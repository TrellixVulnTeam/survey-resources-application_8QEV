!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/common"),require("@angular/common/http"),require("@angular/core"),require("rxjs"),require("jsrsasign-reduced"),require("@angular/router"),require("rxjs/operators"),require("common-tags")):"function"==typeof define&&define.amd?define("angular-auth-oidc-client",["exports","@angular/common","@angular/common/http","@angular/core","rxjs","jsrsasign-reduced","@angular/router","rxjs/operators","common-tags"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self)["angular-auth-oidc-client"]={},e.ng.common,e.ng.common.http,e.ng.core,e.rxjs,e["jsrsasign-reduced"],e.ng.router,e.rxjs.operators,e["common-tags"])}(this,(function(e,t,r,n,i,o,a,s,c){"use strict";var u,l=function(){function e(e){this.platformId=e}return Object.defineProperty(e.prototype,"isBrowser",{get:function(){return t.isPlatformBrowser(this.platformId)},enumerable:!1,configurable:!0}),e}();l.decorators=[{type:n.Injectable}],l.ctorParameters=function(){return[{type:String,decorators:[{type:n.Inject,args:[n.PLATFORM_ID]}]}]},(u=e.LogLevel||(e.LogLevel={}))[u.None=0]="None",u[u.Debug=1]="Debug",u[u.Warn=2]="Warn",u[u.Error=3]="Error";var h={stsServer:"https://please_set",authWellknownEndpoint:"",redirectUrl:"https://please_set",clientId:"please_set",responseType:"code",scope:"openid email profile",hdParam:"",postLogoutRedirectUri:"https://please_set",startCheckSession:!1,silentRenew:!1,silentRenewUrl:"https://please_set",silentRenewTimeoutInSeconds:20,renewTimeBeforeTokenExpiresInSeconds:0,useRefreshToken:!1,usePushedAuthorisationRequests:!1,ignoreNonceAfterRefresh:!1,postLoginRoute:"/",forbiddenRoute:"/forbidden",unauthorizedRoute:"/unauthorized",autoUserinfo:!0,autoCleanStateAfterAuthentication:!0,triggerAuthorizationResultEvent:!1,logLevel:e.LogLevel.Warn,issValidationOff:!1,historyCleanupOff:!1,maxIdTokenIatOffsetAllowedInSeconds:120,disableIatOffsetValidation:!1,storage:"undefined"!=typeof Storage?sessionStorage:null,customParams:{},eagerLoadAuthWellKnownEndpoints:!0,disableRefreshIdTokenAuthTimeValidation:!1,tokenRefreshInSeconds:4,refreshTokenRetryInSeconds:3,ngswBypass:!1},d=function(){function e(e){this.platformProvider=e}return e.prototype.hasValidConfig=function(){return!!this.openIdConfigurationInternal},e.prototype.getOpenIDConfiguration=function(){return this.openIdConfigurationInternal||null},e.prototype.setConfig=function(e){return this.openIdConfigurationInternal=Object.assign(Object.assign({},h),e),(null==e?void 0:e.storage)&&console.warn("PLEASE NOTE: The storage in the config will be deprecated in future versions:\n                Please pass the custom storage in forRoot() as documented"),this.setSpecialCases(this.openIdConfigurationInternal),this.openIdConfigurationInternal},e.prototype.setSpecialCases=function(e){this.platformProvider.isBrowser||(e.startCheckSession=!1,e.silentRenew=!1,e.useRefreshToken=!1,e.usePushedAuthorisationRequests=!1)},e}();d.decorators=[{type:n.Injectable}],d.ctorParameters=function(){return[{type:l}]};var g=function(){function e(e){this.http=e}return e.prototype.get=function(e,t){return this.http.get(e,t)},e.prototype.post=function(e,t,r){return this.http.post(e,t,r)},e}();g.decorators=[{type:n.Injectable}],g.ctorParameters=function(){return[{type:r.HttpClient}]};var p="ngsw-bypass",f=function(){function e(e,t){this.httpClient=e,this.configurationProvider=t}return e.prototype.get=function(e,t){var n=this.prepareHeaders(t),i=new r.HttpParams;return this.configurationProvider.getOpenIDConfiguration().ngswBypass&&(i=i.set(p,"")),this.httpClient.get(e,{headers:n,params:i})},e.prototype.post=function(e,t,n){var i=n||this.prepareHeaders(),o=new r.HttpParams;return this.configurationProvider.getOpenIDConfiguration().ngswBypass&&(o=o.set(p,"")),this.httpClient.post(e,t,{headers:i,params:o})},e.prototype.prepareHeaders=function(e){var t=new r.HttpHeaders;return t=t.set("Accept","application/json"),e&&(t=t.set("Authorization","Bearer "+decodeURIComponent(e))),t},e}();f.decorators=[{type:n.Injectable}],f.ctorParameters=function(){return[{type:g},{type:d}]};Object.create;function v(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function S(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,o=r.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(n=o.next()).done;)a.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=o.return)&&r.call(o)}finally{if(i)throw i.error}}return a}function y(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(S(arguments[t]));return e}function w(e,t){return Object.defineProperty?Object.defineProperty(e,"raw",{value:t}):e.raw=t,e}Object.create;var k,I=function(){function t(e){this.configurationProvider=e}return t.prototype.logError=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];this.loggingIsTurnedOff()||(t&&t.length?console.error.apply(console,y([e],t)):console.error(e))},t.prototype.logWarning=function(t){for(var r=[],n=1;n<arguments.length;n++)r[n-1]=arguments[n];this.logLevelIsSet()&&(this.loggingIsTurnedOff()||this.currentLogLevelIsEqualOrSmallerThan(e.LogLevel.Warn)&&(r&&r.length?console.warn.apply(console,y([t],r)):console.warn(t)))},t.prototype.logDebug=function(t){for(var r=[],n=1;n<arguments.length;n++)r[n-1]=arguments[n];this.logLevelIsSet()&&(this.loggingIsTurnedOff()||this.currentLogLevelIsEqualOrSmallerThan(e.LogLevel.Debug)&&(r&&r.length?console.log.apply(console,y([t],r)):console.log(t)))},t.prototype.currentLogLevelIsEqualOrSmallerThan=function(e){return(this.configurationProvider.getOpenIDConfiguration()||{}).logLevel<=e},t.prototype.logLevelIsSet=function(){var e=(this.configurationProvider.getOpenIDConfiguration()||{}).logLevel;return null!==e&&void 0!==e},t.prototype.loggingIsTurnedOff=function(){return(this.configurationProvider.getOpenIDConfiguration()||{}).logLevel===e.LogLevel.None},t}();I.decorators=[{type:n.Injectable}],I.ctorParameters=function(){return[{type:d}]},(k=e.EventTypes||(e.EventTypes={}))[k.ConfigLoaded=0]="ConfigLoaded",k[k.ConfigLoadingFailed=1]="ConfigLoadingFailed",k[k.CheckSessionReceived=2]="CheckSessionReceived",k[k.UserDataChanged=3]="UserDataChanged",k[k.NewAuthorizationResult=4]="NewAuthorizationResult",k[k.TokenExpired=5]="TokenExpired",k[k.IdTokenExpired=6]="IdTokenExpired";var m=function(){function e(){this.notify=new i.ReplaySubject(1)}return e.prototype.fireEvent=function(e,t){this.notify.next({type:e,value:t})},e.prototype.registerForEvents=function(){return this.notify.asObservable()},e}();m.decorators=[{type:n.Injectable}];var b=function(){};b.decorators=[{type:n.Injectable}];var R=function(){function e(e,t){this.oidcSecurityStorage=e,this.configurationProvider=t}return e.prototype.read=function(e){var t=this.createKeyWithPrefix(e);return this.oidcSecurityStorage.read(t)},e.prototype.write=function(e,t){var r=this.createKeyWithPrefix(e);this.oidcSecurityStorage.write(r,t)},e.prototype.remove=function(e){var t=this.createKeyWithPrefix(e);this.oidcSecurityStorage.remove(t)},e.prototype.resetStorageFlowData=function(){this.remove("session_state"),this.remove("storageSilentRenewRunning"),this.remove("codeVerifier"),this.remove("userData"),this.remove("storageCustomRequestParams"),this.remove("access_token_expires_at")},e.prototype.resetAuthStateInStorage=function(){this.remove("authzData"),this.remove("authnResult")},e.prototype.getAccessToken=function(){return this.read("authzData")},e.prototype.getIdToken=function(){var e;return null===(e=this.read("authnResult"))||void 0===e?void 0:e.id_token},e.prototype.getRefreshToken=function(){var e;return null===(e=this.read("authnResult"))||void 0===e?void 0:e.refresh_token},e.prototype.createKeyWithPrefix=function(e){var t=this.configurationProvider.getOpenIDConfiguration();return((null==t?void 0:t.clientId)||"")+"_"+e},e}();R.decorators=[{type:n.Injectable}],R.ctorParameters=function(){return[{type:b},{type:d}]};var P=function(){function e(e){this.loggerService=e}return e.prototype.getTokenExpirationDate=function(e){if(!e.hasOwnProperty("exp"))return new Date((new Date).toUTCString());var t=new Date(0);return t.setUTCSeconds(e.exp),t},e.prototype.getHeaderFromToken=function(e,t){return this.tokenIsValid(e)?this.getPartOfToken(e,0,t):{}},e.prototype.getPayloadFromToken=function(e,t){return this.tokenIsValid(e)?this.getPartOfToken(e,1,t):{}},e.prototype.getSignatureFromToken=function(e,t){return this.tokenIsValid(e)?this.getPartOfToken(e,2,t):{}},e.prototype.getPartOfToken=function(e,t,r){var n=this.extractPartOfToken(e,t);if(r)return n;var i=this.urlBase64Decode(n);return JSON.parse(i)},e.prototype.urlBase64Decode=function(e){var t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw Error("Illegal base64url string!")}var r="undefined"!=typeof window?window.atob(t):Buffer.from(t,"base64").toString("binary");try{return decodeURIComponent(r.split("").map((function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)})).join(""))}catch(e){return r}},e.prototype.tokenIsValid=function(e){return e?e.includes(".")?3===e.split(".").length||(this.loggerService.logError("token '"+e+"' is not valid --\x3e token has to have exactly 2 dots"),!1):(this.loggerService.logError("token '"+e+"' is not valid --\x3e no dots included"),!1):(this.loggerService.logError("token '"+e+"' is not valid --\x3e token falsy"),!1)},e.prototype.extractPartOfToken=function(e,t){return e.split(".")[t]},e}();P.decorators=[{type:n.Injectable}],P.ctorParameters=function(){return[{type:I}]};var C=function(){function e(e,t){this.tokenHelperService=e,this.loggerService=t,this.keyAlgorithms=["HS256","HS384","HS512","RS256","RS384","RS512","ES256","ES384","PS256","PS384","PS512"]}return e.prototype.hasIdTokenExpired=function(e,t){var r=this.tokenHelperService.getPayloadFromToken(e,!1);return!this.validateIdTokenExpNotExpired(r,t)},e.prototype.validateIdTokenExpNotExpired=function(e,t){var r=this.tokenHelperService.getTokenExpirationDate(e);if(t=t||0,!r)return!1;var n=r.valueOf(),i=new Date((new Date).toUTCString()).valueOf()+1e3*t,o=n>i;return this.loggerService.logDebug("Has id_token expired: "+!o+", "+n+" > "+i),o},e.prototype.validateAccessTokenNotExpired=function(e,t){if(!e)return!0;t=t||0;var r=e.valueOf(),n=new Date((new Date).toUTCString()).valueOf()+1e3*t,i=r>n;return this.loggerService.logDebug("Has access_token expired: "+!i+", "+r+" > "+n),i},e.prototype.validateRequiredIdToken=function(e){var t=!0;return e.hasOwnProperty("iss")||(t=!1,this.loggerService.logWarning("iss is missing, this is required in the id_token")),e.hasOwnProperty("sub")||(t=!1,this.loggerService.logWarning("sub is missing, this is required in the id_token")),e.hasOwnProperty("aud")||(t=!1,this.loggerService.logWarning("aud is missing, this is required in the id_token")),e.hasOwnProperty("exp")||(t=!1,this.loggerService.logWarning("exp is missing, this is required in the id_token")),e.hasOwnProperty("iat")||(t=!1,this.loggerService.logWarning("iat is missing, this is required in the id_token")),t},e.prototype.validateIdTokenIatMaxOffset=function(e,t,r){if(r)return!0;if(!e.hasOwnProperty("iat"))return!1;var n=new Date(0);n.setUTCSeconds(e.iat),t=t||0;var i=new Date((new Date).toUTCString()).valueOf()-n.valueOf(),o=1e3*t;return this.loggerService.logDebug("validate id token iat max offset "+i+" < "+o),i>0?i<o:-i<o},e.prototype.validateIdTokenNonce=function(t,r,n){return!((void 0!==t.nonce&&!n||r!==e.refreshTokenNoncePlaceholder)&&t.nonce!==r)||(this.loggerService.logDebug("Validate_id_token_nonce failed, dataIdToken.nonce: "+t.nonce+" local_nonce:"+r),!1)},e.prototype.validateIdTokenIss=function(e,t){return e.iss===t||(this.loggerService.logDebug("Validate_id_token_iss failed, dataIdToken.iss: "+e.iss+" authWellKnownEndpoints issuer:"+t),!1)},e.prototype.validateIdTokenAud=function(e,t){return Array.isArray(e.aud)?!!e.aud.includes(t)||(this.loggerService.logDebug("Validate_id_token_aud array failed, dataIdToken.aud: "+e.aud+" client_id:"+t),!1):e.aud===t||(this.loggerService.logDebug("Validate_id_token_aud failed, dataIdToken.aud: "+e.aud+" client_id:"+t),!1)},e.prototype.validateIdTokenAzpExistsIfMoreThanOneAud=function(e){return!!e&&!(Array.isArray(e.aud)&&e.aud.length>1&&!e.azp)},e.prototype.validateIdTokenAzpValid=function(e,t){return!(null==e?void 0:e.azp)||e.azp===t},e.prototype.validateStateFromHashCallback=function(e,t){return e===t||(this.loggerService.logDebug("ValidateStateFromHashCallback failed, state: "+e+" local_state:"+t),!1)},e.prototype.validateSignatureIdToken=function(e,t){var r,n,i,a,s,c;if(!t||!t.keys)return!1;var u=this.tokenHelperService.getHeaderFromToken(e,!1);if(0===Object.keys(u).length&&u.constructor===Object)return this.loggerService.logWarning("id token has no header data"),!1;var l=u.kid,h=u.alg;if(!this.keyAlgorithms.includes(h))return this.loggerService.logWarning("alg not supported",h),!1;var d="RSA";"E"===h.charAt(0)&&(d="EC");var g=!1;if(u.hasOwnProperty("kid"))try{for(var p=v(t.keys),f=p.next();!f.done;f=p.next()){if((b=f.value).kid===l){var S=o.KEYUTIL.getKey(b);return(g=o.KJUR.jws.JWS.verify(e,S,[h]))||this.loggerService.logWarning("incorrect Signature, validation failed for id_token"),g}}}catch(e){s={error:e}}finally{try{f&&!f.done&&(c=p.return)&&c.call(p)}finally{if(s)throw s.error}}else{var y=0;try{for(var w=v(t.keys),k=w.next();!k.done;k=w.next()){(b=k.value).kty===d&&"sig"===b.use&&(y+=1)}}catch(e){r={error:e}}finally{try{k&&!k.done&&(n=w.return)&&n.call(w)}finally{if(r)throw r.error}}if(0===y)return this.loggerService.logWarning("no keys found, incorrect Signature, validation failed for id_token"),!1;if(y>1)return this.loggerService.logWarning("no ID Token kid claim in JOSE header and multiple supplied in jwks_uri"),!1;try{for(var I=v(t.keys),m=I.next();!m.done;m=I.next()){var b;if((b=m.value).kty===d&&"sig"===b.use){var R=o.KEYUTIL.getKey(b);return(g=o.KJUR.jws.JWS.verify(e,R,[h]))||this.loggerService.logWarning("incorrect Signature, validation failed for id_token"),g}}}catch(e){i={error:e}}finally{try{m&&!m.done&&(a=I.return)&&a.call(I)}finally{if(i)throw i.error}}}return g},e.prototype.validateIdTokenAtHash=function(e,t,r){this.loggerService.logDebug("at_hash from the server:"+t);var n="sha256";r.includes("384")?n="sha384":r.includes("512")&&(n="sha512");var i=this.generateAtHash(""+e,n);if(this.loggerService.logDebug("at_hash client validation not decoded:"+i),i===t)return!0;var o=this.generateAtHash(""+decodeURIComponent(e),n);return this.loggerService.logDebug("-gen access--"+o),o===t},e.prototype.generateCodeChallenge=function(e){var t=o.KJUR.crypto.Util.hashString(e,"sha256");return o.hextob64u(t)},e.prototype.generateAtHash=function(e,t){var r=o.KJUR.crypto.Util.hashString(e,t),n=r.substr(0,r.length/2);return o.hextob64u(n)},e}();C.refreshTokenNoncePlaceholder="--RefreshToken--",C.decorators=[{type:n.Injectable}],C.ctorParameters=function(){return[{type:P},{type:I}]};var E=function(){function t(e,t,r,n,o){this.storagePersistanceService=e,this.loggerService=t,this.publicEventsService=r,this.configurationProvider=n,this.tokenValidationService=o,this.authorizedInternal$=new i.BehaviorSubject(!1)}return Object.defineProperty(t.prototype,"authorized$",{get:function(){return this.authorizedInternal$.asObservable()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isAuthorized",{get:function(){return!!this.storagePersistanceService.getAccessToken()&&!!this.storagePersistanceService.getIdToken()},enumerable:!1,configurable:!0}),t.prototype.setAuthorizedAndFireEvent=function(){this.authorizedInternal$.next(!0)},t.prototype.setUnauthorizedAndFireEvent=function(){this.storagePersistanceService.resetAuthStateInStorage(),this.authorizedInternal$.next(!1)},t.prototype.updateAndPublishAuthState=function(t){this.publicEventsService.fireEvent(e.EventTypes.NewAuthorizationResult,t)},t.prototype.setAuthorizationData=function(e,t){this.loggerService.logDebug(e),this.loggerService.logDebug("storing the accessToken"),this.storagePersistanceService.write("authzData",e),this.persistAccessTokenExpirationTime(t),this.setAuthorizedAndFireEvent()},t.prototype.getAccessToken=function(){if(!this.isAuthorized)return"";var e=this.storagePersistanceService.getAccessToken();return this.decodeURIComponentSafely(e)},t.prototype.getIdToken=function(){if(!this.isAuthorized)return"";var e=this.storagePersistanceService.getIdToken();return this.decodeURIComponentSafely(e)},t.prototype.getRefreshToken=function(){if(!this.isAuthorized)return"";var e=this.storagePersistanceService.getRefreshToken();return this.decodeURIComponentSafely(e)},t.prototype.areAuthStorageTokensValid=function(){return!!this.isAuthorized&&(this.hasIdTokenExpired()?(this.loggerService.logDebug("persisted id_token is expired"),!1):this.hasAccessTokenExpiredIfExpiryExists()?(this.loggerService.logDebug("persisted access_token is expired"),!1):(this.loggerService.logDebug("persisted id_token and access token are valid"),!0))},t.prototype.hasIdTokenExpired=function(){var t=this.storagePersistanceService.getIdToken(),r=this.configurationProvider.getOpenIDConfiguration().renewTimeBeforeTokenExpiresInSeconds,n=this.tokenValidationService.hasIdTokenExpired(t,r);return n&&this.publicEventsService.fireEvent(e.EventTypes.IdTokenExpired,n),n},t.prototype.hasAccessTokenExpiredIfExpiryExists=function(){var t=this.configurationProvider.getOpenIDConfiguration().renewTimeBeforeTokenExpiresInSeconds,r=this.storagePersistanceService.read("access_token_expires_at"),n=!this.tokenValidationService.validateAccessTokenNotExpired(r,t);return n&&this.publicEventsService.fireEvent(e.EventTypes.TokenExpired,n),n},t.prototype.decodeURIComponentSafely=function(e){return e?decodeURIComponent(e):""},t.prototype.persistAccessTokenExpirationTime=function(e){if(null==e?void 0:e.expires_in){var t=new Date((new Date).toUTCString()).valueOf()+1e3*e.expires_in;this.storagePersistanceService.write("access_token_expires_at",t)}},t}();E.decorators=[{type:n.Injectable}],E.ctorParameters=function(){return[{type:R},{type:I},{type:m},{type:d},{type:C}]};var T="redirect",D=function(){function e(){}return e.prototype.getStoredRedirectRoute=function(){return localStorage.getItem(T)},e.prototype.saveStoredRedirectRoute=function(e){localStorage.setItem(T,e)},e.prototype.deleteStoredRedirectRoute=function(){localStorage.removeItem(T)},e}();D.decorators=[{type:n.Injectable}];var A=function(){function e(e,t){this.doc=e,this.loggerService=t}return e.prototype.createRandom=function(e){if(e<=0)return"";e>0&&e<7&&(this.loggerService.logWarning("RandomService called with "+e+" but 7 chars is the minimum, returning 10 chars"),e=10);var t=e-6,r=new Uint8Array((t||t)/2);return this.getCrypto()&&this.getCrypto().getRandomValues(r),Array.from(r,this.toHex).join("")+this.randomString(7)},e.prototype.toHex=function(e){return("0"+e.toString(16)).substr(-2)},e.prototype.randomString=function(e){var t="",r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=new Uint32Array(e);if(this.getCrypto()){this.getCrypto().getRandomValues(n);for(var i=0;i<e;i++)t+=r[n[i]%r.length]}return t},e.prototype.getCrypto=function(){return this.doc.defaultView.crypto||this.doc.defaultView.msCrypto},e}();A.decorators=[{type:n.Injectable}],A.ctorParameters=function(){return[{type:void 0,decorators:[{type:n.Inject,args:[t.DOCUMENT]}]},{type:I}]};var O=function(){function e(e,t,r,n){this.storagePersistanceService=e,this.randomService=t,this.configurationProvider=r,this.loggerService=n}return e.prototype.createNonce=function(){var e=this.randomService.createRandom(40);return this.setNonce(e),e},e.prototype.setNonce=function(e){this.storagePersistanceService.write("authNonce",e)},e.prototype.getAuthStateControl=function(){return this.storagePersistanceService.read("authStateControl")},e.prototype.setAuthStateControl=function(e){this.storagePersistanceService.write("authStateControl",e)},e.prototype.getExistingOrCreateAuthStateControl=function(){var e=this.storagePersistanceService.read("authStateControl");return e||(e=this.randomService.createRandom(40),this.storagePersistanceService.write("authStateControl",e)),e},e.prototype.setSessionState=function(e){this.storagePersistanceService.write("session_state",e)},e.prototype.resetStorageFlowData=function(){this.storagePersistanceService.resetStorageFlowData()},e.prototype.getCodeVerifier=function(){return this.storagePersistanceService.read("codeVerifier")},e.prototype.createCodeVerifier=function(){var e=this.randomService.createRandom(67);return this.storagePersistanceService.write("codeVerifier",e),e},e.prototype.isSilentRenewRunning=function(){var e=JSON.parse(this.storagePersistanceService.read("storageSilentRenewRunning"));if(e){var t=1e3*this.configurationProvider.getOpenIDConfiguration().silentRenewTimeoutInSeconds,r=Date.parse(e.dateOfLaunchedProcessUtc),n=Date.parse((new Date).toISOString());return Math.abs(n-r)>t?(this.loggerService.logDebug("silent renew process is probably stuck, state will be reset."),this.resetSilentRenewRunning(),!1):"running"===e.state}return!1},e.prototype.setSilentRenewRunning=function(){var e={state:"running",dateOfLaunchedProcessUtc:(new Date).toISOString()};this.storagePersistanceService.write("storageSilentRenewRunning",JSON.stringify(e))},e.prototype.resetSilentRenewRunning=function(){this.storagePersistanceService.write("storageSilentRenewRunning","")},e}();O.decorators=[{type:n.Injectable}],O.ctorParameters=function(){return[{type:R},{type:A},{type:d},{type:I}]};var U=function(){function e(e){this.configurationProvider=e}return e.prototype.isCurrentFlowCodeFlow=function(){return this.currentFlowIs("code")},e.prototype.isCurrentFlowAnyImplicitFlow=function(){return this.isCurrentFlowImplicitFlowWithAccessToken()||this.isCurrentFlowImplicitFlowWithoutAccessToken()},e.prototype.isCurrentFlowCodeFlowWithRefreshTokens=function(){var e=this.configurationProvider.getOpenIDConfiguration().useRefreshToken;return!(!this.isCurrentFlowCodeFlow()||!e)},e.prototype.isCurrentFlowImplicitFlowWithAccessToken=function(){return this.currentFlowIs("id_token token")},e.prototype.isCurrentFlowImplicitFlowWithoutAccessToken=function(){return this.currentFlowIs("id_token")},e.prototype.currentFlowIs=function(e){var t=this.configurationProvider.getOpenIDConfiguration().responseType;return Array.isArray(e)?e.some((function(e){return t===e})):t===e},e}();U.decorators=[{type:n.Injectable}],U.ctorParameters=function(){return[{type:d}]};var j,F,W,_,z,V,x=function(){function e(){}return e.prototype.encodeKey=function(e){return encodeURIComponent(e)},e.prototype.encodeValue=function(e){return encodeURIComponent(e)},e.prototype.decodeKey=function(e){return decodeURIComponent(e)},e.prototype.decodeValue=function(e){return decodeURIComponent(e)},e}(),H=["code","state","token","id_token"],K=function(){function e(e,t,r,n,i,o){this.configurationProvider=e,this.loggerService=t,this.flowsDataService=r,this.flowHelper=n,this.tokenValidationService=i,this.storagePersistanceService=o}return e.prototype.getUrlParameter=function(e,t){if(!e)return"";if(!t)return"";t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var r=new RegExp("[\\?&]"+t+"=([^&#]*)").exec(e);return null===r?"":decodeURIComponent(r[1])},e.prototype.isCallbackFromSts=function(e){var t=this;return H.some((function(r){return!!t.getUrlParameter(e,r)}))},e.prototype.getRefreshSessionSilentRenewUrl=function(e){return this.flowHelper.isCurrentFlowCodeFlow()?this.createUrlCodeFlowWithSilentRenew(e):this.createUrlImplicitFlowWithSilentRenew(e)||""},e.prototype.getAuthorizeParUrl=function(e){var t=this.storagePersistanceService.read("authWellKnownEndPoints");if(!t)return this.loggerService.logError("authWellKnownEndpoints is undefined"),null;var n=t.authorizationEndpoint;if(!n)return this.loggerService.logError("Can not create an authorize url when authorizationEndpoint is '"+n+"'"),null;var i=this.configurationProvider.getOpenIDConfiguration().clientId;if(!i)return this.loggerService.logError("createAuthorizeUrl could not add clientId because it was: ",i),null;var o=n.split("?"),a=o[0],s=new r.HttpParams({fromString:o[1],encoder:new x});return a+"?"+(s=(s=s.set("request_uri",e)).append("client_id",i))},e.prototype.getAuthorizeUrl=function(e){return this.flowHelper.isCurrentFlowCodeFlow()?this.createUrlCodeFlowAuthorize(e):this.createUrlImplicitFlowAuthorize(e)||""},e.prototype.createEndSessionUrl=function(e){var t=this.storagePersistanceService.read("authWellKnownEndPoints"),n=null==t?void 0:t.endSessionEndpoint;if(!n)return null;var i=n.split("?"),o=i[0],a=new r.HttpParams({fromString:i[1],encoder:new x});a=a.set("id_token_hint",e);var s=this.getPostLogoutRedirectUrl();return s&&(a=a.append("post_logout_redirect_uri",s)),o+"?"+a},e.prototype.createRevocationEndpointBodyAccessToken=function(e){var t=this.getClientId();return t?"client_id="+t+"&token="+e+"&token_type_hint=access_token":null},e.prototype.createRevocationEndpointBodyRefreshToken=function(e){var t=this.getClientId();return t?"client_id="+t+"&token="+e+"&token_type_hint=refresh_token":null},e.prototype.getRevocationEndpointUrl=function(){var e=this.storagePersistanceService.read("authWellKnownEndPoints"),t=null==e?void 0:e.revocationEndpoint;return t?t.split("?")[0]:null},e.prototype.createBodyForCodeFlowCodeRequest=function(e,t){var r=this.flowsDataService.getCodeVerifier();if(!r)return this.loggerService.logError("CodeVerifier is not set ",r),null;var n=this.getClientId();if(!n)return null;var i=c.oneLineTrim(j||(j=w(["grant_type=authorization_code\n            &client_id=","\n            &code_verifier=","\n            &code=",""],["grant_type=authorization_code\n            &client_id=","\n            &code_verifier=","\n            &code=",""])),n,r,e);if(t){var o=this.composeCustomParams(Object.assign({},t));i=c.oneLineTrim(F||(F=w(["","",""],["","",""])),i,o)}var a=this.getSilentRenewUrl();if(this.flowsDataService.isSilentRenewRunning()&&a)return c.oneLineTrim(W||(W=w(["","&redirect_uri=",""],["","&redirect_uri=",""])),i,a);var s=this.getRedirectUrl();return s?c.oneLineTrim(_||(_=w(["","&redirect_uri=",""],["","&redirect_uri=",""])),i,s):null},e.prototype.createBodyForCodeFlowRefreshTokensRequest=function(e,t){var r=this.getClientId();if(!r)return null;var n=c.oneLineTrim(z||(z=w(["grant_type=refresh_token\n            &client_id=","\n            &refresh_token=",""],["grant_type=refresh_token\n            &client_id=","\n            &refresh_token=",""])),r,e);t&&(n=""+n+this.composeCustomParams(Object.assign({},t)));return n},e.prototype.createBodyForParCodeFlowRequest=function(e){var t=this.getRedirectUrl();if(!t)return null;var r=this.flowsDataService.getExistingOrCreateAuthStateControl(),n=this.flowsDataService.createNonce();this.loggerService.logDebug("Authorize created. adding myautostate: "+r);var i=this.flowsDataService.createCodeVerifier(),o=this.tokenValidationService.generateCodeChallenge(i),a=this.configurationProvider.getOpenIDConfiguration(),s=a.clientId,u=a.responseType,l=a.scope,h=a.hdParam,d=a.customParams,g=c.oneLineTrim(V||(V=w(["client_id=","\n            &redirect_uri=","\n            &response_type=","\n            &scope=","\n            &nonce=","\n            &state=","\n            &code_challenge=","\n            &code_challenge_method=S256"],["client_id=","\n            &redirect_uri=","\n            &response_type=","\n            &scope=","\n            &nonce=","\n            &state=","\n            &code_challenge=","\n            &code_challenge_method=S256"])),s,t,u,l,n,r,o);(h&&(g=g+"&hd="+h),d)&&(g=""+g+this.composeCustomParams(Object.assign({},d)));e&&(g=""+g+this.composeCustomParams(Object.assign({},e)));return g},e.prototype.createAuthorizeUrl=function(e,t,n,i,o,a){var s,c,u,l,h=this.storagePersistanceService.read("authWellKnownEndPoints"),d=null==h?void 0:h.authorizationEndpoint;if(!d)return this.loggerService.logError("Can not create an authorize url when authorizationEndpoint is '"+d+"'"),null;var g=this.configurationProvider.getOpenIDConfiguration(),p=g.clientId,f=g.responseType,y=g.scope,w=g.hdParam,k=g.customParams;if(!p)return this.loggerService.logError("createAuthorizeUrl could not add clientId because it was: ",p),null;if(!f)return this.loggerService.logError("createAuthorizeUrl could not add responseType because it was: ",f),null;if(!y)return this.loggerService.logError("createAuthorizeUrl could not add scope because it was: ",y),null;var I=d.split("?"),m=I[0],b=new r.HttpParams({fromString:I[1],encoder:new x});if(b=(b=(b=(b=(b=(b=b.set("client_id",p)).append("redirect_uri",t)).append("response_type",f)).append("scope",y)).append("nonce",n)).append("state",i),this.flowHelper.isCurrentFlowCodeFlow()&&(b=(b=b.append("code_challenge",e)).append("code_challenge_method","S256")),o&&(b=b.append("prompt",o)),w&&(b=b.append("hd",w)),k)try{for(var R=v(Object.entries(Object.assign({},k))),P=R.next();!P.done;P=R.next()){var C=S(P.value,2),E=C[0],T=C[1];b=b.append(E,T.toString())}}catch(e){s={error:e}}finally{try{P&&!P.done&&(c=R.return)&&c.call(R)}finally{if(s)throw s.error}}if(a)try{for(var D=v(Object.entries(Object.assign({},a))),A=D.next();!A.done;A=D.next()){var O=S(A.value,2);E=O[0],T=O[1];b=b.append(E,T.toString())}}catch(e){u={error:e}}finally{try{A&&!A.done&&(l=D.return)&&l.call(D)}finally{if(u)throw u.error}}return m+"?"+b},e.prototype.createUrlImplicitFlowWithSilentRenew=function(e){var t=this.flowsDataService.getExistingOrCreateAuthStateControl(),r=this.flowsDataService.createNonce(),n=this.getSilentRenewUrl();return n?(this.loggerService.logDebug("RefreshSession created. adding myautostate: ",t),this.storagePersistanceService.read("authWellKnownEndPoints")?this.createAuthorizeUrl("",n,r,t,"none",e):(this.loggerService.logError("authWellKnownEndpoints is undefined"),null)):null},e.prototype.createUrlCodeFlowWithSilentRenew=function(e){var t=this.flowsDataService.getExistingOrCreateAuthStateControl(),r=this.flowsDataService.createNonce();this.loggerService.logDebug("RefreshSession created. adding myautostate: "+t);var n=this.flowsDataService.createCodeVerifier(),i=this.tokenValidationService.generateCodeChallenge(n),o=this.getSilentRenewUrl();return o?this.storagePersistanceService.read("authWellKnownEndPoints")?this.createAuthorizeUrl(i,o,r,t,"none",e):(this.loggerService.logWarning("authWellKnownEndpoints is undefined"),null):null},e.prototype.createUrlImplicitFlowAuthorize=function(e){var t=this.flowsDataService.getExistingOrCreateAuthStateControl(),r=this.flowsDataService.createNonce();this.loggerService.logDebug("Authorize created. adding myautostate: "+t);var n=this.getRedirectUrl();return n?this.storagePersistanceService.read("authWellKnownEndPoints")?this.createAuthorizeUrl("",n,r,t,null,e):(this.loggerService.logError("authWellKnownEndpoints is undefined"),null):null},e.prototype.createUrlCodeFlowAuthorize=function(e){var t=this.flowsDataService.getExistingOrCreateAuthStateControl(),r=this.flowsDataService.createNonce();this.loggerService.logDebug("Authorize created. adding myautostate: "+t);var n=this.getRedirectUrl();if(!n)return null;var i=this.flowsDataService.createCodeVerifier(),o=this.tokenValidationService.generateCodeChallenge(i);return this.storagePersistanceService.read("authWellKnownEndPoints")?this.createAuthorizeUrl(o,n,r,t,null,e):(this.loggerService.logError("authWellKnownEndpoints is undefined"),null)},e.prototype.getRedirectUrl=function(){var e=this.configurationProvider.getOpenIDConfiguration().redirectUrl;return e||(this.loggerService.logError("could not get redirectUrl, was: ",e),null)},e.prototype.getSilentRenewUrl=function(){var e=this.configurationProvider.getOpenIDConfiguration().silentRenewUrl;return e||(this.loggerService.logError("could not get silentRenewUrl, was: ",e),null)},e.prototype.getPostLogoutRedirectUrl=function(){var e=this.configurationProvider.getOpenIDConfiguration().postLogoutRedirectUri;return e||(this.loggerService.logError("could not get postLogoutRedirectUri, was: ",e),null)},e.prototype.getClientId=function(){var e=this.configurationProvider.getOpenIDConfiguration().clientId;return e||(this.loggerService.logError("could not get clientId, was: ",e),null)},e.prototype.composeCustomParams=function(e){var t,r,n="";try{for(var i=v(Object.entries(e)),o=i.next();!o.done;o=i.next()){var a=S(o.value,2),s=a[0],c=a[1];n=n.concat("&"+s+"="+c.toString())}}catch(e){t={error:e}}finally{try{o&&!o.done&&(r=i.return)&&r.call(i)}finally{if(t)throw t.error}}return n},e}();K.decorators=[{type:n.Injectable}],K.ctorParameters=function(){return[{type:d},{type:I},{type:O},{type:U},{type:C},{type:R}]};var L,q,M=function(){function e(e,t,r,n,i,o,a){this.urlService=e,this.loggerService=t,this.tokenValidationService=r,this.flowsDataService=n,this.configurationProvider=i,this.storagePersistanceService=o,this.dataService=a}return e.prototype.codeFlowCallback=function(e){var t=this.urlService.getUrlParameter(e,"code"),r=this.urlService.getUrlParameter(e,"state"),n=this.urlService.getUrlParameter(e,"session_state")||null;if(!r)return this.loggerService.logDebug("no state in url"),i.throwError("no state in url");if(!t)return this.loggerService.logDebug("no code in url"),i.throwError("no code in url");this.loggerService.logDebug("running validation for callback",e);var o={code:t,refreshToken:null,state:r,sessionState:n,authResult:null,isRenewProcess:!1,jwtKeys:null,validationResult:null,existingIdToken:null};return i.of(o)},e.prototype.codeFlowCodeRequest=function(e){var t=this,n=this.flowsDataService.getAuthStateControl();if(!this.tokenValidationService.validateStateFromHashCallback(e.state,n))return this.loggerService.logWarning("codeFlowCodeRequest incorrect state"),i.throwError("codeFlowCodeRequest incorrect state");var o=this.storagePersistanceService.read("authWellKnownEndPoints"),a=null==o?void 0:o.tokenEndpoint;if(!a)return i.throwError("Token Endpoint not defined");var c=new r.HttpHeaders;c=c.set("Content-Type","application/x-www-form-urlencoded");var u=this.configurationProvider.getOpenIDConfiguration(),l=this.urlService.createBodyForCodeFlowCodeRequest(e.code,null==u?void 0:u.customTokenParams);return this.dataService.post(a,l,c).pipe(s.switchMap((function(t){var r=new Object;return(r=t).state=e.state,r.session_state=e.sessionState,e.authResult=r,i.of(e)})),s.retryWhen((function(e){return t.handleRefreshRetry(e)})),s.catchError((function(e){var r="OidcService code request "+t.configurationProvider.getOpenIDConfiguration().stsServer;return t.loggerService.logError(r,e),i.throwError(r)})))},e.prototype.handleRefreshRetry=function(e){var t=this;return e.pipe(s.mergeMap((function(e){if(e&&e instanceof r.HttpErrorResponse&&e.error instanceof ProgressEvent&&"error"===e.error.type){var n=t.configurationProvider.getOpenIDConfiguration(),o=n.stsServer,a=n.refreshTokenRetryInSeconds,s="OidcService code request "+o+" - no internet connection";return t.loggerService.logWarning(s,e),i.timer(1e3*a)}return i.throwError(e)})))},e}();M.decorators=[{type:n.Injectable}],M.ctorParameters=function(){return[{type:K},{type:I},{type:C},{type:O},{type:d},{type:R},{type:f}]},(L=e.AuthorizedState||(e.AuthorizedState={})).Authorized="Authorized",L.Unauthorized="Unauthorized",L.Unknown="Unknown",(q=e.ValidationResult||(e.ValidationResult={})).NotSet="NotSet",q.StatesDoNotMatch="StatesDoNotMatch",q.SignatureFailed="SignatureFailed",q.IncorrectNonce="IncorrectNonce",q.RequiredPropertyMissing="RequiredPropertyMissing",q.MaxOffsetExpired="MaxOffsetExpired",q.IssDoesNotMatchIssuer="IssDoesNotMatchIssuer",q.NoAuthWellKnownEndPoints="NoAuthWellKnownEndPoints",q.IncorrectAud="IncorrectAud",q.IncorrectIdTokenClaimsAfterRefresh="IncorrectIdTokenClaimsAfterRefresh",q.IncorrectAzp="IncorrectAzp",q.TokenExpired="TokenExpired",q.IncorrectAtHash="IncorrectAtHash",q.Ok="Ok",q.LoginRequired="LoginRequired",q.SecureTokenServerError="SecureTokenServerError";var N=function(){function t(e,t,r,n,o,a,s){this.oidcDataService=e,this.storagePersistanceService=t,this.eventService=r,this.loggerService=n,this.tokenHelperService=o,this.flowHelper=a,this.configurationProvider=s,this.userDataInternal$=new i.BehaviorSubject(null)}return Object.defineProperty(t.prototype,"userData$",{get:function(){return this.userDataInternal$.asObservable()},enumerable:!1,configurable:!0}),t.prototype.getAndPersistUserDataInStore=function(e,t,r){var n=this;void 0===e&&(e=!1),t=t||this.storagePersistanceService.getIdToken(),r=r||this.tokenHelperService.getPayloadFromToken(t,!1);var o=this.getUserDataFromStore(),a=!!o,c=this.flowHelper.isCurrentFlowImplicitFlowWithAccessToken(),u=this.flowHelper.isCurrentFlowCodeFlow(),l=this.storagePersistanceService.getAccessToken();if(!c&&!u)return this.loggerService.logDebug("authorizedCallback id_token flow"),this.loggerService.logDebug("accessToken",l),this.setUserDataToStore(r),i.of(r);var h=this.configurationProvider.getOpenIDConfiguration().renewUserInfoAfterTokenRenew;return e&&!h&&a?i.of(o):this.getUserDataOidcFlowAndSave(r.sub).pipe(s.switchMap((function(e){return n.loggerService.logDebug("Received user data",e),e?(n.loggerService.logDebug("accessToken",l),i.of(e)):i.throwError("no user data, request failed")})))},t.prototype.getUserDataFromStore=function(){return this.storagePersistanceService.read("userData")||null},t.prototype.publishUserDataIfExists=function(){var t=this.getUserDataFromStore();t&&(this.userDataInternal$.next(t),this.eventService.fireEvent(e.EventTypes.UserDataChanged,t))},t.prototype.setUserDataToStore=function(t){this.storagePersistanceService.write("userData",t),this.userDataInternal$.next(t),this.eventService.fireEvent(e.EventTypes.UserDataChanged,t)},t.prototype.resetUserDataInStore=function(){this.storagePersistanceService.remove("userData"),this.eventService.fireEvent(e.EventTypes.UserDataChanged,null),this.userDataInternal$.next(null)},t.prototype.getUserDataOidcFlowAndSave=function(e){var t=this;return this.getIdentityUserData().pipe(s.map((function(r){return t.validateUserDataSubIdToken(e,null==r?void 0:r.sub)?(t.setUserDataToStore(r),r):(t.loggerService.logWarning("authorizedCallback, User data sub does not match sub in id_token"),t.loggerService.logDebug("authorizedCallback, token(s) validation failed, resetting"),t.resetUserDataInStore(),null)})))},t.prototype.getIdentityUserData=function(){var e=this.storagePersistanceService.getAccessToken(),t=this.storagePersistanceService.read("authWellKnownEndPoints");if(!t)return this.loggerService.logWarning("init check session: authWellKnownEndpoints is undefined"),i.throwError("authWellKnownEndpoints is undefined");var r=t.userinfoEndpoint;return r?this.oidcDataService.get(r,e).pipe(s.retry(2)):(this.loggerService.logError("init check session: authWellKnownEndpoints.userinfo_endpoint is undefined; set auto_userinfo = false in config"),i.throwError("authWellKnownEndpoints.userinfo_endpoint is undefined"))},t.prototype.validateUserDataSubIdToken=function(e,t){return!!e&&(!!t&&(e===t||(this.loggerService.logDebug("validateUserDataSubIdToken failed",e,t),!1)))},t}();N.decorators=[{type:n.Injectable}],N.ctorParameters=function(){return[{type:f},{type:R},{type:m},{type:I},{type:P},{type:U},{type:d}]};var B=function(){function e(e,t,r){this.authStateService=e,this.flowsDataService=t,this.userService=r}return e.prototype.resetAuthorizationData=function(){this.userService.resetUserDataInStore(),this.flowsDataService.resetStorageFlowData(),this.authStateService.setUnauthorizedAndFireEvent()},e}();B.decorators=[{type:n.Injectable}],B.ctorParameters=function(){return[{type:E},{type:O},{type:N}]};var $=function(){function e(e,t,r){this.storagePersistanceService=e,this.loggerService=t,this.dataService=r}return e.prototype.getSigningKeys=function(){var e=this.storagePersistanceService.read("authWellKnownEndPoints"),t=null==e?void 0:e.jwksUri;if(!t){var r="getSigningKeys: authWellKnownEndpoints.jwksUri is: '"+t+"'";return this.loggerService.logWarning(r),i.throwError(r)}return this.loggerService.logDebug("Getting signinkeys from ",t),this.dataService.get(t).pipe(s.retry(2),s.catchError(this.handleErrorGetSigningKeys))},e.prototype.handleErrorGetSigningKeys=function(e){var t="";if(e instanceof r.HttpResponse){var n=e.body||{},o=JSON.stringify(n);t=(e.status||"")+" - "+(e.statusText||"")+" "+(o||"")}else{var a=e.message;t=a||""+e}return this.loggerService.logError(t),i.throwError(new Error(t))},e}();$.decorators=[{type:n.Injectable}],$.ctorParameters=function(){return[{type:R},{type:I},{type:f}]};var J=function(){function t(e,t,r,n,i,o,a){this.loggerService=e,this.configurationProvider=t,this.authStateService=r,this.flowsDataService=n,this.signInKeyDataService=i,this.storagePersistanceService=o,this.resetAuthDataService=a}return t.prototype.callbackHistoryAndResetJwtKeys=function(e){var t=this;if(this.storagePersistanceService.write("authnResult",e.authResult),this.historyCleanUpTurnedOn()&&!e.isRenewProcess?this.resetBrowserHistory():this.loggerService.logDebug("history clean up inactive"),e.authResult.error){var r="authorizedCallbackProcedure came with error: "+e.authResult.error;return this.loggerService.logDebug(r),this.resetAuthDataService.resetAuthorizationData(),this.flowsDataService.setNonce(""),this.handleResultErrorFromCallback(e.authResult,e.isRenewProcess),i.throwError(r)}return this.loggerService.logDebug(e.authResult),this.loggerService.logDebug("authorizedCallback created, begin token validation"),this.signInKeyDataService.getSigningKeys().pipe(s.switchMap((function(r){if(r)return e.jwtKeys=r,i.of(e);var n="Failed to retrieve signing key";return t.loggerService.logWarning(n),i.throwError(n)})),s.catchError((function(e){var r="Failed to retrieve signing key with error: "+e;return t.loggerService.logWarning(r),i.throwError(r)})))},t.prototype.handleResultErrorFromCallback=function(t,r){var n=e.ValidationResult.SecureTokenServerError;"login_required"===t.error&&(n=e.ValidationResult.LoginRequired),this.authStateService.updateAndPublishAuthState({authorizationState:e.AuthorizedState.Unauthorized,validationResult:n,isRenewProcess:r})},t.prototype.historyCleanUpTurnedOn=function(){return!this.configurationProvider.getOpenIDConfiguration().historyCleanupOff},t.prototype.resetBrowserHistory=function(){window.history.replaceState({},window.document.title,window.location.origin+window.location.pathname)},t}();J.decorators=[{type:n.Injectable}],J.ctorParameters=function(){return[{type:I},{type:d},{type:E},{type:O},{type:$},{type:R},{type:B}]};var G=function(){function e(e,t,r,n){this.resetAuthDataService=e,this.loggerService=t,this.flowsDataService=r,this.doc=n}return e.prototype.implicitFlowCallback=function(e){var t=this.flowsDataService.isSilentRenewRunning();this.loggerService.logDebug("BEGIN authorizedCallback, no auth data"),t||this.resetAuthDataService.resetAuthorizationData();var r={code:null,refreshToken:null,state:null,sessionState:null,authResult:(e=e||this.doc.location.hash.substr(1)).split("&").reduce((function(e,t){var r=t.split("=");return e[r.shift()]=r.join("="),e}),{}),isRenewProcess:t,jwtKeys:null,validationResult:null,existingIdToken:null};return i.of(r)},e}();G.decorators=[{type:n.Injectable}],G.ctorParameters=function(){return[{type:B},{type:I},{type:O},{type:void 0,decorators:[{type:n.Inject,args:[t.DOCUMENT]}]}]};var Z=function(){function e(e,t,r){this.loggerService=e,this.authStateService=t,this.flowsDataService=r}return e.prototype.refreshSessionWithRefreshTokens=function(){var e=this.flowsDataService.getExistingOrCreateAuthStateControl();this.loggerService.logDebug("RefreshSession created. adding myautostate: "+e);var t=this.authStateService.getRefreshToken(),r=this.authStateService.getIdToken();if(t){var n={code:null,refreshToken:t,state:e,sessionState:null,authResult:null,isRenewProcess:!0,jwtKeys:null,validationResult:null,existingIdToken:r};return this.loggerService.logDebug("found refresh code, obtaining new credentials with refresh code"),this.flowsDataService.setNonce(C.refreshTokenNoncePlaceholder),i.of(n)}var o="no refresh token found, please login";return this.loggerService.logError(o),i.throwError(o)},e}();Z.decorators=[{type:n.Injectable}],Z.ctorParameters=function(){return[{type:I},{type:E},{type:O}]};var Y=function(){function e(e,t,r,n,i){this.urlService=e,this.loggerService=t,this.configurationProvider=r,this.dataService=n,this.storagePersistanceService=i}return e.prototype.refreshTokensRequestTokens=function(e,t){var n=this,o=new r.HttpHeaders;o=o.set("Content-Type","application/x-www-form-urlencoded");var a=this.storagePersistanceService.read("authWellKnownEndPoints"),c=null==a?void 0:a.tokenEndpoint;if(!c)return i.throwError("Token Endpoint not defined");var u=this.urlService.createBodyForCodeFlowRefreshTokensRequest(e.refreshToken,t);return this.dataService.post(c,u,o).pipe(s.switchMap((function(t){n.loggerService.logDebug("token refresh response: ",t);var r=new Object;return(r=t).state=e.state,e.authResult=r,i.of(e)})),s.retryWhen((function(e){return n.handleRefreshRetry(e)})),s.catchError((function(e){var t="OidcService code request "+n.configurationProvider.getOpenIDConfiguration().stsServer;return n.loggerService.logError(t,e),i.throwError(t)})))},e.prototype.handleRefreshRetry=function(e){var t=this;return e.pipe(s.mergeMap((function(e){if(e&&e instanceof r.HttpErrorResponse&&e.error instanceof ProgressEvent&&"error"===e.error.type){var n=t.configurationProvider.getOpenIDConfiguration(),o=n.stsServer,a=n.refreshTokenRetryInSeconds,s="OidcService code request "+o+" - no internet connection";return t.loggerService.logWarning(s,e),i.timer(1e3*a)}return i.throwError(e)})))},e}();Y.decorators=[{type:n.Injectable}],Y.ctorParameters=function(){return[{type:K},{type:I},{type:d},{type:f},{type:R}]};var Q=function(){function e(){}return e.prototype.isStringEqualOrNonOrderedArrayEqual=function(e,t){return!this.isNullOrUndefined(e)&&(!this.isNullOrUndefined(t)&&(!this.oneValueIsStringAndTheOtherIsArray(e,t)&&(this.bothValuesAreStrings(e,t)?e===t:!!this.bothValuesAreArrays(e,t)&&this.arraysHaveEqualContent(e,t))))},e.prototype.areEqual=function(e,t){if(!e||!t)return!1;if(this.bothValuesAreArrays(e,t))return this.arraysStrictEqual(e,t);if(this.bothValuesAreStrings(e,t))return e===t;if(this.bothValuesAreObjects(e,t))return JSON.stringify(e).toLowerCase()===JSON.stringify(t).toLowerCase();if(this.oneValueIsStringAndTheOtherIsArray(e,t)){if(Array.isArray(e)&&this.valueIsString(t))return e[0]===t;if(Array.isArray(t)&&this.valueIsString(e))return t[0]===e}},e.prototype.oneValueIsStringAndTheOtherIsArray=function(e,t){return Array.isArray(e)&&this.valueIsString(t)||Array.isArray(t)&&this.valueIsString(e)},e.prototype.bothValuesAreObjects=function(e,t){return this.valueIsObject(e)&&this.valueIsObject(t)},e.prototype.bothValuesAreStrings=function(e,t){return this.valueIsString(e)&&this.valueIsString(t)},e.prototype.bothValuesAreArrays=function(e,t){return Array.isArray(e)&&Array.isArray(t)},e.prototype.valueIsString=function(e){return"string"==typeof e||e instanceof String},e.prototype.valueIsObject=function(e){return"object"==typeof e},e.prototype.arraysStrictEqual=function(e,t){if(e.length!==t.length)return!1;for(var r=e.length;r--;)if(e[r]!==t[r])return!1;return!0},e.prototype.arraysHaveEqualContent=function(e,t){return e.length===t.length&&e.some((function(e){return t.includes(e)}))},e.prototype.isNullOrUndefined=function(e){return null==e},e}();Q.decorators=[{type:n.Injectable}];var X=function(t,r,n,i,o){void 0===t&&(t=""),void 0===r&&(r=""),void 0===n&&(n=!1),void 0===i&&(i={}),void 0===o&&(o=e.ValidationResult.NotSet),this.accessToken=t,this.idToken=r,this.authResponseIsValid=n,this.decodedIdToken=i,this.state=o},ee=function(){function t(e,t,r,n,i,o,a){this.storagePersistanceService=e,this.tokenValidationService=t,this.tokenHelperService=r,this.loggerService=n,this.configurationProvider=i,this.equalityService=o,this.flowHelper=a}return t.prototype.getValidatedStateResult=function(e){return e?e.authResult.error?new X("","",!1,{}):this.validateState(e):new X("","",!1,{})},t.prototype.validateState=function(t){var r=new X,n=this.storagePersistanceService.read("authStateControl");if(!this.tokenValidationService.validateStateFromHashCallback(t.authResult.state,n))return this.loggerService.logWarning("authorizedCallback incorrect state"),r.state=e.ValidationResult.StatesDoNotMatch,this.handleUnsuccessfulValidation(),r;var i=this.flowHelper.isCurrentFlowImplicitFlowWithAccessToken(),o=this.flowHelper.isCurrentFlowCodeFlow();if((i||o)&&(r.accessToken=t.authResult.access_token),t.authResult.id_token){var a=this.configurationProvider.getOpenIDConfiguration(),s=a.clientId,c=a.issValidationOff,u=a.maxIdTokenIatOffsetAllowedInSeconds,l=a.disableIatOffsetValidation,h=a.ignoreNonceAfterRefresh;if(r.idToken=t.authResult.id_token,r.decodedIdToken=this.tokenHelperService.getPayloadFromToken(r.idToken,!1),!this.tokenValidationService.validateSignatureIdToken(r.idToken,t.jwtKeys))return this.loggerService.logDebug("authorizedCallback Signature validation failed id_token"),r.state=e.ValidationResult.SignatureFailed,this.handleUnsuccessfulValidation(),r;var d=this.storagePersistanceService.read("authNonce");if(!this.tokenValidationService.validateIdTokenNonce(r.decodedIdToken,d,h))return this.loggerService.logWarning("authorizedCallback incorrect nonce"),r.state=e.ValidationResult.IncorrectNonce,this.handleUnsuccessfulValidation(),r;if(!this.tokenValidationService.validateRequiredIdToken(r.decodedIdToken))return this.loggerService.logDebug("authorizedCallback Validation, one of the REQUIRED properties missing from id_token"),r.state=e.ValidationResult.RequiredPropertyMissing,this.handleUnsuccessfulValidation(),r;if(!this.tokenValidationService.validateIdTokenIatMaxOffset(r.decodedIdToken,u,l))return this.loggerService.logWarning("authorizedCallback Validation, iat rejected id_token was issued too far away from the current time"),r.state=e.ValidationResult.MaxOffsetExpired,this.handleUnsuccessfulValidation(),r;var g=this.storagePersistanceService.read("authWellKnownEndPoints");if(!g)return this.loggerService.logWarning("authWellKnownEndpoints is undefined"),r.state=e.ValidationResult.NoAuthWellKnownEndPoints,this.handleUnsuccessfulValidation(),r;if(c)this.loggerService.logDebug("iss validation is turned off, this is not recommended!");else if(!c&&!this.tokenValidationService.validateIdTokenIss(r.decodedIdToken,g.issuer))return this.loggerService.logWarning("authorizedCallback incorrect iss does not match authWellKnownEndpoints issuer"),r.state=e.ValidationResult.IssDoesNotMatchIssuer,this.handleUnsuccessfulValidation(),r;if(!this.tokenValidationService.validateIdTokenAud(r.decodedIdToken,s))return this.loggerService.logWarning("authorizedCallback incorrect aud"),r.state=e.ValidationResult.IncorrectAud,this.handleUnsuccessfulValidation(),r;if(!this.tokenValidationService.validateIdTokenAzpExistsIfMoreThanOneAud(r.decodedIdToken))return this.loggerService.logWarning("authorizedCallback missing azp"),r.state=e.ValidationResult.IncorrectAzp,this.handleUnsuccessfulValidation(),r;if(!this.tokenValidationService.validateIdTokenAzpValid(r.decodedIdToken,s))return this.loggerService.logWarning("authorizedCallback incorrect azp"),r.state=e.ValidationResult.IncorrectAzp,this.handleUnsuccessfulValidation(),r;if(!this.isIdTokenAfterRefreshTokenRequestValid(t,r.decodedIdToken))return this.loggerService.logWarning("authorizedCallback pre, post id_token claims do not match in refresh"),r.state=e.ValidationResult.IncorrectIdTokenClaimsAfterRefresh,this.handleUnsuccessfulValidation(),r;if(!this.tokenValidationService.validateIdTokenExpNotExpired(r.decodedIdToken))return this.loggerService.logWarning("authorizedCallback id token expired"),r.state=e.ValidationResult.TokenExpired,this.handleUnsuccessfulValidation(),r}else this.loggerService.logDebug("No id_token found, skipping id_token validation");if(!i&&!o)return r.authResponseIsValid=!0,r.state=e.ValidationResult.Ok,this.handleSuccessfulValidation(),this.handleUnsuccessfulValidation(),r;if(t.authResult.id_token){var p=this.tokenHelperService.getHeaderFromToken(r.idToken,!1);if(o&&!r.decodedIdToken.at_hash)this.loggerService.logDebug("Code Flow active, and no at_hash in the id_token, skipping check!");else if(!this.tokenValidationService.validateIdTokenAtHash(r.accessToken,r.decodedIdToken.at_hash,p.alg)||!r.accessToken)return this.loggerService.logWarning("authorizedCallback incorrect at_hash"),r.state=e.ValidationResult.IncorrectAtHash,this.handleUnsuccessfulValidation(),r}return r.authResponseIsValid=!0,r.state=e.ValidationResult.Ok,this.handleSuccessfulValidation(),r},t.prototype.isIdTokenAfterRefreshTokenRequestValid=function(e,t){var r=this.configurationProvider.getOpenIDConfiguration(),n=r.useRefreshToken,i=r.disableRefreshIdTokenAuthTimeValidation;if(!n)return!0;if(!e.existingIdToken)return!0;var o=this.tokenHelperService.getPayloadFromToken(e.existingIdToken,!1);return o.iss!==t.iss?(this.loggerService.logDebug("iss do not match: "+o.iss+" "+t.iss),!1):o.azp!==t.azp?(this.loggerService.logDebug("azp do not match: "+o.azp+" "+t.azp),!1):o.sub!==t.sub?(this.loggerService.logDebug("sub do not match: "+o.sub+" "+t.sub),!1):this.equalityService.isStringEqualOrNonOrderedArrayEqual(null==o?void 0:o.aud,null==t?void 0:t.aud)?!!i||(o.auth_time===t.auth_time||(this.loggerService.logDebug("auth_time do not match: "+o.auth_time+" "+t.auth_time),!1)):(this.loggerService.logDebug("aud in new id_token is not valid: '"+(null==o?void 0:o.aud)+"' '"+t.aud+"'"),!1)},t.prototype.handleSuccessfulValidation=function(){var e=this.configurationProvider.getOpenIDConfiguration().autoCleanStateAfterAuthentication;this.storagePersistanceService.write("authNonce",""),e&&this.storagePersistanceService.write("authStateControl",""),this.loggerService.logDebug("AuthorizedCallback token(s) validated, continue")},t.prototype.handleUnsuccessfulValidation=function(){var e=this.configurationProvider.getOpenIDConfiguration().autoCleanStateAfterAuthentication;this.storagePersistanceService.write("authNonce",""),e&&this.storagePersistanceService.write("authStateControl",""),this.loggerService.logDebug("AuthorizedCallback token(s) invalid")},t}();ee.decorators=[{type:n.Injectable}],ee.ctorParameters=function(){return[{type:R},{type:C},{type:P},{type:I},{type:d},{type:Q},{type:U}]};var te=function(){function t(e,t,r,n,i){this.loggerService=e,this.stateValidationService=t,this.authStateService=r,this.resetAuthDataService=n,this.doc=i}return t.prototype.callbackStateValidation=function(e){var t=this.stateValidationService.getValidatedStateResult(e);if(e.validationResult=t,t.authResponseIsValid)return this.authStateService.setAuthorizationData(t.accessToken,e.authResult),i.of(e);var r="authorizedCallback, token(s) validation failed, resetting. Hash: "+this.doc.location.hash;return this.loggerService.logWarning(r),this.resetAuthDataService.resetAuthorizationData(),this.publishUnauthorizedState(e.validationResult,e.isRenewProcess),i.throwError(r)},t.prototype.publishUnauthorizedState=function(t,r){this.authStateService.updateAndPublishAuthState({authorizationState:e.AuthorizedState.Unauthorized,validationResult:t.state,isRenewProcess:r})},t}();te.decorators=[{type:n.Injectable}],te.ctorParameters=function(){return[{type:I},{type:ee},{type:E},{type:B},{type:void 0,decorators:[{type:n.Inject,args:[t.DOCUMENT]}]}]};var re=function(){function t(e,t,r,n,i,o){this.loggerService=e,this.configurationProvider=t,this.authStateService=r,this.flowsDataService=n,this.userService=i,this.resetAuthDataService=o}return t.prototype.callbackUser=function(e){var t=this,r=e.isRenewProcess,n=e.validationResult,o=e.authResult,a=e.refreshToken,c=this.configurationProvider.getOpenIDConfiguration(),u=c.autoUserinfo,l=c.renewUserInfoAfterTokenRenew;return u?this.userService.getAndPersistUserDataInStore(r,n.idToken,n.decodedIdToken).pipe(s.switchMap((function(s){if(s)return a||t.flowsDataService.setSessionState(o.session_state),t.publishAuthorizedState(n,r),i.of(e);t.resetAuthDataService.resetAuthorizationData(),t.publishUnauthorizedState(n,r);var c="Called for userData but they were "+s;return t.loggerService.logWarning(c),i.throwError(c)})),s.catchError((function(e){var r="Failed to retrieve user info with error:  "+e;return t.loggerService.logWarning(r),i.throwError(r)}))):(r&&!l||n.decodedIdToken&&this.userService.setUserDataToStore(n.decodedIdToken),r||a||this.flowsDataService.setSessionState(o.session_state),this.publishAuthorizedState(n,r),i.of(e))},t.prototype.publishAuthorizedState=function(t,r){this.authStateService.updateAndPublishAuthState({authorizationState:e.AuthorizedState.Authorized,validationResult:t.state,isRenewProcess:r})},t.prototype.publishUnauthorizedState=function(t,r){this.authStateService.updateAndPublishAuthState({authorizationState:e.AuthorizedState.Unauthorized,validationResult:t.state,isRenewProcess:r})},t}();re.decorators=[{type:n.Injectable}],re.ctorParameters=function(){return[{type:I},{type:d},{type:E},{type:O},{type:N},{type:B}]};var ne=function(){function e(e,t,r,n,i,o,a){this.codeFlowCallbackHandlerService=e,this.implicitFlowCallbackHandlerService=t,this.historyJwtKeysCallbackHandlerService=r,this.userHandlerService=n,this.stateValidationCallbackHandlerService=i,this.refreshSessionCallbackHandlerService=o,this.refreshTokenCallbackHandlerService=a}return e.prototype.processCodeFlowCallback=function(e){var t=this;return this.codeFlowCallbackHandlerService.codeFlowCallback(e).pipe(s.switchMap((function(e){return t.codeFlowCallbackHandlerService.codeFlowCodeRequest(e)})),s.switchMap((function(e){return t.historyJwtKeysCallbackHandlerService.callbackHistoryAndResetJwtKeys(e)})),s.switchMap((function(e){return t.stateValidationCallbackHandlerService.callbackStateValidation(e)})),s.switchMap((function(e){return t.userHandlerService.callbackUser(e)})))},e.prototype.processSilentRenewCodeFlowCallback=function(e){var t=this;return this.codeFlowCallbackHandlerService.codeFlowCodeRequest(e).pipe(s.switchMap((function(e){return t.historyJwtKeysCallbackHandlerService.callbackHistoryAndResetJwtKeys(e)})),s.switchMap((function(e){return t.stateValidationCallbackHandlerService.callbackStateValidation(e)})),s.switchMap((function(e){return t.userHandlerService.callbackUser(e)})))},e.prototype.processImplicitFlowCallback=function(e){var t=this;return this.implicitFlowCallbackHandlerService.implicitFlowCallback(e).pipe(s.switchMap((function(e){return t.historyJwtKeysCallbackHandlerService.callbackHistoryAndResetJwtKeys(e)})),s.switchMap((function(e){return t.stateValidationCallbackHandlerService.callbackStateValidation(e)})),s.switchMap((function(e){return t.userHandlerService.callbackUser(e)})))},e.prototype.processRefreshToken=function(e){var t=this;return this.refreshSessionCallbackHandlerService.refreshSessionWithRefreshTokens().pipe(s.switchMap((function(r){return t.refreshTokenCallbackHandlerService.refreshTokensRequestTokens(r,e)})),s.switchMap((function(e){return t.historyJwtKeysCallbackHandlerService.callbackHistoryAndResetJwtKeys(e)})),s.switchMap((function(e){return t.stateValidationCallbackHandlerService.callbackStateValidation(e)})),s.switchMap((function(e){return t.userHandlerService.callbackUser(e)})))},e}();ne.decorators=[{type:n.Injectable}],ne.ctorParameters=function(){return[{type:M},{type:G},{type:J},{type:re},{type:te},{type:Z},{type:Y}]};var ie=function(){function e(e){this.zone=e,this.runTokenValidationRunning=null}return e.prototype.stopPeriodicallTokenCheck=function(){this.runTokenValidationRunning&&(this.runTokenValidationRunning.unsubscribe(),this.runTokenValidationRunning=null)},e.prototype.startPeriodicTokenCheck=function(e){var t=this,r=1e3*e;return new i.Observable((function(e){var n;return t.zone.runOutsideAngular((function(){n=setInterval((function(){return e.next()}),r)})),function(){clearInterval(n)}}))},e}();ie.ɵprov=n.ɵɵdefineInjectable({factory:function(){return new ie(n.ɵɵinject(n.NgZone))},token:ie,providedIn:"root"}),ie.decorators=[{type:n.Injectable,args:[{providedIn:"root"}]}],ie.ctorParameters=function(){return[{type:n.NgZone}]};var oe=function(){function e(e,t,r,n,i){this.flowsService=e,this.configurationProvider=t,this.router=r,this.flowsDataService=n,this.intervalService=i}return e.prototype.authorizedImplicitFlowCallback=function(e){var t=this,r=this.flowsDataService.isSilentRenewRunning(),n=this.configurationProvider.getOpenIDConfiguration(),o=n.triggerAuthorizationResultEvent,a=n.postLoginRoute,c=n.unauthorizedRoute;return this.flowsService.processImplicitFlowCallback(e).pipe(s.tap((function(e){o||e.isRenewProcess||t.router.navigate([a])})),s.catchError((function(e){return t.flowsDataService.resetSilentRenewRunning(),t.intervalService.stopPeriodicallTokenCheck(),o||r||t.router.navigate([c]),i.throwError(e)})))},e}();oe.ɵprov=n.ɵɵdefineInjectable({factory:function(){return new oe(n.ɵɵinject(ne),n.ɵɵinject(d),n.ɵɵinject(a.Router),n.ɵɵinject(O),n.ɵɵinject(ie))},token:oe,providedIn:"root"}),oe.decorators=[{type:n.Injectable,args:[{providedIn:"root"}]}],oe.ctorParameters=function(){return[{type:ne},{type:d},{type:a.Router},{type:O},{type:ie}]};var ae=function(){function e(e,t,r,n,i){this.flowsService=e,this.flowsDataService=t,this.intervallService=r,this.configurationProvider=n,this.router=i}return e.prototype.authorizedCallbackWithCode=function(e){var t=this,r=this.flowsDataService.isSilentRenewRunning(),n=this.configurationProvider.getOpenIDConfiguration(),o=n.triggerAuthorizationResultEvent,a=n.postLoginRoute,c=n.unauthorizedRoute;return this.flowsService.processCodeFlowCallback(e).pipe(s.tap((function(e){o||e.isRenewProcess||t.router.navigate([a])})),s.catchError((function(e){return t.flowsDataService.resetSilentRenewRunning(),t.intervallService.stopPeriodicallTokenCheck(),o||r||t.router.navigate([c]),i.throwError(e)})))},e}();ae.ɵprov=n.ɵɵdefineInjectable({factory:function(){return new ae(n.ɵɵinject(ne),n.ɵɵinject(O),n.ɵɵinject(ie),n.ɵɵinject(d),n.ɵɵinject(a.Router))},token:ae,providedIn:"root"}),ae.decorators=[{type:n.Injectable,args:[{providedIn:"root"}]}],ae.ctorParameters=function(){return[{type:ne},{type:O},{type:ie},{type:d},{type:a.Router}]};var se=function(){function e(e,t,r,n){this.urlService=e,this.flowHelper=t,this.implicitFlowCallbackService=r,this.codeFlowCallbackService=n,this.stsCallbackInternal$=new i.Subject}return Object.defineProperty(e.prototype,"stsCallback$",{get:function(){return this.stsCallbackInternal$.asObservable()},enumerable:!1,configurable:!0}),e.prototype.isCallback=function(e){return this.urlService.isCallbackFromSts(e)},e.prototype.handleCallbackAndFireEvents=function(e){var t,r=this;return this.flowHelper.isCurrentFlowCodeFlow()?t=this.codeFlowCallbackService.authorizedCallbackWithCode(e):this.flowHelper.isCurrentFlowAnyImplicitFlow()&&(t=this.implicitFlowCallbackService.authorizedImplicitFlowCallback()),t.pipe(s.tap((function(){return r.stsCallbackInternal$.next()})))},e}();se.ɵprov=n.ɵɵdefineInjectable({factory:function(){return new se(n.ɵɵinject(K),n.ɵɵinject(U),n.ɵɵinject(oe),n.ɵɵinject(ae))},token:se,providedIn:"root"}),se.decorators=[{type:n.Injectable,args:[{providedIn:"root"}]}],se.ctorParameters=function(){return[{type:K},{type:U},{type:oe},{type:ae}]};var ce=function(){function e(e,t){this.doc=e,this.loggerService=t}return e.prototype.getExistingIFrame=function(e){var t=this.getIFrameFromParentWindow(e);if(this.isIFrameElement(t))return t;var r=this.getIFrameFromWindow(e);return this.isIFrameElement(r)?r:null},e.prototype.addIFrameToWindowBody=function(e){var t=this.doc.createElement("iframe");return t.id=e,t.title=e,this.loggerService.logDebug(t),t.style.display="none",this.doc.body.appendChild(t),t},e.prototype.getIFrameFromParentWindow=function(e){try{var t=this.doc.defaultView.parent.document.getElementById(e);return this.isIFrameElement(t)?t:null}catch(e){return null}},e.prototype.getIFrameFromWindow=function(e){var t=this.doc.getElementById(e);return this.isIFrameElement(t)?t:null},e.prototype.isIFrameElement=function(e){return!!e&&e instanceof HTMLIFrameElement},e}();ce.decorators=[{type:n.Injectable}],ce.ctorParameters=function(){return[{type:void 0,decorators:[{type:n.Inject,args:[t.DOCUMENT]}]},{type:I}]};var ue="myiFrameForSilentRenew",le=function(){function t(e,t,r,n,o,a,s,c,u,l){this.configurationProvider=e,this.iFrameService=t,this.flowsService=r,this.resetAuthDataService=n,this.flowsDataService=o,this.authStateService=a,this.loggerService=s,this.flowHelper=c,this.implicitFlowCallbackService=u,this.intervalService=l,this.refreshSessionWithIFrameCompletedInternal$=new i.Subject}return Object.defineProperty(t.prototype,"refreshSessionWithIFrameCompleted$",{get:function(){return this.refreshSessionWithIFrameCompletedInternal$.asObservable()},enumerable:!1,configurable:!0}),t.prototype.getOrCreateIframe=function(){var e=this.getExistingIframe();return e||this.iFrameService.addIFrameToWindowBody(ue)},t.prototype.isSilentRenewConfigured=function(){var e=this.configurationProvider.getOpenIDConfiguration(),t=e.useRefreshToken,r=e.silentRenew;return!t&&r},t.prototype.codeFlowCallbackSilentRenewIframe=function(t){var n=this,o=new r.HttpParams({fromString:t[1]}),a=o.get("error");if(a)return this.authStateService.updateAndPublishAuthState({authorizationState:e.AuthorizedState.Unauthorized,validationResult:e.ValidationResult.LoginRequired,isRenewProcess:!0}),this.resetAuthDataService.resetAuthorizationData(),this.flowsDataService.setNonce(""),this.intervalService.stopPeriodicallTokenCheck(),i.throwError(a);var c={code:o.get("code"),refreshToken:null,state:o.get("state"),sessionState:o.get("session_state"),authResult:null,isRenewProcess:!0,jwtKeys:null,validationResult:null,existingIdToken:null};return this.flowsService.processSilentRenewCodeFlowCallback(c).pipe(s.catchError((function(e){return n.intervalService.stopPeriodicallTokenCheck(),n.resetAuthDataService.resetAuthorizationData(),i.throwError(e)})))},t.prototype.silentRenewEventHandler=function(e){var t=this;if(this.loggerService.logDebug("silentRenewEventHandler"),e.detail){var r=i.of(null);if(this.flowHelper.isCurrentFlowCodeFlow()){var n=e.detail.toString().split("?");r=this.codeFlowCallbackSilentRenewIframe(n)}else r=this.implicitFlowCallbackService.authorizedImplicitFlowCallback(e.detail);r.subscribe((function(e){t.refreshSessionWithIFrameCompletedInternal$.next(e),t.flowsDataService.resetSilentRenewRunning()}),(function(e){t.loggerService.logError("Error: "+e),t.refreshSessionWithIFrameCompletedInternal$.next(null),t.flowsDataService.resetSilentRenewRunning()}))}},t.prototype.getExistingIframe=function(){return this.iFrameService.getExistingIFrame(ue)},t}();le.decorators=[{type:n.Injectable}],le.ctorParameters=function(){return[{type:d},{type:ce},{type:ne},{type:B},{type:O},{type:E},{type:I},{type:U},{type:oe},{type:ie}]};var he=function(){function e(e,t,r,n,i){this.doc=e,this.loggerService=t,this.urlService=r,this.silentRenewService=n,this.renderer=i.createRenderer(null,null)}return e.prototype.refreshSessionWithIframe=function(e){this.loggerService.logDebug("BEGIN refresh session Authorize Iframe renew");var t=this.urlService.getRefreshSessionSilentRenewUrl(e);return this.sendAuthorizeRequestUsingSilentRenew(t)},e.prototype.sendAuthorizeRequestUsingSilentRenew=function(e){var t=this,r=this.silentRenewService.getOrCreateIframe();return this.initSilentRenewRequest(),this.loggerService.logDebug("sendAuthorizeRequestUsingSilentRenew for URL:"+e),new i.Observable((function(n){var i=function(){r.removeEventListener("load",i),t.loggerService.logDebug("removed event listener from IFrame"),n.next(!0),n.complete()};r.addEventListener("load",i),r.contentWindow.location.replace(e)}))},e.prototype.initSilentRenewRequest=function(){var e=this,t=Math.random(),r=this.renderer.listen("window","oidc-silent-renew-init",(function(e){e.detail!==t&&(r(),n())})),n=this.renderer.listen("window","oidc-silent-renew-message",(function(t){return e.silentRenewService.silentRenewEventHandler(t)}));this.doc.defaultView.dispatchEvent(new CustomEvent("oidc-silent-renew-init",{detail:t}))},e}();he.ɵprov=n.ɵɵdefineInjectable({factory:function(){return new he(n.ɵɵinject(t.DOCUMENT),n.ɵɵinject(I),n.ɵɵinject(K),n.ɵɵinject(le),n.ɵɵinject(n.RendererFactory2))},token:he,providedIn:"root"}),he.decorators=[{type:n.Injectable,args:[{providedIn:"root"}]}],he.ctorParameters=function(){return[{type:void 0,decorators:[{type:n.Inject,args:[t.DOCUMENT]}]},{type:I},{type:K},{type:le},{type:n.RendererFactory2}]};var de=function(){function e(e,t,r,n){this.loggerService=e,this.resetAuthDataService=t,this.flowsService=r,this.intervalService=n}return e.prototype.refreshSessionWithRefreshTokens=function(e){var t=this;return this.loggerService.logDebug("BEGIN refresh session Authorize"),this.flowsService.processRefreshToken(e).pipe(s.catchError((function(e){return t.intervalService.stopPeriodicallTokenCheck(),t.resetAuthDataService.resetAuthorizationData(),i.throwError(e)})))},e}();de.ɵprov=n.ɵɵdefineInjectable({factory:function(){return new de(n.ɵɵinject(I),n.ɵɵinject(B),n.ɵɵinject(ne),n.ɵɵinject(ie))},token:de,providedIn:"root"}),de.decorators=[{type:n.Injectable,args:[{providedIn:"root"}]}],de.ctorParameters=function(){return[{type:I},{type:B},{type:ne},{type:ie}]};var ge=function(){function e(e,t,r,n,i,o,a,s,c,u,l){this.resetAuthDataService=e,this.flowHelper=t,this.configurationProvider=r,this.flowsDataService=n,this.loggerService=i,this.userService=o,this.authStateService=a,this.refreshSessionIframeService=s,this.refreshSessionRefreshTokenService=c,this.intervalService=u,this.storagePersistanceService=l}return e.prototype.startTokenValidationPeriodically=function(e){var t=this,r=this.configurationProvider.getOpenIDConfiguration().silentRenew;if(!this.intervalService.runTokenValidationRunning&&r){this.loggerService.logDebug("starting token validation check every "+e+"s");var n=this.intervalService.startPeriodicTokenCheck(e).pipe(s.switchMap((function(){var e=t.authStateService.getIdToken(),r=t.flowsDataService.isSilentRenewRunning(),n=t.userService.getUserDataFromStore();if(t.loggerService.logDebug("Checking: silentRenewRunning: "+r+" id_token: "+!!e+" userData: "+!!n),!(n&&!r&&e))return i.of(null);var o=t.authStateService.hasIdTokenExpired(),a=t.authStateService.hasAccessTokenExpiredIfExpiryExists();if(!o&&!a)return i.of(null);var s=t.configurationProvider.getOpenIDConfiguration();if(!(null==s?void 0:s.silentRenew))return t.resetAuthDataService.resetAuthorizationData(),i.of(null);t.loggerService.logDebug("starting silent renew..."),t.flowsDataService.setSilentRenewRunning();var c=t.storagePersistanceService.read("storageCustomRequestParams");return t.flowHelper.isCurrentFlowCodeFlowWithRefreshTokens()?t.refreshSessionRefreshTokenService.refreshSessionWithRefreshTokens(c):t.refreshSessionIframeService.refreshSessionWithIframe(c)})));this.intervalService.runTokenValidationRunning=n.pipe(s.catchError((function(){return t.flowsDataService.resetSilentRenewRunning(),i.throwError("periodically check failed")}))).subscribe((function(){t.loggerService.logDebug("silent renew, periodic check finished!"),t.flowHelper.isCurrentFlowCodeFlowWithRefreshTokens()&&t.flowsDataService.resetSilentRenewRunning()}),(function(e){t.loggerService.logError("silent renew failed!",e)}))}},e}();ge.ɵprov=n.ɵɵdefineInjectable({factory:function(){return new ge(n.ɵɵinject(B),n.ɵɵinject(U),n.ɵɵinject(d),n.ɵɵinject(O),n.ɵɵinject(I),n.ɵɵinject(N),n.ɵɵinject(E),n.ɵɵinject(he),n.ɵɵinject(de),n.ɵɵinject(ie),n.ɵɵinject(R))},token:ge,providedIn:"root"}),ge.decorators=[{type:n.Injectable,args:[{providedIn:"root"}]}],ge.ctorParameters=function(){return[{type:B},{type:U},{type:d},{type:O},{type:I},{type:N},{type:E},{type:he},{type:de},{type:ie},{type:R}]};var pe="/.well-known/openid-configuration",fe=function(){function e(e){this.http=e}return e.prototype.getWellKnownEndPointsFromUrl=function(e){return this.getWellKnownDocument(e).pipe(s.map((function(e){return{issuer:e.issuer,jwksUri:e.jwks_uri,authorizationEndpoint:e.authorization_endpoint,tokenEndpoint:e.token_endpoint,userinfoEndpoint:e.userinfo_endpoint,endSessionEndpoint:e.end_session_endpoint,checkSessionIframe:e.check_session_iframe,revocationEndpoint:e.revocation_endpoint,introspectionEndpoint:e.introspection_endpoint,parEndpoint:e.pushed_authorization_request_endpoint}})))},e.prototype.getWellKnownDocument=function(e){var t=e;return e.includes(pe)||(t=""+e+pe),this.http.get(t).pipe(s.retry(2))},e}();fe.decorators=[{type:n.Injectable}],fe.ctorParameters=function(){return[{type:f}]};var ve=function(){function t(e,t,r){this.publicEventsService=e,this.dataService=t,this.storagePersistanceService=r}return t.prototype.getAuthWellKnownEndPoints=function(t){var r=this,n=this.storagePersistanceService.read("authWellKnownEndPoints");return n?i.of(n):this.getWellKnownEndPointsFromUrl(t).pipe(s.tap((function(e){return r.storeWellKnownEndpoints(e)})),s.catchError((function(t){return r.publicEventsService.fireEvent(e.EventTypes.ConfigLoadingFailed,null),i.throwError(t)})))},t.prototype.storeWellKnownEndpoints=function(e){this.storagePersistanceService.write("authWellKnownEndPoints",e)},t.prototype.getWellKnownEndPointsFromUrl=function(e){return this.dataService.getWellKnownEndPointsFromUrl(e)},t}();ve.decorators=[{type:n.Injectable}],ve.ctorParameters=function(){return[{type:m},{type:fe},{type:R}]};var Se=function(){function e(e,t,r,n,i,o,a,s,c){this.flowHelper=e,this.configurationProvider=t,this.flowsDataService=r,this.loggerService=n,this.silentRenewService=i,this.authStateService=o,this.authWellKnownService=a,this.refreshSessionIframeService=s,this.refreshSessionRefreshTokenService=c}return e.prototype.forceRefreshSession=function(e){var t=this;if(this.flowHelper.isCurrentFlowCodeFlowWithRefreshTokens())return this.startRefreshSession(e).pipe(s.map((function(){return t.authStateService.areAuthStorageTokensValid()?{idToken:t.authStateService.getIdToken(),accessToken:t.authStateService.getAccessToken()}:null})));var r=1e3*this.configurationProvider.getOpenIDConfiguration().silentRenewTimeoutInSeconds;return i.forkJoin([this.startRefreshSession(e),this.silentRenewService.refreshSessionWithIFrameCompleted$.pipe(s.take(1))]).pipe(s.timeout(r),s.retryWhen(this.timeoutRetryStrategy.bind(this)),s.map((function(e){var r,n,i=S(e,2),o=(i[0],i[1]);return t.authStateService.areAuthStorageTokensValid()?{idToken:null===(r=null==o?void 0:o.authResult)||void 0===r?void 0:r.id_token,accessToken:null===(n=null==o?void 0:o.authResult)||void 0===n?void 0:n.access_token}:null})))},e.prototype.startRefreshSession=function(e){var t=this,r=this.flowsDataService.isSilentRenewRunning();if(this.loggerService.logDebug("Checking: silentRenewRunning: "+r),!!r)return i.of(null);var n=(this.configurationProvider.getOpenIDConfiguration()||{}).authWellknownEndpoint;return n?this.authWellKnownService.getAuthWellKnownEndPoints(n).pipe(s.switchMap((function(){return t.flowsDataService.setSilentRenewRunning(),t.flowHelper.isCurrentFlowCodeFlowWithRefreshTokens()?t.refreshSessionRefreshTokenService.refreshSessionWithRefreshTokens(e):t.refreshSessionIframeService.refreshSessionWithIframe(e)}))):(this.loggerService.logError("no authwellknownendpoint given!"),i.of(null))},e.prototype.timeoutRetryStrategy=function(e){var t=this;return e.pipe(s.mergeMap((function(e,r){var n=r+1;return!(e instanceof i.TimeoutError)||n>3?i.throwError(e):(t.loggerService.logDebug("forceRefreshSession timeout. Attempt #"+n),t.flowsDataService.resetSilentRenewRunning(),i.timer(1e3*n))})))},e}();Se.ɵprov=n.ɵɵdefineInjectable({factory:function(){return new Se(n.ɵɵinject(U),n.ɵɵinject(d),n.ɵɵinject(O),n.ɵɵinject(I),n.ɵɵinject(le),n.ɵɵinject(E),n.ɵɵinject(ve),n.ɵɵinject(he),n.ɵɵinject(de))},token:Se,providedIn:"root"}),Se.decorators=[{type:n.Injectable,args:[{providedIn:"root"}]}],Se.ctorParameters=function(){return[{type:U},{type:d},{type:O},{type:I},{type:le},{type:E},{type:ve},{type:he},{type:de}]};var ye="myiFrameForCheckSession",we=function(){function t(e,t,r,n,o,a){this.storagePersistanceService=e,this.loggerService=t,this.iFrameService=r,this.eventService=n,this.configurationProvider=o,this.zone=a,this.checkSessionReceived=!1,this.lastIFrameRefresh=0,this.outstandingMessages=0,this.heartBeatInterval=3e3,this.iframeRefreshInterval=6e4,this.checkSessionChangedInternal$=new i.BehaviorSubject(!1)}return Object.defineProperty(t.prototype,"checkSessionChanged$",{get:function(){return this.checkSessionChangedInternal$.asObservable()},enumerable:!1,configurable:!0}),t.prototype.isCheckSessionConfigured=function(){return this.configurationProvider.getOpenIDConfiguration().startCheckSession},t.prototype.start=function(){if(!this.scheduledHeartBeatRunning){var e=this.configurationProvider.getOpenIDConfiguration().clientId;this.pollServerSession(e)}},t.prototype.stop=function(){this.scheduledHeartBeatRunning&&(this.clearScheduledHeartBeat(),this.checkSessionReceived=!1)},t.prototype.serverStateChanged=function(){return this.configurationProvider.getOpenIDConfiguration().startCheckSession&&this.checkSessionReceived},t.prototype.getExistingIframe=function(){return this.iFrameService.getExistingIFrame(ye)},t.prototype.init=function(){var e=this;if(this.lastIFrameRefresh+this.iframeRefreshInterval>Date.now())return i.of(void 0);var t=this.storagePersistanceService.read("authWellKnownEndPoints");if(!t)return this.loggerService.logWarning("init check session: authWellKnownEndpoints is undefined. Returning."),i.of();var r=this.getOrCreateIframe(),n=t.checkSessionIframe;return n?r.contentWindow.location.replace(n):this.loggerService.logWarning("init check session: checkSessionIframe is not configured to run"),new i.Observable((function(t){r.onload=function(){e.lastIFrameRefresh=Date.now(),t.next(),t.complete()}}))},t.prototype.pollServerSession=function(e){var t=this;this.outstandingMessages=0;var r=function(){t.init().pipe(s.take(1)).subscribe((function(){var n,i=t.getExistingIframe();if(i&&e){t.loggerService.logDebug(i);var o=t.storagePersistanceService.read("session_state"),a=t.storagePersistanceService.read("authWellKnownEndPoints");if(o&&(null==a?void 0:a.checkSessionIframe)){var s=null===(n=new URL(a.checkSessionIframe))||void 0===n?void 0:n.origin;t.outstandingMessages++,i.contentWindow.postMessage(e+" "+o,s)}else t.loggerService.logDebug("OidcSecurityCheckSession pollServerSession session_state is '"+o+"'"),t.loggerService.logDebug("AuthWellKnownEndPoints is '"+JSON.stringify(a)+"'"),t.checkSessionChangedInternal$.next(!0)}else t.loggerService.logWarning("OidcSecurityCheckSession pollServerSession checkSession IFrame does not exist"),t.loggerService.logDebug(e),t.loggerService.logDebug(i);t.outstandingMessages>3&&t.loggerService.logError("OidcSecurityCheckSession not receiving check session response messages.\n                            Outstanding messages: "+t.outstandingMessages+". Server unreachable?"),t.zone.runOutsideAngular((function(){t.scheduledHeartBeatRunning=setTimeout((function(){return t.zone.run(r)}),t.heartBeatInterval)}))}))};r()},t.prototype.clearScheduledHeartBeat=function(){clearTimeout(this.scheduledHeartBeatRunning),this.scheduledHeartBeatRunning=null},t.prototype.messageHandler=function(t){var r,n=this.getExistingIframe(),i=this.storagePersistanceService.read("authWellKnownEndPoints"),o=!!(null===(r=null==i?void 0:i.checkSessionIframe)||void 0===r?void 0:r.startsWith(t.origin));this.outstandingMessages=0,n&&o&&t.source===n.contentWindow&&("error"===t.data?this.loggerService.logWarning("error from checksession messageHandler"):"changed"===t.data?(this.loggerService.logDebug(t),this.checkSessionReceived=!0,this.eventService.fireEvent(e.EventTypes.CheckSessionReceived,t.data),this.checkSessionChangedInternal$.next(!0)):(this.eventService.fireEvent(e.EventTypes.CheckSessionReceived,t.data),this.loggerService.logDebug(t.data+" from checksession messageHandler")))},t.prototype.bindMessageEventToIframe=function(){var e=this.messageHandler.bind(this);window.addEventListener("message",e,!1)},t.prototype.getOrCreateIframe=function(){var e=this.getExistingIframe();if(!e){var t=this.iFrameService.addIFrameToWindowBody(ye);return this.bindMessageEventToIframe(),t}return e},t}();we.decorators=[{type:n.Injectable}],we.ctorParameters=function(){return[{type:R},{type:I},{type:ce},{type:m},{type:d},{type:n.NgZone}]};var ke=function(){function e(){this.STORAGE_IDENTIFIER="popupauth",this.receivedUrlInternal$=new i.Subject}return Object.defineProperty(e.prototype,"receivedUrl$",{get:function(){return this.receivedUrlInternal$.asObservable()},enumerable:!1,configurable:!0}),e.prototype.isCurrentlyInPopup=function(){var e=sessionStorage.getItem(this.STORAGE_IDENTIFIER);return!!window.opener&&window.opener!==window&&!!e},e.prototype.openPopUp=function(e,t){var r=this,n=this.getOptions(t);this.popUp=window.open(e,"_blank",n),this.popUp.sessionStorage.setItem(this.STORAGE_IDENTIFIER,"true");var i=function(e){(null==e?void 0:e.data)&&"string"==typeof e.data&&(r.receivedUrlInternal$.next(e.data),r.cleanUp(i))};window.addEventListener("message",i,!1)},e.prototype.sendMessageToMainWindow=function(e){window.opener&&this.sendMessage(e,window.location.href)},e.prototype.cleanUp=function(e){window.removeEventListener("message",e,!1),this.popUp&&(this.popUp.sessionStorage.removeItem(this.STORAGE_IDENTIFIER),this.popUp.close(),this.popUp=null)},e.prototype.sendMessage=function(e,t){window.opener.postMessage(e,t)},e.prototype.getOptions=function(e){var t=Object.assign(Object.assign({},{width:500,height:500,left:50,top:50}),e||{});return Object.entries(t).map((function(e){var t=S(e,2),r=t[0],n=t[1];return encodeURIComponent(r)+"="+encodeURIComponent(n)})).join(",")},e}();ke.ɵprov=n.ɵɵdefineInjectable({factory:function(){return new ke},token:ke,providedIn:"root"}),ke.decorators=[{type:n.Injectable,args:[{providedIn:"root"}]}];var Ie=function(){function e(e,t,r,n,i,o,a,s,c,u,l,h,d){this.doc=e,this.checkSessionService=t,this.silentRenewService=r,this.userService=n,this.loggerService=i,this.configurationProvider=o,this.authStateService=a,this.callbackService=s,this.refreshSessionService=c,this.periodicallyTokenCheckService=u,this.popupService=l,this.autoLoginService=h,this.router=d}return e.prototype.checkAuth=function(e){var t=this;if(!this.configurationProvider.hasValidConfig())return this.loggerService.logError("Please provide a configuration before setting up the module"),i.of(!1);var r=this.configurationProvider.getOpenIDConfiguration().stsServer;this.loggerService.logDebug("STS server: ",r);var n=e||this.doc.defaultView.location.toString();if(this.popupService.isCurrentlyInPopup())return this.popupService.sendMessageToMainWindow(n),i.of(null);var o=this.callbackService.isCallback(n);return this.loggerService.logDebug("currentUrl to check auth with: ",n),(o?this.callbackService.handleCallbackAndFireEvents(n):i.of(null)).pipe(s.map((function(){var e=t.authStateService.areAuthStorageTokensValid();return e&&(t.startCheckSessionAndValidation(),o||(t.authStateService.setAuthorizedAndFireEvent(),t.userService.publishUserDataIfExists())),t.loggerService.logDebug("checkAuth completed fired events, auth: "+e),e})),s.tap((function(){var e=t.autoLoginService.getStoredRedirectRoute();e&&(t.autoLoginService.deleteStoredRedirectRoute(),t.router.navigate([e]))})),s.catchError((function(e){return t.loggerService.logError(e),i.of(!1)})))},e.prototype.checkAuthIncludingServer=function(){var e=this;return this.checkAuth().pipe(s.switchMap((function(t){return t?i.of(t):e.refreshSessionService.forceRefreshSession().pipe(s.map((function(e){return!!(null==e?void 0:e.idToken)&&!!(null==e?void 0:e.accessToken)})),s.switchMap((function(t){return t&&e.startCheckSessionAndValidation(),i.of(t)})))})))},e.prototype.startCheckSessionAndValidation=function(){this.checkSessionService.isCheckSessionConfigured()&&this.checkSessionService.start();var e=this.configurationProvider.getOpenIDConfiguration().tokenRefreshInSeconds;this.periodicallyTokenCheckService.startTokenValidationPeriodically(e),this.silentRenewService.isSilentRenewConfigured()&&this.silentRenewService.getOrCreateIframe()},e}();Ie.decorators=[{type:n.Injectable}],Ie.ctorParameters=function(){return[{type:void 0,decorators:[{type:n.Inject,args:[t.DOCUMENT]}]},{type:we},{type:le},{type:N},{type:I},{type:d},{type:E},{type:se},{type:Se},{type:ge},{type:ke},{type:D},{type:a.Router}]};var me={result:!0,messages:[],level:null},be=[function(e){return e.stsServer?me:{result:!1,messages:["The STS URL MUST be provided in the configuration!"],level:"error"}},function(e){var t=e.useRefreshToken,r=e.silentRenew,n=(e.scope||"").split(" ").includes("offline_access");return t&&r&&!n?{result:!1,messages:["When using silent renew and refresh tokens please set the `offline_access` scope"],level:"warning"}:me},function(e){return e.redirectUrl?me:{result:!1,messages:["The redirectURL is required and missing from your config"],level:"error"}},function(e){return e.clientId?me:{result:!1,messages:["The clientId is required and missing from your config!"],level:"error"}},function(e){var t=e.silentRenew,r=e.useRefreshToken,n=e.silentRenewUrl;return!t||r||n?me:{result:!1,messages:["Please provide a silent renew URL if using renew and not refresh tokens"],level:"error"}}],Re=function(){function e(e){this.loggerService=e}return e.prototype.validateConfig=function(e){var t=this,r=be.map((function(t){return t(e)})).filter((function(e){return e.messages.length>0})),n=this.getAllMessagesOfType("error",r),i=this.getAllMessagesOfType("warning",r);return n.map((function(e){return t.loggerService.logError(e)})),i.map((function(e){return t.loggerService.logWarning(e)})),0===n.length},e.prototype.getAllMessagesOfType=function(e,t){return t.filter((function(t){return t.level===e})).map((function(e){return e.messages})).reduce((function(e,t){return e.concat(t)}),[])},e}();Re.decorators=[{type:n.Injectable}],Re.ctorParameters=function(){return[{type:I}]};var Pe=function(){function t(e,t,r,n,i,o){this.loggerService=e,this.publicEventsService=t,this.configurationProvider=r,this.authWellKnownService=n,this.storagePersistanceService=i,this.configValidationService=o}return t.prototype.withConfig=function(t,r){var n=this;return new Promise((function(o,a){n.configValidationService.validateConfig(t)||(n.loggerService.logError("Validation of config rejected with errors. Config is NOT set."),o()),t.authWellknownEndpoint||(t.authWellknownEndpoint=t.stsServer);var c=n.configurationProvider.setConfig(t),u=n.storagePersistanceService.read("authWellKnownEndPoints");u&&(n.publicEventsService.fireEvent(e.EventTypes.ConfigLoaded,{configuration:t,wellknown:u}),o()),r&&(n.authWellKnownService.storeWellKnownEndpoints(r),n.publicEventsService.fireEvent(e.EventTypes.ConfigLoaded,{configuration:t,wellknown:r}),o()),c.eagerLoadAuthWellKnownEndpoints?n.authWellKnownService.getAuthWellKnownEndPoints(c.authWellknownEndpoint).pipe(s.catchError((function(e){return n.loggerService.logError("Getting auth well known endpoints failed on start",e),i.throwError(e)})),s.tap((function(r){return n.publicEventsService.fireEvent(e.EventTypes.ConfigLoaded,{configuration:t,wellknown:r})}))).subscribe((function(){return o()}),(function(){return a()})):(n.publicEventsService.fireEvent(e.EventTypes.ConfigLoaded,{configuration:t,wellknown:null}),o())}))},t}();Pe.decorators=[{type:n.Injectable}],Pe.ctorParameters=function(){return[{type:I},{type:m},{type:d},{type:ve},{type:R},{type:Re}]};var Ce=function(){function e(e){this.doc=e}return e.prototype.redirectTo=function(e){this.doc.location.href=e},e}();Ce.ɵprov=n.ɵɵdefineInjectable({factory:function(){return new Ce(n.ɵɵinject(t.DOCUMENT))},token:Ce,providedIn:"root"}),Ce.decorators=[{type:n.Injectable,args:[{providedIn:"root"}]}],Ce.ctorParameters=function(){return[{type:void 0,decorators:[{type:n.Inject,args:[t.DOCUMENT]}]}]};var Ee=function(){function e(e,t){this.loggerService=e,this.flowHelper=t}return e.prototype.hasConfigValidResponseType=function(){return!!this.flowHelper.isCurrentFlowAnyImplicitFlow()||(!!this.flowHelper.isCurrentFlowCodeFlow()||(this.loggerService.logWarning("module configured incorrectly, invalid response_type. Check the responseType in the config"),!1))},e}();Ee.decorators=[{type:n.Injectable}],Ee.ctorParameters=function(){return[{type:I},{type:U}]};var Te=function(){function e(e,t,r,n){this.loggerService=e,this.urlService=t,this.dataService=r,this.storagePersistanceService=n}return e.prototype.postParRequest=function(e){var t=this,n=new r.HttpHeaders;n=n.set("Content-Type","application/x-www-form-urlencoded");var o=this.storagePersistanceService.read("authWellKnownEndPoints");if(!o)return i.throwError("Could not read PAR endpoint because authWellKnownEndPoints are not given");var a=o.parEndpoint;if(!a)return i.throwError("Could not read PAR endpoint from authWellKnownEndpoints");var c=this.urlService.createBodyForParCodeFlowRequest(e);return this.dataService.post(a,c,n).pipe(s.retry(2),s.map((function(e){return t.loggerService.logDebug("par response: ",e),{expiresIn:e.expires_in,requestUri:e.request_uri}})),s.catchError((function(e){var r="There was an error on ParService postParRequest";return t.loggerService.logError(r,e),i.throwError(r)})))},e}();Te.decorators=[{type:n.Injectable}],Te.ctorParameters=function(){return[{type:I},{type:K},{type:f},{type:R}]};var De=function(){function e(e,t,r,n,i,o,a,s,c,u,l){this.loggerService=e,this.responseTypeValidationService=t,this.urlService=r,this.redirectService=n,this.configurationProvider=i,this.authWellKnownService=o,this.popupService=a,this.checkAuthService=s,this.userService=c,this.authStateService=u,this.parService=l}return e.prototype.loginPar=function(e){var t=this;if(this.responseTypeValidationService.hasConfigValidResponseType()){var r=this.configurationProvider.getOpenIDConfiguration().authWellknownEndpoint;if(r){this.loggerService.logDebug("BEGIN Authorize OIDC Flow, no auth data");var n=e||{},i=n.urlHandler,o=n.customParams;this.authWellKnownService.getAuthWellKnownEndPoints(r).pipe(s.switchMap((function(){return t.parService.postParRequest(o)}))).subscribe((function(e){t.loggerService.logDebug("par response: ",e);var r=t.urlService.getAuthorizeParUrl(e.requestUri);t.loggerService.logDebug("par request url: ",r),r?i?i(r):t.redirectService.redirectTo(r):t.loggerService.logError("Could not create url with param "+e.requestUri+": '"+r+"'")}))}else this.loggerService.logError("no authWellknownEndpoint given!")}else this.loggerService.logError("Invalid response type!")},e.prototype.loginWithPopUpPar=function(e,t){var r=this;if(!this.responseTypeValidationService.hasConfigValidResponseType()){var n="Invalid response type!";return this.loggerService.logError(n),i.throwError(n)}var o=this.configurationProvider.getOpenIDConfiguration().authWellknownEndpoint;if(!o){n="no authWellknownEndpoint given!";return this.loggerService.logError(n),i.throwError(n)}this.loggerService.logDebug("BEGIN Authorize OIDC Flow with popup, no auth data");var a=(e||{}).customParams;return this.authWellKnownService.getAuthWellKnownEndPoints(o).pipe(s.switchMap((function(){return r.parService.postParRequest(a)})),s.switchMap((function(e){r.loggerService.logDebug("par response: ",e);var n=r.urlService.getAuthorizeParUrl(e.requestUri);if(r.loggerService.logDebug("par request url: ",n),!n){var o="Could not create url with param "+e.requestUri+": 'url'";return r.loggerService.logError(o),i.throwError(o)}return r.popupService.openPopUp(n,t),r.popupService.receivedUrl$.pipe(s.take(1),s.switchMap((function(e){return r.checkAuthService.checkAuth(e)})),s.map((function(e){return{isAuthenticated:e,userData:r.userService.getUserDataFromStore(),accessToken:r.authStateService.getAccessToken()}})))})))},e}();De.decorators=[{type:n.Injectable}],De.ctorParameters=function(){return[{type:I},{type:Ee},{type:K},{type:Ce},{type:d},{type:ve},{type:ke},{type:Ie},{type:N},{type:E},{type:Te}]};var Ae=function(){function e(e,t,r,n,i,o,a,s,c){this.loggerService=e,this.responseTypeValidationService=t,this.urlService=r,this.configurationProvider=n,this.authWellKnownService=i,this.popupService=o,this.checkAuthService=a,this.userService=s,this.authStateService=c}return e.prototype.loginWithPopUpStandard=function(e,t){var r=this;if(!this.responseTypeValidationService.hasConfigValidResponseType()){var n="Invalid response type!";return this.loggerService.logError(n),i.throwError(n)}var o=this.configurationProvider.getOpenIDConfiguration().authWellknownEndpoint;if(!o){n="no authWellknownEndpoint given!";return this.loggerService.logError(n),i.throwError(n)}return this.loggerService.logDebug("BEGIN Authorize OIDC Flow with popup, no auth data"),this.authWellKnownService.getAuthWellKnownEndPoints(o).pipe(s.switchMap((function(){var n=(e||{}).customParams,i=r.urlService.getAuthorizeUrl(n);return r.popupService.openPopUp(i,t),r.popupService.receivedUrl$.pipe(s.take(1),s.switchMap((function(e){return r.checkAuthService.checkAuth(e)})),s.map((function(e){return{isAuthenticated:e,userData:r.userService.getUserDataFromStore(),accessToken:r.authStateService.getAccessToken()}})))})))},e}();Ae.decorators=[{type:n.Injectable}],Ae.ctorParameters=function(){return[{type:I},{type:Ee},{type:K},{type:d},{type:ve},{type:ke},{type:Ie},{type:N},{type:E}]};var Oe=function(){function e(e,t,r,n,i,o){this.loggerService=e,this.responseTypeValidationService=t,this.urlService=r,this.redirectService=n,this.configurationProvider=i,this.authWellKnownService=o}return e.prototype.loginStandard=function(e){var t=this;if(this.responseTypeValidationService.hasConfigValidResponseType()){var r=this.configurationProvider.getOpenIDConfiguration().authWellknownEndpoint;r?(this.loggerService.logDebug("BEGIN Authorize OIDC Flow, no auth data"),this.authWellKnownService.getAuthWellKnownEndPoints(r).subscribe((function(){var r=e||{},n=r.urlHandler,i=r.customParams,o=t.urlService.getAuthorizeUrl(i);o?n?n(o):t.redirectService.redirectTo(o):t.loggerService.logError("Could not create url",o)}))):this.loggerService.logError("no authWellknownEndpoint given!")}else this.loggerService.logError("Invalid response type!")},e}();Oe.decorators=[{type:n.Injectable}],Oe.ctorParameters=function(){return[{type:I},{type:Ee},{type:K},{type:Ce},{type:d},{type:ve}]};var Ue=function(){function e(e,t,r,n){this.configurationProvider=e,this.parLoginService=t,this.popUpLoginService=r,this.standardLoginService=n}return e.prototype.login=function(e){return this.configurationProvider.getOpenIDConfiguration().usePushedAuthorisationRequests?this.parLoginService.loginPar(e):this.standardLoginService.loginStandard(e)},e.prototype.loginWithPopUp=function(e,t){return this.configurationProvider.getOpenIDConfiguration().usePushedAuthorisationRequests?this.parLoginService.loginWithPopUpPar(e,t):this.popUpLoginService.loginWithPopUpStandard(e,t)},e}();Ue.decorators=[{type:n.Injectable}],Ue.ctorParameters=function(){return[{type:d},{type:De},{type:Ae},{type:Oe}]};var je=function(){function e(e,t,r,n,i,o,a){this.dataService=e,this.storagePersistanceService=t,this.loggerService=r,this.urlService=n,this.checkSessionService=i,this.resetAuthDataService=o,this.redirectService=a}return e.prototype.logoff=function(e){this.loggerService.logDebug("logoff, remove auth ");var t=this.getEndSessionUrl();this.resetAuthDataService.resetAuthorizationData(),t?this.checkSessionService.serverStateChanged()?this.loggerService.logDebug("only local login cleaned up, server session has changed"):e?e(t):this.redirectService.redirectTo(t):this.loggerService.logDebug("only local login cleaned up, no end_session_endpoint")},e.prototype.logoffLocal=function(){this.resetAuthDataService.resetAuthorizationData(),this.checkSessionService.stop()},e.prototype.logoffAndRevokeTokens=function(e){var t,r=this;return(null===(t=this.storagePersistanceService.read("authWellKnownEndPoints"))||void 0===t?void 0:t.revocationEndpoint)||(this.loggerService.logDebug("revocation endpoint not supported"),this.logoff(e)),this.storagePersistanceService.getRefreshToken()?this.revokeRefreshToken().pipe(s.switchMap((function(e){return r.revokeAccessToken(e)})),s.catchError((function(e){var t="revoke token failed";return r.loggerService.logError(t,e),i.throwError(t)})),s.tap((function(){return r.logoff(e)}))):this.revokeAccessToken().pipe(s.catchError((function(e){var t="revoke access token failed";return r.loggerService.logError(t,e),i.throwError(t)})),s.tap((function(){return r.logoff(e)})))},e.prototype.revokeAccessToken=function(e){var t=this,n=e||this.storagePersistanceService.getAccessToken(),o=this.urlService.createRevocationEndpointBodyAccessToken(n),a=this.urlService.getRevocationEndpointUrl(),c=new r.HttpHeaders;return c=c.set("Content-Type","application/x-www-form-urlencoded"),this.dataService.post(a,o,c).pipe(s.retry(2),s.switchMap((function(e){return t.loggerService.logDebug("revocation endpoint post response: ",e),i.of(e)})),s.catchError((function(e){var r="Revocation request failed";return t.loggerService.logError(r,e),i.throwError(r)})))},e.prototype.revokeRefreshToken=function(e){var t=this,n=e||this.storagePersistanceService.getRefreshToken(),o=this.urlService.createRevocationEndpointBodyRefreshToken(n),a=this.urlService.getRevocationEndpointUrl(),c=new r.HttpHeaders;return c=c.set("Content-Type","application/x-www-form-urlencoded"),this.dataService.post(a,o,c).pipe(s.retry(2),s.switchMap((function(e){return t.loggerService.logDebug("revocation endpoint post response: ",e),i.of(e)})),s.catchError((function(e){var r="Revocation request failed";return t.loggerService.logError(r,e),i.throwError(r)})))},e.prototype.getEndSessionUrl=function(){var e=this.storagePersistanceService.getIdToken();return this.urlService.createEndSessionUrl(e)},e}();je.decorators=[{type:n.Injectable}],je.ctorParameters=function(){return[{type:f},{type:R},{type:I},{type:K},{type:we},{type:B},{type:Ce}]};var Fe=function(){function e(e,t,r,n,i,o,a,s,c,u,l,h){this.checkSessionService=e,this.checkAuthService=t,this.userService=r,this.tokenHelperService=n,this.configurationProvider=i,this.authStateService=o,this.flowsDataService=a,this.callbackService=s,this.logoffRevocationService=c,this.loginService=u,this.storagePersistanceService=l,this.refreshSessionService=h}return Object.defineProperty(e.prototype,"configuration",{get:function(){return{configuration:this.configurationProvider.getOpenIDConfiguration(),wellknown:this.storagePersistanceService.read("authWellKnownEndPoints")}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"userData$",{get:function(){return this.userService.userData$},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isAuthenticated$",{get:function(){return this.authStateService.authorized$},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"checkSessionChanged$",{get:function(){return this.checkSessionService.checkSessionChanged$},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"stsCallback$",{get:function(){return this.callbackService.stsCallback$},enumerable:!1,configurable:!0}),e.prototype.checkAuth=function(e){return this.checkAuthService.checkAuth(e)},e.prototype.checkAuthIncludingServer=function(){return this.checkAuthService.checkAuthIncludingServer()},e.prototype.getToken=function(){return this.authStateService.getAccessToken()},e.prototype.getIdToken=function(){return this.authStateService.getIdToken()},e.prototype.getRefreshToken=function(){return this.authStateService.getRefreshToken()},e.prototype.getPayloadFromIdToken=function(e){void 0===e&&(e=!1);var t=this.getIdToken();return this.tokenHelperService.getPayloadFromToken(t,e)},e.prototype.setState=function(e){this.flowsDataService.setAuthStateControl(e)},e.prototype.getState=function(){return this.flowsDataService.getAuthStateControl()},e.prototype.authorize=function(e){(null==e?void 0:e.customParams)&&this.storagePersistanceService.write("storageCustomRequestParams",e.customParams),this.loginService.login(e)},e.prototype.authorizeWithPopUp=function(e){return(null==e?void 0:e.customParams)&&this.storagePersistanceService.write("storageCustomRequestParams",e.customParams),this.loginService.loginWithPopUp(e)},e.prototype.forceRefreshSession=function(e){return e&&this.storagePersistanceService.write("storageCustomRequestParams",e),this.refreshSessionService.forceRefreshSession(e)},e.prototype.logoffAndRevokeTokens=function(e){return this.logoffRevocationService.logoffAndRevokeTokens(e)},e.prototype.logoff=function(e){return this.logoffRevocationService.logoff(e)},e.prototype.logoffLocal=function(){return this.logoffRevocationService.logoffLocal()},e.prototype.revokeAccessToken=function(e){return this.logoffRevocationService.revokeAccessToken(e)},e.prototype.revokeRefreshToken=function(e){return this.logoffRevocationService.revokeRefreshToken(e)},e.prototype.getEndSessionUrl=function(){return this.logoffRevocationService.getEndSessionUrl()},e}();Fe.decorators=[{type:n.Injectable}],Fe.ctorParameters=function(){return[{type:we},{type:Ie},{type:N},{type:P},{type:d},{type:E},{type:O},{type:se},{type:je},{type:Ue},{type:R},{type:Se}]};var We=function(){function e(e,t){this.configProvider=e,this.loggerService=t}return e.prototype.read=function(e){var t;if(!this.hasStorage())return this.loggerService.logDebug("Wanted to read '"+e+"' but Storage was undefined"),!1;var r=null===(t=this.getStorage())||void 0===t?void 0:t.getItem(e);return r?JSON.parse(r):(this.loggerService.logDebug("Wanted to read '"+e+"' but nothing was found"),null)},e.prototype.write=function(e,t){if(!this.hasStorage())return this.loggerService.logDebug("Wanted to write '"+e+"/"+t+"' but Storage was falsy"),!1;var r=this.getStorage();return r?(t=t||null,r.setItem(""+e,JSON.stringify(t)),!0):(this.loggerService.logDebug("Wanted to write '"+e+"/"+t+"' but Storage was falsy"),!1)},e.prototype.remove=function(e){if(!this.hasStorage())return this.loggerService.logDebug("Wanted to remove '"+e+"' but Storage was falsy"),!1;var t=this.getStorage();return t?(t.removeItem(""+e),!0):(this.loggerService.logDebug("Wanted to write '"+e+"' but Storage was falsy"),!1)},e.prototype.getStorage=function(){var e=this.configProvider.getOpenIDConfiguration();return e?e.storage:null},e.prototype.hasStorage=function(){return"undefined"!=typeof Storage},e}();We.decorators=[{type:n.Injectable}],We.ctorParameters=function(){return[{type:d},{type:I}]};var _e=function(){function e(){}return e.forRoot=function(t){return void 0===t&&(t={}),{ngModule:e,providers:[Pe,m,U,Fe,C,l,we,O,ne,le,d,je,N,A,g,K,E,$,R,P,I,ce,Q,Ue,Te,fe,ve,f,ee,Re,Ie,B,oe,J,Ee,re,te,Z,Y,M,G,De,Ae,Oe,D,{provide:b,useClass:t.storage||We}]}},e}();_e.decorators=[{type:n.NgModule,args:[{imports:[t.CommonModule,r.HttpClientModule],declarations:[],exports:[]}]}];var ze=function(){function e(e,t,r,n,i){this.autoLoginService=e,this.authStateService=t,this.checkAuthService=r,this.loginService=n,this.router=i}return e.prototype.canLoad=function(e,t){return this.checkAuth(e.path)},e.prototype.canActivate=function(e,t){return this.checkAuth(t.url)},e.prototype.checkAuth=function(e){var t=this;return this.authStateService.authorized$.pipe(s.concatMap((function(e){return e?i.of(e):t.checkAuthService.checkAuth()})),s.map((function(r){var n=t.autoLoginService.getStoredRedirectRoute();return r?(n&&(t.autoLoginService.deleteStoredRedirectRoute(),t.router.navigate([n])),!0):(t.autoLoginService.saveStoredRedirectRoute(e),t.loginService.login(),!1)})))},e}();ze.ɵprov=n.ɵɵdefineInjectable({factory:function(){return new ze(n.ɵɵinject(D),n.ɵɵinject(E),n.ɵɵinject(Ie),n.ɵɵinject(Ue),n.ɵɵinject(a.Router))},token:ze,providedIn:"root"}),ze.decorators=[{type:n.Injectable,args:[{providedIn:"root"}]}],ze.ctorParameters=function(){return[{type:D},{type:E},{type:Ie},{type:Ue},{type:a.Router}]};var Ve=function(){function e(e,t,r){this.authStateService=e,this.configurationProvider=t,this.loggerService=r}return e.prototype.intercept=function(e,t){var r=this.configurationProvider.getOpenIDConfiguration().secureRoutes;if(!r)return this.loggerService.logDebug("No routes to check configured"),t.handle(e);var n=r.find((function(t){return e.url.startsWith(t)}));if(!n)return this.loggerService.logDebug("Did not find matching route for "+e.url),t.handle(e);this.loggerService.logDebug("'"+e.url+"' matches configured route '"+n+"'");var i=this.authStateService.getAccessToken();return i?(this.loggerService.logDebug("'"+e.url+"' matches configured route '"+n+"', adding token"),e=e.clone({headers:e.headers.set("Authorization","Bearer "+i)}),t.handle(e)):(this.loggerService.logDebug("Wanted to add token to "+e.url+" but found no token: '"+i+"'"),t.handle(e))},e}();Ve.decorators=[{type:n.Injectable}],Ve.ctorParameters=function(){return[{type:E},{type:d},{type:I}]},e.AbstractSecurityStorage=b,e.AuthInterceptor=Ve,e.AuthModule=_e,e.AutoLoginGuard=ze,e.LoggerService=I,e.OidcConfigService=Pe,e.OidcSecurityService=Fe,e.PublicEventsService=m,e.StateValidationResult=X,e.TokenHelperService=P,e.TokenValidationService=C,e.ɵa=d,e.ɵb=l,e.ɵba=ee,e.ɵbb=Q,e.ɵbc=Z,e.ɵbd=Y,e.ɵbe=oe,e.ɵbf=ie,e.ɵbg=se,e.ɵbh=ae,e.ɵbi=Se,e.ɵbj=he,e.ɵbk=de,e.ɵbl=ge,e.ɵbm=ke,e.ɵbn=D,e.ɵbo=je,e.ɵbp=Ce,e.ɵbq=Ue,e.ɵbr=De,e.ɵbs=Ee,e.ɵbt=Te,e.ɵbu=Ae,e.ɵbv=Oe,e.ɵbw=We,e.ɵc=ve,e.ɵd=fe,e.ɵe=f,e.ɵf=g,e.ɵg=R,e.ɵh=Re,e.ɵi=U,e.ɵj=we,e.ɵk=ce,e.ɵl=Ie,e.ɵm=le,e.ɵn=ne,e.ɵo=M,e.ɵp=K,e.ɵq=O,e.ɵr=A,e.ɵs=G,e.ɵt=B,e.ɵu=E,e.ɵv=N,e.ɵw=J,e.ɵx=$,e.ɵy=re,e.ɵz=te,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=angular-auth-oidc-client.umd.min.js.map