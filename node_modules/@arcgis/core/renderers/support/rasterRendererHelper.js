/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{isSome as e,unwrap as t}from"../../core/maybe.js";import n from"../../Color.js";import{getMetersPerUnitForSR as r}from"../../core/unitUtils.js";import l from"../../tasks/support/AlgorithmicColorRamp.js";import o from"../../tasks/support/MultipartColorRamp.js";import a from"./AuthoringInfo.js";import s from"./ClassBreakInfo.js";import i from"../ClassBreaksRenderer.js";import{PREDEFINED_JSON_COLOR_RAMPS as u,convertColorRampToColormap as c}from"./colorRampUtils.js";import m from"../RasterColormapRenderer.js";import f from"../RasterShadedReliefRenderer.js";import p from"../RasterStretchRenderer.js";import d from"./UniqueValueInfo.js";import b from"../UniqueValueRenderer.js";import h from"../VectorFieldRenderer.js";import"../../rasterRenderers.js";import v from"../../layers/support/Field.js";import y from"../../layers/support/RasterInfo.js";import g from"../../tasks/support/ClassBreaksDefinition.js";import{createGenerateRendererClassBreaks as C}from"../../tasks/support/generateRendererUtils.js";const w=.25,x=o.fromJSON({type:"multipart",colorRamps:[{fromColor:[0,0,255],toColor:[0,255,255]},{fromColor:[0,255,255],toColor:[255,255,0]},{fromColor:[255,255,0],toColor:[255,0,0]}]}),R=o.fromJSON(u[0]);function j(t,n){const{attributeTable:r,colormap:l,dataType:o}=t;if("vector-uv"===o||"vector-magdir"===o){const n=G(t);if(e(n))return n}if(e(l)){const n=F(t);if(e(n))return n}if(e(r)){const n=O(t);if(e(n))return n}return T(t,n)}function k(e){const t=["raster-stretch"];return P(e)&&t.push("raster-colormap"),N(e)&&t.push("unique-value"),J(e)&&t.push("class-breaks"),A(e)&&t.push("raster-shaded-relief"),_(e)&&t.push("vector-field"),t}function M(e,t,n){const r=["nearest","bilinear","cubic","majority"].find((e=>e===(null==n?void 0:n.toLowerCase())));if("Map"===t)return null!=r?r:"bilinear";return"thematic"===e.dataType||e.attributeTable||e.colormap?"nearest"===r||"majority"===r?r:"nearest":null!=r?r:"bilinear"}function T(e,n){var r,l,o,a;e=I(e,null==n?void 0:n.variableName);const{bandCount:s}=e;let{bandIds:i,stretchType:u}=n||{};null!=(r=i)&&r.some((e=>e>=s))&&(i=null);let c=t(e.statistics),m=t(e.histograms);var f;s>1?(i=null!=(f=i)&&f.length?i:V(e),c=null==c?null:i.map((e=>c[e])),m=null==m?null:i.map((e=>m[e]))):i=[0];null==u&&(u=B(e));let d=!1;switch(u){case"none":d=!1;break;case"percent-clip":d=!(null!=(l=m)&&l.length);break;default:d=!(null!=(o=c)&&o.length)}const b=1===(null==(a=i)?void 0:a.length)&&"scientific"===e.dataType?x:null,h=new p({stretchType:u,dynamicRangeAdjustment:d,colorRamp:b,outputMin:0,outputMax:255,gamma:1===i.length?[1]:[1,1,1],useGamma:!1});return"percent-clip"===u?h.maxPercent=h.minPercent=w:"standard-deviation"===u&&(h.numberOfStandardDeviations=2),d||("percent-clip"===u?h.histograms=m:"min-max"!==u&&"standard-deviation"!==u||(h.statistics=c)),h}function I(n,r){if(null==r)return n;let l=t(n.statistics),o=t(n.histograms);const{multidimensionalInfo:a}=n;if(r&&e(a)){const{statistics:e,histograms:t}=a.variables.find((e=>e.name===r));null!=e&&e.length&&(l=e),null!=t&&t.length&&(o=t)}return y.fromJSON({...n.toJSON(),statistics:l,histograms:o})}function V(e){const t=e.bandCount;if(1===t)return null;if(2===t)return[0];const n=e.keyProperties&&e.keyProperties.BandProperties;let r;if(n&&n.length===t){const{red:e,green:t,blue:l,nir:o}=S(n);null!=e&&null!=t&&null!=l?r=[e,t,l]:null!=o&&null!=e&&null!=t&&(r=[o,e,t])}return!r&&t>=3&&(r=[0,1,2]),r}function L(e,t){var n;const r=e.keyProperties&&e.keyProperties.BandProperties;return(t=null!=(n=t)&&n.length?t:Array.from(Array(e.bandCount).keys())).map((t=>r&&r.length===e.bandCount&&r[t]&&r[t].BandName||"band_"+(t+1)))}function S(e){const t={};for(let r=0;r<e.length;r++){var n;const l=e[r],o=null==(n=l.BandName)?void 0:n.toLowerCase();if("red"===o)t.red=r;else if("green"===o)t.green=r;else if("blue"===o)t.blue=r;else if("nearinfrared"===o||"nearinfrared_1"===o||"nir"===o)t.nir=r;else if(l.WavelengthMax&&l.WavelengthMin){const e=l.WavelengthMin,n=l.WavelengthMax;null==t.blue&&e>=410&&e<=480&&n>=480&&n<=540?t.blue=r:null==t.green&&e>=490&&e<=560&&n>=560&&n<=610?t.green=r:null==t.red&&e>=595&&e<=670&&n>=660&&n<=730?t.red=r:null==t.nir&&e>=700&&e<=860&&n>=800&&n<=950&&(t.nir=r)}}return t}function B(t){let n="percent-clip";const{pixelType:r,dataType:l,histograms:o,statistics:a}=t;return"u8"!==r||"processed"!==l&&e(o)&&e(a)?"u8"===r||"elevation"===l||"scientific"===l?n="min-max":e(o)?n="percent-clip":e(a)&&(n="min-max",n="min-max"):n="none",n}function O(t,r,l,o){if(!N(t,r))return null;const{attributeTable:s,statistics:i}=t,u=q(s,r),m=E(s,"red"),f=E(s,"green"),p=E(s,"blue"),h=new a,v=[],y=new Set,g=!!(m&&f&&p);if(e(s))s.features.forEach((e=>{const t=e.attributes[u.name];y.has(e.attributes[u.name])||null==t||(y.add(t),v.push(new d({value:e.attributes[u.name],label:e.attributes[u.name]+"",symbol:{type:"simple-fill",style:"solid",outline:null,color:new n(g?[e.attributes[m.name],e.attributes[f.name],e.attributes[p.name],1]:[0,0,0,0])}})))}));else if(null!=i&&i[0])for(let e=i[0].min;e<=i[0].max;e++)v.push(new d({value:e,label:e.toString(),symbol:{type:"simple-fill",style:"solid",outline:null,color:new n([0,0,0,0])}}));if(v.sort(((e,t)=>e.value&&"string"==typeof e.value.valueOf()?0:e.value>t.value?1:-1)),!g){const e=c(R,v.length);v.forEach(((t,r)=>t.symbol.color=new n(e[r].slice(1,4)))),h.colorRamp=R}if(l||o){const e=l||c(o,v.length).map((e=>e.slice(1)));v.forEach(((t,r)=>t.symbol.color=new n(e[r]))),h.colorRamp=o}return new b({field:u.name,uniqueValueInfos:v,authoringInfo:h})}function q(t,n){let r;return e(t)?(r=n?t.fields.find((e=>n.toLowerCase()===e.name.toLowerCase())):t.fields.find((e=>"string"===e.type&&e.name.toLowerCase().indexOf("class")>-1)),r||(r=t.fields.find((e=>"string"===e.type)),r||(r=E(t,"value")))):r=new v({name:"value"}),r}function E(t,n){return e(t)?t.fields.find((e=>e.name.toLowerCase()===n)):null}function N(t,n){const{attributeTable:r,bandCount:l}=t;if(!e(r)&&z(t))return!0;if(!e(r)||l>1)return!1;if(n){if(null==r.fields.find((e=>e.name.toLowerCase()===n.toLowerCase())))return!1}return!0}function P(t){const{bandCount:n,colormap:r}=t;return e(r)&&r.length&&1===n}function F(n){if(!P(n))return null;let r;const{attributeTable:l,colormap:o}=n;if(e(l)){const e=E(l,"value"),t=q(l);"string"===t.type&&(r={},l.features.forEach((n=>{const l=n.attributes;r[l[e.name]]=t?l[t.name]:l[e.name]})))}return m.createFromColormap(t(o),r)}function A(e){return"elevation"===e.dataType}function U(e,t){var n;if(!A(e))return null;const{extent:l}=e,o=l.width*r(l.spatialReference);return t=null!=(n=t)?n:"multi-directional",new f({hillshadeType:t,scalingType:o>5e6?"adjusted":"none"})}function J(t){const{attributeTable:n,bandCount:r}=t;return 1===r&&(e(n)||e(t.histograms))}function W(t,n){t=I(t,null==n?void 0:n.variableName);const{attributeTable:r}=t;if(!J(t))return null;const l=e(t.histograms)?t.histograms[0]:null,o=(null==n?void 0:n.numClasses)||5,u=new a({classificationMethod:null==n?void 0:n.classificationMethod,colorRamp:null==n?void 0:n.colorRamp});let m=(null==n?void 0:n.field)||"value";const f=[],p=[],d=1e3;if(e(r)){const e=r.fields.find((e=>"count"===e.name.toLowerCase())),t=r.fields.find((e=>e.name.toLowerCase()===m.toLowerCase()));m=t.name;const n=r.features.length;let l=0;r.features.forEach((t=>l+=t.attributes[e.name]/n)),r.features.forEach((r=>{const o=r.attributes[t.name],a=r.attributes[e.name];if(a>0){p.push(a);const e=Math.max(1,Math.round(a/n/l*d));for(let t=0;t<e;t++)f.push(o)}}))}else{const{pixelType:e}=t,n=(l.max-l.min)/l.size,r=e.indexOf("s")>-1||e.indexOf("u")>-1,o=r&&1===n?Math.floor(l.min+.5):l.min,a=r&&1===n?Math.floor(l.max-.5):l.max,s=l.size;let i=0;l.counts.forEach((e=>i+=e/s)),l.counts.forEach(((e,t)=>{if(e>0){p.push(e);const r=Math.max(1,Math.round(e/s/i*d)),u=0===t?o:t===s-1?a:l.min+n*(t+.5);for(let e=0;e<r;e++)f.push(u)}}))}const b=(null==n?void 0:n.classificationMethod)||"natural-breaks",h=C({values:f,valueFrequency:p,normalizationTotal:null,definition:new g({classificationMethod:b,breakCount:o,definedInterval:null==n?void 0:n.definedInterval})});let v=null==n?void 0:n.colors;if(!v){const e=(null==n?void 0:n.colorRamp)||x;u.colorRamp=e;const t=c(e,h.classBreaks.length,!0);v=t.map((e=>e.slice(1)))}const y=h.classBreaks.map(((e,t)=>new s({minValue:e.minValue,maxValue:e.maxValue,label:e.label,symbol:{type:"simple-fill",color:v[t]}})));return new i({field:m,classBreakInfos:y,authoringInfo:u})}function z(e){var t,n,r;return["u8","s8"].indexOf(e.pixelType)>-1&&null!=(null==(t=e.statistics)||null==(n=t[0])?void 0:n.min)&&null!=(null==(r=e.statistics[0])?void 0:r.max)&&1===e.bandCount}function D(e){const t=[];for(let r=0;r<e.length-1;r++)t[r]=new l({algorithm:"hsv",fromColor:e[r],toColor:e[r+1]||new n({r:255,g:255,b:255,a:1})});if(e.length>2){return new o({colorRamps:t})}return t[0]}function _(e){const{dataType:t}=e;return"vector-uv"===t||"vector-magdir"===t}function G(e){return _(e)?new h:null}function H(e){var t;return{color:null==(t=e.symbolLayers[0].material)?void 0:t.color,type:"esriSFS",style:"esriSFSSolid"}}function K(e){if("uniqueValue"===e.type){var t;const n=e.uniqueValueInfos,r=n[0].symbol;return null!=r&&null!=(t=r.symbolLayers)&&t.length&&(e.uniqueValueInfos=n.map((e=>({value:e.value,label:e.label,symbol:e.symbol?H(e.symbol):null})))),e}if("classBreaks"===e.type){var n;const t=e.classBreakInfos,r=t[0].symbol;return null!=r&&null!=(n=r.symbolLayers)&&n.length&&(e.classBreakInfos=t.map((e=>({classMinValue:e.classMinValue,classMaxValue:e.classMaxValue,label:e.label,symbol:e.symbol?H(e.symbol):null})))),e}return e}export{W as createClassBreaksRenderer,D as createColorRamp,F as createColormapRenderer,j as createDefaultRenderer,U as createShadedReliefRenderer,T as createStretchRenderer,O as createUVRenderer,G as createVectorFieldRenderer,L as getBandNames,q as getClassField,V as getDefaultBandCombination,M as getDefaultInterpolation,k as getSupportedRendererTypes,S as getWellKnownBandIndexes,J as isClassBreaksSupported,P as isColormapRendererSupported,A as isShadedReliefRendererSupported,z as isSingleBand8BitRasterWithStats,N as isUVRendererSupported,_ as isVectorFieldRendererSupported,K as normalizeRendererJSON};
