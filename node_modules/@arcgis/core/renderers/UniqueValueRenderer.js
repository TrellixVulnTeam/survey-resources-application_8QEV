/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import"../core/has.js";import{clone as t}from"../core/lang.js";import{deepMerge as i}from"../core/object.js";import{isNone as r,unwrapOr as s,unwrap as o}from"../core/maybe.js";import l from"../core/Logger.js";import{ensureType as n,ensureString as a}from"../core/accessorSupport/ensureType.js";import{property as u}from"../core/accessorSupport/decorators/property.js";import{cast as p}from"../core/accessorSupport/decorators/cast.js";import{enumeration as f}from"../core/accessorSupport/decorators/enumeration.js";import{reader as d}from"../core/accessorSupport/decorators/reader.js";import{subclass as c}from"../core/accessorSupport/decorators/subclass.js";import{writer as y}from"../core/accessorSupport/decorators/writer.js";import m from"../core/Error.js";import"../core/urlUtils.js";import"../core/uuid.js";import"../portal/support/resourceExtension.js";import{f as h,t as b}from"../chunks/persistableUrlUtils.js";import{loadArcade as g}from"../support/arcadeOnDemand.js";import{collectArcadeFieldNames as v,collectField as S}from"../layers/support/fieldUtils.js";import V from"../portal/Portal.js";import j from"../symbols/WebStyleSymbol.js";import{ensureType as q}from"../symbols.js";import I from"./support/LegendOptions.js";import _ from"./Renderer.js";import{VisualVariablesMixin as U}from"./mixins/VisualVariablesMixin.js";import{rendererBackgroundFillSymbolProperty as w,rendererSymbolProperty as O}from"./support/commonProperties.js";import{diff as F}from"../core/accessorSupport/diffUtils.js";import x from"./support/UniqueValueInfo.js";import{fetchStyle as D}from"../symbols/support/styleUtils.js";var E;const M=l.getLogger("esri.renderers.UniqueValueRenderer"),N=n(x);let R=E=class extends(U(_)){constructor(e){super(e),this._valueInfoMap={},this._isDefaultSymbolDerived=!1,this.type="unique-value",this.backgroundFillSymbol=null,this.field=null,this.field2=null,this.field3=null,this.valueExpression=null,this.valueExpressionTitle=null,this.legendOptions=null,this.defaultLabel=null,this.fieldDelimiter=null,this.portal=null,this.styleOrigin=null,this.diff={uniqueValueInfos(e,t){if(!e&&!t)return;if(!e||!t)return{type:"complete",oldValue:e,newValue:t};let i=!1;const r={type:"collection",added:[],removed:[],changed:[],unchanged:[]};for(let s=0;s<t.length;s++){const o=e.find((e=>e.value===t[s].value));o?F(o,t[s])?(r.changed.push({type:"complete",oldValue:o,newValue:t[s]}),i=!0):r.unchanged.push({oldValue:o,newValue:t[s]}):(r.added.push(t[s]),i=!0)}for(let s=0;s<e.length;s++){t.find((t=>t.value===e[s].value))||(r.removed.push(e[s]),i=!0)}return i?r:void 0}},this._set("uniqueValueInfos",[])}get _cache(){return{compiledFunc:null}}castField(e){return null==e||"function"==typeof e?e:a(e)}writeField(e,t,i,r){"string"==typeof e?t[i]=e:r&&r.messages?r.messages.push(new m("property:unsupported","UniqueValueRenderer.field set to a function cannot be written to JSON")):M.error(".field: cannot write field to JSON since it's not a string value")}set defaultSymbol(e){this._isDefaultSymbolDerived=!1,this._set("defaultSymbol",e)}readPortal(e,t,i){return i.portal||V.getDefault()}readStyleOrigin(e,t,i){if(t.styleName)return Object.freeze({styleName:t.styleName});if(t.styleUrl){const e=h(t.styleUrl,i);return Object.freeze({styleUrl:e})}}writeStyleOrigin(e,t,i,r){e.styleName?t.styleName=e.styleName:e.styleUrl&&(t.styleUrl=b(e.styleUrl,r))}set uniqueValueInfos(e){this.styleOrigin?M.error("#uniqueValueInfos=","Cannot modify unique value infos of a UniqueValueRenderer created from a web style"):(this._set("uniqueValueInfos",e),this._updateValueInfoMap())}addUniqueValueInfo(e,t){if(this.styleOrigin)return void M.error("#addUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");let i;i="object"==typeof e?N(e):new x({value:e,symbol:q(t)}),this.uniqueValueInfos.push(i),this._valueInfoMap[i.value]=i}removeUniqueValueInfo(e){if(this.styleOrigin)M.error("#removeUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");else for(let t=0;t<this.uniqueValueInfos.length;t++){if(this.uniqueValueInfos[t].value===e+""){delete this._valueInfoMap[e],this.uniqueValueInfos.splice(t,1);break}}}async getUniqueValueInfo(e,t){let i=t;return this.valueExpression&&(r(t)||r(t.arcade))&&(i={...i,arcade:await g()}),this._getUniqueValueInfo(e,i)}getSymbol(e,t){if(this.valueExpression&&(r(t)||r(t.arcade)))return void M.error("#getSymbol()","Please use getSymbolAsync if valueExpression is used");const i=this._getUniqueValueInfo(e,t);return i&&i.symbol||this.defaultSymbol}async getSymbolAsync(e,t){let i=t;if(this.valueExpression&&(r(i)||r(i.arcade))){const e=await g(),{arcadeUtils:t}=e;t.hasGeometryOperations(this.valueExpression)&&await t.enableGeometryOperations(),i={...i,arcade:e}}const s=this._getUniqueValueInfo(e,i);return s&&s.symbol||this.defaultSymbol}getSymbols(){const e=[];for(const t of this.uniqueValueInfos)t.symbol&&e.push(t.symbol);return this.defaultSymbol&&e.push(this.defaultSymbol),e}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce(((e,t)=>e+t.getAttributeHash()),"")}getMeshHash(){return`${JSON.stringify(this.backgroundFillSymbol)}.${JSON.stringify(this.defaultSymbol)}.${this.uniqueValueInfos.reduce(((e,t)=>e+t.getMeshHash()),"")}.${`${this.field}.${this.field2}.${this.field3}.${this.fieldDelimiter}`}.${this.valueExpression}`}clone(){const e=new E({field:this.field,field2:this.field2,field3:this.field3,defaultLabel:this.defaultLabel,defaultSymbol:t(this.defaultSymbol),valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,fieldDelimiter:this.fieldDelimiter,visualVariables:t(this.visualVariables),legendOptions:t(this.legendOptions),authoringInfo:this.authoringInfo&&this.authoringInfo.clone(),backgroundFillSymbol:t(this.backgroundFillSymbol)});this._isDefaultSymbolDerived&&(e._isDefaultSymbolDerived=!0),e._set("portal",this.portal);const i=t(this.uniqueValueInfos);return this.styleOrigin&&(e._set("styleOrigin",Object.freeze(t(this.styleOrigin))),Object.freeze(i)),e._set("uniqueValueInfos",i),e._updateValueInfoMap(),e}get arcadeRequired(){return this.arcadeRequiredForVisualVariables||!!this.valueExpression}async collectRequiredFields(e,t){const i=[this.collectVVRequiredFields(e,t),this.collectSymbolFields(e,t)];await Promise.all(i)}async collectSymbolFields(e,t){const i=[...this.getSymbols().map((i=>i.collectRequiredFields(e,t))),v(e,t,this.valueExpression)];S(e,t,this.field),S(e,t,this.field2),S(e,t,this.field3),await Promise.all(i)}populateFromStyle(){return D(this.styleOrigin,{portal:this.portal}).then((e=>{const t=[];return this._valueInfoMap={},e&&e.data&&Array.isArray(e.data.items)&&e.data.items.forEach((i=>{const r=new j({styleUrl:e.styleUrl,styleName:e.styleName,portal:this.portal,name:i.name});this.defaultSymbol||i.name!==e.data.defaultItem||(this.defaultSymbol=r,this._isDefaultSymbolDerived=!0);const s=new x({value:i.name,symbol:r});t.push(s),this._valueInfoMap[i.name]=s})),this._set("uniqueValueInfos",Object.freeze(t)),!this.defaultSymbol&&this.uniqueValueInfos.length&&(this.defaultSymbol=this.uniqueValueInfos[0].symbol,this._isDefaultSymbolDerived=!0),this}))}_updateValueInfoMap(){this._valueInfoMap={},this.uniqueValueInfos.forEach((e=>this._valueInfoMap[e.value+""]=e))}_getUniqueValueInfo(e,t){return this.valueExpression?this._getUnqiueValueInfoForExpression(e,t):this._getUnqiueValueInfoForFields(e)}_getUnqiueValueInfoForExpression(e,t){const{viewingMode:i,scale:r,spatialReference:l,arcade:n}=s(t,{});let a=this._cache.compiledFunc;const u=o(n).arcadeUtils;if(!a){const e=u.createSyntaxTree(this.valueExpression);a=u.createFunction(e),this._cache.compiledFunc=a}const p=u.executeFunction(a,u.createExecContext(e,u.getViewInfo({viewingMode:i,scale:r,spatialReference:l})));return this._valueInfoMap[p+""]}_getUnqiueValueInfoForFields(e){const t=this.field,i=e.attributes;let r;if("function"!=typeof t&&this.field2){const e=this.field2,s=this.field3,o=[];t&&o.push(i[t]),e&&o.push(i[e]),s&&o.push(i[s]),r=o.join(this.fieldDelimiter||"")}else"function"==typeof t?r=t(e):t&&(r=i[t]);return this._valueInfoMap[r+""]}static fromPortalStyle(e,t){const i=new E(t&&t.properties);i._set("styleOrigin",Object.freeze({styleName:e})),i._set("portal",t&&t.portal||V.getDefault());const r=i.populateFromStyle();return r.catch((t=>{M.error(`#fromPortalStyle('${e}'[, ...])`,"Failed to create unique value renderer from style name",t)})),r}static fromStyleUrl(e,t){const i=new E(t&&t.properties);i._set("styleOrigin",Object.freeze({styleUrl:e}));const r=i.populateFromStyle();return r.catch((t=>{M.error(`#fromStyleUrl('${e}'[, ...])`,"Failed to create unique value renderer from style URL",t)})),r}};e([u({readOnly:!0})],R.prototype,"_cache",null),e([f({uniqueValue:"unique-value"})],R.prototype,"type",void 0),e([u(w)],R.prototype,"backgroundFillSymbol",void 0),e([u({json:{type:String,read:{source:"field1"},write:{target:"field1"}}})],R.prototype,"field",void 0),e([p("field")],R.prototype,"castField",null),e([y("field")],R.prototype,"writeField",null),e([u({type:String,json:{write:!0}})],R.prototype,"field2",void 0),e([u({type:String,json:{write:!0}})],R.prototype,"field3",void 0),e([u({type:String,json:{write:!0}})],R.prototype,"valueExpression",void 0),e([u({type:String,json:{write:!0}})],R.prototype,"valueExpressionTitle",void 0),e([u({type:I,json:{write:!0}})],R.prototype,"legendOptions",void 0),e([u({type:String,json:{write:!0}})],R.prototype,"defaultLabel",void 0),e([u(i({...O},{json:{write:{overridePolicy(){return{enabled:!this._isDefaultSymbolDerived}}},origins:{"web-scene":{write:{overridePolicy(){return{enabled:!this._isDefaultSymbolDerived}}}}}}}))],R.prototype,"defaultSymbol",null),e([u({type:String,json:{write:!0}})],R.prototype,"fieldDelimiter",void 0),e([u({type:V,readOnly:!0})],R.prototype,"portal",void 0),e([d("portal",["styleName"])],R.prototype,"readPortal",null),e([u({readOnly:!0,json:{write:{enabled:!1,overridePolicy:()=>({enabled:!0})}}})],R.prototype,"styleOrigin",void 0),e([d("styleOrigin",["styleName","styleUrl"])],R.prototype,"readStyleOrigin",null),e([y("styleOrigin",{styleName:{type:String},styleUrl:{type:String}})],R.prototype,"writeStyleOrigin",null),e([u({type:[x],json:{write:{overridePolicy(){return this.styleOrigin?{enabled:!1}:{enabled:!0}}}}})],R.prototype,"uniqueValueInfos",null),R=E=e([c("esri.renderers.UniqueValueRenderer")],R);var P=R;export default P;
