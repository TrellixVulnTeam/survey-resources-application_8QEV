/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import e from"../../../core/Error.js";import t from"../PixelBlock.js";import{c as r}from"../../../chunks/_commonjsHelpers.js";import{Z as a}from"../../../chunks/Zlib.js";import i from"./ImageCanvasDecoder.js";import n from"./JpgPlus.js";import{d as s}from"../../../chunks/LercCodec.js";import o from"./Raw.js";import{isPlatformLittleEndian as l}from"./utils.js";import{decodeTileOrStrip as f,decode as h}from"./TiffDecoder.js";var u=r((function(e){var t;void 0!==(t=function(){var e={unstuff:function(e,t,r,a,i,n,s,o){var l,f,h,u,c,d=(1<<r)-1,p=0,m=0,g=4*e.length-Math.ceil(r*a/8);if(e[e.length-1]<<=8*g,i)for(l=0;l<a;l++)0===m&&(h=e[p++],m=32),m>=r?(f=h>>>m-r&d,m-=r):(f=(h&d)<<(u=r-m)&d,f+=(h=e[p++])>>>(m=32-u)),t[l]=i[f];else for(c=Math.ceil((o-n)/s),l=0;l<a;l++)0===m&&(h=e[p++],m=32),m>=r?(f=h>>>m-r&d,m-=r):(f=(h&d)<<(u=r-m)&d,f+=(h=e[p++])>>>(m=32-u)),t[l]=f<c?n+f*s:o},unstuffLUT:function(e,t,r,a,i,n){var s,o=(1<<t)-1,l=0,f=0,h=0,u=0,c=0,d=[],p=4*e.length-Math.ceil(t*r/8);e[e.length-1]<<=8*p;var m=Math.ceil((n-a)/i);for(f=0;f<r;f++)0===u&&(s=e[l++],u=32),u>=t?(c=s>>>u-t&o,u-=t):(c=(s&o)<<(h=t-u)&o,c+=(s=e[l++])>>>(u=32-h)),d[f]=c<m?a+c*i:n;return d.unshift(a),d},unstuff2:function(e,t,r,a,i,n,s,o){var l,f,h,u,c=(1<<r)-1,d=0,p=0,m=0;if(i)for(l=0;l<a;l++)0===p&&(h=e[d++],p=32,m=0),p>=r?(f=h>>>m&c,p-=r,m+=r):(f=h>>>m&c,p=32-(u=r-p),f|=((h=e[d++])&(1<<u)-1)<<r-u,m=u),t[l]=i[f];else{var g=Math.ceil((o-n)/s);for(l=0;l<a;l++)0===p&&(h=e[d++],p=32,m=0),p>=r?(f=h>>>m&c,p-=r,m+=r):(f=h>>>m&c,p=32-(u=r-p),f|=((h=e[d++])&(1<<u)-1)<<r-u,m=u),t[l]=f<g?n+f*s:o}return t},unstuffLUT2:function(e,t,r,a,i,n){var s,o=(1<<t)-1,l=0,f=0,h=0,u=0,c=0,d=0,p=[],m=Math.ceil((n-a)/i);for(f=0;f<r;f++)0===u&&(s=e[l++],u=32,d=0),u>=t?(c=s>>>d&o,u-=t,d+=t):(c=s>>>d&o,u=32-(h=t-u),c|=((s=e[l++])&(1<<h)-1)<<t-h,d=h),p[f]=c<m?a+c*i:n;return p.unshift(a),p},originalUnstuff:function(e,t,r,a){var i,n,s,o,l=(1<<r)-1,f=0,h=0,u=4*e.length-Math.ceil(r*a/8);for(e[e.length-1]<<=8*u,i=0;i<a;i++)0===h&&(s=e[f++],h=32),h>=r?(n=s>>>h-r&l,h-=r):(n=(s&l)<<(o=r-h)&l,n+=(s=e[f++])>>>(h=32-o)),t[i]=n;return t},originalUnstuff2:function(e,t,r,a){var i,n,s,o,l=(1<<r)-1,f=0,h=0,u=0;for(i=0;i<a;i++)0===h&&(s=e[f++],h=32,u=0),h>=r?(n=s>>>u&l,h-=r,u+=r):(n=s>>>u&l,h=32-(o=r-h),n|=((s=e[f++])&(1<<o)-1)<<r-o,u=o),t[i]=n;return t}},t={HUFFMAN_LUT_BITS_MAX:12,computeChecksumFletcher32:function(e){for(var t=65535,r=65535,a=e.length,i=Math.floor(a/2),n=0;i;){var s=i>=359?359:i;i-=s;do{t+=e[n++]<<8,r+=t+=e[n++]}while(--s);t=(65535&t)+(t>>>16),r=(65535&r)+(r>>>16)}return 1&a&&(r+=t+=e[n]<<8),((r=(65535&r)+(r>>>16))<<16|(t=(65535&t)+(t>>>16)))>>>0},readHeaderInfo:function(e,t){var r=t.ptr,a=new Uint8Array(e,r,6),i={};if(i.fileIdentifierString=String.fromCharCode.apply(null,a),0!==i.fileIdentifierString.lastIndexOf("Lerc2",0))throw"Unexpected file identifier string (expect Lerc2 ): "+i.fileIdentifierString;r+=6;var n,s=new DataView(e,r,8),o=s.getInt32(0,!0);if(i.fileVersion=o,r+=4,o>=3&&(i.checksum=s.getUint32(4,!0),r+=4),s=new DataView(e,r,12),i.height=s.getUint32(0,!0),i.width=s.getUint32(4,!0),r+=8,o>=4?(i.numDims=s.getUint32(8,!0),r+=4):i.numDims=1,s=new DataView(e,r,40),i.numValidPixel=s.getUint32(0,!0),i.microBlockSize=s.getInt32(4,!0),i.blobSize=s.getInt32(8,!0),i.imageType=s.getInt32(12,!0),i.maxZError=s.getFloat64(16,!0),i.zMin=s.getFloat64(24,!0),i.zMax=s.getFloat64(32,!0),r+=40,t.headerInfo=i,t.ptr=r,o>=3&&(n=o>=4?52:48,this.computeChecksumFletcher32(new Uint8Array(e,r-n,i.blobSize-14))!==i.checksum))throw"Checksum failed.";return!0},checkMinMaxRanges:function(e,t){var r=t.headerInfo,a=this.getDataTypeArray(r.imageType),i=r.numDims*this.getDataTypeSize(r.imageType),n=this.readSubArray(e,t.ptr,a,i),s=this.readSubArray(e,t.ptr+i,a,i);t.ptr+=2*i;var o,l=!0;for(o=0;o<r.numDims;o++)if(n[o]!==s[o]){l=!1;break}return r.minValues=n,r.maxValues=s,l},readSubArray:function(e,t,r,a){var i;if(r===Uint8Array)i=new Uint8Array(e,t,a);else{var n=new ArrayBuffer(a);new Uint8Array(n).set(new Uint8Array(e,t,a)),i=new r(n)}return i},readMask:function(e,t){var r,a,i=t.ptr,n=t.headerInfo,s=n.width*n.height,o=n.numValidPixel,l=new DataView(e,i,4),f={};if(f.numBytes=l.getUint32(0,!0),i+=4,(0===o||s===o)&&0!==f.numBytes)throw"invalid mask";if(0===o)r=new Uint8Array(Math.ceil(s/8)),f.bitset=r,a=new Uint8Array(s),t.pixels.resultMask=a,i+=f.numBytes;else if(f.numBytes>0){r=new Uint8Array(Math.ceil(s/8));var h=(l=new DataView(e,i,f.numBytes)).getInt16(0,!0),u=2,c=0,d=0;do{if(h>0)for(;h--;)r[c++]=l.getUint8(u++);else for(d=l.getUint8(u++),h=-h;h--;)r[c++]=d;h=l.getInt16(u,!0),u+=2}while(u<f.numBytes);if(-32768!==h||c<r.length)throw"Unexpected end of mask RLE encoding";a=new Uint8Array(s);var p=0,m=0;for(m=0;m<s;m++)7&m?(p=r[m>>3],p<<=7&m):p=r[m>>3],128&p&&(a[m]=1);t.pixels.resultMask=a,f.bitset=r,i+=f.numBytes}return t.ptr=i,t.mask=f,!0},readDataOneSweep:function(e,r,a){var i,n=r.ptr,s=r.headerInfo,o=s.numDims,l=s.width*s.height,f=s.imageType,h=s.numValidPixel*t.getDataTypeSize(f)*o,u=r.pixels.resultMask;if(a===Uint8Array)i=new Uint8Array(e,n,h);else{var c=new ArrayBuffer(h);new Uint8Array(c).set(new Uint8Array(e,n,h)),i=new a(c)}if(i.length===l*o)r.pixels.resultPixels=i;else{r.pixels.resultPixels=new a(l*o);var d=0,p=0,m=0,g=0;if(o>1)for(m=0;m<o;m++)for(g=m*l,p=0;p<l;p++)u[p]&&(r.pixels.resultPixels[g+p]=i[d++]);else for(p=0;p<l;p++)u[p]&&(r.pixels.resultPixels[p]=i[d++])}return n+=h,r.ptr=n,!0},readHuffmanTree:function(e,a){var i=this.HUFFMAN_LUT_BITS_MAX,n=new DataView(e,a.ptr,16);if(a.ptr+=16,n.getInt32(0,!0)<2)throw"unsupported Huffman version";var s=n.getInt32(4,!0),o=n.getInt32(8,!0),l=n.getInt32(12,!0);if(o>=l)return!1;var f=new Uint32Array(l-o);t.decodeBits(e,a,f);var h,u,c,d,p=[];for(h=o;h<l;h++)p[u=h-(h<s?0:s)]={first:f[h-o],second:null};var m=e.byteLength-a.ptr,g=Math.ceil(m/4),w=new ArrayBuffer(4*g);new Uint8Array(w).set(new Uint8Array(e,a.ptr,m));var y,x=new Uint32Array(w),k=0,b=0;for(y=x[0],h=o;h<l;h++)(d=p[u=h-(h<s?0:s)].first)>0&&(p[u].second=y<<k>>>32-d,32-k>=d?32===(k+=d)&&(k=0,y=x[++b]):(k+=d-32,y=x[++b],p[u].second|=y>>>32-k));var I=0,U=0,v=new r;for(h=0;h<p.length;h++)void 0!==p[h]&&(I=Math.max(I,p[h].first));U=I>=i?i:I;var A,D,T,M,V,C=[];for(h=o;h<l;h++)if((d=p[u=h-(h<s?0:s)].first)>0)if(A=[d,u],d<=U)for(D=p[u].second<<U-d,T=1<<U-d,c=0;c<T;c++)C[D|c]=A;else for(D=p[u].second,V=v,M=d-1;M>=0;M--)D>>>M&1?(V.right||(V.right=new r),V=V.right):(V.left||(V.left=new r),V=V.left),0!==M||V.val||(V.val=A[1]);return{decodeLut:C,numBitsLUTQick:U,numBitsLUT:I,tree:v,stuffedData:x,srcPtr:b,bitPos:k}},readHuffman:function(e,t,r){var a,i,n,s,o,l,f,h,u,c=t.headerInfo,d=c.numDims,p=t.headerInfo.height,m=t.headerInfo.width,g=m*p,w=this.readHuffmanTree(e,t),y=w.decodeLut,x=w.tree,k=w.stuffedData,b=w.srcPtr,I=w.bitPos,U=w.numBitsLUTQick,v=w.numBitsLUT,A=0===t.headerInfo.imageType?128:0,D=t.pixels.resultMask,T=0;I>0&&(b++,I=0);var M,V=k[b],C=1===t.encodeMode,S=new r(g*d),P=S;for(M=0;M<c.numDims;M++){if(d>1&&(P=new r(S.buffer,g*M,g),T=0),t.headerInfo.numValidPixel===m*p)for(h=0,l=0;l<p;l++)for(f=0;f<m;f++,h++){if(i=0,o=s=V<<I>>>32-U,32-I<U&&(o=s|=k[b+1]>>>64-I-U),y[o])i=y[o][1],I+=y[o][0];else for(o=s=V<<I>>>32-v,32-I<v&&(o=s|=k[b+1]>>>64-I-v),a=x,u=0;u<v;u++)if(!(a=s>>>v-u-1&1?a.right:a.left).left&&!a.right){i=a.val,I=I+u+1;break}I>=32&&(I-=32,V=k[++b]),n=i-A,C?(n+=f>0?T:l>0?P[h-m]:T,n&=255,P[h]=n,T=n):P[h]=n}else for(h=0,l=0;l<p;l++)for(f=0;f<m;f++,h++)if(D[h]){if(i=0,o=s=V<<I>>>32-U,32-I<U&&(o=s|=k[b+1]>>>64-I-U),y[o])i=y[o][1],I+=y[o][0];else for(o=s=V<<I>>>32-v,32-I<v&&(o=s|=k[b+1]>>>64-I-v),a=x,u=0;u<v;u++)if(!(a=s>>>v-u-1&1?a.right:a.left).left&&!a.right){i=a.val,I=I+u+1;break}I>=32&&(I-=32,V=k[++b]),n=i-A,C?(f>0&&D[h-1]?n+=T:l>0&&D[h-m]?n+=P[h-m]:n+=T,n&=255,P[h]=n,T=n):P[h]=n}t.ptr=t.ptr+4*(b+1)+(I>0?4:0)}t.pixels.resultPixels=S},decodeBits:function(t,r,a,i,n){var s=r.headerInfo,o=s.fileVersion,l=0,f=t.byteLength-r.ptr>=5?5:t.byteLength-r.ptr,h=new DataView(t,r.ptr,f),u=h.getUint8(0);l++;var c=u>>6,d=0===c?4:3-c,p=(32&u)>0,m=31&u,g=0;if(1===d)g=h.getUint8(l),l++;else if(2===d)g=h.getUint16(l,!0),l+=2;else{if(4!==d)throw"Invalid valid pixel count type";g=h.getUint32(l,!0),l+=4}var w,y,x,k,b,I,U,v,A,D=2*s.maxZError,T=s.numDims>1?s.maxValues[n]:s.zMax;if(p){for(r.counter.lut++,v=h.getUint8(l),l++,k=Math.ceil((v-1)*m/8),b=Math.ceil(k/4),y=new ArrayBuffer(4*b),x=new Uint8Array(y),r.ptr+=l,x.set(new Uint8Array(t,r.ptr,k)),U=new Uint32Array(y),r.ptr+=k,A=0;v-1>>>A;)A++;k=Math.ceil(g*A/8),b=Math.ceil(k/4),y=new ArrayBuffer(4*b),(x=new Uint8Array(y)).set(new Uint8Array(t,r.ptr,k)),w=new Uint32Array(y),r.ptr+=k,I=o>=3?e.unstuffLUT2(U,m,v-1,i,D,T):e.unstuffLUT(U,m,v-1,i,D,T),o>=3?e.unstuff2(w,a,A,g,I):e.unstuff(w,a,A,g,I)}else r.counter.bitstuffer++,A=m,r.ptr+=l,A>0&&(k=Math.ceil(g*A/8),b=Math.ceil(k/4),y=new ArrayBuffer(4*b),(x=new Uint8Array(y)).set(new Uint8Array(t,r.ptr,k)),w=new Uint32Array(y),r.ptr+=k,o>=3?null==i?e.originalUnstuff2(w,a,A,g):e.unstuff2(w,a,A,g,!1,i,D,T):null==i?e.originalUnstuff(w,a,A,g):e.unstuff(w,a,A,g,!1,i,D,T))},readTiles:function(e,r,a){var i=r.headerInfo,n=i.width,s=i.height,o=i.microBlockSize,l=i.imageType,f=t.getDataTypeSize(l),h=Math.ceil(n/o),u=Math.ceil(s/o);r.pixels.numBlocksY=u,r.pixels.numBlocksX=h,r.pixels.ptr=0;var c,d,p,m,g,w,y,x,k,b,I=0,U=0,v=0,A=0,D=0,T=0,M=0,V=0,C=0,S=0,P=0,B=0,O=0,L=0,z=0,F=new a(o*o),j=s%o||o,E=n%o||o,H=i.numDims,R=r.pixels.resultMask,_=r.pixels.resultPixels,Z=i.fileVersion>=5?14:15,X=i.zMax;for(v=0;v<u;v++)for(D=v!==u-1?o:j,A=0;A<h;A++)for(S=v*n*o+A*o,P=n-(T=A!==h-1?o:E),x=0;x<H;x++){if(H>1?(b=_,S=v*n*o+A*o,_=new a(r.pixels.resultPixels.buffer,n*s*x*f,n*s),X=i.maxValues[x]):b=null,M=e.byteLength-r.ptr,d={},z=0,V=(c=new DataView(e,r.ptr,Math.min(10,M))).getUint8(0),z++,k=i.fileVersion>=5?4&V:0,C=V>>6&255,(V>>2&Z)!=(A*o>>3&Z))throw"integrity issue";if(k&&0===x)throw"integrity issue";if((g=3&V)>3)throw r.ptr+=z,"Invalid block encoding ("+g+")";if(2!==g)if(0===g){if(k)throw"integrity issue";if(r.counter.uncompressed++,r.ptr+=z,B=(B=D*T*f)<(O=e.byteLength-r.ptr)?B:O,p=new ArrayBuffer(B%f==0?B:B+f-B%f),new Uint8Array(p).set(new Uint8Array(e,r.ptr,B)),m=new a(p),L=0,R)for(I=0;I<D;I++){for(U=0;U<T;U++)R[S]&&(_[S]=m[L++]),S++;S+=P}else for(I=0;I<D;I++){for(U=0;U<T;U++)_[S++]=m[L++];S+=P}r.ptr+=L*f}else if(w=t.getDataTypeUsed(k&&l<6?4:l,C),y=t.getOnePixel(d,z,w,c),z+=t.getDataTypeSize(w),3===g)if(r.ptr+=z,r.counter.constantoffset++,R)for(I=0;I<D;I++){for(U=0;U<T;U++)R[S]&&(_[S]=k?Math.min(X,b[S]+y):y),S++;S+=P}else for(I=0;I<D;I++){for(U=0;U<T;U++)_[S]=k?Math.min(X,b[S]+y):y,S++;S+=P}else if(r.ptr+=z,t.decodeBits(e,r,F,y,x),z=0,k)if(R)for(I=0;I<D;I++){for(U=0;U<T;U++)R[S]&&(_[S]=F[z++]+b[S]),S++;S+=P}else for(I=0;I<D;I++){for(U=0;U<T;U++)_[S]=F[z++]+b[S],S++;S+=P}else if(R)for(I=0;I<D;I++){for(U=0;U<T;U++)R[S]&&(_[S]=F[z++]),S++;S+=P}else for(I=0;I<D;I++){for(U=0;U<T;U++)_[S++]=F[z++];S+=P}else{if(k)if(R)for(I=0;I<D;I++)for(U=0;U<T;U++)R[S]&&(_[S]=b[S]),S++;else for(I=0;I<D;I++)for(U=0;U<T;U++)_[S]=b[S],S++;r.counter.constant++,r.ptr+=z}}},formatFileInfo:function(e){return{fileIdentifierString:e.headerInfo.fileIdentifierString,fileVersion:e.headerInfo.fileVersion,imageType:e.headerInfo.imageType,height:e.headerInfo.height,width:e.headerInfo.width,numValidPixel:e.headerInfo.numValidPixel,microBlockSize:e.headerInfo.microBlockSize,blobSize:e.headerInfo.blobSize,maxZError:e.headerInfo.maxZError,pixelType:t.getPixelType(e.headerInfo.imageType),eofOffset:e.eofOffset,mask:e.mask?{numBytes:e.mask.numBytes}:null,pixels:{numBlocksX:e.pixels.numBlocksX,numBlocksY:e.pixels.numBlocksY,maxValue:e.headerInfo.zMax,minValue:e.headerInfo.zMin,noDataValue:e.noDataValue}}},constructConstantSurface:function(e){var t=e.headerInfo.zMax,r=e.headerInfo.numDims,a=e.headerInfo.height*e.headerInfo.width,i=0,n=0,s=0,o=e.pixels.resultMask,l=e.pixels.resultPixels;if(o)if(r>1)for(i=0;i<r;i++)for(s=i*a,t=e.headerInfo.maxValues[i],n=0;n<a;n++)o[n]&&(l[s+n]=t);else for(n=0;n<a;n++)o[n]&&(l[n]=t);else if(r>1)for(i=0;i<r;i++)for(s=i*a,t=e.headerInfo.maxValues[i],n=0;n<a;n++)l[s+n]=t;else for(n=0;n<a;n++)l[n]=t},getDataTypeArray:function(e){var t;switch(e){case 0:t=Int8Array;break;case 1:t=Uint8Array;break;case 2:t=Int16Array;break;case 3:t=Uint16Array;break;case 4:t=Int32Array;break;case 5:t=Uint32Array;break;case 6:t=Float32Array;break;case 7:t=Float64Array;break;default:t=Float32Array}return t},getPixelType:function(e){var t;switch(e){case 0:t="S8";break;case 1:t="U8";break;case 2:t="S16";break;case 3:t="U16";break;case 4:t="S32";break;case 5:t="U32";break;case 6:t="F32";break;case 7:t="F64";break;default:t="F32"}return t},isValidPixelValue:function(e,t){if(null==t)return!1;var r;switch(e){case 0:r=t>=-128&&t<=127;break;case 1:r=t>=0&&t<=255;break;case 2:r=t>=-32768&&t<=32767;break;case 3:r=t>=0&&t<=65536;break;case 4:r=t>=-2147483648&&t<=2147483647;break;case 5:r=t>=0&&t<=4294967296;break;case 6:r=t>=-34027999387901484e22&&t<=34027999387901484e22;break;case 7:r=t>=5e-324&&t<=17976931348623157e292;break;default:r=!1}return r},getDataTypeSize:function(e){var t=0;switch(e){case 0:case 1:t=1;break;case 2:case 3:t=2;break;case 4:case 5:case 6:t=4;break;case 7:t=8;break;default:t=e}return t},getDataTypeUsed:function(e,t){var r=e;switch(e){case 2:case 4:r=e-t;break;case 3:case 5:r=e-2*t;break;case 6:r=0===t?e:1===t?2:1;break;case 7:r=0===t?e:e-2*t+1;break;default:r=e}return r},getOnePixel:function(e,t,r,a){var i=0;switch(r){case 0:i=a.getInt8(t);break;case 1:i=a.getUint8(t);break;case 2:i=a.getInt16(t,!0);break;case 3:i=a.getUint16(t,!0);break;case 4:i=a.getInt32(t,!0);break;case 5:i=a.getUInt32(t,!0);break;case 6:i=a.getFloat32(t,!0);break;case 7:i=a.getFloat64(t,!0);break;default:throw"the decoder does not understand this pixel type"}return i}},r=function(e,t,r){this.val=e,this.left=t,this.right=r};return{decode:function(e,r){var a=(r=r||{}).noDataValue,i=0,n={};if(n.ptr=r.inputOffset||0,n.pixels={},t.readHeaderInfo(e,n)){var s=n.headerInfo,o=s.fileVersion,l=t.getDataTypeArray(s.imageType);if(o>5)throw"unsupported lerc version 2."+o;t.readMask(e,n),s.numValidPixel===s.width*s.height||n.pixels.resultMask||(n.pixels.resultMask=r.maskData);var f,h=s.width*s.height;if(n.pixels.resultPixels=new l(h*s.numDims),n.counter={onesweep:0,uncompressed:0,lut:0,bitstuffer:0,constant:0,constantoffset:0},0!==s.numValidPixel)if(s.zMax===s.zMin)t.constructConstantSurface(n);else if(o>=4&&t.checkMinMaxRanges(e,n))t.constructConstantSurface(n);else{var u=new DataView(e,n.ptr,2),c=u.getUint8(0);if(n.ptr++,c)t.readDataOneSweep(e,n,l);else if(o>1&&s.imageType<=1&&Math.abs(s.maxZError-.5)<1e-5){var d=u.getUint8(1);if(n.ptr++,n.encodeMode=d,d>2||o<4&&d>1)throw"Invalid Huffman flag "+d;d?t.readHuffman(e,n,l):t.readTiles(e,n,l)}else t.readTiles(e,n,l)}n.eofOffset=n.ptr,r.inputOffset?(f=n.headerInfo.blobSize+r.inputOffset-n.ptr,Math.abs(f)>=1&&(n.eofOffset=r.inputOffset+n.headerInfo.blobSize)):(f=n.headerInfo.blobSize-n.ptr,Math.abs(f)>=1&&(n.eofOffset=n.headerInfo.blobSize));var p={width:s.width,height:s.height,pixelData:n.pixels.resultPixels,minValue:s.zMin,maxValue:s.zMax,validPixelCount:s.numValidPixel,dimCount:s.numDims,dimStats:{minValues:s.minValues,maxValues:s.maxValues},maskData:n.pixels.resultMask};if(n.pixels.resultMask&&t.isValidPixelValue(s.imageType,a)){var m=n.pixels.resultMask;for(i=0;i<h;i++)m[i]||(p.pixelData[i]=a);p.noDataValue=a}return n.noDataValue=a,r.returnFileInfo&&(p.fileInfo=t.formatFileInfo(n)),p}},getBandCount:function(e){for(var r=0,a=0,i={ptr:0,pixels:{}};a<e.byteLength-58;)t.readHeaderInfo(e,i),a+=i.headerInfo.blobSize,r++,i.ptr=a;return r}}}())&&(e.exports=t)})),c=function(e){var t,r,i,n,s,o;function l(e){var t,r,a,i,n,s,o,l,f,h,u,c,d;for(this.data=e,this.pos=8,this.palette=[],this.imgData=[],this.transparency={},this.animation=null,this.text={},n=null;;){switch(t=this.readUInt32(),l=function(){var e,t;for(t=[],e=0;e<4;++e)t.push(String.fromCharCode(this.data[this.pos++]));return t}.call(this).join("")){case"IHDR":this.width=this.readUInt32(),this.height=this.readUInt32(),this.bits=this.data[this.pos++],this.colorType=this.data[this.pos++],this.compressionMethod=this.data[this.pos++],this.filterMethod=this.data[this.pos++],this.interlaceMethod=this.data[this.pos++];break;case"acTL":this.animation={numFrames:this.readUInt32(),numPlays:this.readUInt32()||1/0,frames:[]};break;case"PLTE":this.palette=this.read(t);break;case"fcTL":n&&this.animation.frames.push(n),this.pos+=4,n={width:this.readUInt32(),height:this.readUInt32(),xOffset:this.readUInt32(),yOffset:this.readUInt32()},i=this.readUInt16(),a=this.readUInt16()||100,n.delay=1e3*i/a,n.disposeOp=this.data[this.pos++],n.blendOp=this.data[this.pos++],n.data=[];break;case"IDAT":case"fdAT":for("fdAT"===l&&(this.pos+=4,t-=4),e=(null!=n?n.data:void 0)||this.imgData,u=0;0<=t?u<t:u>t;0<=t?++u:--u)e.push(this.data[this.pos++]);break;case"tRNS":switch(this.transparency={},this.colorType){case 3:if(this.transparency.indexed=this.read(t),(f=255-this.transparency.indexed.length)>0)for(c=0;0<=f?c<f:c>f;0<=f?++c:--c)this.transparency.indexed.push(255);break;case 0:this.transparency.grayscale=this.read(t)[0];break;case 2:this.transparency.rgb=this.read(t)}break;case"tEXt":s=(h=this.read(t)).indexOf(0),o=String.fromCharCode.apply(String,h.slice(0,s)),this.text[o]=String.fromCharCode.apply(String,h.slice(s+1));break;case"IEND":return n&&this.animation.frames.push(n),this.colors=function(){switch(this.colorType){case 0:case 3:case 4:return 1;case 2:case 6:return 3}}.call(this),this.hasAlphaChannel=4===(d=this.colorType)||6===d,r=this.colors+(this.hasAlphaChannel?1:0),this.pixelBitlength=this.bits*r,this.colorSpace=function(){switch(this.colors){case 1:return"DeviceGray";case 3:return"DeviceRGB"}}.call(this),void(this.imgData=new Uint8Array(this.imgData));default:this.pos+=t}if(this.pos+=4,this.pos>this.data.length)throw new Error("Incomplete or corrupt PNG file")}}return l.load=function(e,t,r){var a;return"function"==typeof t&&(r=t),(a=new XMLHttpRequest).open("GET",e,!0),a.responseType="arraybuffer",a.onload=function(){var e;return e=new l(new Uint8Array(a.response||a.mozResponseArrayBuffer)),"function"==typeof(null!=t?t.getContext:void 0)&&e.render(t),"function"==typeof r?r(e):void 0},a.send(null)},r=1,i=2,t=0,l.prototype.read=function(e){var t,r;for(r=[],t=0;0<=e?t<e:t>e;0<=e?++t:--t)r.push(this.data[this.pos++]);return r},l.prototype.readUInt32=function(){return this.data[this.pos++]<<24|this.data[this.pos++]<<16|this.data[this.pos++]<<8|this.data[this.pos++]},l.prototype.readUInt16=function(){return this.data[this.pos++]<<8|this.data[this.pos++]},l.prototype.decodePixels=function(e){var t,r,i,n,s,o,l,f,h,u,c,d,p,m,g,w,y,x,k,b,I,U,v;if(null==e&&(e=this.imgData),0===e.length)return new Uint8Array(0);for(e=(e=new a(e)).getBytes(),w=(d=this.pixelBitlength/8)*this.width,p=new Uint8Array(w*this.height),o=e.length,g=0,m=0,r=0;m<o;){switch(e[m++]){case 0:for(n=k=0;k<w;n=k+=1)p[r++]=e[m++];break;case 1:for(n=b=0;b<w;n=b+=1)t=e[m++],s=n<d?0:p[r-d],p[r++]=(t+s)%256;break;case 2:for(n=I=0;I<w;n=I+=1)t=e[m++],i=(n-n%d)/d,y=g&&p[(g-1)*w+i*d+n%d],p[r++]=(y+t)%256;break;case 3:for(n=U=0;U<w;n=U+=1)t=e[m++],i=(n-n%d)/d,s=n<d?0:p[r-d],y=g&&p[(g-1)*w+i*d+n%d],p[r++]=(t+Math.floor((s+y)/2))%256;break;case 4:for(n=v=0;v<w;n=v+=1)t=e[m++],i=(n-n%d)/d,s=n<d?0:p[r-d],0===g?y=x=0:(y=p[(g-1)*w+i*d+n%d],x=i&&p[(g-1)*w+(i-1)*d+n%d]),l=s+y-x,f=Math.abs(l-s),u=Math.abs(l-y),c=Math.abs(l-x),h=f<=u&&f<=c?s:u<=c?y:x,p[r++]=(t+h)%256;break;default:throw new Error("Invalid filter algorithm: "+e[m-1])}g++}return p},l.prototype.decodePalette=function(){var e,t,r,a,i,n,s,o,l;for(r=this.palette,n=this.transparency.indexed||[],i=new Uint8Array((n.length||0)+r.length),a=0,r.length,e=0,t=s=0,o=r.length;s<o;t=s+=3)i[a++]=r[t],i[a++]=r[t+1],i[a++]=r[t+2],i[a++]=null!=(l=n[e++])?l:255;return i},l.prototype.copyToImageData=function(e,t){var r,a,i,n,s,o,l,f,h,u,c;if(a=this.colors,h=null,r=this.hasAlphaChannel,this.palette.length&&(h=null!=(c=this._decodedPalette)?c:this._decodedPalette=this.decodePalette(),a=4,r=!0),f=(i=e.data||e).length,s=h||t,n=o=0,1===a)for(;n<f;)l=h?4*t[n/4]:o,u=s[l++],i[n++]=u,i[n++]=u,i[n++]=u,i[n++]=r?s[l++]:this.transparency.grayscale&&this.transparency.grayscale===u?0:255,o=l;else for(;n<f;)l=h?4*t[n/4]:o,i[n++]=s[l++],i[n++]=s[l++],i[n++]=s[l++],i[n++]=r?s[l++]:this.transparency.rgb&&this.transparency.rgb[1]===s[l-3]&&this.transparency.rgb[3]===s[l-2]&&this.transparency.rgb[5]===s[l-1]?0:255,o=l},l.prototype.decode=function(){var e;return e=new Uint8Array(this.width*this.height*4),this.copyToImageData(e,this.decodePixels()),e},s=e.document&&e.document.createElement("canvas"),o=s&&s.getContext("2d"),n=function(e){var t;return o.width=e.width,o.height=e.height,o.clearRect(0,0,e.width,e.height),o.putImageData(e,0,0),(t=new Image).src=s.toDataURL(),t},l.prototype.decodeFrames=function(e){var t,r,a,i,s,o,l,f;if(this.animation){for(f=[],r=s=0,o=(l=this.animation.frames).length;s<o;r=++s)t=l[r],a=e.createImageData(t.width,t.height),i=this.decodePixels(new Uint8Array(t.data)),this.copyToImageData(a,i),t.imageData=a,f.push(t.image=n(a));return f}},l.prototype.renderFrame=function(e,a){var n,s,o;return n=(s=this.animation.frames)[a],o=s[a-1],0===a&&e.clearRect(0,0,this.width,this.height),(null!=o?o.disposeOp:void 0)===r?e.clearRect(o.xOffset,o.yOffset,o.width,o.height):(null!=o?o.disposeOp:void 0)===i&&e.putImageData(o.imageData,o.xOffset,o.yOffset),n.blendOp===t&&e.clearRect(n.xOffset,n.yOffset,n.width,n.height),e.drawImage(n.image,n.xOffset,n.yOffset)},l.prototype.animate=function(e){var t,r,a,i,n,s,o=this;return r=0,s=this.animation,i=s.numFrames,a=s.frames,n=s.numPlays,(t=function(){var s,l;if(s=r++%i,l=a[s],o.renderFrame(e,s),i>1&&r/i<n)return o.animation._timeout=setTimeout(t,l.delay)})()},l.prototype.stopAnimation=function(){var e;return clearTimeout(null!=(e=this.animation)?e._timeout:void 0)},l.prototype.render=function(e){var t,r;return e._png&&e._png.stopAnimation(),e._png=this,e.width=this.width,e.height=this.height,t=e.getContext("2d"),this.animation?(this.decodeFrames(t),this.animate(t)):(r=t.createImageData(this.width,this.height),this.copyToImageData(r,this.decodePixels()),t.putImageData(r,0,0))},l}(self);const d=new Set(["jpg","png","bmp","gif"]);function p(r,a){if(!l)throw new e("rasterCoded:decode","lerc decoder is not supported on big endian platform");const{width:i,height:n,pixelType:o}=a,f=v(o),h=f.pixelTypeCtor,u=null==a.noDataValue?f.noDataValue:a.noDataValue;let c,d,p=0,m=0;const g=r.byteLength-10;for(;m<g;){const a=s(r,{inputOffset:m,encodedMaskData:c,returnMask:0===p,returnEncodedMask:0===p,returnFileInfo:!0,pixelType:h,noDataValue:u});if(i&&n&&(a.width!==i||a.height!==n))throw new e("rasterCoded:decode","lerc decoded result has width or height different from specified in options");if(m=a.fileInfo.eofOffset,0===p&&(c=a.encodedMaskData,d=new t({width:a.width,height:a.height,pixels:[],pixelType:o,mask:a.maskData,statistics:[]})),p++,d.addData({pixels:a.pixelData,statistics:{minValue:a.minValue,maxValue:a.maxValue,noDataValue:a.noDataValue}}),g-m>10){const e=String.fromCharCode.apply(null,new Uint8Array(r,m,10));m=m+e.indexOf("CntZ")>-1?e.indexOf("CntZ"):0}}return d}function m(r,a){if(!l)throw new e("rasterCoded:decode","lerc decoder is not supported on big endian platform");let i,n,s,o=0,f=0,h=0;const c=r.byteLength-10,d=[],{width:p,height:m}=a;let g=0;for(;f<c;){var w;if(n=u.decode(r,{inputOffset:f,maskData:i,returnFileInfo:!0}),p&&m&&(n.width!==p||n.height!==m))throw new e("rasterCoded:decode","lerc2 decoded result has width or height different from what's specified in options");if(f=n.fileInfo.eofOffset,i=n.maskData,0===o&&(h=n.fileInfo.numValidPixel,s=new t({width:n.width,height:n.height,pixels:[],pixelType:n.fileInfo.pixelType,mask:i,statistics:[]})),n.fileInfo.mask&&n.fileInfo.mask.numBytes>0&&g++,i&&d.push(i),n.dimCount>1&&(null==(w=n.pixelData)?void 0:w.length)===n.width*n.height*n.dimCount){var y,x,k,b;n.pixelData=n.pixelData.slice(-n.width*n.height);const e=null==(y=n.dimStats)||null==(x=y.minValues)?void 0:x[n.dimCount-1],t=null==(k=n.dimStats)||null==(b=k.maxValues)?void 0:b[n.dimCount-1];null!=e&&null!=t&&(n.minValue=e,n.maxValue=t)}if(o++,s.addData({pixels:n.pixelData,statistics:{minValue:n.minValue,maxValue:n.maxValue}}),c-f>10){const e=String.fromCharCode.apply(null,new Uint8Array(r,f,10));f+=e.indexOf("Lerc")>-1?e.indexOf("Lerc"):0}}let I=0,U=0,v=0;if(g>1){for(v=s.width*s.height,i=new Uint8Array(v),i.set(d[0]),I=1;I<d.length;I++){const e=d[I];for(U=0;U<v;U++)i[U]=i[U]&e[U]}for(h=0,U=0;U<v;U++)h+=i[U];s.mask=i}return s.validPixelCount=h,s}function g(e){const r=h(e),a=new t({width:r.width,height:r.height,pixels:r.pixels,pixelType:r.pixelType.toLowerCase(),mask:r.mask,statistics:null});return a.updateStatistics(),a}function w(e,r){const a=f(e,r.customOptions),i=new t({width:a.width,height:a.height,pixels:a.pixels,pixelType:a.pixelType.toLowerCase(),mask:a.mask,statistics:null});return i.updateStatistics(),i}function y(e,r,a){const{pixelTypeCtor:i}=v(r.pixelType),n=(0,o.decode)(e,{width:r.width,height:r.height,pixelType:i,format:a}),s=new t({width:r.width,height:r.height,pixels:n.pixels,pixelType:r.pixelType,mask:n.mask,statistics:null});return s.updateStatistics(),s}function x(e){const r=n.decode(e),a=new t({width:r.width,height:r.height,pixels:r.pixels,pixelType:"U8",mask:r.mask,statistics:null});return a.updateStatistics(),a}function k(e,r){const a=new Uint8Array(e),i=new c(a),{width:n,height:s}=r,o=n*s,l=i.decode();let f,h=0,u=0;const d=new Uint8Array(o);for(h=0;h<o;h++)d[h]=l[4*h+3];const p=new t({width:n,height:s,pixels:[],pixelType:"U8",mask:d,statistics:[]});for(h=0;h<3;h++){for(f=new Uint8Array(o),u=0;u<o;u++)f[u]=l[4*u+h];p.addData({pixels:f})}return p.updateStatistics(),p}async function b(e,r,a,n){const s=new i,o={applyJpegMask:!1,format:r,...a},l=await s.decode(e,o,n),f=new t(l);return f.updateStatistics(),f}function I(t){if(null==t)throw new e("rasterCodec:decode","parameter encodeddata is required.");const r=new Uint8Array(t,0,10);let a="";return 255===r[0]&&216===r[1]?a="jpg":137===r[0]&&80===r[1]&&78===r[2]&&71===r[3]?a="png":67===r[0]&&110===r[1]&&116===r[2]&&90===r[3]&&73===r[4]&&109===r[5]&&97===r[6]&&103===r[7]&&101===r[8]&&32===r[9]?a="lerc":76===r[0]&&101===r[1]&&114===r[2]&&99===r[3]&&50===r[4]&&32===r[5]?a="lerc2":73===r[0]&&73===r[1]&&42===r[2]&&0===r[3]||77===r[0]&&77===r[1]&&0===r[2]&&42===r[3]||73===r[0]&&73===r[1]&&43===r[2]&&0===r[3]||77===r[0]&&77===r[1]&&0===r[2]&&43===r[3]?a="tiff":71===r[0]&&73===r[1]&&70===r[2]?a="gif":66===r[0]&&77===r[1]?a="bmp":String.fromCharCode.apply(null,r).toLowerCase().indexOf("error")>-1&&(a="error"),a}function U(t){let r=null;switch(t){case"lerc":r=p;break;case"lerc2":r=m;break;case"jpg":r=x;break;case"png":r=k;break;case"bsq":case"bip":r=(e,r)=>y(e,r,t);break;case"tiff":r=g;break;case"error":r=()=>{throw new e("rasterCodec:decode","input data contains error")};break;default:r=()=>{throw new e("rasterCodec:decode","unsupported raster format")}}return r}function v(e){let t=null,r=null;switch(e?e.toLowerCase():"f32"){case"u1":case"u2":case"u4":case"u8":r=255,t=Uint8Array;break;case"u16":r=r||65535,t=Uint16Array;break;case"u32":r=r||2**32-1,t=Uint32Array;break;case"s8":r=r||-128,t=Int8Array;break;case"s16":r=r||-32768,t=Int16Array;break;case"s32":r=r||0-2**31,t=Int32Array;break;default:t=Float32Array}return{pixelTypeCtor:t,noDataValue:r}}function A(e,r=1){if(!e)return;const{pixels:a,width:i,height:n,mask:s}=e;if(!a||0===a.length)return;const o=a.length,l=i-1,f=n-1,h=[];let u,c,d,p,m,g,w;const y=t.getPixelArrayConstructor(e.pixelType);if(0===r){for(u=0;u<o;u++){for(m=a[u],g=new y(l*f),c=0;c<f;c++)for(p=c*i,d=0;d<l;d++)g[c*l+d]=m[p+d];h.push(g)}if(s)for(w=new Uint8Array(l*f),c=0;c<f;c++)for(p=c*i,d=0;d<l;d++)w[c*l+d]=s[p+d]}else{for(u=0;u<o;u++){for(m=a[u],g=new y(l*f),c=0;c<f;c++)for(p=c*i,d=0;d<l;d++)g[c*l+d]=(m[p+d]+m[p+d+1]+m[p+i+d]+m[p+i+d+1])/4;h.push(g)}if(s)for(w=new Uint8Array(l*f),c=0;c<f;c++)for(p=c*i,d=0;d<l;d++)w[c*l+d]=Math.min.apply(null,[s[p+d],s[p+d+1],s[p+i+d],s[p+i+d+1]])}e.width=l,e.height=f,e.mask=w,e.pixels=h}function D(e){let t=I(e);return"lerc2"===t?t="lerc":"error"===t&&(t=""),t}async function T(t,r,a){if(null==t)throw new e("rasterCodec:decode","missing encodeddata parameter.");if(null==r||null==r.width||null==r.height)throw new e("rasterCodec:decode","requires width and height in options parameter.");let i,n,s=r.format&&r.format.toLowerCase();return"tiff"===s&&r.customOptions?w(t,r):((!s||"bsq"!==s&&"bip"!==s)&&(s=I(t)),r.useCanvas&&d.has(s)?n=await b(t,s,r,a):(i=U(s),r.isPoint&&((r={...r}).width++,r.height++),n=i(t,r),r.isPoint&&A(n)),n)}export{T as decode,D as getFormat};
