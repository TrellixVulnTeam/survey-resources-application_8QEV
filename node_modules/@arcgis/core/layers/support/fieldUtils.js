/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{getDeepValue as e,setDeepValue as n}from"../../core/object.js";import{isNone as i,isSome as t}from"../../core/maybe.js";import r from"../../core/Error.js";import{validateDomainValue as o,getDomainRange as l,DomainValidationError as a}from"./domains.js";import{loadArcade as s}from"../../support/arcadeOnDemand.js";const u=["field","field2","field3","normalizationField","rotationInfo.field","proportionalSymbolInfo.field","proportionalSymbolInfo.normalizationField","colorInfo.field","colorInfo.normalizationField"],f=["field","normalizationField"];function c(e,n){if(null!=e&&null!=n)for(const i of Array.isArray(e)?e:[e])if(d(u,i,n),"visualVariables"in i&&i.visualVariables)for(const e of i.visualVariables)d(f,e,n)}function d(i,t,r){if(i)for(const o of i){const i=e(o,t),l=i&&"function"!=typeof i&&T(r,i);l&&n(o,l.name,t)}}function m(e,n){if(null!=e&&null!=n)if("startField"in e){const i=T(n,e.startField),t=T(n,e.endField);e.startField=i&&i.name||null,e.endField=t&&t.name||null}else{const i=T(n,e.startTimeField),t=T(n,e.endTimeField);e.startTimeField=i&&i.name||null,e.endTimeField=t&&t.name||null}}const p=new Set;function y(e,n){return e&&n?(p.clear(),g(p,e,n),Array.from(p).sort()):[]}function g(e,n,i){if(i)if(n&&n.length)if(i.includes("*"))for(const{name:t}of n)e.add(t);else for(const t of i)F(e,n,t);else{if(i.includes("*"))return e.clear(),void e.add("*");for(const n of i)e.add(n)}}function F(e,n,i){if(n&&n.length){const t=T(n,i);t&&e.add(t.name)}else"string"==typeof i&&e.add(i)}function I(e,n){return i(n)||i(e)?[]:n.includes("*")?e.map((e=>e.name)):n}function b(e,n,i=1){if(!n||!e)return[];if(n.includes("*"))return["*"];const t=y(e,n);return t.length/e.length>=i?["*"]:t}function T(e,n){if("string"!=typeof n)return null;if(null!=e){n=n.toLowerCase();for(const i of e)if(i&&i.name.toLowerCase()===n)return i}return null}function h(e,n){if(!e||!n||"string"!=typeof n)return!1;n=n.toLowerCase();for(const i of e)if(i&&i.name.toLowerCase()===n)return!0;return!1}async function w(e,n,i){if(!i)return;const{arcadeUtils:t}=await s(),r=t.extractFieldNames(i);for(const o of r)F(e,n,o)}function S({displayField:e,fields:n}){return e||(n&&n.length?A(n,"name-or-title")||A(n,"unique-identifier")||A(n,"type-or-category")||x(n):null)}function x(e){for(const n of e){if(!n||!n.name)continue;const e=n.name.toLowerCase();if(e.indexOf("name")>-1||e.indexOf("title")>-1)return n.name}return null}function A(e,n){for(const i of e)if(i&&i.valueType&&i.valueType===n)return i.name;return null}async function N(e){if(!e)return[];const n=new Set;return await v(n,e),Array.from(n).sort()}async function v(n,i){if(!i)return;const{fields:t}=i,r=e("elevationInfo.featureExpressionInfo",i);return r?r.collectRequiredFields(n,t):void 0}async function E(e,n,i){i.outStatistic.onStatisticValueExpression?w(e,n,i.outStatistic.onStatisticValueExpression):e.add(i.outStatistic.onStatisticField)}async function V(e,n,i){n&&i&&"cluster"===i.type&&i.fields&&await Promise.all(i.fields.map((i=>E(e,n.fields,i))))}async function L(e,n,i){if(n&&(n.timeInfo&&t(i)&&i.timeExtent&&g(e,n.fields,[n.timeInfo.startField,n.timeInfo.endField]),n.floorInfo&&g(e,n.fields,[n.floorInfo.floorField]),t(i)&&t(i.where)&&i.where&&"1=1"!==i.where)){const t=(await import("../../core/sql/WhereClause.js")).WhereClause.create(i.where,n.fieldsIndex);if(!t.isStandardized)throw new r("fieldUtils:collectFilterFields","Where clause is not standardized");g(e,n.fields,t.fieldNames)}}async function _(e){if(!e)return[];const n="timeInfo"in e&&e.timeInfo;return n?y(e.fields,[e.trackIdField,n.startField,n.endField]):[]}function D(e){if(!e)return[];const n="editFieldsInfo"in e&&e.editFieldsInfo;return n?y(e.fields,[n&&n.creatorField,n&&n.creationDateField,n&&n.editorField,n&&n.editDateField]):[]}function $(e){if(!e)return[];const n=e.geometryFieldsInfo;return n?y(e.fields,[n.shapeAreaField,n.shapeLengthField]):[]}async function O(e){if(!e)return[];const n=new Set;return await U(n,e),Array.from(n).sort()}async function U(e,n){const{labelingInfo:i,fields:t}=n;i&&i.length&&await Promise.all(i.map((n=>C(e,t,n))))}async function C(e,n,i){if(!i)return;const t=i.getLabelExpression(),r=i.where;if("arcade"===t.type)await w(e,n,t.expression);else{const i=t.expression.match(/{[^}]*}/g);i&&i.forEach((i=>{F(e,n,i.slice(1,-1))}))}const o=/['"]+/g;if(r){const i=r.split(" ");3===i.length&&F(e,n,i[0].replace(o,"")),7===i.length&&(F(e,n,i[0].replace(o,"")),F(e,n,i[4].replace(o,"")))}}function j(e){const n=e.defaultValue;return void 0!==n&&W(e,n)?n:e.nullable?null:void 0}function z(e){return"number"==typeof e&&!isNaN(e)&&isFinite(e)}function k(e){return null===e||z(e)}const P="isInteger"in Number?Number.isInteger:e=>"number"==typeof e&&isFinite(e)&&Math.floor(e)===e;function R(e){return null===e||P(e)}function G(e){return null!=e&&"string"==typeof e}function q(e){return null===e||G(e)}function M(){return!0}function W(e,n){let i;switch(e.type){case"date":case"integer":case"long":case"small-integer":case"esriFieldTypeDate":case"esriFieldTypeInteger":case"esriFieldTypeLong":case"esriFieldTypeSmallInteger":i=e.nullable?R:P;break;case"double":case"single":case"esriFieldTypeSingle":case"esriFieldTypeDouble":i=e.nullable?k:z;break;case"string":case"esriFieldTypeString":i=e.nullable?q:G;break;default:i=M}return 1===arguments.length?i:i(n)}const Y=["integer","small-integer","single","double"],J=new Set([...Y,"esriFieldTypeInteger","esriFieldTypeSmallInteger","esriFieldTypeSingle","esriFieldTypeDouble"]);function X(e){return null!=e&&J.has(e.type)}function B(e){return null!=e&&("string"===e.type||"esriFieldTypeString"===e.type)}function H(e){return null!=e&&("date"===e.type||"esriFieldTypeDate"===e.type)}function K(e,n){return null===ne(e,n)}var Q,Z;function ee(e){return null==e||"number"==typeof e&&isNaN(e)?null:e}function ne(e,n){return e.nullable&&null===n?null:X(e)&&!ie(e.type,Number(n))?Q.OUT_OF_RANGE:W(e,n)?e.domain?o(e.domain,n):null:Z.INVALID_TYPE}function ie(e,n){const i="string"==typeof e?re(e):e;return!!i&&(i.isInteger?P(n)&&n>=i.min&&n<=i.max:n>=i.min&&n<=i.max)}function te(e){const n=l(e.domain);return n||(X(e)?re(e.type):void 0)}function re(e){switch(e){case"esriFieldTypeSmallInteger":case"small-integer":return le;case"esriFieldTypeInteger":case"integer":return ae;case"esriFieldTypeSingle":case"single":return se;case"esriFieldTypeDouble":case"double":return ue}}function oe(e){if(!z(e))return null;if(P(e)){if(e>=le.min&&e<=le.max)return"esriFieldTypeSmallInteger";if(e>=ae.min&&e<=ae.max)return"esriFieldTypeInteger"}return e>=se.min&&e<=se.max?"esriFieldTypeSingle":"esriFieldTypeDouble"}!function(e){e.OUT_OF_RANGE="numeric-range-validation-error::out-of-range"}(Q||(Q={})),function(e){e.INVALID_TYPE="type-validation-error::invalid-type"}(Z||(Z={}));const le={min:-32768,max:32767,isInteger:!0},ae={min:-2147483648,max:2147483647,isInteger:!0},se={min:-34e37,max:12e37,isInteger:!1},ue={min:-Number.MAX_VALUE,max:Number.MAX_VALUE,isInteger:!1};function fe(e,n,i){switch(e){case a.INVALID_CODED_VALUE:return`Value ${i} is not in the coded domain - field: ${n.name}, domain: ${JSON.stringify(n.domain)}`;case a.VALUE_OUT_OF_RANGE:return`Value ${i} is out of the range of valid values - field: ${n.name}, domain: ${JSON.stringify(n.domain)}`;case Z.INVALID_TYPE:return`Value ${i} is not a valid value for the field type - field: ${n.name}, type: ${n.type}, nullable: ${n.nullable}`;case Q.OUT_OF_RANGE:{const{min:e,max:t}=re(n.type);return`Value ${i} is out of range for the number type - field: ${n.name}, type: ${n.type}, value range is ${e} to ${t}`}}}function ce(e,n){return!de(e,n,null)}function de(e,n,i){if(!n||!n.attributes||!e){if(t(i))for(const n of e)i.add(n);return!0}const r=n.attributes;let o=!1;for(const l of e)if(!(l in r)){if(o=!0,!t(i))break;i.add(l)}return o}async function me(e,n){const i=new Set;for(const t of n)await w(i,e.fields,t);return Array.from(i).sort()}export{Q as NumericRangeValidationError,Z as TypeValidationError,w as collectArcadeFieldNames,v as collectElevationFields,V as collectFeatureReductionFields,F as collectField,g as collectFields,L as collectFilterFields,U as collectLabelingFields,ue as doubleRange,ce as featureHasFields,y as fixFields,c as fixRendererFields,m as fixTimeInfoFields,S as getDisplayFieldName,N as getElevationFields,me as getExpressionFields,D as getFeatureEditFields,$ as getFeatureGeometryFields,T as getField,j as getFieldDefaultValue,te as getFieldRange,O as getLabelingFields,oe as getNumericTypeForValue,_ as getTimeFields,h as hasField,ae as integerRange,H as isDateField,ie as isNumberInRange,X as isNumericField,B as isStringField,K as isValidFieldValue,W as isValueMatchingFieldType,Y as numericTypes,b as packFields,de as populateMissingFields,u as rendererFields,ee as sanitizeNullFieldValue,se as singleRange,le as smallIntegerRange,I as unpackFieldNames,ne as validateFieldValue,fe as validationErrorToString,f as visualVariableFields};
