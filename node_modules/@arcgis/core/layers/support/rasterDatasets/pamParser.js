/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import e from"../../../geometry/SpatialReference.js";import"../../../geometry.js";import t from"../rasterTransforms/PolynomialTransform.js";import{isSameTagIgnoreNS as n,getElementValue as a,getElements as r,getElement as s,getElementNumericValue as l,getElementNumericValues as i}from"./xmlUtilities.js";function o(e,t){if(!e||!t)return null;const n=[];for(let a=0;a<e.length;a++)n.push(e[a]),n.push(t[a]);return n}function u(e){var n;const r=s(e,"GeodataXform"),u=c(l(r,"SpatialReference/WKID")||a(r,"SpatialReference/WKT"));if("typens:PolynomialXform"!==r.getAttribute("xsi:type"))return{spatialReference:u,transform:null};const f=null!=(n=l(r,"PolynomialOrder"))?n:1,m=i(r,"CoeffX/Double"),d=i(r,"CoeffY/Double"),p=i(r,"InverseCoeffX/Double"),S=i(r,"InverseCoeffY/Double"),I=o(m,d),g=o(p,S);return{spatialReference:u,transform:new t({spatialReference:u,polynomialOrder:f,forwardCoefficients:I,inverseCoefficients:g})}}function f(e){var t;const n=l(e,"NoDataValue"),i=s(e,"Histograms/HistItem"),o=l(i,"HistMin"),u=l(i,"HistMax"),f=l(i,"BucketCount"),c=null==(t=a(i,"HistCounts"))?void 0:t.split("|").map((e=>Number(e)));let m,d,p,S;r(e,"Metadata/MDI").forEach((e=>{var t;const n=Number(null!=(t=e.textContent)?t:e.nodeValue);switch(e.getAttribute("key").toUpperCase()){case"STATISTICS_MINIMUM":m=n;break;case"STATISTICS_MAXIMUM":d=n;break;case"STATISTICS_MEAN":p=n;break;case"STATISTICS_STDDEV":S=n}}));const I=l(e,"Metadata/SourceBandIndex");return{noDataValue:n,histogram:null!=c&&c.length&&null!=m&&null!=d?{min:o,max:u,size:f||c.length,counts:c}:null,sourceBandIndex:I,statistics:null!=m&&null!=d?{min:m,max:d,avg:p,stddev:S}:null}}function c(t){if(!t)return null;let n=Number(t);if(!isNaN(n)&&0!==n)return new e({wkid:n});if(!(t=String(t)).startsWith("GEOGCS")&&!t.startsWith("PROJCS"))return null;const a=t.replace(/\]/g,"[").replace(/\"/g,"").split("[").map((e=>e.trim())).filter((e=>""!==e)),r=a[a.length-1].split(",");return"EPSG"===r[0]&&t.endsWith('"]]')&&(n=Number(r[1]),!isNaN(n)&&0!==n)?new e({wkid:n}):new e({wkt:t})}function m(e){var t;if("pamdataset"!==(null==e||null==(t=e.documentElement.tagName)?void 0:t.toLowerCase()))return{};const s={spatialReference:null,transform:null,metadata:{},rasterBands:[],statistics:null,histograms:null};e.documentElement.childNodes.forEach((e=>{if(1===e.nodeType)if(n(e,"SRS")){if(!s.spatialReference){const t=a(e);s.spatialReference=c(t)}}else if(n(e,"Metadata"))if("xml:ESRI"===e.getAttribute("domain")){const{spatialReference:t,transform:n}=u(e);s.transform=n,s.spatialReference||(s.spatialReference=t)}else{r(e,"MDI").forEach((e=>s.metadata[e.getAttribute("key")]=a(e)))}else if(n(e,"PAMRasterBand")){const t=f(e);null!=t.sourceBandIndex&&null==s.rasterBands[t.sourceBandIndex]?s.rasterBands[t.sourceBandIndex]=t:s.rasterBands.push(t)}}));const l=s.rasterBands;if(l){const e=!!l[0].statistics;s.statistics=e?l.map((e=>e.statistics)):null;const t=!!l[0].histogram;s.histograms=t?l.map((e=>e.histogram)):null}return s}export{m as parsePAMInfo,c as parseSpatialReference};
