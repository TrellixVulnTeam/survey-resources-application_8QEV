/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import e from"../../../geometry/Extent.js";import t from"../../../geometry/Polygon.js";import n from"../RasterInfo.js";import{getElements as i,isSameTagIgnoreNS as o,getElementValue as s,getElementValues as a,getNodeNameIgnoreNS as r,getElement as l,getSpaceDelimitedNumericValues as p}from"./xmlUtilities.js";import{coordsReversedForWKID as m}from"../wmsUtils.js";function u(e){return{requestResponseCRSs:a(e,"requestResponseCRSs").map((e=>e.split(":")[1])),nativeCRSs:a(e,"nativeCRSs").map((e=>e.split(":")[1]))}}function d(e,t){const n=a(e,"1.0.0"===t?"interpolationMethod":"InterpolationMethod"),i="1.0.0"===t?e.getAttribute("default"):s(e,"InterpolationMethods/Default");return null!=i?[i].concat(n.filter((e=>e.toLowerCase()!==i.toLowerCase()))):n}function f(e){return null==e?["nearest"]:e.map((e=>{const t=e.toLowerCase();return t.indexOf("nearest")>-1?"nearest":t.indexOf("linear")>-1?"bilinear":t.indexOf("cubic")>-1?"cubic":null})).filter((e=>!!e))}function c(t){const n=i(t,"pos"),o=p(n[0]),s=p(n[1]);return new e({xmin:o[0],ymin:o[1],xmax:s[0],ymax:s[1],spatialReference:{wkid:4326}})}function h(e){const t=[],n=i(e,"RangeSet");let o=[];for(let r=0;r<n.length;r++){const e=s(n[r],"name"),l=s(n[r],"label"),p=[],m=i(n[r],"AxisDescription");for(let t=0;t<m.length;t++){const e=s(m[t],"name"),n=s(m[t],"label"),i=a(m[t],"singleValue");if(0===i.length){const e=s(m[t],"min"),n=s(m[t],"max"),o=Number(s(m[t],"res"))||1;if(null!==e&&null!==n)for(let t=parseInt(e,10);t<=parseInt(n,10);t+=o)i.push(t.toString())}"band"===e.toLowerCase()&&(o=i),p.push({name:e,label:n,values:i})}t.push({name:e,label:l,axis:p})}return{rangeSet:t,bandNames:o}}function g(e=null){if(!e)return{resolution:null,units:null};let t=e.toUpperCase();const n=["Y","M","D"],i=["H","M","S"],o=["Years","Months","Days","Hours","Minutes","Seconds"];let s,a,r;return-1===t.indexOf("PT")?(t=t.slice(1),r=n.findIndex((e=>t.indexOf(e)>-1)),r>-1&&(s=o[r]),a=parseFloat(t.substring(0,t.length-1))):(t=t.slice(2),r=i.findIndex((e=>t.indexOf(e)>-1)),s=o[3+r],a=parseFloat(t.substring(0,t.length-1))),{resolution:a,units:s}}function x(e){const t=i(e,"timeposition");if(t.length>0){const e=[];for(let n=0;n<t.length;n++)e.push(new Date(s(t[n])));return{begin:e[0],end:e[e.length-1],values:e}}const n=l(e,"timePeriod")||l(e,"TimePeriod");if(n){return{begin:new Date(s(n,"beginPosition")||s(n,"BeginPosition")),end:new Date(s(n,"endPosition")||s(n,"EndPosition")),...g(s(n,"timeResolution")||s(n,"TimeResolution"))}}return null}function b(t){const n=l(t,"spatialDomain"),o=l(n,"Envelope")||l(n,"EnvelopeWithTimePeriod"),a=o.getAttribute("srsName").split(":"),r=a[a.length-1],m=i(o,"pos"),u=p(m[0]),d=p(m[1]),f=parseInt(r,10),c=isNaN(f)?null:{wkid:f},h=new e({xmin:u[0],ymin:u[1],xmax:d[0],ymax:d[1],spatialReference:c}),g=l(n,"RectifiedGrid"),b=s(g,"low").split(" "),v=s(g,"high").split(" "),w=parseInt(v[0],10)-parseInt(b[0],10)+1,y=parseInt(v[1],10)-parseInt(b[1],10)+1,D=p(n,"origin/pos"),L=i(n,"offsetVector"),S={envelope:h,columns:w,rows:y,offset:{x:parseFloat(s(L[0]).split(" ")[0]),y:parseFloat(s(L[1]).split(" ")[1])},origin:{x:D[0],y:D[1]}},C=l(t,"temporalDomain")||l(t,"TemporalDomain");return{spatialDomain:S,temporalDomain:C?x(C):null}}function v(e){const t={version:"1.0"};let i=[];for(let n=0;n<e.childNodes.length;n++){const r=e.childNodes[n];if(1===r.nodeType)if(o(r,"description"))t.description=s(r);else if(o(r,"name"))t.name=s(r);else if(o(r,"label"))t.label=s(r);else if(o(r,"supportedFormats"))t.supportedFormats=a(r,"formats");else if(o(r,"supportedCRSs"))t.supportedCRSs=u(r);else if(o(r,"supportedInterpolations"))t.supportedInterpolations=d(r,"1.0.0");else if(o(r,"lonLatEnvelope"))t.lonLatEnvelope=c(r);else if(o(r,"rangeSet")){const e=h(r);t.rangeSet=e.rangeSet,i=e.bandNames}else o(r,"domainSet")&&(t.domainSet=b(r))}const r=f(t.supportedInterpolations),{name:l,description:p,label:m,lonLatEnvelope:g,supportedFormats:x}=t,{spatialDomain:v}=t.domainSet,w={x:Math.abs(v.offset.x),y:Math.abs(v.offset.y)},y=new n({width:v.columns,height:v.rows,pixelSize:w,extent:v.envelope,spatialReference:v.envelope.spatialReference,bandCount:i.length||1});return{id:l,title:t.name,description:p||m,lonLatEnvelope:g,rasterInfo:y,bandNames:i,supportedFormats:x,supportedInterpolations:r,coverageDescription:t,version:"1.0.0",useEPSGAxis:!1}}function w(e){const t=[],n=i(e,"Field");let o=[];for(let r=0;r<n.length;r++){const e=s(n[r],"Identifier"),l=s(n[r],"Description"),p=s(n[r],"Definition"),m=s(n[r],"Abstract"),u=s(n[r],"Title"),f=d(n[r],"1.1.0"),c=[],h=i(n[r],"Axis");for(let t=0;t<h.length;t++){const e=h[t].getAttribute("identifier"),n=s(h[t],"UOM"),i=s(h[t],"DataType"),r=a(h[t],"Key");"band"===e.toLowerCase()&&(o=r),c.push({identifier:e,uom:n,dataType:i,values:r})}t.push({identifier:e,description:l,definition:p,abstract:m,title:u,supportedInterpolations:f,axis:c})}return{rangeSet:t,bandNames:o}}function y(e,t){const n=e.filter((e=>-1===e.identifier.toLowerCase().indexOf("field_1")&&!e.axis.some((e=>"band"===e.identifier.toLowerCase())))),i=[];if(n.length&&n.forEach((e=>{var t,n;const o=e.axis.map((e=>{const t=e.values.map((t=>{if("ISO8601"===e.uom){return-1===(t=t.trim()).toLowerCase().indexOf("z")?new Date(t+"Z").getTime():new Date(t).getTime()}return parseFloat(t.trim())})),n=[Math.min.apply(null,t),Math.max.apply(null,t)];return{name:e.identifier.trim(),description:"",field:e.identifier.trim(),unit:e.uom?e.uom.trim():"",hasRegularIntervals:!1,values:t,extent:n}}));i.push({name:e.identifier.trim(),description:null!=(t=null==(n=e.description)?void 0:n.trim())?t:"",unit:"",dimensions:o})})),t.temporalDomain){const{begin:e,end:n,values:o,units:s,resolution:a}=t.temporalDomain;i.some((e=>e.dimensions.some((e=>"stdtime"===e.name.toLowerCase()))))||i.forEach((t=>{t.dimensions.push({name:"StdTime",description:"",unit:"ISO8601",values:null==o?void 0:o.map((e=>e.getTime())),hasRegularIntervals:!o,interval:a,intervalUnit:s,extent:[e.getTime(),n.getTime()]})}))}return i.length?{variables:i}:null}function D(t){var n;const o=l(t,"SpatialDomain"),a=l(o,"GridCRS"),r=s(a,"GridBaseCRS"),u=s(a,"GridOrigin"),d=null!=(n=null==u?void 0:u.split(" ").map((e=>parseFloat(e))))?n:[0,0],f=p(a,"GridOffsets"),c=i(o,"BoundingBox");let h,g,b,v;for(let i=0;i<c.length;i++){var w;const t=null==(w=c[i].getAttribute("crs"))?void 0:w.toLowerCase();if(null!=t)if(t.indexOf("imagecrs")>-1){const e=p(c[i],"LowerCorner"),t=p(c[i],"UpperCorner");h=t[0]-e[0]+1,g=t[1]-e[1]+1}else if(t.indexOf("epsg")>0){const n=t.split(":");b=parseInt(n[n.length-1],10);const o=p(c[i],"LowerCorner"),s=p(c[i],"UpperCorner");v=new e({xmin:o[0],ymin:o[1],xmax:s[0],ymax:s[1],spatialReference:{wkid:b}})}}const y=h>g,D=v.xmax-v.xmin>v.ymax-v.ymin;let L=!1;m(b)&&(y===D?L=!1:(L=!0,v=new e({xmin:v.ymin,ymin:v.xmin,xmax:v.ymax,ymax:v.xmax,spatialReference:{wkid:b}})));const S={columns:h,rows:g,origin:{x:d[0],y:d[1]},offset:{x:f[0],y:f[1]},gridBaseCRS:r,envelope:v,useEPSGAxis:L},C=l(t,"temporalDomain")||l(t,"TemporalDomain");return{spatialDomain:S,temporalDomain:C?x(C):null}}function L(e,t){const i=[],o=[],a={supportedFormats:i,supportedCRSs:o,version:"1.1"};let l;for(let n=0;n<e.childNodes.length;n++){const t=e.childNodes[n];if(1!==t.nodeType)continue;const p=r(t).toLowerCase();switch(p){case"title":case"abstract":case"identifier":a[p]=s(t);break;case"supportedformat":{const e=s(t);-1===i.indexOf(e)&&i.push(e)}break;case"supportedcrs":{const e=s(t);-1===o.indexOf(e)&&o.push(e)}break;case"range":{const e=w(t);a.range=e.rangeSet,l=e.bandNames}break;case"domain":a.domain=D(t)}}const p=f(a.range[0].supportedInterpolations),{identifier:m,abstract:u,title:d,domain:c,range:h}=a,g={x:Math.abs(c.spatialDomain.offset.x),y:Math.abs(c.spatialDomain.offset.y)},x=y(h,c),b=new n({width:c.spatialDomain.columns,height:c.spatialDomain.rows,pixelSize:g,extent:c.spatialDomain.envelope,spatialReference:c.spatialDomain.envelope.spatialReference,bandCount:l.length||1,multidimensionalInfo:x});return{id:m,title:a.title,description:u||d,lonLatEnvelope:null,bandNames:l,rasterInfo:b,supportedFormats:i,supportedInterpolations:p,coverageDescription:a,version:t,useEPSGAxis:c.spatialDomain.useEPSGAxis}}function S(t){const n=l(t,"Envelope")||l(t,"EnvelopeWithTimePeriod"),i=n.getAttribute("srsName"),a=i.slice(i.lastIndexOf("/")+1),r=n.getAttribute("axisLabels").split(" ").map((e=>e.trim())).filter((e=>""!==e.trim())),m=p(n,"lowerCorner"),u=p(n,"upperCorner"),d=!["y","lat","latitude","north","nor","n","b"].some((e=>e===r[0].toLowerCase()));let f;const c=parseInt(a,10),h=isNaN(c)?null:{wkid:c};f=new e(d?{xmin:m[0],ymin:m[1],xmax:u[0],ymax:u[1],spatialReference:h}:{xmin:m[1],ymin:m[0],xmax:u[1],ymax:u[0],spatialReference:h});const g={mins:m,maxs:u},x=n.getAttribute("uomLabels").trim().split(" ");let b,v;return o(n,"EnvelopeWithTimePeriod")&&(b=new Date(s(t,"beginPosition")||s(t,"BeginPosition")),v=new Date(s(t,"endPosition")||s(t,"EndPosition"))),{envelope:f,axisLabels:r,uomLabels:x.length?x:null,envelopeAllDims:g,beginPosition:b,endPosition:v,isEastFirst:d}}function C(e){const t=[],n=i(e,"DataRecord"),o=[];for(let r=0;r<n.length;r++){const e=i(n[r],"field"),m=[];for(let t=0;t<e.length;t++){var a;const n=e[t].getAttribute("name"),i=s(e[t],"description")||"",r=(null==(a=l(e[t],"uom"))?void 0:a.getAttribute("code"))||"",u=p(e[t],"interval");n.toLowerCase().indexOf("band")>-1&&o.push(n),m.push({name:n,description:i,uom:r,allowedValues:u})}t.push(m)}return{rangeType:t,bandNames:o}}function I(e){let t=1,n="";const i=.01;return Math.abs(e-1/24)<1/24*i?n="Hours":Math.abs(e-1)<1*i?n="Days":e<1?(t=Math.round(24*e),n="Hours"):e>28-i&&e<31+i||Math.round(e/30)<12?n="Months":e>365-i&&e<366+i&&(n="Years"),{interval:t,intervalUnit:n}}function R(e,t,n){const i=[];for(let s=0;s<e.length;s++){const t=e[s];for(let e=0;e<t.length;e++)-1===t[e].name.toLowerCase().indexOf("band")&&i.push(t[e])}const o=[];if(i.length){const e=[];for(let i=2;i<n.axisLabels.length;i++){const o=(t.uomLabels&&t.uomLabels.length)>i?t.uomLabels[i]:"",s=n.axisLabels[i].toLowerCase().indexOf("time")>-1||"iso8601"===o.toLowerCase()||"oledatetime"===o.toLowerCase();let a,r;if(s){const e=I(n.offset[i]);a=e.interval,r=e.intervalUnit}else a=n.offset[i],r=o;const l=[];s?(l.push((new Date).setTime(24*(t.envelopeAllDims.mins[i]-25569)*3600*1e3)),l.push((new Date).setTime(24*(t.envelopeAllDims.maxs[i]-25569)*3600*1e3))):(l.push(t.envelopeAllDims.mins[i]),l.push(t.envelopeAllDims.maxs[i])),e.push({name:n.axisLabels[i].trim(),description:n.axisLabels[i].trim(),unit:t.uomLabels&&t.uomLabels.length>i?t.uomLabels[i].trim():"",hasRegularIntervals:!0,extent:l,interval:a,intervalUnit:r})}if(i.forEach((t=>{var n,i;return o.push({name:t.name.trim(),description:null!=(n=null==(i=t.description)?void 0:i.trim())?n:"",unit:t.uom.trim(),dimensions:e})})),o.length)return{variables:o}}return null}function T(e,t){const n=l(e,"RectifiedGrid"),o=p(n,"low"),a=p(n,"high"),r=[];for(let i=0;i<o.length;i++)r.push(a[i]-o[i]+1);const m=s(n,"axisLabels").split(" "),u=p(n,"origin/pos"),d=i(n,"offsetVector"),f=[];for(let i=0;i<d.length;i++){const e=p(d[i]),t=e.findIndex((e=>0!==e));f[t]=e[t]}const c=t||m;let h,g,x;return["y","lat","latitude","north","nor","n","b"].some((e=>e===c[0].toLowerCase()))?(h=r[1],g=r[0],x={y:Math.abs(f[0]),x:Math.abs(f[1])}):(h=r[0],g=r[1],x={x:Math.abs(f[0]),y:Math.abs(f[1])}),{columns:h,rows:g,origin:u,offset:f,resolution:x,gridSamples:r,axisLabels:m}}function M(e){const n=l(e,"EarthObservation");if(!n)return null;const i=l(n,"phenomenonTime"),o=i?x(i):null,a=l(n,"phenomenonTime"),r=a?x(a):null,p=s(n,"featureOfInterest/Footprint/multiExtentOf/MultiSurface/surfaceMembers/Polygon/exterior/LinearRing/posList");let m=null;if(p){const e=p.split(" ").map((e=>e.trim())).filter((e=>null!=e&&""!==e));if(e.length){const n=[];for(let t=0;t<e.length/2;t+=2)n.push(e[t],e[t+1]);m=new t({rings:[n],spatialReference:{wkid:4326}})}}return{observation:{phonomenonTime:o,resultTime:r,footprint:m,identifier:s(e,"metaDataProperty/EarthObservationMetaData/identifier"),acquisitionType:s(e,"metaDataProperty/EarthObservationMetaData/acquisitionType"),status:s(e,"metaDataProperty/EarthObservationMetaData/status")}}}function O(e){const t={version:"2.0"};let i=[];for(let n=0;n<e.childNodes.length;n++){const p=e.childNodes[n];if(1===p.nodeType)if(o(p,"coverageId"))t.coverageId=s(p);else if(o(p,"ServiceParameters"))t.serviceParameters={supportedFormats:a(p,"nativeFormat")};else if(o(p,"boundedBy"))t.boundedBy=S(p);else if(o(p,"rangeType")){const e=C(p);t.rangeType=e.rangeType,i=e.bandNames}else if(o(p,"domainSet")){var r;t.domainSet=T(p,null==(r=t.boundedBy)?void 0:r.axisLabels)}else if(o(p,"metadata")){const e=l(p,"EOMetadata");t.eoMetadata=e?M(e):null}}const{coverageId:p,boundedBy:m,domainSet:u,rangeType:d,serviceParameters:f}=t,c=R(d,m,u);return{id:p,title:p,description:p,lonLatEnvelope:null,bandNames:i,rasterInfo:new n({width:u.columns,height:u.rows,pixelSize:u.resolution,extent:m.envelope,spatialReference:m.envelope.spatialReference,bandCount:i.length||1,multidimensionalInfo:c}),supportedFormats:f.supportedFormats,supportedInterpolations:null,coverageDescription:t,version:"2.0.1",useEPSGAxis:!1}}function P(e,t){let n=null;if("string"==typeof e){n=(new DOMParser).parseFromString(e,"text/xml")}else n=e;if("1.0.0"===t){return i(n,"CoverageOffering").map((e=>v(e)))}const o=i(n,"CoverageDescription");return"1.1.0"===t||"1.1.1"===t||"1.1.2"===t?o.map((e=>L(e,t))):o.map((e=>O(e)))}export{P as parseCoverages,f as standardizeInterpolations};
