/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import"../../../core/has.js";import{isSome as t}from"../../../core/maybe.js";import"../../../core/Logger.js";import"../../../core/accessorSupport/ensureType.js";import{property as o}from"../../../core/accessorSupport/decorators/property.js";import{subclass as r}from"../../../core/accessorSupport/decorators/subclass.js";import i from"../../../core/Error.js";import"../../../core/urlUtils.js";import"../../../core/uuid.js";import"../../../portal/support/resourceExtension.js";import{equals as n}from"../../../geometry/support/spatialReferenceUtils.js";import s from"../../../geometry/SpatialReference.js";import l from"../../../geometry/Extent.js";import{typeKebabDictionary as c}from"../../../geometry/support/typeUtils.js";import"../../../geometry.js";import a from"../../../core/Loadable.js";import{getServerLandingPage as p,getServerConformance as u,getServerCollection as m,getCollectionDefinition as f,getSpatialReference as y,queryFeatureSet as d,queryFeatureSetJSON as g}from"../../ogc/ogcFeatureUtils.js";const h="http://www.opengis.net/def/crs/OGC/1.3/CRS84";let j=class extends a{constructor(){super(...arguments),this.collection=null,this.conformance=null,this.landingPage=null,this.layerDefinition=null,this.type="ogc-feature"}load(e){const o=t(e)?e.signal:null,{collectionId:r,fields:n,geometryType:s,hasZ:l,objectIdField:a,timeInfo:y,url:d}=this.layer,g={fields:null==n?void 0:n.map((e=>e.toJSON())),geometryType:c.toJSON(s),hasZ:l,objectIdField:a,timeInfo:null==y?void 0:y.toJSON()};return this.addResolvingPromise(Promise.all([p(d,o),u(d,o),m(d,r,o),f(d,r,g,o)]).then((e=>{const[t,o,r,n]=e;this.set({landingPage:t,conformance:o,collection:r,layerDefinition:n});const s=new RegExp(`^https?:${"//www.opengis.net/spec/ogcapi-features-1/1.0/conf/geojson"}$`,"i");if(!(null==o?void 0:o.conformsTo.some((e=>s.test(e)))))throw new i("ogc-feature-layer:no-geojson-support","Server does not support geojson")}))),this.when()}get fullExtent(){var e,t;const o=null==(e=this.collection)||null==(t=e.extent)?void 0:t.spatial;if(!o)return null;const r=o.bbox[0],i=4===r.length,n=r[0],c=r[1],a=i?void 0:r[2],p=i?r[2]:r[3],u=i?r[3]:r[4],m=i?void 0:r[5],f=s.WGS84;return new l({xmin:n,ymin:c,xmax:p,ymax:u,zmin:a,zmax:m,spatialReference:f})}get spatialReference(){var e;const t=null!=(e=this.collection.storageCrs)?e:h,o=y(t);return o||s.WGS84}getFeatureDefinition(){var e;const{collection:t,layer:{capabilities:o,collectionId:r,spatialReference:i,url:n},layerDefinition:s}=this,l=null!=(e=null==t?void 0:t.crs)?e:[h];return{capabilities:o,collectionId:r,layerDefinition:s,spatialReference:i.toJSON(),supportedCrs:l,url:n}}queryExtent(e,t={}){return null}queryFeatureCount(e,t={}){return null}queryFeatures(e,t={}){const o=this.getFeatureDefinition();return this.load(t).then((()=>d(o,e,t)))}queryFeaturesJSON(e,t={}){const o=this.getFeatureDefinition();return this.load(t).then((()=>g(o,e,t)))}queryObjectIds(e,t={}){return null}supportsSpatialReference(e){var t,o;if(e.isWGS84||e.isWebMercator)return!0;return(null!=(t=null==(o=this.collection)?void 0:o.crs)?t:[h]).some((t=>{const o=y(t);return!!o&&n(o,e)}))}};e([o()],j.prototype,"collection",void 0),e([o()],j.prototype,"conformance",void 0),e([o({readOnly:!0,type:l})],j.prototype,"fullExtent",null),e([o()],j.prototype,"landingPage",void 0),e([o({constructOnly:!0})],j.prototype,"layer",void 0),e([o()],j.prototype,"layerDefinition",void 0),e([o()],j.prototype,"spatialReference",null),e([o()],j.prototype,"type",void 0),j=e([r("esri.layers.graphics.sources.OGCFeatureSource")],j);var v=j;export default v;export{j as OGCFeatureSource};
