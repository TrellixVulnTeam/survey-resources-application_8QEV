/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{isValid as s,equals as t,isWebMercator as n}from"../../../geometry/support/spatialReferenceUtils.js";import{lngLatToXY as e,xyToLngLat as r,canProject as i}from"../../../geometry/support/webMercatorUtils.js";import{initializeProjection as o,projectMany as a}from"../../../geometry/projection.js";import{jsonAdapter as m}from"../../../geometry/geometryAdapters/json.js";const h=[0,0];function u(s,t){if(!t)return null;if("x"in t){const n={x:0,y:0};return[n.x,n.y]=s(t.x,t.y,h),null!=t.z&&(n.z=t.z),null!=t.m&&(n.m=t.m),n}if("xmin"in t){const n={xmin:0,ymin:0,xmax:0,ymax:0};return[n.xmin,n.ymin]=s(t.xmin,t.ymin,h),[n.xmax,n.ymax]=s(t.xmax,t.ymax,h),t.hasZ&&(n.zmin=t.zmin,n.zmax=t.zmax,n.hasZ=!0),t.hasM&&(n.mmin=t.mmin,n.mmax=t.mmax,n.hasM=!0),n}return"rings"in t?{rings:c(t.rings,s),hasM:t.hasM,hasZ:t.hasZ}:"paths"in t?{paths:c(t.paths,s),hasM:t.hasM,hasZ:t.hasZ}:"points"in t?{points:l(t.points,s),hasM:t.hasM,hasZ:t.hasZ}:void 0}function c(s,t){const n=[];for(const e of s)n.push(l(e,t));return n}function l(s,t){const n=[];for(const e of s){const s=t(e[0],e[1],[0,0]);n.push(s),e.length>2&&s.push(e[2]),e.length>3&&s.push(e[3])}return n}async function p(s,t){if(!t)return;const n=Array.isArray(s)?s.map((s=>{var t;return null==(t=s.geometry)?void 0:t.spatialReference})):[s];await o(n.map((s=>({source:s,dest:t}))))}const f=u.bind(null,e),x=u.bind(null,r);function y(e,r,o){return e?(o||(o=r,r=e.spatialReference),s(r)&&s(o)&&!t(r,o)?i(r,o)?n(o)?f(e):x(e):a(m,[e],r,o,null)[0]:e):e}class g{constructor(){this._jobs=[],this._timer=null,this._process=this._process.bind(this)}async push(s,n,e){!s||!s.length||!n||!e||t(n,e);const r={geometries:s,inSpatialReference:n,outSpatialReference:e,resolve:null};return this._jobs.push(r),new Promise((s=>{r.resolve=s,null===this._timer&&(this._timer=setTimeout(this._process,10))}))}_process(){this._timer=null;const s=this._jobs.shift();if(!s)return;const{geometries:t,inSpatialReference:e,outSpatialReference:r,resolve:o}=s;i(e,r)?n(r)?o(t.map(f)):o(t.map(x)):o(a(m,t,e,r,null)),this._jobs.length>0&&(this._timer=setTimeout(this._process,10))}}const _=new g;async function j(s,t,n){return _.push(s,t,n)}export{p as checkProjectionSupport,y as project,j as projectMany};
