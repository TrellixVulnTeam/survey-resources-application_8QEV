/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{unwrapOr as e,isNone as t,isSome as r}from"../../core/maybe.js";import i from"../../core/Logger.js";import n from"../../core/Error.js";import{WGS84 as o,equals as s}from"../../geometry/support/spatialReferenceUtils.js";import a from"../../geometry/SpatialReference.js";import{project as l}from"../../geometry/support/webMercatorUtils.js";import"../../geometry.js";import d from"../../request.js";import{kebabDict as c}from"../support/fieldType.js";import u from"../graphics/OptimizedFeatureSet.js";import{convertToFeatureSet as f,convertToGeometry as m,convertFromGeometry as p}from"../graphics/featureConversionUtils.js";import y from"../support/FieldsIndex.js";import g from"../../tasks/support/FeatureSet.js";import{validateGeoJSON as b,inferLayerProperties as w,createOptimizedFeatures as F}from"../graphics/sources/geojson/geojson.js";import{createDrawingInfo as I}from"../graphics/sources/support/clientSideDefaults.js";const h=i.getLogger("esri.layers.graphics.sources.ogcfeature"),j="json";async function T(e,t,r,i,o=5){const s=`${e}/collections/${t}/items`,{data:a}=await d(s,{signal:i,query:{limit:o,f:j}});await b(a);const l=w(a,{geometryType:r.geometryType}),u=r.fields||l.fields||[],f=null!=r.hasZ?r.hasZ:l.hasZ,m=l.geometryType,p=r.objectIdField||l.objectIdFieldName||"OBJECTID";let g=r.timeInfo;const F=u.find((e=>e.name===p));if(!F){if(!l.objectIdFieldType)throw new n("ogc-feature-layer:missing-feature-id","Collection geojson require a feature id as a unique identifier");u.unshift({name:p,alias:p,type:"esriFieldTypeOID",editable:!1,nullable:!1})}else F.type="esriFieldTypeOID",F.editable=!1,F.nullable=!1;if(p!==l.objectIdFieldName){const e=u.find((e=>e.name===l.objectIdFieldName));e&&(e.type="esriFieldTypeInteger")}if(!m)throw new n("ogc-feature-layer:missing-property","geometryType not set and couldn't be inferred from the provided features");u===l.fields&&l.unknownFields.length>0&&h.warn({name:"ogc-feature-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",details:{unknownFields:l.unknownFields}});for(const d of u){if(null==d.name&&(d.name=d.alias),null==d.alias&&(d.alias=d.name),"esriFieldTypeOID"!==d.type&&"esriFieldTypeGlobalID"!==d.type&&(d.editable=null==d.editable||!!d.editable,d.nullable=null==d.nullable||!!d.nullable),!d.name)throw new n("ogc-feature-layer:invalid-field-name","field name is missing",{field:d});if(-1===c.jsonValues.indexOf(d.type))throw new n("ogc-feature-layer:invalid-field-type",`invalid type for field "${d.name}"`,{field:d})}if(g){const e=new y(u);if(g.startTimeField){const t=e.get(g.startTimeField);t?(g.startTimeField=t.name,t.type="esriFieldTypeDate"):g.startTimeField=null}if(g.endTimeField){const t=e.get(g.endTimeField);t?(g.endTimeField=t.name,t.type="esriFieldTypeDate"):g.endTimeField=null}if(g.trackIdField){const t=e.get(g.trackIdField);t?g.trackIdField=t.name:(g.trackIdField=null,h.warn({name:"ogc-feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:g}}))}g.startTimeField||g.endTimeField||(h.warn({name:"ogc-feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:g}}),g=null)}return{drawingInfo:I(m),geometryType:m,fields:u,hasZ:!!f,objectIdField:p,timeInfo:g}}async function x(e,t,r){const i=`${e}/collections/${t}`,{data:n}=await d(i,{signal:r,query:{f:j}});return n}async function S(e,t){const r=`${e}/collections`,{data:i}=await d(r,{signal:t,query:{f:j}});return i}async function N(e,t){const r=`${e}/conformance`,{data:i}=await d(r,{signal:t,query:{f:j}});return i}async function $(e,t){const{data:r}=await d(e,{signal:t,query:{f:j}});return r}function k(e){const t=new RegExp("^http://www.opengis.net/def/crs/(?<authority>.*)/(?<version>.*)/(?<code>.*)$","i").exec(e),r=null==t?void 0:t.groups;if(!r)return null;const{authority:i,code:n}=r;switch(i.toLowerCase()){case"ogc":switch(n.toLowerCase()){case"crs27":return a.GCS_NAD_1927;case"crs83":return new a({wkid:4269});case"crs84":case"crs84h":return a.WGS84;default:return null}case"esri":case"epsg":{const e=Number.parseInt(n,10);return Number.isNaN(e)?null:900913===e?a.WebMercator:new a({wkid:e})}default:return null}}async function q(e,t,r){const i=await O(e,t,r);return g.fromJSON(i)}async function O(e,t,r){const i=await R(e,t,r);return f(i)}async function R(t,r,i){const{capabilities:{query:{maxRecordCount:s}},collectionId:c,layerDefinition:f,spatialReference:y,supportedCrs:g,url:b}=t,w=`${b}/collections/${c}/items`,{geometry:I,num:h,start:T,timeExtent:x,where:S}=r;if(r.objectIds)throw new n("ogc-feature-layer:query-by-objectids-not-supported","Queries with objectids are not supported");const N=a.fromJSON(y),$=e(r.outSpatialReference,N),k=$.isWGS84?null:D($,g),q=G(I,g),O=W(x),R=C(S),v=null!=h?h:null!=T&&void 0!==T?10:s,{data:M}=await d(w,{...i,query:{...q,crs:k,datetime:O,query:R,limit:v,startindex:T,f:j}});let Z=!1;if(M.links){Z=!!M.links.find((e=>"next"===e.rel))}!Z&&Number.isInteger(M.numberMatched)&&Number.isInteger(M.numberReturned)&&(Z=M.numberReturned<M.numberMatched);const{fields:L,globalIdField:E,hasM:J,hasZ:U,objectIdField:_}=f,z=f.geometryType,A=F(M,{geometryType:z,hasZ:U,objectIdFieldName:_});if(!k&&$.isWebMercator)for(const e of A)if(e.geometry){const t=m(e.geometry,z,U,!1);t.spatialReference=a.WGS84,e.geometry=p(l(t,$))}for(const e of A)e.objectId=e.attributes[_];const B=k||!k&&$.isWebMercator?$.toJSON():o,Q=new u;return Q.exceededTransferLimit=Z,Q.features=A,Q.fields=L,Q.geometryType=z,Q.globalIdFieldName=E,Q.hasM=J,Q.hasZ=U,Q.objectIdFieldName=_,Q.spatialReference=B,Q}function v(e){return r(e)&&"extent"===e.type}function D(e,t){return t.find((t=>{const r=k(t);return s(r,e)}))}function M(e){const{xmin:t,ymin:r,xmax:i,ymax:n}=e;return`${t},${r},${i},${n}`}function W(e){if(t(e))return null;const{start:r,end:i}=e;return`${r?r.toISOString():".."}/${i?i.toISOString():".."}`}function C(e){return t(e)||!e||"1=1"===e?null:e}function G(e,t){if(!v(e))return null;const{spatialReference:r}=e;if(!r||r.isWGS84)return{bbox:M(e)};const i=D(r,t);return i?{bbox:M(e),"bbox-crs":i}:r.isWebMercator?{bbox:M(l(e,a.WGS84))}:null}export{T as getCollectionDefinition,x as getServerCollection,S as getServerCollections,N as getServerConformance,$ as getServerLandingPage,k as getSpatialReference,q as queryFeatureSet,O as queryFeatureSetJSON,R as queryOptimizedFeatureSet};
