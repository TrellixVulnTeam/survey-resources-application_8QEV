/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import e from"../../core/Error.js";import n from"../../popup/FieldInfo.js";import o from"../../popup/ExpressionInfo.js";import i from"../../PopupTemplate.js";import{substitute as t}from"../../intl/substitute.js";import{fetchMessageBundle as r}from"../../intl/messages.js";import{getArcadeForPredominantCategoryAlias as s,getArcadeForPredominantCategoryValue as f,getArcadeForPredominanceMargin as a,getArcadeForStrengthOfPredominance as p,getArcadeForOrderedFields as l,getArcadeForSumOfFields as d}from"../statistics/support/predominanceUtils.js";import{getFieldInfo as m}from"./support/utils.js";function I(e,n){return e.legendOptions&&e.legendOptions.title?e.legendOptions.title:n.competingFields}function u(e,i){return{fieldInfo:new n({fieldName:"expression/predominant-category"}),expressionInfo:new o({name:"predominant-category",title:i.predominantCategory,expression:s(e)})}}function c(e,i){const t=e.map((e=>e.fieldName));return{fieldInfo:new n({fieldName:"expression/predominant-value",format:{digitSeparator:!0,places:1}}),expressionInfo:new o({name:"predominant-value",title:i.predominantCategoryValue,expression:f(t),returnType:"number"})}}function x(e,i){const t=e.map((e=>e.fieldName));return{fieldInfo:new n({fieldName:"expression/predominant-margin",format:{digitSeparator:!0,places:0}}),expressionInfo:new o({name:"predominant-margin",title:i.marginOfVictory,expression:a(t),returnType:"number"})}}function g(e,i){const t=e.map((e=>e.fieldName));return{fieldInfo:new n({fieldName:"expression/predominant-strength",format:{digitSeparator:!0,places:0}}),expressionInfo:new o({name:"predominant-strength",title:i.strengthOfPredominance,expression:p(t),returnType:"number"})}}function y(e,i){return{fieldInfo:new n({fieldName:"expression/predominant-categories-list"}),expressionInfo:new o({name:"predominant-categories-list",title:i.listOfCategories,expression:l(e)})}}function b(e,i){const t=e.map((e=>e.fieldName));return{fieldInfo:new n({fieldName:"expression/predominant-total",format:{digitSeparator:!0,places:0}}),expressionInfo:new o({name:"predominant-total",title:i.sumOfCategories,expression:d(t),returnType:"number"})}}function N(e,n){const o=u(e.fieldInfos,n),r=new i({expressionInfos:[o.expressionInfo],fieldInfos:[o.fieldInfo],content:t(n.predominantCategoryContent,{expression:`<b>{${o.fieldInfo.fieldName}}</b>`})});return{name:"predominant-category",title:n.predominantCategory,value:r}}function w(e,n){const{fieldInfos:o}=e,r=u(o,n),s=c(o,n),f=new i({expressionInfos:[s.expressionInfo,r.expressionInfo],fieldInfos:[s.fieldInfo,r.fieldInfo],content:t(n.predominantCategoryValueContent,{expression1:`<b>{${r.fieldInfo.fieldName}}</b>`,expression2:`<b>{${s.fieldInfo.fieldName}}</b>`})});return{name:"predominant-category-value",title:n.predominantCategoryValue,value:f}}function C(e,n){const{fieldInfos:o}=e,r=u(o,n),s=c(o,n),f=x(o,n),a=new i({expressionInfos:[s.expressionInfo,r.expressionInfo,f.expressionInfo],fieldInfos:[s.fieldInfo,r.fieldInfo,f.fieldInfo],title:t(n.mostCommon,{expression:"{expression/predominant-category}"}),content:t(n.predominantCategoryValueMarginContent,{expression1:`<b>{${r.fieldInfo.fieldName}}</b>`,expression2:`<b>{${s.fieldInfo.fieldName}}</b>`,expression3:`<b>{${f.fieldInfo.fieldName}}</b>`})});return{name:"predominant-category-value-margin",title:n.marginOfVictory,value:a}}function h(e,n){const{fieldInfos:o}=e,r=u(o,n),s=c(o,n),f=g(o,n),a=new i({expressionInfos:[s.expressionInfo,r.expressionInfo,f.expressionInfo],fieldInfos:[s.fieldInfo,r.fieldInfo,f.fieldInfo],content:t(n.predominantCategoryStrengthContent,{expression1:`{${s.fieldInfo.fieldName}}`,expression2:`<b>{${r.fieldInfo.fieldName}}</b>`,expression3:`<b>{${f.fieldInfo.fieldName}}%</b>`})});return{name:"predominant-category-strength",title:n.strengthOfPredominance,value:a}}function $(e,n){const{renderer:o,fieldInfos:r}=e,s=u(r,n),f=c(r,n),a=g(r,n),p=y(r,n),l=new i({expressionInfos:[s.expressionInfo,f.expressionInfo,a.expressionInfo,p.expressionInfo],fieldInfos:[s.fieldInfo,f.fieldInfo,a.fieldInfo,p.fieldInfo],title:I(o,n),content:[{type:"text",text:t(n.predominantCategoryStrengthContent,{expression1:`{${f.fieldInfo.fieldName}}`,expression2:`<b>{${s.fieldInfo.fieldName}}</b>`,expression3:`<b>{${a.fieldInfo.fieldName}}%</b>`})},{type:"text",text:`{${p.fieldInfo.fieldName}}`}]});return{name:"predominant-categories-list",title:n.orderedListOfValues,value:l}}function v(e,n){const{fieldInfos:o}=e,r=u(o,n),s=c(o,n),f=g(o,n),a=b(o,n),p=new i({expressionInfos:[s.expressionInfo,r.expressionInfo,a.expressionInfo,f.expressionInfo],fieldInfos:[s.fieldInfo,r.fieldInfo,a.fieldInfo,f.fieldInfo],content:t(n.predominantCategoryTotalStrengthContent,{expression1:`{${s.fieldInfo.fieldName}}`,expression2:`<b>{${r.fieldInfo.fieldName}}</b>`,expression3:`<b>{${f.fieldInfo.fieldName}}%</b>`,expression4:`{${a.fieldInfo.fieldName}}`})});return{name:"predominant-category-total-strength",title:n.predominantCategoryWithTotalAndStrength,value:p}}function O(e,n){const{renderer:o,fieldInfos:r}=e,s=u(r,n),f=c(r,n),a=g(r,n),p=new i({expressionInfos:[f.expressionInfo,s.expressionInfo,a.expressionInfo],fieldInfos:[f.fieldInfo,s.fieldInfo,a.fieldInfo],title:I(o,n),content:[{type:"text",text:t(n.predominantCategoryStrengthContent,{expression1:`{${f.fieldInfo.fieldName}}`,expression2:`<b>{${s.fieldInfo.fieldName}}</b>`,expression3:`<b>{${a.fieldInfo.fieldName}}%</b>`})},{type:"media",mediaInfos:{type:"pie-chart",value:{fields:r.map((e=>e.fieldName))}}}]});return{name:"predominant-category-chart",title:n.predominantCategoryWithChart,value:p}}function S(n,o){const i=n.authoringInfo,t="predominance"===i.type?i.fields:[];if(!t||!t.length)throw new e("predominance-popup:insufficient-info","unable to find input fields in authoringInfo");return t.map((e=>m(o,e)))}async function T(n){const{layer:o,renderer:i}=n;await o.load();const t=i||o.renderer;if("unique-value"!==t.type)throw new e("predmoinance-popup:invalid-parameters","renderer.type must be 'unique-value'");return{renderer:t,fieldInfos:S(t,o)}}async function j(e){const[n,o]=await Promise.all([T(e),r("esri/smartMapping/t9n/smartMapping")]);return[N(n,o),w(n,o),C(n,o),v(n,o),$(n,o),h(n,o),O(n,o)]}async function V(e){const[n,o]=await Promise.all([T(e),r("esri/smartMapping/t9n/smartMapping")]),i=$(n,o),t=await j(e);return{primaryTemplate:i,secondaryTemplates:t.filter((e=>e.name!==i.name))}}export{j as getAllTemplates,V as getTemplates};
