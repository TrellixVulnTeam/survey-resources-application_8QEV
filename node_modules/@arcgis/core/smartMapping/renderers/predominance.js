/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{isSome as e}from"../../core/maybe.js";import a from"../../core/Error.js";import{fetchMessageBundle as i}from"../../intl/messages.js";import s from"../../renderers/support/AuthoringInfoVisualVariable.js";import r from"../../renderers/support/AuthoringInfo.js";import n from"../../renderers/visualVariables/OpacityVariable.js";import{round as o}from"../../renderers/support/numberUtils.js";import{getPredominanceExpressions as l}from"../statistics/support/predominanceUtils.js";import{createLayerAdapter as t,getLayerTypeLabels as p}from"../support/adapters/support/layerUtils.js";import m from"../statistics/summaryStatistics.js";import d from"../heuristics/outline.js";import{verifyBasicFieldValidity as u,getBasemapInfo as c,createSymbol as y,getSymbolOutlineFromScheme as b,createColors as f}from"./support/utils.js";import{createVisualVariables as g}from"./size.js";import{createRenderer as h}from"./type.js";import v from"../statistics/predominantCategories.js";import{c as w,g as z}from"../../chunks/predominance.js";async function T(i){if(!(i&&i.layer&&i.view&&i.fields&&i.fields.length))throw new a("predominance-renderer:missing-parameters","'layer', 'view' and 'fields' parameters are required");if(i.fields.length<2)throw new a("predominance-renderer:invalid-parameters","Minimum 2 fields are required");if(i.fields.length>10)throw new a("predominance-renderer:invalid-parameters","Maximum 10 fields are supported");const s={...i};s.symbolType=s.symbolType||"2d",s.defaultSymbolEnabled=null==s.defaultSymbolEnabled||s.defaultSymbolEnabled,s.includeOpacityVariable=i.includeOpacityVariable||!1,s.includeSizeVariable=i.includeSizeVariable||!1,s.sortBy=null==s.sortBy?"count":s.sortBy;const r=[0,2,1,3],n=t(s.layer,r);if(s.layer=n,!n)throw new a("predominance-renderer:invalid-parameters","'layer' must be one of these types: "+p(r).join(", "));const o=e(s.signal)?{signal:s.signal}:null;await n.load(o);const l=n.geometryType,m=s.symbolType.indexOf("3d")>-1;if(s.outlineOptimizationEnabled="polygon"===l&&s.outlineOptimizationEnabled,s.includeSizeVariable||(s.sizeOptimizationEnabled=("point"===l||"multipoint"===l||"polyline"===l)&&s.sizeOptimizationEnabled),"mesh"===l)s.symbolType="3d-volumetric",s.colorMixMode=s.colorMixMode||"replace",s.edgesType=s.edgesType||"none",s.sizeOptimizationEnabled=!1;else{if(m&&("polyline"===l||"polygon"===l))throw new a("predominance-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");if(s.symbolType.indexOf("3d-volumetric")>-1&&(!s.view||"3d"!==s.view.type))throw new a("predominance-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'")}const d=s.fields.map((e=>e.name)),c=u(n,d,"predominance-renderer:invalid-parameters");if(c)throw c;return s}async function V(a){let i=a.predominanceScheme,s=null,r=null;const n=await c(a.basemap,a.view);if(s=e(n.basemapId)?n.basemapId:null,r=e(n.basemapTheme)?n.basemapTheme:null,i)return{scheme:w(i),basemapId:s,basemapTheme:r};const o=z({basemap:s,basemapTheme:r,geometryType:a.geometryType,numColors:a.numColors,theme:a.theme,worldScale:a.worldScale,view:a.view});return o&&(i=o.primaryScheme,s=o.basemapId,r=o.basemapTheme),{scheme:i,basemapId:s,basemapTheme:r}}async function E(e,a,s,n){const o=await i("esri/smartMapping/t9n/smartMapping"),l=e.layer,t={layer:e.layer,view:e.view,signal:e.signal},[p,m]=await Promise.all([v({layer:l,fields:n,view:e.view,signal:e.signal}),e.outlineOptimizationEnabled?d(t):null]);let u=p;p&&p.predominantCategoryInfos||(u={predominantCategoryInfos:n.map((e=>({value:e,count:0})))});const c=m&&m.opacity,g=await h({layer:l,basemap:e.basemap,valueExpression:a.valueExpression,valueExpressionTitle:o.predominantCategory,numTypes:-1,defaultSymbolEnabled:e.defaultSymbolEnabled,sortBy:e.sortBy,typeScheme:s,statistics:{uniqueValueInfos:u.predominantCategoryInfos},legendOptions:e.legendOptions,outlineOptimizationEnabled:!1,sizeOptimizationEnabled:(!e.includeSizeVariable||!e.sizeOptimizationEnabled)&&e.sizeOptimizationEnabled,symbolType:e.symbolType,colorMixMode:e.colorMixMode,edgesType:e.edgesType,view:e.view,signal:e.signal}),{renderer:w,basemapId:z,basemapTheme:T,uniqueValueInfos:V,excludedUniqueValueInfos:E}=g,S=w.uniqueValueInfos,x={};for(const i of e.fields){const e=l.getField(i.name);x[e.name]=i.label||e&&e.alias||i.name}if(S.forEach(((e,a)=>{const i=x[e.value];e.label=i,V[a].label=i})),e.includeSizeVariable){let a=l.geometryType,i=null;if("polygon"===a){const r=s.sizeScheme,n=r.background;w.backgroundFillSymbol=y(a,{type:e.symbolType,color:n.color,outline:b(n,a,c)}),i=r.marker.size,a="point"}else if("polyline"===a){i=s.width}else{i=s.size}const r=f(s.colors,S.length);S.forEach(((n,o)=>{const l=y(a,{type:e.symbolType,color:r[o],size:i,outline:b(s,a,c),meshInfo:{colorMixMode:e.colorMixMode,edgesType:e.edgesType}});n.symbol=l,V[o].symbol=l.clone()}))}return m&&m.visualVariables&&m.visualVariables.length&&(w.visualVariables=m.visualVariables.map((e=>e.clone()))),w.authoringInfo=new r({type:"predominance",fields:[...n]}),{renderer:w,predominantCategoryInfos:V,excludedCategoryInfos:E,predominanceScheme:s,basemapId:z,basemapTheme:T}}async function S(e,a,s){const r=await i("esri/smartMapping/t9n/smartMapping");return g({layer:e.layer,basemap:e.basemap,valueExpression:a.valueExpression,sqlExpression:a.statisticsQuery.sqlExpression,sqlWhere:a.statisticsQuery.sqlWhere,sizeScheme:s,sizeOptimizationEnabled:e.sizeOptimizationEnabled,worldScale:e.symbolType.indexOf("3d-volumetric")>-1,legendOptions:{title:r.sumOfCategories},view:e.view,signal:e.signal})}async function x(e,a){const l=await i("esri/smartMapping/t9n/smartMapping"),t=await m({layer:e.layer,valueExpression:a.valueExpression,sqlExpression:a.statisticsQuery.sqlExpression,sqlWhere:a.statisticsQuery.sqlWhere,view:e.view,signal:e.signal}),p=null==t.avg||null==t.stddev,d=1/e.fields.length*100;let u=p?100:t.avg+1.285*t.stddev;u>100&&(u=100);const c=o([d,u],{strictBounds:!0}),y=new n({valueExpression:a.valueExpression,stops:[{value:c[0],opacity:.15},{value:c[1],opacity:1}],legendOptions:{title:l.strengthOfPredominance}}),b=new s({type:"opacity",minSliderValue:t.min,maxSliderValue:t.max});return{visualVariable:y,statistics:t,defaultValuesUsed:p,authoringInfo:new r({visualVariables:[b]})}}async function O(e){const a=await T(e),i=a.layer,s=(await V({basemap:a.basemap,geometryType:i.geometryType,numColors:a.fields.length,predominanceScheme:a.predominanceScheme,worldScale:a.symbolType.indexOf("3d-volumetric")>-1,view:a.view})).scheme,r=a.fields.map((e=>e.name)),n=l(i,r),o=E(a,n.predominantCategory,s,r),t=a.includeSizeVariable?S(a,n.size,s.sizeScheme):null,p=a.includeOpacityVariable?x(a,n.opacity):null,[m,d,u]=await Promise.all([o,t,p]),c=[],y=[];if(d&&(Array.prototype.push.apply(c,d.visualVariables.map((e=>e.clone()))),delete d.sizeScheme,m.size=d,Array.prototype.push.apply(y,d.authoringInfo.visualVariables.map((e=>e.clone())))),u&&(c.push(u.visualVariable.clone()),m.opacity=u,Array.prototype.push.apply(y,u.authoringInfo.visualVariables.map((e=>e.clone())))),c.length){const e=m.renderer.visualVariables||[];Array.prototype.push.apply(e,c),m.renderer.visualVariables=e,m.renderer.authoringInfo.visualVariables=y}return m}export{O as createRenderer};
