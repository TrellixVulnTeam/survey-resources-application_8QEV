/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{numericHash as e}from"../../core/string.js";import{throwIfAborted as t}from"../../core/promiseUtils.js";import{getJsonType as r,isPolygon as a,isPolyline as i}from"../../geometry/support/jsonUtils.js";import{pt2px as s}from"../../core/screenUtils.js";import o from"../support/Symbol3DAnchorPosition2D.js";import n from"../../request.js";import{createLabelOverrideFunction as c,evaluateValueOrFunction as l,colorToArray as m}from"./utils.js";import{scaleCIMMarker as h}from"../support/cimSymbolUtils.js";import{analyzeCIMSymbol as f,analyzeCIMResource as g}from"./cimAnalyzer.js";import y from"./Rasterizer.js";import{TextRasterizer as u}from"./TextRasterizer.js";var p;!function(e){e.Legend="legend",e.Preview="preview"}(p||(p={}));const d=(e,t,r)=>{if(e&&e.targetSize){let a;if(r){const t=Math.max(r.frame.xmax-r.frame.xmin,r.frame.ymax-r.frame.ymin);a=e.targetSize/s(t)}else a=e.targetSize/t.referenceSize;return a}return e&&e.scaleFactor?e.scaleFactor:1},M={fill:{legend:{frame:{xmax:15,xmin:0,ymax:15,ymin:0},geometry:{rings:[[[0,15],[15,7.5],[15,0],[0,0],[0,15]]]},canvasPaths:{rings:[[[0,15],[0,0],[15,7.5],[15,15],[0,15]]]}},preview:{frame:{xmax:100,xmin:0,ymax:100,ymin:0},geometry:{rings:[[[0,100],[100,100],[100,0],[0,0],[0,100]]]},canvasPaths:{rings:[[[0,100],[0,0],[100,0],[100,100],[0,100]]]}}},stroke:{legend:{frame:{xmax:24,xmin:0,ymax:-2,ymin:2},geometry:{paths:[[[0,0],[12,0],[24,0]]]},canvasPaths:{paths:[[[0,2],[12,2],[24,2]]]}},preview:{frame:{xmax:100,xmin:0,ymax:-2,ymin:2},geometry:{paths:[[[0,0],[50,0],[100,0]]]},canvasPaths:{paths:[[[0,2],[50,2],[100,2]]]}}}};class C{constructor(e,t){this._spatialReference=e,this._avoidSDF=t,this._resourceCache=new Map,this._rasterizer=new y,this._textRasterizer=new u,this._pictureMarkerCache=new Map}async rasterizeCIMSymbolAsync(e,t,a,i,s,o,n,c){i=i||(t?null!=t.centroid?"esriGeometryPolygon":r(t.geometry):null)||z(e);const l=await this.analyzeCIMSymbol(e,t?I(t.attributes):null,a,i,c);return this.rasterizeCIMSymbol(l,t,i,s,o,n)}async analyzeCIMSymbol(e,r,a,i,s){const o=[],n=r?{geometryType:i,spatialReference:this._spatialReference,fields:r}:null;let l;await f(e.data,n,o,this._avoidSDF),t(s);for(const t of o)"CIMPictureMarker"!==t.cim.type&&"CIMPictureFill"!==t.cim.type&&"CIMPictureStroke"!==t.cim.type||(l||(l=[]),l.push(this.fetchPictureMarkerResource(t,s))),a&&"text"===t.type&&"string"==typeof t.text&&t.text.indexOf("[")>-1&&(t.text=c(a,t.text,t.cim.textCase));return l&&await Promise.all(l),o}async fetchPictureMarkerResource(e,t){const r=e.materialHash;if(!this._pictureMarkerCache.get(r)){const a=(await n(e.cim.url,{responseType:"image",signal:t&&t.signal})).data;this._pictureMarkerCache.set(r,a)}}rasterizeCIMSymbol(e,t,r,a,i,s){const o=[];for(const n of e){a&&"function"==typeof a.scaleFactor&&(a.scaleFactor=a.scaleFactor(t,i,s));const e=this._getRasterizedResource(n,t,r,a,i,s);if(!e)continue;let c=0,m=e.anchorX||0,h=e.anchorY||0,f=!1,g=0,y=0;if("esriGeometryPoint"===r){const e=d(a,n,null);if(g=l(n.offsetX,t,i,s)*e||0,y=l(n.offsetY,t,i,s)*e||0,"marker"===n.type)c=l(n.rotation,t,i,s)||0,f=!!n.rotateClockwise&&n.rotateClockwise;else if("text"===n.type){if(c=l(n.angle,t,i,s)||0,void 0!==n.horizontalAlignment)switch(n.horizontalAlignment){case"left":m=-.5;break;case"right":m=.5;break;default:m=0}if(void 0!==n.verticalAlignment)switch(n.verticalAlignment){case"top":h=.5;break;case"bottom":h=-.5;break;case"baseline":h=-.25;break;default:h=0}}}null!=e&&o.push({angle:c,rotateClockWise:f,anchorX:m,anchorY:h,offsetX:g,offsetY:y,rasterizedResource:e})}return this.getSymbolImage(o)}getSymbolImage(e){const t=document.createElement("canvas"),r=t.getContext("2d");let a=0,i=0,n=0,c=0;const l=[];for(let o=0;o<e.length;o++){const t=e[o],m=t.rasterizedResource;if(!m)continue;const h=m.size,f=t.offsetX,g=t.offsetY,y=t.anchorX,u=t.anchorY,p=t.rotateClockWise||!1;let d=t.angle,M=s(f)-h[0]*(.5+y),C=s(g)-h[1]*(.5+u),I=M+h[0],z=C+h[1];if(d){p&&(d=-d);const e=Math.sin(d*Math.PI/180),t=Math.cos(d*Math.PI/180),r=M*t-C*e,a=M*e+C*t,i=M*t-z*e,s=M*e+z*t,o=I*t-z*e,n=I*e+z*t,c=I*t-C*e,l=I*e+C*t;M=Math.min(r,i,o,c),C=Math.min(a,s,n,l),I=Math.max(r,i,o,c),z=Math.max(a,s,n,l)}a=M<a?M:a,i=C<i?C:i,n=I>n?I:n,c=z>c?z:c;const P=r.createImageData(m.size[0],m.size[1]);P.data.set(new Uint8ClampedArray(m.image.buffer));const x={offsetX:f,offsetY:g,rotateClockwise:p,angle:d,rasterizedImage:P,anchorX:y,anchorY:u};l.push(x)}t.width=n-a,t.height=c-i;const m=-a,h=c;for(let o=0;o<l.length;o++){const e=l[o],t=this._imageDataToCanvas(e.rasterizedImage),a=e.rasterizedImage.width,i=e.rasterizedImage.height,n=m-a*(.5+e.anchorX),c=h-i*(.5-e.anchorY);if(e.angle){const a=(360-e.angle)*Math.PI/180;r.save(),r.translate(s(e.offsetX),-s(e.offsetY)),r.translate(m,h),r.rotate(a),r.translate(-m,-h),r.drawImage(t,n,c),r.restore()}else r.drawImage(t,n+s(e.offsetX),c-s(e.offsetY))}const f=new o({x:m/t.width-.5,y:h/t.height-.5});return{imageData:0!==t.width&&0!==t.height?r.getImageData(0,0,t.width,t.height):r.createImageData(1,1),anchorPosition:f}}_imageDataToCanvas(e){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const t=this._imageDataCanvas,r=t.getContext("2d");return t.width=e.width,t.height=e.height,r.putImageData(e,0,0),t}_imageTo32Array(e,t,r){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const a=this._imageDataCanvas,i=a.getContext("2d");return a.width=t,a.height=r,i.drawImage(e,0,0,t,r),new Uint32Array(i.getImageData(0,0,t,r).data.buffer)}_getRasterizedResource(t,r,a,i,s,o){let n,c,m,f;if("esriGeometryPolyline"===a||"esriGeometryPolygon"===a){const h=i&&i.style?i.style:p.Legend,f="esriGeometryPolyline"===a?M.stroke[h]:M.fill[h];if("line"===t.type){if("CIMSolidStroke"!==t.cim.type){if("CIMPictureStroke"===t.cim.type){const e=l(t.width,r,s,o),{image:a,width:i,height:n}=this._getPictureResource(t,e);return this._rasterizePictureResource(t,a,i,n,f,e)}return null}({analyzedCIM:n,hash:m}=P(t,r,s,o)),c=this._embedCIMLayerInVectorMarker(n,f)}else if("marker"===t.type){if("CIMPictureMarker"===t.cim.type)return null;if("CIMVectorMarker"!==t.cim.type)return null;t.cim.offsetX=l(t.offsetX,r,s,o),t.cim.offsetY=l(t.offsetY,r,s,o),t.cim.rotation=l(t.rotation,r,s,o),t.cim.markerPlacement=t.markerPlacement,({analyzedCIM:n}=P(t,r,s,o)),m=e(JSON.stringify(n)).toString(),c=this._embedCIMLayerInVectorMarker(n,f)}else{if("text"===t.type)return null;if("fill"===t.type){if("CIMHatchFill"===t.cim.type||"CIMVectorMarker"===t.cim.type||"CIMPictureMarker"===t.cim.type||"CIMPictureFill"===t.cim.type){const e=t.cim.size||t.cim.height;let a,i,c;if("CIMPictureMarker"===t.cim.type||"CIMPictureFill"===t.cim.type)({image:a,width:i,height:c}=this._getPictureResource(t,e));else{({analyzedCIM:n,hash:m}=P(t,r,s,o));const e=this._rasterizer.rasterizeJSONResource(n,1,this._avoidSDF);a=e.image,i=e.size[0],c=e.size[1]}return this._rasterizePictureResource(t,a,i,c,f,null)}if("CIMSolidFill"!==t.cim.type)return null;({analyzedCIM:n,hash:m}=P(t,r,s,o)),c=this._embedCIMLayerInVectorMarker(n,f)}}}else{if("text"===t.type)return f=this._rasterizeTextResource(t,r,i,s,o),f;({analyzedCIM:n,hash:m}=P(t,r,s,o));const e=d(i,t,null);if("CIMPictureMarker"===t.cim.type){const a=l(t.size,r,s,o)*e,{image:i,width:n,height:c}=this._getPictureResource(t,a);return f={image:i,size:[n,c],sdf:!1,simplePattern:!1,anchorX:t.anchorPoint?t.anchorPoint.x:0,anchorY:t.anchorPoint?t.anchorPoint.y:0},f}h(n,e,{preserveOutlineWidth:!1}),c=n}m+=a,i&&(m+=JSON.stringify(i));const g=this._resourceCache;return g.has(m)?g.get(m):(f=this._rasterizer.rasterizeJSONResource(c,window.devicePixelRatio||1,this._avoidSDF),g.set(m,f),f)}_rasterizeTextResource(e,t,r,a,i){const s=d(r,e,null),o=l(e.text,t,a,i);if(!o||0===o.length)return null;const n=l(e.fontName,t,a,i),c=l(e.style,t,a,i),h=l(e.weight,t,a,i),f=l(e.decoration,t,a,i),g=l(e.size,t,a,i)*s,y=l(e.horizontalAlignment,t,a,i),u=l(e.verticalAlignment,t,a,i),p=m(l(e.color,t,a,i)),M=m(l(e.outlineColor,t,a,i)),C={color:p,size:g,horizontalAlignment:y,verticalAlignment:u,font:{family:n,style:c,weight:h,decoration:f},halo:{size:l(e.outlineSize,t,a,i)||0,color:M,style:c},pixelRatio:1,premultiplyColors:!this._avoidSDF};return this._textRasterizer.rasterizeText(o,C)}_rasterizePictureResource(e,t,r,o,n,c){const l=document.createElement("canvas"),m=l.getContext("2d");l.height=s(Math.max(Math.abs(n.frame.ymax-n.frame.ymin),c)),l.width=s(Math.abs(n.frame.xmax-n.frame.xmin));const h=m.createImageData(r,o);h.data.set(new Uint8ClampedArray(t.buffer));const f=this._imageDataToCanvas(h),g=m.createPattern(f,"repeat"),y=Math.cos((-e.cim.rotation||0)*Math.PI/180),u=Math.sin((-e.cim.rotation||0)*Math.PI/180);g.setTransform({m11:y,m12:u,m21:-u,m22:y,m41:s(e.cim.offsetX)||0,m42:s(e.cim.offsetY)||0});const p=n.canvasPaths;let d,M,C;a(p)?(d=p.rings,m.fillStyle=g,M=m.fill,C=["evenodd"]):i(p)&&(d=p.paths,m.strokeStyle=g,m.lineWidth=c,M=m.stroke,d[0][0][1]=l.height/2,d[0][1][1]=l.height/2),m.beginPath();for(const a of d){const e=a?a.length:0;if(e>1){let t=a[0];m.moveTo(s(t[0]),s(t[1]));for(let r=1;r<e;++r)t=a[r],m.lineTo(s(t[0]),s(t[1]));m.closePath()}}M.apply(m,C);const I=m.getImageData(0,0,l.width,l.height),z=new Uint8Array(I.data);return{size:[l.width,l.height],image:new Uint32Array(z.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}_getPictureResource(e,t){const r=this._pictureMarkerCache.get(e.materialHash);if(!r)return null;const a=r.height/r.width,i=t?a>1?s(t):s(t)/a:r.width,o=t?a>1?s(t)*a:s(t):r.height;return{image:this._imageTo32Array(r,i,o),width:i,height:o}}_embedCIMLayerInVectorMarker(e,t){const r=a(t.geometry)?"CIMPolygonSymbol":"CIMLineSymbol";return{type:"CIMVectorMarker",frame:t.frame,markerGraphics:[{type:"CIMMarkerGraphic",geometry:t.geometry,symbol:{type:r,symbolLayers:[e]}}]}}}function I(e){return(e?Object.keys(e):[]).map((t=>({name:t,alias:t,type:"string"==typeof e[t]?"esriFieldTypeString":"esriFieldTypeDouble"})))}function z(e){if(!(e&&e.data&&e.data.symbol))return null;switch(e.data.symbol.type){case"CIMPointSymbol":case"CIMTextSymbol":return"esriGeometryPoint";case"CIMLineSymbol":return"esriGeometryPolyline";case"CIMPolygonSymbol":return"esriGeometryPolygon";default:return null}}function P(e,t,r,a){let i,s;if("function"==typeof e.materialHash){i=(0,e.materialHash)(t,r,a),s=g(e.cim,e.materialOverrides)}else i=e.materialHash,s=e.cim;return{analyzedCIM:s,hash:i}}export{C as CIMSymbolRasterizer,p as GeometryStyle};
