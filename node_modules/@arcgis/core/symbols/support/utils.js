/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import e from"../../core/has.js";import{isSome as t,unwrap as r,get as o,isNone as n}from"../../core/maybe.js";import i from"../../Color.js";import{px2pt as l}from"../../core/screenUtils.js";import s from"./Symbol3DMaterial.js";import{isSymbol3D as c,isSymbol2D as u}from"../../symbols.js";import{forEach as a}from"../../core/asyncUtils.js";import{O as f}from"../../chunks/vec3f64.js";import{getStroke as m}from"./gfxUtils.js";const y=/\/resource\/(.*?)\.svg$/,p=new i("white");function h(e){const t=e.symbolLayers&&e.symbolLayers.length;if(!t)return;const r=e.symbolLayers.getItemAt(t-1);return"outline"in r?o(r,"outline","size"):void 0}function b(e){if(!e)return 0;if(c(e)){const r=h(e);return t(r)?r:0}const r=m(e);return r&&l(r.width)||0}function w(e){if(!e||!e.symbolLayers)return!1;switch(e.type){case"point-3d":return e.symbolLayers.some((e=>"object"===e.type));case"line-3d":return e.symbolLayers.some((e=>"path"===e.type));case"polygon-3d":return e.symbolLayers.some((e=>"object"===e.type||"extrude"===e.type));default:return!1}}function d(t,r){const o=r.resource.href;return!e("esri-canvas-svg-support")&&t.styleOrigin&&y.test(o)?o.replace(y,"/resource/png/$1.png"):o}function g(e,t){if(!e)return null;let r=null;return c(e)?r=j(e):u(e)&&(r=e.color?new i(e.color):null),r?k(r,t):null}function j(e){const o=e.symbolLayers;if(!o)return null;let n=null;return o.forEach((e=>{"object"===e.type&&null!=e.resource.href||(n="water"===e.type?r(e.color):t(e.material)?r(e.material.color):null)})),n?new i(n):null}function k(e,t){if(null==t)return e;const r=e.toRgba();return r[3]=r[3]*t,new i(r)}function L(e,r,o){const i=e.symbolLayers;if(!i)return;const l=e=>{const n=t(e)?e:null;return k(r=r||n||null!=o&&p,o)};i.forEach((e=>{if("object"!==e.type||null==e.resource.href||r)if("water"===e.type)e.color=l(e.color);else{const r=t(e.material)?e.material.color:null,i=l(r);n(e.material)?e.material=new s({color:i}):e.material.color=i,null!=o&&"outline"in e&&t(e.outline)&&t(e.outline.color)&&(e.outline.color=k(e.outline.color,o))}}))}function z(e,t,r){(t=t||e.color)&&(e.color=k(t,r)),null!=r&&"outline"in e&&e.outline&&e.outline.color&&(e.outline.color=k(e.outline.color,r))}function v(e,t,r){e&&(t||null!=r)&&(t&&(t=new i(t)),c(e)?L(e,t,r):u(e)&&z(e,t,r))}async function x(e,t){const r=e.symbolLayers;r&&await a(r,(async e=>S(e,t)))}async function S(e,t){switch(e.type){case"extrude":O(e,t);break;case"icon":case"line":case"text":U(e,t);break;case"path":$(e,t);break;case"object":await R(e,t)}}function U(e,r){const o=E(r);t(o)&&(e.size=o)}function E(e){for(const t of e)if("number"==typeof t)return t;return null}function O(e,t){e.size="number"==typeof t[2]?t[2]:0}async function R(e,t){const{resourceSize:r,symbolSize:o}=await C(e),n=A(t,r,o);e.width=D(t[0],o[0],r[0],n),e.depth=D(t[1],o[1],r[1],n),e.height=D(t[2],o[2],r[2],n)}function $(e,t){const r=A(t,f,[e.width,void 0,e.height]);e.width=D(t[0],e.width,1,r),e.height=D(t[2],e.height,1,r)}function A(e,t,r){for(let o=0;o<3;o++){const n=e[o];switch(n){case"symbol-value":return null!=r[o]?r[o]/t[o]:1;case"proportional":break;default:if(n&&t[o])return n/t[o]}}return 1}async function C(e){const t=await import("./symbolLayerUtils.js"),r=await t.computeObjectLayerResourceSize(e,10),{width:o,height:n,depth:i}=e,l=[o,i,n];let s=1;for(let c=0;c<3;c++)if(null!=l[c]){s=l[c]/r[c];break}for(let c=0;c<3;c++)null==l[c]&&(l[c]=r[c]*s);return{resourceSize:r,symbolSize:l}}function D(e,t,r,o){switch(e){case"proportional":return r*o;case"symbol-value":return null!=t?t:r;default:return e}}function I(e,t){const r=E(t);if(!n(r))switch(e.type){case"simple-marker":e.size=r;break;case"picture-marker":{const t=e.width/e.height;t>1?(e.width=r,e.height=r*t):(e.width=r*t,e.height=r);break}case"simple-line":e.width=r;break;case"text":e.font.size=r}}async function M(e,t){if(e&&t)return c(e)?x(e,t):void(u(e)&&I(e,t))}function q(e,t,r){if(e&&null!=t)if(c(e)){const o=e.symbolLayers;o&&o.forEach((e=>{if(e&&"object"===e.type)switch(r){case"tilt":e.tilt=t;break;case"roll":e.roll=t;break;default:e.heading=t}}))}else u(e)&&("simple-marker"!==e.type&&"picture-marker"!==e.type&&"text"!==e.type||(e.angle=t))}export{v as applyColorToSymbol,k as applyOpacityToColor,q as applyRotationToSymbol,M as applySizesToSymbol,g as getColorFromSymbol,d as getIconHref,b as getSymbolOutlineSize,w as isVolumetricSymbol};
