/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import"../../core/has.js";import{isSome as e,isNone as t,unwrap as l}from"../../core/maybe.js";import{loadArcade as a}from"../../support/arcadeOnDemand.js";import{applyColorToSymbol as i,applySizesToSymbol as r,applyRotationToSymbol as s,getColorFromSymbol as o,applyOpacityToColor as n}from"./utils.js";let c=null;function u(e,t){return Math.floor(Math.random()*(t-e+1)+e)}function y(e,t,l){const{backgroundColor:a,outline:i,dotSize:r}=e,s=l&&l.swatchSize||22,o=.8,n=Math.round(s*s/r**2*o),y=window.devicePixelRatio,p=document.createElement("canvas"),h=s*y;p.width=h,p.height=h,p.style.width=p.width/y+"px",p.style.height=p.height/y+"px";const b=p.getContext("2d");if(a&&(b.fillStyle=a.toCss(!0),b.fillRect(0,0,h,h),b.fill()),b.fillStyle=t.toCss(!0),c&&c.length/2===n)for(let u=0;u<2*n;u+=2){const e=c[u],t=c[u+1];b.fillRect(e,t,r*y,r*y),b.fill()}else{c=[];for(let e=0;e<2*n;e+=2){const e=u(0,h),t=u(0,h);c.push(e,t),b.fillRect(e,t,r*y,r*y),b.fill()}}i&&(i.color&&(b.strokeStyle=i.color.toCss(!0)),b.lineWidth=i.width,b.strokeRect(0,0,h,h));const f=new Image(s,s);return f.src=p.toDataURL(),f}function p(e,t={}){const l=24,a=75,i="horizontal"===t.align,r=i?a:l,s=i?l:a,{width:o=r,height:n=s,gradient:c=!0}=t,u=window.devicePixelRatio,y=o*u,p=n*u,h=document.createElement("canvas");h.width=y,h.height=p,h.style.width=`${o}px`,h.style.height=`${n}px`;const b=h.getContext("2d"),f=i?y:0,m=i?0:p;if(c){const t=b.createLinearGradient(0,0,f,m),l=1/(e.length-1);e.forEach(((e,a)=>t.addColorStop(a*l,e.toString()))),b.fillStyle=t,b.fillRect(0,0,y,p)}else{const t=i?y/e.length:y,l=i?p:p/e.length;let a=0,r=0;for(const s of e)b.fillStyle=s.toString(),b.fillRect(a,r,t,l),a=i?a+t:0,r=i?0:r+l}const d=document.createElement("div");return d.style.width=`${o}px`,d.style.height=`${n}px`,d.appendChild(h),d}async function h(e,t){switch(e.type){case"web-style":{const{previewWebStyleSymbol:l}=await import("./previewWebStyleSymbol.js");return l(e,h,t)}case"label-3d":case"line-3d":case"mesh-3d":case"point-3d":case"polygon-3d":{const{previewSymbol3D:l}=await import("./previewSymbol3D.js");return l(e,t)}case"simple-marker":case"simple-line":case"simple-fill":case"picture-marker":case"picture-fill":case"text":{const{previewSymbol2D:l}=await import("./previewSymbol2D.js");return l(e,t)}case"cim":{const{previewCIMSymbol:l}=await import("./previewCIMSymbol.js");return l(e,t)}default:return}}function b(e){return e&&"opacity"in e?e.opacity*b(e.parent):1}async function f(o,n){if(!o)return;const c=b(o.layer||o.sourceLayer);if(e(o.symbol)&&(!e(n)||!0!==n.ignoreGraphicSymbol)){const t="web-style"===o.symbol.type?await o.symbol.fetchSymbol(e(n)?n.abortOptions:null):o.symbol.clone();return i(t,null,c),t}const u=e(n)&&n.renderer||o.get("layer.renderer")||o.get("sourceLayer.renderer");let y=await u.getSymbolAsync(o,n);if(!y)return;if(y="web-style"===y.type?await y.fetchSymbol(e(n)?n.abortOptions:null):y.clone(),!("visualVariables"in u)||"visualVariables"in u&&!u.visualVariables||"visualVariables"in u&&u.visualVariables&&!u.visualVariables.length)return y;if(u.arcadeRequiredForVisualVariables&&(t(n)||t(n.arcade))){const e={...l(n)};e.arcade=await a(),n=e}const p=await import("../../renderers/visualVariables/support/visualVariableUtils.js"),h=[],f=[],m=[],d=[];for(const e of u.visualVariables)switch(e.type){case"color":h.push(e);break;case"opacity":f.push(e);break;case"rotation":d.push(e);break;case"size":e.target||m.push(e)}const g=!!h.length&&h[h.length-1],w=g?p.getColor(g,o,n):null,v=!!f.length&&f[f.length-1];let S=v?p.getOpacity(v,o,n):null;if(null!=c&&(S=null!=S?S*c:c),i(y,w,S),m.length){const e=p.getAllSizes(m,o,n);await r(y,e)}for(const e of d)s(y,p.getRotationAngle(e,o,n),e.axis);return y}async function m(i,r){var s;if(!i)return;const c=b(i.layer||i.sourceLayer);if(e(i.symbol)&&(!e(r)||!0!==r.ignoreGraphicSymbol)){const t="web-style"===i.symbol.type?await i.symbol.fetchSymbol(e(r)?r.abortOptions:null):i.symbol.clone();return o(t,c)}const u=e(r)&&r.renderer||i.get("layer.renderer")||i.get("sourceLayer.renderer");let y=await u.getSymbolAsync(i,r);if(!y)return;y="web-style"===y.type?await y.fetchSymbol(e(r)?r.abortOptions:null):y.clone();const p=o(y,c);if(!("visualVariables"in u)||"visualVariables"in u&&!u.visualVariables||"visualVariables"in u&&(null==(s=u.visualVariables)||!s.length))return p;if(u.arcadeRequiredForVisualVariables&&(t(r)||t(r.arcade))){const e={...l(r)};e.arcade=await a(),r=e}const h=await import("../../renderers/visualVariables/support/visualVariableUtils.js"),f=[],m=[];for(const e of u.visualVariables)switch(e.type){case"color":f.push(e);break;case"opacity":m.push(e)}const d=f.length>0?f[f.length-1]:null,g=d?h.getColor(d,i,r):p,w=m.length>0?m[m.length-1]:null;let v=w?h.getOpacity(w,i,r):null;return null!=c&&(v=null!=v?v*c:c),g?n(g,v):null}export{m as getDisplayedColor,f as getDisplayedSymbol,p as renderColorRampPreviewHTML,y as renderDotDensityPreviewHTML,h as renderPreviewHTML};
