/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import e from"../../core/Error.js";import{normalize as t,removeFile as r,urlToObject as o}from"../../core/urlUtils.js";import{f as s}from"../../chunks/persistableUrlUtils.js";import n from"../../request.js";import l from"../../portal/PortalQueryParams.js";import a from"../../portal/Portal.js";import i from"./StyleOrigin.js";import m from"./Thumbnail.js";import{isSymbol3D as u}from"../../symbols.js";import{fromJSON as y}from"./jsonUtils.js";import{isDevEnvironment as f,adjustStaticAGOUrl as c}from"../../core/devEnvironmentUtils.js";import{enableWebStyleForceWOSR as p}from"../../support/featureFlags.js";const b={};function d(e,t){return P(e,t).then((t=>({data:t.data,baseUrl:r(e),styleUrl:e})))}function h(e,t,r){const o=t.portal||a.getDefault();let s;const n=`${o.url} - ${o.user&&o.user.username} - ${e}`;return b[n]||(b[n]=j(e,o,r).then((e=>(s=e,e.fetchData()))).then((t=>({data:t,baseUrl:s.itemUrl,styleName:e})))),b[n]}function j(t,r,o){return r.load(o).then((()=>{const e=new l({disableExtraQuery:!0,query:`owner:${D} AND type:${R} AND typekeywords:"${t}"`});return r.queryItems(e,o)})).then((({results:r})=>{let s=null;const n=t.toLowerCase();if(r&&Array.isArray(r))for(const e of r){if(e.typeKeywords.some((e=>e.toLowerCase()===n))&&e.type===R&&e.owner===D){s=e;break}}if(!s)throw new e("symbolstyleutils:style-not-found",`The style '${t}' could not be found`,{styleName:t});return s.load(o)}))}function g(t,r,o){return t.styleUrl?d(t.styleUrl,o):t.styleName?h(t.styleName,r,o):Promise.reject(new e("symbolstyleutils:style-url-and-name-missing","Either styleUrl or styleName is required to resolve a style"))}function w(t,r,o,s){return t.name?t.styleName&&"Esri2DPointSymbolsStyle"===t.styleName?E(t,r,s):g(t,r,s).then((e=>U(e,t.name,r,o,s))):Promise.reject(new e("symbolstyleutils:style-symbol-reference-name-missing","Missing name in style symbol reference"))}function U(t,n,l,a,p){const b=t.data,d={portal:l.portal,url:o(t.baseUrl),origin:"portal-item"},h=b.items.find((e=>e.name===n));if(!h){const t=`The symbol name '${n}' could not be found`;return Promise.reject(new e("symbolstyleutils:symbol-name-not-found",t,{symbolName:n}))}let j=s(S(h,a),d),g=h.thumbnail&&h.thumbnail.href;const w=h.thumbnail&&h.thumbnail.imageData;f()&&(j=c(j),g=c(g));const U={portal:l.portal,url:o(r(j)),origin:"portal-item"};return P(j,p).then((e=>{const r="cimRef"===a?N(e.data):e.data,o=y(r,U);if(o&&u(o)){if(g){const e=s(g,d);o.thumbnail=new m({url:e})}else w&&(o.thumbnail=new m({url:`data:image/png;base64,${w}`}));t.styleUrl?o.styleOrigin=new i({portal:l.portal,styleUrl:t.styleUrl,name:n}):t.styleName&&(o.styleOrigin=new i({portal:l.portal,styleName:t.styleName,name:n}))}return o}))}function N(e){return null===e||"CIMSymbolReference"===e.type?e:{type:"CIMSymbolReference",symbol:e}}function S(e,t){if("cimRef"===t)return e.cimRef;if(e.formatInfos&&!p())for(const r of e.formatInfos)if("gltf"===r.type)return r.href;return e.webRef}function $(e){for(const t of e.typeKeywords)if(/^Esri.*Style$/.test(t)&&"Esri Style"!==t)return t}function E(e,t,s){const n=q.replace(/\{SymbolName\}/gi,e.name);return P(n,s).then((e=>{const s=N(e.data);return y(s,{portal:t.portal,url:o(r(n)),origin:"portal-item"})}))}function P(e,r){const o={responseType:"json",query:{f:"json"},...r};return n(t(e),o)}const D="esri_en",R="Style",q="https://cdn.arcgis.com/sharing/rest/content/items/220936cc6ed342c9937abd8f180e7d1e/resources/styles/cim/{SymbolName}.json?f=json";export{g as fetchStyle,U as fetchSymbolFromStyle,w as resolveWebStyleSymbol,$ as styleNameFromItem};
