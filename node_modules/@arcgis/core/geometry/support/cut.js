/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{getInfo as s}from"./spatialReferenceUtils.js";import{getBoundsXY as t,getPointsBoundsCenterX as e,getPointsBounds as n,getPointsBoundsWidth as o}from"./boundsUtils.js";import{isPolygon as f,isPolyline as r}from"./jsonUtils.js";import{create as i}from"./aaBoundingRect.js";function l(t){if(!t)return null;if(!t.spatialReference)return t;const e=s(t.spatialReference);if(!e)return t;const n=e.valid[1];return f(t)?u(t,n):r(t)?h(t,n):t}function h(s,n){let o={paths:[],spatialReference:s.spatialReference};const[f,,r]=t(i(),s);let l=Math.ceil((f-n)/(2*n))*(2*n)+n;if(l>r)o=s;else{let t,e;for(;l<r;){const f=c(s,l);if(t=f[0],e=f[1],t)for(const s of t.paths)o.paths.push(s);if(null==e)break;s=e,l+=2*n}if(e)for(const s of e.paths)o.paths.push(s)}for(const t of o.paths){const s=j(e(t),n);for(const e of t)e[0]-=2*s*n}return o}function u(s,n){let o={rings:[],spatialReference:s.spatialReference};const[f,,r]=t(i(),s);let l=Math.ceil((f-n)/(2*n))*(2*n)+n;if(l>r)o=s;else{let t,e;for(;l<r;){if([t,e]=a(s,l),t)for(const s of t.rings)o.rings.push(s);if(null==e)break;s=e,l+=2*n}if(e)for(const s of e.rings)o.rings.push(s)}for(const t of o.rings){const s=j(e(t),n);for(const e of t)e[0]-=2*s*n}return o}const p=i();function c(s,e){const[o,,f]=t(p,s);let r,i;if(f<=e)r=s;else if(o>=e)i=s;else{r={paths:[]},i={paths:[]};const t=r.paths,o=i.paths;for(const f of s.paths){const[s,,r]=n(p,f);if(r<=e)t.push(f);else if(s>=e)o.push(f);else{let s=f[0],n=m(s,e),r=[];r.push(s);for(let i=1;i<f.length;i++){const l=f[i],h=m(l,e);if(h===n)r.push(l);else{const f=R(s,l,e);r.push(f),n?t.push(r):o.push(r),r=[f,l],n=h}s=l}n?t.push(r):o.push(r)}}}return[r,i]}function a(s,e){let o,f;const[r,,l]=t(i(),s);if(l<=e)o=s;else if(r>=e)f=s;else{const t=[],r=[],l=[];for(const o of s.rings){const[s,,f]=n(i(),o);if(f<=e)t.push(o);else if(s>=e)r.push(o);else{let s=o[o.length-1],n=m(s,e),f=[];for(const i of o){const o=m(i,e);if(o===n)f.push(i);else{const h=R(s,i,e);f.push(h),n?t.push(f):r.push(f),l.push(h[1]),f=[],f.push([h[0],h[1]]),f.push(i),n=o}s=i}n?t.push(f):r.push(f)}}l.sort();for(let s=0;s<l.length-1;s+=2){const n=[];n.push([e,l[s]]),n.push([e,l[s+1]]),t.length>0&&t.push(n),r.length>0&&r.push(n)}t.length>0&&(o=g(t)),r.length>0&&(f=g(r))}return[o,f]}function g(s){let t;const e={rings:[]};for(;s.length>0;){const n=s[0];let f=!1;const[r,i]=n[0],[l,h]=n[n.length-1];if(r!==l||i!==h)for(let u=1;u<s.length;u++){const p=s[u],[c,a]=p[0],[g,m]=p[p.length-1];if(h===a&&l===c){for(t=1;t<p.length;t++)n.push([p[t][0],p[t][1]]);f=!0}else if(h===m&&l===g){for(t=p.length-2;t>=0;t--)n.push([p[t][0],p[t][1]]);f=!0}else if(i===m&&r===g){for(t=0;t<p.length-1;t++)n.splice(t,0,[p[t][0],p[t][1]]);f=!0}else if(i===a&&r===c){for(t=1;t<p.length;t++)n.unshift([p[t][0],p[t][1]]);f=!0}if(f){s.splice(u,1),b(n[0],n[n.length-1])&&(s.shift(),o(n)>0&&e.rings.push(n));break}}f||(s.shift(),n.length,e.rings.push(n))}return e}function m([s],t){return s<t}function R([s,t],[e,n],o){return[o,t+(n-t)/(e-s)*(o-s)]}function j(s,t){let e=(s+t)/(2*t);return e%2==1&&e--,Math.floor(e)}function b([s,t],[e,n]){return s===e&&t===n}export{l as normalize};
