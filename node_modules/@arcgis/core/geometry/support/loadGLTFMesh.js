/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{unwrap as t,applySome as e}from"../../core/maybe.js";import{f as r}from"../../chunks/vec3f64.js";import{a as o}from"../../chunks/mat3f64.js";import{b as s}from"../../chunks/vec4f64.js";import n from"./MeshTexture.js";import a from"./MeshMaterialMetallicRoughness.js";import{n as i}from"../../chunks/mat3.js";import{BufferViewVec3f64 as u,BufferViewVec3f as c,BufferViewVec4f as f,BufferViewVec2f as m,BufferViewVec4u8 as l,BufferViewVec4u16 as p,BufferViewVec3u8 as d,BufferViewVec3u16 as h}from"../../views/3d/support/buffer/BufferView.js";import{t as g,a as v,s as w,b as j}from"../../chunks/vec32.js";import{georeference as b}from"./meshUtils/georeference.js";import{COLOR_GAMMA as x}from"../../views/3d/webgl-engine/materials/DefaultMaterial.js";import{DefaultLoadingContext as M}from"../../views/3d/glTF/DefaultLoadingContext.js";import{n as k}from"../../chunks/vec22.js";import{c as T}from"../../chunks/vec33.js";import{c as y,f as B}from"../../chunks/vec43.js";import{createBuffer as C}from"../../views/3d/support/buffer/utils.js";import{load as F}from"../../views/3d/glTF/loader.js";import{triangleFanToTriangles as E,triangleStripToTriangles as R,trianglesToTriangles as S}from"../../views/3d/glTF/internal/indexUtils.js";import{t as A,s as D,a as N}from"../../chunks/vec42.js";async function U(t,e,r){const o=new M,s=(await F(o,e,r,!0)).model,n=s.lods.shift(),a=new Map,i=new Map;return s.textures.forEach(((t,e)=>a.set(e,L(t)))),s.materials.forEach(((t,e)=>i.set(e,O(t,a)))),n.parts.map((e=>q(t,i,e,r)))}function L(t){return new n({data:t.data,wrap:P(t.parameters.wrap)})}function O(r,o){const s=G(r.color,r.opacity),n=r.emissiveFactor?H(r.emissiveFactor):null,i={color:s,colorTexture:t(e(r.textureColor,(t=>o.get(t)))),normalTexture:t(e(r.textureNormal,(t=>o.get(t)))),emissiveColor:n,emissiveTexture:t(e(r.textureEmissive,(t=>o.get(t)))),occlusionTexture:t(e(r.textureOcclusion,(t=>o.get(t)))),alphaMode:K(r.alphaMode),alphaCutoff:r.alphaCutoff,doubleSided:r.doubleSided,metallic:r.metallicFactor,roughness:r.roughnessFactor,metallicRoughnessTexture:t(e(r.textureMetallicRoughness,(t=>o.get(t))))};return new a(i)}function q(r,s,n,a){const x=C(u,n.attributes.position.count);g(x,n.attributes.position,n.transform);const M=e(n.attributes.normal,(t=>{const e=C(c,t.count),r=i(o(),n.transform);return v(e,t,r),e.typedBuffer})),F=e(n.attributes.tangent,(t=>{const e=C(f,t.count),r=i(o(),n.transform);return A(e,t,r),e.typedBuffer})),E=e(n.attributes.texCoord0,(t=>{const e=C(m,t.count);return k(e,t),e.typedBuffer})),R=e(n.attributes.color,(t=>{const e=C(l,t.count);if(4===t.elementCount)t instanceof f?D(e,t,255):t instanceof l?y(e,t):t instanceof p&&N(e,t,8);else{B(e,255,255,255,255);const r=new d(e.buffer,0,4);t instanceof c?w(r,t,255):t instanceof d?T(r,t):t instanceof h&&j(r,t,8)}return e.typedBuffer})),S=b({position:x.typedBuffer,normal:t(M),tangent:t(F)},r,{...a,unit:"meters"}),U=z(n.indices||n.attributes.position.count,n.primitiveType);return{vertexAttributes:{position:S.position,normal:S.normal,tangent:S.tangent,uv:t(E),color:t(R)},components:[{faces:U,material:s.get(n.material),trustSourceNormals:!0}],spatialReference:r.spatialReference}}function z(t,e){switch(e){case 4:return S(t);case 5:return R(t);case 6:return E(t)}}function K(t){switch(t){case"OPAQUE":return"opaque";case"MASK":return"mask";case"BLEND":return"blend"}}function P(t){return{horizontal:Q(t.s),vertical:Q(t.t)}}function Q(t){switch(t){case 33071:return"clamp";case 33648:return"mirror";case 10497:return"repeat"}}function V(t){return t**(1/x)*255}function G(t,e){return s(V(t[0]),V(t[1]),V(t[2]),e)}function H(t){return r(V(t[0]),V(t[1]),V(t[2]))}export{U as loadGLTFMesh};
