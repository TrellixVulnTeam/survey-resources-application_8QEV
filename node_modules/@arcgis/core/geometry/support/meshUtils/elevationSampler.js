/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{isSome as e}from"../../../core/maybe.js";import{c as t}from"../../../chunks/vec3f64.js";import{open as r}from"../../../core/workers/workers.js";import{ElevationSamplerBase as o}from"../../../layers/support/ElevationSampler.js";import{i as n}from"../../../chunks/triangle.js";import{ray as s}from"../../../views/3d/support/geometryUtils.js";import{ElevationSamplerWorker as a}from"./ElevationSamplerWorker.js";async function i(e,t){const r=await m(),o=await p.createIndex(e,r);return c(r),new l(e,o,t)}class l extends o{constructor(t,r,o){super(),this.rindex=r,this.demResolution={min:0,max:0},this.spatialReference=t.spatialReference.clone(),this.extent=t.extent.clone(),this.noDataValue=e(o)&&o.noDataValue||0}elevationAt(e){const t=this.projectIfRequired(e,this.spatialReference);let r=Number.NEGATIVE_INFINITY;return s.fromValues([t.x,t.y,0],[0,0,-1],j),this.rindex.search({minX:t.x,maxX:t.x,minY:t.y,maxY:t.y},(e=>{n(e,j,N)&&N[2]>r&&(r=N[2])})),r===Number.NEGATIVE_INFINITY?this.noDataValue:r}}function m(){return++f,u(),h||(h=r("ElevationSamplerWorker").catch((()=>null)),h)}function c(t){--f,e(t)&&0===f&&(x=setTimeout((()=>{t.close(),h=null,x=0}),I))}function u(){x&&(clearTimeout(x),x=0)}const p=new a;let f=0,h=null,x=0;const I=1e4,j=s.fromValues([0,0,0],[0,0,-1]),N=t();export{i as create};
