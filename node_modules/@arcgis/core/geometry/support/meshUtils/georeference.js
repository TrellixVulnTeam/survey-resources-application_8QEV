/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{isNone as r}from"../../../core/maybe.js";import{getSphericalPCPF as n}from"../../projectionEllipsoid.js";import{getMetersPerUnit as t,getMetersPerVerticalUnitForSR as o,convertUnit as e}from"../../../core/unitUtils.js";import{a,s as i}from"../../../chunks/mat4.js";import{computeLinearTransformation as l}from"../../projection.js";import{a as s}from"../../../chunks/mat3f64.js";import{a as f}from"../../../chunks/mat4f64.js";import{n as c}from"../../../chunks/mat3.js";import{BufferViewVec3f64 as u,BufferViewVec3f as p}from"../../../views/3d/support/buffer/BufferView.js";import{projectFromECEF as m,projectNormalFromECEF as y,projectTangentFromECEF as h,projectToECEF as g,projectNormalToECEF as A,projectTangentToECEF as E}from"./projection.js";import{t as T,a as j}from"../../../chunks/vec32.js";function F(r,n,t){return b(n,t)?R(r,n,t):w(r,n,t)}function d(r,n,t){return b(n,t)?k(r,n,t):_(r,n,t)}function w(r,n,t){const o=new Float64Array(r.position.length),e=r.position,a=n.x,i=n.y,l=n.z||0,{horizontal:s,vertical:f}=G(t?t.unit:null,n.spatialReference);for(let c=0;c<e.length;c+=3)o[c+0]=e[c+0]*s+a,o[c+1]=e[c+1]*s+i,o[c+2]=e[c+2]*f+l;return{position:o,normal:r.normal,tangent:r.tangent}}function R(r,n,t){const o=n.spatialReference,e=x(n,t,L),a=new Float64Array(r.position.length),i=z(r.position,e,o,a),l=c(P,e);return{position:i,normal:v(i,a,r.normal,l,o),tangent:S(i,a,r.tangent,l,o)}}function z(r,n,t,o){T(u.fromTypedArray(o),u.fromTypedArray(r),n);const e=new Float64Array(r.length);return m(o,e,t)}function v(r,n,t,o,e){if(!t)return null;const a=new Float32Array(t.length);return j(p.fromTypedArray(a),p.fromTypedArray(t),o),y(a,r,n,e,a),a}function S(r,n,t,o,e){if(!t)return null;const a=new Float32Array(t.length);j(p.fromTypedArray(a,4*Float32Array.BYTES_PER_ELEMENT),p.fromTypedArray(t,4*Float32Array.BYTES_PER_ELEMENT),o);for(let i=3;i<a.length;i+=4)a[i]=t[i];return h(a,r,n,e,a),a}function _(r,n,t){const o=new Float64Array(r.position.length),e=r.position,a=n.x,i=n.y,l=n.z||0,{horizontal:s,vertical:f}=G(t?t.unit:null,n.spatialReference);for(let c=0;c<e.length;c+=3)o[c+0]=(e[c+0]-a)/s,o[c+1]=(e[c+1]-i)/s,o[c+2]=(e[c+2]-l)/f;return{position:o,normal:r.normal,tangent:r.tangent}}function k(r,n,t){const o=n.spatialReference;x(n,t,L);const e=a(N,L),i=new Float64Array(r.position.length),l=B(r.position,o,e,i),s=c(P,e);return{position:l,normal:M(r.normal,r.position,i,o,s),tangent:W(r.tangent,r.position,i,o,s)}}function x(r,t,o){l(r.spatialReference,[r.x,r.y,r.z||0],o,n(r.spatialReference));const{horizontal:e,vertical:a}=G(t?t.unit:null,r.spatialReference);return i(o,o,[e,e,a]),o}function B(r,n,t,o){const e=g(r,n,o),a=u.fromTypedArray(e),i=new Float64Array(e.length),l=u.fromTypedArray(i);return T(l,a,t),i}function M(r,n,t,o,e){if(!r)return null;const a=A(r,n,t,o,new Float32Array(r.length)),i=p.fromTypedArray(a);return j(i,i,e),a}function W(r,n,t,o,e){if(!r)return null;const a=E(r,n,t,o,new Float32Array(r.length)),i=p.fromTypedArray(a,4*Float32Array.BYTES_PER_ELEMENT);return j(i,i,e),a}function b(r,n){const t=r.spatialReference;return t.isWGS84||t.isWebMercator&&(!n||!1!==n.geographic)}function G(n,a){if(r(n))return Y;const i=a.isWGS84?1:t(a),l=a.isWGS84?1:o(a),s=e(1,n,"meters");return{horizontal:s*i,vertical:s*l}}const L=f(),N=f(),P=s(),Y={horizontal:1,vertical:1};export{F as georeference,d as ungeoreference};
