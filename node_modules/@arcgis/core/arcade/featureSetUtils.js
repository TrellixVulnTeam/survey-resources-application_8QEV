/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{resolve as e,reject as t,create as r}from"../core/promiseUtils.js";import{id as n}from"../kernel.js";import a from"../request.js";import s from"../portal/Portal.js";import i from"../portal/PortalItem.js";import{extractServiceUrl as l}from"./featureset/support/shared.js";import o from"./featureSetCollection.js";import u from"./featureset/support/cache.js";import{WhereClause as c}from"../core/sql/WhereClause.js";import d from"./featureset/actions/AttributeFilter.js";import m from"./featureset/actions/OrderBy.js";import h from"./featureset/actions/GroupBy.js";import f from"./featureset/actions/SpatialFilter.js";import p from"./featureset/actions/Top.js";import y from"../layers/FeatureLayer.js";import L from"./featureset/sources/FeatureLayerDynamic.js";import I from"./featureset/sources/FeatureLayerMemory.js";import _ from"./featureset/sources/FeatureLayerRelated.js";function S(){null===u.applicationCache&&(u.applicationCache=new u)}function N(t,n){if(u.applicationCache){const a=u.applicationCache.getLayerInfo(t);if(a)return a.then((r=>e(new y({url:t,outFields:n,sourceJSON:r}))));const s=new y({url:t,outFields:n});let i=r(((e,t)=>{s.load().then((()=>{e(s.sourceJSON)}),(e=>{t(e)}))}));return u.applicationCache&&(u.applicationCache.setLayerInfo(t,i),i=i.catch((e=>{throw u.applicationCache.clearLayerInfo(t),e}))),i.then((()=>e(s)))}return e(new y({url:t,outFields:n}))}function T(t,r,n,a,s,i=null){return N(t,["*"]).then((t=>e(A(t,r,n,a,s,i))))}function A(e,t=null,r=null,n=!0,a=null,s=null){return!0===e._hasMemorySource()?new I({layer:e,spatialReference:t,outFields:r,includeGeometry:n,lrucache:a,interceptor:s}):new L({layer:e,spatialReference:t,outFields:r,includeGeometry:n,lrucache:a,interceptor:s})}function C(t){if(null!==u.applicationCache){const e=u.applicationCache.getLayerInfo(t);if(null!==e)return e}let r=a(t,{responseType:"json",query:{f:"json"}}).then((t=>{if(t.data){const r=t.data;return e(r)}return e(null)}));return null!==u.applicationCache&&(u.applicationCache.setLayerInfo(t,r),r=r.catch((e=>{throw u.applicationCache.clearLayerInfo(t),e}))),r}function F(e,t){const r="QUERYDATAELEMTS:"+t.toString()+":"+e;if(null!==u.applicationCache){const e=u.applicationCache.getLayerInfo(r);if(null!==e)return e}let n=a(e+"/queryDataElements",{method:"post",responseType:"json",query:{layers:JSON.stringify([t.toString()]),f:"json"}}).then((e=>{if(e.data){const t=e.data;if(t.layerDataElements&&t.layerDataElements[0])return t.layerDataElements[0]}throw new Error("Not Found")}));return null!==u.applicationCache&&(u.applicationCache.setLayerInfo(r,n),n=n.catch((e=>{throw u.applicationCache.clearLayerInfo(r),e}))),n}function g(t){if(null!==u.applicationCache){const e=u.applicationCache.getLayerInfo(t);if(null!==e)return e}let r=a(t,{responseType:"json",query:{f:"json"}}).then((t=>{if(t.data){const r=t.data;return r.layers||(r.layers=[]),r.tables||(r.tables=[]),e(r)}return e({layers:[],tables:[]})}));return null!==u.applicationCache&&(u.applicationCache.setLayerInfo(t,r),r=r.catch((e=>{throw u.applicationCache.clearLayerInfo(t),e}))),r}function k(e,t){const r={metadata:null,networkId:-1,unVersion:3,terminals:[],queryelem:null,layerNameLkp:{},lkp:null};return g(e).then((n=>{if(r.metadata=n,n.controllerDatasetLayers&&void 0!==n.controllerDatasetLayers.utilityNetworkLayerId&&null!==n.controllerDatasetLayers.utilityNetworkLayerId){if(n.layers)for(const e of n.layers)r.layerNameLkp[e.id]=e.name;if(n.tables)for(const e of n.tables)r.layerNameLkp[e.id]=e.name;const a=n.controllerDatasetLayers.utilityNetworkLayerId;return r.networkId=a,F(e,a).then((n=>{if(n){r.queryelem=n,r.queryelem&&r.queryelem.dataElement&&void 0!==r.queryelem.dataElement.schemaGeneration&&(r.unVersion=r.queryelem.dataElement.schemaGeneration),r.lkp={},r.queryelem.dataElement.domainNetworks||(r.queryelem.dataElement.domainNetworks=[]);for(const e of r.queryelem.dataElement.domainNetworks){for(const t of e.edgeSources?e.edgeSources:[]){const e={layerId:t.layerId,sourceId:t.sourceId,className:r.layerNameLkp[t.layerId]?r.layerNameLkp[t.layerId]:null};e.className&&(r.lkp[e.className]=e)}for(const t of e.junctionSources?e.junctionSources:[]){const e={layerId:t.layerId,sourceId:t.sourceId,className:r.layerNameLkp[t.layerId]?r.layerNameLkp[t.layerId]:null};e.className&&(r.lkp[e.className]=e)}}if(r.queryelem.dataElement.terminalConfigurations)for(const e of r.queryelem.dataElement.terminalConfigurations)for(const t of e.terminals)r.terminals.push({terminalId:t.terminalId,terminalName:t.terminalName});return C(e+"/"+a).then((n=>{if(n.systemLayers&&void 0!==n.systemLayers.associationsTableId&&null!==n.systemLayers.associationsTableId){const a=[];return r.unVersion>=4&&(a.push("STATUS"),a.push("PERCENTALONG")),T(e+"/"+n.systemLayers.associationsTableId.toString(),t,["OBJECTID","FROMNETWORKSOURCEID","TONETWORKSOURCEID","FROMGLOBALID","TOGLOBALID","TOTERMINALID","FROMTERMINALID","ASSOCIATIONTYPE","ISCONTENTVISIBLE","GLOBALID",...a],!1,null,null).then((e=>e.load())).then((e=>r.unVersion>=4?(e=e.filter(c.create("STATUS NOT IN (1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 23, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 41, 42, 43, 44, 45, 46, 47, 49, 50, 51, 52, 53, 54, 55, 57, 58, 59, 60, 61, 62,63)",e.getFieldsIndex()))).load():e)).then((e=>({lkp:r.lkp,associations:e,unVersion:r.unVersion,terminals:r.terminals})))}return{associations:null,unVersion:r.unVersion,lkp:null,terminals:[]}}))}return{associations:null,unVersion:r.unVersion,lkp:null,terminals:[]}}))}return{associations:null,unVersion:r.unVersion,lkp:null,terminals:[]}}))}function j(e,t,r,n=null,a=null,s=!0,i=null,l=null){let o=e.serviceUrl();return o?(o="/"===o.charAt(o.length-1)?o+t.relatedTableId.toString():o+"/"+t.relatedTableId.toString(),T(o,n,a,s,i,l).then((o=>new _({layer:e,relatedLayer:o,relationship:t,objectId:r,spatialReference:n,outFields:a,includeGeometry:s,lrucache:i,interceptor:l})))):null}d.registerAction(),h.registerAction(),m.registerAction(),f.registerAction(),p.registerAction();class O extends o{constructor(e,t=null,r=null,n=null){super(),this._map=e,this._overridespref=t,this.lrucache=r,this.interceptor=n,this._instantLayers=[]}makeAndAddFeatureSet(e,t=!0,r=null){const n=A(e,this._overridespref,null===r?["*"]:r,t,this.lrucache,this.interceptor);return this._instantLayers.push({featureset:n,opitem:e,includeGeometry:t,outFields:JSON.stringify(r)}),n}featureSetByName(e,r=!0,n=null){if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then((()=>{try{return this.featureSetByName(e,r,n)}catch(a){return t(a)}}));null===n&&(n=["*"]),n=(n=n.slice(0)).sort();const a=JSON.stringify(n);for(let t=0;t<this._instantLayers.length;t++){const n=this._instantLayers[t];if(n.opitem.title===e&&n.includeGeometry===r&&n.outFields===a)return this.resolvePromise(this._instantLayers[t].featureset)}const s=this._map.layers.find((t=>t instanceof y&&t.title===e));if(s)return this.resolvePromise(this.makeAndAddFeatureSet(s,r,n));if(this._map.tables){const t=this._map.tables.find((t=>!!(t.title&&t.title===e||t.title&&t.title===e)));if(t){if(t instanceof y)return this.resolvePromise(this.makeAndAddFeatureSet(t,r,n));if(t._materializedTable);else{const e=t.outFields?t:{...t,outFields:["*"]};t._materializedTable=new y(e)}return t._materializedTable.load().then((()=>this.resolvePromise(this.makeAndAddFeatureSet(t._materializedTable,r,n))))}}return this.resolvePromise(null)}featureSetById(e,r=!0,n=["*"]){if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then((()=>{try{return this.featureSetById(e,r,n)}catch(a){return t(a)}}));null===n&&(n=["*"]),n=(n=n.slice(0)).sort();const a=JSON.stringify(n);for(let t=0;t<this._instantLayers.length;t++){const n=this._instantLayers[t];if(n.opitem.id===e&&n.includeGeometry===r&&n.outFields===a)return this.resolvePromise(this._instantLayers[t].featureset)}const s=this._map.layers.find((t=>t instanceof y&&t.id===e));if(s)return this.resolvePromise(this.makeAndAddFeatureSet(s,r,n));if(this._map.tables){const t=this._map.tables.find((t=>t.id===e));if(t){if(t instanceof y)return this.resolvePromise(this.makeAndAddFeatureSet(t,r,n));if(t._materializedTable);else{const e={...t,outFields:["*"]};t._materializedTable=new y(e)}return t._materializedTable.load().then((()=>this.resolvePromise(this.makeAndAddFeatureSet(t._materializedTable,r,n))))}}return this.resolvePromise(null)}}class w extends o{constructor(e,t=null,r=null,n=null){super(),this._url=e,this._overridespref=t,this.lrucache=r,this.interceptor=n,this.metadata=null,this._instantLayers=[]}get url(){return this._url}makeAndAddFeatureSet(e,t=!0,r=null){const n=A(e,this._overridespref,null===r?["*"]:r,t,this.lrucache);return this._instantLayers.push({featureset:n,opitem:e,includeGeometry:t,outFields:JSON.stringify(r)}),n}_loadMetaData(){return g(this._url).then((e=>(this.metadata=e,e)))}load(){return this._loadMetaData()}clone(){return new w(this._url,this._overridespref,this.lrucache,this.interceptor)}featureSetByName(e,t=!0,r=null){null===r&&(r=["*"]),r=(r=r.slice(0)).sort();const n=JSON.stringify(r);for(let a=0;a<this._instantLayers.length;a++){const r=this._instantLayers[a];if(r.opitem.title===e&&r.includeGeometry===t&&r.outFields===n)return this.resolvePromise(this._instantLayers[a].featureset)}return this._loadMetaData().then((n=>{let a=null;for(const t of n.layers?n.layers:[])t.name===e&&(a=t);if(!a)for(const t of n.tables?n.tables:[])t.name===e&&(a=t);return a?N(this._url+"/"+a.id,["*"]).then((e=>this.makeAndAddFeatureSet(e,t,r))):this.resolvePromise(null)}))}featureSetById(e,t=!0,r=["*"]){null===r&&(r=["*"]),r=(r=r.slice(0)).sort();const n=JSON.stringify(r);e=null!=e?e.toString():"";for(let a=0;a<this._instantLayers.length;a++){const r=this._instantLayers[a];if(r.opitem.id===e&&r.includeGeometry===t&&r.outFields===n)return this.resolvePromise(this._instantLayers[a].featureset)}return this._loadMetaData().then((n=>{let a=null;for(const t of n.layers?n.layers:[])null!==t.id&&void 0!==t.id&&t.id.toString()===e&&(a=t);if(!a)for(const t of n.tables?n.tables:[])null!==t.id&&void 0!==t.id&&t.id.toString()===e&&(a=t);return a?N(this._url+"/"+a.id,["*"]).then((e=>this.makeAndAddFeatureSet(e,t,r))):this.resolvePromise(null)}))}}function v(e,t,r=null,n=null){return new O(e,t,r,n)}function E(e,t,r=null,n=null){return new w(e,t,r,n)}function b(e,t){if(null===e)return t;return new s({url:e.field("url")})}function D(t,r,s){return n.findCredential(t.restUrl)?"loaded"===t.loadStatus&&""===r&&t.user&&t.user.sourceJSON&&!1===s?e(t.user.sourceJSON):""===r?a(t.restUrl+"/community/self",{responseType:"json",query:{f:"json",...!1===s?{}:{returnUserLicenseTypeExtensions:!0}}}).then((t=>{if(t.data){const r=t.data;if(r&&r.username)return e(r)}return e(null)})):a(t.restUrl+"/community/users/"+r,{responseType:"json",query:{f:"json"}}).then((t=>{if(t.data){const r=t.data;return r.error?null:e(r)}return e(null)})):e(null)}function q(n,a,s,o,c,d,m,h=null){if(u.applicationCache){const r=u.applicationCache.getLayerInfo(n+":"+d.url);if(r)return r.then((r=>{try{const t=new y({url:l(r.url)+"/"+a,outFields:["*"]});return e(A(t,s,o,c,m,h))}catch(n){return t(n)}}),(e=>t(e)))}return r(((e,t)=>{const r=new i({id:n,portal:d}).load();u.applicationCache&&u.applicationCache.setLayerInfo(n+":"+d.url,r),r.then((r=>{try{const t=new y({url:l(r.url)+"/"+a,outFields:["*"]});e(A(t,s,o,c,m,h))}catch(n){t(n)}}),(e=>{u.applicationCache&&u.applicationCache.clearLayerInfo(n+":"+d.url),t(e)}))}))}export{k as constructAssociationMetaDataFeatureSetFromUrl,A as constructFeatureSet,q as constructFeatureSetFromPortalItem,j as constructFeatureSetFromRelationship,T as constructFeatureSetFromUrl,v as createFeatureSetCollectionFromMap,E as createFeatureSetCollectionFromService,b as getPortal,S as initialiseMetaDataCache,D as lookupUser};
