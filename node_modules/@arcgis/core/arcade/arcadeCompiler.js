/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{create as e,isPromiseLike as t,reject as n,resolve as r,all as o}from"../core/promiseUtils.js";import a from"../geometry/SpatialReference.js";import l from"../geometry/Geometry.js";import s from"../geometry/Point.js";import i from"../geometry/Extent.js";import c from"../geometry/Multipoint.js";import u from"../geometry/Polygon.js";import p from"../geometry/Polyline.js";import f from"./ImmutablePointArray.js";import m from"./ImmutablePathArray.js";import{p as h,i as g,n as y,N as d,v as S,h as w,c as E,o as b,q as N,e as v,r as M,b as I,s as O,u as x,a as T,S as R,w as _,R as C,I as U,x as A,y as F,f as P,z as k,A as j}from"../chunks/languageUtils.js";import D from"./Dictionary.js";import L from"./ArcadePortal.js";import B from"./Attachment.js";import Y from"./Feature.js";import{addFunctionDeclaration as V,findFieldLiterals as G,validateScript as z,referencesMember as q,referencesFunction as J,nodeErrorMessage as Z}from"./treeAnalysis.js";import{registerFunctions as H}from"./functions/array.js";import{registerFunctions as W}from"./functions/date.js";import{registerFunctions as K}from"./functions/geometry.js";import{registerFunctions as X}from"./functions/geomsync.js";import{registerFunctions as Q}from"./functions/maths.js";import{registerFunctions as $}from"./functions/stats.js";import{registerFunctions as ee}from"./functions/string.js";import{FeatureSetReader as te}from"../views/2d/layers/features/support/FeatureSetReader.js";function ne(e,t){const n=[];for(let r=0;r<t.arguments.length;r++)n.push(ae(e,t.arguments[r]));return n}function re(e,t,n){try{return n(e,null,t)}catch(r){throw r}}function oe(e){return e instanceof Error?n(e):n(new Error(e))}function ae(e,t){try{switch(t.type){case"EmptyStatement":return"lc.voidOperation";case"VariableDeclarator":return we(e,t);case"VariableDeclaration":return Se(e,t);case"BlockStatement":return ge(e,t);case"FunctionDeclaration":return de(e,t);case"ReturnStatement":return ye(e,t);case"IfStatement":return he(e,t);case"ExpressionStatement":return fe(e,t);case"AssignmentExpression":return pe(e,t);case"UpdateExpression":return ue(e,t);case"BreakStatement":return"break";case"ContinueStatement":return"continue";case"TemplateLiteral":return Ie(e,t);case"TemplateElement":return JSON.stringify(t.value?t.value.cooked:"");case"ForStatement":return ce(e,t);case"ForInStatement":return ie(e,t);case"Identifier":return Te(e,t);case"MemberExpression":return Ne(e,t);case"Literal":return null===t.value||void 0===t.value?"null":JSON.stringify(t.value);case"ThisExpression":throw new Error(Z(t,"RUNTIME","NOTSUPPORTED"));case"CallExpression":return Re(e,t);case"UnaryExpression":return ve(e,t);case"BinaryExpression":return Oe(e,t);case"LogicalExpression":return xe(e,t);case"ConditionalExpression":throw new Error(Z(t,"RUNTIME","NOTSUPPORTED"));case"ArrayExpression":return Me(e,t);case"ObjectExpression":return le(e,t);case"Property":return se(e,t);case"Array":throw new Error(Z(t,"RUNTIME","NOTSUPPORTED"));default:throw new Error(Z(t,"RUNTIME","UNREOGNISED"))}}catch(n){throw n}}function le(e,t){let n="lang.dictionary([";for(let r=0;r<t.properties.length;r++){const o=t.properties[r];r>0&&(n+=","),n+="lang.strCheck("+("Identifier"===o.key.type?"'"+o.key.name+"'":ae(e,o.key))+",'ObjectExpression'),lang.aCheck("+ae(e,o.value)+", 'ObjectExpression')"}return n+="])",n}function se(e,t){throw new Error("Should not get here")}function ie(e,t){const n=Le(e),r=Le(e),o=Le(e);let a="var "+n+" = "+ae(e,t.right)+";\n";"VariableDeclaration"===t.left.type&&(a+=ae(e,t.left));let l="VariableDeclaration"===t.left.type?t.left.declarations[0].id.name:t.left.name;l=l.toLowerCase();let s="";return null!==e.localScope&&(void 0!==e.localScope[l]?s="lscope['"+l+"']":void 0!==e.localScope._SymbolsMap[l]&&(s="lscope['"+e.localScope._SymbolsMap[l]+"']")),""===s&&(void 0!==e.globalScope[l]?s="gscope['"+l+"']":void 0!==e.globalScope._SymbolsMap[l]&&(s="gscope['"+e.globalScope._SymbolsMap[l]+"']")),a+="if ("+n+"===null) {  lastStatement = lc.voidOperation; }\n ",a+="else if (lc.isArray("+n+") || lc.isString("+n+")) {",a+="var "+r+"="+n+".length; \n",a+="for(var "+o+"=0; "+o+"<"+r+"; "+o+"++) {\n",a+=s+"="+o+";\n",a+=ae(e,t.body),a+="\n}\n",a+=" lastStatement = lc.voidOperation; \n",a+=" \n}\n",a+="else if (lc.isImmutableArray("+n+")) {",a+="var "+r+"="+n+".length(); \n",a+="for(var "+o+"=0; "+o+"<"+r+"; "+o+"++) {\n",a+=s+"="+o+";\n",a+=ae(e,t.body),a+="\n}\n",a+=" lastStatement = lc.voidOperation; \n",a+=" \n}\n",a+="else if (( "+n+" instanceof lang.Dictionary) || ( "+n+" instanceof lang.Feature)) {",a+="var "+r+"="+n+".keys(); \n",a+="for(var "+o+"=0; "+o+"<"+r+".length; "+o+"++) {\n",a+=s+"="+r+"["+o+"];\n",a+=ae(e,t.body),a+="\n}\n",a+=" lastStatement = lc.voidOperation; \n",a+=" \n}\n",e.isAsync&&(a+="else if (lc.isFeatureSet("+n+")) {",a+="var "+r+"="+n+".iterator(runtimeCtx.abortSignal); \n",a+="for(var "+o+"=lang. graphicToFeature( yield "+r+".next(),"+n+"); "+o+"!=null; "+o+"=lang. graphicToFeature( yield "+r+".next(),"+n+")) {\n",a+=s+"="+o+";\n",a+=ae(e,t.body),a+="\n}\n",a+=" lastStatement = lc.voidOperation; \n",a+=" \n}\n"),a+="else { lastStatement = lc.voidOperation; } \n",a}function ce(e,t){let n="lastStatement = lc.voidOperation; \n";null!==t.init&&(n+=ae(e,t.init)+"; ");const r=Le(e),o=Le(e);return n+="var "+r+" = true; ",n+="\n do { ",null!==t.update&&(n+=" if ("+r+"===false) {\n "+ae(e,t.update)+"  \n}\n "+r+"=false; \n"),null!==t.test&&(n+="var "+o+" = "+ae(e,t.test)+"; ",n+="if ("+o+"===false) { break; } else if ("+o+"!==true) { lang.error({type: '"+t.type+"'},'RUNTIME','CANNOT_USE_NONBOOLEAN_IN_CONDITION');   }\n"),n+=ae(e,t.body),null!==t.update&&(n+="\n "+ae(e,t.update)),n+="\n"+r+" = true; \n} while(true);  lastStatement = lc.voidOperation; ",n}function ue(e,t){let n=null,r="";if("MemberExpression"===t.argument.type)return n=ae(e,t.argument.object),r=!0===t.argument.computed?ae(e,t.argument.property):"'"+t.argument.property.name+"'","lang.memberupdate("+n+","+r+",'"+t.operator+"',"+t.prefix+")";if(n=t.argument.name.toLowerCase(),null!==e.localScope){if(void 0!==e.localScope[n])return"lang.update(lscope, '"+n+"','"+t.operator+"',"+t.prefix+")";if(void 0!==e.localScope._SymbolsMap[n])return"lang.update(lscope, '"+e.localScope._SymbolsMap[n]+"','"+t.operator+"',"+t.prefix+")"}if(void 0!==e.globalScope[n])return"lang.update(gscope, '"+n+"','"+t.operator+"',"+t.prefix+")";if(void 0!==e.globalScope._SymbolsMap[n])return"lang.update(gscope, '"+e.globalScope._SymbolsMap[n]+"','"+t.operator+"',"+t.prefix+")";throw new Error("Variable not recognised")}function pe(e,t){const n=ae(e,t.right);let r=null,o="";if("MemberExpression"===t.left.type)return r=ae(e,t.left.object),o=!0===t.left.computed?ae(e,t.left.property):"'"+t.left.property.name+"'","lang.assignmember("+r+","+o+",'"+t.operator+"',"+n+")";if(r=t.left.name.toLowerCase(),null!==e.localScope){if(void 0!==e.localScope[r])return"lscope['"+r+"']=lang.assign("+n+",'"+t.operator+"', lscope['"+r+"'])";if(void 0!==e.localScope._SymbolsMap[r])return"lscope['"+e.localScope._SymbolsMap[r]+"']=lang.assign("+n+",'"+t.operator+"', lscope['"+e.localScope._SymbolsMap[r]+"'])"}if(void 0!==e.globalScope[r])return"gscope['"+r+"']=lang.assign("+n+",'"+t.operator+"', gscope['"+r+"'])";if(void 0!==e.globalScope._SymbolsMap[r])return"gscope['"+e.globalScope._SymbolsMap[r]+"']=lang.assign("+n+",'"+t.operator+"', gscope['"+e.globalScope._SymbolsMap[r]+"'])";throw new Error("Variable not recognised")}function fe(e,t){return"AssignmentExpression"===t.expression.type?"lastStatement = lc.voidOperation; "+ae(e,t.expression)+"; \n ":(t.expression.type,"lastStatement = "+ae(e,t.expression)+"; ")}function me(e,t){return"BlockStatement"===t.type?ae(e,t):"ReturnStatement"===t.type||"BreakStatement"===t.type||"ContinueStatement"===t.type?ae(e,t)+"; ":"UpdateExpression"===t.type?"lastStatement = "+ae(e,t)+"; ":"ExpressionStatement"===t.type?ae(e,t):"ObjectExpression"===t.type?"lastStatement = "+ae(e,t)+"; ":ae(e,t)+"; "}function he(e,t){if("AssignmentExpression"===t.test.type||"UpdateExpression"===t.test.type)throw new Error(Z(t.test,"RUNTIME","CANNOT_USE_ASSIGNMENT_IN_CONDITION"));const n=ae(e,t.test),r=Le(e);let o="var "+r+" = "+n+";\n if ("+r+" === true) {\n"+me(e,t.consequent)+"\n }\n";return null!==t.alternate?o+="else if ("+r+"===false)   { \n"+me(e,t.alternate)+"}\n":o+="else if ("+r+"===false) { \n lastStatement = lc.voidOperation;\n }\n",o+="else { lang.error({type: '"+t.type+"'},'RUNTIME','CANNOT_USE_NONBOOLEAN_IN_CONDITION'); \n}\n",o}function ge(e,t){let n="";for(let r=0;r<t.body.length;r++)"ReturnStatement"===t.body[r].type||"BreakStatement"===t.body[r].type||"ContinueStatement"===t.body[r].type?n+=ae(e,t.body[r])+"; \n":"UpdateExpression"===t.body[r].type||"ObjectExpression"===t.body[r].type?n+="lastStatement = "+ae(e,t.body[r])+"; \n":n+=ae(e,t.body[r])+" \n";return n}function ye(e,t){if(null===t.argument)return"return lc.voidOperation";return"return "+ae(e,t.argument)}function de(e,t){const n=t.id.name.toLowerCase(),r={isAsync:e.isAsync,spatialReference:e.spatialReference,console:e.console,lrucache:e.lrucache,interceptor:e.interceptor,services:e.services,symbols:e.symbols,mangleMap:e.mangleMap,localScope:{_SymbolsMap:{}},depthCounter:e.depthCounter+1,globalScope:e.globalScope};if(r.depthCounter>64)throw new Error("Exceeded maximum function depth");let o="new lc.SizzleFunction( lang.functionDepthchecker(function() { var lastStatement = lc.voidOperation; \n   var lscope = runtimeCtx.localStack[runtimeCtx.localStack.length-1];\n";for(let a=0;a<t.params.length;a++){const n=t.params[a].name.toLowerCase(),l=De(e);r.localScope._SymbolsMap[n]=l,r.mangleMap[n]=l,o+="lscope['"+l+"']=arguments["+a.toString()+"];\n"}if(!0===e.isAsync?(o+="return lang.__awaiter(this, void 0, void 0, function* () {\n",o+=ge(r,t.body)+"\n return lastStatement; ",o+="});  }",o+=", runtimeCtx))",o+="\n lastStatement = lc.voidOperation; \n"):(o+=ge(r,t.body)+"\n return lastStatement; }, runtimeCtx))",o+="\n lastStatement = lc.voidOperation; \n"),void 0!==e.globalScope[n])return"gscope['"+n+"']="+o;if(void 0!==e.globalScope._SymbolsMap[n])return"gscope['"+e.globalScope._SymbolsMap[n]+"']="+o;{const t=De(e);return e.globalScope._SymbolsMap[n]=t,e.mangleMap[n]=t,"gscope['"+t+"']="+o}}function Se(e,t){const n=[];for(let r=0;r<t.declarations.length;r++)n.push(ae(e,t.declarations[r]));return n.join("\n")+" \n lastStatement=  lc.voidOperation; \n"}function we(e,t){let n=null===t.init?null:ae(e,t.init);n===S&&(n=null);const r=t.id.name.toLowerCase();if(null!==e.localScope){if(void 0!==e.localScope[r])return"lscope['"+r+"']="+n+"; ";if(void 0!==e.localScope._SymbolsMap[r])return"lscope['"+e.localScope._SymbolsMap[r]+"']="+n+"; ";{const t=De(e);return e.localScope._SymbolsMap[r]=t,e.mangleMap[r]=t,"lscope['"+t+"']="+n+"; "}}if(void 0!==e.globalScope[r])return"gscope['"+r+"']="+n+"; ";if(void 0!==e.globalScope._SymbolsMap[r])return"gscope['"+e.globalScope._SymbolsMap[r]+"']="+n+"; ";{const t=De(e);return e.globalScope._SymbolsMap[r]=t,e.mangleMap[r]=t,"gscope['"+t+"']="+n+"; "}}let Ee=0;function be(e,t,n){let r;switch(t=t.toLowerCase()){case"hasz":{const t=e.hasZ;return void 0!==t&&t}case"hasm":{const t=e.hasM;return void 0!==t&&t}case"spatialreference":{let t=e.spatialReference._arcadeCacheId;if(void 0===t){let n=!0;Object.freeze&&Object.isFrozen(e.spatialReference)&&(n=!1),n&&(Ee++,e.spatialReference._arcadeCacheId=Ee,t=Ee)}const n=new D({wkt:e.spatialReference.wkt,wkid:e.spatialReference.wkid});return void 0!==t&&(n._arcadeCacheId="SPREF"+t.toString()),n}}switch(e.type){case"extent":switch(t){case"xmin":case"xmax":case"ymin":case"ymax":case"zmin":case"zmax":case"mmin":case"mmax":{const n=e[t];return void 0!==n?n:null}case"type":return"Extent"}break;case"polygon":switch(t){case"rings":r=e.cache._arcadeCacheId,void 0===r&&(Ee++,r=Ee,e.cache._arcadeCacheId=r);return new m(e.rings,e.spatialReference,!0===e.hasZ,!0===e.hasM,r);case"type":return"Polygon"}break;case"point":switch(t){case"x":case"y":case"z":case"m":return void 0!==e[t]?e[t]:null;case"type":return"Point"}break;case"polyline":switch(t){case"paths":r=e.cache._arcadeCacheId,void 0===r&&(Ee++,r=Ee,e.cache._arcadeCacheId=r);return new m(e.paths,e.spatialReference,!0===e.hasZ,!0===e.hasM,r);case"type":return"Polyline"}break;case"multipoint":switch(t){case"points":r=e.cache._arcadeCacheId,void 0===r&&(Ee++,r=Ee,e.cache._arcadeCacheId=r);return new f(e.points,e.spatialReference,!0===e.hasZ,!0===e.hasM,r,1);case"type":return"Multipoint"}}throw new Error(Z(n,"RUNTIME","PROPERTYNOTFOUND"))}function Ne(e,t){try{let n;return n=!0===t.computed?ae(e,t.property):"'"+t.property.name+"'","lang.member("+ae(e,t.object)+","+n+")"}catch(n){throw n}}function ve(e,t){try{return"lang.unary("+ae(e,t.argument)+",'"+t.operator+"')"}catch(n){throw n}}function Me(e,t){try{const n=[];for(let r=0;r<t.elements.length;r++)"Literal"===t.elements[r].type?n.push(ae(e,t.elements[r])):n.push("lang.aCheck("+ae(e,t.elements[r])+",'ArrayExpression')");return"["+n.join(",")+"]"}catch(n){throw n}}function Ie(e,t){try{const n=[];let r=0;for(const o of t.quasis)n.push(o.value?JSON.stringify(o.value.cooked):JSON.stringify("")),!1===o.tail&&(n.push(t.expressions[r]?"lang.castString(lang.aCheck("+ae(e,t.expressions[r])+", 'TemplateLiteral'))":""),r++);return"(["+n.join(",")+"]).join('')"}catch(n){throw n}}function Oe(e,t){try{return"lang.binary("+ae(e,t.left)+","+ae(e,t.right)+",'"+t.operator+"')"}catch(n){throw n}}function xe(e,t){try{if("AssignmentExpression"===t.left.type||"UpdateExpression"===t.left.type)throw new Error(Z(t.left,"RUNTIME","CANNOT_USE_ASSIGNMENT_IN_CONDITION"));if("AssignmentExpression"===t.right.type||"UpdateExpression"===t.right.type)throw new Error(Z(t.right,"RUNTIME","CANNOT_USE_ASSIGNMENT_IN_CONDITION"));if("&&"===t.operator||"||"===t.operator)return"(lang.logicalCheck("+ae(e,t.left)+") "+t.operator+" lang.logicalCheck("+ae(e,t.right)+"))";throw new Error(Z(t,"RUNTIME","ONLYORORAND"))}catch(n){throw n}}function Te(e,t){try{const n=t.name.toLowerCase();if(null!==e.localScope){if(void 0!==e.localScope[n])return"lscope['"+n+"']";if(void 0!==e.localScope._SymbolsMap[n])return"lscope['"+e.localScope._SymbolsMap[n]+"']"}if(void 0!==e.globalScope[n])return"gscope['"+n+"']";if(void 0!==e.globalScope._SymbolsMap[n])return"gscope['"+e.globalScope._SymbolsMap[n]+"']";throw new Error(Z(t,"RUNTIME","VARIABLENOTFOUND"))}catch(n){throw n}}function Re(e,t){try{if("Identifier"!==t.callee.type)throw new Error(Z(t,"RUNTIME","ONLYNODESSUPPORTED"));const n=t.callee.name.toLowerCase();let r="";if(null!==e.localScope&&(void 0!==e.localScope[n]?r="lscope['"+n+"']":void 0!==e.localScope._SymbolsMap[n]&&(r="lscope['"+e.localScope._SymbolsMap[n]+"']")),""===r&&(void 0!==e.globalScope[n]?r="gscope['"+n+"']":void 0!==e.globalScope._SymbolsMap[n]&&(r="gscope['"+e.globalScope._SymbolsMap[n]+"']")),""!==r){let n="[";for(let r=0;r<t.arguments.length;r++)r>0&&(n+=", "),n+=ae(e,t.arguments[r]);return n+="]",e.isAsync?"(yield lang.callfunc("+r+","+n+",runtimeCtx) )":"lang.callfunc("+r+","+n+",runtimeCtx)"}throw new Error(Z(t,"RUNTIME","NOTFOUND"))}catch(n){throw n}}const _e={};function Ce(e){return null===e?"":w(e)||b(e)?"Array":P(e)?"Date":I(e)?"String":g(e)?"Boolean":T(e)?"Number":e instanceof B?"Attachment":e instanceof L?"Portal":e instanceof D?"Dictionary":e instanceof Y?"Feature":e instanceof s?"Point":e instanceof u?"Polygon":e instanceof p?"Polyline":e instanceof c?"Multipoint":e instanceof i?"Extent":N(e)?"Function":k(e)?"FeatureSet":j(e)?"FeatureSetCollection":e===S?"":"number"==typeof e&&isNaN(e)?"Number":"Unrecognised Type"}function Ue(e,t,n,r){try{const o=t[n];if(y(o,r))return t[n+1];{const o=t.length-n;return 1===o?t[n]:2===o?null:3===o?t[n+2]:Ue(e,t,n+2,r)}}catch(o){throw o}}function Ae(e,t,n,r){try{if(!0===r)return t[n+1];if(3===t.length-n)return t[n+2];{const r=t[n+2];if(!1===g(r))throw new Error("WHEN needs boolean test conditions");return Ae(e,t,n+2,r)}}catch(o){throw o}}function Fe(e,t){const n=e.length,r=Math.floor(n/2);return 0===n?[]:1===n?[e[0]]:Pe(Fe(e.slice(0,r),t),Fe(e.slice(r,n),t),t)}function Pe(e,t,n){const r=[];for(;e.length>0||t.length>0;)if(e.length>0&&t.length>0){let o=n(e[0],t[0]);isNaN(o)&&(o=0),o<=0?(r.push(e[0]),e=e.slice(1)):(r.push(t[0]),t=t.slice(1))}else e.length>0?(r.push(e[0]),e=e.slice(1)):t.length>0&&(r.push(t[0]),t=t.slice(1));return r}function ke(e,t){try{const n=e.length,a=Math.floor(n/2);if(0===n)return r([]);if(1===n)return r([e[0]]);const l=[ke(e.slice(0,a),t),ke(e.slice(a,n),t)];return o(l).then((e=>je(e[0],e[1],t,[])))}catch(a){return n(a)}}function je(t,n,r,o){return e(((e,a)=>{const l=o;t.length>0||n.length>0?t.length>0&&n.length>0?r(t[0],n[0]).then((s=>{try{isNaN(s)&&(s=1),s<=0?(l.push(t[0]),t=t.slice(1)):(l.push(n[0]),n=n.slice(1)),je(t,n,r,o).then((t=>{e(t)}),a)}catch(i){a(i)}}),a):t.length>0?(l.push(t[0]),je(t=t.slice(1),n,r,o).then((t=>{e(t)}),a)):n.length>0&&(l.push(n[0]),n=n.slice(1),je(t,n,r,o).then((t=>{e(t)}),a)):e(o)}))}function De(e){return e.symbols.symbolCounter++,"_T"+e.symbols.symbolCounter.toString()}function Le(e){return e.symbols.symbolCounter++,"_Tvar"+e.symbols.symbolCounter.toString()}H(_e,re),W(_e,re),ee(_e,re),Q(_e,re),K(_e,re),$(_e,re),_e.typeof=function(e,t){return re(e,t,(function(e,t,n){h(n,1,1);const r=Ce(n[0]);if("Unrecognised Type"===r)throw new Error("Unrecognised Type");return r}))},_e.iif=function(e,t){try{return re(e,t,(function(e,t,n){if(h(n,3,3),!1===g(n[0]))throw new Error("IF Function must have a boolean test condition");return n[0]?n[1]:n[2]}))}catch(n){throw n}},_e.decode=function(e,t){try{return re(e,t,(function(t,n,r){if(r.length<2)throw new Error("Missing Parameters");if(2===r.length)return r[1];{if((r.length-1)%2==0)throw new Error("Must have a default value result.");const t=r[0];return Ue(e,r,1,t)}}))}catch(n){throw n}},_e.when=function(e,t){try{return re(e,t,(function(t,n,r){if(r.length<3)throw new Error("Missing Parameters");if(r.length%2==0)throw new Error("Must have a default value result.");const o=r[0];if(!1===g(o))throw new Error("WHEN needs boolean test conditions");return Ae(e,r,0,o)}))}catch(n){throw n}},_e.top=function(e,t){return re(e,t,(function(e,t,n){if(h(n,2,2),w(n[0]))return E(n[1])>=n[0].length?n[0].slice(0):n[0].slice(0,E(n[1]));if(b(n[0]))return E(n[1])>=n[0].length()?n[0].slice(0):n[0].slice(0,E(n[1]));throw new Error("Top cannot accept this parameter type")}))},_e.first=function(e,t){return re(e,t,(function(e,t,n){return h(n,1,1),w(n[0])?0===n[0].length?null:n[0][0]:b(n[0])?0===n[0].length()?null:n[0].get(0):null}))},_e.sort=function(e,t){return re(e,t,(function(t,n,r){h(r,1,2);let o=r[0];if(b(o)&&(o=o.toArray()),!1===w(o))throw new Error("Illegal Argument");if(r.length>1){if(!1===N(r[1]))throw new Error("Illegal Argument");let n=o;const a=function(e,n){return et.callfunc(r[1],[e,n],t)};return e.isAsync?ke(n,a):(n=Fe(n,(function(e,t){return a(e,t)})),n)}{let e=o;if(0===e.length)return[];const t={};for(let o=0;o<e.length;o++){const n=Ce(e[o]);""!==n&&(t[n]=!0)}if(!0===t.Array||!0===t.Dictionary||!0===t.Feature||!0===t.Point||!0===t.Polygon||!0===t.Polyline||!0===t.Multipoint||!0===t.Extent||!0===t.Function)return e.slice(0);let n=0,r="";for(const o in t)n++,r=o;return e=n>1||"String"===r?Fe(e,(function(e,t){if(null==e||e===S)return null==t||t===S?0:1;if(null==t||t===S)return-1;const n=v(e),r=v(t);return n<r?-1:n===r?0:1})):"Number"===r?Fe(e,(function(e,t){return e-t})):"Boolean"===r?Fe(e,(function(e,t){return e===t?0:t?-1:1})):"Date"===r?Fe(e,(function(e,t){return t-e})):e.slice(0),e}}))};const Be={};for(const ot in _e)Be[ot]=new d(_e[ot]);X(_e,re);for(const ot in _e)_e[ot]=new d(_e[ot]);const Ye=function(){};Ye.prototype=_e;const Ve=function(){};function Ge(e,t,n){const r={};e||(e={}),n||(n={}),r._SymbolsMap={},r.textformatting=1,r.infinity=1,r.pi=1;for(const o in t)r[o]=1;for(const o in n)r[o]=1;for(const o in e)r[o]=1;return r}function ze(e,t,n){const r=n?new Ve:new Ye;e||(e={}),t||(t={});const o=new D({newline:"\n",tab:"\t",singlequote:"'",doublequote:'"',forwardslash:"/",backwardslash:"\\"});o.immutable=!1,r._SymbolsMap={textformatting:1,infinity:1,pi:1},r.textformatting=o,r.infinity=Number.POSITIVE_INFINITY,r.pi=Math.PI;for(const a in t)r[a]=t[a],r._SymbolsMap[a]=1;for(const a in e)r._SymbolsMap[a]=1,e[a]&&"esri.Graphic"===e[a].declaredClass?r[a]=Y.createFromGraphic(e[a]):r[a]=e[a];return r}Ve.prototype=Be;const qe={fixSpatialReference:M,parseArguments:ne,standardFunction:re};function Je(e,t){const n={mode:t,compiled:!0,functions:{},signatures:[],failDefferred:oe,standardFunction:re,standardFunctionAsync:re,evaluateIdentifier:Qe};for(let r=0;r<e.length;r++)e[r].registerFunctions(n);if("sync"===t){for(const e in n.functions)_e[e]=new d(n.functions[e]),Ye.prototype[e]=_e[e];for(let e=0;e<n.signatures.length;e++)V(n.signatures[e],"sync")}else{for(const e in n.functions)Be[e]=new d(n.functions[e]),Ve.prototype[e]=Be[e];for(let e=0;e<n.signatures.length;e++)V(n.signatures[e],"async")}}function Ze(e,t){return e(t)}function He(e,t){return G(e)}function We(e,t){return z(e,t,"sync")}function Ke(e,t){return q(e,t)}function Xe(e,t){return J(e,t)}function Qe(e,t){const n=t.name;if("_SymbolsMap"===n)throw"Illegal";if(e.localStack.length>0){if("_t"!==n.substr(0,2).toLowerCase()&&void 0!==e.localStack[e.localStack.length-1][n])return e.localStack[e.localStack.length-1][n];const t=e.mangleMap[n];if(void 0!==t&&void 0!==e.localStack[e.localStack.length-1][t])return e.localStack[e.localStack.length-1][t]}if("_t"!==n.substr(0,2).toLowerCase()&&void 0!==e.globalScope[n])return e.globalScope[n];if(1===e.globalScope._SymbolsMap[n])return e.globalScope[n];const r=e.mangleMap[n];return void 0!==r?e.globalScope[r]:void 0}let $e=0;const et={error(e,t,n){throw new Error(Z(e,t,n))},__awaiter:(t,n,r,o)=>e(((e,r)=>{function a(e){try{s(o.next(e))}catch(t){r(t)}}function l(e){try{s(o.throw(e))}catch(t){r(t)}}function s(t){t.done?e(t.value):t.value&&t.value.then?t.value.then(a,l):($e++,$e%100==0?setTimeout((()=>{$e=0,a(t.value)}),0):a(t.value))}s((o=o.apply(t,n||[])).next())})),functionDepthchecker:(e,n)=>function(){if(n.depthCounter++,n.localStack.push([]),n.depthCounter>64)throw new Error("Exceeded maximum function depth");const r=e.apply(this,arguments);return t(r)?r.then((e=>(n.depthCounter--,n.localStack.length=n.localStack.length-1,e))):(n.depthCounter--,n.localStack.length=n.localStack.length-1,r)},castString:e=>v(e),aCheck(e,t){if(N(e))throw new Error(Z({type:t},"RUNTIME","FUNCTIONCONTEXTILLEGAL"));return e===S?null:e},Dictionary:D,Feature:Y,dictionary(e){const t={};for(let r=0;r<e.length;r+=2){if(N(e[r+1]))throw new Error("Illegal Argument");if(!1===I(e[r]))throw new Error("Illegal Argument");e[r+1]===S?t[e[r].toString()]=null:t[e[r].toString()]=e[r+1]}const n=new D(t);return n.immutable=!1,n},strCheck(e){if(!1===I(e))throw new Error("Illegal Argument");return e},unary(e,t){if(g(e)){if("!"===t)return!e;if("-"===t)return-1*E(e);if("+"===t)return 1*E(e);if("~"===t)return~E(e);throw new Error(Z({type:"UnaryExpression",operator:t,prefix:null,argument:null},"RUNTIME","NOTSUPPORTEDUNARYOPERATOR"))}if("-"===t)return-1*E(e);if("+"===t)return 1*E(e);if("~"===t)return~E(e);throw new Error(Z({type:"UnaryExpression",operator:t,prefix:null,argument:null},"RUNTIME","NOTSUPPORTEDUNARYOPERATOR"))},logicalCheck(e){if(!1===g(e)){throw new Error(Z({type:"LogicalExpression",operator:null,left:null,right:null},"RUNTIME","ONLYORORAND"))}return e},logical(e,t,n){if(g(e)&&g(t))switch(n){case"||":return e||t;case"&&":return e&&t;default:throw new Error(Z({type:"LogicalExpression",operator:null,left:null,right:null},"RUNTIME","ONLYORORAND"))}throw new Error(Z({type:"LogicalExpression",operator:null,left:null,right:null},"RUNTIME","ONLYORORAND"))},binary(e,t,n){switch(n){case"|":case"<<":case">>":case">>>":case"^":case"&":return x(E(e),E(t),n);case"==":case"=":return y(e,t);case"!=":return!y(e,t);case"<":case">":case"<=":case">=":return O(e,t,n);case"+":return I(e)||I(t)?v(e)+v(t):E(e)+E(t);case"-":return E(e)-E(t);case"*":return E(e)*E(t);case"/":return E(e)/E(t);case"%":return E(e)%E(t);default:throw new Error(Z({type:"BinaryExpression",operator:n,left:e,right:t},"RUNTIME","OPERATORNOTRECOGNISED"))}},assign(e,t,n){switch(t){case"=":return e===S?null:e;case"/=":return E(n)/E(e);case"*=":return E(n)*E(e);case"-=":return E(n)-E(e);case"+=":return I(n)||I(e)?v(n)+v(e):E(n)+E(e);case"%=":return E(n)%E(e);default:throw new Error(Z({type:"AssignmentExpression",operator:t,left:null,right:null},"RUNTIME","OPERATORNOTRECOGNISED"))}},update(e,t,n,r){const o=E(e[t]);return e[t]="++"===n?o+1:o-1,!1===r?o:"++"===n?o+1:o-1},graphicToFeature:(e,t)=>null===e?null:Y.createFromGraphicLikeObject(e.geometry,e.attributes,t),memberupdate(e,t,n,r){let o;if(w(e)){if(!T(t))throw new Error("Invalid Parameter");if(t<0&&(t=e.length+t),t<0||t>=e.length)throw new Error("Assignment outside of array bounds");o=E(e[t]),e[t]="++"===n?o+1:o-1}else if(e instanceof D){if(!1===I(t))throw new Error("Dictionary accessor must be a string");if(!0!==e.hasField(t))throw new Error("Invalid Parameter");o=E(e.field(t)),e.setField(t,"++"===n?o+1:o-1)}else{if(!(e instanceof Y))throw b(e)?new Error("Array is Immutable"):new Error("Invalid Parameter");if(!1===I(t))throw new Error("Feature accessor must be a string");if(!0!==e.hasField(t))throw new Error("Invalid Parameter");o=E(e.field(t)),e.setField(t,"++"===n?o+1:o-1)}return!1===r?o:"++"===n?o+1:o-1},assignmember(e,t,n,r){if(w(e)){if(!T(t))throw new Error("Invalid Parameter");if(t<0&&(t=e.length+t),t<0||t>e.length)throw new Error("Assignment outside of array bounds");if(t===e.length){if("="!==n)throw new Error("Invalid Parameter");e[t]=this.assign(r,n,e[t])}else e[t]=this.assign(r,n,e[t])}else if(e instanceof D){if(!1===I(t))throw new Error("Dictionary accessor must be a string");if(!0===e.hasField(t))e.setField(t,this.assign(r,n,e.field(t)));else{if("="!==n)throw new Error("Invalid Parameter");e.setField(t,this.assign(r,n,null))}}else{if(!(e instanceof Y))throw b(e)?new Error("Array is Immutable"):new Error("Invalid Parameter");if(!1===I(t))throw new Error("Feature accessor must be a string");if(!0===e.hasField(t))e.setField(t,this.assign(r,n,e.field(t)));else{if("="!==n)throw new Error("Invalid Parameter");e.setField(t,this.assign(r,n,null))}}},member(e,t){if(null===e){throw new Error(Z({type:"MemberExpression",object:null,property:null,computed:null},"RUNTIME","NOTFOUND"))}if(e instanceof te){if(I(t))return e.field(t);throw new Error(Z({type:"MemberExpression",object:null,property:null,computed:null},"RUNTIME","INVALIDTYPE"))}if(e instanceof D||e instanceof Y){if(I(t))return e.field(t);throw new Error(Z({type:"MemberExpression",object:null,property:null,computed:null},"RUNTIME","INVALIDTYPE"))}if(e instanceof l){if(I(t))return be(e,t,"MemberExpression");throw new Error(Z({type:"MemberExpression",object:null,property:null,computed:null},"RUNTIME","INVALIDTYPE"))}if(w(e)){if(T(t)&&isFinite(t)&&Math.floor(t)===t){if(t<0&&(t=e.length+t),t>=e.length||t<0){throw new Error(Z({type:"MemberExpression",object:null,property:null,computed:null},"RUNTIME","OUTOFBOUNDS"))}return e[t]}throw new Error(Z({type:"MemberExpression",object:null,property:null,computed:null},"RUNTIME","INVALIDTYPE"))}if(I(e)){if(T(t)&&isFinite(t)&&Math.floor(t)===t){if(t<0&&(t=e.length+t),t>=e.length||t<0){throw new Error(Z({type:"MemberExpression",object:null,property:null,computed:null},"RUNTIME","OUTOFBOUNDS"))}return e[t]}throw new Error(Z({type:"MemberExpression",object:null,property:null,computed:null},"RUNTIME","INVALIDTYPE"))}if(b(e)){if(T(t)&&isFinite(t)&&Math.floor(t)===t){if(t<0&&(t=e.length()+t),t>=e.length()||t<0){throw new Error(Z({type:"MemberExpression",object:null,property:null,computed:null},"RUNTIME","OUTOFBOUNDS"))}return e.get(t)}throw new Error(Z({type:"MemberExpression",object:null,property:null,computed:null},"RUNTIME","INVALIDTYPE"))}throw new Error(Z({type:"MemberExpression",object:null,property:null,computed:null},"RUNTIME","INVALIDTYPE"))},callfunc(e,t,n){return e instanceof d?e.fn(n,t):e instanceof R?e.fn.apply(this,t):e.apply(this,t)}};function tt(e){console.log(e)}function nt(e,t=null,n=!1){null===t&&(t={vars:{},customfunctions:{}});const r={isAsync:n,globalScope:Ge(t.vars,n?Be:_e,t.customfunctions),localScope:null,mangleMap:{},console:tt,lrucache:t.lrucache,interceptor:t.interceptor,services:t.services,symbols:{symbolCounter:0}};let o=ae(r,e.body[0].body);""===o&&(o="lc.voidOperation; ");let l="";l=n?"var runtimeCtx=this.prepare(context, true);\n var lc = this.lc;  var lang = this.lang; var gscope=runtimeCtx.globalScope; \nreturn lang.__awaiter(this, void 0, void 0, function* () {\n\n function mainBody() {\n var lastStatement=lc.voidOperation;\n return lang.__awaiter(this, void 0, void 0, function* () {\n"+o+"\n return lastStatement; }); } \n return this.postProcess(yield mainBody()); }); ":"var runtimeCtx=this.prepare(context, false);\n var lc = this.lc;  var lang = this.lang; var gscope=runtimeCtx.globalScope; \n function mainBody() {\n var lastStatement=lc.voidOperation;\n "+o+"\n return lastStatement; } \n return this.postProcess(mainBody()); ";const s={lc:_,lang:et,mangles:r.mangleMap,postProcess(e){if(e instanceof C&&(e=e.value),e instanceof U&&(e=e.value),e===S&&(e=null),e===A)throw new Error("Cannot return BREAK");if(e===F)throw new Error("Cannot return CONTINUE");if(N(e))throw new Error("Cannot return FUNCTION");return e},prepare(e,t){let n=e.spatialReference;null==n&&(n=new a({wkid:102100}));const r=ze(e.vars,e.customfunctions,t);return{localStack:[],isAsync:t,mangleMap:this.mangles,spatialReference:n,globalScope:r,abortSignal:void 0===e.abortSignal||null===e.abortSignal?{aborted:!1}:e.abortSignal,localScope:null,services:e.services,console:e.console?e.console:tt,lrucache:e.lrucache,interceptor:e.interceptor,symbols:{symbolCounter:0},depthCounter:1}}};return new Function("context","spatialReference",l).bind(s)}function rt(){return import("./functions/geomasync.js").then((e=>(Je([e],"async"),!0)))}export{nt as compileScript,rt as enableAsyncSupport,Ze as executeScript,Je as extend,He as extractFieldLiterals,qe as functionHelper,Xe as referencesFunction,Ke as referencesMember,We as validateScript};
