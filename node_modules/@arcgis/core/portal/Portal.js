/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import"../core/has.js";import t from"../config.js";import{isSome as r}from"../core/maybe.js";import"../core/Logger.js";import{ensureType as o}from"../core/accessorSupport/ensureType.js";import{property as s}from"../core/accessorSupport/decorators/property.js";import{reader as i}from"../core/accessorSupport/decorators/reader.js";import{subclass as a}from"../core/accessorSupport/decorators/subclass.js";import l from"../core/Error.js";import"../core/urlUtils.js";import"../core/uuid.js";import"./support/resourceExtension.js";import{throwIfAborted as n,isAborted as u,createAbortError as p,throwIfAbortError as d}from"../core/promiseUtils.js";import{JSONSupportMixin as h}from"../core/JSONSupport.js";import c from"../geometry/Extent.js";import{getLocale as y}from"../intl/locale.js";import{id as m}from"../kernel.js";import v from"../request.js";import"../intl.js";import f from"../core/Loadable.js";import S from"./PortalQueryParams.js";import g from"./PortalQueryResult.js";import P from"./PortalUser.js";var _;let O;const U={PortalGroup:()=>import("./PortalGroup.js"),PortalItem:()=>import("./PortalItem.js"),PortalUser:()=>import("./PortalUser.js")};let j=_=class extends(h(f)){constructor(e){super(e),this.access=null,this.allSSL=!1,this.authMode="auto",this.authorizedCrossOriginDomains=null,this.basemapGalleryGroupQuery=null,this.bingKey=null,this.canListApps=!1,this.canListData=!1,this.canListPreProvisionedItems=!1,this.canProvisionDirectPurchase=!1,this.canSearchPublic=!0,this.canShareBingPublic=!1,this.canSharePublic=!1,this.canSignInArcGIS=!1,this.canSignInIDP=!1,this.colorSetsGroupQuery=null,this.commentsEnabled=!1,this.created=null,this.culture=null,this.customBaseUrl=null,this.defaultBasemap=null,this.defaultExtent=null,this.defaultVectorBasemap=null,this.description=null,this.eueiEnabled=null,this.featuredGroups=null,this.featuredItemsGroupQuery=null,this.galleryTemplatesGroupQuery=null,this.livingAtlasGroupQuery=null,this.hasCategorySchema=!1,this.helperServices=null,this.homePageFeaturedContent=null,this.homePageFeaturedContentCount=null,this.httpPort=null,this.httpsPort=null,this.id=null,this.ipCntryCode=null,this.isPortal=!1,this.isReadOnly=!1,this.layerTemplatesGroupQuery=null,this.maxTokenExpirationMinutes=null,this.modified=null,this.name=null,this.portalHostname=null,this.portalMode=null,this.portalProperties=null,this.region=null,this.rotatorPanels=null,this.showHomePageDescription=!1,this.sourceJSON=null,this.supportsHostedServices=!1,this.symbolSetsGroupQuery=null,this.templatesGroupQuery=null,this.units=null,this.url=t.portalUrl,this.urlKey=null,this.user=null,this.useStandardizedQuery=!1,this.useVectorBasemaps=!1,this.vectorBasemapGalleryGroupQuery=null}normalizeCtorArgs(e){return"string"==typeof e?{url:e}:e}destroy(){this._esriId_credentialCreateHandle&&(this._esriId_credentialCreateHandle.remove(),this._esriId_credentialCreateHandle=null)}readAuthorizedCrossOriginDomains(e){if(e)for(const r of e)-1===t.request.trustedServers.indexOf(r)&&t.request.trustedServers.push(r);return e}readDefaultBasemap(e){if(e){const t=O.fromJSON(e);return t.portalItem={portal:this},t}return null}readDefaultVectorBasemap(e){if(e){const t=O.fromJSON(e);return t.portalItem={portal:this},t}return null}get extraQuery(){const e=!(this.user&&this.user.orgId)||this.canSearchPublic;return this.id&&!e?` AND orgid:${this.id}`:null}get isOrganization(){return!!this.access}get restUrl(){let e=this.url;if(e){const t=e.indexOf("/sharing");e=t>0?e.substring(0,t):this.url.replace(/\/+$/,""),e+="/sharing/rest"}return e}get thumbnailUrl(){const e=this.restUrl,t=this.thumbnail;return e&&t?this._normalizeSSL(e+"/portals/self/resources/"+t):null}readUrlKey(e){return e?e.toLowerCase():e}readUser(e){let t=null;return e&&(t=P.fromJSON(e),t.portal=this),t}load(e){const t=import("../Basemap.js").then((({default:t})=>{n(e),O=t})).then((()=>this.sourceJSON?this.sourceJSON:this._fetchSelf(this.authMode,!1,e))).then((e=>{if(m){const e=m;this.credential=e.findCredential(this.restUrl),this.credential||this.authMode!==_.AUTH_MODE_AUTO||(this._esriId_credentialCreateHandle=e.on("credential-create",(()=>{e.findCredential(this.restUrl)&&this._signIn()})))}this.sourceJSON=e,this.read(e)}));return this.addResolvingPromise(t),Promise.resolve(this)}async createClosestFacilityTask(){await this.load();const e=this._getHelperServiceUrl("closestFacility");return new(0,(await import("../tasks/ClosestFacilityTask.js")).default)(e)}async createElevationLayers(){await this.load();const e=this._getHelperService("defaultElevationLayers"),t=(await import("../layers/ElevationLayer.js")).default;return e?e.map((e=>new t({id:e.id,url:e.url}))):[]}async createGeometryService(){await this.load();const e=this._getHelperServiceUrl("geometry");return new(0,(await import("../tasks/GeometryService.js")).default)({url:e})}async createPrintTask(){await this.load();const e=this._getHelperServiceUrl("printTask");return new(0,(await import("../tasks/PrintTask.js")).default)(e)}async createRouteTask(){await this.load();const e=this._getHelperServiceUrl("route");return new(0,(await import("../tasks/RouteTask.js")).default)(e)}async createServiceAreaTask(){await this.load();const e=this._getHelperServiceUrl("serviceArea");return new(0,(await import("../tasks/ServiceAreaTask.js")).default)(e)}fetchBasemaps(e,t){const r=new S;return r.query=e||(this.useVectorBasemaps?this.vectorBasemapGalleryGroupQuery:this.basemapGalleryGroupQuery),r.disableExtraQuery=!0,this.queryGroups(r,t).then((e=>{if(r.num=100,r.query='type:"Web Map" -type:"Web Application"',e.total){const o=e.results[0];return r.sortField=o.sortField||"name",r.sortOrder=o.sortOrder||"desc",o.queryItems(r,t)}return null})).then((e=>{let t;return t=e&&e.total?e.results.filter((e=>"Web Map"===e.type)).map((e=>new O({portalItem:e}))):[],t}))}fetchCategorySchema(e){return this.hasCategorySchema?this._request(this.restUrl+"/portals/self/categorySchema",e).then((e=>e.categorySchema)):u(e)?Promise.reject(p()):Promise.resolve([])}fetchFeaturedGroups(e){const t=this.featuredGroups,r=new S;if(r.num=100,r.sortField="title",t&&t.length){const o=[];for(const e of t)o.push(`(title:"${e.title}" AND owner:${e.owner})`);return r.query=o.join(" OR "),this.queryGroups(r,e).then((e=>e.results))}return u(e)?Promise.reject(p()):Promise.resolve([])}fetchRegions(e){const t=this.user&&this.user.culture||this.culture||y();return this._request(this.restUrl+"/portals/regions",{...e,query:{culture:t}})}static getDefault(){return _._default&&!_._default.destroyed||(_._default=new _),_._default}queryGroups(e,t){return this._queryPortal("/community/groups",e,"PortalGroup",t)}queryItems(e,t){return this._queryPortal("/search",e,"PortalItem",t)}queryUsers(e,t){return e.sortField||(e.sortField="username"),this._queryPortal("/community/users",e,"PortalUser",t)}toJSON(){throw new l("internal:not-yet-implemented","Portal.toJSON is not yet implemented")}static fromJSON(e){if(!e)return null;if(e.declaredClass)throw new Error("JSON object is already hydrated");return new _({sourceJSON:e})}_getHelperService(e){const t=this.helperServices&&this.helperServices[e];if(!t)throw new l("portal:service-not-found",`The \`helperServices\` do not include an entry named "${e}"`);return t}_getHelperServiceUrl(e){const t=this._getHelperService(e);if(!t.url)throw new l("portal:service-url-not-found",`The \`helperServices\` entry "${e}" does not include a \`url\` value`);return t.url}_fetchSelf(e=this.authMode,t=!1,r){const o=this.restUrl+"/portals/self",s={authMode:e,query:{culture:y().toLowerCase()},...r};return"auto"===s.authMode&&(s.authMode="no-prompt"),t&&(s.query.default=!0),this._request(o,s)}_queryPortal(e,t,r,s){const i=o(S,t),a=t=>this._request(this.restUrl+e,{...i.toRequestOptions(this),...s}).then((e=>{const r=i.clone();return r.start=e.nextStart,new g({nextQueryParams:r,queryParams:i,total:e.total,results:_._resultsToTypedArray(t,{portal:this},e,s)})})).then((e=>Promise.all(e.results.map((t=>"function"==typeof t.when?t.when():e))).then((()=>e),(t=>(d(t),e)))));return r&&U[r]?U[r]().then((({default:e})=>(n(s),a(e)))):a()}_signIn(){if(this.authMode===_.AUTH_MODE_ANONYMOUS)return Promise.reject(new l("portal:invalid-auth-mode",`Current "authMode"' is "${this.authMode}"`));if("failed"===this.loadStatus)return Promise.reject(this.loadError);const e=e=>Promise.resolve().then((()=>"not-loaded"===this.loadStatus?(e||(this.authMode="immediate"),this.load().then((()=>null))):"loading"===this.loadStatus?this.load().then((()=>this.credential?null:(this.credential=e,this._fetchSelf("immediate")))):this.user&&this.credential===e?null:(this.credential=e,this._fetchSelf("immediate")))).then((e=>{e&&(this.sourceJSON=e,this.read(e))}));return m?m.getCredential(this.restUrl).then((t=>e(t))):e(this.credential)}_normalizeSSL(e){return e.replace(/^http:/i,"https:").replace(":7080",":7443")}_normalizeUrl(e){const t=this.credential&&this.credential.token;return this._normalizeSSL(t?e+(e.indexOf("?")>-1?"&":"?")+"token="+t:e)}_requestToTypedArray(e,t,r){return this._request(e,t).then((e=>{const t=_._resultsToTypedArray(r,{portal:this},e);return Promise.all(t.map((t=>"function"==typeof t.when?t.when():e))).then((()=>t),(()=>t))}))}_request(e,t={}){const r={f:"json",...t.query},{authMode:o=(this.authMode===_.AUTH_MODE_ANONYMOUS?"anonymous":"auto"),body:s=null,cacheBust:i=!1,method:a="auto",responseType:l="json",signal:n}=t,u={authMode:o,body:s,cacheBust:i,method:a,query:r,responseType:l,timeout:0,signal:n};return v(this._normalizeSSL(e),u).then((e=>e.data))}static _resultsToTypedArray(e,t,o,s){let i;if(o){const a=r(s)?s.signal:null;i=o.listings||o.notifications||o.userInvitations||o.tags||o.items||o.groups||o.comments||o.provisions||o.results||o.relatedItems||o,(e||t)&&(i=i.map((r=>{const o=Object.assign(e?e.fromJSON(r):r,t);return"function"==typeof o.load&&o.load(a),o})))}else i=[];return i}};j.AUTH_MODE_ANONYMOUS="anonymous",j.AUTH_MODE_AUTO="auto",j.AUTH_MODE_IMMEDIATE="immediate",e([s()],j.prototype,"access",void 0),e([s()],j.prototype,"allSSL",void 0),e([s()],j.prototype,"authMode",void 0),e([s()],j.prototype,"authorizedCrossOriginDomains",void 0),e([i("authorizedCrossOriginDomains")],j.prototype,"readAuthorizedCrossOriginDomains",null),e([s()],j.prototype,"basemapGalleryGroupQuery",void 0),e([s()],j.prototype,"bingKey",void 0),e([s()],j.prototype,"canListApps",void 0),e([s()],j.prototype,"canListData",void 0),e([s()],j.prototype,"canListPreProvisionedItems",void 0),e([s()],j.prototype,"canProvisionDirectPurchase",void 0),e([s()],j.prototype,"canSearchPublic",void 0),e([s()],j.prototype,"canShareBingPublic",void 0),e([s()],j.prototype,"canSharePublic",void 0),e([s()],j.prototype,"canSignInArcGIS",void 0),e([s()],j.prototype,"canSignInIDP",void 0),e([s()],j.prototype,"colorSetsGroupQuery",void 0),e([s()],j.prototype,"commentsEnabled",void 0),e([s({type:Date})],j.prototype,"created",void 0),e([s()],j.prototype,"credential",void 0),e([s()],j.prototype,"culture",void 0),e([s()],j.prototype,"currentVersion",void 0),e([s()],j.prototype,"customBaseUrl",void 0),e([s()],j.prototype,"defaultBasemap",void 0),e([i("defaultBasemap")],j.prototype,"readDefaultBasemap",null),e([s({type:c})],j.prototype,"defaultExtent",void 0),e([s()],j.prototype,"defaultVectorBasemap",void 0),e([i("defaultVectorBasemap")],j.prototype,"readDefaultVectorBasemap",null),e([s()],j.prototype,"description",void 0),e([s()],j.prototype,"eueiEnabled",void 0),e([s({readOnly:!0})],j.prototype,"extraQuery",null),e([s()],j.prototype,"featuredGroups",void 0),e([s()],j.prototype,"featuredItemsGroupQuery",void 0),e([s()],j.prototype,"galleryTemplatesGroupQuery",void 0),e([s()],j.prototype,"livingAtlasGroupQuery",void 0),e([s()],j.prototype,"hasCategorySchema",void 0),e([s()],j.prototype,"helpBase",void 0),e([s()],j.prototype,"helperServices",void 0),e([s()],j.prototype,"helpMap",void 0),e([s()],j.prototype,"homePageFeaturedContent",void 0),e([s()],j.prototype,"homePageFeaturedContentCount",void 0),e([s()],j.prototype,"httpPort",void 0),e([s()],j.prototype,"httpsPort",void 0),e([s()],j.prototype,"id",void 0),e([s()],j.prototype,"ipCntryCode",void 0),e([s({readOnly:!0})],j.prototype,"isOrganization",null),e([s()],j.prototype,"isPortal",void 0),e([s()],j.prototype,"isReadOnly",void 0),e([s()],j.prototype,"layerTemplatesGroupQuery",void 0),e([s()],j.prototype,"maxTokenExpirationMinutes",void 0),e([s({type:Date})],j.prototype,"modified",void 0),e([s()],j.prototype,"name",void 0),e([s()],j.prototype,"portalHostname",void 0),e([s()],j.prototype,"portalMode",void 0),e([s()],j.prototype,"portalProperties",void 0),e([s()],j.prototype,"region",void 0),e([s({readOnly:!0})],j.prototype,"restUrl",null),e([s()],j.prototype,"rotatorPanels",void 0),e([s()],j.prototype,"showHomePageDescription",void 0),e([s()],j.prototype,"sourceJSON",void 0),e([s()],j.prototype,"staticImagesUrl",void 0),e([s()],j.prototype,"stylesGroupQuery",void 0),e([s()],j.prototype,"supportsHostedServices",void 0),e([s()],j.prototype,"symbolSetsGroupQuery",void 0),e([s()],j.prototype,"templatesGroupQuery",void 0),e([s()],j.prototype,"thumbnail",void 0),e([s({readOnly:!0})],j.prototype,"thumbnailUrl",null),e([s()],j.prototype,"units",void 0),e([s()],j.prototype,"url",void 0),e([s()],j.prototype,"urlKey",void 0),e([i("urlKey")],j.prototype,"readUrlKey",null),e([s()],j.prototype,"user",void 0),e([i("user")],j.prototype,"readUser",null),e([s()],j.prototype,"useStandardizedQuery",void 0),e([s()],j.prototype,"useVectorBasemaps",void 0),e([s()],j.prototype,"vectorBasemapGalleryGroupQuery",void 0),j=_=e([a("esri.portal.Portal")],j);var w=j;export default w;
