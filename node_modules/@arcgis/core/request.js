/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import e from"./core/global.js";import t from"./core/has.js";import{clone as r}from"./core/lang.js";import o from"./config.js";import{unwrap as s}from"./core/maybe.js";import n from"./core/Error.js";import{isDataProtocol as a,isBlobProtocol as i,normalize as l,getInterceptor as u,isTrustedServer as c,getOrigin as d,toHTTPS as p,addQueryParameter as m,objectToQuery as h,getProxyRule as f,getProxyUrl as w,addQueryParameters as y,hasSameOrigin as g,appUrl as b,addProxyRule as q,removeFile as k,urlToObject as O}from"./core/urlUtils.js";import{createAbortController as T,onAbort as x,isAbortError as S,createAbortError as C,isAborted as E}from"./core/promiseUtils.js";import{id as L}from"./kernel.js";import{supportsApiKey as v}from"./support/apiKeyUtils.js";import{loadImageAsync as j}from"./support/requestUtils.js";async function U(e,r){const o=a(e),n=i(e);n||o||(e=l(e));const c={url:e,requestOptions:{...s(r)}};let d=u(e);if(d){const e=await z(d,c);if(null!=e)return{data:e,getHeader:R,requestOptions:c.requestOptions,url:c.url};d.after||d.error||(d=null)}if(e=c.url,"image"===(r=c.requestOptions).responseType){if(t("host-webworker")||t("host-node"))throw N("request:invalid-parameters",new Error("responseType 'image' is not supported in Web Workers or Node environment"),c)}else if(o)throw N("request:invalid-parameters",new Error("Data URLs are not supported for responseType = "+r.responseType),c);if("head"===r.method){if(r.body)throw N("request:invalid-parameters",new Error("body parameter cannot be set when method is 'head'"),c);if(o||n)throw N("request:invalid-parameters",new Error("data and blob URLs are not supported for method 'head'"),c)}if(await A(),P)return P.execute(e,r);const p=T();x(r,(()=>p.abort()));const m={controller:p,credential:null,credentialToken:null,fetchOptions:null,hasToken:!1,interceptor:d,params:c,redoRequest:!1,useIdentity:D.useIdentity,useProxy:!1,useSSL:!1,withCredentials:!1},h=await Q(m);return d&&d.after&&d.after(h),h}let P;const D=o.request,_="FormData"in e,F=[499,498,403,401],I=["COM_0056","COM_0057","SB_0008"],M=[/\/arcgis\/tokens/i,/\/sharing(\/rest)?\/generatetoken/i,/\/rest\/info/i],R=()=>null;function H(e){if(i(e)||a(e))return;const t=d(e);t&&-1===U._corsServers.indexOf(t)&&U._corsServers.push(t)}function B(e){const t=d(e);return!t||t.endsWith(".arcgis.com")||-1!==U._corsServers.indexOf(t)||c(t)}function N(e,t,o,s){let a="Error";const i={url:o.url,requestOptions:o.requestOptions,getHeader:R,ssl:!1};if(t instanceof n)return t.details?(t.details=r(t.details),t.details.url=o.url,t.details.requestOptions=o.requestOptions):t.details=i,t;if(t){const e=s&&(e=>s.headers.get(e)),r=s&&s.status,o=t.message;o&&(a=o),e&&(i.getHeader=e),i.httpStatus=(null!=t.httpCode?t.httpCode:t.code)||r||0,i.subCode=t.subcode,i.messageCode=t.messageCode,"string"==typeof t.details?i.messages=[t.details]:i.messages=t.details}return S(t)?C():new n(e,a,i)}async function A(){t("host-webworker")?P||(P=await import("./core/workers/request.js")):U._abortableFetch||(U._abortableFetch=e.fetch.bind(e))}async function $(){L||await import("./identity/IdentityManager.js")}async function K(t){const r=t.params.url,s=t.params.requestOptions,n=t.controller.signal,a=s.body;let i=null,l=null,u=null;if(_&&"HTMLFormElement"in e&&(a instanceof FormData?i=a:a instanceof HTMLFormElement&&(l=a,i=new FormData(l))),"string"==typeof a&&(u=a),t.fetchOptions={cache:s.cacheBust&&!U._abortableFetch.polyfill?"no-cache":"default",credentials:"same-origin",headers:s.headers||{},method:"head"===s.method?"HEAD":"GET",mode:"cors",redirect:"follow",signal:n},(i||u)&&(t.fetchOptions.body=i||u),"anonymous"===s.authMode&&(t.useIdentity=!1),t.hasToken=!!(/token=/i.test(r)||s.query&&s.query.token||i&&i.get&&i.get("token")||l&&l.elements.token),!t.hasToken&&o.apiKey&&v(r)&&(s.query||(s.query={}),s.query.token=o.apiKey,t.hasToken=!0),t.useIdentity&&!t.hasToken&&!t.credentialToken&&!W(r)&&!E(n)){let e;"immediate"===s.authMode?(await $(),e=await L.getCredential(r,{signal:n}),t.credential=e):"no-prompt"===s.authMode?(await $(),e=await L.getCredential(r,{prompt:!1,signal:n}).catch((()=>{})),t.credential=e):L&&(e=L.findCredential(r)),e&&(t.credentialToken=e.token,t.useSSL=!!e.ssl)}}function W(e){return M.some((t=>t.test(e)))}async function G(e){let r=e.params.url;const o=e.params.requestOptions,s=e.fetchOptions,n=i(r)||a(r),l=o.responseType||"json",u=n?0:null!=o.timeout?o.timeout:D.timeout;let d=!1;if(!n){e.useSSL&&(r=p(r)),o.cacheBust&&"default"===s.cache&&(r=m(r,"request.preventCache",Date.now()));let n={...o.query};e.credentialToken&&(n.token=e.credentialToken);let a=h(n);t("esri-url-encodes-apostrophe")&&(a=a.replace(/'/g,"%27"));const i=r.length+1+a.length;let l;d="delete"===o.method||"post"===o.method||"put"===o.method||!!o.body||i>D.maxUrlLength;const u=o.useProxy||!!f(r);if(u){const e=w(r);l=e.path,!d&&l.length+1+i>D.maxUrlLength&&(d=!0),e.query&&(n={...e.query,...n})}if("HEAD"===s.method&&(d||u)){if(d){if(i>D.maxUrlLength)throw N("request:invalid-parameters",new Error("URL exceeds maximum length"),e.params);throw N("request:invalid-parameters",new Error("cannot use POST request when method is 'head'"),e.params)}if(u)throw N("request:invalid-parameters",new Error("cannot use proxy when method is 'head'"),e.params)}if(d?(s.method="delete"===o.method?"DELETE":"put"===o.method?"PUT":"POST",o.body?r=y(r,n):(s.body=h(n),s.headers["Content-Type"]="application/x-www-form-urlencoded")):r=y(r,n),u&&(e.useProxy=!0,r=`${l}?${r}`),n.token&&_&&s.body instanceof FormData){const e=s.body;e.set?e.set("token",n.token):e.append("token",n.token)}if(o.hasOwnProperty("withCredentials"))e.withCredentials=o.withCredentials;else if(!g(r,b))if(c(r))e.withCredentials=!0;else if(L){const t=L.findServerInfo(r);t&&t.webTierAuth&&(e.withCredentials=!0)}e.withCredentials&&(s.credentials="include")}let T,x,S=0,E=!1;u>0&&(S=setTimeout((()=>{E=!0,e.controller.abort()}),u));try{if("image"!==o.responseType||"default"!==s.cache||"GET"!==s.method||d||J(o.headers)||!n&&!e.useProxy&&D.proxyUrl&&!B(r)){if(T=await U._abortableFetch(r,s),e.useProxy||H(r),T.ok&&"HEAD"!==s.method){switch(l){case"array-buffer":x=await T.arrayBuffer();break;case"blob":case"image":x=await T.blob();break;default:x=await T.text()}if(S&&(clearTimeout(S),S=0),"json"===l||"xml"===l||"document"===l)if(x)switch(l){case"json":x=JSON.parse(x);break;case"xml":x=X(x,"application/xml");break;case"document":x=X(x,"text/html")}else x=null;if(x){if("array-buffer"===l||"blob"===l){const e=T.headers.get("Content-Type");if(/application\/json|text\/plain/i.test(e)&&x["blob"===l?"size":"byteLength"]<=750)try{const e=await new Response(x).json();e.error&&(x=e)}catch{}}"image"===l&&x instanceof Blob&&(x=await Y(URL.createObjectURL(x),e,!0))}}}else x=await Y(r,e)}catch(v){if("AbortError"===v.name){if(E)throw new Error("Timeout exceeded");throw C("Request canceled")}if(!(!T&&v instanceof TypeError&&D.proxyUrl)||o.body||"delete"===o.method||"head"===o.method||"post"===o.method||"put"===o.method||e.useProxy)throw v;e.redoRequest=!0,q({proxyUrl:D.proxyUrl,urlPrefix:k(O(r).path)})}finally{S&&clearTimeout(S)}return[T,x]}async function z(e,t){if(null!=e.responseData)return e.responseData;if(e.headers&&(t.requestOptions.headers={...t.requestOptions.headers,...e.headers}),e.query&&(t.requestOptions.query={...t.requestOptions.query,...e.query}),e.before){let o,s;try{s=await e.before(t)}catch(r){o=N("request:interceptor",r,t)}if((s instanceof Error||s instanceof n)&&(o=N("request:interceptor",s,t)),o)throw e.error&&e.error(o),o;return s}}function J(e){if(e)for(const t of Object.getOwnPropertyNames(e))if(e[t])return!0;return!1}function X(e,t){let r;try{r=(new DOMParser).parseFromString(e,t)}catch{}if(!r||r.getElementsByTagName("parsererror").length)throw new SyntaxError("XML Parse error");return r}async function Q(e){let t,r;await K(e);try{do{[t,r]=await G(e)}while(!await V(e,t,r))}catch(n){const r=N("request:server",n,e.params,t);throw r.details.ssl=e.useSSL,e.interceptor&&e.interceptor.error&&e.interceptor.error(r),r}const o=e.params.url;if(/\/sharing\/rest\/(accounts|portals)\/self/i.test(o)&&!e.hasToken&&!e.credentialToken&&r&&r.user&&r.user.username&&!c(o)){const e=d(o,!0);e&&D.trustedServers.push(e)}const s=e.credential;if(s&&L){const e=L.findServerInfo(s.server);let t=e&&e.owningSystemUrl;if(t){t=t.replace(/\/?$/,"/sharing");const e=L.findCredential(t,s.userId);e&&-1===L._getIdenticalSvcIdx(t,e)&&e.resources.unshift(t)}}return{data:r,getHeader:t?e=>t.headers.get(e):R,requestOptions:e.params.requestOptions,ssl:e.useSSL,url:e.params.url}}async function V(e,t,r){if(e.redoRequest)return e.redoRequest=!1,!1;if(!t)return!0;if(!t.ok)throw new Error(`Unable to load ${t.url} status: ${t.status}`);let o,s,n,a;r&&r.error&&(o=Object.assign(new Error,r.error)),o&&(s=Number(o.code),n=o.hasOwnProperty("subcode")?Number(o.subcode):null,a=o.messageCode,a=a&&a.toUpperCase());const i=e.params.requestOptions.authMode;if(403===s&&(4===n||o.message&&o.message.toLowerCase().indexOf("ssl")>-1&&-1===o.message.toLowerCase().indexOf("permission"))){if(!e.useSSL)return e.useSSL=!0,!1}else if(!e.hasToken&&e.useIdentity&&("no-prompt"!==i||498===s)&&-1!==F.indexOf(s)&&!W(e.params.url)&&(403!==s||-1===I.indexOf(a)&&(null==n||2===n&&e.credentialToken))){await $();try{const t=await L.getCredential(e.params.url,{error:N("request:server",o,e.params),prompt:"no-prompt"!==i,signal:e.controller.signal,token:e.credentialToken});return e.credential=t,e.credentialToken=t.token,e.useSSL=e.useSSL||t.ssl,!1}catch(l){if("no-prompt"===i)return e.credential=null,e.credentialToken=null,!1;o=l}}if(o)throw o;return!0}function Y(e,t,r=!1){const o=t.controller.signal,s=new Image;return t.withCredentials?s.crossOrigin="use-credentials":s.crossOrigin="anonymous",s.alt="",s.src=e,j(s,e,r,o)}U._abortableFetch=null,U._corsServers=["https://server.arcgisonline.com","https://services.arcgisonline.com"];export default U;
