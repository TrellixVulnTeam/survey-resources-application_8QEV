/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import e from"../core/has.js";import{all as t,create as r}from"../core/promiseUtils.js";import{M as n}from"./languageUtils.js";import{findScriptDependencies as s,findFunctionCalls as i}from"../arcade/treeAnalysis.js";import{compileScript as u,extend as c,enableAsyncSupport as o}from"../arcade/arcadeCompiler.js";import{extend as a,executeScript as f,referencesMember as p,referencesFunction as l}from"../arcade/arcadeRuntime.js";import{parseScript as m,validateScript as d,scriptCheck as y,extractFieldLiterals as S}from"../arcade/parser.js";import{loadMoment as h}from"../intl/moment.js";function j(){if(e("csp-restrictions"))return!1;try{return new Function("function* test() {}; return true")()}catch(t){return!1}}const A=j();let x=!1,b=!1,g=null,F=[];function E(t,r){if(!0===r.useAsync||!0===t.isAsync)return v(t,r);if(e("csp-restrictions")){return function(e){return f(t,e)}}return u(t,r)}function v(t,r){if(null===g)throw new Error("Async Arcade must be enabled for this script");if(e("csp-restrictions")||!1===A){return function(e){return g.executeScript(t,e)}}return u(t,r,!0)}function G(e){a(e),c(e,"sync"),null===g?F.push(e):(c(e,"async"),g.extend(e))}function w(e,t=[]){return m(e,t)}function U(e,t,r=""){return d(e,t,r)}function M(e,t,r,n=""){return y(e,t,r,n)}function _(e,t,r=[]){return k(m(e,r),t)}function k(e,t){if(!0===t.useAsync||!0===e.isAsync){if(null===g)throw new Error("Async Arcade must be enabled for this script");return g.executeScript(e,t)}return f(e,t)}function C(e,t){return p(e,t)}function O(e,t){return l(e,t)}function L(e,t=!1){return S(e)}function R(e,t=[]){return void 0===e.usesGeometry&&s(e,t),!0===e.usesGeometry}let q=null;function z(){return q||(q=t([import("../geometry/geometryEngine.js"),import("../arcade/functions/geomsync.js")]).then((([e,t])=>(b=!0,t.setGeometryEngine(e),!0))),q)}let D=null;function I(){return null!==D||(D=o().then((()=>import("../arcade/arcadeAsyncRuntime.js"))).then((e=>{g=e;for(const t of F)g.extend(t),c(t,"async");return F=null,!0}))),D}function T(){return x}function B(){return!!g}function H(){return b}let J=null;function K(){return J||(J=I().then((()=>t([import("../arcade/featureSetUtils.js"),import("../arcade/functions/featuresetbase.js"),import("../arcade/functions/featuresetgeom.js"),import("../arcade/functions/featuresetstats.js"),import("../arcade/functions/featuresetstring.js")]).then((([e,t,r,n,s])=>(X=e,g.extend([t,r,n,s]),c([t,r,n,s],"async"),x=!0,!0))))),J)}function N(e,t=[]){return void 0===e.usesFeatureSet&&s(e,t),!0===e.usesFeatureSet}function P(e,t=[]){return void 0===e.isAsync&&s(e,t),!0===e.isAsync}function Q(e,t){if(t){for(const r of t)if(C(e,r))return!0;return!1}return!1}function V(e,n,s=[],i=!1){return r(((r,u)=>{const c="string"==typeof e?w(e):e,o=[];o.push(Z()),c&&(!1===H()&&(R(c)||i)&&o.push(z()),!1===B()&&(!0===c.isAsync||n)&&o.push(I()),!1===T()&&(N(c)||Q(c,s))&&o.push(K())),o?t(o).then((()=>{r(!0)}),u):r(!0)}))}function W(e){if(R(e))return!0;const t=i(e);return t.indexOf("geometry")>-1||t.indexOf("feature")>-1}let X=null;function Y(){return X}function Z(){return null!==$||($=h().then((e=>(n.Moment=e,!0)))),$}let $=null;var ee=Object.freeze({__proto__:null,compileScript:E,extend:G,parseScript:w,validateScript:U,scriptCheck:M,parseAndExecuteScript:_,executeScript:k,referencesMember:C,referencesFunction:O,extractFieldLiterals:L,scriptUsesGeometryEngine:R,enableGeometrySupport:z,enableAsyncSupport:I,isFeatureSetSupportEnabled:T,isAsyncEnabled:B,isGeometryEnabled:H,enableFeatureSetSupport:K,scriptUsesFeatureSet:N,scriptIsAsync:P,loadScriptDependencies:V,scriptTouchesGeometry:W,featureSetUtils:Y,load:Z});export{L as a,z as b,E as c,K as d,k as e,Y as f,ee as g,G as h,M as i,_ as j,O as k,V as l,I as m,T as n,B as o,w as p,H as q,C as r,R as s,N as t,P as u,U as v,W as w,Z as x};
