/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{_ as r}from"./chunks/tslib.es6.js";import"./core/has.js";import{typeCast as e}from"./core/compilerUtils.js";import{clone as o}from"./core/lang.js";import t from"./core/Logger.js";import{Integer as s}from"./core/accessorSupport/ensureType.js";import{property as a}from"./core/accessorSupport/decorators/property.js";import{subclass as i}from"./core/accessorSupport/decorators/subclass.js";import{writer as n}from"./core/accessorSupport/decorators/writer.js";import l from"./core/Error.js";import"./core/urlUtils.js";import"./core/uuid.js";import"./portal/support/resourceExtension.js";import{throwIfAborted as p,eachAlways as c}from"./core/promiseUtils.js";import{JSONSupportMixin as u}from"./core/JSONSupport.js";import y from"./core/Collection.js";import d from"./Color.js";import{transparencyToOpacity as m,opacityToTransparency as f}from"./webdoc/support/opacityUtils.js";import{referenceSetter as h}from"./core/collectionUtils.js";import v from"./core/Loadable.js";import{loadAll as g}from"./core/loadAll.js";import{NavigationConstraint as j}from"./ground/NavigationConstraint.js";var w;const C=t.getLogger("esri.Ground");let S=w=class extends(u(v)){constructor(r){super(r),this.opacity=1,this.surfaceColor=null,this.navigationConstraint=null,this.layers=new y;const e=r=>{r.parent&&r.parent!==this&&"remove"in r.parent&&r.parent.remove(r),r.parent=this,"elevation"!==r.type&&"base-elevation"!==r.type&&C.error(`Layer '${r.title}, id:${r.id}' of type '${r.type}' is not supported as a ground layer and will therefore be ignored. Only layers of type 'elevation' are supported.`)},o=r=>{r.parent=null};this.layers.on("after-add",(r=>e(r.item))),this.layers.on("after-remove",(r=>o(r.item)))}initialize(){this.when().catch((r=>{C.error("#load()","Failed to load ground",r)})),this.resourceInfo&&this.read(this.resourceInfo.data,this.resourceInfo.context)}destroy(){const r=this.layers.removeAll();for(const e of r)e.destroy();this.layers.destroy()}normalizeCtorArgs(r){return r&&"resourceInfo"in r&&(this._set("resourceInfo",r.resourceInfo),delete(r={...r}).resourceInfo),r}set layers(r){this._set("layers",h(r,this._get("layers")))}writeLayers(r,o,t,s){const a=[];r?(s={...s,layerContainerType:"ground"},r.forEach((r=>{if("write"in r){const o={};e(r)().write(o,s)&&a.push(o)}else s&&s.messages&&s.messages.push(new l("layer:unsupported",`Layers (${r.title}, ${r.id}) of type '${r.declaredClass}' cannot be persisted in the ground`,{layer:r}))})),o.layers=a):o.layers=a}load(r){return this.addResolvingPromise(this._loadFromSource(r)),Promise.resolve(this)}loadAll(){return g(this,(r=>{r(this.layers)}))}async queryElevation(r,e){await this.load({signal:null==e?void 0:e.signal});const{ElevationQuery:o}=await import("./layers/support/ElevationQuery.js");p(e);const t=new o,s=this.layers.filter(L).toArray();return t.queryAll(s,r,e)}async createElevationSampler(r,e){await this.load({signal:null==e?void 0:e.signal});const{ElevationQuery:o}=await import("./layers/support/ElevationQuery.js");p(e);const t=new o,s=this.layers.filter(L).toArray();return t.createSamplerAll(s,r,e)}clone(){const r={opacity:this.opacity,surfaceColor:o(this.surfaceColor),navigationConstraint:o(this.navigationConstraint),layers:this.layers.slice()};return this.loaded&&(r.loadStatus="loaded"),new w({resourceInfo:this.resourceInfo}).set(r)}read(r,e){this.resourceInfo||this._set("resourceInfo",{data:r,context:e}),super.read(r,e)}_loadFromSource(r){const e=this.resourceInfo;return e?this._loadLayersFromJSON(e.data,e.context,r):Promise.resolve(null)}_loadLayersFromJSON(r,e,o){const t=e&&e.origin||"web-scene",s=e&&e.portal||null,a=e&&e.url||null;return import("./layers/support/layersCreator.js").then((({populateOperationalLayers:e})=>{p(o);const i=[];if(r.layers&&Array.isArray(r.layers)){const o={context:{origin:t,url:a,portal:s,layerContainerType:"ground"},defaultLayerType:"ArcGISTiledElevationServiceLayer"};i.push(e(this.layers,r.layers,o))}return c(i)})).then((()=>{}))}};function I(r){return r&&"createElevationSampler"in r}function L(r){return"elevation"===r.type||I(r)}r([a({json:{read:!1}})],S.prototype,"layers",null),r([n("layers")],S.prototype,"writeLayers",null),r([a({readOnly:!0})],S.prototype,"resourceInfo",void 0),r([a({type:Number,nonNullable:!0,range:{min:0,max:1},json:{type:s,read:{reader:m,source:"transparency"},write:{writer:(r,e)=>{e.transparency=f(r)},target:"transparency"}}})],S.prototype,"opacity",void 0),r([a({type:d,json:{type:[s],write:(r,e)=>{e.surfaceColor=r.toJSON().slice(0,3)}}})],S.prototype,"surfaceColor",void 0),r([a({type:j,json:{write:!0}})],S.prototype,"navigationConstraint",void 0),S=w=r([i("esri.Ground")],S);var A=S;export default A;
