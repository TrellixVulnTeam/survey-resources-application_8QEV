/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import"../../core/has.js";import t from"../../core/Logger.js";import"../../core/accessorSupport/ensureType.js";import{property as r}from"../../core/accessorSupport/decorators/property.js";import{aliasOf as a}from"../../core/accessorSupport/decorators/aliasOf.js";import{subclass as o}from"../../core/accessorSupport/decorators/subclass.js";import i from"../../core/Error.js";import"../../core/urlUtils.js";import"../../core/uuid.js";import"../../portal/support/resourceExtension.js";import s from"../../core/Evented.js";import n from"../../core/Collection.js";import{on as l,watch as d,whenFalseOnce as p}from"../../core/watchUtils.js";import{HandleOwnerMixin as c}from"../../core/HandleOwner.js";import u from"../../layers/GraphicsLayer.js";import w from"../Attachments/AttachmentsViewModel.js";import f from"../Spinner/SpinnerViewModel.js";import h from"../../views/interactive/snapping/SnappingOptions.js";import m from"../FeatureForm/FeatureFormViewModel.js";import y from"../FeatureTemplates/FeatureTemplatesViewModel.js";import{isEditableLayer as k}from"../../layers/graphics/editingSupport.js";import v from"./CreateWorkflow.js";import g from"./UpdateWorkflow.js";import W from"../Sketch/SketchViewModel.js";const _="esri.widgets.Editor.EditorViewModel",b=t.getLogger(_),j=["create","update"];function V(e,t,r){b.error(new i(e,t,r))}function C(e){return e&&k(e.layer)}function M(e,t){return e&&e.find((e=>e.layer===t))}const F="all-layer-views-prop-watcher";let U=class extends(c(s.EventedAccessor)){constructor(e){super(e),this._sketchGraphicsLayer=new u({listMode:"hide",internal:!0}),this.activeWorkflow=null,this.activityQueue=[],this.failures=[],this.attachmentsViewModel=new w({abilities:{editing:!0}}),this.featureFormViewModel=new m,this.featureTemplatesViewModel=new y,this.layerInfos=null,this.sketchViewModel=new W({layer:this._sketchGraphicsLayer}),this.snappingOptions=new h,this.spinnerViewModel=new f}initialize(){this.handles.add([l(this,"activeWorkflow","cancel",(()=>this.emit("workflow-cancel"))),l(this,"activeWorkflow","commit",(()=>this.emit("workflow-commit"))),l(this,"view.allLayerViews","change",(()=>{this.handles.remove(F),this.notifyChange("editableItems")})),d(this,"editableItems",(()=>{const{activeWorkflow:e}=this;if(!e)return;const{stepId:t}=e;if("create"===e.type)return this.refreshCreationTemplates(),void("awaiting-feature-creation-info"!==t||this.canCreate||this._cancelWorkflow());"update"===e.type&&("awaiting-feature-to-update"===t&&!this.canUpdate||"awaiting-update-feature-candidate"===t&&!e.data.candidates.some((e=>{const t=this.editableItems.find((t=>t.layer===e.layer));return t&&t.supports.indexOf("update")>-1})))&&this._cancelWorkflow()}))])}destroy(){this._cancelWorkflow().then((()=>this.view=null))}get allowedWorkflows(){return this._get("allowedWorkflows")}set allowedWorkflows(e){e&&0!==e.length||(e=[...j]),this._set("allowedWorkflows",e)}get canCreate(){return this.editableItems.some((e=>e.supports.indexOf("create")>-1))}get canUpdate(){return this.editableItems.some((e=>e.supports.indexOf("update")>-1))}get editableItems(){const e=this.get("view.allLayerViews");if(!e)return new n;const t=()=>this.notifyChange("editableItems");return e.filter(C).map((e=>{this.handles.add(d(e,["suspended","layer.editingEnabled"],t),F);const{layer:r,suspended:a}=e,{data:o,operations:i}=r.capabilities,s=M(this.layerInfos,r),n="supportsAttachment"in o&&o.supportsAttachment&&(!s||!1!==s.allowAttachments);if(a)return{hasAttachments:n,layer:r,supports:[]};const l=this.allowedWorkflows.filter((e=>!s||!1!==s.enabled&&("create"===e&&!1!==s.addEnabled||"update"===e&&!1!==s.updateEnabled))),p=e=>l.find((t=>t===e)),c=[];return p("create")&&i.supportsAdd&&c.push("create"),p("update")&&i.supportsUpdate&&c.push("update"),!1!==(s&&s.deleteEnabled)&&i.supportsDelete&&c.push("delete"),{hasAttachments:n,layer:r,supports:c}})).reverse()}get state(){if(!this.get("view.ready")||0===this.editableItems.length)return"disabled";const e=this.attachmentsViewModel.mode;if("add"===e)return"adding-attachment";if("edit"===e)return"editing-attachment";const{activeWorkflow:t}=this;return t?t.stepId:"ready"}get syncing(){return this.activityQueue.length>0}set view(e){this.sketchViewModel.view=e,this.spinnerViewModel.view=e,this._set("view",e)}async startCreateWorkflowAtFeatureTypeSelection(){if(!this.canCreate)return void V("editing:unsupported-workflow","Create workflow is unsupported or disabled.");await this._cancelWorkflow();const e=this._createCreateWorkflow();await e.start(),this._set("activeWorkflow",e)}async startCreateWorkflowAtFeatureCreation(e){if(!this.canCreate)return void V("editing:unsupported-workflow","Update workflow is unsupported or disabled.");await this._cancelWorkflow();const t=this._createCreateWorkflow("awaiting-feature-to-create");t.data.creationInfo=e,await t.start(),this._set("activeWorkflow",t)}async startCreateWorkflowAtFeatureEdit(e){if(!this.canCreate)return void V("editing:unsupported-workflow","Update workflow is unsupported or disabled.");await this._cancelWorkflow();const t=this._createCreateWorkflow("editing-new-feature");t.data.edits.feature=e,await t.start(),this._set("activeWorkflow",t)}async startUpdateWorkflowAtFeatureSelection(){if(!this.canUpdate)return void V("editing:unsupported-workflow","Update workflow is unsupported or disabled.");await this._cancelWorkflow();const e=this._createUpdateWorkflow();await e.start(),this._set("activeWorkflow",e)}async startUpdateWorkflowAtMultipleFeatureSelection(e){if(!this.canUpdate)return void V("editing:unsupported-workflow","Update workflow is unsupported or disabled.");await this._cancelWorkflow();const t=this._createUpdateWorkflow("awaiting-update-feature-candidate");t.data.candidates=e,await t.start(),this._set("activeWorkflow",t)}async startUpdateWorkflowAtFeatureEdit(e){if(!this.canUpdate)return void V("editing:unsupported-workflow","Update workflow is unsupported or disabled.");await this._cancelWorkflow();const t=this._createUpdateWorkflow("editing-existing-feature");t.data.edits.feature=e,await t.start(),this._set("activeWorkflow",t)}async deleteFeatureFromWorkflow(){const{activeWorkflow:e}=this;e&&"create"!==e.type?(await this._delete(e.data.edits.feature),await e.reset()):V("editing:unsupported-workflow","Deleting requires an active update workflow.")}async cancelWorkflow(e){return this._cancelWorkflow({warn:!0,...e})}refreshCreationTemplates(){this.featureTemplatesViewModel.layers=this.editableItems.filter((({supports:e})=>e.indexOf("create")>-1)).map((({layer:e})=>e)).toArray()}async _cancelWorkflow(e){const t=this.activeWorkflow;if(!t)return void(e&&e.warn&&V("editing:no-active-workflow","There is no active workflow to cancel."));if(!e||!1!==e.force)return this.emit("workflow-cancel"),this._set("activeWorkflow",null),void await t.cancel(e);await t.cancel(e),this._set("activeWorkflow",null)}_createCreateWorkflow(e){return v.create(this,e,(e=>this._create(e)))}_createUpdateWorkflow(e){return g.create(this,e,(e=>this._update(e)))}async _create(e){await this._applyEdits(e.layer,{addFeatures:[e]})}async _delete(e){await this._applyEdits(e.layer,{deleteFeatures:[e]})}async _update(e){await this._applyEdits(e.layer,{updateFeatures:[e]})}async _applyEdits(e,t){await this._queueOperation((()=>e.applyEdits(t)));const r=await this.view.whenLayerView(e);await p(r,"updating")}_queueOperation(e){this.activityQueue.push(e),this.notifyChange("syncing");const t=(e,t)=>{const r=t.indexOf(e);r>-1&&t.splice(r,1)};return e().then((({addFeatureResults:e,deleteFeatureResults:t,updateFeatureResults:r})=>{const a=e.find((e=>!!e.error))||r.find((e=>!!e.error))||t.find((e=>!!e.error));if(a)throw a.error})).catch((r=>{V("editing:operation-error","An error occurred.",{error:r});const a={error:r,retry:()=>(t(a,this.failures),this._queueOperation(e)),cancel:()=>{t(a,this.failures)}};this._set("failures",[...this.failures,a])})).then((()=>{t(e,this.activityQueue),this.notifyChange("syncing")}))}};e([r({readOnly:!0})],U.prototype,"activeWorkflow",void 0),e([r({readOnly:!0})],U.prototype,"activityQueue",void 0),e([r({value:[...j]})],U.prototype,"allowedWorkflows",null),e([r({readOnly:!0})],U.prototype,"canCreate",null),e([r({readOnly:!0})],U.prototype,"canUpdate",null),e([r({readOnly:!0})],U.prototype,"editableItems",null),e([r({readOnly:!0})],U.prototype,"failures",void 0),e([r()],U.prototype,"attachmentsViewModel",void 0),e([r()],U.prototype,"featureFormViewModel",void 0),e([r()],U.prototype,"featureTemplatesViewModel",void 0),e([r()],U.prototype,"layerInfos",void 0),e([r()],U.prototype,"sketchViewModel",void 0),e([a("sketchViewModel.snappingOptions")],U.prototype,"snappingOptions",void 0),e([r()],U.prototype,"spinnerViewModel",void 0),e([r()],U.prototype,"state",null),e([r({readOnly:!0})],U.prototype,"syncing",null),e([r()],U.prototype,"view",null),U=e([o(_)],U);var O=U;export default O;
