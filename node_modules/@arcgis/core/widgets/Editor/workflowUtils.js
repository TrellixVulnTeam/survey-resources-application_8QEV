/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import"../../core/has.js";import{isNone as e,isSome as t}from"../../core/maybe.js";import{whenOrAbort as r,eachAlways as a}from"../../core/promiseUtils.js";import{hasField as i}from"../../layers/support/fieldUtils.js";import{px2pt as n}from"../../core/screenUtils.js";import s from"../../Graphic.js";import{meterIn as o}from"../../renderers/support/lengthUtils.js";import{getTransformationType as l}from"../../renderers/visualVariables/support/sizeVariableUtils.js";import{getVisualVariableValues as c}from"../../renderers/visualVariables/support/visualVariableUtils.js";import{to3D as u}from"../../symbols/support/symbolConversion.js";import{diff as p}from"../../core/accessorSupport/diffUtils.js";import{getDisplayedSymbol as y}from"../../symbols/support/symbolUtils.js";import{hitTestSelectSameDistance as d}from"../../views/support/hitTestSelectUtils.js";import{calculateTolerance as f}from"../../renderers/support/clickToleranceUtils.js";import{createQueryGeometry as m}from"../../views/support/drapedUtils.js";function b(e){const t=e.layer,r=I(t.renderer)&&c(t.renderer,e),a=r?r.map((e=>e.variable)):[],i=a.filter((e=>"rotation"===e.type&&(!e.axis||"heading"===e.axis))),n=i[0],s=1===i.length&&n.field&&!n.valueExpression,o=a.filter((e=>"size"===e.type)),u=o[0],p=1===o.length&&"real-world-size"===l(u)&&u.field&&!u.useSymbolValue&&!u.valueExpression;return{rotation:s?g(n,t):null,size:p?w(u,t):null}}function g(e,t){const r="heading"===(e.axis||"heading")&&"arithmetic"===e.rotationType?-1:1,a=e.field,i=t.fields&&t.fields.filter((e=>e.name===a)),n=i&&1===i.length?i[0].type:"double",s={initial:0,current:0};return{field:a,getDefault:()=>Promise.resolve(0),getValue:e=>(s.current=s.initial-r*e,j((s.current+360)%360,n)),initValue:e=>{s.initial=null!=e?e:s.current,s.current=0},isUpdatingInteractively:!1}}function h(e,t){switch(t){case"width":return e[0];case"depth":return e[1];case"height":return e[2];default:return e[2]||e[1]||e[0]}}async function v(t,r,a){if(e(r))return 0;const{symbol:i}=u(r);if(e(i)||"web-style"===i.type)return 0;const n=i.symbolLayers.getItemAt(0);if(!n)return 0;switch(n.type){case"icon":{const{computeIconLayerResourceSize:e}=await import("../../symbols/support/symbolLayerUtils.js");return n.size||Math.min(E.icon,(await e(n,E.icon))[0])||E.icon}case"text":return n.size||E.text;case"line":return n.size||E.line;case"object":{const{computeObjectLayerResourceSize:e}=await import("../../symbols/support/symbolLayerUtils.js");return h(await e(n,t.scale/E.viewScaleSizeFactor),a)}case"path":case"extrude":return n.size||t.scale/E.viewScaleSizeFactor;case"fill":case"water":default:return 0}}function w(e,t){const r=e.field,a=e.axis,i=t.fields&&t.fields.filter((e=>e.name===r)),n=i&&1===i.length?i[0].type:"double",s={updating:!1,initial:0,current:0},l=o[e.valueUnit];let c;return c="area"===e.valueRepresentation?e=>(e*l/2)**2*Math.PI:"radius"===e.valueRepresentation||"distance"===e.valueRepresentation?e=>e*l/2:e=>e*l,{field:r,getDefault:async(e,t)=>j(c(await v(t,e,a)),n),getValue:(e,t)=>(s.initial||(s.initial=t.pixelSizeAt(t.center)),s.current=s.initial*e,j(s.current,n)),initValue:e=>{s.initial=null!=e?e:s.current,s.current=0},isUpdatingInteractively:!1}}function j(e,t){switch(t){case"small-integer":case"integer":case"long":return Math.round(e);case"double":case"single":return e;default:return 0}}function I(e){switch(e.type){case"class-breaks":case"simple":case"unique-value":case"dot-density":case"dictionary":return!0;default:return!1}}async function S(e){const r=await y(e,{ignoreGraphicSymbol:!0}),a=p(e.symbol,r);t(a)&&(e.symbol=r)}async function U(e,t,r,a){const i=t.layer;await V(e,t,r),e.layer.elevationInfo=i.elevationInfo;const n=()=>e.create(i.geometryType,{hasZ:i.capabilities.data.supportsZ});await n();const s=e.on("create",(async r=>{const{state:s,graphic:o}=r;if("cancel"!==s){if("complete"===s){const r=o.clone();r.attributes={...t.template.prototype.attributes},r.layer=i,e.layer.remove(o),await S(r),a(r)}}else n()}));return r.map.add(e.layer),{remove:()=>{s.remove(),r.map.remove(e.layer),e.cancel()}}}async function V(t,r,a){var i;if("3d"!==a.type)return;const n=r.layer,o={...r.template.prototype.attributes},l=new s({layer:n,sourceLayer:n,attributes:o}),{rotation:c,size:u}=b(l);let p=await y(l),d=!1;for(const s of[u,c]){if(e(s))continue;null==o[s.field]&&(o[s.field]=await s.getDefault(p,a),d=!0)}switch(d&&(p=await y(l)),null==(i=p)?void 0:i.type){case"simple-fill":case"polygon-3d":t.polygonSymbol=p;break;case"simple-line":case"line-3d":t.polylineSymbol=p;break;case"simple-marker":case"point-3d":t.pointSymbol=p}}function x(e,t){return e&&e.find((e=>e.layer===t))}async function z(e,t,n,s){if(0===e.length)return[];const{updatable:o,graphicsByLayer:l}=await n.async((async()=>{const{results:a}=await r(d(t,n),s),i=new Map,o=({layer:e})=>{const t=i.get(e);if(!t){const t=new Array;return i.set(e,t),t}return t};a.forEach((({graphic:e})=>o(e).push(e)));const l=e.filter((({supports:e,layer:t})=>e.indexOf("update")>-1&&i.has(t)));return 0!==l.length&&n.stopPropagation(),{updatable:l,graphicsByLayer:i}}));return r(a(o.map((async({layer:e})=>{const{objectIdField:t,displayField:r}=e,a=[t];i(e.fields,r)&&a.push(r);const n=l.get(e);if(!!n.some((e=>a.some((t=>!(t in e.attributes)))))){const t=e.createQuery();return t.outFields=a,t.returnGeometry=!1,t.objectIds=n.map((e=>e.getObjectId())),e.queryFeatures(t,{signal:s}).then((({features:e})=>e))}return n}))),s)}async function F(e,t,n,s){if(0===e.length)return[];const o=await n.async((async()=>{const{results:a}=await r(t.hitTest(n),s);if(0===a.length)return[];const i=new Set;a.forEach((({graphic:e})=>i.add(e.layer)));const o=e.items.filter((({layer:e,supports:t})=>t.indexOf("update")>-1&&i.has(e)));return o.length>0&&n.stopPropagation(),o}));return r(a(o.map((({layer:e})=>{const{objectIdField:r,displayField:a}=e,o=[r];i(e.fields,a)&&o.push(a);const l=e.createQuery();l.outFields=o,l.returnGeometry=!1;const c=f({renderer:e.renderer,event:n});return l.geometry=m(n.mapPoint,c,t),l.outSpatialReference=t.spatialReference,e.queryFeatures(l,{signal:s}).then((({features:e})=>e))}))),s)}async function L(e,t,r,a){switch(t.type){case"3d":return z(e,t,r,a);case"2d":return F(e,t,r,a)}}async function R(e,t,r){const a=e.layer,i=a.createQuery();return i.objectIds=[e.getAttribute(a.objectIdField)],i.outFields=["*"],i.outSpatialReference=t.spatialReference,i.returnM=a.capabilities.data.supportsM,i.returnZ=a.capabilities.data.supportsZ,(await a.queryFeatures(i,{signal:r})).features[0]}async function A(r,a,i,n,s){const o=r.clone();await S(o),i.layer.add(o),o.sourceLayer=r.layer;const l=(()=>{const{layer:e}=r;if("graphics"===e.type)return{remove(){}};const{objectIdField:t}=e,a=r.attributes[t],i=n.whenLayerView(e);return i.then((e=>e.setVisibility(a,!1)),(()=>{})),{remove(){i.then((e=>e.setVisibility(a,!0)),(()=>{}))}}})(),c=r.layer,u=a.size,p=a.rotation,y={multipleSelectionEnabled:!1};"point"===c.geometryType&&(y.enableRotation=!!p,y.enableScaling=!!u),i.layer.elevationInfo=c.elevationInfo,i.update(o,y);const d=(t(u)||t(p))&&r.watch("attributes",(async e=>{let r=!1;for(const a in e){const i=e[a];i!==o.attributes[a]&&(o.setAttribute(a,i),r=!0,t(u)&&!u.isUpdatingInteractively&&u.field===a&&u.initValue(i),t(p)&&!p.isUpdatingInteractively&&p.field===a&&p.initValue(i))}r&&"3d"===n.type&&await S(o)}));[p,u].forEach((async t=>{if(e(t))return;const a=r.attributes[t.field];if(null!=a)t.initValue(a);else{const e=await t.getDefault(o.symbol,n);t.initValue(e),o.setAttribute(t.field,e),"3d"===n.type&&await S(o)}}));const f=i.on("update",(async e=>{const{graphics:[r],state:a,toolEventInfo:l}=e;if("complete"===a)return void i.update(r,y);const c=l;if(t(p)&&c){const{field:e,getValue:t,initValue:r}=p;"rotate-stop"===c.type?(p.isUpdatingInteractively=!1,r()):null!=c.angle&&(p.isUpdatingInteractively=!0,o.attributes[e]=t(c.angle,n))}const d=l;if(t(u)&&d){const{field:e,getValue:t,initValue:r}=u;"scale-stop"===d.type?(u.isUpdatingInteractively=!1,r()):null!=d.xScale&&(u.isUpdatingInteractively=!0,o.attributes[e]=t(d.xScale,n))}"3d"===n.type&&await S(o),s(r.clone())})),m=i.on(["undo","redo"],(async e=>{const{graphics:[t]}=e;s(t.clone())}));n.map.add(i.layer);const b=()=>{};return{interactive:{remove(){m.remove(),f.remove(),i.cancel(),d&&d.remove(),this.remove=b}},visual:{remove(){l.remove(),n.map.remove(i.layer),i.layer.removeAll(),this.remove=b}}}}const E={icon:n(24),text:n(12),line:n(1),viewScaleSizeFactor:100};export{L as fetchCandidates,R as fetchFullFeature,x as findLayerInfo,b as getVisualVariableAttributes,U as setUpFeatureAdd,A as setUpGeometryUpdate,E as sizeDefaults};
