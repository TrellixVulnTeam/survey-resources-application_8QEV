/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import"../../core/has.js";import{isSome as t}from"../../core/maybe.js";import"../../core/Logger.js";import"../../core/accessorSupport/ensureType.js";import"../../core/accessorSupport/decorators/property.js";import{subclass as r}from"../../core/accessorSupport/decorators/subclass.js";import"../../core/urlUtils.js";import"../../core/uuid.js";import"../../portal/support/resourceExtension.js";import i from"./CreateWorkflowData.js";import o from"./Edits.js";import a from"./Workflow.js";import{setUpFeatureAdd as s,findLayerInfo as n,getVisualVariableAttributes as l,setUpGeometryUpdate as f}from"./workflowUtils.js";var c;function d(e){if(1!==e.length)return null;const[t]=e;if(!("items"in t))return t;{const e=t;if(1===e.items.length)return e.items[0]}return null}let u=c=class extends a{constructor(e){super(e),this.type="create"}static create(e,t,r){const a=new i({edits:new o,viewModel:e}),s=new c({data:a,afterCommit:r});return s._set("steps",this._createWorkflowSteps(s,t)),s}static _createWorkflowSteps(e,r="awaiting-feature-creation-info"){const{data:i,handles:o}=e,a={"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",async setUp(){i.creationInfo=null,i.edits.feature=null,o.add(i.viewModel.featureTemplatesViewModel.on("select",(({item:e})=>{i.creationInfo={layer:e.layer,template:e.template},i.viewModel.activeWorkflow.next()})),this.id)},async tearDown(){o.remove(this.id)}}),"awaiting-feature-to-create":()=>({id:"awaiting-feature-to-create",async setUp(){o.add(await s(i.viewModel.sketchViewModel,i.creationInfo,i.viewModel.view,(e=>{i.edits.feature=e,i.viewModel.activeWorkflow.next()})),this.id)},async tearDown(){o.remove(this.id)}}),"editing-new-feature":()=>({id:"editing-new-feature",async setUp(){const e=i.edits.feature,r=i.viewModel,a=n(r.layerInfos,e.layer),s=a&&a.fieldConfig;r.featureFormViewModel.set({feature:e,fieldConfig:s});const c=l(e),{interactive:d,visual:u}=await f(e,c,r.sketchViewModel,r.view,(({geometry:e,attributes:o})=>{if(t(c.rotation)){const{field:e}=c.rotation;r.featureFormViewModel.setValue(e,o[e])}if(t(c.size)){const{field:e}=c.size;r.featureFormViewModel.setValue(e,o[e])}i.edits.updateAttributes(o),i.edits.updateGeometry(e)}));o.add([i.viewModel.featureFormViewModel.on("value-change",(()=>{i.edits.updateAttributes(i.viewModel.featureFormViewModel.getValues()),e.attributes=i.edits.feature.attributes})),d,u],this.id)},async tearDown(){o.remove(this.id)}})};let c=!1;const u=["awaiting-feature-creation-info","awaiting-feature-to-create","editing-new-feature"].filter((e=>!!c||(c=e===r,c))).map((e=>a[e]()));i.viewModel.refreshCreationTemplates();const w=d(i.viewModel.featureTemplatesViewModel.items),[m]=u;if("awaiting-feature-creation-info"===m.id&&w){const{layer:e,template:t}=w;i.creationInfo={layer:e,template:t},u.shift()}return u}};u=c=e([r("esri.widgets.Editor.CreateWorkflow")],u);var w=u;export default w;
