/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{typeCast as e}from"../../../core/compilerUtils.js";import a from"../../../core/Error.js";import{throwIfAborted as t}from"../../../core/promiseUtils.js";import{isSpatialReferenceSupported as i}from"../../../views/support/spatialReferenceSupport.js";import{isTiledLayer as r}from"../../../layers/support/layerUtils.js";import n from"../../../views/3d/terrain/TilingScheme.js";import{checkIfTileInfoSupportedForView as o}from"../../../views/3d/terrain/terrainUtils.js";async function s(e,a={}){await c(e,a),t(a)}async function l(e,a={}){const{basemap:i,view:n}=e;if(await i.load(a),t(a),0===i.baseLayers.length)return;const o=i.baseLayers.getItemAt(0);if(!r(o))return;if(i.spatialReference){if(n.spatialReference.equals(i.spatialReference))return;p()}await o.load(a),t(a);const s=(o.get("supportedSpatialReferences")||[o.get("tileInfo.spatialReference")]).filter(Boolean);0!==s.length&&s.every((e=>!n.spatialReference.equals(e)))&&p()}function p(){throw new a("basemap-compatibility:incompatible-spatial-reference","Basemap spatial reference is not compatible with the view")}async function c(t,i){const{basemap:r,view:n}=t;if(await r.load(i),0===r.baseLayers.length)return;const o=m(r.baseLayers.concat(r.referenceLayers));if(o.length)throw o[0];const s=e(r.baseLayers.getItemAt(0))();try{await s.load(i)}catch(l){const e="basemap-compatibility:unknown-error",t="Unknown basemap compatibility error",{name:i=e,message:r=t,details:n}=l;throw new a(i,r,n)}f(s,n)}function m(e){const t=["ArcGISTiledImageServiceLayer","ArcGISTiledMapServiceLayer","OpenStreetMap","VectorTileLayer","WebTiledLayer"];return e.toArray().filter((e=>-1===t.indexOf(e.operationalLayerType))).map((e=>new a("basemap-compatibility:unsupported-basemap-layer-type","Unsupported basemap layer type ${operationalLayerType}",{layer:e,operationalLayerType:e.operationalLayerType||"unknown"})))}function f(e,t){const r=e.tileInfo;if(!r)return;const s=t.viewingMode;if(!s)return;if(!i(r.spatialReference,s))throw new a(`basemapgalleryitem:spatial-reference-unsupported-${s}`,`Basemap spatial reference is unsupported in ${s} mode`);if("global"===s){let t=o(r,e.fullExtent,null,1);if(t&&e.compatibleTileInfo256&&!o(e.compatibleTileInfo256,e.fullExtent,null,1)&&(t=null),t){const e=r.spatialReference.isWebMercator?"web-mercator":"wgs84";throw new a(`basemapgalleryitem:tiling-scheme-unsupported-${e}-global`,"Basemap tiling scheme is unsupported in global mode",{error:t})}}else if(n.checkUnsupported(r))throw new a("basemapgalleryitem:tiling-scheme-unsupported-local","Basemap tiling scheme is unsupported in local mode");const l=t.get("basemapTerrain.tilingScheme");if(l&&!l.compatibleWith(r)&&(!e.compatibleTileInfo256||!l.compatibleWith(e.compatibleTileInfo256)))throw new a("basemapgalleryitem:tiling-scheme-incompatible","Basemap tiling scheme is incompatible with the view")}export{l as default2DCompatibility,s as default3DCompatibility};
