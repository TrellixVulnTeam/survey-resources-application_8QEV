/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import"../core/has.js";import"../core/Logger.js";import{property as t}from"../core/accessorSupport/decorators/property.js";import{cast as i}from"../core/accessorSupport/decorators/cast.js";import{subclass as s}from"../core/accessorSupport/decorators/subclass.js";import"../core/urlUtils.js";import"../core/uuid.js";import"../portal/support/resourceExtension.js";import{on as l,eventKey as a}from"../core/events.js";import{formatNumber as n}from"../intl/number.js";import{substitute as r}from"../intl/substitute.js";import"../intl.js";import{init as c,whenTrue as o}from"../core/watchUtils.js";import{HandleOwnerMixin as d}from"../core/HandleOwner.js";import{closest as u}from"../core/domUtils.js";import{isRTL as m,storeNode as h}from"./support/widgetUtils.js";import{accessibleHandler as p}from"./support/decorators/accessibleHandler.js";import{messageBundle as v}from"./support/decorators/messageBundle.js";import{j as _}from"../chunks/index.js";import S from"./Widget.js";import g from"./support/Popover.js";import M from"./Slider.js";import{getScalePreviewSource as w,getScalePreviewSpriteBackgroundPosition as f}from"./ScaleRangeSlider/scalePreviewUtils.js";import b from"./ScaleRangeSlider/ScaleRanges.js";import y from"./ScaleRangeSlider/ScaleRangeSliderViewModel.js";const x={base:"esri-scale-range-slider",scaleIndicator:"esri-scale-range-slider__scale-indicator",scaleIndicatorIcon:"esri-scale-range-slider__scale-indicator-icon",scaleIndicatorContainer:"esri-scale-range-slider__scale-indicator-container",scaleMenuContainer:"esri-scale-range-slider__scale-menu-container",scaleMenuToggle:"esri-scale-range-slider__scale-menu-toggle",scaleMenuToggleIcon:"esri-scale-range-slider__scale-menu-toggle-icon",scaleMenuToggleActive:"esri-scale-range-slider__scale-menu-toggle--active",scaleMenu:"esri-scale-range-slider__scale-menu",scaleMenuList:"esri-scale-range-slider__scale-menu-list",scaleMenuListItem:"esri-scale-range-slider__scale-menu-item",scaleMenuListItemActive:"esri-scale-range-slider__scale-menu-item--active",scaleMenuScroller:"esri-scale-range-slider__scale-menu-scroller",scaleItemLabel:"esri-scale-range-slider__scale-item-label",scaleItemValue:"esri-scale-range-slider__scale-item-value",scaleItemValueEditable:"esri-scale-range-slider__scale-item-value--editable",scalePreview:"esri-scale-range-slider__scale-preview",scalePreviewThumbnail:"esri-scale-range-slider__scale-preview-thumbnail",slider:"esri-slider",expandIcon:"esri-icon-down",heading:"esri-widget__heading",hidden:"esri-hidden",input:"esri-input",button:"esri-button",disabled:"esri-disabled",widget:"esri-widget"},I={preview:!0},T={maximumFractionDigits:0},C=e=>`1:${n(e,T)}`,R=e=>{const t=/[^\d.\s]/g,i=e.replace(/.*\(/,"").replace(/\).*$/,"").replace(/.*:/,"").replace(t,"");return parseFloat(i)};let L=class extends(d(S)){constructor(e,t){super(e,t),this._activeMenu=null,this._activeMenuNode=null,this._activeMenuToggleNode=null,this._activeThumb=null,this._customMaxScale=-1,this._customMinScale=-1,this._focusedMenuItemIndex=-1,this._previewAutoCloseTimeoutId=null,this._previewPopover=new g({owner:this,placement:"top",anchorElement:()=>0===this._activeThumb?this._minThumbNode:this._maxThumbNode,offset:[0,16],renderContentFunction:this.renderScalePreview}),this._maxScaleMenuPopover=new g({owner:this,placement:"bottom-end",anchorElement:()=>this._activeMenuToggleNode,renderContentFunction:this.renderMaxScaleMenu}),this._minScaleMenuPopover=new g({owner:this,placement:"bottom-start",anchorElement:()=>this._activeMenuToggleNode,renderContentFunction:this.renderMinScaleMenu}),this._scaleMenuNode=null,this._slider=new M({thumbCreatedFunction:(e,t,i)=>{0===e&&(this._minThumbNode=i),1===e&&(this._maxThumbNode=i),this.own([l(i,"mouseenter",(()=>{const{visibleElements:{preview:t}}=this;this._activeThumb=e,this._previewPopover.open=t,this.scheduleRender()})),l(i,"mouseleave",(()=>{this._previewAutoCloseTimeoutId||(this._activeThumb=null,this._previewPopover.open=!1,this.scheduleRender())}))])}}),this.disabled=!1,this.label=void 0,this.layer=null,this.maxScale=null,this.maxScaleLimit=null,this.messages=null,this.minScale=null,this.minScaleLimit=null,this.region="US",this.view=null,this.viewModel=new y,this.visibleElements=I,this._handleScaleMenuToggleClick=e=>{const t=e.currentTarget,i=t.getAttribute("data-type"),s="menu-closing-click-handle";if(this.handles.remove(s),i===this._activeMenu)return this._setActiveMenu(null),void(this._activeMenuToggleNode=null);this._setActiveMenu(i),this._activeMenuToggleNode=t,this.handles.add(l(document,"mousedown",(e=>{const t=e.target,i=u(t,`.${x.scaleMenuToggle}`),l=i&&i.getAttribute("data-type");if(i&&l===this._activeMenu)return;!l&&this._scaleMenuNode&&!this._scaleMenuNode.contains(t)&&(this._setActiveMenu(null),this.handles.remove(s),this.scheduleRender())})),s)},this._afterMenuListCreate=e=>{this._activeMenuNode=e,e.children[0].focus({preventScroll:!0})},this._handleCustomScaleEntry=e=>{this._setScaleFromMenuSelection(e),this._customMaxScale=-1,this._customMinScale=-1},this._handleCustomScaleInputBlur=()=>{"max"===this._activeMenu?this._customMaxScale=-1:this._customMinScale=-1},this.handleCustomScaleInputKeyDown=e=>{const t=e.currentTarget,{handleCustomScaleSelect:i}=t["data-render-props"],{key:s,ctrlKey:l,metaKey:a}=e,{viewModel:{scaleRanges:n}}=this;if("Enter"===s){const s=R(t.value);return i(isNaN(s)?-1:n.clampScale(s)),e.preventDefault(),void e.stopPropagation()}if(s.length>1||l||a)return;/[:,.\d]/.test(s)||(e.preventDefault(),e.stopPropagation())},this._handleScaleMenuKeyDown=e=>{const t=a(e);if("Escape"===t||"Tab"===t)return this._setActiveMenu(null),void this._activeMenuToggleNode.focus();if("ArrowUp"!==t&&"ArrowDown"!==t)return;const i=this._activeMenuNode.children,s=this._focusedMenuItemIndex,l="ArrowUp"===t?(0===s?i.length:s)-1:(s+1)%i.length;e.preventDefault(),e.stopPropagation(),i[l].focus(),this._focusedMenuItemIndex=l}}initialize(){this.own([c(this,"viewModel",(e=>this._slider.viewModel=e?e.sliderViewModel:null)),c(this,"_interactive",(e=>{this._slider.disabled=!e,e||this._setActiveMenu(null)})),this._slider.on("thumb-drag",(({index:e})=>{const{visibleElements:{preview:t}}=this;this._activeThumb=e,this._previewPopover.open=t,clearTimeout(this._previewAutoCloseTimeoutId);const i=250;this._previewAutoCloseTimeoutId=setTimeout((()=>{this._previewAutoCloseTimeoutId=null,this._activeThumb=null,this._previewPopover.open=!1,this.scheduleRender()}),i)})),o(this,"view.stationary",(()=>this.scheduleRender()))])}destroy(){this._previewPopover.destroy(),this._previewPopover=null,this._maxScaleMenuPopover.destroy(),this._maxScaleMenuPopover=null,this._minScaleMenuPopover.destroy(),this._minScaleMenuPopover=null,this._slider.destroy(),this._slider=null}get _effectiveMaxScale(){return 0===this.maxScale?this.maxScaleLimit:this.maxScale}get _effectiveMinScale(){return 0===this.minScale?this.minScaleLimit:this.minScale}get _interactive(){return"disabled"!==this.get("viewModel.state")&&!this.disabled}castVisibleElements(e){return{...I,...e}}render(){const{_interactive:e,_slider:t,label:i,messages:s,view:l,viewModel:{scaleRanges:a,state:n}}=this,r=s.scaleRangeLabels[a.findScaleRangeByIndex(t.values[0]).id],c=s.scaleRangeLabels[a.findScaleRangeByIndex(t.values[1]).id];return t.layout=m()?"horizontal-reversed":"horizontal",_("div",{"aria-label":i,class:this.classes(x.base,x.widget,e?null:x.disabled)},"ready"===n&&l?this.renderCurrentScaleIndicator():null,t.render(),_("div",{class:x.scaleMenuContainer,key:"scale-menu-toggles"},this.renderScaleMenuToggle("min",r),this.renderScaleMenuToggle("max",c)))}renderMinScaleMenu(){const{_effectiveMaxScale:e,minScaleLimit:t,view:i,viewModel:{scaleRanges:s}}=this,l=i?i.scale:void 0;return this.renderScaleMenu({type:"min",min:t,max:s.findScaleRange(e).minScale,map:l})}renderMaxScaleMenu(){const{_effectiveMinScale:e,maxScaleLimit:t,view:i,viewModel:{scaleRanges:s}}=this,l=i?i.scale:void 0;return this.renderScaleMenu({type:"max",min:s.findScaleRange(e).maxScale,max:t,map:l})}renderScalePreview(){const{_activeThumb:e,_slider:t,region:i,viewModel:{scaleRanges:s}}=this,l=0===e?t.values[0]:t.values[1],a=Object.keys(b.RecommendedScales).indexOf(s.findScaleRangeByIndex(l).id),n={backgroundImage:w(i),backgroundPosition:f(a)};return _("div",{class:x.scalePreview},_("div",{class:x.scalePreviewThumbnail,styles:n}))}renderScaleMenu({map:e,min:t,max:i,type:s}){const l=b.fromScaleRange({minScale:t,maxScale:i}),a=this.messages.featuredScaleLabels,n=b.RecommendedScales,r=Object.keys(n).filter((e=>l.contains(n[e]))).map((e=>this.renderScaleMenuItem({scaleLabel:a[e],scaleValue:n[e],valueVisible:"world"!==e,handleNamedScaleSelect:this._handleRecommendedScaleClick}))),{_customMaxScale:c,_customMinScale:o,messages:d}=this,u="max"===s?c:o;return _("div",{bind:this,class:x.scaleMenu,"data-type":s,id:`${this.id}__scale-menu--${s}`,key:`${s}-scale-menu`,afterCreate:h,"data-node-ref":"_scaleMenuNode",onkeydown:this._handleScaleMenuKeyDown},_("div",{class:x.scaleMenuScroller},_("ul",{class:x.scaleMenuList,afterCreate:this._afterMenuListCreate},this.renderScaleMenuItem({scaleValue:u,scaleLabel:d.featuredScaleLabels.custom,valueVisible:!1,handleNamedScaleSelect:this._handleScaleSelection,handleCustomScaleSelect:this._handleCustomScaleEntry}),null!=e?this.renderScaleMenuItem({scaleValue:e,scaleLabel:d.featuredScaleLabels.current,valueVisible:!0,handleNamedScaleSelect:this._handleRecommendedScaleClick}):null,r)))}_handleScaleSelection(){"max"===this._activeMenu?this._customMaxScale=this._effectiveMaxScale:this._customMinScale=this._effectiveMinScale}renderScaleMenuToggle(e,t){const{_activeMenu:i,_interactive:s}=this,l=i===e;return _("button",{"aria-controls":l?`${this.id}__scale-menu--${e}`:"","aria-pressed":l?"true":"false",class:this.classes(x.scaleMenuToggle,l?x.scaleMenuToggleActive:null),"data-type":e,key:`${e}-scale-menu-toggle`,onclick:this._handleScaleMenuToggleClick,disabled:!s,type:"button"},t,_("span",{class:this.classes(x.scaleMenuToggleIcon,x.expandIcon),"aria-hidden":"true"}))}renderScaleMenuItem(e){const{scaleValue:t,scaleLabel:i,valueVisible:s,handleNamedScaleSelect:l,handleCustomScaleSelect:a=null}=e,{id:n}=this,r=`${n}__custom-scale-input`;return _("li",{bind:this,class:x.scaleMenuListItem,"data-scale":t,key:i,onclick:l,onkeydown:l,tabIndex:-1},_("label",{class:x.scaleItemLabel,for:r},i),t>-1?a?_("input",{afterCreate:this.focusAndSelectInputOnCreate,class:this.classes(x.scaleItemValue,x.scaleItemValueEditable),"data-render-props":e,id:r,key:"value",value:C(t),onkeydown:this.handleCustomScaleInputKeyDown,onblur:this._handleCustomScaleInputBlur}):s?_("div",{class:x.scaleItemValue,key:"value"},C(t)):null:null)}focusAndSelectInputOnCreate(e){e.focus(),e.select()}renderCurrentScaleIndicator(){const{_slider:e,messages:t,view:i,viewModel:{scaleRanges:s}}=this,l=s.clampScale(i.scale),a=this.viewModel.mapScaleToSlider(l),n=a/e.max,c=t.scaleRangeLabels[s.findScaleRangeByIndex(a).id],o=r(t.currentScaleTooltip,{scaleLabel:c});return _("div",{class:x.scaleIndicatorContainer,key:"scale-indicator"},_("div",{"aria-label":o,class:x.scaleIndicator,styles:{left:(m()?-1:1)*n*100+"%"},title:o},this.renderCurrentScaleIndicatorIcon()))}renderCurrentScaleIndicatorIcon(){return _("svg",{class:x.scaleIndicatorIcon,height:"8",width:"8",viewBox:"0 0 8 8",version:"1.1",xmlns:"http://www.w3.org/2000/svg"},_("polygon",{points:"4 0 8 8 0 8"}))}_handleRecommendedScaleClick(e){const t=e.currentTarget,i=Number(t["data-scale"]);this._setScaleFromMenuSelection(i)}_setScaleFromMenuSelection(e){"max"===this._activeMenu?this.maxScale=Math.min(e,this._effectiveMinScale-1):this.minScale=Math.max(e,this._effectiveMaxScale+1),this._setActiveMenu(null),this._activeMenuToggleNode.focus()}_setActiveMenu(e){this._activeMenu=e,this._maxScaleMenuPopover.open="max"===e,this._minScaleMenuPopover.open="min"===e,this._focusedMenuItemIndex=e?0:-1}};e([t()],L.prototype,"_slider",void 0),e([t()],L.prototype,"_effectiveMaxScale",null),e([t()],L.prototype,"_effectiveMinScale",null),e([t({readOnly:!0})],L.prototype,"_interactive",null),e([t()],L.prototype,"disabled",void 0),e([t({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],L.prototype,"label",void 0),e([t({aliasOf:"viewModel.layer"})],L.prototype,"layer",void 0),e([t({aliasOf:"viewModel.maxScale"})],L.prototype,"maxScale",void 0),e([t({aliasOf:"viewModel.maxScaleLimit"})],L.prototype,"maxScaleLimit",void 0),e([t(),v("esri/widgets/ScaleRangeSlider/t9n/ScaleRangeSlider")],L.prototype,"messages",void 0),e([t({aliasOf:"viewModel.minScale"})],L.prototype,"minScale",void 0),e([t({aliasOf:"viewModel.minScaleLimit"})],L.prototype,"minScaleLimit",void 0),e([t()],L.prototype,"region",void 0),e([t({aliasOf:"viewModel.view"})],L.prototype,"view",void 0),e([t()],L.prototype,"viewModel",void 0),e([t()],L.prototype,"visibleElements",void 0),e([i("visibleElements")],L.prototype,"castVisibleElements",null),e([p()],L.prototype,"_handleScaleSelection",null),e([p()],L.prototype,"_handleRecommendedScaleClick",null),L=e([s("esri.widgets.ScaleRangeSlider")],L);var j=L;export default j;
