/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import"../../../core/has.js";import{isNone as i,isSome as t,applySome as e,unwrapOr as o}from"../../../core/maybe.js";import"../../../core/Logger.js";import{makeHandle as n,handlesGroup as a}from"../../../core/handleUtils.js";import{last as s,binaryFindClosest as r}from"../../../core/arrayUtils.js";import{throwIfAborted as l}from"../../../core/promiseUtils.js";import{formatNumber as d}from"../../../intl/number.js";import{substitute as c}from"../../../intl/substitute.js";import"../../../intl.js";import{convertUnit as p}from"../../../core/unitUtils.js";import{unitName as u,formatDecimal as x}from"../../../core/unitFormatUtils.js";import{isDarkTheme as m,isRTL as f}from"../../support/widgetUtils.js";import{loadChartsModule as g}from"../../support/chartUtils.js";import{CHART_CSS as b}from"../css.js";import{NO_DATA_VALUE as h,MAX_CHART_RATIO as v,FORMAT_PRECISION as T,NOT_AVAILABLE as y}from"./constants.js";import{getTranslatedLineTitle as A}from"./intlUtils.js";import{niceScale as L}from"./niceScale.js";const C="#f8f8f8",k="#a9a9a9",P="#323232",S="line",F="fill",z=15,w=12,M=30,j=.001,B=3,E=2,I=30,U={sideSpacing:z,paddingBottom:0,paddingLeft:0,paddingRight:0,paddingTop:0,axisFontSize:9,axisFontWeight:"400",axisGridStroke:"#f4f4f4",axisLabelsFontSize:9,axisLabelsFontWeight:"400",axisLabelsColor:k,axisTooltipFontSize:12,axisTooltipBackgroundColor:P,axisTooltipLabelColor:C,axisTooltipPaddingTop:Math.round(w/4),axisTooltipPaddingBottom:Math.round(w/4),axisTooltipPaddingHorizontal:Math.round(z/4),xAxisMinGridDistance:50,xAxisLabelsSpacing:Math.round(w/2),xAxisMinLabelPosition:.05,xAxisMaxLabelPosition:.9,yAxisMinGridDistance:30,yAxisExtraFactorTop:.25,yAxisExtraFactorBottom:.02,yAxisLabelSpacing:Math.round(z/4),yAxisMinLabelPosition:0,yAxisMaxLabelPosition:.8,seriesTooltipFontSize:12,seriesTooltipBackgroundColor:C,seriesTooltipLabelColor:P,seriesFillLighten:.9,seriesTooltipSpacing:w/2,seriesTooltipPaddingVertical:Math.round(z/4),seriesTooltipPaddingHorizontal:Math.round(z/4),tooltipBorderRadius:0},R={...U,axisGridStroke:P,axisLabelsColor:k,axisTooltipBackgroundColor:P,axisTooltipLabelColor:C,seriesTooltipBackgroundColor:P,seriesTooltipLabelColor:C,seriesFillLighten:-.75};async function W(t){const e=await g();l(t.abortOptions);const{am4core:o,am4charts:n}=e;o.options.minPolylineStep=B,o.options.autoSetClassName=!0,o.options.animationsEnabled=!1;const s=m(),r=s?R:U;s&&o.useTheme(e.am4themes_dark);const d=o.create(t.container,n.XYChart);d.arrangeTooltips=!1,d.preloader.disabled=!0,d.zoomOutButton.disabled=!0;const c=f();d.rtl=c,d.padding(r.paddingTop,c?r.paddingLeft:r.paddingRight,r.paddingBottom,c?r.paddingRight:r.paddingLeft);const p=d.plotContainer.background;p.strokeWidth=0,p.strokeOpacity=0,p.stroke=null;const u=d.xAxes.push(new n.ValueAxis),x=d.yAxes.push(new n.ValueAxis),b={params:t,amCharts4Index:e,amChart:d,xAxis:u,yAxis:x,series:new Map,data:null,messages:null,theme:r};d.cursor=D(b),G(b),O(b),H(b);const h=[K(b,t.onRangeChange),Z(b,t.onCursorPositionChange),Q(b)];let v=null,T=!1;const y=()=>{i(v)||("undefined"!=typeof window&&"cancelIdleCallback"in window?window.cancelIdleCallback(v):clearTimeout(v),v=null)};return{...b,destroy(){T=!0,y(),a(h).remove(),d.dispose()},update(i){if(i.data===b.data&&i.messages===b.messages)return;if(y(),T)return;const t=()=>{T||(v=null,V(b,i))};v="undefined"!=typeof window&&"requestIdleCallback"in window?window.requestIdleCallback(t,{timeout:I}):setTimeout(t,I)},zoomOut(){T||b.xAxis.zoom({start:0,end:1},!1,!0)}}}function D(i){const t=new i.amCharts4Index.am4charts.XYCursor;return t.trackable=!0,t.lineY.disabled=!0,t.behavior="zoomX",t}function G(i){const t=i.theme,e=i.amChart.tooltip,{am4core:o}=i.amCharts4Index;e.id="series-tooltip",e.fitPointerToBounds=!0,e.pointerOrientation="vertical",e.zIndex=-1,e.getFillFromObject=!1,e.label.fontSize=t.seriesTooltipFontSize,e.label.fill=o.color(t.seriesTooltipLabelColor),e.label.padding(t.seriesTooltipPaddingVertical,t.seriesTooltipPaddingHorizontal,t.seriesTooltipPaddingVertical,t.seriesTooltipPaddingHorizontal),e.background.cornerRadius=t.tooltipBorderRadius,e.background.stroke=null,e.background.fill=o.color(t.seriesTooltipBackgroundColor),e.background.padding(0,0,0,0),e.adapter.add("dy",(()=>t.seriesTooltipSpacing*(e.background.pointerY<=0?1:-1))),f()&&(e.label.textAlign="middle")}function O(i){const{xAxis:t,theme:e}=i,{am4core:o}=i.amCharts4Index;t.numberFormatter=si(i,"distance"),t.strictMinMax=!0,t.cursorTooltipEnabled=!1,t.title.visible=!1;const n=t.renderer;n.line.visible=!1,n.minGridDistance=e.xAxisMinGridDistance,n.minLabelPosition=e.xAxisMinLabelPosition,n.maxLabelPosition=e.xAxisMaxLabelPosition,n.fontWeight=e.axisFontWeight,n.fontSize=e.axisFontSize,n.baseGrid.disabled=!0;const a=n.labels.template;a.fontSize=e.axisLabelsFontSize,a.fontWeight=e.axisLabelsFontWeight,a.fill=o.color(e.axisLabelsColor),a.paddingTop=e.xAxisLabelsSpacing,a.horizontalCenter="left",a.paddingLeft=0;const s=t.tooltip;s.id="axis-tooltip",s.background.fill=o.color(e.axisTooltipBackgroundColor),s.background.stroke=null,s.background.padding(0,0,0,0),s.label.fontSize=e.axisTooltipFontSize,s.label.fill=o.color(e.axisTooltipLabelColor),s.label.padding(e.axisTooltipPaddingTop,e.axisTooltipPaddingHorizontal,e.axisTooltipPaddingBottom,e.axisTooltipPaddingHorizontal);const r=n.grid.template;r.strokeOpacity=1,r.stroke=o.color(e.axisGridStroke)}function H(i){const{yAxis:t,theme:e}=i,{am4core:o}=i.amCharts4Index;t.numberFormatter=si(i,"elevation"),t.title.visible=!1,t.cursorTooltipEnabled=!1,t.strictMinMax=!0,t.baseValue=h;const n=t.renderer;n.inside=!0,n.line.opacity=0,n.line.visible=!1,n.minGridDistance=e.yAxisMinGridDistance,n.minLabelPosition=e.yAxisMinLabelPosition,n.maxLabelPosition=e.yAxisMaxLabelPosition,n.fontWeight=e.axisFontWeight,n.fontSize=e.axisFontSize,n.baseGrid.disabled=!0;const a=n.labels.template;a.fontSize=e.axisLabelsFontSize,a.fontWeight=e.axisLabelsFontWeight,a.fill=o.color(e.axisLabelsColor),a.verticalCenter="bottom",a.paddingLeft=e.yAxisLabelSpacing,a.paddingBottom=0;const s=n.grid.template;s.strokeOpacity=1,s.stroke=o.color(e.axisGridStroke),f()&&(n.opposite=!0,a.textAlign="middle",a.paddingLeft=0,a.paddingRight=e.yAxisLabelSpacing)}function V(i,{data:o,messages:n}){ti(i);const a=t(o)&&o.fullyRefined;i.amChart.cursor.disabled=!a,i.amChart.htmlContainer.classList.toggle(b.cursorEnabled,a);const s=i.data!==o,r=e(i.data,(i=>i.effectiveUnits))!==e(o,(i=>i.effectiveUnits));i.data=o,i.messages=n,s&&($(i),Y(i),X(i)),r&&(i.yAxis.invalidateLabels(),i.xAxis.invalidateLabels())}function $({xAxis:e,data:n}){if(i(n))return;let a=0;for(const i of n.lines){var r;const e=o(i.samples,[]),n=null==(r=s(e))?void 0:r.distance;t(n)&&n>a&&(a=n)}e.min=0,e.max=a}function Y({yAxis:o,data:n,theme:a}){if(i(n))return;const s=e(n.statistics,(i=>i.maxDistance)),r=e(n.statistics,(i=>i.minElevation)),l=e(n.statistics,(i=>i.maxElevation));if(t(s)&&t(r)&&t(l)){let i=r,t=l;if(n.dynamicElevationRange){let e=s;const o=l-r,a=n.effectiveUnits;e=p(s,a.distance,"meters");let d=p(o,a.elevation,"meters");d=Math.max(d,e/v,d),d=p(d,"meters",a.elevation),i=r,t=i+d}const e=Math.max(t-i,j);i-=a.yAxisExtraFactorBottom*e,t+=a.yAxisExtraFactorTop*e,[o.min,o.max]=L(i,t,10)}else o.min=void 0,o.max=void 0}function X(t){const{amChart:o,data:n}=t;if(i(n)||0===n.lines.length)return void o.series.clear();const a=new Map,s=new Set(o.series.values),r=n.lines.length;for(let i=0;i<r;i++){const l=n.lines[i];let d=t.series.get(l.id);d?(e(d.fill,(i=>s.delete(i))),s.delete(d.line)):(d=_(t,l),e(d.fill,(i=>o.series.push(i))),o.series.push(d.line)),a.set(d.id,d);const c=r-i-1;e(d.fill,(i=>i.zIndex=c)),d.line.zIndex=r+c,q(t,d,l)}t.series=a;for(const i of s)o.series.removeValue(i)}function q(i,{line:t,fill:n},a){const{theme:s}=i,{am4core:r}=i.amCharts4Index,{r:l,g:d,b:c,a:p}=a.color,u=r.color({r:l,g:d,b:c,a:p}),x=o(a.samples,[]),m=x.length>0;t.stroke=u,t.visible=m,e(n,(i=>{i.visible=m,i.fill=u.lighten(s.seriesFillLighten)}));const f=x.length,g=t.data;if(g.length===f){for(let i=0;i<f;++i)N(g[i],x[i]);t.invalidateRawData(),e(n,(i=>i.invalidateRawData()))}else t.data=x,e(n,(i=>i.data=x))}function N(i,t){i.x=t.x,i.y=t.y,i.z=t.z,i.distance=t.distance,i.elevation=t.elevation}function _(i,t){const{id:e}=t,o=J(i,`${S}-${e}`);o.strokeWidth=t.chartStrokeWidth,o.dy=t.chartStrokeOffsetY;let n=null;return t.chartFillEnabled&&(n=J(i,`${F}-${e}`),n.fillOpacity=1),{id:e,line:o,fill:n}}function J(i,t){const e=new i.amCharts4Index.am4charts.LineSeries;e.id=t,e.showOnInit=!1,e.simplifiedProcessing=!0,e.minDistance=E,e.excludeFromTotal=!0,e.clickable=!1,e.contextMenuDisabled=!0,e.cursorHoverEnabled=!1,e.cursorTooltipEnabled=!1,e.connect=!1,e.fill=null,e.stroke=null;const o="distance";e.dataFields.valueX=o;const n="elevation";return e.dataFields.valueY=n,e}function K({xAxis:i},t){const e=i.events.on("rangechangeended",(()=>{t(i.zoomFactor)}));return n((()=>e.dispose()))}function Q({xAxis:i,yAxis:t}){const e=i=>()=>{i.renderer.grid.each((i=>{i.visible="none"!==i.dataItem.label.dom.getAttribute("display")}))},o=[i.events.on("rangechangeended",e(i)),i.events.on("validated",e(i)),t.events.on("rangechangeended",e(t)),t.events.on("validated",e(t))];return n((()=>{o.forEach((i=>i.dispose()))}))}function Z(i,t){const{amChart:e,xAxis:o,yAxis:a}=i,{cursor:s}=e;let r=!1;const l=()=>{const e=o.toAxisPosition(s.xPosition),n=a.toAxisPosition(s.yPosition);t(e,n),ii(i)},d=()=>{r=!1,t(null,null),ti(i)},c=[s.events.on("cursorpositionchanged",(()=>{r&&l()})),e.events.on("over",(()=>{r=!0})),e.events.on("out",d),e.events.on("blur",d)];return n((()=>{c.forEach((i=>i.dispose()))}))}function ii(i){const{amChart:o,xAxis:n,theme:a}=i;if(ti(i),!e(i.data,(i=>i.fullyRefined)))return;const s=o.tooltip,r=n.tooltip,l=ei(i);if(t(l)){s.text=l.text,s.show(0),s.validate();const t=l.y-s.contentHeight-a.seriesTooltipSpacing;s.pointerOrientation=t<M?"up":"down",s.pointTo(l,!0),r.text=ai(i),r.show(),o.cursor.show()}}function ti({amChart:i,xAxis:t}){i.cursor.hide(),i.tooltip.hide(),t.hideTooltip()}function ei(t){const{amChart:o,yAxis:n,data:a}=t;if(i(a))return null;const s=a.lines.map((i=>({line:i,y:e(ri(t,i),(i=>i.elevation))}))).sort(oi),r=s.length?s[0].y:null;if(i(r))return null;const l=o.cursor,d=n.measuredHeight,c=d+o.pixelPaddingTop;return{text:s.map((({y:i,line:e})=>ni(t,e,i))).join("\n"),x:l.point.x+l.parent.pixelX+o.pixelPaddingLeft,y:c-n.valueToPosition(r)*d}}function oi({y:t},{y:e}){return i(t)?1:i(e)?-1:e-t}function ni(e,o,n){const{data:a,messages:s}=e;if(i(a)||i(s))return"";const r=c(s.chartTooltip,{name:A(o,s),elevation:t(n)?x(s,n,a.effectiveUnits.elevation,T):y});return`[${o.color.toHex()}]●[/] ${r}`}function ai(e){const{data:o,messages:n}=e;if(i(o)||i(n))return"";const a=o.lines[0],s=a?ri(e,a):null;return t(s)?x(n,s.distance,o.effectiveUnits.distance,T):"-"}function si(t,e){const o=t.xAxis.numberFormatter.clone();return o.format=(o,n,a)=>{const{messages:s,data:r}=t;if(i(s)||i(r)||"string"==typeof o)return"";return`${d(o,{maximumFractionDigits:a})} ${u(s,r.effectiveUnits[e],"abbr")}`},o}function ri({amChart:i,xAxis:t},e){const n=o(e.samples,[]);if(0===n.length)return null;const a=t.toAxisPosition(i.cursor.xPosition),s=t.positionToValue(a);return r(n,s,(i=>i.distance))}export{W as createChart};
