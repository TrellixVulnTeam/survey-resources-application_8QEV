/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import"../../core/has.js";import"../../core/Logger.js";import"../../core/accessorSupport/ensureType.js";import{property as t}from"../../core/accessorSupport/decorators/property.js";import{subclass as s}from"../../core/accessorSupport/decorators/subclass.js";import"../../core/urlUtils.js";import"../../core/uuid.js";import"../../portal/support/resourceExtension.js";import r from"../../geometry/SpatialReference.js";import i from"../../geometry/Point.js";import o from"../../geometry/Polyline.js";import"../../geometry.js";import{onLocaleChange as a}from"../../intl/locale.js";import n from"../../symbols/CIMSymbol.js";import l from"../../symbols/Font.js";import{fetchMessageBundle as h}from"../../intl/messages.js";import"../../intl.js";import m from"../../symbols/SimpleMarkerSymbol.js";import p from"../../symbols/TextSymbol.js";import"../../symbols.js";import c from"../../Graphic.js";import d from"../../core/Handles.js";import{init as u}from"../../core/watchUtils.js";import{convertUnit as y}from"../../core/unitUtils.js";import{isLoaded as _,load as v,project as f,isSupported as w}from"../../geometry/projection.js";import{formatDecimal as g,formatImperialLength as j,formatMetricLength as b}from"../../core/unitFormatUtils.js";import{isSupported as S,geodesicLengths as L,geodesicDensify as x}from"../../geometry/support/geodesicUtils.js";import{geodesicLength as A,geodesicDensify as C,planarLength as M}from"../../geometry/geometryEngine.js";import D from"../../layers/GraphicsLayer.js";import I from"../../layers/GroupLayer.js";import{createManipulatorDragEventPipeline as k,screenToMap as G,dragGraphic as R}from"../../views/interactive/dragEventPipeline.js";import{InteractiveToolBase as E}from"../../views/interactive/InteractiveToolBase.js";import P from"../../views/draw/Draw.js";import{GraphicManipulator as T}from"../../views/interactive/GraphicManipulator.js";const W=1e5;let U=class extends E{constructor(){super(...arguments),this._drawActive=!1,this._handles=new d,this._polylineLayer=new D,this._manipulatorLayer=new D,this._groupLayer=new I({layers:[this._polylineLayer,this._manipulatorLayer],listMode:"hide",visible:!1}),this._vertices=[],this.deferCreation=!0,this.geodesicDistanceThreshold=1e5,this.measurement=null,this.measurementLabel=null}initialize(){h("esri/core/t9n/Units").then((e=>{this.messages=e})),this._handles.add(a((async()=>{this.messages=await h("esri/core/t9n/Units")})))}destroy(){this.detach(),this._draw&&(this._draw.destroy(),this._draw=null),this._handles&&(this._handles.destroy(),this._handles=null),this._polylineLayer&&(this._polylineLayer.destroy(),this._polylineLayer=null),this._manipulatorLayer&&(this._manipulatorLayer.destroy(),this._manipulatorLayer=null)}set editable(e){this._set("editable",e),e||this._draw.reset()}activate(){this._drawActive||0!==this._vertices.length||this._startSketch()}onAttach(){const e=this.view;this._draw=new P({view:e}),e.map.add(this._groupLayer),e.focus(),this._handles.add([u(this,["unit","geodesicDistanceThreshold","palette","messages"],(()=>{this._vertices.length>0&&this._updatePolylines()})),u(this,"view.spatialReference",(e=>{O(e)&&!_()&&v()}))]),this.create()}onDetach(){const{map:e}=this.view;this._draw.view=null,this._draw.destroy(),this._draw=null,e.remove(this._groupLayer),this._handles.removeAll(),this._polylineLayer.removeAll(),this._manipulatorLayer.removeAll(),this._set("measurement",null),this._set("measurementLabel",null)}onShow(){this._groupLayer.visible=!0}onHide(){this._groupLayer.visible=!1}reset(){this._vertices=[],this._polylineLayer.removeAll(),this._set("measurement",null),this._set("measurementLabel",null),this._draw.reset(),this._drawActive=!1,this._updateSketch([])}onInputEvent(e){"pointer-move"===e.type&&this._updateCursor()}_startSketch(){this._drawActive=!0;const e=this._draw.create("polyline",{mode:"click"});e.on(["vertex-add","vertex-update","vertex-remove","cursor-update","undo","redo"],(e=>this._updateSketch(e.vertices))),e.on("draw-complete",(()=>{this._stopSketch()}))}_stopSketch(){this.manipulators.forEach((e=>{e.manipulator.interactive=!0})),this._drawActive=!1,this.complete()}_updateSketch(e){if(O(this.view.spatialReference)&&!_())return;if(e.length<2)return this._vertices=[],this.manipulators.removeAll(),void this._polylineLayer.removeAll();this.create();const{spatialReference:t}=this.view;for(;this._vertices.length>e.length;){const{manipulatorId:e}=this._vertices.pop();this.manipulators.remove(e)}for(let l=this._vertices.length;l<e.length;l++){const[s,r]=e[l],o=z(new i({x:s,y:r,spatialReference:t}),this.view,this._manipulatorLayer,this.palette),a=this.manipulators.add(o);k(o,((e,t)=>{t.next(G(this.view)).next(R(e.graphic)).next((()=>{const t=e.graphic.geometry;this._vertices[l].coord=[t.x,t.y],this._updatePolylines()}))})),this._vertices.push({manipulatorId:a,coord:[s,r]})}const s=this._vertices.length-1,r=this._vertices[s],[o,a]=e[s];if(r.coord[0]!==o||r.coord[1]!==a){r.coord=[o,a];const e=new i({x:o,y:a,spatialReference:t});this.manipulators.findById(r.manipulatorId).graphic.geometry=e}const n=this._drawActive?this._vertices[s].manipulatorId:null;this.manipulators.forEach((e=>{e.manipulator.interactive=null==n||e.id!==n})),this._updatePolylines()}_updateCursor(){this.cursor=this._drawActive?"crosshair":null}_updatePolylines(){const e=this._vertices.map((e=>e.coord)),{measurement:t,drawing:s,original:r}=B(e,this.view.spatialReference,this.geodesicDistanceThreshold);this._set("measurement",t);const i=H(this.messages,t,this.unit);this._set("measurementLabel",i);const{pathPrimaryColor:o,pathSecondaryColor:a,pathWidth:h}=this.palette;this._polylineLayer.removeAll(),this._polylineLayer.addMany([new c({geometry:s,symbol:new n({data:{type:"CIMSymbolReference",symbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",effects:[{type:"CIMGeometricEffectDashes",dashTemplate:[14,12],lineDashEnding:"FullGap",controlPointEnding:"NoConstraint"}],enable:!0,capStyle:"Butt",joinStyle:"Round",width:h-1.5,color:a},{type:"CIMSolidStroke",enable:!0,capStyle:"Butt",joinStyle:"Round",width:h,color:o}]}}})}),new c({geometry:r.extent.center,symbol:new p({color:[255,255,255,1],haloColor:[0,0,0,.5],haloSize:2,font:new l({size:14,family:"sans-serif"}),text:i})})])}};function z(e,t,s,r){const i=new m({style:"circle",color:r.handleColor,size:r.handleWidth,outline:{type:"simple-line",width:0}}),o=new m({style:"circle",color:r.handleColor,size:1.5*r.handleWidth,outline:{type:"simple-line",width:0}}),a=new c({geometry:e,symbol:i});return new T({view:t,layer:s,graphic:a,focusedSymbol:o})}function B(e,t,s){const i=new o({paths:[e],spatialReference:t});let a,n;if(t.isGeographic)if(S(t))a=L([i],"meters")[0],n=x(i,W);else{const e=f(i,r.WGS84),s=x(e,W);a=L([e],"meters")[0],n=f(s,t)}else if(t.isWebMercator)a=A(i,"meters"),n=C(i,W,"meters");else{const e=M(i,"meters");if(e>=s){const e=f(i,r.WGS84),s=x(e,W);a=L([e],"meters")[0],n=f(s,t)}else a=e,n=i}return{measurement:{geometry:n,length:a},original:i,drawing:n}}function F(e){return null!=e&&(!O(e)||w())}function O(e){if(!e)return!1;const{isGeographic:t,isWebMercator:s,isWGS84:r}=e;return t&&!r&&!S(e)||!t&&!s}function H(e,t,s){if(!t||!e)return null;switch(s){case"metric":return b(e,t.length,"meters");case"imperial":return j(e,t.length,"meters");default:return g(e,y(t.length,"meters",s),s)}}e([t()],U.prototype,"cursor",void 0),e([t({value:!0})],U.prototype,"editable",null),e([t({type:Number})],U.prototype,"geodesicDistanceThreshold",void 0),e([t({readOnly:!0})],U.prototype,"measurement",void 0),e([t({readOnly:!0})],U.prototype,"measurementLabel",void 0),e([t()],U.prototype,"messages",void 0),e([t()],U.prototype,"palette",void 0),e([t()],U.prototype,"unit",void 0),e([t({constructOnly:!0})],U.prototype,"view",void 0),U=e([s("esri.widgets.DistanceMeasurement2D.DistanceMeasurement2DTool")],U);var N=U;export default N;export{B as createDistanceMeasurementInfo2D,H as createDistanceMeasurementLabel,F as isSupported};
