/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import"../../core/has.js";import"../../core/Logger.js";import"../../core/accessorSupport/ensureType.js";import{property as e}from"../../core/accessorSupport/decorators/property.js";import{subclass as i}from"../../core/accessorSupport/decorators/subclass.js";import"../../core/urlUtils.js";import"../../core/uuid.js";import"../../portal/support/resourceExtension.js";import r from"../../geometry/SpatialReference.js";import{geographicToWebMercator as o,project as s}from"../../geometry/support/webMercatorUtils.js";import{extentContainsPoint as n}from"../../geometry/support/contains.js";import"../../geometry.js";import a from"../../core/Collection.js";import{result as c}from"../../core/asyncUtils.js";import{on as u,whenTrue as h}from"../../core/watchUtils.js";import{HandleOwner as l}from"../../core/HandleOwner.js";function p(t,e){return t&&"copyright"in t&&(!e||"function"==typeof t.originOf&&"user"===t.originOf("copyright"))}function d(t,e){return t.length!==e.length||t.some(((t,i)=>t.text!==e[i].text))}function m(t,e,i){if(!i||!e)return;t.find((t=>t.layerView===e&&t.text===i))||t.push({text:i,layerView:e})}function f(t){return"bing-maps"===t.type}const b=[];let y=class extends l{constructor(t){super(t),this.clear=()=>{this._fetchedAttributionData.clear(),this._pendingAttributions.clear(),this.handles.remove("suspension"),this.notifyChange("state")},this._pendingAttributions=new Set,this._fetchedAttributionData=new Map,this.items=new a,this.view=null,this._allLayerViewsChange=t=>{this.handles.remove("suspension");const e=this.get("view.allLayerViews");e&&this.handles.add(e.map((t=>t.watch(["suspended","attributionVisible"],this._updateAttributionItems))),"suspension"),t&&t.removed&&t.removed.forEach((t=>{this._pendingAttributions.delete(t),this._fetchedAttributionData.delete(t)})),this._updateAttributionItems()},this._updateAttributionItems=()=>{const t=this.get("view.allLayerViews");b.length=0,t?(t.forEach((t=>{if(t.suspended||!t.get("layer.attributionVisible"))return;const e=t.layer;if(p(e,"user"))return void m(b,t,e.copyright);if(e.hasAttributionData){if(this._fetchedAttributionData.has(t)){const i=this._fetchedAttributionData.get(t);return void(i?m(b,t,this._getDynamicAttribution(i,this.view,e)):p(e)&&m(b,t,e.copyright))}return void this._fetchAttributionData(t)}const i=e.get("portalItem.accessInformation");m(b,t,i||e.copyright)})),d(this.items,b)&&(this.items.removeAll(),this.items.addMany(b)),b.length=0,this.notifyChange("state")):this.clear()},this.handles.add([u(this,"view.allLayerViews","change",this._allLayerViewsChange,this._allLayerViewsChange,this.clear),h(this,"view.stationary",(()=>this._updateAttributionItems()))])}destroy(){this.view=null,this._fetchedAttributionData.clear(),this._pendingAttributions.clear(),this.items.removeAll()}get state(){return this.get("view.ready")?this._pendingAttributions.size>0?"loading":"ready":"disabled"}async _fetchAttributionData(t){if(this._pendingAttributions.has(t))return;this._pendingAttributions.add(t);const e=await c(t.layer.fetchAttributionData());if(this._pendingAttributions.has(t)){const i=e.ok?this._createContributionIndex(e.value,f(t.layer)):null;this._pendingAttributions.delete(t),this._fetchedAttributionData.set(t,i)}this._updateAttributionItems()}_createContributionIndex(t,e){const i=t.contributors,s={};if(!i)return s;for(let n=0;n<i.length;n++){const t=i[n],a=t.coverageAreas;if(!a)return;for(const i of a){const a=i.bbox,c=i.zoomMin-(e&&i.zoomMin?1:0),u=i.zoomMax-(e&&i.zoomMax?1:0),h={xmin:a[1],ymin:a[0],xmax:a[3],ymax:a[2],spatialReference:r.WGS84},l={extent:o(h),attribution:t.attribution||"",score:null!=i.score?i.score:100,id:n};for(let t=c;t<=u;t++)s[t]=s[t]||[],s[t].push(l)}}return s.maxKey=Math.max.apply(null,Object.keys(s)),s}_getDynamicAttribution(t,e,i){const{extent:r,scale:o}=e;let a=i.tileInfo.scaleToZoom(o);if(a=Math.min(t.maxKey,Math.round(a)),!r||null==a||a<=-1)return"";const c=t[a],u=s(r.center.clone().normalize(),e.spatialReference),h={};return c?c.filter((t=>{const e=!h[t.id]&&u&&n(t.extent,u);return e&&(h[t.id]=!0),e})).sort(((t,e)=>e.score-t.score||t.objectId-e.objectId)).map((t=>t.attribution)).join(", "):""}};t([e({readOnly:!0,type:a})],y.prototype,"items",void 0),t([e({readOnly:!0})],y.prototype,"state",null),t([e()],y.prototype,"view",void 0),y=t([i("esri.widgets.Attribution.AttributionViewModel")],y);var g=y;export default g;
