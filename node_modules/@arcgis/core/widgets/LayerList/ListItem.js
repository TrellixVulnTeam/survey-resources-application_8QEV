/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import"../../core/has.js";import"../../core/Logger.js";import{property as t}from"../../core/accessorSupport/decorators/property.js";import{aliasOf as i}from"../../core/accessorSupport/decorators/aliasOf.js";import{cast as r}from"../../core/accessorSupport/decorators/cast.js";import{subclass as o}from"../../core/accessorSupport/decorators/subclass.js";import"../../core/urlUtils.js";import"../../core/uuid.js";import"../../portal/support/resourceExtension.js";import s from"../../core/Accessor.js";import l from"../../core/Collection.js";import{IdentifiableMixin as a}from"../../core/Identifiable.js";import n from"../../support/actions/ActionBase.js";import p from"../../support/actions/ActionButton.js";import h from"../../support/actions/ActionToggle.js";import{init as d,watch as c}from"../../core/watchUtils.js";import{HandleOwnerMixin as y}from"../../core/HandleOwner.js";import u from"../../layers/support/Sublayer.js";import m from"../../support/actions/ActionSlider.js";import v from"./ListItemPanel.js";import{isLayerOutsideScaleRange as f,findLayerVisibilityMode as w,findLayerListMode as g,canDisplayLayer as b,getNormalizedChildLayerProperty as _}from"./support/layerListUtils.js";var j;const L=l.ofType({key:"type",defaultKeyValue:"button",base:n,typeMap:{button:p,toggle:h,slider:m}}),S=l.ofType(L),O="layer",C="child-list-mode",P="hide",A="esri.widgets.LayerList.ListItem";let V=j=class extends(a(y(s))){constructor(e){super(e),this.actionsSections=new S,this.actionsOpen=!1,this.children=new(l.ofType(j)),this.childrenSortable=!0,this.error=null,this.layer=null,this.layerView=null,this.open=!1,this.panel=null,this.parent=null,this.sortable=!0,this.view=null,this.visible=null}initialize(){this.handles.add([d(this,"layer",(e=>this._watchLayerProperties(e))),d(this,"view",(e=>this._updateChildren(e))),d(this,"panel",(e=>this._setListItemOnPanel(e))),d(this,["layer","view"],(()=>this._getLayerView()))])}destroy(){this.view=null}castPanel(e){return this.get("panel.open")&&!e.hasOwnProperty("open")&&(e.open=!0),e?new v(e):null}get title(){const e=this.get("layer.layer");return(!e||e&&this.get("layer.layer.loaded"))&&this.get("layer.title")||this.get("layer.attributes.title")||""}set title(e){void 0!==e?this._override("title",e):this._clearOverride("title")}get updating(){const e=this.layerView;return e?e.updating:this._isLayerUpdating(this.layer)}get visibleAtCurrentScale(){return!f(this.layer,this.get("view.scale"))}get visibilityMode(){return w(this.layer)}clone(){return new j({actionsSections:this.actionsSections.clone(),actionsOpen:this.actionsOpen,children:this.children.clone(),layer:this.layer,open:this.open,panel:this.panel,title:this.title,view:this.view,visible:this.visible})}_setListItemOnPanel(e){e&&(e.listItem=this)}_updateChildren(e){const t=this.children;t&&t.forEach((t=>t.view=e))}_addChildren(e){if(this.handles.remove(C),this.children.removeAll(),!e)return;e.forEach((t=>{this.handles.add(c(t,"listMode",(()=>this._addChildren(e))),C)}));const t=[];e.filter((e=>g(e)!==P)).forEach((e=>{if(b(e)){const i=new j({layer:e,parent:this,view:this.view});t.unshift(i)}})),this.children.addMany(t)}_watchSublayerChanges(e){e&&this.handles.add(e.on("change",(()=>{this._addChildren(e)})),O)}_initializeChildLayers(e){this._addChildren(e),this._watchSublayerChanges(e)}_watchLayerProperties(e){if(!this.handles)return;if(this.handles.remove(O),this.handles.remove(C),!e)return;this.handles.add(c(e,"listMode",(()=>this._watchLayerProperties(e))),O);if("hide-children"===g(e))return void this.children.removeAll();const t=_(e);t&&this.handles.add(d(e,t,(()=>{e.hasOwnProperty(t)&&this._initializeChildLayers(e[t])})),O)}async _getLayerView(){const{layer:e,view:t}=this;if(e&&t)try{const i=await t.whenLayerView(e);if(i.layer!==this.layer)return;this._set("layerView",i)}catch{}}_isLayerUpdating(e){return!(e instanceof u)&&(e&&"loading"===e.loadStatus)}};e([t({type:S})],V.prototype,"actionsSections",void 0),e([t()],V.prototype,"actionsOpen",void 0),e([t({type:l})],V.prototype,"children",void 0),e([t()],V.prototype,"childrenSortable",void 0),e([i("layer.loadError?")],V.prototype,"error",void 0),e([t()],V.prototype,"layer",void 0),e([t({readOnly:!0})],V.prototype,"layerView",void 0),e([t()],V.prototype,"open",void 0),e([t({type:v})],V.prototype,"panel",void 0),e([r("panel")],V.prototype,"castPanel",null),e([t()],V.prototype,"parent",void 0),e([t()],V.prototype,"sortable",void 0),e([t()],V.prototype,"title",null),e([t({readOnly:!0})],V.prototype,"updating",null),e([t({value:null})],V.prototype,"view",void 0),e([i("layer.visible")],V.prototype,"visible",void 0),e([t({readOnly:!0})],V.prototype,"visibleAtCurrentScale",null),e([t({readOnly:!0})],V.prototype,"visibilityMode",null),V=j=e([o(A)],V);var I=V;export default I;
