/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import"../../core/has.js";import t from"../../core/Logger.js";import"../../core/accessorSupport/ensureType.js";import{property as a}from"../../core/accessorSupport/decorators/property.js";import{aliasOf as s}from"../../core/accessorSupport/decorators/aliasOf.js";import{subclass as i}from"../../core/accessorSupport/decorators/subclass.js";import"../../core/urlUtils.js";import"../../core/uuid.js";import"../../portal/support/resourceExtension.js";import{eventKey as r}from"../../core/events.js";import{formatDate as o}from"../../intl/date.js";import"../../intl.js";import{loadMoment as n}from"../../intl/moment.js";import{storeNode as d,isRTL as l}from"./widgetUtils.js";import{accessibleHandler as c}from"./decorators/accessibleHandler.js";import{messageBundle as h}from"./decorators/messageBundle.js";import{j as u}from"../../chunks/index.js";import _ from"../Widget.js";import p from"./Popover.js";import m from"./DatePickerViewModel.js";import{parseDateIntoParts as y}from"./datePickerUtils.js";const v={base:"esri-date-picker",datePicker:"esri-date-picker__calendar",monthPicker:"esri-date-picker__month-picker",dayPicker:"esri-date-picker__day-picker",week:"esri-date-picker__week-item",nearbyMonth:"esri-date-picker__day-item--nearby-month",activeDay:"esri-date-picker__day-item--active",today:"esri-date-picker__day-item--today",selectedDay:"esri-date-picker__day-item--selected",day:"esri-date-picker__day-item",dayHeader:"esri-date-picker__day-item--header",yearPicker:"esri-date-picker__year-picker",selectedYear:"esri-date-picker__year-picker-item--selected",year:"esri-date-picker__year-picker-item",monthDropdown:"esri-date-picker__month-dropdown",date:"esri-date-picker__date",datePickerToggle:"esri-date-picker__calendar-toggle",dateInput:"esri-date-picker__input",dateTextInput:"esri-date-picker__text-input",leadingIcon:"esri-date-picker__icon--leading",previousIcon:"esri-icon-left",nextIcon:"esri-icon-right",calendarIcon:"esri-icon-calendar",widget:"esri-widget",button:"esri-widget--button",input:"esri-input",select:"esri-select"},k={year:"numeric",month:"2-digit",day:"2-digit"},g=[" ","ArrowDown","ArrowLeft","ArrowRight","ArrowUp","End","Enter","Home","PageDown","PageUp"],D="esri.widgets.support.DatePicker",w=t.getLogger(D),b="onfocusout"in HTMLElement.prototype,P="formatToParts"in Intl.DateTimeFormat.prototype;let f=class extends _{constructor(e,t){super(e,t),this._activeDate=null,this._calendarNode=null,this._calendarPopover=new p({owner:this,placement:"bottom-start",anchorElement:()=>this._rootNode,renderContentFunction:this._renderCalendar}),this._closedByUserAction=!1,this._isOpen=!1,this._requestDayPickerFocusOnCreate=!1,this._rootNode=null,this.dateInputEnabled=!1,this.label=void 0,this.messages=null,this.value=null,this.commitOnMonthChange=!1,this.viewModel=new m,this._handleDatePickerBlur=b?null:this._handleDatePickerBlurOrFocusOut,this._handleDatePickerFocusOut=b?this._handleDatePickerBlurOrFocusOut:null,this._toggle=this._toggle.bind(this)}async loadLocale(){this._moment=await n(),this._isOpen&&(this._activeDate=this._moment(this._activeDate.toDate()))}destroy(){this._calendarPopover.destroy()}render(){return u("div",{afterCreate:d,bind:this,class:this.classes(v.base,v.widget),"data-node-ref":"_rootNode"},P&&this.dateInputEnabled?this.renderInputAndButtonMode():this.renderButtonOnlyMode())}renderButtonOnlyMode(){const e=o(this.viewModel.value,k),{_isOpen:t,messages:a}=this;return u("div",{afterUpdate:this._focusSelectedOrClosed,"aria-controls":t?this._getCalendarId():null,"aria-expanded":t.toString(),"aria-haspopup":"true","aria-label":a.setDate,"aria-pressed":t.toString(),class:this.classes(v.button,v.select,v.datePickerToggle),onclick:this._toggle,onkeydown:this._toggle,role:"button",tabIndex:0},u("span",{class:v.date},e))}renderInputAndButtonMode(){const e=o(this.viewModel.value,k),{_isOpen:t,messages:a}=this;return u("div",{class:this.classes(v.dateInput)},u("input",{"aria-controls":t?this._getCalendarId():null,"aria-haspopup":"true","aria-label":a.setDate,bind:this,class:this.classes(v.dateTextInput,v.input),key:"date-input",onblur:this._handleDateInputBlur,onfocus:this._handleDateInputFocus,onkeydown:this._handleDateInputKeyDown,type:"text",value:e}),u("span",{"aria-hidden":"true",class:this.classes(v.leadingIcon,v.calendarIcon)}))}_handleDateInputKeyDown(e){"Enter"===e.key&&this._handleDateText(e)}_handleDateInputBlur(e){this._handleDatePickerBlurOrFocusOut(e),this._isOpen||this._handleDateText(e)}_handleDateInputFocus(){this._open(this.viewModel.value,!1)}_handleDateText(e){const t=e.currentTarget;let a;try{a=y(t.value,k)}catch(i){return w.warn(i),void(t.value=o(this.viewModel.value,k))}const s=this._moment(a);s.isValid()?(this.viewModel.value=s.toDate(),this._activeDate=s):t.value=o(this.viewModel.value,k)}_focusSelectedOrClosed(e){this._closedByUserAction&&(this._closedByUserAction=!1,e.focus())}_handleDatePickerKeydown(e){"Escape"===r(e)&&(this._closedByUserAction=!0,this._close(),e.preventDefault(),e.stopPropagation())}_renderCalendar(){const e=this._activeDate,t=this._moment(this.viewModel.value);return u("div",{afterCreate:d,bind:this,class:this.classes(v.datePicker,v.widget),"data-node-ref":"_calendarNode",id:this._getCalendarId(),key:"esri-date-picker__calendar",onkeydown:this._handleDatePickerKeydown},this._renderMonthPicker(e),this._renderDayPicker(e,t),this._renderYearPicker(e))}_getCalendarId(){return`date-picker__calendar--${this.id}`}_handleDatePickerBlurOrFocusOut(e){if(e.currentTarget!==e.target)return;const t=e.relatedTarget;this._calendarNode.contains(t)||this._rootNode.contains(t)||this._close()}_renderMonthPicker(e){const t=l(),a=t?v.nextIcon:v.previousIcon,s=t?v.previousIcon:v.nextIcon,i=this._moment.months().map(((t,a)=>{const s=e.month()===a;return u("option",{selected:s},t)})),{messages:r}=this;return u("div",{class:v.monthPicker},u("div",{"aria-label":r.goToPreviousMonth,bind:this,class:v.button,onblur:this._handleDatePickerBlur,onclick:this._setPreviousMonth,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._setPreviousMonth,role:"button",tabIndex:0,title:r.goToPreviousMonth},u("span",{"aria-hidden":"true",class:a})),u("select",{"aria-live":"assertive","aria-label":r.selectMonth,bind:this,class:this.classes(v.monthDropdown,v.select),id:`${this.id}__month-picker`,onblur:this._handleDatePickerBlur,onchange:this._setMonth,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._setMonth,title:r.selectMonth},i),u("div",{"aria-label":r.goToNextMonth,bind:this,class:v.button,onblur:this._handleDatePickerBlur,onclick:this._setNextMonth,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._setNextMonth,role:"button",tabIndex:0,title:r.goToNextMonth},u("span",{"aria-hidden":"true",class:s})))}_renderDayPicker(e,t){const a=e.clone().day(this._moment.localeData().firstDayOfWeek()),s=this._getWeekLabels(a),i=this._getDayId(e),r=this._renderMonth(e,t);return u("div",{afterCreate:this._handleDayPickerCreate,"aria-activedescendant":i,"aria-labelledby":`${this.id}__month-picker ${this.id}__selected-year`,bind:this,class:v.dayPicker,id:`${this.id}__day-picker`,onblur:this._handleDatePickerBlur,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._handleDayPickerKeydown,role:"grid",tabIndex:0},u("div",{class:v.week,role:"row"},s.map((e=>u("div",{"aria-label":e.name,class:this.classes(v.day,v.dayHeader),role:"columnheader",title:e.name},e.abbr)))),r)}_getDayId(e){return`${this.id}__${o(e.valueOf(),k)}`}_handleDayPickerCreate(e){this._requestDayPickerFocusOnCreate&&(this._requestDayPickerFocusOnCreate=!1,e.focus())}_getWeekLabels(e){const t=[],a={weekday:"long"},s={weekday:"narrow"};for(let i=0;i<7;i++)t.push({name:o(e.valueOf(),a),abbr:o(e.valueOf(),s)}),e.add(1,"day");return t}_handleDayPickerKeydown(e){const{ctrlKey:t,shiftKey:a}=e,s=r(e),i=this._activeDate;if(-1!==g.indexOf(s)){if("ArrowLeft"===s)i.subtract(1,"day");else if("ArrowRight"===s)i.add(1,"day");else if("ArrowUp"===s)i.subtract(1,"week");else if("ArrowDown"===s)i.add(1,"week");else if("PageUp"===s){const e=a?"year":"month";i.subtract(1,e)}else if("PageDown"===s){const e=a?"year":"month";i.add(1,e)}else if("Home"===s){const e=t?"year":"month";i.startOf(e)}else if("End"===s){const e=t?"year":"month";i.endOf(e)}else"Enter"!==s&&" "!==s||(this.viewModel.value=i.toDate(),this._closedByUserAction=!0,this._close());e.preventDefault(),e.stopPropagation()}}_renderMonth(e,t){const a=this._moment(),s=e.clone().startOf("month"),i=e.clone().endOf("month"),r=6,o=7,n=s.clone().subtract(s.weekday(),"day"),d=[];for(let l=0;l<r;l++){const r=[];for(let d=0;d<o;d++){const o=n.date(),d=n.isSame(e,"day"),l=n.isSame(t,"day"),c=this._getDayId(n),h={[v.nearbyMonth]:!n.isBetween(s,i,null,"[]"),[v.today]:n.isSame(a,"day"),[v.activeDay]:d,[v.selectedDay]:l};r.push(u("div",{"aria-label":o.toString(),"aria-selected":d.toString(),bind:this,class:this.classes(v.day,h),"data-iso-date":n.toISOString(),id:c,onclick:this._handleSelectedDate,onkeydown:this._handleSelectedDate,role:"gridcell"},o)),n.add(1,"day")}d.push(u("div",{class:v.week,role:"row"},r))}return d}_renderYearPicker(e){const t={year:"numeric"},a=e.clone(),s=o(a.valueOf(),t),i=o(a.add(1,"year").valueOf(),t),r=o(a.subtract(2,"year").valueOf(),t),{messages:n}=this;return u("div",{class:v.yearPicker},u("div",{"aria-label":n.goToPreviousYear,bind:this,class:v.year,onblur:this._handleDatePickerBlur,onclick:this._setPreviousYear,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._setPreviousYear,tabIndex:0,title:n.goToPreviousYear},r),u("div",{class:this.classes(v.year,v.selectedYear),id:`${this.id}__selected-year`},s),u("div",{"aria-label":n.goToNextYear,bind:this,class:v.year,onblur:this._handleDatePickerBlur,onclick:this._setNextYear,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._setNextYear,tabIndex:0,title:n.goToNextYear},i))}_toggle(){this._isOpen?this._close():this._open(this.viewModel.value)}_setMonth(e){const t=e.target.value;this._activeDate.month(t),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate.toDate())}_close(){this._activeDate=null,this._isOpen=!1,this._calendarPopover.open=!1}_open(e,t=!0){this._activeDate=this._moment(e),this._isOpen=!0,this._calendarPopover.open=!0,this._requestDayPickerFocusOnCreate=t}_setPreviousMonth(){this._activeDate.subtract(1,"month"),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate.toDate())}_setNextMonth(){this._activeDate.add(1,"month"),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate.toDate())}_setPreviousYear(){this._activeDate.subtract(1,"year")}_setNextYear(){this._activeDate.add(1,"year")}_handleSelectedDate(e){const t=e.target;this.viewModel.value=this._moment(t.getAttribute("data-iso-date")).toDate(),this._closedByUserAction=!0,this._close()}};e([a()],f.prototype,"dateInputEnabled",void 0),e([a({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],f.prototype,"label",void 0),e([a(),h("esri/widgets/support/t9n/DatePicker")],f.prototype,"messages",void 0),e([s("viewModel.value")],f.prototype,"value",void 0),e([a()],f.prototype,"commitOnMonthChange",void 0),e([a({type:m})],f.prototype,"viewModel",void 0),e([c()],f.prototype,"_toggle",null),e([c()],f.prototype,"_setPreviousMonth",null),e([c()],f.prototype,"_setNextMonth",null),e([c()],f.prototype,"_setPreviousYear",null),e([c()],f.prototype,"_setNextYear",null),e([c()],f.prototype,"_handleSelectedDate",null),f=e([i(D)],f);var O=f;export default O;
