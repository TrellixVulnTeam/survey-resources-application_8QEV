/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import t from"../../core/has.js";import r from"../../config.js";import{isSome as s,unwrap as o,get as i}from"../../core/maybe.js";import l from"../../core/Logger.js";import"../../core/accessorSupport/ensureType.js";import{property as a}from"../../core/accessorSupport/decorators/property.js";import{subclass as n}from"../../core/accessorSupport/decorators/subclass.js";import u from"../../core/Error.js";import"../../core/urlUtils.js";import"../../core/uuid.js";import"../../portal/support/resourceExtension.js";import{eachAlways as c,after as h,createAbortController as p}from"../../core/promiseUtils.js";import d from"../../core/Accessor.js";import g from"../../geometry/SpatialReference.js";import m from"../../geometry/Point.js";import y from"../../core/Evented.js";import S from"../../core/Collection.js";import{onLocaleChange as f}from"../../intl/locale.js";import v from"../../PopupTemplate.js";import _ from"../../symbols/SimpleLineSymbol.js";import{fetchMessageBundle as b}from"../../intl/messages.js";import{getAssetUrl as w}from"../../assets.js";import x from"../../portal/Portal.js";import j from"../../symbols/PictureMarkerSymbol.js";import I from"../../symbols/SimpleFillSymbol.js";import T from"../../symbols/SimpleMarkerSymbol.js";import P from"../../symbols/TextSymbol.js";import R from"../../Graphic.js";import L from"../../core/Handles.js";import{on as E,init as C,whenFalseOnce as F,whenOnce as G}from"../../core/watchUtils.js";import{highlightsSupported as O}from"../../views/support/layerViewUtils.js";import{GoToMixin as A}from"../support/GoTo.js";import{g as D}from"../../chunks/location.js";import N from"./SearchSource.js";import{getPointFromGeometry as M,getPointWithElevation as k}from"./support/geometryUtils.js";import V from"./LayerSearchSource.js";import{isArcGISWorldGeocoder as B,isProxiedArcGISWorldGeocoder as J,isMeteredArcGISWorldGeocoder as U}from"./support/locatorUtils.js";import H from"./LocatorSearchSource.js";import{supported as z,getCurrentPosition as Q,positionToPoint as Z}from"../support/geolocationUtils.js";function q(e,t){return e.hasOwnProperty(t)&&null!=e[t]&&""!==e[t]}const W=()=>b("esri/widgets/Search/t9n/Search"),K="esri.widgets.Search.SearchViewModel",X=l.getLogger(K),Y="highlight",$=S.ofType({key:e=>e.layer?"layer":"locator",base:N,typeMap:{layer:V,locator:H}}),ee=g.WGS84,te="esri/images/search/search-symbol-32.svg",re="esri/images/search/search-symbol-32.png",se=/<(?:.|\s)*?>/g,oe=-1;let ie=class extends(A(y.EventedMixin(d))){constructor(e){super(e),this._handles=new L,this._gotoController=null,this._searching=null,this.autoNavigate=!0,this.autoSelect=!0,this.defaultPopupTemplate=null,this.defaultSources=new $,this.defaultSymbol=new j({url:w(t("trident")?re:te),size:24,width:24,height:24}),this.includeDefaultSources=!0,this.maxInputLength=128,this.maxResults=6,this.maxSuggestions=6,this.messages=null,this.minSuggestCharacters=1,this.popupEnabled=!0,this.popupTemplate=null,this.portal=x.getDefault(),this.resultCount=null,this.resultGraphicEnabled=!0,this.resultGraphic=null,this.results=null,this.selectedSuggestion=null,this.searchAllEnabled=!0,this.selectedResult=null,this.sources=new $,this.suggestionDelay=150,this.suggestionCount=null,this.suggestions=null,this.suggestionsEnabled=!0,this.view=null}initialize(){const e=async()=>{const e=await W();this.messages=e,this.defaultPopupTemplate=new v({title:e.searchResult,content:"{Match_addr}"})};e(),this._handles.add([E(this,["defaultSources","sources"],"change",(()=>this.notifyChange("allSources"))),C(this,["includeDefaultSources","view","portal"],(()=>this._update())),f(e)])}destroy(){this._abortGoTo(),this.clearGraphics(),this._handles.destroy(),this._handles=null}get activeSource(){return this.allSources.getItemAt(this.activeSourceIndex)||null}get activeSourceIndex(){return 1===this.allSources.length||!this.searchAllEnabled?0:oe}set activeSourceIndex(e){void 0!==e?this._override("activeSourceIndex",e):this._clearOverride("activeSourceIndex")}get allPlaceholder(){var e;return null==(e=this.messages)?void 0:e.allPlaceholder}set allPlaceholder(e){e?this._override("allPlaceholder",e):this._clearOverride("allPlaceholder")}get allSources(){const{sources:e,defaultSources:t,includeDefaultSources:r}=this,s="function"==typeof r?r.call(null,{sources:e,defaultSources:t}):r?t.concat(e):e,o=this._get("allSources")||new $;return o.removeAll(),o.addMany(s.filter(Boolean)),o}get locationEnabled(){return this._get("locationEnabled")||z()}set locationEnabled(e){if(void 0===e)return void this._clearOverride("locationEnabled");const t=z();if(e&&!t){const e=new u("locationEnabled:geolocation-unsupported","Geolocation API is unsupported.",{geolocation:navigator.geolocation});X.error(e)}this._override("locationEnabled",e&&t)}get placeholder(){const{allSources:e,activeSourceIndex:t,allPlaceholder:r}=this;if(t===oe)return r;const s=e.getItemAt(t);return s?s.placeholder:""}set searchTerm(e){this._set("searchTerm",e||""),this.clearGraphics(),this.selectedSuggestion&&this.selectedSuggestion.text!==e&&this._set("selectedSuggestion",null),""===e&&this._clear()}get searchTerm(){return this._get("searchTerm")||""}get state(){return this._searching?"searching":this.updating?"loading":0===this.allSources.length?"disabled":"ready"}get updating(){return null!=this._updatingPromise}clear(){this.searchTerm=""}clearGraphics(){this._removeHighlight(),this._closePopup(),this.view&&this.view.graphics.remove(this.resultGraphic),this._set("resultGraphic",null)}search(e,t){this.emit("search-start"),this.clearGraphics();const r=this._createSuggestionForSearch(e),s=this.when().then((()=>this._getResultsFromSources(r,t).then((e=>{const t={activeSourceIndex:this.activeSourceIndex,searchTerm:r.text,numResults:0,numErrors:0,errors:[],results:[]};this._formatResponse(t,e,r);const s=this._getFirstResult(t.results),o=(r.location&&s?s.name:r.text).replace(se,"");return this._set("searchTerm",o),(r.key&&"number"==typeof r.sourceIndex||r.location)&&this._set("selectedSuggestion",r),this._set("results",t.results),this._set("resultCount",t.results.reduce(((e,t)=>e+t.results.length),0)),this.emit("search-complete",t),this._selectFirstResult(s).then((()=>t))})))).then((e=>(this._clearSearching(),e)),(e=>{throw this._clearSearching(),e}));return this._searching=s,this.notifyChange("state"),s}searchNearby(e){if(!this.locationEnabled){const e=new u("searchNearby:geolocation-unsupported","Geolocation API is unsupported.",{geolocation:navigator.geolocation});return X.error(e),Promise.reject(e)}const t=Q().then((t=>Z({position:t,view:this.view},e))).then((t=>this.search(t,e)));return this._searching=t,this.notifyChange("state"),t.catch((()=>{})).then((()=>this._clearSearching())),t}select(e){if(this.clearGraphics(),!e){const t=new u("select:missing-parameter","Cannot select without a searchResult.",{searchResult:e});return X.error(t),Promise.reject(t)}const{view:t}=this,r=q(e,"sourceIndex")?e.sourceIndex:this._getSourceIndexOfResult(e),o=this.allSources.getItemAt(r);if(!o){const e=new u("select:missing-source","Cannot select without a source.",{source:o});return X.error(e),Promise.reject(e)}const i=o instanceof V?this._getLayerSourcePopupTemplate(o):o.popupTemplate,l=o.resultSymbol||this._getDefaultSymbol(e),a=q(o,"resultGraphicEnabled")?o.resultGraphicEnabled:this.resultGraphicEnabled,n=q(o,"autoNavigate")?o.autoNavigate:this.autoNavigate,h=q(o,"popupEnabled")?o.popupEnabled:this.popupEnabled,p=h?i||this.popupTemplate||this.defaultPopupTemplate:null,{feature:d}=e;if(!d){const e=new u("select:missing-feature","Cannot select without a feature.",{feature:d});return X.error(e),Promise.reject(e)}const{attributes:g,geometry:m,layer:y,sourceLayer:S}=d,f=M(m),v={layerViewQuery:this._getLayerView(d),elevationQuery:t&&s(f)?k(f,t).catch((()=>f)):Promise.resolve(f)};return c(v).then((i=>{const u=i.layerViewQuery.value,c=i.elevationQuery.value;l instanceof P&&(l.text=e.name);const f=t&&n?e.target||e.extent:null;return(s(f)?this._goToSearchResult(f):Promise.resolve()).then((()=>{var s;const i=u?d:new R({geometry:m,symbol:l,attributes:g,layer:y,sourceLayer:S,popupTemplate:p}),n=h&&(null==(s=this.view)?void 0:s.popup),f=n&&i.getEffectivePopupTemplate(n.defaultPopupTemplateEnabled);return f&&t.popup.open({features:[i],location:c}),u&&O(u)&&!f&&this._highlightFeature({graphic:i,layerView:u}),!u&&a&&t&&t.graphics.push(i),this._set("selectedResult",e),this._set("resultGraphic",i),this.emit("select-result",{result:e,source:o,sourceIndex:r}),e}))}))}suggest(e,t,r){const s=e||this.searchTerm;return this.emit("suggest-start",{searchTerm:s}),this._suggestTimer(t,r).then((()=>this._suggestImmediate(s,r).then((e=>(this._set("suggestions",e.results),this._set("suggestionCount",e.results.reduce(((e,t)=>e+t.results.length),0)),this.emit("suggest-complete",e),e)))))}async when(){await F(this,"updating")}async _update(){const{portal:e,view:t}=this;if(this.includeDefaultSources){const r=this._updatingPromise=c([null==e?void 0:e.load(),null==t?void 0:t.when()]);if(this.destroyed)return;if(this.notifyChange("updating"),await r,r!==this._updatingPromise)return}this._updatingPromise=null,this.notifyChange("updating");const r=G(this,"messages");this.destroyed||(this._handles.add(r),await r,this._updateDefaultSources())}_clearSearching(){this._searching=null,this.notifyChange("state")}_convertHelperServices(){var e,t;const s=null==(e=this.portal)||null==(t=e.helperServices)?void 0:t.geocode;if(!s)return[];return s.map((e=>{var t;if(!1===e.placefinding)return;const s=r.apiKey&&B(e.url)?{url:"https://geocode-api.arcgis.com/arcgis/rest/services/World/GeocodeServer"}:null,o=H.fromJSON({...e,...s}),i=null==(t=o.locator)?void 0:t.url;if(B(i)||J(i)||U(i)){const e=o.outFields||["Addr_type","Match_addr","StAddr","City"],t=o.placeholder||this.messages.placeholder,r="number"==typeof o.defaultZoomScale?o.defaultZoomScale:2500;o.set({singleLineFieldName:"SingleLine",outFields:e,placeholder:t,defaultZoomScale:r})}return o.singleLineFieldName?o:void 0})).filter(Boolean)}_getLayerSources(e,t){var r;const s=null==(r=this.view)?void 0:r.map;return e.map((e=>{const r=s.findLayerById(e.id);if(!r)return;const o=this._getLayerJSON(e),i=V.fromJSON(o);return i.placeholder=t,this._getLayer(r,o).then((e=>{i.layer=e})),i})).filter(Boolean).toArray()}_getTableSources(e,t){var r;const s=null==(r=this.view)?void 0:r.map;return e.map((e=>{const r=s.findTableById(e.id);if(!r)return;const o=this._getLayerJSON(e),i=V.fromJSON(o);return i.placeholder=t,this._getLayer(r,o).then((e=>{i.layer=e})),i})).filter(Boolean).toArray()}_convertApplicationProperties(){var e,t,r;const s=null==(e=this.view)?void 0:e.map,o=null==s||null==(t=s.applicationProperties)||null==(r=t.viewing)?void 0:r.search;if(!o)return[];const{enabled:i,hintText:l,layers:a,tables:n}=o;if(!i)return[];return[...this._getLayerSources(a,l),...this._getTableSources(n,l)]}_getSubLayer(e,t){return e.load().then((()=>{if(!e.allSublayers)return Promise.reject();const r=e.allSublayers.find((e=>e.id===t.subLayer));return r?r.createFeatureLayer():Promise.reject()}))}async _getBuildingSubLayer(e,t){await e.load();const r=e.allSublayers.find((e=>e.id===t.subLayer));return"building-component"!==(null==r?void 0:r.type)?Promise.reject():(await r.load(),null==r.associatedLayer?Promise.reject():(await r.associatedLayer.load(),r))}_getLayer(e,t){return"feature"===e.type||"scene"===e.type||"csv"===e.type||"geojson"===e.type||"ogc-feature"===e.type?Promise.resolve(e):"map-image"===e.type?this._getSubLayer(e,t).catch((()=>{const t=new u("search:create-featurelayer","Could not create a FeatureLayer from the MapImageLayer",{layer:e});return X.error(t),null})):"building-scene"===e.type?this._getBuildingSubLayer(e,t):Promise.resolve(null)}_getLayerJSON(e){return"function"==typeof e.toJSON?e.toJSON():e}_updateDefaultSources(){const{defaultSources:e,includeDefaultSources:t}=this;e.removeAll(),t&&e.addMany([...this._convertApplicationProperties(),...this._convertHelperServices()]),this.notifyChange("allSources")}_abortGoTo(){this._gotoController&&this._gotoController.abort(),this._gotoController=null}_clear(){this._abortGoTo(),this._set("resultCount",null),this._set("results",null),this._set("suggestions",null),this._set("suggestionCount",null),this._set("selectedResult",null),this._set("selectedSuggestion",null),this.emit("search-clear")}_closePopup(){var e;const t=null==(e=this.view)?void 0:e.popup,{resultGraphic:r}=this;if(!t||!r)return;const{selectedFeature:s}=t;s&&s===r&&t.close()}_suggestTimer(e,t){const r=null!=e?e:this.suggestionDelay;return h(r,null,t&&t.signal)}_createLocationForSearch(e){return e instanceof R?M(e.geometry):e instanceof m?e:Array.isArray(e)&&2===e.length?new m({longitude:e[0],latitude:e[1]}):null}_createSuggestionForSearch(e){if(e&&q(e,"key")&&q(e,"text")&&q(e,"sourceIndex"))return e;const t=this._createLocationForSearch(e),r="string"==typeof e?e:this.searchTerm,{selectedSuggestion:s,selectedResult:i}=this,l=!e&&s&&i,a=l&&s.key===i.key&&s.sourceIndex===i.sourceIndex,n=l&&s.location;return a||n?s:{location:o(t),text:t?"":r,sourceIndex:null,key:null}}_getFirstResult(e){let t=null;return e&&e.some((e=>{const{results:r}=e,s=r[0],o=!!s;return o&&(t=s),o})),t}_selectFirstResult(e){return this.autoSelect&&e?this.select(e):Promise.resolve(null)}_suggestImmediate(e,t){return this.when().then((()=>this._getSuggestionsFromSources(e,t))).then((t=>{const r={activeSourceIndex:this.activeSourceIndex,searchTerm:e,numResults:0,numErrors:0,errors:[],results:[]};return this._formatResponse(r,t),r}))}_formatSourceResponse(e,t,r){const s=t&&t.value||[],o=t&&t.error,i=this.allSources.getItemAt(r);if(o){const t={sourceIndex:r,source:i,error:o};e.errors.push(t),e.numErrors++}else{const t={sourceIndex:r,source:i,results:s};e.results.push(t),e.numResults+=s.length}}_formatResponse(e,t,r){if(t)if(e.activeSourceIndex===oe){const s=r&&q(r,"sourceIndex")&&-1!==r.sourceIndex?r.sourceIndex:void 0;t.forEach(((t,r)=>{const o=void 0!==s?s:r;this._formatSourceResponse(e,t,o)}))}else this._formatSourceResponse(e,t[0],e.activeSourceIndex)}_getResultsFromSources(e,t){const{allSources:r}=this,s=!e.location&&q(e,"sourceIndex")?e.sourceIndex:this.activeSourceIndex,o=[];if(!r.length){const e=new u("search:no-sources-defined","At least one source is required.",{allSources:r});return X.error(e),Promise.reject(e)}return s===oe?r.forEach(((r,s)=>{o.push(this._getResultsFromSource(e,s,t))})):o.push(this._getResultsFromSource(e,s,t)),c(o)}_getSuggestionsFromSources(e,t){const{allSources:r,activeSourceIndex:s}=this,o=[];if(!r.length){const e=new u("suggest:no-sources-defined","At least one source is required.",{allSources:r});return X.error(e),Promise.reject(e)}return s===oe?r.forEach(((r,s)=>{o.push(this._getSuggestionsFromSource(e,s,t))})):o.push(this._getSuggestionsFromSource(e,s,t)),c(o)}_getResultsFromSource(e,t,r){var s;const o=this.allSources.getItemAt(t),{location:i=null}=e,l=(null==(s=this.view)?void 0:s.spatialReference)||ee,a=q(o,"maxResults")?o.maxResults:this.maxResults,n=!!(o instanceof V&&q(o,"exactMatch"))&&o.exactMatch,{view:u}=this;return o.getResults({view:u,sourceIndex:t,location:i,suggestResult:e,spatialReference:l,exactMatch:n,maxResults:a},r)}_getSuggestionsFromSource(e,t,r){const s=this.allSources.getItemAt(t),o=q(s,"suggestionsEnabled")?s.suggestionsEnabled:this.suggestionsEnabled,i=e.length,l=q(s,"minSuggestCharacters")?s.minSuggestCharacters:this.minSuggestCharacters;if(o&&e.trim()&&i>=l){var a;const o=(null==(a=this.view)?void 0:a.spatialReference)||ee,i=q(s,"maxSuggestions")?s.maxSuggestions:this.maxSuggestions,{view:l}=this;return s.getSuggestions({view:l,sourceIndex:t,suggestTerm:e,spatialReference:o,maxSuggestions:i},r)}return Promise.resolve(null)}createDefaultSymbol(e,t){if("point"===t){const t=e;return new T({color:e.color,size:t.size,outline:{color:t.outline.color,width:t.outline.width}})}if("polyline"===t){const t=e;return new _({color:t.color,width:t.width})}if("polygon"===t){const t=e;return new I({color:t.color,outline:{color:t.outline.color,width:t.outline.width}})}}_getLayerSourcePopupTemplate(e){const{layer:t}=e;if(t)return q(e,"popupTemplate")?e.popupTemplate:t.popupTemplate}_getSourceIndexOfResult(e){const t=this.results;let r=null;return t.some((t=>t.results.some((s=>s===e&&(r=t.sourceIndex,!0))))),r}async _goToSearchResult(e){const t=!!e;this._abortGoTo();const r=p();this._gotoController=r;const s={target:{target:e},options:{animate:t,signal:r.signal}};await this.callGoTo(s),this._gotoController=null}_getDefaultSymbol(e){var t,r,o;const l=null==(t=this.view)||null==(r=t.map)||null==(o=r.basemap)?void 0:o.id,a=i(e,"feature","geometry","type");if(s(a)){const e=D({basemap:l,geometryType:a})||D({basemap:"topo",geometryType:a}),t=e&&e.primaryScheme;if(t)return t.color&&q(t,"opacity")&&(t.color.a=t.opacity),this.createDefaultSymbol(t,a)}return this.defaultSymbol}_removeHighlight(){this._handles.remove(Y)}async _getLayerView(e){const{view:t}=this;if(!e||!t||"building-component"===e.layer.type)return Promise.resolve(null);const{layer:r}=e;return await t.when(),t.whenLayerView(r)}_highlightFeature(e){const{graphic:t,layerView:r}=e,{attributes:s,layer:o}=t,{objectIdField:i}=o,l=s&&s[i],a=r.highlight(l||t);this._handles.add(a,Y)}};ie.ALL_INDEX=oe,e([a({readOnly:!0,value:null})],ie.prototype,"activeSource",null),e([a()],ie.prototype,"activeSourceIndex",null),e([a()],ie.prototype,"allPlaceholder",null),e([a({readOnly:!0,dependsOn:["defaultSources.length","sources.length","includeDefaultSources"]})],ie.prototype,"allSources",null),e([a()],ie.prototype,"autoNavigate",void 0),e([a()],ie.prototype,"autoSelect",void 0),e([a()],ie.prototype,"defaultPopupTemplate",void 0),e([a({readOnly:!0})],ie.prototype,"defaultSources",void 0),e([a()],ie.prototype,"defaultSymbol",void 0),e([a()],ie.prototype,"includeDefaultSources",void 0),e([a()],ie.prototype,"locationEnabled",null),e([a()],ie.prototype,"maxInputLength",void 0),e([a()],ie.prototype,"maxResults",void 0),e([a()],ie.prototype,"maxSuggestions",void 0),e([a()],ie.prototype,"messages",void 0),e([a()],ie.prototype,"minSuggestCharacters",void 0),e([a({readOnly:!0})],ie.prototype,"placeholder",null),e([a()],ie.prototype,"popupEnabled",void 0),e([a({type:v})],ie.prototype,"popupTemplate",void 0),e([a({type:x})],ie.prototype,"portal",void 0),e([a()],ie.prototype,"resultCount",void 0),e([a()],ie.prototype,"resultGraphicEnabled",void 0),e([a({readOnly:!0})],ie.prototype,"resultGraphic",void 0),e([a({readOnly:!0})],ie.prototype,"results",void 0),e([a({readOnly:!0})],ie.prototype,"selectedSuggestion",void 0),e([a()],ie.prototype,"searchAllEnabled",void 0),e([a({readOnly:!0})],ie.prototype,"selectedResult",void 0),e([a()],ie.prototype,"searchTerm",null),e([a({type:$})],ie.prototype,"sources",void 0),e([a({readOnly:!0,dependsOn:["allSources.length","updating"]})],ie.prototype,"state",null),e([a()],ie.prototype,"suggestionDelay",void 0),e([a()],ie.prototype,"suggestionCount",void 0),e([a({readOnly:!0})],ie.prototype,"suggestions",void 0),e([a()],ie.prototype,"suggestionsEnabled",void 0),e([a({readOnly:!0})],ie.prototype,"updating",null),e([a()],ie.prototype,"view",void 0),e([a()],ie.prototype,"clear",null),ie=e([n(K)],ie);var le=ie;export default le;
