/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{unwrap as e,isSome as o}from"../../../core/maybe.js";import t from"../../../geometry/Polygon.js";import r from"../../../Graphic.js";import s from"../../../tasks/support/AddressToLocationsParameters.js";import n from"../../../tasks/support/LocationToAddressParameters.js";import i from"../../../tasks/support/SuggestLocationsParameters.js";import{createExtentFromGeometry as c,scaleExtent as a}from"./geometryUtils.js";const u="Single Line Input",l=3e5;function m(e,o){return e.location?x(e,o):S(e,o)}function f(e){const o=null==e?void 0:e.scale;return"number"==typeof o&&o<=l?e.get("extent.center"):null}function d(o,t){const{source:r,spatialReference:s,view:n,suggestTerm:c,maxSuggestions:a,sourceIndex:u}=o,l=new i,{apiKey:m,locator:d}=r,g=v(r,n),p=t&&t.signal;if(!d)return Promise.resolve(null);m&&(l.apiKey=m),r.categories&&(l.categories=r.categories),s&&(l.outSpatialReference=s);const y=f(n);y&&(l.location=y);if(!c.trim())return Promise.resolve(null);const{prefix:x="",suffix:S=""}=r,w=`${x}${c}${S}`;return l.text=w,g&&(l.searchExtent=e(g)),l.maxSuggestions=a,r.countryCode&&(l.countryCode=r.countryCode),d.suggestLocations(l,{signal:p}).then((e=>k(e,u)))}function g(e){return!!e&&/(?:geocode\-api\.arcgis\.com\/arcgis\/rest\/services\/world\/geocodeserver).*/gi.test(e)}function p(e){return!!e&&/(?:\/servers\/[\da-z\.-]+\/rest\/services\/world\/geocodeserver).*/gi.test(e)}function y(e){return!!e&&/(?:arcgis\.com\/arcgis\/rest\/services\/world\/geocodeserver).*/gi.test(e)}function x(e,o){const{source:t,spatialReference:r,location:s,sourceIndex:i,view:c}=e,{apiKey:a,locator:u,zoomScale:l,defaultZoomScale:m}=t,f=c&&c.scale,d=o&&o.signal,g=new n;return g.location=s,a&&(g.apiKey=a),r&&(g.outSpatialReference=r),u.locationToAddress(g,{signal:d}).then((e=>K([e],{sourceIndex:i,scale:f,view:c,zoomScale:l,defaultZoomScale:m})))}function v(e,o){const{filter:t,withinViewEnabled:r}=e,s=o&&o.scale,n=o&&o.extent,i=t&&t.geometry;return c(i,o,s)||(r&&n?n:void 0)}function S(o,t){const{source:r,suggestResult:n,spatialReference:i,view:c,maxResults:a,sourceIndex:l}=o,m=r&&r.zoomScale,d=r&&r.defaultZoomScale;if(!n.text.trim())return Promise.resolve(null);const g=!n.key&&r.prefix?r.prefix:"",p=!n.key&&r.suffix?r.suffix:"",y=`${g}${n.text}${p}`,x=new s,{apiKey:S,locator:w}=r,k=c&&c.scale,I=v(r,c),L=t&&t.signal;if(S&&(x.apiKey=S),!w)return Promise.resolve(null);r.categories&&(x.categories=r.categories),r.locationType&&(x.locationType=r.locationType),i&&(x.outSpatialReference=i);const P=f(c);P&&(x.location=P),x.maxLocations=a,I&&(x.searchExtent=e(I)),r.countryCode&&(x.countryCode=r.countryCode);const{key:R}=n;return R&&(x.magicKey=R),x.address={},x.address[r.singleLineFieldName||u]=y,r.outFields&&(x.outFields=r.outFields),w.addressToLocations(x,{signal:L}).then((e=>K(e,{key:R,scale:k,sourceIndex:l,view:c,zoomScale:m,defaultZoomScale:d})))}function w(e,o){return{text:e.text,key:e.magicKey,sourceIndex:o}}function k(e,o){return e.map((e=>w(e,o)))}function I(e,s){const{key:n,scale:i,sourceIndex:u,view:l,zoomScale:m,defaultZoomScale:f}=s,{attributes:d,extent:g,location:p,address:y}=e,x=new r({geometry:p,attributes:d}),v=g||p,S=c(v,l,i),w="number"==typeof m?a(S,l,m):"number"==typeof f&&"point"===v.type?a(S,l,f):S,k=p?`${p.x},${p.y}`:"",I=y||k,K=x.clone();return o(w)&&(K.geometry=t.fromExtent(w)),{extent:w,feature:x,target:K,key:n,name:I,sourceIndex:u}}function K(e,o){return e.map((e=>I(e,o)))}export{f as getLocation,m as getResults,d as getSuggestions,y as isArcGISWorldGeocoder,g as isMeteredArcGISWorldGeocoder,p as isProxiedArcGISWorldGeocoder};
