/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import"../../../core/has.js";import"../../../core/Logger.js";import"../../../core/accessorSupport/ensureType.js";import{property as t}from"../../../core/accessorSupport/decorators/property.js";import{subclass as s}from"../../../core/accessorSupport/decorators/subclass.js";import"../../../core/urlUtils.js";import"../../../core/uuid.js";import"../../../portal/support/resourceExtension.js";import{pt2px as i}from"../../../core/screenUtils.js";import{substitute as r}from"../../../intl/substitute.js";import"../../../intl.js";import a from"../../../core/Handles.js";import"../../support/widgetUtils.js";import{accessibleHandler as o}from"../../support/decorators/accessibleHandler.js";import{messageBundle as l}from"../../support/decorators/messageBundle.js";import{j as n}from"../../../chunks/index.js";import c from"../../Widget.js";import{renderSVG as d}from"../../../symbols/support/svgUtils.js";import{renderRelationshipRamp as p}from"./support/relationshipUtils.js";import{getUnivariateAboveAndBelowRampElements as m,getUnivariateSizeRampSize as h,getUnivariateColorRampSize as y,getUnivariateColorRampPreview as g,getUnivariateColorRampMargin as _,getUnivariateColorSizeRampElements as v}from"./support/univariateUtils.js";import{getTitle as u,attachToNode as b,isImageryStretchedLegend as f}from"../support/styleUtils.js";const w={activated:"esri-legend--card__carousel-indicator--activated",base:"esri-legend--card",stacked:"esri-legend--stacked",carouselTitle:"esri-legend--card__carousel-title",indicator:"esri-legend--card__carousel-indicator",intervalSeparator:"esri-legend--card__interval-separator",imageryLayerStretchedImage:"esri-legend--card__imagery-layer-image--stretched",imageLabel:"esri-legend--card__image-label",layerCaption:"esri-legend--card__layer-caption",labelElement:"esri-legend--card__label-element",layerRow:"esri-legend--card__layer-row",labelCell:"esri-legend--card__label-cell",message:"esri-legend--card__message",rampLabel:"esri-legend--card__ramp-label",section:"esri-legend--card__section",relationshipSection:"esri-legend--card__relationship-section",serviceCaptionText:"esri-legend--card__service-caption-text",serviceContent:"esri-legend--card__service-content",service:"esri-legend--card__service",groupLayer:"esri-legend--card__group-layer",groupLayerChild:"esri-legend--card__group-layer-child",symbol:"esri-legend--card__symbol",sizeRampRow:"esri-legend--card__size-ramp-row",symbolRow:"esri-legend--card__symbol-row",symbolCell:"esri-legend--card__symbol-cell",indicatorContainer:"esri-legend--card__carousel-indicator-container",intervalSeparatorsContainer:"esri-legend--card__interval-separators-container",relationshipLabelContainer:"esri-legend--card__relationship-label-container",labelContainer:"esri-legend--card__label-container",serviceCaptionContainer:"esri-legend--card__service-caption-container",symbolContainer:"esri-legend--card__symbol-container",sizeRampContainer:"esri-legend--card__size-ramp-container",sizeRampPreview:"esri-legend--card__size-ramp-preview",rampContainer:"esri-legend__ramps",sizeRampHorizontal:"esri-legend__size-ramp--horizontal",rampLabelsContainer:"esri-legend__ramp-labels",layerInfo:"esri-legend__layer-cell esri-legend__layer-cell--info",univariateAboveAndBelowColorRamp:"esri-univariate-above-and-below-ramp__color--card",hidden:"esri-hidden",header:"esri-widget__heading"},L=25,C=25,x=768,S=100,z="#ddd",R=window.devicePixelRatio;function $(e){if(e){if(e.type.indexOf("3d")>-1){const t=e.symbolLayers&&e.symbolLayers.length;if(!t)return;const s=e.symbolLayers.getItemAt(t-1),i=s.resource&&s.resource.primitive;return"circle"===i||"cross"===i||"kite"===i||"sphere"===i||"cube"===i||"diamond"===i}{const t=e.style;return"circle"===t||"diamond"===t||"cross"===t}}}function I(e){if(e){if(e.type.indexOf("3d")>-1){const t=e.symbolLayers&&e.symbolLayers.length;if(!t)return;const s=e.symbolLayers.getItemAt(t-1).get("resource.primitive");return"triangle"===s||"cone"===s||"tetrahedron"===s}return"triangle"===e.style}}let k=class extends c{constructor(e,t){super(e,t),this._handles=new a,this._hasIndicators=!1,this._selectedSectionName=null,this._sectionNames=[],this._sectionMap=new Map,this.activeLayerInfos=null,this.layout="stack",this.messages=null,this.messagesCommon=null,this.type="card",this.view=null}initialize(){this.own([this.watch("activeLayerInfos",(e=>{this._handles.removeAll(),this._watchForSectionChanges(e)}))])}destroy(){this._handles.destroy(),this._handles=null}render(){this._hasIndicators="auto"===this.layout&&this.view.container.clientWidth<=x||"stack"===this.layout;const e=this.activeLayerInfos,t=e&&e.toArray().map((e=>this._renderLegendForLayer(e))).filter((e=>!!e));this._hasIndicators?this._selectedSectionName&&-1!==this._sectionNames.indexOf(this._selectedSectionName)||(this._selectedSectionName=this._sectionNames&&this._sectionNames[0]):this._selectedSectionName=null;const s=this._sectionNames.length,i=this._sectionNames.map(((e,t)=>{const i=r(this.messagesCommon.pagination.pageText,{index:t+1,total:s});return n("div",{key:e,role:"tab",id:e,"aria-label":i,"aria-controls":`${e}-panel`,"aria-selected":(this._selectedSectionName===e).toString(),tabIndex:this._selectedSectionName===e?0:-1,title:i,onclick:this._selectSection,onkeydown:this._focusSection,bind:this,class:this.classes(w.indicator,{[w.activated]:this._selectedSectionName===e}),"data-section-name":e})})),a=this._hasIndicators&&s>1?n("div",{class:w.indicatorContainer,key:"carousel-navigation",role:"tablist"},i):null,o=this._hasIndicators?this._sectionMap.get(this._selectedSectionName):t&&t.length?t:null,l={[w.stacked]:this._hasIndicators};return n("div",{class:this.classes(w.base,l)},o||n("div",{class:w.message},this.messages.noLegend),a)}_selectSection(e){const t=e.target.getAttribute("data-section-name");t&&(this._selectedSectionName=t)}_focusSection(e){switch(e.key){case"ArrowLeft":case"ArrowRight":this._switchSectionOnArrowPress(e);break;case"Enter":case" ":this._selectSection(e)}}_switchSectionOnArrowPress(e){const t=e.key,s="ArrowLeft"===t?-1:1,i=e.target.getAttribute("data-section-name"),r=this._sectionNames.indexOf(i),a=this._sectionNames;let o=null;-1!==r&&(a[r+s]?o=document.getElementById(a[r+s]):"ArrowLeft"===t?o=document.getElementById(a[a.length-1]):"ArrowRight"===t&&(o=document.getElementById(a[0])),o&&o.focus())}_watchForSectionChanges(e){if(this._generateSectionNames(),e){e.forEach((e=>{const t=`activeLayerInfo-${e.layer.uid}-version-change`;this._handles.remove(t),this._watchForSectionChanges(e.children),this._handles.add(e.watch("version",(()=>this._generateSectionNames())),t)}));const t="activeLayerInfos-collection-change";this._handles.remove(t),this._handles.add(e.on("change",(()=>this._watchForSectionChanges(e))),t)}}_generateSectionNames(){this._sectionNames.length=0,this._selectedSectionName=null,this.activeLayerInfos&&this.activeLayerInfos.forEach(this._generateSectionNamesForActiveLayerInfo,this)}_getSectionName(e,t,s){return`${this.id}${e.uid}-type-${t.type}-${s}`}_generateSectionNamesForActiveLayerInfo(e){e.children.forEach(this._generateSectionNamesForActiveLayerInfo,this),e.legendElements&&e.legendElements.forEach(((t,s)=>{this._sectionNames.push(this._getSectionName(e.layer,t,s))}))}_renderLegendForLayer(e){if(!e.ready)return null;if(e.children.length){const t=e.children.map((e=>this._renderLegendForLayer(e))).toArray();return n("div",{key:e.layer.uid,class:this.classes(w.service,w.groupLayer)},n("div",{class:w.serviceCaptionContainer},e.title),t)}{const t=e.legendElements;if(t&&!t.length)return null;const s=t.some((e=>"relationship-ramp"===e.type)),i=t.map(((t,i)=>this._renderLegendForElement(t,e,i,s))).filter((e=>!!e));if(!i.length)return null;const r={[w.groupLayerChild]:!!e.parent};return n("div",{key:e.layer.uid,class:this.classes(w.service,r)},n("div",{class:w.serviceCaptionContainer},n("div",{class:w.serviceCaptionText},e.title)),n("div",{class:w.serviceContent},i))}}_renderLegendForElement(e,t,s,i=!1){const r="color-ramp"===e.type,a="opacity-ramp"===e.type,o="size-ramp"===e.type,l=t.layer,c=e.title;let d=null;if("string"==typeof c)d=c;else if(c){const e=u(this.messages,c,r||a);d=c.title?`${c.title} (${e})`:e}const m=this._getSectionName(l,e,s),h=this._hasIndicators?n("div",null,n("h3",{class:this.classes(w.header,w.carouselTitle)},t.title),n("h4",{class:this.classes(w.header,w.layerCaption)},d)):d?n("h4",{class:this.classes(w.header,w.layerCaption)},d):null;let y=null;if("symbol-table"===e.type){const s=e.infos.map(((s,i)=>this._renderLegendForElementInfo(s,t,e.legendType,i))).filter((e=>!!e));if(s.length){const e=s[0].properties.classes&&s[0].properties.classes[w.symbolRow],t={[w.labelContainer]:!e&&!i,[w.relationshipLabelContainer]:i};y=n("div",{class:this.classes(t)},s)}}else"color-ramp"===e.type||"opacity-ramp"===e.type||"heatmap-ramp"===e.type?y=this._renderLegendForRamp(e,l.opacity):o?y=this._renderSizeRamp(e,l.opacity):"relationship-ramp"===e.type?y=p(e,this.id,l.opacity):"univariate-above-and-below-ramp"===e.type?y=this._renderUnivariateAboveAndBelowRamp(e,l.opacity):"univariate-color-size-ramp"===e.type&&(y=this._renderUnivariateColorSizeRamp(e,l.opacity));if(!y)return null;const g=n("div",{key:m,class:w.section,id:`${m}-panel`,role:"tabpanel","aria-labelledby":m,tabIndex:0},[h,y]);return this._sectionMap.set(m,g),g}_renderUnivariateAboveAndBelowRamp(e,t){const{sizeRampElement:s,colorRampElement:i}=m(e,t,"horizontal"),r=h(s,"full",!0,"horizontal"),a=y(s,"above",!0,"horizontal"),o=y(s,"below",!0,"horizontal"),l=12,c=g(i,{width:a,height:l,rampAlignment:"horizontal",opacity:t,type:"above"}),d=g(i,{width:o,height:l,rampAlignment:"horizontal",opacity:t,type:"below"}),p=_(s,"card"),v=s.infos.map((e=>e.label)),u=v.length-1,f=v.map(((e,t)=>0===t||t===u?n("div",{key:t},e):null)),L={display:"flex",flexDirection:"column"},C={display:"flex",flexDirection:"row"},x={marginTop:"3px",marginLeft:`${p}px`,display:"flex"},S={width:`${r}px`,display:"flex",flexDirection:"row",justifyContent:"space-between"};return n("div",{class:w.layerRow,key:"size-ramp-preview",styles:L},n("div",{class:this.classes(w.symbolContainer,w.sizeRampHorizontal),styles:C},s.infos.map(((e,t)=>n("div",{key:t,class:w.symbol,bind:e.preview,afterCreate:b})))),c?n("div",{class:w.univariateAboveAndBelowColorRamp,styles:x,key:"color-ramp-preview"},n("div",{bind:c,afterCreate:b}),n("div",{bind:d,afterCreate:b})):null,n("div",{class:w.layerInfo},n("div",{class:w.rampLabelsContainer,styles:S},f)))}_renderUnivariateColorSizeRamp(e,t){const{sizeRampElement:s,colorRampElement:i}=v(e,"horizontal"),r=h(s,"full",!1,"horizontal"),a=y(s,"full",!1,"horizontal"),o=g(i,{width:a,height:12,rampAlignment:"horizontal",opacity:t,type:"full"}),l=_(s,"card"),c=s.infos.length-1,d=s.infos.map(((e,t)=>0===t||t===c?n("div",{key:t},e.label):null)),p={display:"flex",flexDirection:"column"},m={display:"flex",flexDirection:"row"},u={marginTop:"3px",marginLeft:`${l}px`,display:"flex"},f={width:`${r}px`,display:"flex",flexDirection:"row",justifyContent:"space-between"};return n("div",{class:w.layerRow,key:"size-ramp-preview",styles:p},n("div",{class:this.classes(w.symbolContainer,w.sizeRampHorizontal),styles:m},s.infos.map(((e,t)=>n("div",{key:t,class:w.symbol,bind:e.preview,afterCreate:b})))),n("div",{class:w.univariateAboveAndBelowColorRamp,styles:u,key:"color-ramp-preview"},n("div",{bind:o,afterCreate:b})),n("div",{class:w.layerInfo},n("div",{class:w.rampLabelsContainer,styles:f},d)))}_renderLegendForElementInfo(e,t,s,i){const r=t.layer;if(e.type)return this._renderLegendForElement(e,t,i);const a=f(r,s);if(e.preview){var o,l;if(!e.symbol||-1===e.symbol.type.indexOf("simple-fill")){if(!e.label)return n("div",{key:i,bind:e.preview,afterCreate:b});const t={[w.symbolCell]:this._hasIndicators};return n("div",{key:i,class:this.classes(w.layerRow,{[w.symbolRow]:this._hasIndicators})},n("div",{class:this.classes(t),bind:e.preview,afterCreate:b}),n("div",{class:this.classes(w.imageLabel,{[w.labelCell]:this._hasIndicators})},u(this.messages,e.label,!1)||""))}let t=255,s=255,a=255,c=0,d=255,p=255,m=255,h=0;const y=e.symbol.color&&e.symbol.color.a,g=e.symbol.outline&&e.symbol.outline.color&&e.symbol.outline.color.a;y&&(t=e.symbol.color.r,s=e.symbol.color.g,a=e.symbol.color.b,c=e.symbol.color.a*r.opacity),g&&(d=e.symbol.outline.color.r,p=e.symbol.outline.color.g,m=e.symbol.outline.color.b,h=e.symbol.outline.color.a*r.opacity);const _=null==(o=null==(l=e.symbol.color)?void 0:l.isBright)||o,v=_?"rgba(255, 255, 255, .6)":"rgba(0, 0, 0, .6)",f={background:y?`rgba(${t}, ${s}, ${a}, ${c})`:"none",color:_?"black":"white",textShadow:`-1px -1px 0 ${v},\n                                              1px -1px 0 ${v},\n                                              -1px 1px 0 ${v},\n                                              1px 1px 0 ${v}`,border:g?`1px solid rgba(${d}, ${p}, ${m}, ${h})`:"none"};return n("div",{key:i,class:w.layerRow},n("div",{class:w.labelElement,styles:f}," ",e.label," "))}if(e.src){const t=this._renderImage(e,r,a);return n("div",{key:i,class:w.layerRow},t,n("div",{class:w.imageLabel},e.label||""))}}_renderImage(e,t,s){const{label:i,src:r,opacity:a}=e,o={[w.imageryLayerStretchedImage]:s,[w.symbol]:!s},l={opacity:`${null!=a?a:t.opacity}`};return n("img",{alt:u(this.messages,i,!1),src:r,border:0,width:e.width,height:e.height,class:this.classes(o),styles:l})}_renderSizeRampLines(e){const t=e.infos,s=t[0],r=t[t.length-1],a=s.symbol,o=this._hasIndicators,l=i(s.size+s.outlineSize)*R,c=i(r.size+r.outlineSize)*R,d=o?l:l+50*R,p=o?l/2+50*R:l,m=I(a),h=$(a),y=document.createElement("canvas");y.width=d,y.height=p,y.style.width=y.width/R+"px",y.style.height=y.height/R+"px";const g=y.getContext("2d");if(o){g.beginPath();const e=0,t=0,s=d/2-c/2,i=p;g.moveTo(e,t),g.lineTo(s,i);const r=d,a=0,o=d/2+c/2,l=p;g.moveTo(r,a),g.lineTo(o,l)}else{g.beginPath();const e=0,t=p/2-c/2,s=d,i=0;g.moveTo(e,t),g.lineTo(s,i);const r=0,a=p/2+c/2,o=d,l=p;g.moveTo(r,a),g.lineTo(o,l)}return g.strokeStyle=z,g.stroke(),n("div",{bind:y,afterCreate:b,styles:o?{display:"flex",marginTop:`-${m?0:h?l/2:0}px`,marginBottom:`-${m?c:h?c/2:0}px`}:{display:"flex",marginRight:`-${m?0:h?l/2:0}px`,marginLeft:`-${m?0:h?c/2:0}px`}})}_renderSizeRamp(e,t){const s=e.infos,i=s[0].label,r=s[s.length-1].label;let a=s[0].preview,o=s[s.length-1].preview;const l=this._hasIndicators,c={"flex-direction":l?"column":"row-reverse"};a&&(a=a.cloneNode(!0),a.style.display="flex"),o&&(o=o.cloneNode(!0),o.style.display="flex");const d={opacity:null!=t?`${t}`:""};return n("div",{class:this.classes(w.layerRow,{[w.sizeRampRow]:l})},n("div",{class:w.rampLabel},l?i:r),n("div",{class:w.sizeRampContainer,styles:c},n("div",{bind:a,afterCreate:b,class:w.sizeRampPreview,styles:d}),this._renderSizeRampLines(e),n("div",{bind:o,afterCreate:b,class:w.sizeRampContainer,styles:d})),n("div",{class:w.rampLabel},l?r:i))}_renderLegendForRamp(e,t){const s=e.infos,i="heatmap-ramp"===e.type,r=s.length-1,a=C,o=r>2&&!i?L*r:S,l=o+20,c=10,p=s.slice(0).reverse();p.forEach(((e,t)=>{e.offset=i?e.ratio:t/r}));const m=p.length-1,h=p.length%2!=0&&p[p.length/2|0],y=h&&n("div",{class:w.intervalSeparatorsContainer},n("div",{class:w.intervalSeparator},"|"),n("div",{class:w.rampLabel},h.label)),g=s[s.length-1].label,_=s[0].label;let v=null;null!=t&&(v=`opacity: ${t}`);const u=[[{shape:{type:"path",path:`M0 ${a/2} L${c} 0 L${c} ${a} Z`},fill:p[0].color,stroke:{width:0}},{shape:{type:"rect",x:c,y:0,width:o,height:a},fill:{type:"linear",x1:c,y1:0,x2:o+c,y2:0,colors:p},stroke:{width:0}},{shape:{type:"path",path:`M${o+c} 0 L${l} ${a/2} L${o+c} ${a} Z`},fill:p[m].color,stroke:{width:0}}]],b=d(u,l,a),{messages:f}=this;return n("div",{class:w.layerRow},n("div",{class:w.rampLabel},i?f[g]:g),n("div",{class:w.symbolContainer},n("div",{style:v},b),y),n("div",{class:w.rampLabel},i?f[_]:_))}};e([t()],k.prototype,"activeLayerInfos",void 0),e([t()],k.prototype,"layout",void 0),e([t(),l("esri/widgets/Legend/t9n/Legend")],k.prototype,"messages",void 0),e([t(),l("esri/t9n/common")],k.prototype,"messagesCommon",void 0),e([t({readOnly:!0})],k.prototype,"type",void 0),e([t()],k.prototype,"view",void 0),e([o()],k.prototype,"_selectSection",null),k=e([s("esri.widgets.Legend.styles.Card")],k);var N=k;export default N;
