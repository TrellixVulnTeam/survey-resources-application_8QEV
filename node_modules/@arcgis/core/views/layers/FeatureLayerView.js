/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import"../../core/has.js";import{isSome as t}from"../../core/maybe.js";import r from"../../core/Logger.js";import"../../core/accessorSupport/ensureType.js";import{property as i}from"../../core/accessorSupport/decorators/property.js";import{subclass as s}from"../../core/accessorSupport/decorators/subclass.js";import o from"../../core/Error.js";import"../../core/urlUtils.js";import"../../core/uuid.js";import"../../portal/support/resourceExtension.js";import{eachAlways as l}from"../../core/promiseUtils.js";import{loadArcade as a}from"../../support/arcadeOnDemand.js";import{fixFields as n,unpackFieldNames as u,collectLabelingFields as p,collectElevationFields as m,collectFilterFields as d,collectFeatureReductionFields as f,collectFields as c,collectField as y,featureHasFields as h}from"../../layers/support/fieldUtils.js";import{init as F,on as w}from"../../core/watchUtils.js";import{combinedViewLayerTimeExtentProperty as g}from"../../layers/support/commonProperties.js";import x from"../../tasks/support/Query.js";import v from"./support/FeatureFilter.js";import E from"./support/FeatureEffect.js";import{getFetchPopupTemplate as j,getRequiredFields as b}from"./support/popupUtils.js";const q=r.getLogger("esri.views.layers.FeatureLayerView"),R=r=>{let R=class extends r{constructor(...e){super(...e),this._updatingRequiredFieldsPromise=null,this.effect=null,this.filter=null,this.timeExtent=null,this.layer=null,this.requiredFields=[],this.view=null}initialize(){F(this,["layer.renderer","layer.labelingInfo","layer.elevationInfo.featureExpressionInfo","layer.displayField","filter","effect","layer.timeInfo","layer.floorInfo","timeExtent"],(()=>this._handleRequiredFieldsChange()),!0),w(this,"view.floors","change",(()=>this._handleRequiredFieldsChange()))}get availableFields(){const{layer:e,layer:{fields:t},requiredFields:r}=this;return"outFields"in e&&e.outFields?n(t,[...u(t,e.outFields),...r]):n(t,r)}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(e){q.error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}highlight(e){throw new Error("missing implementation")}createQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},r=t(this.filter)?this.filter.createQuery(e):new x(e);return t(this.timeExtent)&&(r.timeExtent=t(r.timeExtent)?r.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),r}queryFeatures(e,t){throw new Error("missing implementation")}queryObjectIds(e,t){throw new Error("missing implementation")}queryFeatureCount(e,t){throw new Error("missing implementation")}queryExtent(e,t){throw new Error("missing implementation")}_loadArcadeModules(e){if(e.get("expressionInfos.length"))return a()}_handleRequiredFieldsChange(){const e=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",e),e.then((()=>{this._updatingRequiredFieldsPromise===e&&this._set("_updatingRequiredFieldsPromise",null)}))}async _updateRequiredFields(){if(!this.layer||!this.view)return;const e="3d"===this.view.type,{layer:r,layer:{fields:i,objectIdField:s,renderer:o,displayField:a}}=this,n=r.featureReduction,u=new Set,h=await l([o?o.collectRequiredFields(u,i):null,p(u,r),e?m(u,r):null,t(this.filter)?d(u,r,this.filter):null,this.effect?d(u,r,this.effect.filter):null,n?f(u,r,n):null]);r.timeInfo&&this.timeExtent&&c(u,r.fields,[r.timeInfo.startField,r.timeInfo.endField]),"feature"===r.type&&r.floorInfo&&c(u,r.fields,[r.floorInfo.floorField]);for(const t of h)t.error&&q.error(t.error);y(u,i,s),e&&a&&y(u,i,a);const F=Array.from(u).sort();this._set("requiredFields",F)}validateFetchPopupFeatures(e){const{layer:t,layer:{popupEnabled:r}}=this;if(!r)return new o("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:t});return j(this.layer,e)?void 0:new o("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:t})}async fetchClientPopupFeatures(e){const r=t(e)?e.clientGraphics:null;if(!r||0===r.length)return Promise.resolve([]);const i=[],s=[],{layer:o}=this,l=j(o,e);if(!t(l))return Promise.resolve([]);const a=await this._loadArcadeModules(l),n=a&&a.arcadeUtils.hasGeometryOperations(l),p=await this.createPopupQuery(e),m=u(o.fields,p.outFields);for(const t of r)n||!h(m,t)?s.push(t):i.push(t);return"stream"===o.type||0===s.length?Promise.resolve(i):(p.objectIds=s.map((e=>e.attributes[o.objectIdField])),o.queryFeatures(p).then((e=>i.concat(e.features))).catch((()=>s)))}async createPopupQuery(e){const r=this.layer,i=r.createQuery(),s=j(r,e),o=t(s)&&await this._loadArcadeModules(s),l=t(s)&&o&&o.arcadeUtils.hasGeometryOperations(s),a=!("point"!==r.geometryType&&!l);return i.returnGeometry=a,i.returnZ=a,i.returnM=a,i.outFields=await b(this.layer,s),i.outSpatialReference=this.view.spatialReference,i}canResume(){return!!super.canResume()&&(!t(this.timeExtent)||!this.timeExtent.isEmpty)}};return e([i()],R.prototype,"_updatingRequiredFieldsPromise",void 0),e([i({readOnly:!0})],R.prototype,"availableFields",null),e([i({type:E})],R.prototype,"effect",void 0),e([i({type:v})],R.prototype,"filter",void 0),e([i(g)],R.prototype,"timeExtent",void 0),e([i()],R.prototype,"layer",void 0),e([i({type:Number})],R.prototype,"maximumNumberOfFeatures",null),e([i({readOnly:!0,type:Boolean})],R.prototype,"maximumNumberOfFeaturesExceeded",null),e([i({readOnly:!0})],R.prototype,"requiredFields",void 0),e([i()],R.prototype,"suspended",void 0),e([i()],R.prototype,"view",void 0),R=e([s("esri.views.layers.FeatureLayerView")],R),R};export default R;export{R as FeatureLayerView};
