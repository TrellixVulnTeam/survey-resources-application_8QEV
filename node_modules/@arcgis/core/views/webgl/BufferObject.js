/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{isUint16Array as e,isUint32Array as t}from"../../core/typedArrayUtil.js";import{checkWebGLError as i}from"./checkWebGLError.js";class s{constructor(e,t,s,n,r){this._context=e,this.bufferType=t,this.usage=s,this._glName=null,this._size=-1,this._indexType=void 0,e.instanceCounter.increment(1,this),this._glName=this._context.gl.createBuffer(),i(this._context.gl),n&&this.setData(n,r)}static createIndex(e,t,i,n){return new s(e,34963,t,i,n)}static createVertex(e,t,i){return new s(e,34962,t,i)}get glName(){return this._glName}get size(){return this._size}get indexType(){return this._indexType}get byteSize(){return 34962===this.bufferType?this._size:5125===this._indexType?4*this._size:2*this._size}dispose(){if(this._context){if(this._glName){this._context.gl.deleteBuffer(this._glName),this._glName=null}this._context.instanceCounter.decrement(1,this),this._context=null}}setData(i,s){if(!i)return;if("number"==typeof i){if(i<0&&console.error("Buffer size cannot be negative!"),34963===this.bufferType&&s)switch(this._indexType=s,this._size=i,s){case 5123:i*=2;break;case 5125:i*=4}}else{let s=i.byteLength;e(i)&&(s/=2,this._indexType=5123),t(i)&&(s/=4,this._indexType=5125),this._size=s}const n=this._context.getBoundVAO();this._context.bindVAO(null),this._context.bindBuffer(this);this._context.gl.bufferData(this.bufferType,i,this.usage),this._context.bindVAO(n)}setSubData(i,s=0,n=0,r=i.byteLength){if(!i)return;(s<0||s>=this._size)&&console.error("offset is out of range!");let h=s,o=n,c=r,f=i.byteLength;e(i)&&(f/=2,h*=2,o*=2,c*=2),t(i)&&(f/=4,h*=4,o*=4,c*=4),void 0===r&&(r=f-1),n>=r&&console.error("end must be bigger than start!"),s+n-r>this._size&&console.error("An attempt to write beyond the end of the buffer!");const u=this._context.getBoundVAO();this._context.bindVAO(null),this._context.bindBuffer(this);const a=this._context.gl,_=ArrayBuffer.isView(i)?i.buffer:i,l=0===o&&c===i.byteLength?_:_.slice(o,c);a.bufferSubData(this.bufferType,h,l),this._context.bindVAO(u)}}export default s;
