/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import e from"../../../../../../core/has.js";import{unwrap as t}from"../../../../../../core/maybe.js";import{convertFromFeatureSet as r,quantizeOptimizedFeatureSet as s}from"../../../../../../layers/graphics/featureConversionUtils.js";import{openWithPorts as i}from"../../../../../../core/workers/workers.js";import{executeQueryPBFBuffer as a,executeQuery as o}from"../../../../../../rest/query/operations/query.js";import{FeatureSetReaderJSON as n}from"../../support/FeatureSetReaderJSON.js";import{queryOptimizedFeatureSet as c}from"../../../../../../layers/ogc/ogcFeatureUtils.js";import{FeatureSetReaderPBF as u}from"../../support/FeatureSetReaderPBF.js";class l{constructor(e){this.service=e}destroy(){}}function m(e){return Array.isArray(e.source)}function p(e){return e&&e.capabilities&&e.collectionId&&e.layerDefinition&&e.url}function y(t){const{capabilities:r}=t;return p(t.source)?new v(t):m(t)?new f(t):r.query.supportsFormatPBF&&e("featurelayer-pbf")?new d(t):new h(t)}class f extends l{constructor(e){super(e),this._portsOpen=i(e.source).then((e=>this.client=e))}destroy(){this.client.close(),this.client=null}async executeQuery(e,t){await this._portsOpen;const r=await this.client.invoke("queryFeatures",e.toJSON(),t);return n.fromFeatureSet(r,this.service.objectIdField)}}class d extends l{async executeQuery(e,t){const{data:r}=await a(this.service.source,e,{...t,query:{...this.service.customParameters,...null==t?void 0:t.query}}),s=!e.quantizationParameters;return u.fromBuffer(r,this.service.geometryType,s)}}class h extends l{async executeQuery(e,i){const{source:a,capabilities:c,spatialReference:u,objectIdField:l}=this.service;if(e.quantizationParameters&&!c.query.supportsQuantization){const t=e.clone();t.quantizationParameters=null;const{data:c}=await o(a,t,u,{...i,query:{...this.service.customParameters,...null==i?void 0:i.query}}),m=r(c,l);return s(i.transform,m),n.fromOptimizedFeatureSet(m)}const{data:m}=await o(a,e,this.service.spatialReference,{...i,query:{...t(this.service.customParameters),...null==i?void 0:i.query}});return n.fromFeatureSet(m,this.service.objectIdField)}}class v extends l{async executeQuery(e,t){const{capabilities:r}=this.service;if(e.quantizationParameters&&!r.query.supportsQuantization){e.clone().quantizationParameters=null;const r=await c(this.service.source,e,t);return s(t.transform,r),n.fromOptimizedFeatureSet(r)}const i=await c(this.service.source,e,t);return n.fromOptimizedFeatureSet(i)}}export{l as SourceAdapter,y as createSourceAdapter};
