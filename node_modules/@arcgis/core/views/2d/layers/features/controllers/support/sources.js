/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{unwrap as e}from"../../../../../../core/maybe.js";import{convertFromFeatureSet as t,quantizeOptimizedFeatureSet as r}from"../../../../../../layers/graphics/featureConversionUtils.js";import{openWithPorts as s}from"../../../../../../core/workers/workers.js";import{executeQueryPBFBuffer as i,executeQuery as a}from"../../../../../../rest/query/operations/query.js";import{FeatureSetReaderJSON as o}from"../../support/FeatureSetReaderJSON.js";import{queryOptimizedFeatureSet as n}from"../../../../../../layers/ogc/ogcFeatureUtils.js";import{FeatureSetReaderPBF as c}from"../../support/FeatureSetReaderPBF.js";class u{constructor(e){this.service=e}destroy(){}}function l(e){return Array.isArray(e.source)}function m(e){return e&&e.capabilities&&e.collectionId&&e.layerDefinition&&e.url}function p(e){const{capabilities:t}=e;return m(e.source)?new h(e):l(e)?new y(e):t.query.supportsFormatPBF?new f(e):new d(e)}class y extends u{constructor(e){super(e),this._portsOpen=s(e.source).then((e=>this.client=e))}destroy(){this.client.close(),this.client=null}async executeQuery(e,t){await this._portsOpen;const r=await this.client.invoke("queryFeatures",e.toJSON(),t);return o.fromFeatureSet(r,this.service.objectIdField)}}class f extends u{async executeQuery(e,t){const{data:r}=await i(this.service.source,e,{...t,query:{...this.service.customParameters,...null==t?void 0:t.query}}),s=!e.quantizationParameters;return c.fromBuffer(r,this.service.geometryType,s)}}class d extends u{async executeQuery(s,i){const{source:n,capabilities:c,spatialReference:u,objectIdField:l}=this.service;if(s.quantizationParameters&&!c.query.supportsQuantization){const e=s.clone();e.quantizationParameters=null;const{data:c}=await a(n,e,u,{...i,query:{...this.service.customParameters,...null==i?void 0:i.query}}),m=t(c,l);return r(i.transform,m),o.fromOptimizedFeatureSet(m)}const{data:m}=await a(n,s,this.service.spatialReference,{...i,query:{...e(this.service.customParameters),...null==i?void 0:i.query}});return o.fromFeatureSet(m,this.service.objectIdField)}}class h extends u{async executeQuery(e,t){const{capabilities:s}=this.service;if(e.quantizationParameters&&!s.query.supportsQuantization){e.clone().quantizationParameters=null;const s=await n(this.service.source,e,t);return r(t.transform,s),o.fromOptimizedFeatureSet(s)}const i=await n(this.service.source,e,t);return o.fromOptimizedFeatureSet(i)}}export{u as SourceAdapter,p as createSourceAdapter};
