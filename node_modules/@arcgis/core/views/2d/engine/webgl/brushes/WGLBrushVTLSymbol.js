/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{isNone as t}from"../../../../../core/maybe.js";import{VTL_TEXTURE_BINDING_UNIT_SPRITES as e,VTL_TEXTURE_BINDING_UNIT_GLYPHS as a}from"../definitions.js";import{c as i,f as r}from"../../../../../chunks/vec2f32.js";import{FADE_DURATION as n}from"../../vectorTiles/decluttering/config.js";import{u32to4Xu8 as s}from"../number.js";import{WGLDrawPhase as o}from"../enums.js";import l from"./WGLBrush.js";import{degToByte as f}from"../GeometryUtils.js";const c=1/65536;class p extends l{constructor(){super(...arguments),this._iconProgramOptions={id:!1,sdf:!1},this._sdfProgramOptions={id:!1},this._spritesTextureSize=i()}dispose(){}drawMany(t,e){const{drawPhase:a,styleLayerUID:i}=t,r=t.styleLayer;let n;a===o.HITTEST&&(n=s(i+1)),this._drawIcons(t,r,e,n),this._drawText(t,r,e,n)}_drawIcons(a,i,r,s){const{context:l,displayLevel:c,drawPhase:p,painter:u,state:m,styleLayerUID:d}=a,g=i.iconMaterial,y=u.vectorTilesMaterialManager;let _,h=!1;for(const t of r)if(t.layerData.has(d)&&(_=t.layerData.get(d),_.iconPerPageElementsMap.size>0)){h=!0;break}if(!h)return;const M=i.getPaintValue("icon-translate",c),U=i.getPaintValue("icon-translate-anchor",c);let P=i.getLayoutValue("icon-rotation-alignment",c);2===P&&(P=0===i.getLayoutValue("symbol-placement",c)?1:0);const x=0===P,v=i.getLayoutValue("icon-keep-upright",c)&&x,T=_.isIconSDF,E=p===o.HITTEST,D=this._iconProgramOptions;D.id=E,D.sdf=T;const V=y.getMaterialProgram(l,g,D);l.bindProgram(V),V.setUniformMatrix3fv("u_displayViewMat3",0===P?m.displayViewMat3:m.displayMat3),V.setUniformMatrix3fv("u_displayMat3",1===U?m.displayMat3:m.displayViewMat3),V.setUniform2fv("u_iconTranslation",M),V.setUniform1f("u_depth",i.z),V.setUniform1f("u_mapRotation",f(m.rotation)),V.setUniform1f("u_keepUpright",v?1:0),V.setUniform1f("u_level",10*c),V.setUniform1i("u_texture",e),V.setUniform1f("u_fadeDuration",n/1e3),E&&V.setUniform4fv("u_id",s);let S=-1;for(const e of r){if(!e.layerData.has(d))continue;if(e.key.level!==S&&(S=e.key.level,g.setDataUniforms(V,c,i,S)),_=e.layerData.get(d),0===_.iconPerPageElementsMap.size)continue;_.prepareForRendering(l),_.updateOpacityInfo();const r=_.iconVertexArrayObject;if(!t(r)){l.bindVAO(r),V.setUniformMatrix3fv("u_dvsMat3",e.transforms.dvs),V.setUniform1f("u_time",(performance.now()-_.lastOpacityUpdate)/1e3);for(const[t,i]of _.iconPerPageElementsMap)this._renderIconRange(a,V,i,t,e)}}}_renderIconRange(t,a,i,r,n){const{context:s,spriteMosaic:o}=t;this._spritesTextureSize[0]=o.getWidth(r)/4,this._spritesTextureSize[1]=o.getHeight(r)/4,a.setUniform2fv("u_mosaicSize",this._spritesTextureSize),o.bind(s,9729,r,e),s.setStencilTestEnabled(!0),s.setStencilFunction(516,255,255),s.setStencilWriteMask(0),s.drawElements(4,i[1],5125,Uint32Array.BYTES_PER_ELEMENT*i[0]),n.triangleCount+=i[1]/3}_drawText(e,i,s,l){const{context:p,displayLevel:u,drawPhase:m,glyphMosaic:d,painter:g,pixelRatio:y,state:_,styleLayerUID:h}=e,M=i.textMaterial,U=g.vectorTilesMaterialManager;let P,x=!1;for(const t of s)if(t.layerData.has(h)&&(P=t.layerData.get(h),P.glyphPerPageElementsMap.size>0)){x=!0;break}if(!x)return;const v=i.getPaintProperty("text-opacity");if(v&&!v.isDataDriven&&0===v.getValue(u))return;const T=i.getPaintProperty("text-color"),E=!T||T.isDataDriven||T.getValue(u)[3]>0,D=i.getPaintProperty("text-halo-width"),V=i.getPaintProperty("text-halo-color"),S=(!D||D.isDataDriven||D.getValue(u)>0)&&(!V||V.isDataDriven||V.getValue(u)[3]>0);if(!E&&!S)return;const w=24/8;let b=i.getLayoutValue("text-rotation-alignment",u);2===b&&(b=0===i.getLayoutValue("symbol-placement",u)?1:0);const L=0===b,z=i.getLayoutValue("text-keep-upright",u)&&L,k=m===o.HITTEST,I=.8*w/y;this._glyphTextureSize||(this._glyphTextureSize=r(d.width/4,d.height/4));const O=i.getPaintValue("text-translate",u),R=i.getPaintValue("text-translate-anchor",u),j=this._sdfProgramOptions;j.id=k;const A=U.getMaterialProgram(p,M,j);p.bindProgram(A),A.setUniformMatrix3fv("u_displayViewMat3",0===b?_.displayViewMat3:_.displayMat3),A.setUniformMatrix3fv("u_displayMat3",1===R?_.displayMat3:_.displayViewMat3),A.setUniform2fv("u_textTranslation",O),A.setUniform1f("u_depth",i.z+c),A.setUniform2fv("u_mosaicSize",this._glyphTextureSize),A.setUniform1f("u_mapRotation",f(_.rotation)),A.setUniform1f("u_keepUpright",z?1:0),A.setUniform1f("u_level",10*u),A.setUniform1i("u_texture",a),A.setUniform1f("u_antialiasingWidth",I),A.setUniform1f("u_fadeDuration",n/1e3),k&&A.setUniform4fv("u_id",l);let F=-1;for(const a of s){if(!a.layerData.has(h))continue;if(a.key.level!==F&&(F=a.key.level,M.setDataUniforms(A,u,i,F)),P=a.layerData.get(h),0===P.glyphPerPageElementsMap.size)continue;P.prepareForRendering(p),P.updateOpacityInfo();const e=P.textVertexArrayObject;if(t(e))continue;p.bindVAO(e),A.setUniformMatrix3fv("u_dvsMat3",a.transforms.dvs),p.setStencilTestEnabled(!0),p.setStencilFunction(516,255,255),p.setStencilWriteMask(0);const r=(performance.now()-P.lastOpacityUpdate)/1e3;A.setUniform1f("u_time",r),P.glyphPerPageElementsMap.forEach(((t,e)=>{this._renderGlyphRange(p,t,e,d,A,S,E,a)}))}}_renderGlyphRange(t,e,i,r,n,s,o,l){r.bind(t,9729,i,a),s&&(n.setUniform1f("u_halo",1),t.drawElements(4,e[1],5125,Uint32Array.BYTES_PER_ELEMENT*e[0]),l.triangleCount+=e[1]/3),o&&(n.setUniform1f("u_halo",0),t.drawElements(4,e[1],5125,Uint32Array.BYTES_PER_ELEMENT*e[0]),l.triangleCount+=e[1]/3)}}export{p as WGLBrushVTLSymbol};
