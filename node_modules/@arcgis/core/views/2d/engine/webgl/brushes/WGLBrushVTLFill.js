/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{isNone as t}from"../../../../../core/maybe.js";import{VTL_TEXTURE_BINDING_UNIT_SPRITES as e,VTL_HIGH_RES_CUTOFF as i}from"../definitions.js";import{c as a}from"../../../../../chunks/mat3f32.js";import{u32to4Xu8 as r}from"../number.js";import{WGLDrawPhase as n}from"../enums.js";import l from"./WGLBrush.js";const o=1/65536;class s extends l{constructor(){super(...arguments),this._fillProgramOptions={id:!1,pattern:!1},this._outlineProgramOptions={id:!1},this._patternMatrix=a()}dispose(){}drawMany(t,e){const{displayLevel:i,drawPhase:a,renderPass:l,styleLayerUID:o}=t,s=t.styleLayer,f=s.getPaintValue("fill-pattern",i),u=void 0!==f,d=!u&&s.getPaintValue("fill-antialias",i);let p=!0,m=1;if(!u){const t=s.getPaintProperty("fill-color"),e=s.getPaintProperty("fill-opacity");if(!(null!=t&&t.isDataDriven||null!=e&&e.isDataDriven)){const t=s.getPaintValue("fill-color",i);m=s.getPaintValue("fill-opacity",i)*t[3],m>=1&&(p=!1)}}if(p&&"opaque"===l)return;let c;a===n.HITTEST&&(c=r(o+1));const _=s.getPaintValue("fill-translate",i),y=s.getPaintValue("fill-translate-anchor",i);(p||"translucent"!==l)&&this._drawFill(t,o,s,e,_,y,f,c);const M=!s.hasDataDrivenOutlineColor&&s.outlineUsesFillColor&&m<1;d&&"opaque"!==l&&!M&&this._drawOutline(t,o,s,e,_,y,c)}_drawFill(a,r,l,s,f,u,d,p){const{context:m,displayLevel:c,state:_,drawPhase:y,painter:M,pixelRatio:g,spriteMosaic:v}=a,x=l.fillMaterial,P=M.vectorTilesMaterialManager,h=void 0!==d,U=g>i?2:1;let T;const E=y===n.HITTEST,b=this._fillProgramOptions;b.id=E,b.pattern=h;const w=P.getMaterialProgram(m,x,b);if(m.bindProgram(w),h){if(T=v.getMosaicItemPosition(d,!0),!T)return void m.bindProgram();w.setUniform2f("u_pattern_tl",T.tl[0],T.tl[1]),w.setUniform2f("u_pattern_br",T.br[0],T.br[1]),w.setUniform1i("u_texture",e),v.bind(m,9729,T.page,e)}w.setUniformMatrix3fv("u_displayMat3",1===u?_.displayMat3:_.displayViewMat3),w.setUniform2fv("u_fillTranslation",f),w.setUniform1f("u_depth",l.z+o),E&&w.setUniform4fv("u_id",p);let D=-1;for(const e of s){if(!e.layerData.has(r))continue;e.key.level!==D&&(D=e.key.level,x.setDataUniforms(w,c,l,D));const i=e.layerData.get(r);i.prepareForRendering(m);const a=i.fillVertexArrayObject;if(!t(a)){if(m.bindVAO(a),w.setUniformMatrix3fv("u_dvsMat3",e.transforms.dvs),h){const t=Math.max(2**(Math.round(c)-e.key.level),1),i=e.coordRange[0]/(U*e.size[0]*t),a=1/(T.size[0]*i),r=1/(T.size[1]*i);this._patternMatrix[0]=a,this._patternMatrix[4]=r,w.setUniformMatrix3fv("u_pattern_matrix",this._patternMatrix)}m.setStencilFunction(514,e.stencilRef,255),m.drawElements(4,i.fillIndexCount,5125,Uint32Array.BYTES_PER_ELEMENT*i.fillIndexStart),e.triangleCount+=i.fillIndexCount/3}}}_drawOutline(e,i,a,r,l,s,f){const{context:u,displayLevel:d,state:p,drawPhase:m,painter:c,pixelRatio:_}=e,y=a.outlineMaterial,M=c.vectorTilesMaterialManager,g=.75/_,v=m===n.HITTEST,x=this._outlineProgramOptions;x.id=v;const P=M.getMaterialProgram(u,y,x);u.bindProgram(P),P.setUniformMatrix3fv("u_displayMat3",1===s?p.displayMat3:p.displayViewMat3),P.setUniform2fv("u_fillTranslation",l),P.setUniform1f("u_depth",a.z+o),P.setUniform1f("u_outline_width",g),v&&P.setUniform4fv("u_id",f);let h=-1;for(const n of r){if(!n.layerData.has(i))continue;n.key.level!==h&&(h=n.key.level,y.setDataUniforms(P,d,a,h));const e=n.layerData.get(i);e.prepareForRendering(u);const r=e.outlineVertexArrayObject;t(r)||(u.bindVAO(r),P.setUniformMatrix3fv("u_dvsMat3",n.transforms.dvs),u.setStencilFunction(514,n.stencilRef,255),u.drawElements(4,e.outlineIndexCount,5125,Uint32Array.BYTES_PER_ELEMENT*e.outlineIndexStart),n.triangleCount+=e.outlineIndexCount/3)}}}export{s as WGLBrushVTLFill};
