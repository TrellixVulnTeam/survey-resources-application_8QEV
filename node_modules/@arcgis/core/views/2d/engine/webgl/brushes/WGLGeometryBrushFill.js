/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import"../../../../../core/has.js";import e from"../../../../../core/RandomLCG.js";import{TEXTURE_BINDING_RENDERER_0 as t,TEXTURE_BINDING_RENDERER_1 as o,TILE_SIZE as i}from"../definitions.js";import"../../../../../chunks/builtins.js";import"../../../../webgl/checkWebGLError.js";import r from"../../../../webgl/Texture.js";import"../../../../webgl/FramebufferObject.js";import{WGLGeometryType as s}from"../enums.js";import{FillMaterialKey as a}from"../materialKey/MaterialKey.js";import{createProgramDescriptor as n}from"../Utils.js";import l from"./WGLGeometryBrush.js";const d=e=>n(e.data,{geometry:[{location:0,name:"a_pos",count:2,type:5122},{location:1,name:"a_id",count:4,type:5121},...e.dotDensity?[]:[{location:2,name:"a_color",count:4,type:5121,normalized:!0},{location:3,name:"a_tlbr",count:4,type:5123},{location:4,name:"a_aux1",count:4,type:5121},{location:5,name:"a_aux2",count:2,type:5123},{location:6,name:"a_aux3",count:4,type:5121}],...e.dotDensity?[{location:2,name:"a_inverseArea",count:1,type:5126}]:[]]});class u extends l{constructor(){super(...arguments),this._dotTextureSize=0,this._dotTextures=null,this._dotSamplers=new Int32Array([t,o])}dispose(){this._disposeTextures()}getGeometryType(){return s.FILL}drawGeometry(e,t,o,r){const{context:s,painter:n,rendererInfo:l,requiredLevel:u}=e,m=a.load(o.materialKey),{bufferLayouts:c,attributes:_}=d(m),f=n.materialManager.getMaterialProgram(e,m,"materials/fill",_,r);if(s.bindProgram(f),this._setSharedUniforms(f,e,t),m.textureBinding){n.textureManager.bindTextures(s,f,m);const o=1/2**(u-t.key.level)/e.pixelRatio;f.setUniform1f("u_zoomFactor",o)}if(m.vvColor&&(f.setUniform1fv("u_vvColorValues",l.vvColorValues),f.setUniform4fv("u_vvColors",l.vvColors)),m.vvOpacity&&(f.setUniform1fv("u_vvOpacityValues",l.vvOpacityValues),f.setUniform1fv("u_vvOpacities",l.vvOpacities)),m.dotDensity){const o=i/l.ddDotSize,r=o*window.devicePixelRatio*o*window.devicePixelRatio,a=1/2**(u-t.key.level),n=1/a*(1/a),d=l.ddDotScale?e.state.scale/l.ddDotScale:1;f.setUniform1f("u_tileZoomFactor",a),f.setUniform1f("u_tileDotsOverArea",r/(i*window.devicePixelRatio*i*window.devicePixelRatio)),f.setUniformMatrix4fv("u_dotColors",l.ddColors),f.setUniform4fv("u_isActive",l.ddActiveDots),f.setUniform4fv("u_dotBackgroundColor",l.ddBackgroundColor),f.setUniform1f("u_dotValue",Math.max(1,l.ddDotValue*d*n)),this._bindDotDensityTextures(s,f,l,o)}o.draw(s,c,_)}_disposeTextures(){if(this._dotTextures){for(let e=0;e<this._dotTextures.length;e++)this._dotTextures[e].dispose();this._dotTextures=null}}_bindDotDensityTextures(e,t,o,i){const r=this._createDotDensityTextures(e,i,o.ddSeed);t.setUniform1iv("u_dotTextures",this._dotSamplers);for(let s=0;s<r.length;s++)e.bindTexture(r[s],this._dotSamplers[s])}_createDotDensityTextures(t,o,i){if(this._dotTextureSize===o&&this._seed===i||(this._disposeTextures(),this._dotTextureSize=o,this._seed=i),null===this._dotTextures){const r=new e(i);this._dotTextures=[this._allocDotDensityTexture(t,o,r),this._allocDotDensityTexture(t,o,r)]}return this._dotTextures}_allocDotDensityTexture(e,t,o){const i=new Float32Array(t*t*4);for(let r=0;r<i.length;r++)i[r]=o.getFloat();return new r(e,{wrapMode:10497,pixelFormat:6408,dataType:5126,samplingMode:9728,width:t,height:t},i)}}export default u;
