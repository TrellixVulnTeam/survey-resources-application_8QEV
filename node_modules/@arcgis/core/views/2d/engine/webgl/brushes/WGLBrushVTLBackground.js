/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import"../../../../../core/has.js";import"../../../../../core/mathUtils.js";import{f as t}from"../../../../../chunks/vec4f32.js";import{VTL_TEXTURE_BINDING_UNIT_SPRITES as r,VTL_HIGH_RES_CUTOFF as e}from"../definitions.js";import{c as o}from"../../../../../chunks/mat3f32.js";import"../../../../../chunks/builtins.js";import i from"../../../../webgl/BufferObject.js";import s from"../../../../webgl/VertexArrayObject.js";import"../../../../webgl/FramebufferObject.js";import{u32to4Xu8 as a}from"../number.js";import{WGLDrawPhase as n}from"../enums.js";import c from"./WGLBrush.js";class f extends c{constructor(){super(...arguments),this._color=t(1,0,0,1),this._patternMatrix=o(),this._programOptions={id:!1,pattern:!1}}dispose(){this._vao&&(this._vao.dispose(),this._vao=null)}drawMany(t,o){const{context:i,painter:s,styleLayerUID:c}=t;this._loadWGLResources(t);const f=t.displayLevel,m=t.styleLayer,l=m.backgroundMaterial,u=s.vectorTilesMaterialManager,p=m.getPaintValue("background-color",f),_=m.getPaintValue("background-opacity",f),d=m.getPaintValue("background-pattern",f),h=void 0!==d,g=p[3]*_,b=1|window.devicePixelRatio,v=t.spriteMosaic;let M;const x=b>e?2:1,y=t.drawPhase===n.HITTEST,j=this._programOptions;j.id=y,j.pattern=h;const U=u.getMaterialProgram(i,l,j);if(i.bindVAO(this._vao),i.bindProgram(U),h){if(M=v.getMosaicItemPosition(d,!0),!M)return;U.setUniform1f("u_opacity",_),U.setUniform2f("u_pattern_tl",M.tl[0],M.tl[1]),U.setUniform2f("u_pattern_br",M.br[0],M.br[1]),U.setUniform1i("u_texture",r),v.bind(i,9729,M.page,r)}else this._color[0]=g*p[0],this._color[1]=g*p[1],this._color[2]=g*p[2],this._color[3]=g,U.setUniform4fv("u_color",this._color);if(U.setUniform1f("u_depth",m.z||0),y){const t=a(c+1);U.setUniform4fv("u_id",t)}for(const r of o){if(U.setUniform1f("u_coord_range",r.coordRange[0]),U.setUniformMatrix3fv("u_dvsMat3",r.transforms.dvs),h){const t=Math.max(2**(Math.round(f)-r.key.level),1),e=x*r.size[0]*t,o=e/M.size[0],i=e/M.size[1];this._patternMatrix[0]=o,this._patternMatrix[4]=i,U.setUniformMatrix3fv("u_pattern_matrix",this._patternMatrix)}i.setStencilFunction(514,r.stencilRef,255),i.drawArrays(5,0,4)}}_loadWGLResources(t){if(this._vao)return;const{context:r,styleLayer:e}=t,o=e.backgroundMaterial,a=new Int8Array([0,0,1,0,0,1,1,1]),n=i.createVertex(r,35044,a),c=new s(r,o.getAttributeLocations(),o.getLayoutInfo(),{geometry:n});this._vao=c}}export{f as WGLBrushVTLBackground};
