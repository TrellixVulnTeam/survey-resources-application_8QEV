/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import"../../../../../../core/has.js";import e from"../../../../../../core/Logger.js";import"../../../../../../chunks/builtins.js";import"../../../../../webgl/checkWebGLError.js";import t from"../../../../../webgl/Texture.js";import s from"../../../../../webgl/FramebufferObject.js";import r from"../../VertexStream.js";const i=e.getLogger("esri.views.2d.engine.webgl.effects.post-processing.DRA"),o=2;class n{constructor(){this._fbos=null,this._colorAttachmentsPoints=[36064,36065],this._size=[0,0],this._programDesc={"min-max":{vsPath:"post-processing/pp",fsPath:"post-processing/dra/min-max",attributes:{a_position:0}},dra:{vsPath:"post-processing/pp",fsPath:"post-processing/dra",attributes:{a_position:0}}}}dispose(){this._disposeFBOs(),this._layerTexture&&(this._layerTexture.dispose(),this._layerTexture=null)}draw(e,t,s){this._createOrResizeResources(e);const{context:o,state:n,painter:a,pixelRatio:h}=e,{materialManager:d}=a,u=this._programDesc,{size:l}=n,p=this._fbos,c=[h*l[0],h*l[1]],m=o.capabilities.drawBuffers;if(!m)return void i.error("esri.DRA","WebGL Extension WEBGL_draw_buffers isn't supported!");this._quad||(this._quad=new r(o,[-1,-1,1,-1,-1,1,1,1]));const f=this._layerTexture;t.copyToTexture(0,0,c[0],c[1],0,0,f);const _=this._quad;_.bind();const b=d.getProgram(e,u["min-max"]);o.bindProgram(b),o.setBlendingEnabled(!1);let g,x=t.colorTexture,T=t.colorTexture;const w=[c[0],c[1]],M=[0,0];for(let r=0;r<p.length;r++){const e=p[r],t=e.descriptor;M[0]=t.width,M[1]=t.height,o.bindFramebuffer(e),m.drawBuffers(this._colorAttachmentsPoints),o.setViewport(0,0,t.width,t.height),g=r,g>6&&(g=6),o.bindTexture(x,g),o.bindTexture(T,g+1),b.setUniform1i("u_minTexture",g),b.setUniform1i("u_maxTexture",g+1),b.setUniform2fv("u_srcResolution",w),b.setUniform2fv("u_dstResolution",M),_.draw(),x=e.getColorTexture(36064),T=e.getColorTexture(36065),w[0]=M[0],w[1]=M[1]}o.setViewport(0,0,c[0],c[1]),o.bindFramebuffer(t);const P=d.getProgram(e,u.dra);o.bindProgram(P),o.bindTexture(x,5),o.bindTexture(T,6),o.bindTexture(f,7),P.setUniform1i("u_minColor",5),P.setUniform1i("u_maxColor",6),P.setUniform1i("u_texture",7),o.setStencilWriteMask(0),o.setStencilTestEnabled(!1),o.setDepthWriteEnabled(!1),o.setDepthTestEnabled(!1),_.draw(),o.setBlendingEnabled(!0),o.setBlendFunction(1,771),o.setStencilTestEnabled(!0),_.unbind()}_createOrResizeResources(e){const{context:r,state:i,pixelRatio:n}=e,{size:a}=i;let h=Math.round(n*a[0]),d=Math.round(n*a[1]);if(this._size[0]!==h||this._size[1]!==d){for(this._size[0]=h,this._size[1]=d,this._disposeFBOs(),this._fbos=[];h>1||d>1;){h=Math.max(1,0|Math.floor((h+o-1)/o)),d=Math.max(1,0|Math.floor((d+o-1)/o));const e={pixelFormat:6408,internalFormat:6408,dataType:5121,samplingMode:9728,wrapMode:33071,flipped:!1,width:h,height:d},t=new s(r,{depthStencilTarget:0,width:h,height:d},[{attachmentPoint:36064,texture:e},{attachmentPoint:36065,texture:e}]);this._fbos.push(t)}this._layerTexture?this._layerTexture.resize(Math.round(n*a[0]),Math.round(n*a[1])):this._layerTexture=new t(r,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:Math.round(n*a[0]),height:Math.round(n*a[1])})}}_disposeFBOs(){if(this._fbos){for(const e of this._fbos)e.dispose();this._fbos.length=0,this._fbos=null}}}export{n as DRA};
