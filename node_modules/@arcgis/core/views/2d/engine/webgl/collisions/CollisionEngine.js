/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{isSome as e}from"../../../../../core/maybe.js";import{FILTER_FLAG_0 as t,EFFECT_FLAG_0 as i}from"../definitions.js";import{CollisionBitsetGrid as s,NONE as o,HAS_COLLISION as r,OUTSIDE_EXTENT as n}from"./CollisionGrid.js";import a from"./LayerCollisionInfo.js";const l=254,d=255,c=0;function h(t,i){const s=[];t.forEachTile((e=>s.push(e))),s.sort(((e,t)=>e.instanceId-t.instanceId)),s.forEach((t=>{e(t.labelMetrics)&&t.isReady&&i(t,t.labelMetrics.getCursor())}))}class f{constructor(e){this._layers=new Map,this._tilingScheme=e}get collisionInfos(){return Array.from(this._layers.values())}registerLayerView(e,t){if(this._layers.has(e))return;const i=a.create(e,t,this.collisionInfos,this._tilingScheme);this._layers.set(e,i)}unregisterLayerView(e){if(!this._layers.has(e))return;const t=this._layers.get(e);a.delete(t.index,this.collisionInfos),this._layers.delete(e)}run(e,t){this._transformMetrics(e),this._runCollision(e,t)}_runCollision(e,t){const[i,o]=e.state.size,r=new s(i,o);this._forEachLayer(((e,i)=>{const s=e.zoomRanges.some((e=>"none"===e.deconflictionStrategy)),o=i.featuresView.attributeView;s?h(i,((e,t)=>{for(;t.nextId();)o.setLabelMinZoom(t.id,c)})):(this._prepare(i),this._collideVisible(r,i,t),this._collideInvisible(r,i))}))}_isFiltered(e,s,o){const r=s.getFilterFlags(e),n=!o.hasFilter||!!(r&t),a=!o.effect||o.effect.excludedLabelsVisible||!!(r&i);return!(n&&a)}_prepare(e){const t=e.featuresView.attributeView,i=new Set;h(e,((s,o)=>{for(;o.nextId();){if(i.has(o.id))continue;if(i.add(o.id),this._isFiltered(o.id,t,e.layerView)){t.setLabelMinZoom(o.id,l);continue}t.getLabelMinZoom(o.id)!==c?t.setLabelMinZoom(o.id,d):t.setLabelMinZoom(o.id,c)}}))}_collideVisible(e,t,i){const s=t.featuresView.attributeView,a=new Set;h(t,((t,d)=>{for(;d.nextId();)if(!a.has(d.id))if(t.key.level===i){if(0===s.getLabelMinZoom(d.id)){switch(e.insertMetrics(d)){case n:break;case r:s.setLabelMinZoom(d.id,l),a.add(d.id);break;case o:s.setLabelMinZoom(d.id,c),a.add(d.id)}}}else s.setLabelMinZoom(d.id,l)}))}_collideInvisible(e,t){const i=t.featuresView.attributeView,s=new Set;h(t,((t,a)=>{for(;a.nextId();)if(!s.has(a.id)&&i.getLabelMinZoom(a.id)===d){switch(e.insertMetrics(a)){case n:break;case r:i.setLabelMinZoom(a.id,d),s.add(a.id);break;case o:i.setLabelMinZoom(a.id,c),s.add(a.id)}}}))}_transformMetrics(e){this._forEachLayer(((t,i)=>{h(i,((s,o)=>{const r=i.featuresView.attributeView,n=s.transforms.labelMat2d;n[4]=Math.round(n[4]),n[5]=Math.round(n[5]);const a=n[4],l=n[5],d="polyline"===t.geometryType;for(;o.next();){const i=o.boundsCount,s=o.anchorX,c=o.anchorY;let h=0,f=0;if(t.hasVV()){const e=r.getVVSize(o.id),i=t.vvEval(e),s=isNaN(i)||null==i||i===1/0?o.size:i;h=o.directionX*(s/2),f=o.directionY*(s/2)}for(let t=0;t<i;t++){let i=s,r=o.anchorY;if(d){let s=i+o.boundsCenterX(t)+h,d=r+o.boundsCenterY(t)+f;e.state.rotation?(s=n[0]*s+n[2]*d+n[4],d=n[1]*s+n[3]*d+n[5]):(s+=a,d+=l),o.setBoundsComputedAnchorX(t,Math.floor(s)),o.setBoundsComputedAnchorY(t,Math.floor(d))}else{e.state.rotation?(i=n[0]*s+n[2]*c+n[4],r=n[1]*s+n[3]*c+n[5]):(i+=a,r+=l);const d=i+o.boundsCenterX(t)+h,u=r+o.boundsCenterY(t)+f;o.setBoundsComputedAnchorX(t,d),o.setBoundsComputedAnchorY(t,u)}}}}))}))}_forEachLayer(e){const t=[];this._layers.forEach((e=>t.push(e))),t.sort(((e,t)=>e.order-t.order)),t.forEach((t=>{var i;const s=null==(i=t.layerView)?void 0:i.tileRenderer;s&&e(t,s)}))}}export{f as CollisionEngine};
