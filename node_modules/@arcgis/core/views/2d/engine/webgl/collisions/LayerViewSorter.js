/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import e from"../../../../../core/Logger.js";import r from"../../../../../core/Error.js";const t=4294967295,i=-1,a=e.getLogger("esri.views.2d.engine.collisions.LayerViewSorter");function s(e){return"esri.views.2d.layers.FeatureLayerView2D"===e.declaredClass||"esri.views.2d.layers.StreamLayerView2D"===e.declaredClass}function l(e){if(!e.layer||!e.layer.renderer)return!1;switch(e.layer.renderer.type){case"class-breaks":case"simple":case"unique-value":case"dictionary":case"dot-density":return!0;default:return a.error(new r("mapview-labeling",`Renderer of type ${e.layer.renderer.type} does not currently support labeling`)),!1}}class n{constructor(e,r){this.registerLayer=e,this.unregisterLayer=r,this._layerViewState=new Map}findIndex(e){return e.view.allLayerViews.findIndex((r=>r.uid===e.uid))}update(e){const{added:r,removed:t}=e;for(const i of t)s(i)&&this._layerViewState.has(i)&&this._deleteState(i);for(const i of r)s(i)&&l(i)&&!this._layerViewState.has(i)&&this._createState(i);this._recomputeOrder()}destroy(){this._layerViewState.forEach((e=>e.handles.forEach((e=>e.remove()))))}_createState(e){const r={priority:-1,handles:null};return r.handles=[e.layer.watch("visible",this._recomputeOrder.bind(this)),e.layer.watch("labelsVisible",this._recomputeOrder.bind(this)),e.layer.watch("labelingInfo",this._recomputeOrder.bind(this)),e.layer.watch("featureReduction",this._recomputeOrder.bind(this))],this._layerViewState.set(e,r),r}_deleteState(e){if(!this._layerViewState.has(e))return;const r=this._layerViewState.get(e);r.handles.forEach((e=>e.remove())),r.priority!==i&&this.unregisterLayer(e),this._layerViewState.delete(e)}_recomputeOrder(){this._layerViewState.forEach(((e,r)=>{const a=r.view.map.allLayers.findIndex((e=>e.uid===r.layer.uid)),s=r.layer,l=s.featureReduction,n=l&&"cluster"===l.type&&l.labelsVisible&&l.labelingInfo&&l.labelingInfo.length,o=s.labelsVisible&&s.labelingInfo&&s.labelingInfo.length||n,d=s.visible&&o?t-a:i;d!==e.priority&&(e.priority=d,this.unregisterLayer(r),d!==i&&this.registerLayer(r,d))}))}}export{n as LayerViewSorter};
