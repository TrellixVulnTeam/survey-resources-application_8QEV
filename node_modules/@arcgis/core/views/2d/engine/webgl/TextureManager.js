/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import e from"../../../../config.js";import{isNone as t}from"../../../../core/maybe.js";import i from"../../../../core/Logger.js";import s from"../../../../core/Error.js";import{throwIfAborted as r,isAbortError as a}from"../../../../core/promiseUtils.js";import{pt2px as n}from"../../../../core/screenUtils.js";import o from"../../../../request.js";import{s as c}from"../../../../chunks/vec2.js";import{TEXTURE_BINDING_GLYPH_ATLAS as h,TEXTURE_BINDING_SPRITE_ATLAS as u}from"./definitions.js";import{c as d}from"../../../../chunks/vec2f32.js";import{QueueProcessor as l}from"../../../support/QueueProcessor.js";import{bidiText as m}from"./util/BidiText.js";import g from"../../../../symbols/cim/Rasterizer.js";import{MosaicType as p}from"./enums.js";import{getFullyQualifiedFontName as f}from"./fontUtils.js";import _ from"./GlyphMosaic.js";import y from"./GlyphSource.js";import w from"./SDFConverter.js";import M from"./SpriteMosaic.js";import S,{isPNG as I,isAnimatedPNG as v}from"./animatedFormats/apng.js";import T,{isGIF as b,isAnimatedGIF as x}from"./animatedFormats/gif.js";import{ok as z}from"./util/Result.js";import{keyFromSymbol as R}from"./util/symbolUtils.js";const j=d(),C="arial-unicode-ms-regular",F=126,U=i.getLogger("esri.views.2d.engine.webgl.TextureManager"),P=e=>"esriSMS"===e.type&&e.path,B=e=>e.url||e.imageData,G=e=>e.url&&-1!==e.url.indexOf(".gif")||e.contentType&&"image/gif"===e.contentType||e.imageData&&-1!==e.imageData.indexOf("data:image/gif"),L=e=>e.url&&-1!==e.url.indexOf(".png")||e.contentType&&"image/png"===e.contentType||e.imageData&&-1!==e.imageData.indexOf("data:image/png"),O=e=>e.type&&-1!==e.type.toLowerCase().indexOf("3d");function $(e){switch(e.type){case"CIMSolidStroke":case"CIMSolidFill":return!0;case"esriSFS":return"esriSFSSolid"===e.style||"esriSFSNull"===e.style;case"esriSLS":return"esriSLSSolid"===e.style||"esriSLSNull"===e.style;default:return!1}}const k=e=>-1!==e.indexOf("data:image/svg+xml");function q(e){switch(e.type){case"esriSMS":case"esriPMS":case"CIMPointSymbol":case"CIMVectorMarker":case"CIMPictureMarker":case"CIMCharacterMarker":return!1;default:return!0}}function D(e){const t=[];for(let i=0;i<e.length;i++)t.push(e.charCodeAt(i));return t}async function A(e,t){const i=e.imageData?`data:${e.contentType};base64,${e.imageData}`:e.url;let r;const n=";base64,";if(-1!==i.indexOf(n)){const e=i.indexOf(n)+n.length,t=i.substring(e),s=atob(t),a=new Uint8Array(s.length);for(let i=0;i<s.length;i++)a[i]=s.charCodeAt(i);r=a.buffer}else try{const{data:e}=await o(i,{responseType:"array-buffer",...t});r=e}catch(c){if(!a(c))return new s("mapview-invalid-resource",`Could not fetch requested resource at ${i}`)}return r}function N(e,t){const i=Math.round(n(t)*window.devicePixelRatio),s=i>=128?2:4;return Math.min(e,i*s)}const Q=(e,t,i)=>U.error(new s(e,t,i));class E{constructor(e,t,i){this.mosaicType=e,this.page=t,this.sdf=i}static fromMosaic(e,t){return new E(e,t.page,t.sdf)}}class H{constructor(t){this._invalidFontsMap=new Map,this._sdfConverter=new w(F),this._bindingInfos=new Array,this._hashToBindingIndex=new Map,this._rasterizer=new g,this._ongoingRasterizations=new Map,this._imageRequestQueue=new l({concurrency:10,process:async(e,t)=>{r(t);try{return await o(e,{responseType:"image",signal:t})}catch(i){if(!a(i))throw new s("mapview-invalid-resource",`Could not fetch requested resource at ${e}`,i);throw i}}}),this._spriteMosaic=new M(t,2048,2048,500),this._glyphSource=new y(`${e.fontsUrl}/{fontstack}/{range}.pbf`),this._glyphMosaic=new _(1024,1024,this._glyphSource)}dispose(){this._spriteMosaic.dispose(),this._glyphMosaic.dispose(),this._rasterizer.dispose(),this._sdfConverter.dispose(),this._spriteMosaic=null,this._glyphMosaic=null,this._rasterizer=null,this._sdfConverter=null,this._hashToBindingIndex.clear(),this._hashToBindingIndex=null,this._bindingInfos=null,this._ongoingRasterizations.clear(),this._ongoingRasterizations=null,this._imageRequestQueue.clear(),this._imageRequestQueue=null}get sprites(){return this._spriteMosaic}get glyphs(){return this._glyphMosaic}async rasterizeItem(e,i,s,r){if(t(e))return Q("mapview-null-resource","Unable to rasterize null resource"),null;switch(e.type){case"CIMTextSymbol":case"esriTS":{const t=await this._rasterizeText(e,s,r);return t.forEach((e=>this._setTextureBinding(p.GLYPH,e))),{glyphMosaicItems:t}}case"esriSMS":case"esriPMS":case"esriSFS":case"esriPFS":case"esriSLS":default:{if(O(e))return Q("mapview-invalid-type",`MapView does not support symbol type: ${e.type}`,e),null;const t=await this._rasterizeSpriteSymbol(e,i,r);return z(t)&&t&&this._setTextureBinding(p.SPRITE,t),{spriteMosaicItem:t}}}}bindTextures(e,t,i,s=!1){if(0===i.textureBinding)return;const r=this._bindingInfos[i.textureBinding-1],a=r.page,n=s?9987:9729;switch(r.mosaicType){case p.SPRITE:{const i=this.sprites.getWidth(a),s=this.sprites.getHeight(a),r=c(j,i,s);return this._spriteMosaic.bind(e,n,a,u),t.setUniform1i("u_texture",u),void t.setUniform2fv("u_mosaicSize",r)}case p.GLYPH:{const i=this.glyphs.width,s=this.glyphs.height,r=c(j,i,s);return this._glyphMosaic.bind(e,n,a,h),t.setUniform1i("u_texture",h),void t.setUniform2fv("u_mosaicSize",r)}default:U.error("mapview-texture-manager",`Cannot handle unknown type ${r.mosaicType}`)}}_hashMosaic(e,t){return 1|e<<1|(t.sdf?1:0)<<2|t.page<<3}_setTextureBinding(e,t){const i=this._hashMosaic(e,t);if(!this._hashToBindingIndex.has(i)){const s=E.fromMosaic(e,t),r=this._bindingInfos.length+1;this._hashToBindingIndex.set(i,r),this._bindingInfos.push(s)}t.textureBinding=this._hashToBindingIndex.get(i)}async _rasterizeText(e,t,i){const s=f(e.font),r=this._invalidFontsMap.has(s),a=t||D(m(e.text)[0]);try{return await this._glyphMosaic.getGlyphItems(r?C:s,a,i)}catch(n){return Q("mapview-invalid-resource",`Couldn't find font ${s}. Falling back to Arial Unicode MS Regular`),this._invalidFontsMap.set(s,!0),this._glyphMosaic.getGlyphItems(C,a,i)}}async _rasterizeSpriteSymbol(e,t,i){if($(e))return null;const r=R(e);if(this._spriteMosaic.has(r))return this._spriteMosaic.getSpriteItem(r);if(P(e)||B(e))return this._handleAsyncResource(r,e,i);const a=this._rasterizer.rasterizeJSONResource(e,t);if(a){const{size:t,image:i,sdf:s,simplePattern:n}=a;return this._addItemToMosaic(r,t,{type:"static",data:i},q(e),s,n)}return new s("TextureManager","unrecognized or null rasterized image")}async _handleAsyncResource(e,t,i){if(this._ongoingRasterizations.has(e))return this._ongoingRasterizations.get(e);let s;s=P(t)?this._handleSVG(t,e,i):this._handleImage(t,e,i),this._ongoingRasterizations.set(e,s);try{await s,this._ongoingRasterizations.delete(e)}catch{this._ongoingRasterizations.delete(e)}return s}async _handleSVG(e,t,i){const s=[F,F],r=await this._sdfConverter.draw(e.path,i);return this._addItemToMosaic(t,s,{type:"static",data:new Uint32Array(r.buffer)},!1,!0,!0)}async _handleGIFOrPNG(e,t,i){const r=await A(e,i);if(z(r)){const o=b(r),c=I(r);if(!o&&!c)return new s("mapview-invalid-resource","Image data is neither GIF nor PNG!");let h;try{o&&x(r)?h=await T.create(r,i):c&&v(r)&&(h=await S.create(r,i))}catch(n){if(!a(n))return new s("mapview-invalid-resource","Could not fetch requested resource!")}if(h&&z(h))return this._addItemToMosaic(t,[h.width,h.height],{type:"animated",data:h},q(e),!1,!1);const u=new Blob([r],{type:o?"image/gif":"image/png"}),d=await this._imageFromBlob(u);if(d&&d instanceof HTMLImageElement){let i=d.width,s=d.height;"esriPMS"===e.type&&(i=Math.round(N(d.width,e.width)),s=Math.round(d.height*(i/d.width)));const{size:r,sdf:a,image:n}=this._rasterizer.rasterizeImageResource(i,s,d,e.colorSubstitutions);return this._addItemToMosaic(t,r,{type:"static",data:n},q(e),a,!1)}}return new s("mapview-invalid-resource","Could not handle resource!")}async _handleImage(e,t,i){if(G(e)||L(e))return this._handleGIFOrPNG(e,t,i);const r=e.imageData?`data:${e.contentType};base64,${e.imageData}`:e.url;try{const{data:s}=await this._imageRequestQueue.push(r,{...i});k(r)&&(s.width=n(e.width),s.height=n(e.height));let a=s.width,o=s.height;"esriPMS"===e.type&&(a=Math.round(N(s.width,e.width)),o=Math.round(s.height*(a/s.width)));const{size:c,sdf:h,image:u}=this._rasterizer.rasterizeImageResource(a,o,s,e.colorSubstitutions);return this._addItemToMosaic(t,c,{type:"static",data:u},q(e),h,!1)}catch(o){if(!a(o))return new s("mapview-invalid-resource",`Could not fetch requested resource at ${r}. ${o.message}`)}}async _imageFromBlob(e){const t=window.URL.createObjectURL(e);try{const{data:e}=await this._imageRequestQueue.push(t);return window.URL.revokeObjectURL(t),e}catch(i){if(window.URL.revokeObjectURL(t),!a(i))return new s("mapview-invalid-resource",`Could not fetch requested resource at ${t}`);throw i}}_addItemToMosaic(e,t,i,s,r,a){return this._spriteMosaic.addSpriteItem(e,t,i,s,r,a)}}export default H;
