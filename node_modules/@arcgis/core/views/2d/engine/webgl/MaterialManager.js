/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import"../../../../core/has.js";import{isSome as r}from"../../../../core/maybe.js";import"../../../../core/mathUtils.js";import"../../../../chunks/builtins.js";import"../../../webgl/checkWebGLError.js";import"../../../webgl/FramebufferObject.js";import e from"../../../webgl/ProgramCache.js";import{WGLDrawPhase as t}from"./enums.js";import{createProgramTemplate as o}from"./shaders/MaterialPrograms.js";const a=r=>r===t.HITTEST||r===t.LABEL_ALPHA,s=r=>(a(r)?1:0)|(r===t.HIGHLIGHT?2:0),i=({rendererInfo:e,drawPhase:t},o,a,i)=>`${o.getVariationHash()}-${i.join(".")}-${s(t)}-${e.getVariationHash()}-${r(a)&&a.join(".")}`,m=(e,o,s,i)=>{const m=i.reduce(((r,t)=>({...r,[t]:e.driverTestResult[t]})),{}),g={...o.getVariation(),...e.rendererInfo.getVariation(),highlight:e.drawPhase===t.HIGHLIGHT,id:a(e.drawPhase),...m};if(r(s))for(const r of s)g[r]=!0;return g};class g{constructor(r){this._programByKey=new Map,this._programCache=new e(r)}dispose(){this._programCache&&this._programCache.dispose()}getProgram(r,e,t=[],a=[]){const s=e.vsPath+"."+e.fsPath+JSON.stringify(t)+a.join(".");if(this._programByKey.has(s))return this._programByKey.get(s);const i=a.reduce(((e,t)=>({...e,[t]:r.driverTestResult[t]})),{}),m={...t.map((r=>"string"==typeof r?{name:r,value:!0}:r)).reduce(((r,e)=>({...r,[e.name]:e.value})),{}),...i},{vsPath:g,fsPath:h,attributes:n}=e,p=this._programCache.getProgram(o(g,h,n),m);if(!p)throw new Error("Unable to get program for key: ${key}");return this._programByKey.set(s,p),p}getMaterialProgram(r,e,t,a,s,g=["ignoresSamplerPrecision"]){const h=i(r,e,s,g);if(this._programByKey.has(h))return this._programByKey.get(h);const n=m(r,e,s,g),p=this._programCache.getProgram(o(t,t,a),n);if(!p)throw new Error("Unable to get program for key: ${key}");return this._programByKey.set(h,p),p}}export default g;
