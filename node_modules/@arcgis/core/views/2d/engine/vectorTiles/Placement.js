/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{C_DEG_TO_RAD as e,C_PI as t,C_INFINITY as i,radToByte as n,positiveMod as s,C_2PI as a}from"./GeometryUtils.js";import{DECLUTTER_TILES as o}from"./decluttering/config.js";import{Point as l}from"../webgl/Geometry.js";import{SDF_GLYPH_SIZE as h,TextShaping as r,SDF_GLYPH_BASELINE as c}from"./TextShaping.js";const g=4096,m=512,x=8,d=.5,w=2;class p{constructor(e,t,i=0,n=-1,s=d){this.x=e,this.y=t,this.angle=i,this.segment=n,this.minzoom=s}}class y{constructor(e,t,n,s,a,o=d,l=i){this.anchor=e,this.labelAngle=t,this.glyphAngle=n,this.page=s,this.alternateVerticalGlyph=a,this.minzoom=o,this.maxzoom=l}}class f{constructor(e,t,i,n,s,a,o,l,h,r,c,g){this.tl=e,this.tr=t,this.bl=i,this.br=n,this.mosaicRect=s,this.labelAngle=a,this.minAngle=o,this.maxAngle=l,this.anchor=h,this.minzoom=r,this.maxzoom=c,this.page=g}}class b{constructor(e){this.shapes=e}}class u{getIconPlacement(i,n,s){const a=new l(i.x,i.y),h=0===s.rotationAlignment,r=s.keepUpright;let c=s.rotate*e;h&&(c+=i.angle);const g=new b([]);return s.allowOverlap&&s.ignorePlacement||!o||(g.iconColliders=[]),this._addIconPlacement(g,a,n,s,c),h&&r&&this._addIconPlacement(g,a,n,s,c+t),g}_addIconPlacement(e,t,n,s,a){const h=n.pixelRatio,r=n.width/h,c=n.height/h,g=s.offset;let m=g[0],x=g[1];switch(s.anchor){case 0:m-=r/2,x-=c/2;break;case 1:x-=c/2;break;case 2:m-=r,x-=c/2;break;case 3:m-=r/2;break;case 4:m-=r/2,x-=c;break;case 5:break;case 7:x-=c;break;case 6:m-=r;break;case 8:m-=r,x-=c}const w=n.rect,p=2/h,y=m-p,b=x-p,u=y+w.width/h,I=b+w.height/h,k=new l(y,b),T=new l(u,I),P=new l(y,I),N=new l(u,b);if(0!==a){const e=Math.cos(a),t=Math.sin(a);k.rotate(e,t),T.rotate(e,t),P.rotate(e,t),N.rotate(e,t)}const z=new f(k,N,P,T,w,a,0,256,t,d,i,0);if(e.shapes.push(z),(!s.allowOverlap||!s.ignorePlacement)&&o){const n=s.size,o=s.padding,l={xTile:t.x,yTile:t.y,dxPixels:m*n-o,dyPixels:x*n-o,hard:!s.optional,partIndex:0,width:r*n+2*o,height:c*n+2*o,angle:a,minLod:d,maxLod:i};e.iconColliders.push(l)}}getTextPlacement(n,s,a,o){const g=new l(n.x,n.y),m=o.rotate*e,p=0===o.rotationAlignment,u=o.keepUpright,I=o.padding;let k=d;const T=!p?0:n.angle,P=n.segment>=0&&p,N=o.allowOverlap&&o.ignorePlacement?null:[],z=[],A=4,_=!P;let G=Number.POSITIVE_INFINITY,v=Number.NEGATIVE_INFINITY,M=G,E=v;const L=(P||p)&&u,V=o.size/h;let O=!1;for(const e of s)if(e.vertical){O=!0;break}let j,F=0,Y=0;if(!P&&O){const e=r.getTextBox(s,o.lineHeight*h);switch(o.anchor){case 1:F=e.height/2,Y=-e.width/2;break;case 2:F=-e.height/2,Y=e.width/2;break;case 3:F=e.height/2,Y=e.width/2;break;case 4:F=-e.height/2,Y=-e.width/2;break;case 5:F=e.height;break;case 7:Y=-e.width;break;case 6:Y=e.width;break;case 8:F=-e.height}}F+=o.offset[0]*h,Y+=o.offset[1]*h;for(const e of s){const s=e.glyphMosaicItem;if(!s||s.rect.isEmpty)continue;const h=s.rect,r=s.metrics,b=s.page;if(N&&_){if(void 0!==j&&j!==e.y){let e,t,s,a;O?(e=-E+F,t=G+Y,s=E-M,a=v-G):(e=G+F,t=M+Y,s=v-G,a=E-M);const l={xTile:n.x,yTile:n.y,dxPixels:e*V-I,dyPixels:t*V-I,hard:!o.optional,partIndex:1,width:s*V+2*I,height:a*V+2*I,angle:m,minLod:d,maxLod:i};N.push(l),G=Number.POSITIVE_INFINITY,v=Number.NEGATIVE_INFINITY,M=G,E=v}j=e.y}const q=[];if(P){const t=.5*s.metrics.width,i=(e.x+r.left-A+t)*V*x;if(k=this._placeGlyph(n,k,i,a,n.segment,1,e.vertical,b,q),u&&(k=this._placeGlyph(n,k,i,a,n.segment,-1,e.vertical,b,q)),k>=w)break}else q.push(new y(g,T,T,b,!1)),p&&u&&q.push(new y(g,T+t,T+t,b,!1));const C=e.x+r.left,S=e.y-c-r.top,U=C+r.width,R=S+r.height;let B,H,D,J,K,Q,W,X;if(!P&&O)if(e.vertical){const e=(C+U)/2-r.height/2,t=(S+R)/2+r.width/2;B=new l(-t-A+F,e-A+Y),H=new l(B.x+h.width,B.y+h.height),D=new l(B.x,H.y),J=new l(H.x,B.y)}else B=new l(-S+A+F,C-A+Y),H=new l(B.x-h.height,B.y+h.width),D=new l(H.x,B.y),J=new l(B.x,H.y);else B=new l(C-A+F,S-A+Y),H=new l(B.x+h.width,B.y+h.height),D=new l(B.x,H.y),J=new l(H.x,B.y);for(const t of q){let i,s,a,c;if(t.alternateVerticalGlyph){if(!K){const e=(S+R)/2+Y;K=new l((C+U)/2+F-r.height/2-A,e+r.width/2+A),Q=new l(K.x+h.height,K.y-h.width),W=new l(Q.x,K.y),X=new l(K.x,Q.y)}i=K,s=W,a=X,c=Q}else i=B,s=D,a=J,c=H;const g=S,x=R,d=t.glyphAngle+m;if(0!==d){const e=Math.cos(d),t=Math.sin(d);i=i.clone(),s=s.clone(),a=a.clone(),c=c.clone(),i.rotate(e,t),c.rotate(e,t),s.rotate(e,t),a.rotate(e,t)}let p=0,y=256;if(P&&O?e.vertical?t.alternateVerticalGlyph?(p=32,y=96):(p=224,y=32):(p=224,y=96):(p=192,y=64),z.push(new f(i,a,s,c,h,t.labelAngle,p,y,t.anchor,t.minzoom,t.maxzoom,t.page)),N&&(!L||this._legible(t.labelAngle)))if(_)C<G&&(G=C),g<M&&(M=g),U>v&&(v=U),x>E&&(E=x);else if(t.minzoom<w){const e={xTile:n.x,yTile:n.y,dxPixels:(C+F)*V-I,dyPixels:(g+F)*V-I,hard:!o.optional,partIndex:1,width:(U-C)*V+2*I,height:(x-g)*V+2*I,angle:d,minLod:t.minzoom,maxLod:t.maxzoom};N.push(e)}}}if(k>=w)return null;if(N&&_){let e,t,s,a;O?(e=-E+F,t=G+Y,s=E-M,a=v-G):(e=G+F,t=M+Y,s=v-G,a=E-M);const l={xTile:n.x,yTile:n.y,dxPixels:e*V-I,dyPixels:t*V-I,hard:!o.optional,partIndex:1,width:s*V+2*I,height:a*V+2*I,angle:m,minLod:d,maxLod:i};N.push(l)}const q=new b(z);return N&&N.length>0&&(q.textColliders=N),q}_legible(e){const t=n(e);return t<65||t>=193}_placeGlyph(e,n,o,h,r,c,g,m,x){let d=c;const w=d<0?s(e.angle+t,a):e.angle;let p=0;o<0&&(d*=-1,o*=-1,p=t),d>0&&++r;let f=new l(e.x,e.y),b=h[r],u=i;if(h.length<=r)return u;for(;;){const e=b.x-f.x,t=b.y-f.y,i=Math.sqrt(e*e+t*t),l=Math.max(o/i,n),c=e/i,I=t/i,k=s(Math.atan2(I,c)+p,a);if(x.push(new y(f,w,k,m,!1,l,u)),g&&x.push(new y(f,w,k,m,!0,l,u)),l<=n)return l;f=b.clone();do{if(r+=d,h.length<=r||r<0)return l;b=h[r]}while(f.isEqual(b));let T=b.x-f.x,P=b.y-f.y;const N=Math.sqrt(T*T+P*P);T*=i/N,P*=i/N,f.x-=T,f.y-=P,u=l}}}export{p as Anchor,f as PlacedSymbol,b as Placement,u as PlacementEngine,g as TILE_COORD_SIZE,x as TILE_PIXEL_RATIO,m as TILE_PIXEL_SIZE};
