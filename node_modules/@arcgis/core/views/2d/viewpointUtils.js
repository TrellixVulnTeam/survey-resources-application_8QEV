/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{isSome as t,get as e,isNone as n}from"../../core/maybe.js";import{isValid as r,getInfo as o}from"../../geometry/support/spatialReferenceUtils.js";import a from"../../geometry/SpatialReference.js";import i from"../../geometry/Geometry.js";import{earth as s}from"../../geometry/support/Ellipsoid.js";import{canProject as c,project as u}from"../../geometry/support/webMercatorUtils.js";import f from"../../geometry/Point.js";import l from"../../geometry/Extent.js";import m from"../../core/Collection.js";import{t as y,a as p}from"../../chunks/common.js";import g from"../../Viewpoint.js";import{getMetersPerUnitForSR as h}from"../../core/unitUtils.js";import{a as x,f as b}from"../../chunks/vec2f64.js";import{s as d,c as w,a as j,b as G,n as M,d as A,e as R,f as k,g as S,l as v,t as q,h as P}from"../../chunks/vec2.js";import{f as F,r as I,t as N,i as z,s as V,a as E,b as L}from"../../chunks/mat2d.js";import{c as O}from"../../chunks/mat2df64.js";const W=39.37,C=180/Math.PI;function U(t,e,n){const r=p(e[0]/s.radius);return d(t,n?r:r-360*Math.floor((r+180)/360),p(.5*Math.PI-2*Math.atan(Math.exp(-1*e[1]/s.radius))))}function Q(t,e){let n=e[1];return n>89.99999?n=89.99999:n<-89.99999&&(n=-89.99999),n=Math.sin(y(n)),d(t,y(e[0])*s.radius,.5*s.radius*Math.log((1+n)/(1-n)))}function B(t,e,n,r){return r&&n&&!r.equals(n)&&c(r,n)&&r.isWebMercator?r.isWebMercator?Q(t,e):U(t,e):w(t,e)}function D(t){return t.wkid?t:t.spatialReference||a.WGS84}function T(t,e){return e.type?d(t,e.x,e.y):w(t,e)}function H(t){return h(t)}function J(t,e){return Math.max(t.width/e[0],t.height/e[1])*ct(t.spatialReference)}async function K(r,o,a,s){let y,p;if(!r)return null;if(Array.isArray(r)&&!r.length)return null;if(m.isCollection(r)&&(r=r.toArray()),Array.isArray(r)&&r.length&&"object"==typeof r[0]){const e=r.every((t=>"attributes"in t)),n=r.some((t=>!t.geometry));let i=r;if(e&&n&&o&&o.allLayerViews){const e=new Map;for(const t of r){const n=t.layer,r=e.get(n)||[],o=t.attributes[n.objectIdField];null!=o&&r.push(o),e.set(n,r)}const n=[];e.forEach(((t,e)=>{const r=o.allLayerViews.find((t=>t.layer.id===e.id));if("queryFeatures"in r){const o=e.createQuery();o.objectIds=t,o.returnGeometry=!0,n.push(r.queryFeatures(o))}}));const a=await Promise.all(n),s=[];for(const r of a)if(r&&r.features&&r.features.length)for(const e of r.features)t(e.geometry)&&s.push(e.geometry);i=s}for(const t of i)s=await K(t,o,a,s);return s}if(Array.isArray(r)&&2===r.length&&"number"==typeof r[0]&&"number"==typeof r[1])y=new f(r);else if(r instanceof i)y=r;else if("geometry"in r)if(r.geometry)y=r.geometry;else if(r.layer){const t=r.layer,n=o.allLayerViews.find((e=>e.layer.id===t.id));if("queryFeatures"in n){const o=t.createQuery();o.objectIds=[r.attributes[t.objectIdField]],o.returnGeometry=!0;const a=await n.queryFeatures(o);y=e(a,"features",0,"geometry")}}if(n(y))return null;if(p="point"===y.type?new l({xmin:y.x,ymin:y.y,xmax:y.x,ymax:y.y,spatialReference:y.spatialReference}):y.extent,!p)return null;const g=c(p,a);if(!p.spatialReference.equals(a)&&g)p=u(p,a);else if(!g)return null;return s=s?s.union(p):p.clone()}function X(t){if(t&&(!Array.isArray(t)||"number"!=typeof t[0])&&("object"==typeof t||Array.isArray(t)&&"object"==typeof t[0])){if("layer"in t&&t.layer&&t.layer.minScale&&t.layer.maxScale){const e=t.layer;return{min:e.minScale,max:e.maxScale}}if(Array.isArray(t)&&t.length&&t.every((t=>"layer"in t))){let e=0,n=0;for(const r of t){const t=r.layer;t&&t.minScale&&t.maxScale&&(e=t.minScale<e?t.minScale:e,n=t.maxScale>n?t.maxScale:n)}return e&&n?{min:e,max:n}:null}}}async function Y(e,n){if(!e||!n)return new g({targetGeometry:new f,scale:0,rotation:0});let r=n.spatialReference;const{constraints:o,padding:a,viewpoint:i,size:s}=n,m=[a?s[0]-a.left-a.right:s[0],a?s[1]-a.top-a.bottom:s[1]];let y=null;e instanceof g?y=e:e.viewpoint?y=e.viewpoint:e.target&&"esri.Viewpoint"===e.target.declaredClass&&(y=e.target);let p=null;y&&y.targetGeometry?p=y.targetGeometry:e instanceof l?p=e:(e||e&&("center"in e||"extent"in e||"target"in e))&&(p=await K(e.center,n,r)||await K(e.extent,n,r)||await K(e.target,n,r)||await K(e,n,r)),!p&&i&&i.targetGeometry?p=i.targetGeometry:!p&&n.extent&&(p=n.extent);const h=D(p);if(r||(r=D(n.spatialReference||n.extent||p)),!c(p,r)&&h&&!h.equals(r))return null;const b=T(x(),p.center?p.center:p),d=new f(B(b,b,h,r),r);let w=null;w=y&&t(y.targetGeometry)&&"point"===y.targetGeometry.type?y.scale:e.hasOwnProperty("scale")&&e.scale?e.scale:e.hasOwnProperty("zoom")&&-1!==e.zoom&&o&&o.effectiveLODs?o.zoomToScale(e.zoom):Array.isArray(p)||"point"===p.type||"extent"===p.type&&0===p.width&&0===p.height?n.extent&&c(n.extent,r)?J(u(n.extent,r),m):n.extent?J(n.extent,m):i.scale:c(p.extent,r)?J(u(p.extent,r),m):J(p.extent,m);const j=X(e);j&&(j.min&&j.min>w?w=j.min:j.max&&j.max<w&&(w=j.max));let G=0;y?G=y.rotation:e.hasOwnProperty("rotation")?G=e.rotation:i&&(G=i.rotation);let M=new g({targetGeometry:d,scale:w,rotation:G});return o&&(M=o.fit(M),o.constrainByGeometry(M),o.rotationEnabled||(M.rotation=G)),M}function Z(t,e){const n=t.targetGeometry,r=e.targetGeometry;return n.x=r.x,n.y=r.y,n.spatialReference=r.spatialReference,t.scale=e.scale,t.rotation=e.rotation,t}function $(t,e,n){return n?d(t,.5*(e[0]-n.right+n.left),.5*(e[1]-n.bottom+n.top)):j(t,e,.5)}const _=function(){const t=x();return function(e,n,r){const o=n.targetGeometry;T(t,o);const a=.5*at(n);return e.xmin=t[0]-a*r[0],e.ymin=t[1]-a*r[1],e.xmax=t[0]+a*r[0],e.ymax=t[1]+a*r[1],e.spatialReference=o.spatialReference,e}}();function tt(t,e,n,r,o){return wt(t,e,n.center),t.scale=J(n,r),o&&o.constraints&&o.constraints.constrain(t),t}function et(t,e,n,r){return mt(t,e,n,r),E(t,t)}function nt(t,e,n){const r=st(e),o=Math.abs(Math.cos(r)),a=Math.abs(Math.sin(r));return d(t,Math.round(n[1]*a+n[0]*o),Math.round(n[1]*o+n[0]*a))}const rt=function(){const t=x();return function(e,n,r){return G(e,ut(e,n),$(t,n,r))}}(),ot=function(){const t=O(),e=x();return function(n,r,o,a){const i=at(r),s=st(r);return d(e,i,i),F(t,e),I(t,t,s),N(t,t,rt(e,o,a)),N(t,t,[0,a.top-a.bottom]),d(n,t[4],t[5])}}();function at(t){return t.scale*it(t.targetGeometry)}function it(e){return t(e)&&r(e.spatialReference)?1/(H(e.spatialReference)*W*ft()):1}function st(t){return y(t.rotation)||0}function ct(t){return r(t)?H(t)*W*ft():1}function ut(t,e){return j(t,e,.5)}function ft(){return 96}const lt=function(){const t=x(),e=x(),n=x();return function(r,o,a,i,s,c){return M(t,o),j(e,a,.5*c),d(n,1/i*c,-1/i*c),z(r),N(r,r,e),s&&I(r,r,s),V(r,r,n),N(r,r,t),r}}(),mt=function(){const t=x();return function(e,n,r,o){const a=at(n),i=st(n);return T(t,n.targetGeometry),lt(e,t,r,a,i,o)}}(),yt=function(){const t=x();return function(e,n,r,o){const a=at(n);return T(t,n.targetGeometry),lt(e,t,r,a,0,o)}}();function pt(t){if(t.isWrappable){const e=o(t);return e.valid[1]-e.valid[0]}return 0}function gt(t,e){return Math.round(pt(t)/e)}function ht(t,e){return Y(t,e)}const xt=function(){const t=x(),e=x(),n=[0,0,0];return function(r,o,a){A(t,r,o),R(t,t),A(e,r,a),R(e,e),k(n,t,e);let i=Math.acos(S(t,e)/(v(t)*v(e)))*C;return n[2]<0&&(i=-i),isNaN(i)&&(i=0),i}}(),bt=function(){const t=x();return function(e,n,r,o){const a=e.targetGeometry;return Z(e,n),ot(t,n,r,o),a.x+=t[0],a.y+=t[1],e}}(),dt=function(){const t=x();return function(e,n,r,o){const a=e.targetGeometry;return Z(e,n),ot(t,n,r,o),a.x-=t[0],a.y-=t[1],e}}(),wt=function(){const t=x();return function(e,n,r){Z(e,n);const o=e.targetGeometry,a=D(r),i=D(o);return T(t,r),B(t,t,a,i),o.x=t[0],o.y=t[1],e}}();function jt(t){return at(t)}const Gt=function(){const t=x();return function(e,n,r,o,a){a||(a="center"),G(t,r,o),j(t,t,.5);const i=t[0],s=t[1];switch(a){case"center":d(t,0,0);break;case"left":d(t,-i,0);break;case"top":d(t,0,s);break;case"right":d(t,i,0);break;case"bottom":d(t,0,-s);break;case"top-left":d(t,-i,s);break;case"bottom-left":d(t,-i,-s);break;case"top-right":d(t,i,s);break;case"bottom-right":d(t,i,-s)}return Ft(e,n,t),e}}();function Mt(t,e,n){return Z(t,e),t.rotation+=n,t}function At(t,e,n){return Z(t,e),t.rotation=n,t}const Rt=function(){const t=x();return function(e,n,r,o,a){return Z(e,n),isNaN(r)||0===r||(qt(t,o,n,a),e.scale=n.scale*r,Pt(t,t,e,a),Ft(e,e,d(t,t[0]-o[0],o[1]-t[1]))),e}}();function kt(t,e,n){return Z(t,e),t.scale=n,t}const St=function(){const t=x();return function(e,n,r,o,a,i){return Z(e,n),isNaN(r)||0===r||(qt(t,a,n,i),e.scale=n.scale*r,e.rotation+=o,Pt(t,t,e,i),Ft(e,e,d(t,t[0]-a[0],a[1]-t[1]))),e}}(),vt=function(){const t=x(),e=x();return function(n,r,o,a,i,s,c){return rt(e,s,c),P(t,i,e),a?St(n,r,o,a,t,s):Rt(n,r,o,t,s)}}(),qt=function(){const t=O();return function(e,n,r,o){return q(e,n,et(t,r,o,1))}}(),Pt=function(){const t=O();return function(e,n,r,o){return q(e,n,mt(t,r,o,1))}}(),Ft=function(){const t=x(),e=O();return function(n,r,o){Z(n,r);const a=at(r),i=n.targetGeometry;return L(e,st(r)),V(e,e,b(a,a)),q(t,o,e),i.x+=t[0],i.y+=t[1],n}}();export{bt as addPadding,xt as angleBetween,wt as centerAt,Z as copy,Y as create,ht as createAsync,J as extentToScale,$ as getAnchor,_ as getExtent,lt as getMatrix,nt as getOuterSize,ot as getPaddingMapTranslation,rt as getPaddingScreenTranslation,at as getResolution,ct as getResolutionToScaleFactor,mt as getTransform,yt as getTransformNoRotation,gt as getWorldScreenWidth,pt as getWorldWidth,vt as padAndScaleAndRotateBy,jt as pixelSize,dt as removePadding,Gt as resize,Mt as rotateBy,At as rotateTo,St as scaleAndRotateBy,Rt as scaleBy,kt as scaleTo,tt as setExtent,qt as toMap,Pt as toScreen,Ft as translateBy};
