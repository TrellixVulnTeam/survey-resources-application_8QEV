/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import"../../../../core/has.js";import{isNone as r,isSome as t,destroyMaybe as s}from"../../../../core/maybe.js";import"../../../../core/Logger.js";import"../../../../core/accessorSupport/ensureType.js";import{property as o}from"../../../../core/accessorSupport/decorators/property.js";import{aliasOf as a}from"../../../../core/accessorSupport/decorators/aliasOf.js";import{subclass as u}from"../../../../core/accessorSupport/decorators/subclass.js";import"../../../../core/urlUtils.js";import"../../../../core/uuid.js";import"../../../../portal/support/resourceExtension.js";import{throwIfAborted as i,createAbortError as c}from"../../../../core/promiseUtils.js";import p from"../../../../core/Accessor.js";import{runQuery as l,executeQuery as y}from"../../../../rest/query/operations/query.js";import{fromFeatureSetJSON as n}from"../../../../layers/graphics/dehydratedFeatures.js";import{PBFDecoder as d}from"../../support/PBFDecoder.js";let m=class extends p{get queryFeaturesDehydrated(){const e=this.layer.capabilities,s=e&&e.query;if(s&&s.supportsFormatPBF){var o,a;r(this._decoder)&&(this._decoder=new d(this.scheduler));const e={sourceSpatialReference:null!=(o=null==(a=this.layer.spatialReference)?void 0:a.toJSON())?o:null,applyTransform:!0,maxStringAttributeLength:1024};return(r,s)=>l(this.layer.parsedUrl,r,"pbf",s).then((r=>(i(s),t(this._decoder)?this._decoder.invoke({buffer:r.data,options:e},s.signal):Promise.reject(c()))))}return(e,r)=>y(this.layer.parsedUrl,e,this.layer.spatialReference,r).then((e=>n(e.data)))}queryFeatureCount(e,r){return this.layer.queryFeatureCount(e,r)}destroy(){this._decoder=s(this._decoder)}};e([o({constructOnly:!0})],m.prototype,"layer",void 0),e([o({constructOnly:!0})],m.prototype,"scheduler",void 0),e([o({readOnly:!0})],m.prototype,"queryFeaturesDehydrated",null),m=e([u("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceQuery3D")],m);let h=class extends p{queryFeaturesDehydrated(e,r){return this.layer.queryFeatures(e,r)}};e([o({constructOnly:!0})],h.prototype,"layer",void 0),h=e([u("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceQuery3D")],h);let f=class extends p{destroy(){}queryFeaturesDehydrated(e,r){return this.source.queryFeaturesJSON(e,r).then(n,(t=>{if(t&&"query-features-json:unsupported"===t.name)return this.layer.queryFeatures(e,r);throw t}))}queryFeatureCount(e,r){return this.layer.queryFeatureCount(e,r)}};function j(e,r){switch(e.source.type){case"feature-layer":return new m({layer:e,scheduler:r});case"memory":case"csv":case"geojson":return new f({layer:e});case"ogc-feature":return new h({layer:e});case"stream-layer":throw new Error("Tile based queries unsupported for stream sources")}}e([o({constructOnly:!0})],f.prototype,"layer",void 0),e([a("layer.source")],f.prototype,"source",void 0),f=e([u("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileClientQuery3D")],f);export{j as createFeatureTileQuery3D};
