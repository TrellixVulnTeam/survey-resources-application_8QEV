/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import"../../../core/has.js";import{isNone as i}from"../../../core/maybe.js";import"../../../core/Logger.js";import"../../../core/accessorSupport/ensureType.js";import{property as r}from"../../../core/accessorSupport/decorators/property.js";import{subclass as s}from"../../../core/accessorSupport/decorators/subclass.js";import"../../../core/urlUtils.js";import"../../../core/uuid.js";import"../../../portal/support/resourceExtension.js";import t from"../../../core/Accessor.js";import o from"../../../symbols/PointSymbol3D.js";import"../../../symbols.js";import a from"../../../Graphic.js";import{c as l}from"../../../chunks/vec3f64.js";import p from"../../../core/Handles.js";import{diff as c}from"../../../core/accessorSupport/diffUtils.js";import{makeDehydratedPoint as h}from"../../../layers/graphics/dehydratedFeatures.js";import{Graphics3DCore as n}from"./graphics/Graphics3DCore.js";import d from"./graphics/Graphics3DScaleVisibility.js";import{boundingBoxTop as y}from"./i3s/I3SGeometryUtil.js";import{LimitGraphicsMap as u}from"../support/LimitGraphicsMap.js";let g=class extends t{constructor(e){super(e),this.loadedGraphics=new u(5e4),this.slicePlaneEnabled=!1,this._renderingInfo={symbol:new o},this._handles=new p,this._graphicsByNode=new Map,this._scaleVisibility=null}initialize(){this._graphicsCore=new n({owner:this,layer:this.layer,preferredUpdatePolicy:1,elevationFeatureExpressionEnabled:!1,graphicSymbolSupported:!1,getRenderingInfoWithoutRenderer:!0,hasZ:!0,hasM:!1});const e=this.view.basemapTerrain;this._scaleVisibility=new d({layerScaleEnabled:!1}),this._scaleVisibility.setup(this,this.layer,((e,i,r)=>this._graphicsCore.spatialIndex.queryGraphicUIDsInExtent(e,i,r)),this._graphicsCore,e);const i=this.view.labeler.addGraphicsOwner(this._graphicsCore,this._scaleVisibility,{emptySymbolLabelSupported:!0,elevationInfoOverride:{mode:"absolute-height",offset:0},disablePlacement:{logEntityDescription:"3D Object Scene Layer features"}}),r=this.view.deconflictor.addGraphicsOwner(this._graphicsCore);this._graphicsCore.setup({labeler:i,deconflictor:r,scaleVisibility:this._scaleVisibility}).then((()=>{this._graphicsCore.startCreateGraphics()})).catch((()=>{})),this._handles.add([this.layer.watch("labelingInfo",((e,i)=>{c(e,i)&&this._graphicsCore.updateLabelingInfo()}))])}destroy(){this._handles&&(this._handles.destroy(),this._handles=null),null!=this._scaleVisibility&&(this._scaleVisibility.destroy(),this._scaleVisibility=null),null!=this._graphicsCore&&(this._graphicsCore.destroy(),this._graphicsCore=null),this.loadedGraphics.destroy(),this.view=null}addNodeMeta(e,r){let s=0;const t=e.filteredIds,o=e.featureIds.map(((o,l)=>{y(l,this.collection,e.objectHandle,b);const p=h(0,0,0,this.view.spatialReference);this.view.renderCoordsHelper.fromRenderCoords(b,p);const c=r(l,e);let n=!1;return i(t)?n=!0:s<t.length&&o===t[s]&&(n=!0,s++),{objectId:o,uid:a.generateUID(),attributes:c,visible:n,geometry:p}}));this.loadedGraphics.addMany(o),this._graphicsByNode.set(e.node.index,o)}setNodeMetaAttributes(e,i){const r=this._graphicsByNode.get(e.node.index),s=new Array(r.length);for(let t=0;t<r.length;t++){const o=r[t];o.attributes=i(t,e),s[t]=o.uid}this._graphicsCore.updateLabelingInfo(s)}applyFilterChange(e){const r=this._graphicsByNode.get(e.node.index);if(r)if(i(e.filteredIds))for(const i of r)i.visible||(i.visible=!0,m.graphic=i,m.property="visible",m.oldValue=!1,m.newValue=!0,this._graphicsCore.graphicUpdateHandler(m));else{let i=0;for(const s of r){const r=s.visible;i<e.filteredIds.length&&s.objectId===e.filteredIds[i]?(s.visible=!0,i++):s.visible=!1,r!==s.visible&&(m.graphic=s,m.property="visible",m.oldValue=r,m.newValue=s.visible,this._graphicsCore.graphicUpdateHandler(m))}}}removeNodeMeta(e){this.loadedGraphics.removeManyByObjectId(e.featureIds)}getRenderingInfo(){return this._renderingInfo}notifyGraphicGeometryChanged(){}notifyGraphicVisibilityChanged(){}get usedMemory(){return this._graphicsCore.usedMemory}get unloadedMemoryEstimate(){return this._graphicsCore.unprocessedMemoryEstimate}get test(){return{graphicsCore:this._graphicsCore}}};e([r()],g.prototype,"view",void 0),e([r()],g.prototype,"layer",void 0),e([r()],g.prototype,"collection",void 0),e([r()],g.prototype,"loadedGraphics",void 0),e([r({aliasOf:"_graphicsCore.updating"})],g.prototype,"updating",void 0),e([r()],g.prototype,"slicePlaneEnabled",void 0),e([r()],g.prototype,"_graphicsCore",void 0),g=e([s("esri.views.3d.layers.I3SMeshViewLabeler")],g);const m={graphic:null,property:null,oldValue:null,newValue:null},b=l();var f=g;export default f;
