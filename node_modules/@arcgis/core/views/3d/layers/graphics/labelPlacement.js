/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import"../../../../core/has.js";import{isNone as e,isSome as t}from"../../../../core/maybe.js";import r from"../../../../core/Logger.js";import{f as n,c as a}from"../../../../chunks/vec3f64.js";import{l as c}from"../../../../chunks/vec3.js";import{a as l}from"../../../../chunks/vec2f64.js";import{b as o}from"../../../../chunks/vec4f64.js";import{center as s,height as i,create as f}from"../../../../geometry/support/aaBoundingBox.js";import{HUDMaterial as p}from"../../webgl-engine/materials/HUDMaterial.js";import{getGraphics3DSymbol as m}from"./graphicSymbolUtils.js";const h=r.getLogger("esri.views.3d.layers.graphics.labelPlacement");function u(t){const r=D(t);if(e(r))return null;const n=b(t,r);if(e(n))return null;const c=n.anchor,s=!!r.hasLabelVerticalOffset;return y({anchor:c,verticalOffset:r.verticalOffset,screenOffset:l(),centerOffset:o(0,0,0,-1),centerOffsetUnits:"world",translation:a(),elevationOffset:0,hasLabelVerticalOffset:s},n,t)}function b(e,t){if(t.anchor)return t;const r=e.labelClass.labelPlacement,n=C[r],a=n||v(e);return r&&!n&&h.warnOncePerTick(`the requested label placement '${r}' is not currently supported in SceneView`),O(a,e)}function g(e){const r=e.graphics3DGraphic.graphics3DSymbol,n=m(r);return t(n)?n.symbol.symbolLayers.getItemAt(0):null}function O(r,n){const a=n.graphics3DGraphic.graphic.geometry;if(e(a))return null;if(t(n.disablePlacement)){return n.labelClass.labelPlacement?(h.warnOncePerTick(d(r.placement,n.disablePlacement.logEntityDescription)),v(n)):r}const c=a.type;switch(c){case"polyline":case"polygon":case"extent":case"multipoint":if(n.labelClass.labelPlacement)return h.warnOncePerTick(d(r.placement,`'${c}' geometries`)),v(n);break;case"point":case"mesh":return r}return r}function d(e,t){return`the requested label placement '${e}' is currently unsupported for ${t} in SceneView`}function v(r){const n=r.graphics3DGraphic.graphic.geometry;if(e(n))return null;switch(n.type){case"polyline":case"extent":case"multipoint":return{placement:"center-center",normalizedOffset:null,anchor:"center"};case"polygon":{const e=g(r);return t(e)&&"extrude"===e.type?C["above-center"]:{placement:"center-center",normalizedOffset:null,anchor:"center"}}case"point":case"mesh":return C["above-center"];default:return}}function y(t,r,n){const a=n.graphics3DGraphic.graphic.geometry;if(e(a))return null;switch(a.type){case"point":w(t,r,n);break;case"polygon":P(t,r,n);break;case"mesh":j(t,r,n)}return t}function P(r,n,a){const c=g(a);if(!e(c))switch(c.type){case"extrude":{const e=a.graphics3DGraphic._graphics[0];t(e)&&e.getBoundingBoxObjectSpace(B),s(B,r.translation),r.translation[2]=i(B)/2,j(r,n,a);break}}}function w(t,r,n){const a=g(n);if(!e(a))switch(n.graphics3DGraphic.getCenterObjectSpace(t.translation),a.type){case"icon":case"text":L(t,r,n);break;case"object":j(t,r,n)}}function L(e,r,n){const{graphics3DGraphic:a}=n,c=a._graphics[0],l=t(c)?c.getScreenSize():null;if(!a.isDraped&&t(l)){const t=z(n);x[0]=l[0]/2*(r.normalizedOffset[0]-t[0]),x[1]=l[1]/2*(r.normalizedOffset[1]-t[1]),e.screenOffset[0]=x[0],e.hasLabelVerticalOffset?(e.centerOffset[1]=x[1],e.centerOffsetUnits="screen"):e.screenOffset[1]=x[1]}else e.hasLabelVerticalOffset||"center"===e.anchor||(C[n.labelClass.labelPlacement]&&h.warnOncePerTick(`the requested placement '${r.placement}' is currently unsupported for draped graphics`),e.anchor="center")}function z(e,r=G){const{graphics3DGraphic:n}=e,a=n._graphics[0],c=t(a)?a.stageObject.geometryRecords[0].material:null;if(c&&c instanceof p){const e=c.params.anchorPos;r[0]=2*(e[0]-.5),r[1]=2*(e[1]-.5)}else r[0]=0,r[1]=0;return r}function j(e,r,a){const l=a.graphics3DGraphic._graphics[0],o=t(l)?l.getBoundingBoxObjectSpace(B):B,s=n(o[3]-o[0],o[4]-o[1],o[5]-o[2]),i=Math.sqrt(s[0]*s[0]+s[1]*s[1]);e.centerOffset[0]=i/2*r.normalizedOffset[0];const f=e.translation[2],p=s[2]/2*r.normalizedOffset[1];e.translation[2]=0,e.elevationOffset=f+p;const m=c(s);e.centerOffset[2]=m/2*r.normalizedOffset[2]}function S(e){switch(e){case"above-center":return!0;default:return!1}}function D(e){const r=e.labelClass.labelPlacement,{labelSymbol:n,graphics3DGraphic:a}=e,c=m(a.graphics3DSymbol),l=t(c)?c.symbol:null,o=C[r]||v(e);return"point-3d"===l.type&&l.supportsCallout()&&l.hasVisibleVerticalOffset()&&!a.isDraped?{placement:null,hasLabelVerticalOffset:!1,verticalOffset:k(l.verticalOffset),anchor:null,normalizedOffset:null}:!n||!n.hasVisibleVerticalOffset()||"point-3d"===l.type&&l.supportsCallout()&&l.verticalOffset&&!a.isDraped?{placement:null,verticalOffset:null,anchor:null,normalizedOffset:null,hasLabelVerticalOffset:!1}:S(o.placement)?{placement:"above-center",verticalOffset:k(n.verticalOffset),anchor:"bottom",normalizedOffset:[0,o.normalizedOffset[1],0],hasLabelVerticalOffset:!0}:(h.errorOncePerTick("Callouts and vertical offset on labels are currently only supported with 'above-center' label placement (not with "+r+" placement)"),null)}function k(e){const{screenLength:t,minWorldLength:r,maxWorldLength:n}=e;return{screenLength:t,minWorldLength:r,maxWorldLength:n}}const C={"above-center":{placement:"above-center",normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{placement:"above-left",normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{placement:"above-right",normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{placement:"below-center",normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{placement:"below-left",normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{placement:"below-right",normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{placement:"center-center",normalizedOffset:[0,0,1],anchor:"center"},"center-left":{placement:"center-left",normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{placement:"center-right",normalizedOffset:[1,0,0],anchor:"left"}},V={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};for(const T in V){const e=V[T],t=C[T];e.forEach((e=>{C[e]=t}))}Object.freeze&&(Object.freeze(C),Object.keys(C).forEach((function(e){Object.freeze(C[e]),Object.freeze(C[e].normalizedOffset)})));const x=[0,0],G=[0,0],B=f();export{u as get};
