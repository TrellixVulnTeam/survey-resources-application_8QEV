/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{isNone as e,isSome as t,unwrapOr as s}from"../../../../core/maybe.js";import{c as i}from"../../../../chunks/vec3f64.js";import{g as a,i as n,b as r}from"../../../../chunks/vec3.js";import{create as o,isPoint as c,empty as h,center as d,offset as l,setMin as g,setMax as u}from"../../../../geometry/support/aaBoundingBox.js";import{g as b}from"../../../../chunks/sphere.js";import{demResolutionForBoundingBox as O}from"./graphicUtils.js";import{setContextFeature as j}from"./featureExpressionInfoUtils.js";class m{constructor(e,t,s,i,a,n,r,o=null){this.graphics3DSymbolLayer=e,this.stageObject=t,this._uniqueGeometries=s,this._uniqueMaterials=i,this._uniqueTextures=a,this.elevationAligner=n,this.elevationContext=r,this._edgeState=o,this.type="object3d",this.stageLayer=null,this.stage=null,this._visible=!1,this._addedToStage=!1,this.alignedSampledElevation=0,this.needsElevationUpdates=!1,this.graphics3DSymbolLayer=e,this.stageObject=t}get isElevationSource(){return!(!this.stageObject.metadata||!this.stageObject.metadata.isElevationSource)}getBSRadius(){throw new Error("Method not implemented.")}initialize(e,t){this.stageLayer=t,this.stage=e,e.addMany(this._uniqueMaterials),e.addMany(this._uniqueGeometries),e.addMany(this._uniqueTextures),e.add(this.stageObject)}destroy(){const e=this.stage;this.stageLayer&&(e.removeMany(this._uniqueMaterials),e.removeMany(this._uniqueGeometries),e.removeMany(this._uniqueTextures)),e.remove(this.stageObject),this._addedToStage&&(this.stageLayer.remove(this.stageObject),this._addedToStage=!1);const t=this.stage.renderView.ensureEdgeView();t.hasObject(this.stageObject)&&t.removeObject(this.stageObject),this.stageObject.dispose(),this._visible=!1,this.stageLayer=null,this.stage=null}layerOpacityChanged(t,s){if(e(this._edgeState))return;const i=p(this._edgeState.baseMaterial);let a=!1;for(const e of this._edgeState.edgeMaterials)e.objectTransparency!==i&&(e.objectTransparency=i,a=!0);a&&this.resetEdgeObject(s);this.stage.renderView.ensureEdgeView().updateAllComponentOpacities(this.stageObject,[t])}slicePlaneEnabledChanged(t,s){if(e(this._edgeState))return;this.stage.renderView.ensureEdgeView().updateAllComponentMaterials(this.stageObject,this._edgeState.edgeMaterials,{slicePlaneEnabled:t},!s),this._edgeState.properties.slicePlaneEnabled=t}setVisibility(e){if(null!=this.stage&&this._visible!==e&&(this._visible=e,this._visible?this._addedToStage?this.stageObject.setVisible(!0):(this.stageLayer.add(this.stageObject),this._addedToStage=!0):this.stageObject.setVisible(!1),t(this._edgeState))){const t=this.stage.renderView.ensureEdgeView();t.hasObject(this.stageObject)?t.updateObjectVisibility(this.stageObject,e):e&&this.addOrUpdateEdgeObject(t,!1)}}get visible(){return this._visible}alignWithElevation(e,s,i,a){if(null==this.elevationAligner)return;t(i)&&j(this.elevationContext.featureExpressionInfoContext,i);const n=this.elevationAligner(this,this.elevationContext,e,s);null!=n&&(this.alignedSampledElevation=n),this.resetEdgeObject(a)}getCenterObjectSpace(e=i()){return a(e,b(this.stageObject.getBounds(!0)))}getBoundingBoxObjectSpace(e=o()){return v(this.stageObject,!0,e)}computeAttachmentOrigin(e){for(const t of this.stageObject.geometryRecords)t.computeAttachmentOrigin(_)&&(n(_,_,this.stageObject.transformation),r(e.render.origin,e.render.origin,_),e.render.num++)}async getProjectedBoundingBox(e,t,i,a,r){const o=this.getBoundingBoxObjectSpace(r),g=y,u=c(o)?1:g.length;for(let s=0;s<u;s++){const e=g[s];f[0]=o[e[0]],f[1]=o[e[1]],f[2]=o[e[2]],n(f,f,this.stageObject.transformation),E[3*s+0]=f[0],E[3*s+1]=f[1],E[3*s+2]=f[2]}if(!e(E,0,u))return null;h(o);let b=null;this.calculateRelativeScreenBounds&&(b=this.calculateRelativeScreenBounds());for(let s=0;s<3*u;s+=3){for(let e=0;e<3;e++)o[e]=Math.min(o[e],E[s+e]),o[e+3]=Math.max(o[e+3],E[s+e]);b&&i.push({location:E.slice(s,s+3),screenSpaceBoundingRect:b})}if(t&&t.service&&"absolute-height"!==this.elevationContext.mode){d(o,_);const e="relative-to-scene"===this.elevationContext.mode?"scene":"ground";let i=0;if(t.useViewElevation)i=s(t.service.getElevation(_[0],_[1],e),0);else try{const n=O(o,t);i=s(await t.service.queryElevation(_[0],_[1],a,n,e),0)}catch(j){}l(o,0,0,-this.alignedSampledElevation+i)}return o}addObjectState(e,t){0===e&&t.addObject(this.stageObject,this.stageObject.highlight()),1===e&&t.addObject(this.stageObject,this.stageObject.maskOccludee())}removeObjectState(e){e.removeObject(this.stageObject)}resetEdgeObject(t){if(e(this._edgeState))return;const s=this.stage.renderView.ensureEdgeView();this._visible?this.addOrUpdateEdgeObject(s,t):s.removeObject(this.stageObject)}addOrUpdateEdgeObject(t,s){const i=this._edgeState;if(e(i))return;const a=p(i.baseMaterial);for(const e of i.edgeMaterials)e.objectTransparency=a;t.addOrUpdateObject3D(this.stageObject,i.edgeMaterials,i.properties,!s).then((()=>{var e;return null==(e=this.stageLayer)?void 0:e.commit()}))}}function p(e){return e.isVisible?e.params.transparent?1:2:0}function v(e,t,s){return s||(s=o()),g(s,e.getBBMin(t)),u(s,e.getBBMax(t)),s}!function(e){let t;!function(e){e[e.REMOVE_OBJECT=0]="REMOVE_OBJECT",e[e.HIDE_FACERANGE=1]="HIDE_FACERANGE"}(t=e.VisibilityModes||(e.VisibilityModes={}))}(m||(m={}));const E=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],f=i(),_=i(),y=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];var S=m;export default S;
