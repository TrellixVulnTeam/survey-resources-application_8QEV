/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{isSome as e,get as t,isNone as i,unwrap as r}from"../../../../core/maybe.js";import n from"../../../../Color.js";import{pt2px as o}from"../../../../core/screenUtils.js";import{I as a}from"../../../../chunks/mat4f64.js";import{earcut as s}from"../../../../core/libs/earcut/earcut.js";import{s as l}from"../../../../chunks/vec4.js";import{BufferViewMat3f64 as u,BufferViewVec3f64 as p,BufferViewVec4f as c}from"../../support/buffer/BufferView.js";import{empty as h,expandWithBuffer as m,intersectsClippingArea as d,expandWithAABB as _,create as y}from"../../../../geometry/support/aaBoundingBox.js";import{Object3D as g}from"../../webgl-engine/lib/Object3D.js";import{mixinColorAndOpacity as f}from"./graphicUtils.js";import{elevationModeChangeUpdateType as b,SymbolUpdateType as M,needsElevationUpdates2D as E}from"./elevationAlignmentUtils.js";import{ElevationContext as x}from"./ElevationContext.js";import v from"./Graphics3DObject3DGraphicLayer.js";import{Graphics3DSymbolLayer as O}from"./Graphics3DSymbolLayer.js";import{RibbonLineMaterial as D}from"../../webgl-engine/materials/RibbonLineMaterial.js";import{createStipplePattern as A}from"../../webgl-engine/materials/lineStippleUtils.js";import{geometryAsPolygon as S,geometryToRenderInfo as P,createColorGeometry as C,geometryToRenderInfoDraped as U}from"./polygonUtils.js";import G from"./Graphics3DDrapedGraphicLayer.js";import{RenderGeometry as w}from"../../webgl-engine/lib/RenderGeometry.js";import{createGeometry as j}from"./lineUtils.js";import{NativeLineMaterial as T}from"../../webgl-engine/materials/NativeLineMaterial.js";import{createMapSpaceUVCoords as R,createMapSpaceUVCoordsDraped as B}from"../support/uvUtils.js";import{PatternMaterial as L}from"../../webgl-engine/materials/PatternMaterial.js";import{createMaterial as N,uvElevationAligner as V}from"../support/patternUtils.js";const F=["polyline","polygon","extent"];class I extends O{constructor(e,t,i,r){super(e,t,i,r),this._needsUV=!1,this._hasOutline=!1}async doLoad(){}ensureMaterials(){this.ensureFillMaterial(),this.ensureOutlineMaterial()}ensureFillMaterial(){if(e(this._material))return;const i=t(this.symbolLayer,"material","color"),r=this._getCombinedOpacityAndColor(i);this._material=N(this.symbolLayer,{color:r,transparent:r[3]<1||this.needsDrivenTransparentPass,polygonOffset:!1,vertexColors:!0,writeLinearDepth:!0,slicePlaneEnabled:this._context.slicePlaneEnabled},{isDraped:this.draped}),this._needsUV=this._material instanceof L,this._context.stage.add(this._material)}ensureOutlineMaterial(){const t=this.symbolLayer.outline;if(e(this._outlineMaterial)||!this._isValidOutline(t))return;this._hasOutline=!0;const i=e=>{const i=t.stipplePattern?A(t.stipplePattern.map(o)):null,r=t.stippleOffColor?n.toUnitRGBA(t.stippleOffColor):null;return e>1.5?new D({width:e,color:this._getOutlineColor(),polygonOffset:!0,slicePlaneEnabled:this._context.slicePlaneEnabled,isClosed:!0,stipplePattern:i,stippleIntegerRepeats:!0,stippleOffColor:r}):new T({color:this._getOutlineColor(),slicePlaneEnabled:this._context.slicePlaneEnabled,width:e,stipplePattern:i,stippleIntegerRepeats:!0,stippleOffColor:r})};this._outlineMaterial=i(o(t.size)),this._context.stage.add(this._outlineMaterial)}_isValidOutline(t){return e(t)&&t.size&&t.size>0&&e(t.color)}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null,this._context.stage.remove(this._outlineMaterial),this._outlineMaterial=null}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,F,this.symbolLayer.type))return null;const i=this._getVertexOpacityAndColor(e.renderingInfo,255),r=this.setGraphicElevationContext(t,new x);return this.ensureDrapedStatus("on-the-ground"===r.mode),this.ensureMaterials(),this.draped?this._createAsOverlay(t,i):this._createAs3DShape(t,i,r)}layerOpacityChanged(){if(e(this._material)){const e=this._material.params.color,i=t(this.symbolLayer,"material","color"),r=this._getCombinedOpacity(i);this._material.setParameterValues({color:[e[0],e[1],e[2],r],transparent:r<1||this.needsDrivenTransparentPass})}if(e(this._outlineMaterial)){const e=this._outlineMaterial.params.color;this._outlineMaterial.setParameterValues({color:[e[0],e[1],e[2],this._getOutlineOpacity()]})}return!0}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,n=b(I.elevationModeChangeTypes,i,r);if(n!==M.UPDATE)return n;const o=E(r);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>o))}slicePlaneEnabledChanged(){if(e(this._material)&&this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),e(this._outlineMaterial)){const e={slicePlaneEnabled:this._context.slicePlaneEnabled};this._outlineMaterial.setParameterValues(e)}return!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}_createAs3DShape(e,t,r){const n=S(e.geometry);if(i(n))return null;Y.renderData=P(n,this._context.elevationProvider,this._context.renderCoordsHelper,r),Y.color=t;const o=Y.renderData.position.length/3;if(this._needsUV&&(Y.uvMapSpace=new Float32Array(4*o),Y.boundingRect=new Float64Array(9*o)),Y.outNum=0,Y.outGeometries=[],Y.outTransforms=[],Y.outMaterials=[],this._createAs3DShapeFill(Y),this._hasOutline&&this._createAs3DShapeOutline(Y),this._logGeometryCreationWarnings(Y.renderData,n.rings,"rings","FillSymbol3DLayer"),0===Y.outNum)return null;this._needsUV&&R(c.fromTypedArray(Y.uvMapSpace),p.fromTypedArray(Y.renderData.position),this._context.renderCoordsHelper,u.fromTypedArray(Y.boundingRect));const a=new g({geometries:Y.outGeometries,materials:Y.outMaterials,transformations:Y.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:e.uid}}),s=V,l=new v(this,a,Y.outGeometries,null,null,s,r);return l.alignedSampledElevation=Y.renderData.sampledElevation,l.needsElevationUpdates=E(r.mode),l}_createAs3DShapeFill(t){const i=t.renderData.polygons;for(const{position:n,mapPosition:o,holeIndices:l,index:u,count:p}of i){if(e(this._context.clippingExtent)&&(h(z),m(z,o),!d(z,this._context.clippingExtent)))continue;const i=s(o,l,3);if(0===i.length)continue;const c=new Uint32Array(i),_=C({indices:c,attributeData:{position:n,color:t.color,mapPosition:o,uvMapSpace:this._needsUV?new Float32Array(t.uvMapSpace.buffer,4*u*t.uvMapSpace.BYTES_PER_ELEMENT,4*p):null,boundingRect:this._needsUV?new Float64Array(t.boundingRect.buffer,9*u*t.boundingRect.BYTES_PER_ELEMENT,9*p):null}});t.outGeometries.push(_),t.outMaterials.push(r(this._material)),t.outTransforms.push(a),t.outNum++}}_createAs3DShapeOutline(t){if(!this._hasOutline)return;const i=t.renderData.outlines,n=this._outlineMaterial instanceof T;for(let o=0;o<i.length;++o){const{mapPosition:s,position:l}=i[o];if(e(this._context.clippingExtent)&&(h(z),m(z,s),!d(z,this._context.clippingExtent)))continue;const u=j({removeDuplicateStartEnd:n?0:1,attributeData:{position:l,mapPosition:s}}),p=u.vertexAttributes.get("position");p.data===l&&(p.data=new Float64Array(l)),t.outGeometries.push(u),t.outMaterials.push(r(this._outlineMaterial)),t.outTransforms.push(a),t.outNum++}}_createAsOverlay(t,n){const o=S(t.geometry);if(i(o))return null;r(this._material).renderPriority=this._renderPriority+this._renderPriorityStep/2,e(this._outlineMaterial)&&(this._outlineMaterial.renderPriority=this._renderPriority),k.renderData=U(o,this._context.overlaySR),k.color=n;const a=k.renderData.position.length/3;return this._needsUV&&(k.uvMapSpace=new Float32Array(4*a)),k.outNum=0,k.outGeometries=[],k.outBoundingBox=h(),k.layerUid=this._context.layer.uid,k.graphicsUid=t.uid,this._createAsOverlayFill(k),this._hasOutline&&this._createAsOverlayOutline(k),this._logGeometryCreationWarnings(k.renderData,o.rings,"rings","FillSymbol3DLayer"),0===k.outNum?null:(this._needsUV&&B(c.fromTypedArray(k.uvMapSpace),p.fromTypedArray(k.renderData.position),this._context.overlaySR),k.outNum>0?new G(this,k.outGeometries,k.outBoundingBox):null)}_createAsOverlayFill(e){const t=e.renderData.polygons;for(const{position:i,holeIndices:n,index:o,count:a}of t){if(h(z),m(z,i),!d(z,this._context.clippingExtent))continue;const t=s(i,n,3);if(0===t.length)continue;_(e.outBoundingBox,z);const u=new Uint32Array(t),p=C({indices:u,attributeData:{position:i,color:e.color,uvMapSpace:this._needsUV?new Float32Array(e.uvMapSpace.buffer,4*o*e.uvMapSpace.BYTES_PER_ELEMENT,4*a):null}}),c=new w(p,r(this._material),e.layerUid,e.graphicsUid),y=z;l(c.boundingSphere,.5*(y[0]+y[3]),.5*(y[1]+y[4]),0,.5*Math.sqrt((y[3]-y[0])*(y[3]-y[0])+(y[4]-y[1])*(y[4]-y[1]))),e.outGeometries.push(c),e.outNum++}}_createAsOverlayOutline(e){if(!this._hasOutline)return;const t=e.renderData.outlines;for(let i=0;i<t.length;++i){const{position:n}=t[i];if(h(z),m(z,n),!d(z,this._context.clippingExtent))continue;_(e.outBoundingBox,z);const o=this._outlineMaterial instanceof T,a=j({removeDuplicateStartEnd:o?0:1,attributeData:{position:n}}),s=new w(a,r(this._outlineMaterial),e.layerUid,e.graphicsUid),u=z;l(s.boundingSphere,.5*(u[0]+u[3]),.5*(u[1]+u[4]),0,.5*Math.sqrt((u[3]-u[0])*(u[3]-u[0])+(u[4]-u[1])*(u[4]-u[1]))),e.outGeometries.push(s),e.outNum++}}_getOutlineOpacity(){const i=t(this.symbolLayer,"outline","color");return(this.draped?1:this._getLayerOpacity())*(e(i)?i.a:0)}_getOutlineColor(){const i=t(this.symbolLayer,"outline","color"),r=this._getOutlineOpacity();return f(e(i)?n.toUnitRGB(i):null,r)}get test(){return{createAsOverlay:(e,t)=>this._createAsOverlay(e,t),createAs3DShape:(e,t,i)=>this._createAs3DShape(e,t,i)}}}I.elevationModeChangeTypes={definedChanged:M.RECREATE,staysOnTheGround:M.NONE,onTheGroundChanged:M.RECREATE};const z=y(),Y={renderData:null,color:null,uvMapSpace:null,boundingRect:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},k={renderData:null,color:null,uvMapSpace:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null};export default I;export{I as Graphics3DPolygonFillSymbolLayer};
