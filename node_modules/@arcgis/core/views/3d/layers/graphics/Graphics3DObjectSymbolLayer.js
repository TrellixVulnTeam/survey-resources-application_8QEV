/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{isSome as e,get as t,none as s,isNone as r,unwrapOr as i}from"../../../../core/maybe.js";import a from"../../../../Color.js";import{pt2px as o}from"../../../../core/screenUtils.js";import{defaultPrimitive as n}from"../../../../symbols/support/ObjectSymbol3DLayerResource.js";import{d as l,O as c,Z as h,f as d,c as p}from"../../../../chunks/vec3f64.js";import{l as m,p as u,g as y,B as f,b as _,s as g}from"../../../../chunks/vec3.js";import{c as b,i as P,s as v,t as x}from"../../../../chunks/mat4.js";import{projectPointToVector as R,computeLinearTransformation as L}from"../../../../geometry/projection.js";import{a as S}from"../../../../chunks/mat4f64.js";import{O as C,a as E}from"../../../../chunks/vec4f64.js";import{create as U,size as j,containsPoint as T,center as B}from"../../../../geometry/support/aaBoundingBox.js";import{validateSymbolLayerSize as w,mixinColorAndOpacity as G,computeObjectScale as O,computeObjectRotation as V}from"./graphicUtils.js";import{needsElevationUpdates3D as z,evaluateElevationAlignmentAtPoint as I}from"./elevationAlignmentUtils.js";import{perLodInstanceElevationAligner as M}from"./ElevationAligners.js";import{ElevationContext as D}from"./ElevationContext.js";import{isValidPrimitive as A,primitiveLodResources as F}from"./primitiveObjectSymbolUtils.js";import{materialsFromLodResources as k,texturesFromLodResources as W,geometriesFromLodResources as q,geometriesFromLodLevelResources as H}from"../../webgl-engine/lib/lodRendering/LodResources.js";import{defaultSymbolLayerMemoryComplexity as $}from"./symbolComplexity.js";import{Graphics3DSymbolLayer as Z}from"./Graphics3DSymbolLayer.js";import{placePointOnGeometry as J,extendPointGraphicElevationContext as K}from"./pointUtils.js";import{DefaultMaterial as N}from"../../webgl-engine/materials/DefaultMaterial.js";import{initFastSymbolUpdatesState as Q,updateFastSymbolUpdatesState as X,evaluateModelTransform as Y,evaluateModelTransformScale as ee}from"../support/FastSymbolUpdates.js";import{objectSymbolLayerPrimitiveBoundingBox as te,objectSymbolLayerSizeWithResourceSize as se}from"../../../../symbols/support/symbolLayerUtils3D.js";import re from"./Graphics3DLodInstanceGraphicLayer.js";import{makeLodResources as ie,fillEstimatedMinScreenSpaceRadius as ae}from"./lodResourceUtils.js";import{fetch as oe}from"./objectResourceUtils.js";import{LodRenderer as ne}from"../../webgl-engine/lib/lodRendering/LodRenderer.js";class le extends Z{constructor(e,t,s,r){super(e,t,s,r),this._resources=null,this._optionalFields=[],this._instanceIndexToGraphicUid=new Map,this.hasLoadedPBRTextures=!1,this.ensureDrapedStatus(!1),this.hasLoadedPBRTextures=s.physicalBasedRenderingEnabled}getCachedSize(){const[t,s,r]=e(this._resources)?this._resources.symbolSize:[1,1,1];return{width:t,depth:s,height:r}}async doLoad(e){if(!this._drivenProperties.size){if(w(this.symbolLayer))throw new Error}const t=this.symbolLayer;if(this.isPrimitive){const e=t.resource?t.resource.primitive:n;this._resources=this._createResourcesForPrimitive(e)}else this._resources=await this._createResourcesForUrl(t.resource.href,e);this.complexity=this.computeComplexity()}get extentPadding(){return e(this._resources)?this._resources.extentPadding:0}get isPrimitive(){return!(this.symbolLayer.resource&&this.symbolLayer.resource.href)}get lodRenderer(){return t(this._resources,"lodRenderer")}setMaterialTransparencyParams(e,s=t(this.symbolLayer,"material","color")){const r=this._getCombinedOpacity(s),i=r<1||this.needsDrivenTransparentPass;return e.transparent=i,e.opacity=r,e}_createResourcesForPrimitive(t){if(!A(t))throw new Error(`Unknown object symbol primitive: ${t}`);const r=this.symbolLayer,i=U(te(t)),n=l(j(i)),h=l(se(n,r)),d=m(h),p=!1,u=!1,y={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,instanced:["transformation"],ambient:c,diffuse:c,slicePlaneEnabled:this._context.slicePlaneEnabled,sliceHighlightDisabled:!0,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!this.symbolLayer.isPrimitive},f=y.usePBR;this.setMaterialTransparencyParams(y);const _=this.symbol;if("point-3d"===_.type&&_.verticalOffset){const{screenLength:e,minWorldLength:t,maxWorldLength:s}=_.verticalOffset;y.verticalOffset={screenLength:o(e),minWorldLength:t||0,maxWorldLength:null!=s?s:1/0},y.castShadows=!1}if(this._context.screenSizePerspectiveEnabled&&(y.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),this._drivenProperties.color)y.externalColor=C;else{const t=e(r.material)&&r.material.color,s=e(t)?a.toUnitRGBA(t):C;y.externalColor=s}this._fastUpdates=Q(this._context.renderer,this._fastVisualVariableConvertOptions(i,h,n,s)),this._fastUpdates.enabled?(Object.assign(y,this._fastUpdates.materialParameters),y.instanced.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(y.instanced.push("color"),this._optionalFields.push("color"));const g=new N(y),b=F(t,g);if(!b)throw new Error(`Unknown object symbol primitive: ${t}`);const P=k(b).map((e=>({opacity:1,transparent:e.params.transparent}))),v=this._createStageResources(b,f);return{lodResources:b,lodRenderer:this._createLodRenderer(b),stageResources:v,symbolSize:h,extentPadding:d,isEsriSymbolResource:p,isWosr:u,originalMaterialParameters:P,physicalBasedRenderingEnabled:f,resourceBoundingBox:i,resourceSize:n,dispose:s,pivotOffset:s}}async _createResourcesForUrl(e,r){const i=["transformation"],a={materialParamsMixin:{instanced:i,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},streamDataRequester:this._context.streamDataRequester,cache:this._context.sharedResources.objectResourceCache};this._fastUpdates=Q(this._context.renderer,this._fastVisualVariableConvertOptions(s,s,s,s)),this._fastUpdates.enabled?(Object.assign(a.materialParamsMixin,this._fastUpdates.materialParameters),i.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(i.push("color"),this._optionalFields.push("color"));const n=this.symbol;if("point-3d"===n.type&&n.verticalOffset){const{screenLength:e,minWorldLength:t,maxWorldLength:s}=n.verticalOffset;a.materialParamsMixin.verticalOffset={screenLength:o(e),minWorldLength:t||0,maxWorldLength:null!=s?s:1/0},a.materialParamsMixin.castShadows=!1}a.signal=r,a.usePBR=this._context.physicalBasedRenderingEnabled;const c=a.usePBR,h=await oe(e,a),d=h.isEsriSymbolResource,p=h.isWosr,u=h.remove,y=ie(h.lods);ae(y),y.levels.sort(((e,t)=>e.minScreenSpaceRadius-t.minScreenSpaceRadius)),y.levels[0].minScreenSpaceRadius=Math.min(2,y.levels[0].minScreenSpaceRadius);const f=this._context,_=this.symbolLayer.material,g=this._getExternalColorParameters(_),b=t(this.symbolLayer,"material","color"),P=this._getCombinedOpacity(b,{hasIntrinsicColor:!0}),v=this.needsDrivenTransparentPass,x=k(y),R=k(y).map((e=>{const t=e.params;return{opacity:t.opacity||1,transparent:t.transparent}}));x.forEach((e=>{const t=e.params;e.setParameterValues(g);const s=t.opacity*P,r=s<1||v||t.transparent;e.setParameterValues({opacity:s,transparent:r}),f.screenSizePerspectiveEnabled&&e.setParameterValues({screenSizePerspective:f.sharedResources.screenSizePerspectiveSettings})}));const L=h.referenceBoundingBox,S=l(j(L)),C=l(y.levels[0].pivotOffset),E=l(se(S,this.symbolLayer)),U=m(E);X(this._fastUpdates,this._context.renderer,this._fastVisualVariableConvertOptions(L,E,S,C))&&x.forEach((e=>e.setParameterValues(this._fastUpdates.materialParameters)));const T=this._createStageResources(y,c);return{lodResources:y,lodRenderer:this._createLodRenderer(y),stageResources:T,symbolSize:E,extentPadding:U,isEsriSymbolResource:d,isWosr:p,originalMaterialParameters:R,physicalBasedRenderingEnabled:c,resourceBoundingBox:L,resourceSize:S,dispose:u,pivotOffset:C}}_createStageResources(e,t){const s=this._context.stage,r=k(e);t!==this._context.physicalBasedRenderingEnabled&&this.physicalBasedRenderingChanged(),s.addMany(r);const i=W(e);s.addMany(i);const a=q(e);return s.addMany(a),{materials:r,textures:i,geometries:a}}_createLodRenderer(e){const t=this._context.stage,s={layerUid:this._context.layer.uid,graphicUid:e=>this._instanceIndexToGraphicUid.get(e),notifyGraphicGeometryChanged:e=>this._context.notifyGraphicGeometryChanged(this._instanceIndexToGraphicUid.get(e)),notifyGraphicVisibilityChanged:e=>this._context.notifyGraphicVisibilityChanged(this._instanceIndexToGraphicUid.get(e))},r=this._fastUpdates.enabled?{applyTransform:(e,t,s)=>{e.getFeatureAttribute(t,pe),b(s,Y(this._fastUpdates.materialParameters,pe,s))},scaleFactor:(e,t,s)=>(t.getFeatureAttribute(s,pe),ee(e,this._fastUpdates.materialParameters,pe))}:null,i=new ne(e,this._optionalFields,s,r);return i.slicePlane=this._context.slicePlaneEnabled,t.addRenderPlugin(i.slots,i),i}_getExternalColorParameters(t){const s={};return this._drivenProperties.color?s.externalColor=C:e(t)&&e(t.color)?s.externalColor=a.toUnitRGBA(t.color):(s.externalColor=C,s.colorMixMode="ignore"),s}destroy(){super.destroy();const t=this._context.stage;if(e(this._resources)){t.removeRenderPlugin(this._resources.lodRenderer),this._resources.lodRenderer.destroy();const s=this._resources.stageResources;t.removeMany(s.materials),t.removeMany(s.textures),t.removeMany(s.geometries),e(this._resources.dispose)&&this._resources.dispose()}this._resources=null}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry))return null;const s=J(t.geometry);if(r(s))return this.logger.warn(`unsupported geometry type for icon symbol: ${t.geometry.type}`),null;const i=this.setGraphicElevationContext(t,new D),a=e.renderingInfo;return this._createAs3DShape(t,s,a,i,t.uid)}notifyDestroyGraphicLayer(e){this._instanceIndexToGraphicUid.delete(e.instanceIndex)}graphicLayerToGraphicId(){return 0}layerOpacityChanged(){if(r(this._resources))return!0;const e=this._drivenProperties.opacity,s=!this.isPrimitive,i=this._resources.stageResources.materials,a=this._resources.originalMaterialParameters;for(let r=0;r<i.length;r++){const o=i[r],n=t(this.symbolLayer,"material","color"),l=a[r],c=this._getCombinedOpacity(n,{hasIntrinsicColor:s})*l.opacity;o.setParameterValues({opacity:c,transparent:c<1||e||l.transparent})}return!0}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,z)}slicePlaneEnabledChanged(){if(r(this._resources))return!0;this._resources.lodRenderer.slicePlane=this._context.slicePlaneEnabled;for(const e of this._resources.stageResources.materials)e.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});return!0}physicalBasedRenderingChanged(){if(r(this._resources))return!0;const{stageResources:e,isWosr:t}=this._resources;for(const s of e.materials)this.isPrimitive?s.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}):t||s.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!1});return!1!==this.hasLoadedPBRTextures||!0!==this._context.physicalBasedRenderingEnabled||(this.hasLoadedPBRTextures=!0,!1)}pixelRatioChanged(){return!0}applyRendererDiff(e,t){if(r(this._resources))return!0;const{stageResources:{materials:s},lodRenderer:i,resourceBoundingBox:a,symbolSize:o,resourceSize:n,pivotOffset:l}=this._resources;for(const r in e.diff)switch(r){case"visualVariables":if(!X(this._fastUpdates,t,this._fastVisualVariableConvertOptions(a,o,n,l)))return!1;for(const e of s)e.setParameterValues(this._fastUpdates.materialParameters);i.notifyShaderTransformationChanged();break;default:return!1}return!0}computeComplexity(){if(r(this._resources))return super.computeComplexity();return{primitivesPerFeature:H(this._resources.lodResources.levels[0]).reduce(((e,t)=>e+t.indices.get("position").length),0)/3,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:$(this.symbol,this.symbolLayer)}}hasLodRenderer(){return e(this._resources)}_createAs3DShape(t,s,i,a,o){if(!this.hasLodRenderer()||r(this._resources))return null;const n=this.getFastUpdateAttrValues(t),l=!this._fastUpdates.enabled&&this._hasPerInstanceColor()?G(i.color,i.opacity):null,c=this._context.clippingExtent;if(R(s,ce,this._context.elevationProvider.spatialReference),e(c)&&!T(c,ce))return null;const h=this._requiresTerrainElevation(a),d=this._computeGlobalTransform(s,a,de,h?me:null),p=this._computeLocalTransform(this._resources,this.symbolLayer,i,he),m=this._resources.lodRenderer.instanceData,u=m.addInstance();this._instanceIndexToGraphicUid.set(u,o),m.setLocalTransform(u,p,!1),m.setGlobalTransform(u,d),n&&m.setFeatureAttribute(u,n),l&&m.setColor(u,l);const y=new re(this,u,M,a);return h&&(y.alignedSampledElevation=me.sampledElevation),y.needsElevationUpdates=z(a.mode),K(y,s,this._context.elevationProvider),y}_computeGlobalTransform(e,t,s,r){const i=I(e,this._context.elevationProvider,t,this._context.renderCoordsHelper,r);return ce[0]=e.x,ce[1]=e.y,ce[2]=i,L(e.spatialReference,ce,s,this._context.renderCoordsHelper.spatialReference),s}_computeLocalTransform(e,t,s,r){return P(r),this._applyObjectRotation(s,!1,r),this._applyObjectRotation(t,!0,r),this._applyObjectScale(e,s,r),this._applyAnchor(e,t,r),r}_applyObjectScale(e,t,s){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const r=this._drivenProperties.size&&t.size?t.size:e.symbolSize,i=O(r,e.symbolSize,e.resourceSize,this._context.renderCoordsHelper.unitInMeters);1===i[0]&&1===i[1]&&1===i[2]||v(s,s,i)}prepareSymbolLayerPatch(e){if("partial"!==e.diff.type)return;const t=e.diff.diff;this._preparePatchTransform(e,t),this._preparePatchColor(e,t)}updateGeometry(e,t){if(r(this._resources))return!0;const s=t&&J(t);if(r(s))return!1;const i=this.getGeometryElevationMode(t);if(e.elevationContext.mode!==i)return!1;const a=this._requiresTerrainElevation(e.elevationContext);return this._computeGlobalTransform(s,e.elevationContext,de,a?me:null),a&&(e.alignedSampledElevation=me.sampledElevation),this._resources.lodRenderer.instanceData.setGlobalTransform(e.instanceIndex,de,!0),K(e,s,this._context.elevationProvider),!0}_preparePatchTransform(e,t){if(!(t.heading||t.tilt||t.roll||t.width||t.height||t.depth||t.anchor||t.anchorPosition))return;if(r(this._resources))return;const s=(e,t,s)=>i(null!=e&&"complete"===e.type?e.newValue:t,s),a=s(t.heading,this.symbolLayer.heading,0),o=s(t.tilt,this.symbolLayer.tilt,0),n=s(t.roll,this.symbolLayer.roll,0),c=s(t.width,this.symbolLayer.width,void 0),h=s(t.height,this.symbolLayer.height,void 0),d=s(t.depth,this.symbolLayer.depth,void 0),p=s(t.anchor,this.symbolLayer.anchor,void 0),m=s(t.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete t.heading,delete t.tilt,delete t.roll,delete t.width,delete t.height,delete t.depth,delete t.anchor,delete t.anchorPosition;const u={heading:a,tilt:o,roll:n,anchor:p,anchorPosition:m},y=this._resources;1===this.loadStatus&&e.symbolLayerStatePatches.push((()=>{y.symbolSize=l(se(y.resourceSize,{width:c,height:h,depth:d,isPrimitive:this.symbolLayer.isPrimitive}))})),e.graphics3DGraphicPatches.push(((e,t)=>{const s=this._computeLocalTransform(y,u,t,he),r=e.instanceIndex;y.lodRenderer.instanceData.setLocalTransform(r,s,!0)}))}_preparePatchColor(t,s){if(!s.material||"partial"!==s.material.type)return;const i=s.material.diff;if(!i.color||"complete"!==i.color.type||null==i.color.newValue||null==i.color.oldValue)return;const o=i.color.newValue,n=e(o)?a.toUnitRGBA(o):C;delete i.color;const l=this._resources;r(l)||t.graphics3DGraphicPatches.push((e=>{let t;this._hasPerInstanceColor()?(l.lodRenderer.instanceData.setColor(e.instanceIndex,n),t=this.setMaterialTransparencyParams({},o)):t=this.setMaterialTransparencyParams({externalColor:n},o);for(const s of l.stageResources.materials)s.setParameterValues(t)}))}_requiresTerrainElevation(e){return"absolute-height"!==e.mode}_applyObjectRotation(e,t,s){if(!(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation&&t))return V(e.heading,e.tilt,e.roll,s)}_computeAnchor(t,s,r){const i=p();switch(r.anchor){case"center":y(i,B(t)),u(i,i);break;case"top":{const e=B(t);g(i,-e[0],-e[1],-t[5]);break}case"bottom":{const e=B(t);g(i,-e[0],-e[1],-t[2]);break}case"relative":{const e=B(t),s=j(t),a=r.anchorPosition,o=a?d(a.x,a.y,a.z):h;f(i,s,o),_(i,i,e),u(i,i);break}case"origin":default:e(s)?u(i,s):y(i,h)}return i}_applyAnchor(e,t,s){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const r=this._computeAnchor(e.resourceBoundingBox,e.pivotOffset,t);r&&x(s,s,r)}_hasPerInstanceColor(){return this._drivenProperties.color||this._drivenProperties.opacity}_fastVisualVariableConvertOptions(t,s,r,i){const a=e(t)?l(j(t)):c,o=e(t)?this._computeAnchor(t,i,this.symbolLayer):h,n=this._context.renderCoordsHelper.unitInMeters,p=O(e(s)?s:void 0,s,r,n),m=d(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return{modelSize:a,symbolSize:e(s)?s:c,unitInMeters:n,transformation:{anchor:o,scale:p,rotation:m}}}}const ce=p(),he=S(),de=S(),pe=E(),me={verticalDistanceToGround:0,sampledElevation:0};export default le;export{le as Graphics3DObjectSymbolLayer};
