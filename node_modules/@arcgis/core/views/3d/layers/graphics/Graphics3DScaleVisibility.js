/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import"../../../../core/has.js";import{isSome as i,isNone as t}from"../../../../core/maybe.js";import"../../../../core/Logger.js";import"../../../../core/accessorSupport/ensureType.js";import{property as s}from"../../../../core/accessorSupport/decorators/property.js";import{subclass as a}from"../../../../core/accessorSupport/decorators/subclass.js";import"../../../../core/urlUtils.js";import"../../../../core/uuid.js";import"../../../../portal/support/resourceExtension.js";import r from"../../../../core/Accessor.js";import l from"../../../../core/Handles.js";import{Task as n}from"../../../support/Scheduler.js";import{scaleBoundsPredicate as c}from"../../../support/layerViewUtils.js";let h=class extends r{constructor(){super(...arguments),this._scaleRangeActive=!1,this.layerScaleRangeVisibilityQuery=!1,this.handles=new l,this.layerView=null,this.layer=null,this.queryGraphicUIDsInExtent=null,this.extent=null,this.graphicsCore=null,this.basemapTerrain=null,this.layerScaleEnabled=!0,this.suspended=!1,this.updating=!0}setup(e,i,t,s,a){this.layerView=e,this.layer=i,this.queryGraphicUIDsInExtent=t,this.graphicsCore=s,this.basemapTerrain=a,this.updateScaleRangeActive();const r=this.layerView.view.resourceController.scheduler;this.handles.add(r.registerTask(n.SCALE_VISIBILITY,(()=>this.update()),(()=>this.needsUpdate())))}destroy(){this.handles.destroy(),this.handles=null,this.layerView=null,this.extent=null,this.queryGraphicUIDsInExtent=null,this.graphicsCore=null}needsUpdate(){return!(!this.layerView.view.basemapTerrain||!this.updating)}_setDirty(){this.updating||this._set("updating",!0)}setExtent(e){this.extent=e,this._setDirty()}scaleRangeActive(){return this._scaleRangeActive}updateScaleRangeActive(){const e=this.layer;let i=this.layerScaleEnabled&&p(e.minScale,e.maxScale);e.labelingInfo&&!i&&(i=e.labelingInfo.some((e=>e&&p(e.minScale,e.maxScale))));const t=this._scaleRangeActive!==i;return this._scaleRangeActive=i,i&&!this.handles.has(o)&&this.basemapTerrain?(this.handles.add(this.basemapTerrain.on("scale-change",(e=>this.scaleUpdateHandler(e))),o),this.layerScaleEnabled&&this.handles.add(this.basemapTerrain.on("tiles-visibility-changed",(()=>this._setDirty())),o)):!i&&this.handles.has(o)&&this.handles.remove(o),t}update(){const e=this.layerView.view.basemapTerrain;this.extent&&e&&e.ready&&this._scaleRangeActive&&this.layerScaleEnabled?this.layerScaleRangeVisibilityQuery||(this.layerScaleRangeVisibilityQuery=!0,e.queryVisibleScaleRange(this.extent,this.layer.minScale,this.layer.maxScale,(e=>this.finishUpdate(e)))):this.finishUpdate(!0)}finishUpdate(e){this.layerScaleRangeVisibilityQuery=!1,this._set("suspended",!e),this._set("updating",!1)}visibleAtLayerScale(e){return!this.layerScaleEnabled||c(e,this.layer.minScale||0,this.layer.maxScale||0)}visibleAtLabelScale(e,i){return c(e,i.minScale||0,i.maxScale||0)}graphicScale(e){let t;if(i(e.centroid)?t=e.centroid:i(e.graphic.geometry)&&"point"===e.graphic.geometry.type&&(t=e.graphic.geometry),t){return this.layerView.view.basemapTerrain?this.layerView.view.basemapTerrain.getScale(t):1}return null}graphicVisible(e){if(!this.layerScaleEnabled)return!0;const i=this.graphicScale(e);return this.visibleAtLayerScale(i)}updateVisibility(e){if(this._scaleRangeActive){const i=this.graphicVisible(e);return e.setVisibilityFlag(1,i,0)}return!1}updateGraphicLabelScaleVisibility(e){if(!this._scaleRangeActive)return!1;if(!e.labelGraphics||0===e.labelGraphics.length)return!1;const i=this.graphicScale(e),t=this.updateLabelScaleVisibility(e,i);return t&&(this.layerView.view.deconflictor.setDirty(),this.layerView.view.labeler.setDirty()),t}updateLabelScaleVisibility(e,i){if(!e.labelGraphics||0===e.labelGraphics.length)return!1;const t=e.labelGraphics[0]._labelClass;if(t&&null!=t.minScale&&null!=t.maxScale){const s=this.visibleAtLabelScale(i,t);if(e.setVisibilityFlag(1,s,1))return!0}return!1}scaleUpdateHandler(e){if(this._setDirty(),this.layerView.suspended)return;const s=e.extent,a=e.scale,r=this.visibleAtLayerScale(a);let l=!1;this.queryGraphicUIDsInExtent(s,e.spatialReference,(e=>{const n=this.graphicsCore.getGraphics3DGraphicById(e);if(t(n))return;const c=n.centroid;i(c)&&(s[0]>c.x||s[1]>c.y||s[2]<c.x||s[3]<c.y)||(n.setVisibilityFlag(1,r,0)&&(l=!0),this.updateLabelScaleVisibility(n,a)&&(l=!0))})),l&&(this.layerView.view.deconflictor.setDirty(),this.layerView.view.labeler.setDirty())}layerMinMaxScaleChangeHandler(){this.updateScaleRangeActive()&&!this._scaleRangeActive?this.graphicsCore.modifyGraphics3DGraphicVisibilities((e=>e.clearVisibilityFlag(1))):this._scaleRangeActive&&this.graphicsCore.updateAllGraphicsVisibility(),this._setDirty()}};function p(e,i){return e>0||i>0}e([s({constructOnly:!0})],h.prototype,"layerScaleEnabled",void 0),e([s({readOnly:!0})],h.prototype,"suspended",void 0),e([s({readOnly:!0})],h.prototype,"updating",void 0),h=e([a("esri.views.3d.layers.graphics.Graphics3DScaleVisibility")],h);const o="terrain-events";var y=h;export default y;
