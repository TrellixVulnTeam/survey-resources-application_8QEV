/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{isSome as e}from"../../../../core/maybe.js";import{c as t}from"../../../../chunks/vec3f64.js";import{i,s as n}from"../../../../chunks/vec3.js";import{a as s}from"../../../../chunks/mat4f64.js";import{create as a,empty as r,expandWithVec3 as o,isPoint as h,center as l,offset as d}from"../../../../geometry/support/aaBoundingBox.js";import{Object3DStateID as c}from"../../webgl-engine/lib/Object3DStateID.js";import{demResolutionForBoundingBox as g}from"./graphicUtils.js";import{setContextFeature as m}from"./featureExpressionInfoUtils.js";class u{constructor(e,t,i,n){this.graphics3DSymbolLayer=e,this.instanceIndex=t,this.elevationAligner=i,this.elevationContext=n,this.type="lod-instance",this.alignedSampledElevation=0,this.isElevationSource=!1,this.needsElevationUpdates=!1}initialize(){}setVisibility(e){const t=this.lodRenderer.instanceData;e!==t.getVisible(this.instanceIndex)&&t.setVisible(this.instanceIndex,e)}destroy(){null!=this.instanceIndex&&(this.lodRenderer.instanceData.removeInstance(this.instanceIndex),this.graphics3DSymbolLayer.notifyDestroyGraphicLayer(this))}alignWithElevation(e,t,i){if(this.elevationAligner){m(this.elevationContext.featureExpressionInfoContext,i);const n=this.elevationAligner(this,this.elevationContext,e,t);null!=n&&(this.alignedSampledElevation=n)}}getBSRadius(){const e=this.lodRenderer;return e.baseBoundingSphere.radius*e.instanceData.getCombinedMaxScaleFactor(this.instanceIndex)}getCenterObjectSpace(e=t()){return this.lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,v),i(e,this.lodRenderer.baseBoundingSphere.center,v)}getBoundingBoxObjectSpace(e=a()){this.lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,v);const t=this.lodRenderer.baseBoundingBox;r(e);for(let s=0;s<8;++s)n(f,0==(1&s)?t[0]:t[3],0==(2&s)?t[1]:t[4],0==(4&s)?t[2]:t[5]),i(f,f,v),o(e,f);return e}computeAttachmentOrigin(e){this.lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,v),e.render.origin[0]+=v[12],e.render.origin[1]+=v[13],e.render.origin[2]+=v[14],e.render.num++}async getProjectedBoundingBox(t,n,s,a,o){const c=this.getBoundingBoxObjectSpace(o),m=b,u=h(c)?1:m.length;this.lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,v);for(let e=0;e<u;e++){const t=m[e];f[0]=c[t[0]],f[1]=c[t[1]],f[2]=c[t[2]],i(f,f,v),p[3*e+0]=f[0],p[3*e+1]=f[1],p[3*e+2]=f[2]}if(!t(p,0,u))return null;r(c);let S=null;this.calculateRelativeScreenBounds&&(S=this.calculateRelativeScreenBounds());for(let e=0;e<3*u;e+=3){for(let t=0;t<3;t++)c[t]=Math.min(c[t],p[e+t]),c[t+3]=Math.max(c[t+3],p[e+t]);S&&s.push({location:p.slice(e,e+3),screenSpaceBoundingRect:S})}if(n&&(l(c,x),"absolute-height"!==this.elevationContext.mode)){let t;const i=g(c,n);try{t=await n.service.queryElevation(x[0],x[1],a,i,"ground")}catch(I){}e(t)&&d(c,0,0,-this.alignedSampledElevation+t)}return c}addObjectState(e,t){if(0===e){const i=new c(e);this.addHighlightId(i),t.addExternal((e=>{this.removeHighlightId(e)}),i)}}removeObjectState(e){this.highlights&&this.highlights.forEach((t=>e.remove(t)))}addHighlightId(e){this.highlights=this.highlights||new Set,this.highlights.add(e),this.lodRenderer.instanceData.setHighlight(this.instanceIndex,!0)}removeHighlightId(e){this.highlights&&(this.highlights.delete(e),this.lodRenderer.instanceData.setHighlight(this.instanceIndex,this.highlights.size>0),0===this.highlights.size&&(this.highlights=null))}get lodRenderer(){return this.graphics3DSymbolLayer.lodRenderer}}const p=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],f=t(),x=t(),b=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],v=s();export default u;
