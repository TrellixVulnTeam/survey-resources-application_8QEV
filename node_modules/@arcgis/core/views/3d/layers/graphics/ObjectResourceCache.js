/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{isSome as e}from"../../../../core/maybe.js";import{timeoutHandle as t}from"../../../../core/handleUtils.js";import{isAborted as r,createAbortError as o,onAbort as s,createAbortController as i}from"../../../../core/promiseUtils.js";import a from"../../../../core/Handles.js";import{DefaultLoadingContext as n}from"../../glTF/DefaultLoadingContext.js";import{load as l}from"../../glTF/loader.js";import{load as c}from"./wosrLoader.js";class m{constructor(){this.gltfCache=new Map,this.wosrCache=new Map,this.evictHandles=new a}loadGLTF(e,t,r){const o=r?`gltfPBR:${e}`:`gltf:${e}`;return this.fromCache(this.gltfCache,o,(t=>l(new n(t.streamDataRequester),e,t,r)),t)}loadWOSR(e,t){const r=`wosr:${e}:${t.disableTextures}`;return this.fromCache(this.wosrCache,r,(t=>c(e,t)),t)}destroy(){this.evictHandles.destroy(),this.gltfCache.clear(),this.wosrCache.clear()}get size(){return this.wosrCache.size+this.gltfCache.size}fromCache(t,a,n,l){return new Promise(((c,m)=>{if(r(l))return void m(o());const h=s(l,(()=>{this.remove(t,a),m(o())})),f=t.get(a);if(f)return this.evictHandles.remove(a),f.refCount++,void f.item.then(c,m);const d=i(),C={...l,signal:d.signal},v={refCount:1,abortController:d,item:n(C).then((e=>(v.abortController=null,e.remove=()=>this.remove(t,a),e)))};t.set(a,v),v.item.then((t=>{e(h)&&h.remove(),c(t)}),(t=>{e(h)&&h.remove(),m(t)}))}))}remove(r,o){const s=r.get(o);s&&(s.refCount--,0===s.refCount&&this.evictHandles.add(t((()=>{r.delete(o),e(s.abortController)&&s.abortController.abort()}),f),o))}}const h=1e4;let f=h;const d={overrideEvictDelay:e=>(f=e,{remove(){f=h}})};export{m as ObjectResourceCache,d as test};
