/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import"../../../core/has.js";import{estimateSize as t,isArrayBuffer as i}from"../../../core/typedArrayUtil.js";import{unwrapOr as r,isSome as s,isNone as o,mapSome as n}from"../../../core/maybe.js";import a from"../../../core/Logger.js";import"../../../core/accessorSupport/ensureType.js";import{property as d}from"../../../core/accessorSupport/decorators/property.js";import{subclass as l}from"../../../core/accessorSupport/decorators/subclass.js";import"../../../core/urlUtils.js";import"../../../core/uuid.js";import"../../../portal/support/resourceExtension.js";import{createAbortController as h,eachAlways as u,isAbortError as p,eachAlwaysValues as c,throwIfAborted as _}from"../../../core/promiseUtils.js";import m from"../../../core/Collection.js";import g from"../../../layers/support/CodedValue.js";import f from"../../../layers/support/CodedValueDomain.js";import"../../../layers/support/domains.js";import{unpackFieldNames as y}from"../../../layers/support/fieldUtils.js";import{pt2px as b}from"../../../core/screenUtils.js";import{result as w,forEach as N}from"../../../core/asyncUtils.js";import{d as P}from"../../../chunks/vec3.js";import{getMetersPerVerticalUnitForSR as x}from"../../../core/unitUtils.js";import{containsPoint as v,create as C}from"../../../geometry/support/aaBoundingRect.js";import{projectBoundingRect as S}from"../../../geometry/projection.js";import{getMetersPerUnit as A}from"../../../symbols/support/unitConversionUtils.js";import I from"../../../layers/support/PromiseQueue.js";import{Task as k}from"../../support/Scheduler.js";import{create as V}from"../../../geometry/support/aaBoundingBox.js";import{extractSafeScaleBounds as R,scaleBoundsPredicate as L}from"../../support/layerViewUtils.js";import{makeDehydratedPoint as U}from"../../../layers/graphics/dehydratedFeatures.js";import{a as j}from"../../../chunks/vec3f32.js";import{plane as Q}from"../support/geometryUtils.js";import{projectToBoundingBox as D}from"../support/extentUtils.js";import{LayerView3D as F}from"./LayerView3D.js";import{updatingProgress as M}from"./support/layerViewUpdatingProperties.js";import W from"../../layers/LayerView.js";import{minimumDistancePlane as z}from"../support/orientedBoundingBox.js";import{checkPointCloudLayerValid as O,checkPointCloudLayerCompatibleWithView as E}from"./i3s/I3SUtil.js";import{PointCloudWorkerHandle as H}from"./PointCloudWorkerHandle.js";import{nodeDiff as B,sortFrontToBack as G,splitWorkEntries as q}from"./i3s/LoDUtil.js";import T from"./i3s/PagedNodeIndex.js";import{getSplatSizeAlgorithm as $,getFixedSizeAlgorithm as J,getRendererInfo as Y,getFilterInfo as K,rendererUsesFixedSizes as X,getAttributeInfo as Z}from"./i3s/PointCloudRendererUtil.js";import{getAttributeValues as ee,readGeometry as te,elevationFromPositions as ie}from"./i3s/PointCloudWorkerUtil.js";import{PointGraphic as re}from"./i3s/PointGraphic.js";import{PointRenderer as se}from"./i3s/PointRenderer.js";import{PopupSceneLayerView as oe}from"./support/PopupSceneLayerView.js";const ne=a.getLogger("esri.views.3d.layers.PointCloudLayerView3D"),ae=8,de=Q.create();let le=class extends(oe(F(W))){constructor(){super(...arguments),this.maximumPointCount=4e6,this.slicePlaneEnabled=!1,this._renderer=null,this._rendererAdded=!1,this._renderedNodes=new Set,this._nodeScales=new Map,this._updateViewNeeded=!0,this._lodFactor=1,this._maxLoggedBoxWarnings=5,this._pageMultiplier=1,this._nodeLoadEpoch=0,this._indexQueue=[],this._workQueue=new Array,this._idleQueue=new I,this._indexPagesLoading=new Map,this._loadingNodes=new Map,this._recalcWork=!0,this._layerIsVisible=!1,this._codedDomainPopulationPromise=null,this._codedDomainPopulationAbortController=null,this._totalWork=0,this._index=null,this._loadingInitNodePage=!1,this._nodeIdArray=[]}get pointScale(){const e=$(this.layer&&this.layer.renderer),t=1;return e&&null!=e.scaleFactor?e.scaleFactor:t}get useRealWorldSymbolSizes(){const e=J(this.layer&&this.layer.renderer),t=!1;return e&&null!=e.useRealWorldSymbolSizes?e.useRealWorldSymbolSizes:t}get pointSize(){const e=J(this.layer&&this.layer.renderer),t=0;return e&&null!=e.size?e.size:t}get inverseDensity(){const e=96;return this.layer&&this.layer.renderer?1*e/this.layer.renderer.pointsPerInch:5}get availableFields(){const e=Y(this.layer),t=new Set;e.primaryAttribute&&t.add(e.primaryAttribute.name),e.modulationAttribute&&t.add(e.primaryAttribute.name);const i=K(this.layer);if(i)for(const r of i)t.add(r.attributeInfo.name);if(this.layer.outFields)for(const r of y(this.layer.fields,this.layer.outFields))t.add(r);return Array.from(t)}get _clippingBox(){if(!this.view||!this.view.clippingArea)return null;const e=V(),t=this.view.renderSpatialReference;return D(this.view.clippingArea,e,t)?e:null}get _elevationOffset(){const e=this.layer&&this.layer.elevationInfo;if(e&&"absolute-height"===e.mode){const t=x(this.layer.spatialReference),i=A(e.unit);return r(e.offset,0)*i/t}return 0}initialize(){const e=this.view.resourceController,t=e.scheduler;this._worker=new H(t),this.addResolvingPromise(this._worker.promise),this._tmpPoint=U(0,0,0,this.layer.spatialReference),O(this.layer),E(this.layer,this.view),this._indexRequester=e.createStreamDataRequester(2),this._dataRequester=e.createStreamDataRequester(3),this._initRenderer();const i=this._initNodePages(),r=this.view.resourceController.memoryController;this._memCache=r.getMemCache(this.layer.uid),this.updatingHandles.add(this,"_clippingBox",(()=>this._setUpdateViewNeeded()),2),this.updatingHandles.add(this,"_elevationOffset",(()=>this._elevationOffsetChanged()),2),this.updatingHandles.add(this.layer,"renderer",(()=>this._rendererChanged()),2),this.updatingHandles.add(this.layer,"filters",(()=>this._reload()),2),this.updatingHandles.add(this.layer,"outFields",(()=>this._reload()),2),this.updatingHandles.add(this.layer,"scaleRangeId",(()=>this._setUpdateViewNeeded())),this.updatingHandles.add(this,"clippingArea",(()=>this._setUpdateViewNeeded()),2),this.updatingHandles.add(this.view.state,"contentCamera",(()=>this._setUpdateViewNeeded())),this.handles.add([this.view.basemapTerrain.on("scale-change",(e=>this._scaleUpdateHandler(e))),r.events.on("quality-changed",(()=>this._setUpdateViewNeeded()))]),this.addResolvingPromise(i),this.when((()=>{this.handles.add([t.registerTask(k.POINT_CLOUD_LAYER,(e=>this._process(e)),(()=>this._needsUpdate())),t.registerIdleStateCallbacks((()=>this._idleBegin()),(()=>this._idleEnd())),this.updatingHandles.add(this,"suspended",(e=>{e?this._clearNodeState():this._setUpdateViewNeeded()}),2)])}),(()=>{this.updatingHandles.removeAll(),this.handles.removeAll()}))}_setUpdateViewNeeded(){this._updateViewNeeded=!0,this._updateLoading()}destroy(){this.cancelLoading(),this._worker&&(this._worker.destroy(),this._worker=null),this._destroyRenderer(),this._memCache.destroy(),this._memCache=null,this._codedDomainPopulationAbortController&&(this._codedDomainPopulationAbortController.abort(),this._codedDomainPopulationAbortController=null),this._codedDomainPopulationPromise=null}_initRenderer(){this._renderer=new se({createGraphic:(e,t,i)=>this._createGraphic(e,t,i)}),this._renderer.layerUid=this.layer.uid,this.updatingHandles.add(this,"_clippingBox",(e=>this._renderer.clippingBox=e),2),this.updatingHandles.add(this,"suspended",(e=>this._setPointsVisible(!e)),2),this.updatingHandles.add(this,"pointScale",(e=>this._renderer.scaleFactor=e),2),this._renderer.minSizePx=Math.sqrt(2),this.updatingHandles.add(this,"useRealWorldSymbolSizes",(e=>this._renderer.useRealWorldSymbolSizes=e),2),this.updatingHandles.add(this,"pointSize",(e=>{const t=b(e);this._renderer.size=e,this._renderer.sizePx=t}),2),this.updatingHandles.add(this,"slicePlaneEnabled",(e=>this._renderer.slicePlane=e),2),this.updatingHandles.add(this,"inverseDensity",(()=>this._setUpdateViewNeeded()),2),this.updatingHandles.add(this,"maximumPointCount",(()=>this._setUpdateViewNeeded()),2),this.updatingHandles.add(this.view,"qualitySettings.sceneService.pointCloud.lodFactor",(e=>{this._lodFactor=e,this._setUpdateViewNeeded()}),2)}_destroyRenderer(){this._renderer.removeAll(),this._setPointsVisible(!1)}_createGraphic(e,t,i){const r=s(e.pointIdFilterMap)?e.pointIdFilterMap[t]:t,o=this.view.computeMapPointFromVec3d(i),n=this._createGraphicAttributes(e,r);return new re({pointCloudMetadata:{nodeId:e.id,pointIndexInNode:t,attributePointIndexInNode:r,epoch:this._nodeLoadEpoch},geometry:o,attributes:n,layer:this.layer,sourceLayer:this.layer})}_createGraphicAttributes(e,t){const i={};for(const r of e.attributes)this._encodeGraphicAttribute(r.attributeInfo,r.values,t,i);return i}_encodeGraphicAttribute(e,t,i,r){const s=e.storageInfo&&e.storageInfo.attributeValues,o=s?s.valuesPerElement:1;if(1===o)r[e.name]=t[i];else if("UInt8"===s.valueType&&o<=4){let s=0;const n=i*o;for(let e=n;e<n+o;e++)s=(s<<8)+t[e];r[e.name]=s}else r[e.name]=void 0}_setPointsVisible(e){e&&!this._rendererAdded?(this.view._stage.addRenderPlugin([4],this._renderer),this._rendererAdded=!0):!e&&this._rendererAdded&&(this.view._stage.removeRenderPlugin(this._renderer),this._rendererAdded=!1)}_rendererChanged(){this._renderer.useFixedSizes=X(this.layer.renderer),this._reload()}_reload(){this._clearNodeState(),this._memCache.clear(),this._setUpdateViewNeeded()}_elevationOffsetChanged(){this._clearNodeState(),this._memCache.clear(),this._initNodePages()}_scaleUpdateHandler(e){this.layer.minScale||this.layer.maxScale?S(e.extent,e.spatialReference,ue,this.layer.spatialReference)&&(this._nodeScales.forEach(((t,i)=>{if(!this._renderedNodes.has(i))return void this._nodeScales.delete(i);const r=this._index.getNode(i);v(ue,r.obb.center)&&this._nodeScales.set(i,e.scale)})),this._setUpdateViewNeeded()):this._nodeScales.clear()}displayNodes(e){this._workQueue=B([...this._renderedNodes],e,this._index),G(this._workQueue,this.view.state.contentCamera.viewForward,this._index),q(this._workQueue,ae,this._index),this._updateQueues(),this._totalWork=this._computeWork(),this._updateLoading(),this._layerIsVisible=e.length>0||this._loadingInitNodePage,this.notifyChange("suspended")}cancelLoading(){this._cancelNodeLoading(),this._cancelIndexLoading()}_cancelNodeLoading(){const e=new Array;this._loadingNodes.forEach((({abortController:t})=>e.push(t))),this._loadingNodes.clear();for(const t of e)t.abort();this._workQueue=[],this._idleQueue.cancelAll(),this._totalWork=this._computeWork(),this._updateLoading()}_updateQueues(){const e=new Set;this._workQueue.forEach((t=>t.load.forEach((t=>e.add(t)))));const t=new Array,i=new Map;this._loadingNodes.forEach(((r,s)=>{e.has(s)?i.set(s,r):t.push(r)})),this._loadingNodes=i;for(const{abortController:r}of t)r.abort();this._workQueue=this._workQueue.filter((e=>{for(const t of e.load)if(this._loadingNodes.has(t))return this._recalcWork=!0,!1;return!0})),this._totalWork=this._computeWork(),this._updateLoading()}_cancelIndexLoading(){this._indexQueue=[],this._indexPagesLoading.forEach((({abortController:e})=>e.abort())),this._indexPagesLoading.clear(),this._totalWork=this._computeWork(),this._updateLoading()}_clearNodeState(){this._nodeLoadEpoch++,this._renderedNodes.forEach((e=>this._removeFromRenderer(e))),this._cancelNodeLoading()}_idleBegin(){this._setUpdateViewNeeded()}_idleEnd(){this._setUpdateViewNeeded()}_needsUpdate(){return this.suspended?this._updateViewNeeded:this._updateViewNeeded||this._indexQueue.length>0||this._workQueue.length>0||this._idleQueue.length>0}_process(e){if(this.suspended){if(this._updateViewNeeded){this._updateViewNeeded=!1;const e=this._isRootNodeVisible();e!==this._layerIsVisible&&(this._layerIsVisible=e,this.notifyChange("suspended")),this._updateLoading()}}else{for(e.run((()=>this._updateWorkQueues()));this._indexQueue.length>0&&e.run((()=>this._processIndexQueue())););for(this._processWorkQueue(e);this._idleQueue.length>0&&e.run((()=>this._idleQueue.process())););}}_processIndexQueue(){const e=this._indexQueue.shift(),t=this._loadNodePage(e);return this._indexPagesLoading.set(e,t),t.promise.then((t=>{this._index.addPage(e,t,this._elevationOffset),this._setUpdateViewNeeded()})).then((()=>{this._indexPagesLoading.delete(e)}),(()=>{this._indexPagesLoading.delete(e)})),!0}_processWorkQueue(e){for(;!e.done;){const t=this._scheduleWorkEntry();if(o(t))return;this._processWorkEntry(t),e.madeProgress()}}_scheduleWorkEntry(){let e=this._workQueue.length;for(;e--;){const e=this._workQueue.shift();if(!e.remove.find((e=>!this._renderedNodes.has(e))))return e;this._workQueue.push(e)}return null}_processWorkEntry(e){if(0!==e.load.length)Promise.all(e.load.map((e=>{const t=h(),i=this._memCache.pop(e.toString());return s(i)?this._loadingNodes.set(e,{abortController:t,promise:Promise.resolve(i)}):this._loadingNodes.has(e)||this._loadingNodes.set(e,{abortController:t,promise:this.loadNode(e,t.signal)}),this._loadingNodes.get(e).promise}))).then((t=>{for(let i=0;i<e.load.length;i++)if(t[i]){const r=this._setupRendererData(e.load[i],t[i]);this._addToRenderer(r)}for(const i of e.remove)this._removeFromRenderer(i)})).catch((()=>{})).then((()=>{for(const t of e.load)this._loadingNodes.delete(t);this._updateLoading(),this._recalcWork&&0===this._idleQueue.length&&0===this._indexQueue.length&&0===this._loadingNodes.size&&(this._recalcWork=!1,this._setUpdateViewNeeded())})),this._updateLoading();else for(const t of e.remove)this._removeFromRenderer(t)}async populateClassCodeCodedDomain(e,t){const i="CLASS_CODE",r=this.layer.fieldsIndex.get(i);if(!r||r.domain)return;if(-1===e.indexOf(r.name))return;const s=await w(this.layer.queryCachedStatistics(i,{signal:t}));if(!1===s.ok)return;const o=s.value,n=o&&o.labels&&o.labels.labels;n&&Array.isArray(n)&&(r.domain=new f({name:"CLASS_CODE",codedValues:n.map((e=>new g({code:e.value,name:e.label})))}))}async prepareFetchPopupFeatures(e){return this._codedDomainPopulationPromise||(this._codedDomainPopulationAbortController=h(),this._codedDomainPopulationPromise=this.populateClassCodeCodedDomain(e,this._codedDomainPopulationAbortController.signal).then((()=>{this._codedDomainPopulationAbortController=null}))),this._codedDomainPopulationPromise}async whenGraphicAttributes(e,t){const i=this._splitGraphicsPerNode(e),r=this.layer.attributeStorageInfo,s=t.map((e=>Z(r,e))),o=async(e,t)=>{const i=this._index.getNode(t);await N(s,(async t=>{const r=t.useElevation?await this._loadElevationAttributeFromGeometry(i.resourceId):await this._loadAndParseAttribute(i,t);if(r)for(const i of e)if(this._isValidPointGraphic(i)){const e=i.pointCloudMetadata.attributePointIndexInNode;this._encodeGraphicAttribute(t,r,e,i.attributes)}}))},n=[];return i.forEach(((e,t)=>{n.push(o(e,t))})),await u(n),e}_isValidPointGraphic(e){return e instanceof re&&e.pointCloudMetadata&&e.pointCloudMetadata.epoch===this._nodeLoadEpoch}_splitGraphicsPerNode(e){const t=new Map;for(const i of e){if(!this._isValidPointGraphic(i))continue;const e=i.pointCloudMetadata,r=t.get(e.nodeId);r?r.push(i):t.set(e.nodeId,[i])}return t}async _loadAndParseAttribute(e,t){const i=await this._loadAttribute(e.resourceId,t,null);return s(i)?ee({attributeInfo:t,buffer:i},null,e.vertexCount):null}async _loadElevationAttributeFromGeometry(e){const t=this.layer.store.defaultGeometrySchema,i=te(t,await this._loadGeometry(e,null));return ie(i,i.length/3)}highlight(e){if(!e)return{remove(){}};const t=m.isCollection(e)?e.toArray():Array.isArray(e)?e:[e];return this._renderer.highlight(t.map((e=>this._graphicToPointDefinition(e))))}_graphicToPointDefinition(e){if(!this._isValidPointGraphic(e))return null;const{nodeId:t,pointIndexInNode:i}=e.pointCloudMetadata;return null!=t&&null!=i?{nodeId:t,pointId:i}:null}_computeWork(){let e=0;for(const t of this._workQueue)e+=t.load.length+t.remove.length;return e+=this._loadingNodes.size,e+=(this._indexQueue.length+this._indexPagesLoading.size)*this._index.pageSize,e+=this._loadingInitNodePage?100:0,e+=this._updateViewNeeded?100:0,e}get updatingProgressValue(){if(this.suspended)return this._updateViewNeeded?0:1;const e=this._computeWork();return 1-Math.min(this._totalWork,e)/this._totalWork}_updateLoading(){this.notifyChange("updating"),this.notifyChange("updatingProgressValue")}canResume(){return super.canResume()&&this._layerIsVisible}isUpdating(){return this.suspended?this._updateViewNeeded:this._computeWork()>0}_initNodePages(){const e=this.layer.store.index,t=e.nodesPerPage||e.nodePerIndexBlock;return this._index=new T(this.layer.spatialReference,this.view.renderCoordsHelper.spatialReference,t),this._cancelIndexLoading(),this._traverseVisible=this._index.createVisibilityTraverse(),this._loadingInitNodePage=!0,this._layerIsVisible=!0,this.notifyChange("suspended"),this._updateLoading(),this._pageMultiplier=null!=e.nodesPerPage?1:e.nodePerIndexBlock,this._loadNodePage(0).promise.then((e=>{this._index.addPage(0,e,this._elevationOffset),this._loadingInitNodePage=!1,this._setUpdateViewNeeded()}))}_loadNodePage(e){const t=h(),i=`${this.baseUrl}/nodepages/${e*this._pageMultiplier}`;return{promise:this._requestNodePage(i,t.signal).then((t=>t.nodes.map(((t,i)=>({resourceId:null!=t.resourceId?t.resourceId:e*this._index.pageSize+i,obb:t.obb,firstChild:t.firstChild,childCount:t.childCount,vertexCount:null!=t.vertexCount?t.vertexCount:t.pointCount,lodThreshold:null!=t.lodThreshold?t.lodThreshold:t.effectiveArea}))))),abortController:t}}_updateWorkQueues(){if(!this._updateViewNeeded)return!1;let e=this.inverseDensity/this._lodFactor*this._getLodMemoryFactor();const t=this.maximumPointCount*this._lodFactor*this._getLodMemoryFactor();let i=this._computeNodesForMinimumDensity(e),r=this._computePointCount(i),s=Math.sqrt(r/(.75*t));for(;r>t;)e*=s,i=this._computeNodesForMinimumDensity(e),r=this._computePointCount(i),s=Math.sqrt(2);return this.displayNodes(i),this._updateViewNeeded=!1,this._updateLoading(),!0}_computePointCount(e){let t=0;for(let i=0;i<e.length;i++){const r=this._index.getNode(e[i]);r&&(t+=r.vertexCount)}return t}_getLodMemoryFactor(){return this.view.resourceController.memoryController.memoryFactor}_isRootNodeVisible(){let e=!1;return this._traverseVisible({frustum:this.view.state.contentCamera.frustum,clippingBox:this._clippingBox},{predicate:(t,i,r)=>(e=r,!1),pageMiss:()=>{}}),e}_computeNodesForMinimumDensity(e){const t=this.view.state.contentCamera,i=t.frustum,r=this._clippingBox,s=t.viewForward,o=P(s,t.eye),n=Q.fromNormalAndOffset(s,-o,de),a=t.perScreenPixelRatio/2,d=e*e,l=this._nodeIdArray;l.length=0;const{minScale:h,maxScale:u}=R(this.layer),p=0===h&&0===u?e=>l.push(e):e=>{const t=this._getScale(e);L(t,h,u)&&l.push(e)};return this._traverseVisible({frustum:i,clippingBox:r},{predicate:(e,t,i)=>{if(!i)return!1;if(0===t.childCount)return p(e),!1;const r=this._index.getRenderObb(e);return!(this._computeAveragePixelArea(r,t.lodThreshold,t.vertexCount,n,a)<=d)||(p(e),!1)},pageMiss:(e,t)=>{p(e),this._indexQueue.indexOf(t)<0&&this._indexQueue.push(t)}}),l}_getScale(e){let t=this._nodeScales.get(e);if(null==t){const i=this._index.getNode(e).obb.center;this._tmpPoint.x=i[0],this._tmpPoint.y=i[1],this._tmpPoint.z=i[2],t=this.view.basemapTerrain.getScale(this._tmpPoint),this._nodeScales.set(e,t)}return t}_computeAveragePixelArea(e,t,i,r,s){const o=1e-7,n=Math.max(o,z(e,r));return t/(n*n)/(4*s*s)/i}loadNode(e,t){try{return this.loadNodeAsync(e,t)}catch(i){throw p(i)||ne.error(i),i}}async loadAdditionalUserAttributes(e,t,i){const r=this.layer.outFields;if(!r)return[];const o=y(this.layer.fields,r),a=new Set(e.map((e=>s(e)?e.name:null))),d=this.layer.attributeStorageInfo,l=[];for(const s of o){if(a.has(s))continue;const e=Z(d,s);e&&l.push(t(e))}const h=await c(l);return _(i),n(h,(e=>e))}async loadNodeAsync(e,t){const i=this._index.getNode(e),r=Y(this.layer),n=K(this.layer),a=i.resourceId,d=async e=>{if(o(e))return null;if(e.useElevation)return{attributeInfo:e,buffer:null};const i=await this._loadAttribute(a,e,t);return s(i)?{attributeInfo:e,buffer:i}:null};return this._idleQueue.push((async()=>{const i=this._loadGeometry(a,t),{primaryAttribute:s,modulationAttribute:o}=r,l=d(s),h=d(o),u=n.map((e=>e.attributeInfo)),p=u.map((e=>d(e))),c=this.loadAdditionalUserAttributes([s,o,...u],d,t),[m,g,f,y,b]=await Promise.all([i,l,h,Promise.all(p),c]);_(t);const w={geometryBuffer:m,primaryAttributeData:g,modulationAttributeData:f,filterAttributesData:y,userAttributesData:b,schema:this.layer.store.defaultGeometrySchema,rendererInfo:r,filterInfo:n,obb:this._index.getRenderObb(e),elevationOffset:this._elevationOffset,inSR:this.layer.spatialReference.toJSON(),outSR:this.view.renderCoordsHelper.spatialReference.toJSON()};return this._worker.invoke(w,t)}),t)}async _loadGeometry(e,t){return this._requestData(`${this.baseUrl}/nodes/${e}/geometries/0`,t)}async _loadAttribute(e,t,i){if(o(t)||!t.storageInfo)return null;const r=t.storageInfo.key;return this._requestData(`${this.baseUrl}/nodes/${e}/attributes/${r}`,i)}_requestNodePage(e,t){return this._indexRequester.request(e,"json",{query:{f:"json"},signal:t})}_requestData(e,t){return this._dataRequester.request(e,"binary",{signal:t})}_removeFromRenderer(e){if(this._renderedNodes.has(e)){const t=this._renderer.removeNode(e);this._renderedNodes.delete(e),this._nodeScales.delete(e),this._memCache.put(t.id.toString(),t,he(t))}}_addToRenderer(e){this._renderedNodes.has(e.id)||(this._renderedNodes.add(e.id),this._renderer.addNode(e))}_setupRendererData(e,t){const i=this._index.getNode(e),r=Math.sqrt(i.lodThreshold/i.vertexCount),s=this._index.getRenderObb(e);if(se.isInstanceOfNode(t))return t.splatSize=r,t.obb=s,t.origin=j(t.obb.center),t;const o=1.001;if(t.obb.halfSize[0]>s.halfSize[0]*o||t.obb.halfSize[1]>s.halfSize[1]*o||t.obb.halfSize[2]>s.halfSize[2]*o){if(this._maxLoggedBoxWarnings>0){const i=e=>`[${e.halfSize[0]}, ${e.halfSize[1]}, ${e.halfSize[2]}]`;ne.warn(`Node ${e} reported bounding box too small. got ${i(s)} but points cover ${i(t.obb)}`),0==--this._maxLoggedBoxWarnings&&ne.warn("  Too many bounding box errors, stopping reporting for this layer.")}this._index.setRenderObb(e,t.obb)}return{id:e,coordinates:t.points,origin:j(s.center),rgb:t.rgb,attributes:t.attributes,pointIdFilterMap:t.pointIdFilterMap,highlights:null,splatSize:r,obb:s,isLeaf:0===i.childCount}}getUsedMemory(){let e=0;return this._renderer.forEachNode((r=>{e+=pe,e+=t(r.coordinates);for(const s of r.attributes){const r=s.values;i(r.buffer)&&(e+=t(r))}})),e}getUnloadedMemory(){const e=this._renderedNodes.size;if(e<4)return 0;const t=[...this._renderedNodes].reduce(((e,t)=>e+this._index.getNode(t).vertexCount));let i=this._loadingNodes.size;for(let r=0;r<this._workQueue.length;r++)i+=this._workQueue[r].load.length,i-=this._workQueue[r].remove.length;if(i<0)return 0;return i*t/e*((this.getUsedMemory()-e*pe)/t)+i*pe}ignoresMemoryFactor(){return!1}get performanceInfo(){return{nodes:this._renderedNodes.size,displayedNumberOfFeatures:[...this._renderedNodes].reduce(((e,t)=>e+this._index.getNode(t).vertexCount),0),maximumNumberOfFeatures:this.maximumPointCount,totalNumberOfFeatures:-1,core:null,"Loading Nodes":this._loadingNodes.size,"Index Queue":this._indexQueue.length,"Work Queue":this._workQueue.length,"Idle Queue":this._idleQueue.length}}get test(){return{index:this._index,visibleNodes:this._renderedNodes}}};function he(e){return 5*e.coordinates.length+128}e([d()],le.prototype,"layer",void 0),e([d({readOnly:!0,aliasOf:"layer.parsedUrl.path"})],le.prototype,"baseUrl",void 0),e([d({readOnly:!0})],le.prototype,"pointScale",null),e([d({readOnly:!0})],le.prototype,"useRealWorldSymbolSizes",null),e([d({readOnly:!0})],le.prototype,"pointSize",null),e([d({readOnly:!0})],le.prototype,"inverseDensity",null),e([d()],le.prototype,"maximumPointCount",void 0),e([d({readOnly:!0})],le.prototype,"availableFields",null),e([d({readOnly:!0})],le.prototype,"_clippingBox",null),e([d({readOnly:!0})],le.prototype,"_elevationOffset",null),e([d({type:Boolean})],le.prototype,"slicePlaneEnabled",void 0),e([d()],le.prototype,"updating",void 0),e([d(M)],le.prototype,"updatingProgress",void 0),e([d({readOnly:!0})],le.prototype,"updatingProgressValue",null),le=e([l("esri.views.3d.layers.PointCloudLayerView3D")],le);const ue=C(),pe=160;var ce=le;export default ce;
