/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import e from"../../../core/Logger.js";import t from"../../../core/PooledArray.js";import{canProjectWithoutEngine as o,projectVectorToVector as r}from"../../../geometry/projection.js";import{WorkerHandle as s}from"../../../core/workers/WorkerHandle.js";const n=e.getLogger("esri.views.3d.layers.I3SMeshWorkerHandle");class i extends s{constructor(e){super("SceneLayerWorker","process",e,{hasInitialize:!0})}getTransferList(e){return[e.geometryBuffer]}setModifications(e,t,o){const r={context:e,modifications:f(t,o),isGeodetic:o.isGeographic};this.broadcast(r,"setModifications")}setLegacySchema(e,t){const o=JSON.stringify(t);this.broadcast({context:e,jsonSchema:o},"setLegacySchema")}destroyContext(e){return this.broadcast(e,"destroyContext")}}const c=new t({deallocator:null}),a=[0,0,0];function f(e,t){c.clear();for(const i of e){const e="clip"===i.type?2:"mask"===i.type?1:0,s=i.geometry;let f=e=>e;if(s.spatialReference){if(!o(s.spatialReference,t)){n.warn("Can't project modification polygon into layer spatial reference, ignoring modification");continue}f=e=>(r(e,s.spatialReference,a,t),a)}else s.hasZ||(a[2]=0,f=e=>(a[0]=e[0],a[1]=e[1],a));c.push(e),c.push(s.rings.length);for(const t of s.rings){c.push(t.length);for(const e of t){const t=f(e);c.push(t[0]),c.push(t[1]),c.push(t[2])}}}c.push(3);const s=new Float64Array(c.length);for(let o=0;o<c.length;++o)s[o]=c.getItemAt(o);return s}export{i as I3SMeshWorkerHandle,f as toWasmModification};
