/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import"../../../../core/has.js";import{isNone as t,isSome as r}from"../../../../core/maybe.js";import s from"../../../../core/Logger.js";import"../../../../core/accessorSupport/ensureType.js";import{property as i}from"../../../../core/accessorSupport/decorators/property.js";import{subclass as n}from"../../../../core/accessorSupport/decorators/subclass.js";import"../../../../core/urlUtils.js";import"../../../../core/uuid.js";import"../../../../portal/support/resourceExtension.js";import{indexOf as o,PositionHint as a}from"../../../../core/arrayUtils.js";import c from"../../../../core/Accessor.js";import l from"../../../../geometry/SpatialReference.js";import{canProject as p,project as u}from"../../../../geometry/support/webMercatorUtils.js";import"../../../../geometry.js";import{t as f,b as d,s as g}from"../../../../chunks/vec3.js";import{whenOnce as h}from"../../../../core/watchUtils.js";import{getUnitString as y}from"../../../../core/unitUtils.js";import{fromValues as m,expandWithNestedArray as j,expand as b}from"../../../../geometry/support/aaBoundingRect.js";import{projectBoundingSphere as S,load as R,project as w,projectVectorToVector as E}from"../../../../geometry/projection.js";import{WhereClause as F}from"../../../../core/sql/WhereClause.js";import{create as x}from"../../../../geometry/support/aaBoundingBox.js";import I from"../../../layers/support/FeatureFilter.js";import{objectIdFilter as M,filterInPlace as _}from"./I3SUtil.js";const v=s.getLogger("esri.views.3d.layers.i3s.I3SMeshViewFilter");let O,k=class extends c{constructor(e){super(e),this._projectionEngineLoaded=!1}initialize(){h(this,"filter.geometry").then((()=>this.loadAsyncModule(W().then((e=>{this.destroyed||(this._geometryEngine=e,this.applyFilters())})))))}get sortedObjectIds(){if(t(this.filter.objectIds))return null;const e=new Float64Array(this.filter.objectIds);return e.sort(),e}get parsedWhereClause(){const e=r(this.filter)?this.filter.where:null;if(t(e)||!e)return null;try{return F.create(e,this.layerFieldsIndex)}catch(s){v.error(`Failed to parse filter where clause: ${s}`)}return null}addFilters(e,t,s,i){const n=this.sortedObjectIds;r(n)&&e.push((e=>M(n,!0,e))),this.addSqlFilter(e,this.parsedWhereClause);const o=this.parsedGeometry;if(r(o)){const r=this.spatialRelationship;e.push(((e,n)=>T(e,n,i,t,s,o,r)))}}isMBSGeoemtryVisible(e,t,s){const i=this.parsedGeometry;if(r(i)){const r=this.spatialRelationship,n=i[0].spatialReference||t;if(!S(e,s,V,n))return v.warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter for MBS"),!0;return A(V,i,n,r)}return!0}get parsedGeometry(){if(t(this.filter))return null;if(!this._geometryEngine)return null;const{geometry:e}=this.filter;if(t(e))return null;const{distance:r,units:s}=this.filter,i=this.spatialRelationship,n="mesh"===e.type?e.extent:e;if(t(r)||0===r)return C(n,i);const o=s||y(n.spatialReference);if(n.spatialReference.isWGS84){return C(this._geometryEngine.geodesicBuffer(n,r,o),i)}if(p(n,l.WGS84)){return C(u(this._geometryEngine.geodesicBuffer(u(n,l.WGS84),r,o),n.spatialReference),i)}if(!this._projectionEngineLoaded&&(this.loadAsyncModule(R().then((()=>this._projectionEngineLoaded=!0))),!this._projectionEngineLoaded))return null;let a=null;try{a=w(n,l.WGS84)}catch(c){}if(a)try{a=w(this._geometryEngine.geodesicBuffer(a,r,o),n.spatialReference)}catch(c){a=null}return a||v.error(`Filter by geodesic buffer (distance) unsupported, failed to project input geometry (${n.spatialReference.wkid}) to WGS84.`),C(a,i)}get spatialRelationship(){return r(this.filter)?this.filter.spatialRelationship:"intersects"}static checkSupport(e){return e.timeExtent?(v.warn("Filters with a timeExtent are not supported for mesh scene layers"),!1):!!L(e.spatialRelationship)||(v.warn(`Filters with spatialRelationship other than ${B.join(", ")} are not supported for mesh scene layers`),!1)}};function G(){return!!O}async function W(){return G()||(O=await import("../../../../geometry/geometryEngine.js")),O}e([i({type:I})],k.prototype,"filter",void 0),e([i()],k.prototype,"layerFieldsIndex",void 0),e([i()],k.prototype,"loadAsyncModule",void 0),e([i()],k.prototype,"applyFilters",void 0),e([i()],k.prototype,"addSqlFilter",void 0),e([i({readOnly:!0})],k.prototype,"sortedObjectIds",null),e([i({readOnly:!0})],k.prototype,"parsedWhereClause",null),e([i({readOnly:!0})],k.prototype,"parsedGeometry",null),e([i({readOnly:!0})],k.prototype,"spatialRelationship",null),e([i()],k.prototype,"_projectionEngineLoaded",void 0),e([i()],k.prototype,"_geometryEngine",void 0),k=e([n("esri.views.3d.layers.i3s.I3SMeshViewFilter")],k);const B=(e=>e)(["contains","intersects","disjoint"]);function L(e){return null!=e&&B.indexOf(e)>=0}function C(e,t){if(!e)return null;if("disjoint"===t&&"polygon"===e.type){const t=new Array(e.rings.length);for(let i=0;i<e.rings.length;++i){const r=m(1/0,1/0,-1/0,-1/0);j(r,e.rings[i]),t[i]={type:"polygon",rings:[e.rings[i]],spatialReference:e.spatialReference,aabr:r}}t.sort(((e,t)=>e.aabr[0]-t.aabr[0]));const r=new Set,s=new a;for(let e=0;e<t.length;++e){const i=t[e];for(let s=e+1;s<t.length;++s){const e=t[s];if(e.aabr[0]>=i.aabr[2])break;r.add(e)}r.forEach((e=>{if(i!==e)if(e.aabr[2]<=i.aabr[0])r.delete(e);else if(O.intersects(i,e)){i.rings=i.rings.concat(e.rings),b(i.aabr,e.aabr),delete i._geVersion,r.delete(e);const n=o(t,e,t.length,s);t.splice(n,1)}})),r.add(i)}for(const e of t)delete e.aabr;return t}return[e]}function A(e,t,r,s){const i=q(e,r);return t.every((e=>1!==Z(e,i,s)))}function T(e,t,r,s,i,n,o){const a=n[0].spatialReference||s.spatialReference;if(!S(t.node.mbs,i,V,a))return void v.warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter");const c=q(V,a),l=U(o,s,a,r,t.objectHandle);for(const p of n){if(0===e.length)return;switch(Z(p,c,o)){case 1:return void(e.length=0);case 0:continue}_(e,t.featureIds,(e=>P(p,e,l)))}}const V=[0,0,0,0];function U(e,t,r,s,i){const n=t.renderSpatialReference,o=new Map,a={rings:[[[0,0,0],[0,0,0],[0,0,0],[0,0,0]]],hasZ:!1,hasM:!1,type:"polygon",spatialReference:r};a.rings[0][3]=a.rings[0][0];const c={indices:null,data:null,stride:0,startIndex:0,endIndex:0};let l,p;switch(e){case"intersects":l=(e,t)=>O.intersects(e,t)?0:2,p=$;break;case"contains":l=(e,t)=>O.contains(e,t)?2:1,p=$;break;case"disjoint":default:l=(e,t)=>O.disjoint(e,t)?2:1,p=z}return{collection:s,object:i,type:e,maskSR:r,renderSR:n,aabbCache:o,triangle:a,positions:c,triangleTest:l,geometryTest:p}}function q(e,t){const r={x:e[0],y:e[1],hasZ:!1,hasM:!1,type:"point",spatialReference:t},s=!t.isWGS84&&!t.isWebMercator?O.buffer(r,e[3],1):O.geodesicBuffer(r,e[3],1);return s.type="polygon",s}function Z(e,t,r){switch(r){case"intersects":case"contains":return $(e,t);case"disjoint":return z(e,t)}}function $(e,t){return O.intersects(e,t)?O.contains(e,t)?0:2:1}function z(e,t){return O.intersects(e,t)?O.contains(e,t)?1:2:0}const H=2**-32;function P(e,t,r){const{collection:s,object:i,renderSR:n,maskSR:o,geometryTest:a,aabbCache:c}=r;let l=c.get(t);if(!l){const e=s.getObjectTransform(i);s.getComponentAabb(i,t,D);const r=[[D[0],D[1],0],[D[0],D[4],0],[D[3],D[4],0],[D[3],D[1],0]];for(let t=0;t<4;++t)f(r[t],r[t],e.rotationScale),d(r[t],r[t],e.position),E(r[t],n,r[t],o);l={rings:[r],hasZ:!1,hasM:!1,type:"polygon",spatialReference:o},l.rings[0][4]=l.rings[0][0],c.set(t,l)}switch(a(e,l)){case 1:return!1;case 0:return!0}const{triangle:p,triangleTest:u,positions:h}=r,y=p.rings[0][0],m=p.rings[0][1],j=p.rings[0][2],b=s.getObjectTransform(i);s.getComponentPositions(i,t,h);const{indices:S,data:R,stride:w,startIndex:F,endIndex:x}=h;for(let I=F;I<x;I+=3){const t=w*S[I+0],r=w*S[I+1],s=w*S[I+2];g(y,R[t+0],R[t+1],R[t+2]),g(m,R[r+0],R[r+1],R[r+2]),g(j,R[s+0],R[s+1],R[s+2]),f(y,y,b.rotationScale),f(m,m,b.rotationScale),f(j,j,b.rotationScale),d(y,y,b.position),d(m,m,b.position),d(j,j,b.position),E(y,n,y,o),E(m,n,m,o),E(j,n,j,o);const i=m[0]-y[0],a=m[1]-y[1],c=j[0]-y[0],l=j[1]-y[1];if(!(Math.abs(i*l-a*c)<H))switch(delete p._geVersion,u(e,p)){case 1:return!1;case 0:return!0}}switch(r.type){case"intersects":return!1;case"contains":case"disjoint":default:return!0}}const D=x();export{k as I3SMeshViewFilter};
