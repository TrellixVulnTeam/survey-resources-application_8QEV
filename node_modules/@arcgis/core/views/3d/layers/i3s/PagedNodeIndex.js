/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{create as e,contains as t,intersects as s}from"../../../../geometry/support/aaBoundingBox.js";import{set as n,toAaBoundingBox as i,intersectPlane as r,ObbArray as o}from"../../support/orientedBoundingBox.js";import{transformObb as p}from"./I3SUtil.js";class h{constructor(e,t,s){this._pages=[],this.pageSize=0,this._nodeSR=null,this._renderSR=null,this._nodeSR=e,this._renderSR=t,this.pageSize=s}addPage(e,t,s=0){for(;this._pages.length<e;)this._pages.push(null);const n=a(t,this._nodeSR,this._renderSR,s);this._pages[e]={nodes:t,renderObbs:n,parents:new Uint32Array(this.pageSize)},u(this._pages,this.pageSize)}hasPage(e){return!!this._pages[e]}getNode(e){const t=this.pageSize;return this._pages[l(e,t)].nodes[c(e,t)]}getRenderObb(e){const t=this.pageSize;return this._pages[l(e,t)].renderObbs[c(e,t)]}getRenderCenter(e){return this.getRenderObb(e).center}setRenderObb(e,t){const s=this.pageSize;n(t,this._pages[l(e,s)].renderObbs[c(e,s)])}getParentId(e){const t=this.pageSize;return this._pages[l(e,t)].parents[c(e,t)]}hasNodes(e,t){const s=l(e,this.pageSize),n=l(e+t-1,this.pageSize);for(let i=s;i<=n;i++)if(null==this._pages[i])return!1;return!0}forEachNodeId(e){for(let t=0;t<this._pages.length;t++){const s=this._pages[t];if(s)for(let n=0;n<s.nodes.length;n++)e(t*this.pageSize+n)}}createVisibilityTraverse(){const t={index:this,queue:[],masks:[],tempAabb:e()};return(e,s)=>g(t,e,s)}}function g(e,n,o){const p=e.index;if(!p.hasNodes(0,1))return;const h=e.queue;h.length=0,h.push(0);const g=e.masks;for(g.length=0,g.push(0);h.length>0;){const a=h.pop();let u=g.pop();const c=p.getNode(a),d=p.getRenderObb(a);let f=!0;if(null!=n.clippingBox){const r=1<<n.frustum.length;if(0==(u&r)){const o=i(d,e.tempAabb);t(n.clippingBox,o)?u|=r:s(n.clippingBox,o)||(f=!1)}}for(let e=0;e<n.frustum.length&&f;e++){const t=1<<e;if(0==(u&t)){const s=r(d,n.frustum[e]);s>0?f=!1:s<0&&(u|=t)}}if(o.predicate(a,c,f)){const e=c.firstChild,t=c.childCount;let s=!1;const n=l(e,p.pageSize),i=l(e+t-1,p.pageSize);for(let r=n;r<=i;r++)if(!p.hasPage(r)){o.pageMiss(a,r),s=!0;break}if(!s)for(let r=0;r<t;r++)h.push(e+r),g.push(u)}}}function a(e,t,s,n){const i=new o(e.length);for(let r=0;r<e.length;r++)p(e[r].obb,t,i.obbs[r],s,n);return i.obbs}function u(e,t){const s=[0];for(;s.length;){const n=s.pop(),i=e[l(n,t)].nodes[c(n,t)];for(let r=0;r<i.childCount;r++){const o=i.firstChild+r;null!=e[l(o,t)]&&(e[l(o,t)].parents[c(o,t)]=n,s.push(o))}}}function l(e,t){return e/t|0}function c(e,t){return e%t}export default h;
