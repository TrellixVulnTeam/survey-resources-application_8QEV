/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{isNone as e,unwrap as i,disposeMaybe as t,isSome as s}from"../../../../core/maybe.js";import n from"../../../../core/PooledArray.js";import{c as r}from"../../../../chunks/vec3f64.js";import{f as o,l as h,a,p as l,d as c,o as d,s as u}from"../../../../chunks/vec3.js";import{i as m,t as p,m as g}from"../../../../chunks/mat4.js";import{I as f}from"../../../../chunks/mat4f64.js";import{s as _}from"../../../../chunks/vec4.js";import{create as x,POSITIVE_INFINITY as S,offset as z,contains as b,containsPoint as P,equals as w,set as R}from"../../../../geometry/support/aaBoundingBox.js";import{Default3D as y}from"../../webgl-engine/lib/DefaultVertexAttributeLocations.js";import{c as q}from"../../../../chunks/mat4f32.js";import{c as v}from"../../../../chunks/vec3f32.js";import{plane as M,ray as j}from"../../support/geometryUtils.js";import F from"../../../webgl/BufferObject.js";import H from"../../../webgl/VertexArrayObject.js";import{IntersectorResult as U}from"../../webgl-engine/lib/intersectorUtils.js";import{Slice as V}from"../../webgl-engine/core/shaderLibrary/Slice.glsl.js";import{OutputHighlight as A}from"../../webgl-engine/core/shaderLibrary/output/OutputHighlight.glsl.js";import{minimumDistancePlane as C,maximumDistancePlane as E,intersectLine as B,toAaBoundingBox as L}from"../../support/orientedBoundingBox.js";import{PointHighlights as O}from"./PointHighlights.js";import{PointRendererTechniqueConfiguration as I,PointRendererTechnique as N}from"../../webgl-engine/shaders/PointRendererTechnique.js";const k={positions:[{name:"position",count:3,type:5126,offset:0,stride:12,normalized:!1}],colors:[{name:"color",count:3,type:5121,offset:0,stride:3,normalized:!0}]};class T{constructor(e){this._params=e,this.type="Point",this.isGround=!1,this._bindParameters={inverseViewport:[0,0],highlightDepthTexture:null},this._highlights=new O({forEachNode:e=>this.forEachNode(e),addHighlight:(e,i,t)=>this.addHighlight(e,i,t),removeHighlight:(e,i)=>this.removeHighlight(e,i)}),this.canRender=!0,this.layerUid="",this._useFixedSizes=!1,this._scaleFactor=1,this._minSizePx=0,this._useRealWorldSymbolSizes=!1,this._size=0,this._sizePx=0,this._slicePlaneEnabled=!1,this._clipBox=x(S),this._techniqueConfig=new I,this.tempMatrix4=q(),this.tempVec3=v(),this.nodes=new n}get needsHighlight(){return this._highlights.hasHighlights}initializeRenderContext(e){this._context=e,this._techniqueRep=this._context.shaderTechniqueRep,e.requestRender()}uninitializeRenderContext(){}intersect(e,i,t,s){const n=r(),u=r(),m=r(),p=r(),g=M.create(),S=e.camera.perScreenPixelRatio/2,w=e.camera.near,R=this._getSizeParams();o(u,s,t);const y=1/h(u);a(u,u,y),l(m,u),_(g,u[0],u[1],u[2],-c(u,t));class q{constructor(){this.node=null,this.pointId=null,this.point=null,this.dist=null,this.normal=null,this.layerUid=""}}const v=new q,F=new q,H=[],V=x(),A=x(this._clipBox);z(A,-t[0],-t[1],-t[2],A),this.nodes.forAll((r=>{const h=r.splatSize*this._scaleFactor;let a=C(r.obb,g),l=E(r.obb,g);a-=G(h,a+w,R,S,r.isLeaf),l-=G(h,l+w,R,S,r.isLeaf);const f=l<0,_=null!=v.dist&&null!=F.dist&&v.dist<a*y&&F.dist>l*y;if(f||_)return;const x=D(h,l+w,R,S,r.isLeaf);if(!B(r.obb,t,u,x))return;const M=x*x;L(r.obb,V),z(V,-t[0],-t[1],-t[2],V);const j=!b(A,V);o(p,r.origin,t);const U=r.coordinates.length/3;for(let o=0;o<U;o++){if(n[0]=p[0]+r.coordinates[3*o],n[1]=p[1]+r.coordinates[3*o+1],n[2]=p[2]+r.coordinates[3*o+2],j&&!P(A,n))continue;const a=c(n,u),l=d(n)-a*a;if(l>M)continue;let g=a+w;const f=G(h,g,R,S,r.isLeaf);if(a-f<0)continue;g-=f;const _=D(h,g,R,S,r.isLeaf);if(l>_*_)continue;const x=(a-f)*y,z=e=>{e.point=$(r,o,e.point),e.dist=x,e.normal=m,e.node=r,e.pointId=o,e.layerUid=this.layerUid};if((null==v.dist||x<v.dist)&&(null==i||i(t,s,x))&&z(v),0!==e.options.store&&(null==F.dist||x>F.dist)&&(null==i||i(t,s,x))&&z(F),2===e.options.store&&(null==i||i(t,s,x))){const e=new q;z(e),H.push(e)}}}));const O=e=>{const{layerUid:i,node:t,pointId:s}=e;return{type:"external",point:e.point,metadata:{layerUid:i,createGraphic:()=>this._params.createGraphic(t,s,e.point)}}},I=(e,i)=>{const t=O(i),s=`${i.layerUid}/${i.node.id}/${i.pointId}`;e.set(t,s,i.dist,i.normal,f,void 0),e.intersector="PointRenderer"};if(null!=v.dist){const i=e.results.min;(null==i.dist||v.dist<i.dist)&&I(i,v)}if(null!=F.dist&&0!==e.options.store){const i=e.results.max;(null==i.dist||F.dist>i.dist)&&I(i,F)}if(2===e.options.store){const i=j.fromPoints(t,s);for(const t of H){const s=new U(i);I(s,t),e.results.all.push(s)}}}render(e){if(0!==e.pass&&2!==e.pass&&5!==e.pass)return!1;const i=2===e.pass,t=e.rctx;this.nodes.forAll((i=>{null==i.vao&&this._initNode(e,i)}));const s=this._getSizeParams(),n=this.selectTechnique(e,s),r=n.program;if(null==r||0===this.nodes.length)return!0;const o=this._clipBox,h=!w(o,S,((e,i)=>e===i));h||(u(this.tempVec3,-1/0,-1/0,-1/0),r.setUniform3fv("uClipMin",this.tempVec3),u(this.tempVec3,1/0,1/0,1/0),r.setUniform3fv("uClipMax",this.tempVec3)),t.bindProgram(r),n.bindPipelineState(t),r.setUniformMatrix4fv("uProjectionMatrix",e.camera.projectionMatrix),i&&r.setUniform2f("nearFar",e.camera.near,e.camera.far),e.isHighlightPass&&(this._bindParameters.inverseViewport[0]=1/e.camera.fullViewport[2],this._bindParameters.inverseViewport[1]=1/e.camera.fullViewport[3],this._bindParameters.highlightDepthTexture=e.highlightDepthTexture,A.bindOutputHighlight(t,r,this._bindParameters));const a=e.camera.pixelRatio;s.drawFixedSize&&r.setUniform2f("uPointScale",s.fixedSize*a,e.camera.fullHeight);const l=this._slicePlaneEnabled?e.sliceHelper&&e.sliceHelper.plane:null;return this.nodes.forAll((i=>{if(0===i.coordinates.length||e.isHighlightPass&&!i.highlights)return;if(r.setUniform2f("uScreenMinMaxSize",s.screenMinSize*a,W(i.isLeaf)*a),!s.drawFixedSize){const t=i.splatSize*this._scaleFactor;r.setUniform2f("uPointScale",t*a,e.camera.fullHeight/a)}const c=i.origin;h&&(u(this.tempVec3,o[0]-c[0],o[1]-c[1],o[2]-c[2]),r.setUniform3fv("uClipMin",this.tempVec3),u(this.tempVec3,o[3]-c[0],o[4]-c[1],o[5]-c[2]),r.setUniform3fv("uClipMax",this.tempVec3)),m(this.tempMatrix4),p(this.tempMatrix4,this.tempMatrix4,c),g(this.tempMatrix4,e.camera.viewMatrix,this.tempMatrix4),r.setUniformMatrix4fv("uModelViewMatrix",this.tempMatrix4),V.bindUniforms(r,n.configuration,l,c),t.bindVAO(i.vao),e.isHighlightPass?this._renderHighlightFragments(t,i):t.drawArrays(0,0,i.coordinates.length/3)})),!0}_renderHighlightFragments(t,s){const n=s.highlights;if(e(n))return;let r=i(n[0].component),o=r+1;for(let e=1;e<n.length;e++){const s=i(n[e].component);if(s!==o){const e=o-r;e>0&&t.drawArrays(0,r,e),r=s}o=s+1}const h=o-r;h>0&&t.drawArrays(0,r,h)}set useFixedSizes(e){this._useFixedSizes!==e&&(this._useFixedSizes=e,this._requestRender())}get useFixedSizes(){return this._useFixedSizes}set scaleFactor(e){this._scaleFactor!==e&&(this._scaleFactor=e,this._requestRender())}get scaleFactor(){return this._scaleFactor}set minSizePx(e){this._minSizePx!==e&&(this._minSizePx=e,this._requestRender())}get minSizePx(){return this._minSizePx}set useRealWorldSymbolSizes(e){this._useRealWorldSymbolSizes!==e&&(this._useRealWorldSymbolSizes=e,this._requestRender())}get useRealWorldSymbolSizes(){return this._useRealWorldSymbolSizes}set size(e){this._size!==e&&(this._size=e,this._requestRender())}get size(){return this._size}set sizePx(e){this._sizePx!==e&&(this._sizePx=e,this._requestRender())}get sizePx(){return this._sizePx}set clippingBox(e){R(this._clipBox,e||S)}get slicePlane(){return this._slicePlaneEnabled}set slicePlane(e){this._slicePlaneEnabled!==e&&(this._slicePlaneEnabled=e,this._requestRender())}get intersectionHandlerId(){return this.layerUid}addNode(e){this.nodes.push(e),this._highlights.nodeAdded(e),this._requestRender()}removeNode(e){let i=null;return this.nodes.filterInPlace((s=>s.id!==e||(i=s,s.vao=t(s.vao),this._highlights.nodeRemoved(s),!1))),this._requestRender(),i}forEachNode(e){this.nodes.forAll(e)}removeAll(){this.nodes.forAll((e=>e.vao=t(e.vao))),this._highlights.removeAll(),this.nodes.clear(),this._requestRender()}highlight(e){return this._highlights.add(e)}addHighlight(e,i,t){e.highlights=K(e.highlights,i,t),this._requestRender()}removeHighlight(e,i){e.highlights=Q(e.highlights,i),this._requestRender()}_initNode(e,i){const t=e.rctx;i.vao=new H(t,y,k,{positions:F.createVertex(t,35044,i.coordinates),colors:F.createVertex(t,35044,i.rgb)})}_requestRender(){this._context&&this._context.requestRender()}_getSizeParams(){const e=this._useFixedSizes,i=e&&!this._useRealWorldSymbolSizes,t=i?this._sizePx:this._size;let s=this._minSizePx;return e&&(s=0),{drawScreenSpace:i,drawFixedSize:e,fixedSize:t,screenMinSize:s}}selectTechnique(e,i){return this._techniqueConfig.drawScreenSize=i.drawScreenSpace,this._techniqueConfig.slicePlaneEnabled=this._slicePlaneEnabled,this._techniqueConfig.sceneHasOcludees=e.hasOccludees,this._techniqueConfig.output=2===e.pass?1:5===e.pass?4:0,this._techniqueRep.acquireAndReleaseExisting(N,this._techniqueConfig,this._technique)}}function W(e){return e?256:64}function D(e,i,t,s,n){if(t.drawScreenSpace)return t.fixedSize*i*s;const r=W(n)*i*s;return t.drawFixedSize?Math.min(t.fixedSize/2,r):t.screenMinSize>0?Math.min(Math.max(t.screenMinSize*i*s,e/2),r):Math.min(e/2,r)}function G(e,i,t,s,n){return t.drawScreenSpace?0:D(e,i,t,s,n)}function $(e,i,t){return null==t&&(t=r()),t[0]=e.origin[0]+e.coordinates[3*i],t[1]=e.origin[1]+e.coordinates[3*i+1],t[2]=e.origin[2]+e.coordinates[3*i+2],t}function J(e){return s(e.component)?e.component:-1}function K(i,t,s){e(i)&&(i=[]);const n={component:t,id:s};i.push(n);const r=J(n);let o=i.length-1;for(;o>0&&r<J(i[o-1]);)[i[o-1],i[o]]=[i[o],i[o-1]],--o;return i}function Q(i,t){if(e(i))return i;const s=i.filter((e=>e.id!==t));return 0===s.length?null:s}!function(e){function i(e){return e.hasOwnProperty("splatSize")}e.isInstanceOfNode=i}(T||(T={}));export{T as PointRenderer};
