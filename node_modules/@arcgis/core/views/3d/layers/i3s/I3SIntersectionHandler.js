/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{isSome as e}from"../../../../core/maybe.js";import{g as t}from"../../../../chunks/vec3.js";import{getVerticalOffsetI3S as i,IntersectorResult as r}from"../../webgl-engine/lib/intersectorUtils.js";import{intersectLine as s}from"../../support/orientedBoundingBox.js";class n{constructor(e){this.type="I3S",this.layerUid=e.layerUid,this.sublayerUid=e.sublayerUid,this.collection=e.collection,this.forEach=e.forEach,this.slicePlane=e.slicePlaneEnabled,this.isGround=e.isGround}intersect(n,l,d,a){const c=n.results,u=2===n.options.store,b=n.ray.direction,m=n.tolerance;let f=e=>e,h=e=>e;const y=i(n.verticalOffset);e(y)&&(f=e=>y.applyToMbs(e),h=e=>y.applyToObb(e)),this.forEach(((i,p)=>{if(e(i.geometryObb)){if(!s(h(i.geometryObb),d,b,m))return}else if(e(i.serviceObbInRenderSR)){if(!s(h(i.serviceObbInRenderSR),d,b,m))return}else if(!o(f(i.renderMbs),d,b,m))return;this.collection.intersect(p,d,a,m,y,((e,s,o,b)=>{if(s>=0){if(null!=l&&!l(d,a,s))return;const m=r=>{r.intersector=this.type,r.target={type:"external",metadata:{layerUid:this.layerUid,sublayerUid:this.sublayerUid,nodeIndex:i.index,componentIndex:e}},r.dist=s,t(r.normal,o),r.triangleNr=b};if(this.isGround&&(null==c.ground.dist||s<c.ground.dist)&&m(c.ground),n.options.isFiltered)return;if((null==c.min.dist||s<c.min.dist)&&m(c.min),(null==c.max.dist||s>c.max.dist)&&m(c.max),u){const e=new r(n.ray);m(e),n.results.all.push(e)}}}))}))}get intersectionHandlerId(){return this.layerUid}}function o(e,t,i,r=0){const s=e[3]+r,n=t[0]-e[0],o=t[1]-e[1],l=t[2]-e[2],d=i[0],a=i[1],c=i[2],u=d*n+a*o+c*l;return u*u-(d*d+a*a+c*c)*(n*n+o*o+l*l-s*s)>=0}export{n as I3SIntersectionHandler};
