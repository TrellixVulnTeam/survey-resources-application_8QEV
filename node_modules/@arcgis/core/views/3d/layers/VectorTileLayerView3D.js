/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import"../../../core/has.js";import{disposeMaybe as t,destroyMaybe as r}from"../../../core/maybe.js";import"../../../core/Logger.js";import"../../../core/accessorSupport/ensureType.js";import{property as i}from"../../../core/accessorSupport/decorators/property.js";import{subclass as l}from"../../../core/accessorSupport/decorators/subclass.js";import"../../../core/urlUtils.js";import"../../../core/uuid.js";import"../../../portal/support/resourceExtension.js";import{createAbortController as s,isAborted as o}from"../../../core/promiseUtils.js";import{whenTrueOnce as a}from"../../../core/watchUtils.js";import n from"../../2d/engine/vectorTiles/SchemaHelper.js";import h from"../../2d/engine/vectorTiles/style/StyleRepository.js";import{test as p}from"../terrain/terrainUtils.js";import{LayerView3D as c}from"./LayerView3D.js";import{TiledLayerView3D as m}from"./TiledLayerView3D.js";import d from"../../layers/LayerView.js";import y from"../../2d/engine/vectorTiles/TileHandler3D.js";import u from"../../2d/engine/vectorTiles/VTLPainter3D.js";let f=class extends(m(c(d))){constructor(e){super(e)}initialize(){const e=p.force512VTL?this.layer.tileInfo:this.layer.compatibleTileInfo256,t=this._getTileInfoSupportError(e,this.layer.fullExtent);if(t)return void this.addResolvingPromise(Promise.reject(t));const{basemapTerrain:r,spatialReference:i,pixelRatio:l}=this.view,c=a(this.view,"basemapTerrain.tilingSchemeLocked").then((()=>{const e=r.tilingScheme,t=e.pixelSize;let l;this.schemaHelper=new n(t,i.isGeographic),l=256===t?this.layer.compatibleTileInfo256:this.view.spatialReference.isGeographic?this.layer.compatibleTileInfo512:this.layer.tileInfo;const s=this._getTileInfoCompatibilityError(l,e);if(s)throw s;this._set("tileInfo",l)}));this._tileHandlerController=s();const{memoryController:m,scheduler:d}=this.view.resourceController;this._memCache=m.getMemCache(this.layer.uid,(e=>e.release()));const{style:f,spriteUrl:g,glyphsUrl:H}=this.layer.currentStyleInfo,v=new h(f,{spriteUrl:g,glyphsUrl:H}),j=r.mapTileRequester;this.tileHandler=new y(this.layer,v,l,this._memCache,j);const C=this._tileHandlerController.signal,_=this.tileHandler.start({signal:C,scheduler:d}),w=this.tileHandler.spriteMosaic;w.then((e=>{!o(C)&&this.tileHandler&&(this.painter=new u(e,this.tileHandler.glyphMosaic))})),_.then((()=>this._tileHandlerController=null));const T=()=>{this._tileHandlerController&&this._tileHandlerController.abort(),this._tileHandlerController=s(),this._memCache.clear();const{style:e,spriteUrl:t,glyphsUrl:r}=this.layer.currentStyleInfo,i=new h(e,{spriteUrl:t,glyphsUrl:r}),o=new y(this.layer,i,l,this._memCache,j),a=o.start({signal:this._tileHandlerController.signal,scheduler:d}),n=o.spriteMosaic;a.then((()=>this._tileHandlerController=null)),this.updatingHandles.addPromise(Promise.all([a,n]).then((([,e])=>{const t=this.tileHandler,r=this.painter;this.painter=new u(e,o.glyphMosaic),this.tileHandler=o,this.emit("data-changed"),t.destroy(),r&&r.dispose()})))};this.updatingHandles.add(this,"layer.currentStyleInfo",T),this.updatingHandles.add(this,"view.pixelRatio",T);const I=Promise.all([c,_,w]);this.addResolvingPromise(I)}destroy(){this.painter=t(this.painter),this._tileHandlerController&&(this._tileHandlerController.abort(),this._tileHandlerController=null),r(this.tileHandler),this._memCache=r(this._memCache),this.tileHandler=null}get dataLevelRange(){const e=this.tileInfo.lods,t=e[0].scale,r=e[e.length-1].scale,i=this.levelRangeFromScaleRange(t,r);return 1===i.minLevel&&256===this.tileInfo.size[0]&&(i.minLevel=0),i}};e([i({aliasOf:"layer.fullExtent"})],f.prototype,"fullExtent",void 0),e([i()],f.prototype,"layer",void 0),e([i()],f.prototype,"tileInfo",void 0),e([i()],f.prototype,"dataLevelRange",null),e([i()],f.prototype,"updatingProgressValue",void 0),f=e([l("esri.views.3d.layers.VectorTileLayerView3D")],f);var g=f;export default g;
