/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import{f as t}from"../../../../chunks/vec3f64.js";import{ReloadableShaderModule as i}from"../core/shaderTechnique/ReloadableShaderModule.js";import{ShaderTechnique as r}from"../core/shaderTechnique/ShaderTechnique.js";import{ShaderTechniqueConfiguration as o,parameter as s}from"../core/shaderTechnique/ShaderTechniqueConfiguration.js";import{Default3D as a}from"../lib/DefaultVertexAttributeLocations.js";import n from"../../../webgl/Program.js";import{makePipelineState as l,defaultDepthWriteParams as c,defaultColorWriteParams as p}from"../../../webgl/renderState.js";import{View as u}from"../core/shaderLibrary/util/View.glsl.js";import{colorMixModes as h,bindScreenSizePerspective as d}from"../materials/internal/MaterialUtil.js";import{Slice as m}from"../core/shaderLibrary/Slice.glsl.js";import{OutputHighlight as f}from"../core/shaderLibrary/output/OutputHighlight.glsl.js";import{VisualVariables as v}from"../core/shaderLibrary/shading/VisualVariables.glsl.js";import{VerticalOffset as g}from"../core/shaderLibrary/attributes/VerticalOffset.glsl.js";import{blendingDefault as b,OITBlending as y,OITDepthTest as x,getOITPolygonOffset as T}from"../lib/OrderIndependentTransparency.js";import{bindMultipassTerrainUniforms as P}from"../core/shaderLibrary/shading/MultipassTerrainTest.glsl.js";import{stencilWriteMaskOn as M,stencilToolMaskBaseParams as S,stencilBaseAllZerosParams as O}from"../lib/StencilUtils.js";import{ReadShadowMap as C}from"../core/shaderLibrary/shading/ReadShadowMap.glsl.js";import{doublePrecisionRequiresObfuscation as D}from"../core/shaderLibrary/util/DoublePrecision.glsl.js";import{InstancedDoublePrecision as w}from"../core/shaderLibrary/attributes/InstancedDoublePrecision.glsl.js";import{PhysicallyBasedRenderingParameters as j}from"../core/shaderLibrary/shading/PhysicallyBasedRenderingParameters.glsl.js";import{D as A}from"../../../../chunks/DefaultMaterial.glsl.js";class E extends r{initializeProgram(e){const t=E.shader.get(),i=this.configuration,r=t.build({OITEnabled:0===i.transparencyPassType,output:i.output,viewingMode:e.viewingMode,receiveShadows:i.receiveShadows,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:i.sliceHighlightDisabled,sliceEnabledForVertexPrograms:!1,symbolColor:i.symbolColors,vvSize:i.vvSize,vvColor:i.vvColor,vvInstancingEnabled:!0,instanced:i.instanced,instancedColor:i.instancedColor,instancedDoublePrecision:i.instancedDoublePrecision,useOldSceneLightInterface:!1,pbrMode:i.usePBR?i.isSchematic?2:1:0,hasMetalnessAndRoughnessTexture:i.hasMetalnessAndRoughnessTexture,hasEmissionTexture:i.hasEmissionTexture,hasOcclusionTexture:i.hasOcclusionTexture,hasNormalTexture:i.hasNormalTexture,hasColorTexture:i.hasColorTexture,receiveAmbientOcclusion:i.receiveAmbientOcclusion,useCustomDTRExponentForWater:!1,normalType:i.normalsTypeDerivate?3:0,doubleSidedMode:i.doubleSidedMode,vertexTangets:i.vertexTangents,attributeTextureCoordinates:i.hasMetalnessAndRoughnessTexture||i.hasEmissionTexture||i.hasOcclusionTexture||i.hasNormalTexture||i.hasColorTexture?1:0,textureAlphaPremultiplied:i.textureAlphaPremultiplied,attributeColor:i.vertexColors,screenSizePerspectiveEnabled:i.screenSizePerspective,verticalOffsetEnabled:i.verticalOffset,offsetBackfaces:i.offsetBackfaces,doublePrecisionRequiresObfuscation:D(e.rctx),alphaDiscardMode:i.alphaDiscardMode,supportsTextureAtlas:!1,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new n(e.rctx,r.generateSource("vertex"),r.generateSource("fragment"),a)}bindPass(e,t,i){u.bindProjectionMatrix(this.program,i.camera.projectionMatrix);const r=this.configuration.output;(1===this.configuration.output||i.multipassTerrainEnabled||3===r)&&this.program.setUniform2fv("cameraNearFar",i.camera.nearFar),i.multipassTerrainEnabled&&(this.program.setUniform2fv("inverseViewport",i.inverseViewport),P(this.program,e,i)),7===r&&(this.program.setUniform1f("opacity",t.opacity),this.program.setUniform1f("layerOpacity",t.layerOpacity),this.program.setUniform4fv("externalColor",t.externalColor),this.program.setUniform1i("colorMixMode",h[t.colorMixMode])),0===r?(i.lighting.setUniforms(this.program,!1),this.program.setUniform3fv("ambient",t.ambient),this.program.setUniform3fv("diffuse",t.diffuse),this.program.setUniform4fv("externalColor",t.externalColor),this.program.setUniform1i("colorMixMode",h[t.colorMixMode]),this.program.setUniform1f("opacity",t.opacity),this.program.setUniform1f("layerOpacity",t.layerOpacity),this.configuration.usePBR&&j.bindUniforms(this.program,t,this.configuration.isSchematic)):4===r&&f.bindOutputHighlight(e,this.program,i),v.bindUniformsForSymbols(this.program,t),g.bindUniforms(this.program,t,i),d(t.screenSizePerspective,this.program,"screenSizePerspectiveAlignment"),2!==t.textureAlphaMode&&3!==t.textureAlphaMode||this.program.setUniform1f("textureAlphaCutoff",t.textureAlphaCutoff)}bindDraw(e){const i=this.configuration.instancedDoublePrecision?t(e.camera.viewInverseTransposeMatrix[3],e.camera.viewInverseTransposeMatrix[7],e.camera.viewInverseTransposeMatrix[11]):e.origin;u.bindViewCustomOrigin(this.program,i,e.camera.viewMatrix),(0===this.configuration.output||7===this.configuration.output||1===this.configuration.output&&this.configuration.screenSizePerspective||2===this.configuration.output&&this.configuration.screenSizePerspective||4===this.configuration.output&&this.configuration.screenSizePerspective)&&u.bindCamPosition(this.program,i,e.camera.viewInverseTransposeMatrix),2===this.configuration.output&&this.program.setUniformMatrix4fv("viewNormal",e.camera.viewInverseTransposeMatrix),this.configuration.instancedDoublePrecision&&w.bindCustomOrigin(this.program,i),m.bindUniforms(this.program,this.configuration,e.slicePlane,i),0===this.configuration.output&&C.bindViewCustomOrigin(this.program,e,i)}setPipeline(e,t){const i=this.configuration,r=3===e,o=2===e;return l({blending:0!==i.output&&7!==i.output||!i.transparent?null:r?b:y(e),culling:z(i),depthTest:{func:x(e)},depthWrite:r||o?i.writeDepth&&c:null,colorWrite:p,stencilWrite:i.sceneHasOcludees?M:null,stencilTest:i.sceneHasOcludees?t?S:O:null,polygonOffset:r||o?null:T(i.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this.setPipeline(this.configuration.transparencyPassType,!0),this.setPipeline(this.configuration.transparencyPassType,!1)}getPipelineState(e){return e?this._occludeePipelineState:this.pipeline}}function U(e){return e.cullFace?0!==e.cullFace:!e.slicePlaneEnabled&&(!e.transparent&&!e.doubleSidedMode)}E.shader=new i(A,(()=>import("./DefaultMaterial.glsl.js")));const z=e=>U(e)&&{face:1===e.cullFace?1028:1029,mode:2305};class R extends o{constructor(){super(...arguments),this.output=0,this.alphaDiscardMode=1,this.doubleSidedMode=0,this.isSchematic=!1,this.vertexColors=!1,this.offsetBackfaces=!1,this.symbolColors=!1,this.vvSize=!1,this.vvColor=!1,this.verticalOffset=!1,this.receiveShadows=!1,this.slicePlaneEnabled=!1,this.sliceHighlightDisabled=!1,this.receiveAmbientOcclusion=!1,this.screenSizePerspective=!1,this.textureAlphaPremultiplied=!1,this.hasColorTexture=!1,this.usePBR=!1,this.hasMetalnessAndRoughnessTexture=!1,this.hasEmissionTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.instanced=!1,this.instancedColor=!1,this.instancedDoublePrecision=!1,this.vertexTangents=!1,this.normalsTypeDerivate=!1,this.writeDepth=!0,this.sceneHasOcludees=!1,this.transparent=!1,this.enableOffset=!0,this.cullFace=0,this.transparencyPassType=3,this.multipassTerrainEnabled=!1,this.cullAboveGround=!0}}e([s({count:8})],R.prototype,"output",void 0),e([s({count:4})],R.prototype,"alphaDiscardMode",void 0),e([s({count:3})],R.prototype,"doubleSidedMode",void 0),e([s()],R.prototype,"isSchematic",void 0),e([s()],R.prototype,"vertexColors",void 0),e([s()],R.prototype,"offsetBackfaces",void 0),e([s()],R.prototype,"symbolColors",void 0),e([s()],R.prototype,"vvSize",void 0),e([s()],R.prototype,"vvColor",void 0),e([s()],R.prototype,"verticalOffset",void 0),e([s()],R.prototype,"receiveShadows",void 0),e([s()],R.prototype,"slicePlaneEnabled",void 0),e([s()],R.prototype,"sliceHighlightDisabled",void 0),e([s()],R.prototype,"receiveAmbientOcclusion",void 0),e([s()],R.prototype,"screenSizePerspective",void 0),e([s()],R.prototype,"textureAlphaPremultiplied",void 0),e([s()],R.prototype,"hasColorTexture",void 0),e([s()],R.prototype,"usePBR",void 0),e([s()],R.prototype,"hasMetalnessAndRoughnessTexture",void 0),e([s()],R.prototype,"hasEmissionTexture",void 0),e([s()],R.prototype,"hasOcclusionTexture",void 0),e([s()],R.prototype,"hasNormalTexture",void 0),e([s()],R.prototype,"instanced",void 0),e([s()],R.prototype,"instancedColor",void 0),e([s()],R.prototype,"instancedDoublePrecision",void 0),e([s()],R.prototype,"vertexTangents",void 0),e([s()],R.prototype,"normalsTypeDerivate",void 0),e([s()],R.prototype,"writeDepth",void 0),e([s()],R.prototype,"sceneHasOcludees",void 0),e([s()],R.prototype,"transparent",void 0),e([s()],R.prototype,"enableOffset",void 0),e([s({count:3})],R.prototype,"cullFace",void 0),e([s({count:4})],R.prototype,"transparencyPassType",void 0),e([s()],R.prototype,"multipassTerrainEnabled",void 0),e([s()],R.prototype,"cullAboveGround",void 0);export{E as DefaultMaterialTechnique,R as DefaultMaterialTechniqueConfiguration};
