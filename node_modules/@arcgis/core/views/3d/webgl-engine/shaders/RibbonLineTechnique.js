/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import{isSome as t,unwrap as i,unwrapOr as r}from"../../../../core/maybe.js";import{ReloadableShaderModule as o}from"../core/shaderTechnique/ReloadableShaderModule.js";import{ShaderTechnique as s}from"../core/shaderTechnique/ShaderTechnique.js";import{ShaderTechniqueConfiguration as n,parameter as l}from"../core/shaderTechnique/ShaderTechniqueConfiguration.js";import p from"../../../webgl/Program.js";import{makePipelineState as a,defaultDepthWriteParams as d,defaultColorWriteParams as c}from"../../../webgl/renderState.js";import{View as u}from"../core/shaderLibrary/util/View.glsl.js";import{Slice as h}from"../core/shaderLibrary/Slice.glsl.js";import{OutputHighlight as f}from"../core/shaderLibrary/output/OutputHighlight.glsl.js";import{VisualVariables as m}from"../core/shaderLibrary/shading/VisualVariables.glsl.js";import{blendingDefault as g,OITBlending as b,OITDepthTest as v,OITDepthWrite as y,OITPolygonOffset as T}from"../lib/OrderIndependentTransparency.js";import{bindMultipassTerrainUniforms as E}from"../core/shaderLibrary/shading/MultipassTerrainTest.glsl.js";import{stencilWriteMaskOn as P,stencilToolMaskBaseParams as O,stencilBaseAllZerosParams as x,depthCompareAlways as C,stencilToolTransparentOccluderParams as S,stencilWriteMaskOff as j,stencilToolMaskOccluderParams as W,depthCompareLess as R}from"../lib/StencilUtils.js";import{R as U}from"../../../../chunks/RibbonLine.glsl.js";const w={position:0,subdivisionFactor:1,uv0:2,auxpos1:3,auxpos2:4,size:6,sizeFeatureAttribute:6,color:5,colorFeatureAttribute:5,opacityFeatureAttribute:7};class z extends s{constructor(e,t){super(e,t),this.stipplePattern=null,this.stippleTextureBind=null,this.stippleTextureRepository=e.stippleTextureRepository}initializeProgram(e){const t=z.shader.get(),i=this.configuration,r=t.build({OITEnabled:0===i.transparencyPassType,output:i.output,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,stippleEnabled:i.stippleEnabled,stippleOffColorEnabled:i.stippleOffColorEnabled,stippleUVMaxEnabled:i.stippleIntegerRepeatsEnabled,stippleIntegerRepeatsEnabled:i.stippleIntegerRepeatsEnabled,roundCaps:i.roundCaps,roundJoins:i.roundJoins,vvColor:i.vvColor,vvSize:i.vvSize,vvInstancingEnabled:!0,vvOpacity:i.vvOpacity,falloffEnabled:i.falloffEnabled,innerColorEnabled:i.innerColorEnabled,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new p(e.rctx,r.generateSource("vertex"),r.generateSource("fragment"),w)}dispose(){super.dispose(),this.stippleTextureRepository.release(this.stipplePattern),this.stipplePattern=null,this.stippleTextureBind=null}bindPass(e,o,s){if(u.bindProjectionMatrix(this.program,s.camera.projectionMatrix),4===this.configuration.output&&f.bindOutputHighlight(e,this.program,s),s.multipassTerrainEnabled&&(this.program.setUniform2fv("inverseViewport",s.inverseViewport),E(this.program,e,s)),this.program.setUniform1f("intrinsicWidth",o.width),this.program.setUniform4fv("intrinsicColor",o.color),this.program.setUniform1f("miterLimit","miter"!==o.join?0:o.miterLimit),this.program.setUniform2fv("cameraNearFar",s.camera.nearFar),this.program.setUniform1f("pixelRatio",s.camera.pixelRatio),this.program.setUniform2f("screenSize",s.camera.fullViewport[2],s.camera.fullViewport[3]),m.bindUniformsWithOpacity(this.program,o),this.stipplePattern!==o.stipplePattern){const e=o.stipplePattern;this.stippleTextureBind=this.stippleTextureRepository.swap(this.stipplePattern,e),this.stipplePattern=e}if(this.configuration.stippleEnabled){const r=t(this.stippleTextureBind)?this.stippleTextureBind(e,0)*s.camera.pixelRatio:1;if(this.program.setUniform1i("stipplePatternTexture",0),this.program.setUniform1f("stipplePatternPixelSizeInv",1/r),this.configuration.stippleOffColorEnabled){const e=i(o.stippleOffColor);this.program.setUniform4f("stippleOffColor",e[0],e[1],e[2],e.length>3?e[3]:1)}}this.configuration.falloffEnabled&&this.program.setUniform1f("falloff",o.falloff),this.configuration.innerColorEnabled&&(this.program.setUniform4fv("innerColor",r(o.innerColor,o.color)),this.program.setUniform1f("innerWidth",o.innerWidth*s.camera.pixelRatio))}bindDraw(e){u.bindView(this.program,e),h.bindUniformsWithOrigin(this.program,this.configuration,e)}setPipelineState(e,t){const i=this.configuration,r=3===e,o=2===e;return a({blending:0===i.output||7===i.output?r?g:b(e):null,depthTest:{func:v(e)},depthWrite:r?!i.transparent&&i.writeDepth&&d:y(e),colorWrite:c,stencilWrite:i.sceneHasOcludees?P:null,stencilTest:i.sceneHasOcludees?t?O:x:null,polygonOffset:r||o?i.polygonOffset&&V:T})}initializePipeline(){const e=this.configuration,t=e.polygonOffset&&V;return e.occluder&&(this._occluderPipelineTransparent=a({blending:g,polygonOffset:t,depthTest:C,depthWrite:null,colorWrite:c,stencilWrite:null,stencilTest:S}),this._occluderPipelineOpaque=a({blending:g,polygonOffset:t,depthTest:C,depthWrite:null,colorWrite:c,stencilWrite:j,stencilTest:W}),this._occluderPipelineMaskWrite=a({blending:null,polygonOffset:t,depthTest:R,depthWrite:null,colorWrite:null,stencilWrite:P,stencilTest:O})),this._occludeePipelineState=this.setPipelineState(this.configuration.transparencyPassType,!0),this.setPipelineState(this.configuration.transparencyPassType,!1)}get primitiveType(){return 5}getPipelineState(e,t){return t?this._occludeePipelineState:this.configuration.occluder?11===e?this._occluderPipelineTransparent:10===e?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:this.pipeline}}z.shader=new o(U,(()=>import("./RibbonLine.glsl.js")));const V={factor:0,units:-4};class I extends n{constructor(){super(...arguments),this.output=0,this.occluder=!1,this.slicePlaneEnabled=!1,this.transparent=!1,this.polygonOffset=!1,this.writeDepth=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stippleIntegerRepeatsEnabled=!1,this.roundCaps=!1,this.roundJoins=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.falloffEnabled=!1,this.innerColorEnabled=!1,this.sceneHasOcludees=!1,this.transparencyPassType=3,this.multipassTerrainEnabled=!1,this.cullAboveGround=!0}}e([l({count:8})],I.prototype,"output",void 0),e([l()],I.prototype,"occluder",void 0),e([l()],I.prototype,"slicePlaneEnabled",void 0),e([l()],I.prototype,"transparent",void 0),e([l()],I.prototype,"polygonOffset",void 0),e([l()],I.prototype,"writeDepth",void 0),e([l()],I.prototype,"stippleEnabled",void 0),e([l()],I.prototype,"stippleOffColorEnabled",void 0),e([l()],I.prototype,"stippleIntegerRepeatsEnabled",void 0),e([l()],I.prototype,"roundCaps",void 0),e([l()],I.prototype,"roundJoins",void 0),e([l()],I.prototype,"vvSize",void 0),e([l()],I.prototype,"vvColor",void 0),e([l()],I.prototype,"vvOpacity",void 0),e([l()],I.prototype,"falloffEnabled",void 0),e([l()],I.prototype,"innerColorEnabled",void 0),e([l()],I.prototype,"sceneHasOcludees",void 0),e([l({count:4})],I.prototype,"transparencyPassType",void 0),e([l()],I.prototype,"multipassTerrainEnabled",void 0),e([l()],I.prototype,"cullAboveGround",void 0);export{z as RibbonLineTechnique,I as RibbonLineTechniqueConfiguration,w as ribbonVertexAttributeLocations};
