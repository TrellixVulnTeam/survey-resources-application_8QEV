/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import"../../../core/has.js";import{isNone as t,isSome as r,applySome as i}from"../../../core/maybe.js";import"../../../core/Logger.js";import"../../../core/accessorSupport/ensureType.js";import{property as s}from"../../../core/accessorSupport/decorators/property.js";import{subclass as o}from"../../../core/accessorSupport/decorators/subclass.js";import"../../../core/urlUtils.js";import"../../../core/uuid.js";import"../../../portal/support/resourceExtension.js";import n from"../../../core/PooledArray.js";import d from"../../../core/Accessor.js";import{f as a}from"../../../chunks/vec3f64.js";import{s as h,p as c}from"../../../chunks/vec3.js";import m from"../../../core/Handles.js";import{Task as l}from"../../support/Scheduler.js";import{MainLight as p,AmbientLight as y}from"./lighting/Lightsources.js";import{GeometryRecord as g}from"./lib/GeometryRecord.js";import{AutoDisposableMixin as _,autoDispose as u}from"./lib/AutoDisposable.js";import{isWebGLLayer as S}from"./lib/WebGLLayer.js";import{ChangeSet as f}from"./lib/ChangeSet.js";import{Model as w}from"./parts/Model.js";import{RenderView as v}from"./parts/RenderView.js";var j;let V=j=class extends(_(d)){constructor(e){super(e),this._handles=new m,this._model=new w,this._layers=new n,this._mainLightDirection=a(0,1,0),this._changeSet=new f,this._layerSyncSet=new Set}initialize(){this._set("renderView",new v(this)),this.setLighting({lights:[new p(a(.7,.7,.7)),new y(a(.3,.3,.3))],groundLightingFactor:.5,globalFactor:.5}),this._handles.add(this.scheduler.registerTask(l.STAGE,(()=>this._processDirty()),(()=>this._model.dirtySet.dirty)))}destroy(){g.pool.prune(0),this._handles.destroy(),this.dispose()}get updating(){return this._model.dirtySet.dirty||this.renderView.updating}get mainLightDirection(){return this._mainLightDirection}get lighting(){return this._lighting}setLighting(e){h(this._mainLightDirection,0,0,0);for(const t of e.lights)if(t instanceof p){c(this._mainLightDirection,t.direction);break}this._lighting=e,this.renderView.setNeedsRender()}add(e){this._model.add(e),S(e)&&(e.attachStage(this),this._addLayer(e)),this.renderView.setNeedsRender()}remove(e){t(e)||(this.renderView.setNeedsRender(),this._model.remove(e),S(e)&&(this._removeLayer(e),e.detachStage()))}addMany(e){r(e)&&(this._model.addMany(e),this.renderView.setNeedsRender())}removeMany(e){r(e)&&(this._model.removeMany(e),this.renderView.setNeedsRender())}forEachOfType(e,t){this._model.forEachOfType(e,t)}handleEvent(e,t){this.destroyed||(this._model.dirtySet[e](t),this.renderView.setNeedsRender())}_processDirty(){const e=this._model.dirtySet;j.DebugSettings.logDirtySet&&console.log("Dirty set: "+e.formatDebugInfo()),e.commit(this._changeSet),j.DebugSettings.logDirtySet&&(console.log("RGs add: "+this._changeSet.adds.map((e=>e.id))),console.log("RGs remove: "+this._changeSet.removes.map((e=>e.id)))),this._layerSyncSet.clear(),this.renderView.modify(this._changeSet),this.renderView.setNeedsRender()}processDirtyLayer(e){this._layerSyncSet.add(e),this.renderView.setNeedsRender()}commitDirtyLayers(){if(0===this._layerSyncSet.size)return;const e=this._model.dirtySet;for(const t of this._layerSyncSet)e.commitLayer(t,this._changeSet);this._layerSyncSet.clear(),this.renderView.modify(this._changeSet),this.renderView.setNeedsRender()}getObject(e){return this._model.getObject(e)}get camera(){return this.renderView.camera}set camera(e){this.renderView.camera=e}get layers(){return this._layers}_addLayer(e){this._layers.some((t=>t===e))||this._layers.push(e)}_removeLayer(e){this._processDirty(),null!=this._layers.removeUnordered(e)&&(this._model.dirtySet.getResidentRenderGeometries(e.id,this._changeSet.removes),this.renderView.modify(this._changeSet))}addRenderPlugin(e,t){"intersect"in t&&this.sceneIntersectionHelper.addIntersectionHandler(t),this.renderView.renderPlugins.add(e,t)}removeRenderPlugin(e){"intersect"in e&&this.sceneIntersectionHelper.removeIntersectionHandler(e),this.renderView.renderPlugins.remove(e)}get performanceInfo(){return{renderView:this.renderView.performanceInfo,model:this._model.getStats()}}get test(){const e=this;return{getCount:t=>e._model.test.content.filter((e=>e.type===t)).length,stopAnimations:t=>e._model.test.content.filter((e=>3===e.type)).forEach((e=>i(e.animation,(e=>e.stopAtTime(t))))),model:e._model}}};V.DebugSettings={endFrameContentValidation:!1,logDirtySet:!1},e([s({constructOnly:!0})],V.prototype,"scheduler",void 0),e([s({constructOnly:!0})],V.prototype,"options",void 0),e([s({constructOnly:!0})],V.prototype,"sceneIntersectionHelper",void 0),e([s({constructOnly:!0})],V.prototype,"viewingMode",void 0),e([s({constructOnly:!0})],V.prototype,"container",void 0),e([s({constructOnly:!0})],V.prototype,"_handles",void 0),e([s({readOnly:!0})],V.prototype,"updating",null),e([s({constructOnly:!0})],V.prototype,"_model",void 0),e([u(),s()],V.prototype,"renderView",void 0),V=j=e([o("esri.views.3d.webgl-engine.Stage")],V);export{V as Stage};
