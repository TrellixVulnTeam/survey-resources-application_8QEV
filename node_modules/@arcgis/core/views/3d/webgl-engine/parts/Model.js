/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{_ as t}from"../../../../chunks/tslib.es6.js";import"../../../../core/has.js";import"../../../../core/Logger.js";import"../../../../core/accessorSupport/ensureType.js";import{property as e}from"../../../../core/accessorSupport/decorators/property.js";import{subclass as o}from"../../../../core/accessorSupport/decorators/subclass.js";import"../../../../core/urlUtils.js";import"../../../../core/uuid.js";import"../../../../portal/support/resourceExtension.js";import r from"../../../../core/Accessor.js";import{maxScale as n}from"../../support/mathUtils.js";import{assert as i,logWithBase as s}from"../lib/Util.js";import{fromValues as a}from"../lib/localOrigin.js";import{isWebGLLayer as d}from"../lib/WebGLLayer.js";import{RenderGeometry as c}from"../lib/RenderGeometry.js";import m from"../lib/ModelDirtySet.js";const l=i,p=s,h=1e4,u=10;let g=class extends r{constructor(){super(),this.dirtySet=new m({model:this}),this._id2origin=new Map,this._content=new Map}getObject(t){return this._content.get(t)}add(t){const e=t.id;l(!this._content.has(e),"Model/Stage already contains object to be added"),this._content.set(e,t),d(t)&&this.dirtySet.layerAdded(t)}remove(t){l(this._content.has(t.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(t.id),t.unload(),d(t)&&this.dirtySet.layerRemoved(t)}addMany(t){for(const e of t)l(!this._content.has(e.id),"Model/Stage already contains object to be added"),this._content.set(e.id,e)}removeMany(t){for(const e of t)l(this._content.has(e.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(e.id),e.unload()}forEachOfType(t,e){this._content.forEach((o=>{o.type===t&&e(o)}))}_getOrigin(t){let e=0;const o=t[3]*u/h;o>1&&(e=Math.ceil(p(o,2)));const r=2**e*h,n=Math.round(t[0]/r),i=Math.round(t[1]/r),s=Math.round(t[2]/r),d=e+"_"+n+"_"+i+"_"+s;let c=this._id2origin.get(d);return null==c&&(c=a(n*r,i*r,s*r,d),this._id2origin.set(d,c)),c}getRenderGeometry(t,e){const o=e.geometry,r=t.getCombinedStaticTransformation(e),i=n(r),s=e.origin,a=new c(o,e.material,null,null,o.boundingInfo,r,e.shaderTransformation,i,t.castShadow);return a.id=e.id,a.origin=s||this._getOrigin(a.boundingSphere),a.instanceParameters=e.instanceParameters,a}updateRenderGeometryTransformation(t,e,o){const r=t.getCombinedStaticTransformation(e,o.transformation);o.updateTransformation(r);const n=this._getOrigin(o.boundingSphere);return o.origin!==n}getStats(){const t={},e=Array.from(this._content.values());for(let o=0;o<5;++o)t[o]=e.filter((t=>t.type===o)).length;return{contentTypes:t,dirtySet:this.dirtySet.formatDebugInfo()}}get test(){return{content:Array.from(this._content.values())}}};t([e({constructOnly:!0})],g.prototype,"dirtySet",void 0),g=t([o("esri.views.3d.webgl-engine.parts.Model")],g);export{g as Model};
