/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{isSome as e,disposeMaybe as t}from"../../../../core/maybe.js";import s from"../../../../core/Logger.js";import{k as i}from"../../../../chunks/vec3.js";import{a as r}from"../../../../chunks/vec2f64.js";import{a as o}from"../../../../chunks/vec4f64.js";import{c as n}from"../../../../chunks/vec4.js";import{requestImage as a}from"../../../../support/requestImageUtils.js";import{assert as h,inverseProjectionInfo as u}from"./Util.js";import l from"../../../webgl/Texture.js";import{vertexCount as _,getGpuMemoryUsage as m}from"../../../webgl/Util.js";import{createColorTexture as p,createQuadVAO as f}from"./glUtil3D.js";import{DefaultTextureUnits as d}from"./DefaultTextureUnits.js";import c from"../../../webgl/FramebufferObject.js";import{SSAOTechniqueConfiguration as b,SSAOTechnique as g}from"./SSAOTechnique.js";const T=s.getLogger("esri.views.3d.webgl-engine.lib.SSAOHelper"),x=4;class O{constructor(e,t,s){this._enabled=!1,this._BLUR_F=2,this._attenuation=.5,this._radius=3,this._samples=16,this._viewportToRestore=o(),this.quadVAO=null,this._rctx=t,this._techniqueRep=e,this._requestRender=s,this._ssaoTechniqueConfig=new b,this._emptyTexture=p(t,[1,1,1,1])}dispose(){this._emptyTexture.dispose(),this._emptyTexture=null,e(this.quadVAO)&&(this.quadVAO=t(this.quadVAO))}get isSupported(){const e=this._rctx,t=-1!==e.parameters.versionString.indexOf("WebGL 0.93"),s=-1!==e.parameters.versionString.indexOf("WebGL 0.94");return!(t||s)}set enabled(e){e?this.enable():this.disable()}get enabled(){return this._enabled}set attenuation(e){this._attenuation=e}get attenuation(){return this._attenuation}set radius(e){this._radius=e}get radius(){return this._radius}get filterRadius(){return x}set samples(e){this._samples=e,this._enabled&&this.selectPrograms()}get samples(){return this._samples}computeSSAO(t,s,r){if(!this._noiseTexture)return;h(this.enabled);const o=this._rctx,a=t.fullViewport,l=a[2],m=a[3],p=l/this._BLUR_F,d=m/this._BLUR_F;this._ssaoFBO.resize(l,m),this._blur0FBO.resize(p,d),this._blur1FBO.resize(p,d);const c=1,b=1,g=l*c,T=m*b;o.bindFramebuffer(this._ssaoFBO),n(this._viewportToRestore,t.fullViewport),o.setViewport(0,0,l,m);const O=this._ssaoTechnique.program,w=this._blurTechnique.program;o.bindProgram(O),o.setPipelineState(this._ssaoTechnique.pipeline),O.setUniform2f("rnmScale",l/this._noiseTexture.descriptor.width,m/this._noiseTexture.descriptor.height),O.setUniform3fv("pSphere",this._samples<=8?this._data.random8:this._samples<=16?this._data.random16:this._samples<=32?this._data.random32:this._data.random64);const B=this._data.minDiscrepancy,S=this._samples<B.length?B[this._samples]:5779;O.setUniform1f("numSpiralTurns",S);const q=U,R=F;u(t.projectionMatrix,t.fullWidth,t.fullHeight,q,R),O.setUniform4fv("projInfo",q),O.setUniform2fv("zScale",R),O.setUniform2f("nearFar",t.near,t.far);let A=1/t.computeRenderPixelSizeAtDist(1);O.setUniform1f("projScale",A*c),O.setUniform2f("screenDimensions",g,T);let v=2*this._radius;const j=i(t.eye,t.center);v=20*t.computeRenderPixelSizeAtDist(j),v=Math.max(.1,v),O.setUniform1f("radius",v),O.setUniform1f("intensity",4*this._attenuation/v**6),O.setUniform1i("rnm",0),O.setUniform1i("normalMap",1),O.setUniform1i("depthMap",2),o.bindTexture(this._noiseTexture,0),o.bindTexture(r,1),o.bindTexture(s,2),e(this.quadVAO)||(this.quadVAO=f(this._rctx));const y=this.quadVAO;o.bindVAO(y),o.drawArrays(5,0,_(y,"geometry"));const z=(x+1)/2,P=1/(2*z*z);o.bindTexture(this._ssaoFBO.colorTexture,0),o.setViewport(0,0,g/this._BLUR_F,T/this._BLUR_F),o.bindFramebuffer(this._blur0FBO),o.bindProgram(w),w.setUniform2f("screenDimensions",g,T),w.setUniform1i("tex",0),w.setUniform1i("normalMap",1),w.setUniform1i("depthMap",2),w.setUniform2f("blurSize",0,this._BLUR_F*c/T),w.setUniform1i("radius",x),w.setUniform1f("g_BlurFalloff",P),w.setUniform2f("nearFar",t.near,t.far),j>5e4&&(A=Math.max(0,A-(j-5e4))),w.setUniform1f("projScale",A),w.setUniform2f("zScale",1,0),o.drawArrays(5,0,_(y,"geometry")),w.setUniform2f("blurSize",this._BLUR_F*b/g,0),o.bindFramebuffer(this._blur1FBO),o.bindTexture(this._blur0FBO.colorTexture,0),o.drawArrays(5,0,_(y,"geometry")),o.setViewport(this._viewportToRestore[0],this._viewportToRestore[1],this._viewportToRestore[2],this._viewportToRestore[3])}setUniforms(e,t){const s=this.enabled&&this._noiseTexture,i=this._rctx;i.bindTexture(s?this._blur1FBO.colorTexture:this._emptyTexture,t),i.setActiveTexture(0),e.setUniform1i("ssaoTex",t),s?e.setUniform4f("viewportPixelSz",this._viewportToRestore[0],this._viewportToRestore[1],1/this._ssaoFBO.width,1/this._ssaoFBO.height):e.setUniform4f("viewportPixelSz",-1,-1,-1,-1)}bindToAllPrograms(e){const t=e.getProgramsUsingUniform("viewportPixelSz");for(const s of t)this.setUniforms(s,d.SSAO)}selectPrograms(){const e=this._samples<=8?8:this._samples<=16?16:this._samples<=32?32:64;this._ssaoTechniqueConfig.samples=e,this._ssaoTechniqueConfig.radius=x,this._ssaoTechniqueConfig.output=0,this._ssaoTechnique=this._techniqueRep.acquireAndReleaseExisting(g,this._ssaoTechniqueConfig,this._ssaoTechnique),this._ssaoTechniqueConfig.output=1,this._blurTechnique=this._techniqueRep.acquireAndReleaseExisting(g,this._ssaoTechniqueConfig,this._blurTechnique)}enable(){this.enabled||(this.isSupported?(this._enabled=!0,this.loadResources((()=>{this._enabled&&this.initialize()}))):T.warn("SSAO is not supported for this browser or hardware"))}loadResources(e){this._data?e():import("./SSAOHelperData.js").then((t=>{this._data=t,e()}))}initialize(){const e={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0},t={colorTarget:0,depthStencilTarget:0};this._ssaoFBO=new c(this._rctx,t,e),this._blur0FBO=new c(this._rctx,t,e),this._blur1FBO=new c(this._rctx,t,e),a(this._data.noiseTexture).then((e=>{this._enabled&&(this._noiseTexture=new l(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,hasMipmap:!0,width:e.width,height:e.height},e),this._requestRender())})),this.selectPrograms()}disable(){this.enabled&&(this._enabled=!1,this._noiseTexture&&(this._noiseTexture.dispose(),this._noiseTexture=null),this._blur1FBO&&(this._blur1FBO.dispose(),this._blur1FBO=null),this._blur0FBO&&(this._blur0FBO.dispose(),this._blur0FBO=null),this._ssaoFBO&&(this._ssaoFBO.dispose(),this._ssaoFBO=null))}getGpuMemoryUsage(){return m(this._blur0FBO)+m(this._blur1FBO)+m(this._ssaoFBO)}get test(){return{ssao:this._ssaoFBO,blur:this._blur1FBO}}}const F=r(),U=o();export default O;
