/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{isSome as e}from"../../../../../core/maybe.js";import{c as t}from"../../../../../chunks/vec3f64.js";import{f as s,d as n,i as r}from"../../../../../chunks/vec3.js";import{a as i}from"../../../../../chunks/mat4f64.js";import{a}from"../../../../../chunks/vec2f64.js";import{a as o}from"../../../../../chunks/vec4f64.js";import{empty as l,expandWithVec3 as c,center as h,diameter as d}from"../../../../../geometry/support/aaBoundingBox.js";import{Default3D as u}from"../DefaultVertexAttributeLocations.js";import{glLayout as p}from"../../../support/buffer/glUtil.js";import{assert as m}from"../Util.js";import f from"../../../../webgl/BufferObject.js";import{bindVertexBufferLayout as g,unbindVertexBufferLayout as _}from"../../../../webgl/Util.js";import y from"../../../../webgl/VertexArrayObject.js";import{acquireMaterials as b,releaseMaterials as I,encodeDoubleVec3 as v}from"../../materials/renderers/utils.js";import{IntersectorResult as D}from"../intersectorUtils.js";import C from"../Camera.js";import R from"../../../support/debugFlags.js";import{colorMixModes as x}from"../../materials/internal/MaterialUtil.js";import{OutputHighlight as E}from"../../core/shaderLibrary/output/OutputHighlight.glsl.js";import{DefaultMaterial as T}from"../../materials/DefaultMaterial.js";import{InstanceData as L,StateFlags as S}from"./InstanceData.js";import{InstanceOctree as U}from"./InstanceOctree.js";import{LevelSelector as A}from"./LevelSelector.js";import{RenderInstanceData as w}from"./RenderInstanceData.js";let V=function(e){const t=e.baseBoundingSphere.radius,s=e.levels.map((e=>e.minScreenSpaceRadius));return new A(t,s)};function O(e){V=e}class M{constructor(e,t){const s=e.renderContext.rctx,n=t.geometry,r=t.material;this.materialRep=e.materialRep,r.setParameterValues({instancedDoublePrecision:!0});const i=r.createBufferWriter(),a=i.vertexBufferLayout,o=i.elementCount(n),l=i.allocate(o);i.write({},n,l,0),this.geometry=n,this.material=r,this.glMaterials=b(r,this.materialRep),this.vertexBufferLayout=a,this.vbo=f.createVertex(s,35044,l.buffer),this.vao=new y(s,u,{geometry:p(a)},{geometry:this.vbo}),this.vertexCount=o}destroy(){I(this.material,this.materialRep),this.vbo.dispose(),this.vao.dispose()}get boundingInfo(){return this.geometry.boundingInfo}get triangleCount(){return this.vertexCount/3}intersect(e,t,s,n,r,i){const a=this.geometry.id,o=r.toString();this.material.intersect(this.geometry,null,e.transform.transform,e,s,n,((s,n,l,c)=>{if(s>=0){if(null!=t&&!t(e.rayBeginPoint,e.rayEndPoint,s))return;const h={type:"external",metadata:{layerUid:i.layerUid,graphicUid:i.graphicUid(r)}};if((null==e.results.min.drapedLayerOrder||c>=e.results.min.drapedLayerOrder)&&(null==e.results.min.dist||s<e.results.min.dist)&&(e.results.min.set(h,o,s,n,e.transform.transform,c,null,a,l),e.results.min.intersector="LodRenderer"),0!==e.options.store&&(null==e.results.max.drapedLayerOrder||c>=e.results.max.drapedLayerOrder)&&(null==e.results.max.dist||s>e.results.max.dist)&&(e.results.max.set(h,o,s,n,e.transform.transform,c,null,a,l),e.results.min.intersector="LodRenderer"),2===e.options.store){const t=new D(e.results.min.ray);t.set(h,o,s,n,e.transform.transform,c,null,a,l),t.intersector="LodRenderer",e.results.all.push(t)}}}))}}class B{constructor(e,t){this.components=[],this.minScreenSpaceRadius=t.minScreenSpaceRadius,t.components.forEach((t=>{this.components.push(new M(e,t))}))}destroy(){this.components.forEach((e=>{e.destroy()}))}intersect(e,t,s,n,r,i){this.components.forEach((a=>{a.intersect(e,t,s,n,r,i)}))}get boundingBox(){if(!this._boundingBox){const t=l();this.components.forEach((s=>{e(s.boundingInfo)&&(c(t,s.boundingInfo.bbMin),c(t,s.boundingInfo.bbMax))})),this._boundingBox=t}return this._boundingBox}get boundingSphere(){if(!this._boundingSphere){const e=this.boundingBox,s=t();h(e,s),this._boundingSphere={center:s,radius:.5*d(e)}}return this._boundingSphere}get triangleCount(){return this.components.reduce(((e,t)=>e+t.triangleCount),0)}}class j{constructor(e,t,s,n){this.type="Lod",this.isGround=!1,this._inverseViewport=a(),this._levels=[],this._defaultRenderInstanceData=[],this._highlightRenderInstanceData=[],this._instanceIndex=0,this._slicePlane=!1,this._enableLevelSelection=!0,this._lastCamera=new C,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.canRender=!0,this._symbol=e,this._optionalFields=t,this._metadata=s,this._instanceBufferLayout=T.getInstanceBufferLayout({instancedDoublePrecision:!0,instanced:t}),this._glInstanceBufferLayout=p(this._instanceBufferLayout,{divisor:1}),this._instanceData=new L(this._optionalFields,n),this._instanceData.on("instance-added",(()=>{this.requestUpdateCycle()})),this._instanceData.on("instance-removed",(()=>{this.requestUpdateCycle()})),this._instanceData.on("instance-transform-changed",(e=>{this.requestUpdateCycle(),this._metadata.notifyGraphicGeometryChanged(e.index)})),this._instanceData.on("instance-visibility-changed",(e=>{this.requestUpdateCycle(!0),this._metadata.notifyGraphicVisibilityChanged(e.index)})),this._instanceData.on("instance-highlight-changed",(()=>{this.requestUpdateCycle(!0)})),this._enableLevelSelection=this._symbol.levels.length>1,F.push(this)}destroy(){F.splice(F.indexOf(this),1)}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlane(){return this._slicePlane}set slicePlane(e){this._slicePlane=e}get intersectionHandlerId(){return this._metadata.layerUid}get instanceData(){return this._instanceData}get memoryUsage(){const e={cpu:0,gpu:0};return this._defaultRenderInstanceData.forEach((t=>{const s=t.memoryUsage;e.cpu+=s.cpu,e.gpu+=s.gpu})),this._highlightRenderInstanceData.forEach((t=>{const s=t.memoryUsage;e.cpu+=s.cpu,e.gpu+=s.gpu})),e}get renderStats(){const e=this._instanceData.size,t=[];return this._levels.forEach(((e,s)=>{const n=this._defaultRenderInstanceData[s],r=this._highlightRenderInstanceData[s],i=n.size+r.size,a=e.triangleCount;t.push({renderedInstances:i,renderedTriangles:i*a,trianglesPerInstance:a})})),{totalInstances:e,renderedInstances:t.reduce(((e,t)=>e+t.renderedInstances),0),renderedTriangles:t.reduce(((e,t)=>e+t.renderedTriangles),0),levels:t}}initializeRenderContext(e){this._context=e;const t=e.renderContext.rctx;this._symbol.levels.forEach((s=>{this._levels.push(new B(e,s)),this._defaultRenderInstanceData.push(new w(t,this._instanceBufferLayout)),this._highlightRenderInstanceData.push(new w(t,this._instanceBufferLayout))})),this._levelSelector=V(this)}uninitializeRenderContext(){this.invalidateOctree(),this._levels.forEach((e=>{e.destroy()})),this._defaultRenderInstanceData.forEach((e=>{e.destroy()})),this._highlightRenderInstanceData.forEach((e=>{e.destroy()}))}get slots(){return[4,6]}get needsHighlight(){return this._highlightRenderInstanceData.reduce(((e,t)=>e+t.size),0)>0}prepareRender(e){this.runUpdates(e)}render(e){const t=e.rctx,s=4===e.slot?3:6===e.slot?5:null;if(!s)return;if(!this.baseMaterial.isVisible()||!this.baseMaterial.isVisibleInPass(e.pass))return!1;const n=e.camera;this._inverseViewport[0]=1/n.fullViewport[2],this._inverseViewport[1]=1/n.fullViewport[3];const r={slot:s,origin:[0,0,0],camera:n,inverseViewport:this._inverseViewport,shadowMap:e.shadowMap,shadowMappingEnabled:!!e.shadowMap&&e.shadowMap.enabled,ssaoEnabled:!!e.ssaoHelper&&e.ssaoHelper.enabled,screenToWorldRatio:null,screenToWorldRatioGlobalWM:null,slicePlane:e.sliceHelper&&e.sliceHelper.plane,hudVisibilityTexture:e.offscreenRenderingHelper?e.offscreenRenderingHelper.hudVisibilityTexture:null,highlightDepthTexture:e.offscreenRenderingHelper?e.offscreenRenderingHelper.depthTexture:null,hasOccludees:!1,linearDepthTexture:null,linearDepthTextureUnit:0,lastFrameColorTexture:null,lastFrameColorTextureUnit:0,reprojectionMat:null,ssrEnabled:!1,lighting:e.scenelightingData,transparencyPassType:e.transparencyPassType,terrainLinearDepthTexture:e.multipassTerrainParams.terrainLinearDepthTexture,geometryLinearDepthTexture:e.multipassGeometryParams.geometryLinearDepthTexture,multipassTerrainEnabled:e.multipassTerrainParams.multipassTerrainEnabled,cullAboveGround:e.multipassTerrainParams.cullAboveGround,multipassGeometryEnabled:e.multipassGeometryParams.multipassGeometryEnabled};t.bindVAO();const i=5!==e.pass&&7!==e.pass,a=6!==e.pass;return i&&this.renderComponents(e,s,r,this._defaultRenderInstanceData),a&&this.renderComponents(e,s,r,this._highlightRenderInstanceData),!0}intersect(e,n,i,a){if(!this.baseMaterial.isVisible())return;const o=t();s(o,a,i);const l=t=>{this._instanceData.getCombinedModelTransform(t,N),e.transform.set(N),r(z,i,e.transform.inverse),r(W,a,e.transform.inverse);const s=this._instanceData.getState(t),o=this._instanceData.getLodLevel(t);m(s&S.ACTIVE,"invalid instance state"),m(o>=0&&o<this._levels.length,"invaid lod level"),this._levels[o].intersect(e,n,z,W,t,this._metadata)};this.baseMaterial.params.verticalOffset?this.octree.forEach(l):this.octree.forEachAlongRay(i,o,l)}queryDepthRange(e){return this.queryDepthRangeOctree(e)}notifyShaderTransformationChanged(){this.invalidateOctree()}requestUpdateCycle(e=!1){this._updateCyclesWithStaticCamera=-1,e&&(this._needFullCycle=!0),this.needsUpdates&&this._context.requestRender()}get needsUpdates(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}runUpdates(e){if(R.LOD_INSTANCE_RENDERER_DISABLE_UPDATES)return;if(this._enableLevelSelection){const t=e.equals(this._lastCamera);this._lastCamera.copyFrom(e),t||this.requestUpdateCycle()}const t=this._needFullCycle?this._instanceData.size:2e3;this._needFullCycle=!1,this.updateInstances(e,t),this.needsUpdates&&this._context.requestRender()}get octree(){return this._octree||(this._octree=this.buildOctree()),this._octree}invalidateOctree(){this._octree&&(this._octree.destroy(),this._octree=null)}buildOctree(){const e=new U(this._instanceData,this.baseBoundingSphere),t=this._instanceData,s=t.view?t.view.state:null;for(let n=0;n<this._instanceData.capacity;++n){s.get(n)&S.ACTIVE&&e.addInstance(n)}return e}queryDepthRangeOctree(e){const t=e.eye,r=e.viewForward,i=this.octree.findClosest(r,"front-to-back",e.frustum),a=this.octree.findClosest(r,"back-to-front",e.frustum);if(null!=i&&null!=a){this._instanceData.view.boundingSphere.getVec(i,q),s(q,q,t);const o=n(q,r)-q[3];this._instanceData.view.boundingSphere.getVec(a,q),s(q,q,t);const l=n(q,r)+q[3];return{near:Math.max(e.near,o),far:Math.min(e.far,l)}}return{near:1/0,far:-1/0}}startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._defaultRenderInstanceData.forEach((e=>{e.startUpdateCylce()})),this._highlightRenderInstanceData.forEach((e=>{e.startUpdateCylce()})),this.needsUpdates&&this._context.requestRender()}updateInstances(e,t){const s=this._enableLevelSelection,n=this._levelSelector;n.updateCamera(e),this._defaultRenderInstanceData.forEach((e=>{e.beginUpdate()})),this._highlightRenderInstanceData.forEach((e=>{e.beginUpdate()}));const r=this._instanceData,i=this._instanceData.view,a=r.size,o=r.capacity;let l=this._instanceIndex;t=Math.min(a,t);for(let c=0;c<t;++c){0===l&&this.startUpdateCycle();const e=i.state.get(l);let a=0;if(!(e&S.ALLOCATED)){l=(l+1)%o,t++;continue}const c=i.lodLevel.get(l);if(e&S.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[c].freeTail(),e&S.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[c].freeTail(),e&S.REMOVE)r.freeInstance(l);else if(e&S.VISIBLE){let t=0;s&&(i.modelOrigin.getVec(l,G),t=n.selectLevel(G,r.getCombinedMedianScaleFactor(l))),a=e&~(S.ACTIVE|S.TRANSFORM_CHANGED),t>=0&&(e&S.HIGHLIGHT?(H(this._highlightRenderInstanceData[t],i,l),a|=S.HIGHLIGHT_ACTIVE):(H(this._defaultRenderInstanceData[t],i,l),a|=S.DEFAULT_ACTIVE)),i.state.set(l,a),i.lodLevel.set(l,t)}else a=e&~(S.ACTIVE|S.TRANSFORM_CHANGED),i.state.set(l,a);if(this._octree){const t=!!(e&S.ACTIVE),s=!!(a&S.ACTIVE);!t&&s?this._octree.addInstance(l):t&&!s?this._octree.removeInstance(l):t&&s&&e&S.TRANSFORM_CHANGED&&(this._octree.removeInstance(l),this._octree.addInstance(l))}l=(l+1)%o}this._instanceIndex=l,this._defaultRenderInstanceData.forEach((e=>{e.endUpdate()})),this._highlightRenderInstanceData.forEach((e=>{e.endUpdate()}))}renderComponents(e,t,s,n){this.levels.forEach(((r,i)=>{r.components.forEach((r=>{this.renderComponent(e,t,s,n[i],r,i)}))}))}renderComponent(e,t,s,n,r,i){const a=r.glMaterials.get(e.pass);if(!a||!a.beginSlot(t)||0===n.size)return;const o=e.rctx,l=o.capabilities.instancing;a.ensureParameters(s);const c=a.getTechnique(),h=a.getPipelineState(t);o.setPipelineState(h),a.bind(o,s),o.bindVAO(r.vao),c.ensureAttributeLocations(r.vao);const d=c.program;e.isHighlightPass&&E.bindOutputHighlight(o,d,s),c.bindDraw(s),R.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&0===e.pass&&(d.setUniform4fv("externalColor",k[Math.min(i,k.length-1)]),d.setUniform1i("colorMixMode",x.replace));const p=n.capacity,f=n.headIndex,y=n.tailIndex,b=n.firstIndex,I=this._glInstanceBufferLayout,v=(e,t)=>{g(o,u,n.buffer,I,e),l.drawArraysInstanced(c.primitiveType,0,r.vertexCount,t-e),_(o,u,n.buffer,I)};r.material.params.transparent&&null!=b?f>y?(m(b>=y&&b<=f,"invalid firstIndex"),v(b,f),v(y,b)):f<y&&(b<=f?(m(b>=0&&b<=f,"invalid firstIndex"),v(b,f),v(y,p),v(0,b)):(m(b>=y&&b<=p,"invalid firstIndex"),v(b,p),v(0,f),v(y,b))):f>y?v(y,f):f<y&&(v(0,f),v(y,p)),o.bindVAO(null)}}function H(e,t,s){const n=e.allocateHead();P(t,s,e.view,n)}function P(e,t,s,n){v(e.modelOrigin,t,s.modelOriginHi,s.modelOriginLo,n),s.model.copyFrom(n,e.model,t),s.modelNormal.copyFrom(n,e.modelNormal,t),e.color&&s.color&&s.color.copyFrom(n,e.color,t),e.featureAttribute&&s.featureAttribute&&s.featureAttribute.copyFrom(n,e.featureAttribute,t)}const F=[],G=t(),q=o(),N=i(),z=t(),W=t(),k=[[1,0,1,1],[0,0,1,1],[0,1,0,1],[1,1,0,1],[1,0,0,1]];export{M as LodComponentData,B as LodLevelData,j as LodRenderer,F as lodRenderers,O as setLevelSelectorFactory};
