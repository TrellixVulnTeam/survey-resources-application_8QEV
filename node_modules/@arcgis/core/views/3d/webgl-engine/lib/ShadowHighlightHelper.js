/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{smoothstep as t,glClamp as i}from"../../../../core/mathUtils.js";import{c as a}from"../../../../chunks/vec3f64.js";import{i as o,n as s,g as e,s as r,d as h}from"../../../../chunks/vec3.js";import{t as c,a as n}from"../../../../chunks/mat4.js";import{a as d}from"../../../../chunks/mat4f64.js";import{a as l}from"../../../../chunks/vec2f64.js";import{a as p}from"../../../../chunks/vec4f64.js";import{s as u,c as m}from"../../../../chunks/vec2.js";import{f as g}from"../../../../chunks/vec4f32.js";import{assert as _,inverseProjectionInfo as f}from"./Util.js";import{vertexCount as w}from"../../../webgl/Util.js";import{createQuadVAO as y}from"./glUtil3D.js";import{ShadowHighlightTechniqueConfiguration as O,ShadowHighlightTechnique as v}from"../shaders/ShadowHighlightTechnique.js";const S=.001953125,x=4e4,M=5e4;class j{constructor(t,i,a,o){this._rctx=i,this.highlightShadowMapSlot=a,this.defaultSnapshotSlot=o,this._opacityElevationFactor=1,this._dayNightTerminatorFactor=1,this._maxOpacity=1,this._defaultOptions={shadowColor:g(1,0,1,1),shadowOpacity:.2,occludedShadowOpacity:.1};const s=new O;this._shadowHighlightTechnique=t.acquireAndReleaseExisting(v,s,this._shadowHighlightTechnique),this._viewingMode=t.viewingMode,this._quadVAO=y(this._rctx)}render(t,i,a,r,h,d){if(_(this._quadVAO),!a.enabled||!this.wouldRender)return;const l=this._rctx,p=this._quadVAO,g=this._shadowHighlightTechnique,y=k,O=b,v=E,S=V,x=A,M=T,j=this.defaultSnapshotSlot,q=this.highlightShadowMapSlot,N=this._defaultOptions,D=N.shadowColor,H=N.shadowOpacity,U=N.occludedShadowOpacity,z=this._opacityElevationFactor*this._dayNightTerminatorFactor,C=u(F,1/i.descriptor.width,1/i.descriptor.height);o(M,r,t.viewInverseTransposeMatrix),s(M,M),e(x,t.center),m(S,t.nearFar),f(t.projectionMatrix,t.fullWidth,t.fullHeight,y,O),c(v,t.viewMatrix,t.center),n(v,v),l.bindFramebuffer(d),l.bindProgram(g.program),g.bindPipelineState(l),g.bindPass(l,{color:D,opacity:H,occludedOpacity:U,terminationFactor:z,defaultSnapshotSlot:j,highlightSnapshotSlot:q,shadowMappingEnabled:a.enabled,shadowMap:a,origin:x,zScale:O,inverseView:v,projInfo:y,nearFar:S,depthMap:i,lightDirView:M,highlightMap:h.colorTexture,texelSize:C}),l.bindVAO(p),l.drawArrays(g.primitiveType,0,w(p,"geometry"))}getGpuMemoryUsage(){return this._quadVAO?this._quadVAO.size:0}setDefaultOptions(t){this._defaultOptions=t,this._updateMaxOpacity()}setup(i,a){const o=i.relativeElevation;this._opacityElevationFactor=1-t(x,M,o),this._dayNightTerminatorFactor=this._evaluateDayNightTerminatorFactor(i.center,a)}dispose(){this._quadVAO&&(this._quadVAO.dispose(),this._quadVAO=null)}get wouldRender(){return this._maxOpacity*this._opacityElevationFactor*this._dayNightTerminatorFactor>=S}_updateMaxOpacity(){const t=this._defaultOptions,i=t.shadowColor,a=Math.max(t.shadowOpacity,t.occludedShadowOpacity);this._maxOpacity=a*i[3]}_evaluateDayNightTerminatorFactor(a,o){const e=1===this._viewingMode?s(q,a):r(q,0,0,1),c=h(e,o);return t(0,1,i(30*c,0,1))}}const F=l(),q=a(),T=a(),A=a(),V=l(),b=l(),k=p(),E=d();export default j;
