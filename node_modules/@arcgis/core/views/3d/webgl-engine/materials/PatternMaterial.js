/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{BufferViewMat3f as e,BufferViewVec4f as t,BufferViewVec4u8 as i,BufferViewVec3f as s}from"../../support/buffer/BufferView.js";import{newLayout as r}from"../../support/buffer/InterleavedLayout.js";import{assert as a}from"../lib/Util.js";import n from"../lib/GLMaterial.js";import{intersectTriangleGeometry as o}from"./internal/MaterialUtil.js";import{Material as u,materialParametersDefaults as c}from"../lib/Material.js";import{writeBufferVec4 as h,writeColor as p,writePosition as l}from"./internal/bufferWriterUtils.js";import{OITPolygonOffsetLimit as f}from"../lib/OrderIndependentTransparency.js";import{DefaultBufferWriter as d}from"./internal/DefaultBufferWriter.js";import{patternVertexAttributeLocations as m,PatternTechniqueConfiguration as g,PatternTechnique as q}from"../shaders/PatternTechnique.js";class b extends u{constructor(e){super(e,v),this.supportsEdges=!0,this._vertexAttributeLocations=m,this.techniqueConfig=new g}getTechniqueConfig(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.cullFace=this.params.cullFace,this.techniqueConfig.vertexColors=this.params.vertexColors,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.polygonOffset=this.params.polygonOffset,this.techniqueConfig.writeDepth=this.params.writeDepth,this.techniqueConfig.style=this.params.style,this.techniqueConfig.patternSpacing=this.params.patternSpacing,this.techniqueConfig.lineWidth=this.params.lineWidth,this.techniqueConfig.draped=this.params.draped,this.techniqueConfig.transparencyPassType=t?t.transparencyPassType:3,this.techniqueConfig.enableOffset=!t||t.camera.relativeElevation<f,this.techniqueConfig.multipassTerrainEnabled=!!t&&t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=!t||t.cullAboveGround,this.techniqueConfig}getPassParameters(){return this.params}intersect(e,t,i,s,r,a,n){o(e,t,s,r,a,void 0,n)}getGLMaterial(e){return 0===e.output||7===e.output||4===e.output||1===e.output&&this.params.writeLinearDepth?new C(e):void 0}createBufferWriter(){const e=r().vec3f("position").vec4u8("color").vec4f("uvMapSpace");return this.params.draped||e.mat3f("boundingRect"),new P(e)}}class C extends n{constructor(e){super(e),this.updateParameters()}updateParameters(e){this.technique=this.techniqueRep.acquireAndReleaseExisting(q,this.material.getTechniqueConfig(this.output,e),this.technique)}beginSlot(e){if(4===this.output)return 3===e;return e===(this.technique.configuration.transparent?this.technique.configuration.writeDepth?5:8:3)}_updateOccludeeState(e){e.hasOccludees!==this.material.params.sceneHasOcludees&&this.material.setParameterValues({sceneHasOcludees:e.hasOccludees})}ensureParameters(e){0!==this.output&&7!==this.output||this._updateOccludeeState(e),this.updateParameters(e)}bind(e,t){e.bindProgram(this.technique.program),this.technique.bindPass(e,this.material.getPassParameters(),t)}getPipelineState(e,t){return this.technique.getPipelineState(t)}}class P extends d{write(r,n,o,u){for(const c of this.vertexBufferLayout.fieldNames){const f=n.vertexAttributes.get(c),d=n.indices.get(c);if(f&&d)switch(c){case"position":{a(3===f.size);const e=o.getField(c,s);e&&l(d,f.data,r.transformation,e,u);break}case"color":{a(3===f.size||4===f.size);const e=o.getField(c,i);e&&p(d,f.data,f.size,e,u);break}case"uvMapSpace":{a(4===f.size);const e=o.getField(c,t);e&&h(d,f.data,e,u);break}case"boundingRect":{a(9===f.size);const t=o.getField(c,e);t&&this.writeBoundingRect(d,f.data,r.transformation,t,u);break}}}}writeBoundingRect(e,t,i,s,r){const a=i,n=s.typedBuffer,o=s.typedBufferStride,u=e.length;r*=o;for(let c=0;c<u;++c){const i=9*e[c],s=t[i],u=t[i+1],h=t[i+2];n[r]=a[0]*s+a[4]*u+a[8]*h+a[12],n[r+1]=a[1]*s+a[5]*u+a[9]*h+a[13],n[r+2]=a[2]*s+a[6]*u+a[10]*h+a[14];for(let e=3;e<9;++e)n[r+e]=t[i+e];r+=o}}}const v={color:[1,1,1,1],writeDepth:!0,writeLinearDepth:!1,vertexColors:!1,polygonOffset:!1,slicePlaneEnabled:!1,cullFace:0,sceneHasOcludees:!1,style:2,patternSpacing:10,lineWidth:1,draped:!0,...c};export{b as PatternMaterial};
