/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{isSome as s}from"../../../../../core/maybe.js";import{c as a}from"../../../../../chunks/vec3f64.js";import{b as e,s as i,g as t,f as r}from"../../../../../chunks/vec3.js";import{c as h}from"../../../../../chunks/mat4.js";import{a as m}from"../../../../../chunks/mat3f64.js";import{f as o,t as n,d as l}from"../../../../../chunks/mat3.js";import{s as p}from"../../../../../chunks/vec2.js";import{c as P}from"../../../../../chunks/vec4.js";import{boundedPlane as c}from"../../../support/geometryUtils.js";import{union as d}from"../../lib/depthRange.js";import{TwoVectorPosition as _}from"../util/TwoVectorPosition.js";import{MaterialPassesParameters as u,ShadowMapPassParameters as g,HighlightPassParameters as w}from"./AllRenderPasses.js";import{RenderPass as f}from"./RenderPass.js";class b{constructor(s,a){this.rctx=s,this.shaderTechniqueRepository=a,this.canRender=!0,this._materialPassParams=new u,this._shadowPassParams=new g,this._highlightPassParams=new w,this._systems=new Set,this._passes=new Array,this._shadowMapPass=this._registerPass(new f(s,this.shaderTechniqueRepository)),this.passes={materialOpaque:this._registerPass(new f(s,this.shaderTechniqueRepository)),materialTransparent:this._registerPass(new f(s,this.shaderTechniqueRepository,1)),materialIntegratedMesh:this._registerPass(new f(s,this.shaderTechniqueRepository)),shadowMap:this._shadowMapPass,highlight:this._registerPass(new f(s,this.shaderTechniqueRepository)),highlightIntegratedMesh:this._registerPass(new f(s,this.shaderTechniqueRepository)),highlightShadowMap:this._registerPass(new f(s,this.shaderTechniqueRepository)),defaultShadowMap:this._registerPass(new f(s,this.shaderTechniqueRepository))}}register(s){this._systems.add(s)}prepareRender(s){0!==this._systems.size&&(this._passes.forEach((s=>s.prepareSubmit())),this._systems.forEach((a=>{a.submit(this.passes,{camera:s})})),this._passes.forEach((s=>s.finishSubmit())),this.shaderTechniqueRepository.frameUpdate())}render(a){if(0===this._systems.size)return!1;if(4===a.slot)switch(this._configure(a),a.pass){case 0:this._materialPassParams.subPass=0,this._configureMaterialColorPass(a),this.passes.materialOpaque.dispatch(this._materialPassParams);break;case 2:this._materialPassParams.subPass=2,this.passes.materialOpaque.dispatch(this._materialPassParams);break;case 3:this._materialPassParams.subPass=3,this.passes.materialOpaque.dispatch(this._materialPassParams);break;case 5:this.passes.highlight.dispatch(this._highlightPassParams);break;case 4:this._shadowMapPass.dispatch(this._shadowPassParams);break;case 7:s(this.passes.highlightShadowMap)&&this.passes.highlightShadowMap.dispatch(this._shadowPassParams);break;case 6:s(this.passes.defaultShadowMap)&&this.passes.defaultShadowMap.dispatch(this._shadowPassParams)}if(6===a.slot)switch(this._configure(a),a.pass){case 0:this._materialPassParams.subPass=0,this._configureMaterialColorPass(a),this.passes.materialTransparent.dispatch(this._materialPassParams);break;case 1:this._materialPassParams.subPass=1,this._configureMaterialColorPass(a),this.passes.materialTransparent.dispatch(this._materialPassParams);break;case 2:this._materialPassParams.subPass=2,this.passes.materialTransparent.dispatch(this._materialPassParams);break;case 3:this._materialPassParams.subPass=3,this.passes.materialTransparent.dispatch(this._materialPassParams)}if(1===a.slot)switch(this._configure(a),a.pass){case 0:this._materialPassParams.subPass=0,this._configureMaterialColorPass(a),this._materialPassParams.ssrParams=a.ssrParams,this.passes.materialIntegratedMesh.dispatch(this._materialPassParams);break;case 2:this._materialPassParams.subPass=2,this.passes.materialIntegratedMesh.dispatch(this._materialPassParams);break;case 3:this._materialPassParams.subPass=3,this.passes.materialIntegratedMesh.dispatch(this._materialPassParams);break;case 5:this.passes.highlightIntegratedMesh.dispatch(this._highlightPassParams)}return!0}notifyDirty(){this.context.requestRender()}slots(){return[4,6,1]}initializeRenderContext(s){this.context=s}uninitializeRenderContext(){}queryDepthRange(a){const e={near:1/0,far:-1/0};return this._systems.forEach((i=>{const t=i.queryShadowCasterDepthRange(a);s(t)&&d(e,t,e)})),e}get shadowCastingEnabled(){return s(this.passes.shadowMap)}set shadowCastingEnabled(s){s?(this._materialPassParams.shadowsEnabled=!0,this.passes.shadowMap=this._shadowMapPass):(this._materialPassParams.shadowsEnabled=!1,this.passes.shadowMap=null)}get screenSpaceReflectionsEnabled(){return s(this._materialPassParams.ssrParams.ssrEnabled)}set screenSpaceReflectionsEnabled(s){this._materialPassParams.ssrParams.ssrEnabled=!!s}_configureMaterialColorPass(s){this._materialPassParams.shadowMap={bind:(a,i)=>{s.shadowMap.bind(a,i);const t=this._materialPassParams.viewTransform;e(M,t.worldFromView_TL,t.worldFromView_TH),s.shadowMap.bindView(a,M)}},this._materialPassParams.ambientOcclusion={bind:(a,e)=>{s.ssaoHelper.setUniforms(a,e)}},this._materialPassParams.ambientOcclusionEnabled=!!s.ssaoHelper&&s.ssaoHelper.enabled,this._materialPassParams.sceneHasOcludees=s.hasOccludees}_configure(s){const a=4===s.pass||7===s.pass||6===s.pass?this._shadowPassParams:5===s.pass?this._highlightPassParams:this._materialPassParams;this._updateParameters(s,a)}_updateParameters(s,a){const e=s.camera,m=e.viewInverseTransposeMatrix;i(M,m[3],m[7],m[11]),y.set(M),t(a.viewTransform.worldFromView_TH,y.high),t(a.viewTransform.worldFromView_TL,y.low),o(a.viewTransform.viewFromCameraRelative_RS,e.viewMatrix),h(a.viewTransform.projFromView,e.projectionMatrix),0===a.identifier?(this._materialPassParams.transparent=6===s.slot,this._materialPassParams.integratedMesh=1===s.slot,this._materialPassParams.lighting=s.scenelightingData,n(T,a.viewTransform.viewFromCameraRelative_RS),l(a.transformNormal_ViewFromGlobal,T),p(a.cameraNearFar,e.near,e.far)):1===a.identifier?p(a.cameraNearFar,e.near,e.far):2===a.identifier&&(a.highlightDepthTexture=s.highlightDepthTexture,P(a.viewport,e.fullViewport)),0!==a.identifier&&2!==a.identifier||(a.inverseViewport[0]=1/e.fullViewport[2],a.inverseViewport[1]=1/e.fullViewport[3]),c.copyWithoutVerify(s.sliceHelper.plane,a.slicePlane),r(a.slicePlane.origin,a.slicePlane.origin,M),a.slicePlaneEnabled=s.sliceHelper.isEnabled,this._materialPassParams.transparencyPassType=s.transparencyPassType,this._materialPassParams.multipassTerrainParams=s.multipassTerrainParams}_registerPass(s){return this._passes.push(s),s}get needsHighlight(){return this.passes.highlight.count>0||this.passes.highlightIntegratedMesh.count>0}}const M=a(),T=m(),y=new _;export{b as RenderPassManager};
