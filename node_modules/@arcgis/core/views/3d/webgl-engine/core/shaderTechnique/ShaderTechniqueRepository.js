/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{isNone as e}from"../../../../../core/maybe.js";class t{constructor(e){this.technique=e,this.refCount=0,this.refZeroFrame=0}}class r{constructor(e){this._context=e,this._perConstructorInstances=new Map,this._frameCounter=0,this._keepAliveFrameCount=1200}get viewingMode(){return this._context.viewingMode}get constructionContext(){return this._context}dispose(){this._perConstructorInstances.forEach((e=>e.forEach((e=>e.technique.dispose())))),this._perConstructorInstances.clear()}acquire(e,r){const s=r.key;let n=this._perConstructorInstances.get(e);n||(n=new Map,this._perConstructorInstances.set(e,n));let o=n.get(s);return void 0===o&&(o=new t(new e(this._context,r)),n.set(s,o)),++o.refCount,o.technique}acquireAndReleaseExisting(t,r,s){return e(s)?this.acquire(t,r):r.key===s.key&&s instanceof t?s:(this.release(s),this.acquire(t,r))}release(t){if(e(t))return;const r=this._perConstructorInstances.get(t.constructor).get(t.key);r.refCount-=1,0===r.refCount&&(r.refZeroFrame=this._frameCounter)}frameUpdate(){this._frameCounter++,this._perConstructorInstances.forEach(((e,t)=>{e.forEach(((t,r)=>{0===t.refCount&&t.refZeroFrame+this._keepAliveFrameCount<this._frameCounter&&(t.technique.dispose(),e.delete(r))})),0===e.size&&this._perConstructorInstances.delete(t)}))}getProgramsUsingUniform(e){return this._context.commonUniformStore.getPrograms(e)}async hotReload(){const e=new Array;this._perConstructorInstances.forEach(((t,r)=>{const s=async(e,t)=>{const r=t.shader;r&&(await r.reload(),e.forEach((e=>{e.technique.reload(this._context)})))};e.push(s(t,r))})),await Promise.all(e)}}export{r as ShaderTechniqueRepository};
