/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../../../chunks/tslib.es6.js";import{isSome as r,unwrap as o}from"../../../../../../core/maybe.js";import{a as t}from"../../../../../../chunks/mat3f64.js";import{a as s}from"../../../../../../chunks/vec4f64.js";import{ReloadableShaderModule as i}from"../../../core/shaderTechnique/ReloadableShaderModule.js";import{ShaderTechnique as a}from"../../../core/shaderTechnique/ShaderTechnique.js";import{ShaderTechniqueConfiguration as n,parameter as l}from"../../../core/shaderTechnique/ShaderTechniqueConfiguration.js";import d from"../../../../../webgl/Program.js";import{makePipelineState as u,defaultDepthWriteParams as c,defaultColorWriteParams as p}from"../../../../../webgl/renderState.js";import{Slice as m}from"../../../core/shaderLibrary/Slice.glsl.js";import{OutputHighlight as h}from"../../../core/shaderLibrary/output/OutputHighlight.glsl.js";import{blendingDefault as b,OITBlending as T,OITDepthTest as f,OITPolygonOffset as O}from"../../../lib/OrderIndependentTransparency.js";import{stencilWriteMaskOn as x,replaceBitWhenDepthTestPasses as g,stencilBaseAllZerosParams as v}from"../../../lib/StencilUtils.js";import{ScreenSpaceReflections as M}from"../../../core/shaderLibrary/shading/ScreenSpaceReflections.glsl.js";import{doublePrecisionRequiresObfuscation as E}from"../../../core/shaderLibrary/util/DoublePrecision.glsl.js";import{PhysicallyBasedRenderingParameters as R}from"../../../core/shaderLibrary/shading/PhysicallyBasedRenderingParameters.glsl.js";import{VertexPosition as S}from"../../../core/shaderLibrary/attributes/VertexPosition.glsl.js";import{C as y}from"../../../../../../chunks/ComponentShader.glsl.js";const A={DIFFUSE:0,COMPONENT_COLOR:1,NORMAL:2,EMISSION:3,OCCLUSION:4,METALLIC_ROUGHNESS:5,OVERLAY0_COLOR:2,OVERLAY1_COLOR:3,OVERLAY0_NORMAL:4,OVERLAY1_NORMAL:5,SSAO:6,SHADOW_MAP:7,PREPASS_LINEAR_DEPTH:8,LAST_FRAME_COLOR:9,TERRAIN_LINEAR_DEPTH:10,GEOMETRY_LINEAR_DEPTH:11};class C extends a{bindPass(e,r){const o=this.program;S.bindViewProjTransform(o,r.viewTransform),m.bindUniforms(this.program,this.configuration,r.slicePlane),0===r.identifier&&void 0!==r.ssrParams&&(r.ssrParams.lastFrameColorTextureUnit=A.LAST_FRAME_COLOR,r.ssrParams.linearDepthTextureUnit=A.PREPASS_LINEAR_DEPTH,M.bindUniforms(this.program,e,r.ssrParams)),0===r.identifier&&(o.setUniformMatrix3fv("uTransformNormal_ViewFromGlobal",r.transformNormal_ViewFromGlobal),2===r.subPass&&o.setUniform2fv("cameraNearFar",r.cameraNearFar),0!==r.subPass&&1!==r.subPass||!r.multipassTerrainParams.multipassTerrainEnabled||(this.program.setUniform2fv("cameraNearFar",r.cameraNearFar),o.setUniform2fv("inverseViewport",r.inverseViewport),r.multipassTerrainParams.terrainLinearDepthTexture&&(o.setUniform1i("terrainDepthTexture",A.TERRAIN_LINEAR_DEPTH),e.bindTexture(r.multipassTerrainParams.terrainLinearDepthTexture,A.TERRAIN_LINEAR_DEPTH))),0===r.subPass&&(r.ambientOcclusionEnabled&&r.ambientOcclusion.bind(o,A.SSAO),r.shadowsEnabled&&r.shadowMap.bind(o,A.SHADOW_MAP),r.lighting.setUniforms(this.program,r.integratedMesh))),1===r.identifier&&this.program.setUniform2fv("cameraNearFar",r.cameraNearFar),2===r.identifier&&h.bindOutputHighlight(e,this.program,r)}bindDraw(e,r){if(S.bindModelTransform(this.program,e),this.program.setUniformMatrix3fv("uTransformNormal_GlobalFromModel",e.transformNormal_GlobalFromModel),r.isIntegratedMesh){const o=r.overlayTexScale,t=r.overlayTexOffset;this.program.setUniform4fv("overlayTexOffset",[e.toMapSpace[0]*o[0]+t[0],e.toMapSpace[1]*o[1]+t[1],e.toMapSpace[0]*o[2]+t[2],e.toMapSpace[1]*o[3]+t[3]]),this.program.setUniform4fv("overlayTexScale",[e.toMapSpace[2]*o[0],e.toMapSpace[3]*o[1],e.toMapSpace[2]*o[2],e.toMapSpace[3]*o[3]])}}bindMaterial(e,t,s){const i=this.program;i.setUniform4fv("uBaseColor",t.baseColor),i.setUniform1f("uObjectOpacity",t.objectOpacity),i.setUniform1f("textureAlphaCutoff",t.alphaCutoff),1===t.componentParameters.type?t.componentParameters.texture.bind(i,{texName:"uComponentColorTex",invDimName:"uComponentColorTexInvDim",unit:A.COMPONENT_COLOR}):(i.setUniform4fv("uExternalColor",t.componentParameters.externalColor),i.setUniform1i("uExternalColorMixMode",t.componentParameters.externalColorMixMode)),r(t.baseColorTexture)&&t.baseColorTexture.bind(e,i,"uBaseColorTexture",A.DIFFUSE,"uBaseColorTextureSize"),0!==this.configuration.output&&7!==this.configuration.output||(R.bindUniforms(this.program,t,this.configuration.isSchematic),r(t.metallicRoughnessTexture)&&t.metallicRoughnessTexture.bind(e,i,"texMetallicRoughness",A.METALLIC_ROUGHNESS,"texMetallicRoughnessSize"),r(t.emissionTexture)&&t.emissionTexture.bind(e,i,"texEmission",A.EMISSION,"texEmissionSize"),r(t.occlusionTexture)&&t.occlusionTexture.bind(e,i,"texOcclusion",A.OCCLUSION,"texOcclusionSize"),r(t.normalTexture)&&t.normalTexture.bind(e,i,"normalTexture",A.NORMAL,"normalTextureSize")),t.isIntegratedMesh&&(0===s.identifier&&0===s.subPass?(e.bindTexture(o(t.overlayColorInner),A.OVERLAY0_COLOR),e.bindTexture(o(t.overlayColorOuter),A.OVERLAY1_COLOR),e.bindTexture(o(t.overlayNormalInner),A.OVERLAY0_NORMAL),e.bindTexture(o(t.overlayNormalOuter),A.OVERLAY1_NORMAL),i.setUniform1i("ovInnerNormalTex",A.OVERLAY0_NORMAL),i.setUniform1i("ovOuterNormalTex",A.OVERLAY1_NORMAL)):2===s.identifier&&(e.bindTexture(o(t.overlayHighlightInner),A.OVERLAY0_COLOR),e.bindTexture(o(t.overlayHighlightOuter),A.OVERLAY1_COLOR)),i.setUniform1i("ovInnerColorTex",A.OVERLAY0_COLOR),i.setUniform1i("ovOuterColorTex",A.OVERLAY1_COLOR),i.setUniform1f("overlayOpacity",1))}initializeProgram(e){const r=C.shader.get(),o=this.configuration,t=r.build({multipassTerrainEnabled:o.multipassTerrainEnabled,cullAboveGround:o.cullAboveGround,OITEnabled:0===o.transparencyPassType,output:o.output,normalType:0===o.integratedMeshMode?o.hasNormals?1:3:2,attributeColor:o.hasVertexColors,attributeTextureCoordinates:o.vertexTextureCoordinates,componentData:o.componentData,alphaDiscardMode:o.alphaDiscardMode,baseColorTexture:o.baseColorTexture,doubleSidedMode:o.doubleSidedMode,receiveAmbientOcclusion:o.receiveAmbientOcclusion,receiveShadows:o.receiveShadows,slicePlaneEnabled:o.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,viewingMode:e.viewingMode,vertexDiscardMode:o.vertexDiscardMode,pbrMode:3===o.integratedMeshMode?4:o.usePBR?o.isSchematic?2:1:0,hasMetalnessAndRoughnessTexture:o.hasMetalnessAndRoughnessTexture,hasEmissionTexture:o.hasEmissionTexture,hasOcclusionTexture:o.hasOcclusionTexture,hasNormalTexture:o.hasNormalTexture,vertexTangets:!1,useOldSceneLightInterface:!1,supportsTextureAtlas:!0,doublePrecisionRequiresObfuscation:E(e.rctx),overlayEnabled:2===o.integratedMeshMode||3===o.integratedMeshMode,ssrEnabled:o.ssrEnabled,highStepCount:!1,ellipsoidMode:o.ellipsoidMode});return new d(e.rctx,t.generateSource("vertex"),t.generateSource("fragment"),r.attributeLocations)}setPipelineState(e){const r=this.configuration,o=0!==r.integratedMeshMode,t=3===e,s=2===e;return u({blending:0!==r.output&&7!==r.output||!r.blendingEnabled?null:t?b:T(e),culling:L[r.cullFace],depthTest:{func:f(e)},depthWrite:t||s?c:null,colorWrite:p,stencilWrite:o||r.sceneHasOcludees?x:null,stencilTest:o?g(1):r.sceneHasOcludees?v:null,polygonOffset:t||s?r.polygonOffsetEnabled?{factor:2,units:2}:null:O})}initializePipeline(){return this.setPipelineState(this.configuration.transparencyPassType)}}C.shader=new i(y,(()=>import("./shader/ComponentShader.glsl.js")));const L=[];L[0]=null,L[2]={face:1029,mode:2305},L[1]={face:1028,mode:2305};class P extends S.ModelTransform{constructor(){super(...arguments),this.transformNormal_GlobalFromModel=t(),this.toMapSpace=s()}}class N extends n{constructor(){super(...arguments),this.output=0,this.hasVertexColors=!1,this.hasNormals=!1,this.vertexTextureCoordinates=0,this.componentData=0,this.slicePlaneEnabled=!1,this.cullFace=2,this.baseColorTexture=!1,this.receiveAmbientOcclusion=!0,this.receiveShadows=!0,this.vertexDiscardMode=0,this.doubleSidedMode=2,this.blendingEnabled=!0,this.alphaDiscardMode=1,this.integratedMeshMode=0,this.ssrEnabled=!1,this.polygonOffsetEnabled=!1,this.usePBR=!1,this.isSchematic=!1,this.hasMetalnessAndRoughnessTexture=!1,this.hasEmissionTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.sceneHasOcludees=!1,this.transparencyPassType=3,this.ellipsoidMode=1,this.multipassTerrainEnabled=!1,this.cullAboveGround=!0}}e([l({count:8})],N.prototype,"output",void 0),e([l()],N.prototype,"hasVertexColors",void 0),e([l()],N.prototype,"hasNormals",void 0),e([l({count:3})],N.prototype,"vertexTextureCoordinates",void 0),e([l({count:2})],N.prototype,"componentData",void 0),e([l()],N.prototype,"slicePlaneEnabled",void 0),e([l({count:3})],N.prototype,"cullFace",void 0),e([l()],N.prototype,"baseColorTexture",void 0),e([l()],N.prototype,"receiveAmbientOcclusion",void 0),e([l()],N.prototype,"receiveShadows",void 0),e([l({count:3})],N.prototype,"vertexDiscardMode",void 0),e([l({count:3})],N.prototype,"doubleSidedMode",void 0),e([l()],N.prototype,"blendingEnabled",void 0),e([l({count:4})],N.prototype,"alphaDiscardMode",void 0),e([l({count:4})],N.prototype,"integratedMeshMode",void 0),e([l()],N.prototype,"ssrEnabled",void 0),e([l()],N.prototype,"polygonOffsetEnabled",void 0),e([l()],N.prototype,"usePBR",void 0),e([l()],N.prototype,"isSchematic",void 0),e([l()],N.prototype,"hasMetalnessAndRoughnessTexture",void 0),e([l()],N.prototype,"hasEmissionTexture",void 0),e([l()],N.prototype,"hasOcclusionTexture",void 0),e([l()],N.prototype,"hasNormalTexture",void 0),e([l()],N.prototype,"sceneHasOcludees",void 0),e([l({count:4})],N.prototype,"transparencyPassType",void 0),e([l({count:4})],N.prototype,"ellipsoidMode",void 0),e([l()],N.prototype,"multipassTerrainEnabled",void 0),e([l()],N.prototype,"cullAboveGround",void 0);export{P as ComponentDrawParameters,C as ComponentTechnique,N as ComponentTechniqueConfiguration,A as TextureUnits};
