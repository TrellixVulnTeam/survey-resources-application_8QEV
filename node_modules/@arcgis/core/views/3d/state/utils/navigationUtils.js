/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{isNone as e}from"../../../../core/maybe.js";import{deg2rad as t,sign as n,clamp as r,acosClamped as o}from"../../../../core/mathUtils.js";import{createScreenPointArray as a}from"../../../../core/screenUtils.js";import{c as i}from"../../../../chunks/vec3f64.js";import{g as c,d as s,a as m,f as u,n as l,c as f,i as p,b as h,l as y,e as M,s as g,h as b}from"../../../../chunks/vec3.js";import{cyclicalPI as d}from"../../support/mathUtils.js";import{i as v,r as z,m as P}from"../../../../chunks/mat4.js";import{a as k}from"../../../../chunks/mat4f64.js";import{a as x}from"../../../../chunks/vec2f64.js";import{s as j}from"../../../../chunks/vec2.js";import{sv3d as w,sm4d as I}from"../../support/stack.js";import{a as A}from"../../../../chunks/vector.js";import{axisAngle as S,plane as V,ray as E,sphere as R}from"../../support/geometryUtils.js";import D from"../../webgl-engine/lib/Camera.js";import{coordinateSystemFromOneAxisAndNormalVector as H,vectorCoordinates as U}from"../../support/geometryUtils/coordinateSystem.js";function G(e,t,n){return n[0]=t[0]/(e.fullWidth/e.pixelRatio),n[1]=t[1]/(e.fullHeight/e.pixelRatio),n}function q(e,t,n){const r=w.get(),o=w.get(),a=w.get();c(o,e),c(a,t);const i=s(o,n),p=s(a,n);m(r,n,i),u(o,o,r),l(o,o),m(r,n,p),u(a,a,r),l(a,a);const h=s(o,a);f(r,n,o);const y=s(a,r);return Math.atan2(y,h)}function F(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e}function C(e,t,n){const r=I.get();v(r),z(r,r,n[3],S.axis(n)),u(e.eye,e.eye,t),p(e.eye,e.eye,r),h(e.eye,e.eye,t),u(e.center,e.center,t),p(e.center,e.center,r),h(e.center,e.center,t),p(e.up,e.up,r),e.markViewDirty()}function O(e,t,n,r){return V.intersectRay(e,E.fromScreen(t,n,Ce),r)}function T(e,t,n,r){const o=w.get();let a=1-n;u(o,t,e.eye);const i=y(o);let c=i*(1-a);a>=0&&c<r&&(c=r,a=-(c-i)/i),Math.abs(i-c)<1e-6||(m(o,o,a),h(e.eye,e.eye,o),M(e.center,e.center,t,a))}function N(e,t,n){t.getScreenCenter(W),R.intersectScreen(e,t,W,t.center),t.markViewDirty();const r=t.distance,o=r*n;if(Math.abs(r-o)<1e-6)return;const a=m(w.get(),t.viewForward,o);u(t.eye,t.center,a),t.markViewDirty()}const W=a();function B(e,t,n){J(t,n),l(n,n),m(n,n,e)}function J(e,t){g(t,0,0,0);for(const n of e)h(t,t,n);m(t,t,1/e.length)}function K(e,t,n,r){return Math.sin(e/y(t))*(n+r.radius)}function L(e,t,n,r){return K(Math.PI/2,t,n,r)+(e-Math.PI/2)}var Q;!function(e){e[e.Vertical=0]="Vertical",e[e.Horizontal=1]="Horizontal"}(Q||(Q={}));const X={Elevation:3e4,Angle:t(6)},Y={Pole:.95,Angle:t(18),Tilt:45},Z=t(80);function $(e,t,n,r,o){const a=i(),c=R.create();let s=!0,m=!0;return e.intersectScreen(n,a)?c[3]=y(a):(m=!1,t.aboveGround?c[3]=Math.max(y(t.center),.9*o.radius):c[3]=y(t.eye)-t.relativeElevation,r?ne(c,t,n,a):s=R.intersectScreen(c,t,n,a)),{sphere:c,scenePickPoint:s?a:null,hasGeometryIntersection:m}}function _(e,t,r,o){if(y(e.eye)-o.radius>X.Elevation)return Q.Horizontal;if(!r)return Q.Vertical;E.fromScreenAtEye(e,t,Oe);return-n(e.relativeElevation)*(.5*Math.PI+A(e.eye,Oe.direction))<X.Angle?Q.Vertical:Q.Horizontal}function ee(e,t,n){u(te,n,t),u(e.eye,e.eye,te),u(e.center,e.center,te),e.markViewDirty()}const te=i();function ne(t,n,r,o){const a=E.fromScreenAtEye(n,r,Ce);return!e(a)&&(R.closestPointOnSilhouette(t,a,re),R.intersectRay(t,a,o)?!(b(re,a.origin)<b(o,a.origin))||(c(o,re),!1):(u(oe,n.eye,n.center),l(oe,oe),V.fromNormalAndOffset(oe,-s(l(oe,oe),re),ae),V.intersectRay(ae,a,o),!1))}const re=i(),oe=i(),ae=V.create();function ie(e,n,a,i,c,p){let h;if(f(qe,e,n),u(Ue,e,n),y(e)<=c||!i.aboveGround){f(a,Ue,i.eye);const m=s(e,n)/(y(e)*y(n)),u=Math.cos(r(d.normalize(t(p)),0,Z));h=-o(m)-Math.max(0,y(n)-c)/(u*c)}else u(ce,i.eye,i.center),f(a,Ue,ce),h=-y(Ue)/c;return l(a,a),m(a,a,y(qe)),h}const ce=i();function se(e,n,a,i){let c,s;const m=Math.cos(r(d.normalize(t(i)),0,Z));return c=n>a?-(n-a)/(m*a):n<-a?Math.PI-(n+a)/(m*a):o(n/a),s=e>a?-(e-a)/(m*a):e<-a?Math.PI-(e+a)/(m*a):o(e/a),(s-c)*a}function me(e,t,n,r,o,a,i,c,m,u){const f=se(e[2],t[2],i[3],m),p=u?se(e[0],t[0],i[3],180):t[0]-e[0],h=Math.sin(c)*p-Math.cos(c)*f,y=Math.cos(c)*p+Math.sin(c)*f;l(He,o);const M=u?h/Math.sqrt(Math.abs(i[3]**2-s(n,He)**2)):h/i[3],g=y/Math.sqrt(Math.abs(i[3]**2-s(n,r)**2));j(a,M,g)}function ue(e,t,n,r,o,a,i,s,u,p){f(qe,e,t),H(a.up,a.eye,ke,xe,je),H([0,0,1],a.eye,ve,ze,Pe),c(n,ze),c(r,ve),l(n,n),m(n,n,y(qe)),U(e,l(xe,xe),l(je,je),l(ke,ke),we),U(t,xe,je,ke,Ie),me(we,Ie,e,ve,ze,o,i,s,u,p)}function le(e,t,n,r,o,a,i){v(Ve),v(Ee),v(Re),z(Ve,Ve,o,r),z(Ee,Ee,i,a),P(Re,Ve,Ee),u(t,e,n),p(t,t,Re),h(t,t,n)}function fe(e,t,n,r,o,a){v(Ve),v(Ee),v(Re),z(Ve,Ve,r,n),z(Ee,Ee,a,o),P(Re,Ve,Ee),u(e.eye,e.eye,t),p(e.eye,e.eye,Re),h(e.eye,e.eye,t),u(e.center,e.center,t),p(e.center,e.center,Re),h(e.center,e.center,t),u(e.up,e.up,t),p(e.up,e.up,Re),h(e.up,e.up,t),e.markViewDirty()}function pe(e,t,n,r,o,a,i=Y.Pole,c=Y.Angle){const s=Math.abs(r)>Math.PI-c||Math.abs(r)<c,m=Math.abs(e[2])<n*i||Math.abs(t)>n;return!!(s&&m&&a.aboveGround&&o<Y.Tilt)}function he(e,t,n,r,o,a){if(a)S.fromPoints(n,r,Se),C(t,e,Se);else{const a=ie(n,r,Fe,t,e[3],o);C(t,e,S.wrapAxisAngle(Fe,a))}}function ye(e,t,n,r,o,a,i){const s=i?20:1,m=1e-12;let u,l;c(De,r),Ge.copyFrom(t);for(let c=0;c<s&&b(n,De)>m&&(u=b(n,De),ue(n,De,ze,ve,Ae,Ge,e,o,a,i),fe(Ge,e,ve,Ae[1],ze,Ae[0]),le(De,De,e,ve,Ae[1],ze,Ae[0]),l=b(n,De),l<u||0===c);c++)t.copyFrom(Ge)}function Me(e,n,r,o,a,i,c){pe(r,s(n.up,r),e[3],-d.normalize(t(a)),i,n,Y.Pole,Y.Angle)?ye(e,n,r,o,-d.normalize(t(a)),i,c):he(e,n,r,o,i,c)}function ge(e,t,n,r,o,a){const{eye:i}=e;H([0,0,1],i,ve,ze,Pe);const c=t.translation[0]*n.pan,m="zoom"===o.mode?0:t.translation[1]*n.pan,u=Math.max(Math.sqrt(Math.abs(1-s(e.center,ve)**2/y(e.center)**2)),.5),l=(Math.sin(a)*m+Math.cos(a)*c)/u,f=-Math.cos(a)*m+Math.sin(a)*c;switch(z(r.pan.matrix,r.pan.matrix,l,ve),r.pan.enabled=!0,o.mode){case"pan":z(r.pan.matrix,r.pan.matrix,f,ze),r.pan.enabled=!0;break;case"zoom":r.zoom=-t.translation[1]*n.zoom}}function be(e,t,n,r,o){const{eye:a,viewRight:i}=e,c=f(w.get(),i,a),s=t.translation[0]*n.pan;switch(0!==s&&(z(r.pan.matrix,r.pan.matrix,-s,c),r.pan.enabled=!0),o.mode){case"pan":{const e=t.translation[1]*n.pan;0!==e&&(z(r.pan.matrix,r.pan.matrix,e,i),r.pan.enabled=!0);break}case"zoom":r.zoom=-t.translation[1]*n.zoom}}function de(e,n,r,o,a,i,c,m,u){pe(e.center,s(e.up,e.center),y(e.center),-d.normalize(t(i)),c,n)?ge(n,r,o,m,u,-d.normalize(t(a))):be(n,r,o,m,u)}const ve=i(),ze=i(),Pe=i(),ke=i(),xe=i(),je=i(),we=i(),Ie=i(),Ae=x(),Se=S.create(),Ve=k(),Ee=k(),Re=k(),De=i(),He=i(),Ue=i(),Ge=new D,qe=i(),Fe=i(),Ce={origin:i(),direction:i()},Oe={origin:i(),direction:i()};export{Q as NavigationMode,Y as PreservingHeadingThreshold,Z as TiltThresholdPanningSpeed,X as VerticalPanTresholds,ee as applyPanPlanar,he as applyPanSphericalDirectRotation,ye as applyPanSphericalPreserveHeading,C as applyRotation,fe as applyRotationWithTwoAxes,N as applyZoomOnSphere,T as applyZoomToPoint,J as centroid,B as centroidOnSphere,_ as decideNavigationMode,O as intersectPlaneFromScreenPoint,se as lengthFromPoints,G as normalizeCoordinate,F as normalizeRotationDelta,L as offSurfaceTiltToEyeTiltGlobal,K as onSurfaceTiltToEyeTiltGlobal,de as panMotionToRotationMatrix,Me as panToPosition,$ as pickPointAndInitSphere,pe as preserveHeadingThreshold,le as rotatePointAroundTwoAxes,ie as rotationAngleAndAxisDirectRotation,ue as rotationAnglesAndAxesHeadingPreserving,me as rotationAnglesHeadingPreserving,q as rotationFromPointsAroundAxis,ne as sphereOrPlanePointFromScreenPoint};
