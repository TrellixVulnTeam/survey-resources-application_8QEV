/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import"../../../core/has.js";import{disposeMaybe as e,releaseMaybe as t,isSome as r,isNone as a}from"../../../core/maybe.js";import{nextHighestPowerOfTwo as i}from"../../../core/mathUtils.js";import{Z as s}from"../../../chunks/vec2f64.js";import{b as o}from"../../../chunks/vec4f64.js";import{s as n,c as l}from"../../../chunks/vec2.js";import{isBaseLayer as c}from"../../../layers/support/layerUtils.js";import"../../../chunks/builtins.js";import"../../webgl/checkWebGLError.js";import u from"../../webgl/Texture.js";import{vertexCount as h}from"../../webgl/Util.js";import{Pos2Tex as d}from"../webgl-engine/lib/DefaultVertexBufferLayouts.js";import{createQuadVAO as f,createColorTexture as p,createEmptyTexture as _}from"../webgl-engine/lib/glUtil3D.js";import"../../webgl/FramebufferObject.js";import{ImageWithType as m}from"../support/StreamDataLoader.js";import{setTextures as x}from"../../webgl/rasterUtils.js";import b from"./TileTexture.js";import{isVectorTileLayerView as y,isVectorTileRenderInfo as g,isImageryTileRenderInfo as T,isRasterTileRenderInfo as w,isTextureTileRenderInfo as k}from"./terrainUtils.js";import{VectorTileRendererHelper3D as D}from"../../2d/engine/vectorTiles/VectorTileRendererHelper3D.js";import{BlendLayersTechniqueConfiguration as I,BlendLayersTechnique as L}from"./BlendLayersTechnique.js";import{RasterColorizerTechniqueConfiguration as C,RasterColorizerTechnique as q}from"./RasterColorizerTechnique.js";import{FBOPool as O}from"./support/FBOPool.js";class j{constructor(e,t,r){this._rctx=e,this.tileSize=t,this._backgroundIsGrid=!1,this._backgroundTexture=null,this._backgroundColor=null,this._blackTex=null,this._vectorTileHelper=new D;this._rctx.capabilities.textureFilterAnisotropic&&(this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy),this._vaoQuad=f(this._rctx,d);const a=new I;a.mode=2,this._blendLayersTechnique=r.acquire(L,a),a.mode=1,this._applyOpacityTechnique=r.acquire(L,a),this._techniqueRep=r,this._blackTex=new b(p(this._rctx,[0,0,0,1])),this._fboPool=new O(this._rctx)}dispose(){this._fboPool&&(this._fboPool.clear(),this._fboPool=null),this._vaoQuad=e(this._vaoQuad),this._backgroundTexture=t(this._backgroundTexture),this._blackTex=t(this._blackTex),this._blendLayersTechnique=e(this._blendLayersTechnique),this._applyOpacityTechnique=e(this._applyOpacityTechnique),this._vectorTileHelper=e(this._vectorTileHelper)}updateTileTexture(e){const t=e.layerInfo[1];for(const r of t)r.pendingUpdates&=-65;if(!e.renderData)return;const i=e.surface,s=i.baseOpacity;let o=0,n=0,l=this.tileSize,u=!1;const h=i.view.pixelRatio;let d=t.length,f=0;for(;f<t.length&&!u;f++){const a=i.layerViewByIndex(f,1),p=a.fullOpacity;if(z[f]=p,c(a.layer)&&d>=t.length&&(d=f),0===p)continue;++n;const _=R(e,f,v);_&&(y(a)?l=Math.max(l,this.tileSize*h):1===s&&1===p&&(a.isOpaque||this._dataToTexture(_)&&r(_.sourceLayerInfo.data)&&_.sourceLayerInfo.data.descriptor.isOpaque)&&(u=!0),++o)}this._cleanupFBOPool(h,t.length),l=P(l);const p=l/this.tileSize,_=f-1;if(0===o){let t=0;return(e.surface.view.layerViewManager.updating||n>0)&&(t=5e3),this._backgroundTexture&&a(e.renderData.textureReference)&&(t=0),void this._useBackgroundTexture(e,t)}1===o&&(u||this._backgroundIsGrid||r(this._backgroundColor))&&this._useLayerTexture(e,_,d,z[_])||this._composeMapLayers(e,_,d,u,z,l,p)}setBackground(e,r){t(this._backgroundTexture),this._backgroundIsGrid=r,e instanceof HTMLImageElement?(this._backgroundTexture=this._buildTexture(e),this._backgroundColor=null):(this._backgroundTexture=new b(p(this._rctx,e)),this._backgroundColor=o(e[0]||0,e[1]||0,e[2]||0,e[3]||0))}get backgroundIsGrid(){return this._backgroundIsGrid}get backgroundColor(){return this._backgroundColor}_buildTexture(e){if(a(e))return null;const t={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9987,maxAnisotropy:this._maxAnisotropy,flipped:!0,hasMipmap:!0},r=this._rctx;let i;if("number"==typeof e)t.width=t.height=e,i=new b(new u(r,t));else if(e instanceof m)t.isOpaque=e.isOpaque,i=new b(new u(r,t,e.image)),e.release();else try{i=new b(new u(r,t,e))}catch(s){i=new b(_(r)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}return r.bindTexture(i.texture,0),i.generateMipmap(),i}_drawQuad(e){this._rctx.bindVAO(this._vaoQuad),e.assertCompatibleVertexAttributeLocations(this._vaoQuad),this._rctx.drawArrays(5,0,h(this._vaoQuad,"geometry"))}_drawRasterData(e,t,r,i,s=1){if(a(t))return;const o=this._rctx,n=e.program;o.setPipelineState(e.pipeline),o.bindProgram(n),o.bindTexture(t,0),n.setUniform1i("tex",0),n.setUniform1f("scale",r),n.setUniform2f("offset",i[0],i[1]),n.setUniform1f("opacity",s),this._drawQuad(n)}_drawImageryTileData(e,t=1){const r=e.sourceLayerInfo.data;if(a(r)||!r.source)return;e.tile.surface.layerViewByIndex(e.layerIndex,1).ensureSymbolizerParameters(r);const i=this._getRasterColorizerTechnique(r.symbolizerParameters.type,!!r.symbolizerParameters.colormap),s=this._rctx,o=i.program;if(s.setPipelineState(i.pipeline),s.bindProgram(o),!r.bind(s))return;r.opacity=t,r.scale=e.scale,r.offset=e.offset;const{names:n,textures:l}=r.getTextures();x(s,o,n,l);const c=r.getUniforms();i.bindPass(s,c),this._drawQuad(o),s.bindVAO()}_getRasterColorizerTechnique(e,t){const r=["stretch","lut","hillshade"].indexOf(e);return this._rasterColorizerConfig||(this._rasterColorizerConfig=new C,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),this._rctx.gl.getExtension("OES_texture_float")),this._rasterColorizerConfig.colorizerType=r,this._rasterColorizerConfig.applyColormap=t,this._rasterColorizerTechnique=this._techniqueRep.acquireAndReleaseExisting(q,this._rasterColorizerConfig,this._rasterColorizerTechnique),this._rasterColorizerTechnique}_drawVectorData(e,t,r,i,s,o,n){const l=t.sourceLayerInfo.data;if(a(l))return n;const c=this._rctx,u=t.tile.surface.layerViewByIndex(t.layerIndex,1);let h;c.setPipelineState(e.pipeline);const d=i<1;return d?(h=this._fboPool.acquire(s),c.bindFramebuffer(h),c.setClearColor(1,1,1,0),c.clearSafe(16640)):n&&c.clearSafe(256),this._vectorTileHelper.render(c,t.sourceLod,l,u.painter,u.layer.styleRepository,u.schemaHelper,Math.round(1/t.scale),t.offset,this.tileSize,r),!d||(c.bindFramebuffer(o),this._drawRasterData(e,h.colorTexture,1,[0,0],i),this._fboPool.release(h),n)}_useBackgroundTexture(e,t){e.renderData.opacity=e.surface.baseOpacity,e.renderData.compositeBackgroundInShader=!1,e.renderData.layerOpacity=1,e.renderData.baseOpacity=1,e.renderData.setTextureReference(this._backgroundTexture,0,0,1,t)}_useLayerTexture(e,t,r,a){const i=t<r;e.renderData.opacity=i?1:e.surface.baseOpacity,e.renderData.compositeBackgroundInShader=!0,e.renderData.layerOpacity=a,e.renderData.baseOpacity=i?e.surface.baseOpacity:1;const s=R(e,t,v);if(this._dataToTexture(s)){const t=s.offset;return e.renderData.setTextureReference(s.sourceLayerInfo.data,t[0],t[1],s.scale),!0}return!1}_composeMapLayers(e,t,i,o,n,l,c){const u=e.renderData.ensureTexture(l,(()=>this._buildTexture(l)));if(a(u))return;const h=this._rctx,d=this._fboPool.acquire(l);h.bindFramebuffer(d),h.setViewport(0,0,l,l),h.setClearColor(0,0,0,0),h.setClearDepth(1),h.clearSafe(16640);let f=!1;!o&&r(this._backgroundTexture)&&this._drawRasterData(this._blendLayersTechnique,this._backgroundTexture.texture,1,s);const p=e.surface.baseOpacity;let _=!1;for(let a=t;a>=0;a--){const t=R(e,a,v);t&&(a<i&&p<1&&!_&&(this._drawRasterData(this._applyOpacityTechnique,this._blackTex.texture,1,s,p),_=!0),0!==n[a]&&(g(t)?f=this._drawVectorData(this._blendLayersTechnique,t,c,n[a],l,d,f):T(t)?this._drawImageryTileData(t,n[a]):this._dataToTexture(t)&&r(t.sourceLayerInfo.data)&&this._drawRasterData(this._blendLayersTechnique,t.sourceLayerInfo.data.texture,t.scale,t.offset,n[a])))}h.bindTexture(u.texture,0);const m=u.descriptor;h.gl.copyTexImage2D(h.gl.TEXTURE_2D,0,m.pixelFormat,0,0,m.width,m.height,0),u.generateMipmap(),h.bindFramebuffer(null),this._fboPool.release(d),e.renderData.opacity=_?1:p,e.renderData.compositeBackgroundInShader=!1,e.renderData.layerOpacity=1,e.renderData.baseOpacity=1,e.renderData.setTextureReference(u,0,0,1)}_dataToTexture(e){return w(e)&&this._rasterDataToTexture(e),k(e)}_rasterDataToTexture(e){const t=e.sourceLayerInfo;t.data=this._buildTexture(t.data),e.tile.setMemoryDirty()}_cleanupFBOPool(e,t){e===this._lastPixelRatio&&t===this._lastNumLayers||(this._fboPool.clear(),this._lastPixelRatio=e,this._lastNumLayers=t)}get test(){return{backgroundTexture:this._backgroundTexture}}}function P(e){const t=i(e),r=t*t,a=e*e;if(r===a)return e;const s=t/2;return r-a<a-s*s?t:s}function R(e,t,r){r.layerIndex=t;const a=e.layerInfo[1][t];if(a.data)return n(r.offset,0,0),r.tile=e,r.scale=1,r.sourceLod=e.lij,r.sourceLayerInfo=a,r;const i=a.upsampleInfo;if(i){const e=i.tile.layerInfo[1][t];return r.tile=i.tile,l(r.offset,i.offset),r.scale=i.scale,r.sourceLod=i.tile.lij,r.sourceLayerInfo=e,r}return null}const z=new Array,v={tile:null,sourceLayerInfo:null,sourceLod:null,offset:[0,0],scale:1,layerIndex:0};export{j as TileRenderer};
