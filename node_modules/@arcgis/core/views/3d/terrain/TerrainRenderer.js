/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import"../../../core/has.js";import{isSome as t,isNone as i}from"../../../core/maybe.js";import"../../../core/Logger.js";import"../../../core/accessorSupport/ensureType.js";import{property as r}from"../../../core/accessorSupport/decorators/property.js";import{subclass as s}from"../../../core/accessorSupport/decorators/subclass.js";import"../../../core/urlUtils.js";import"../../../core/uuid.js";import"../../../portal/support/resourceExtension.js";import n from"../../../core/ObjectPool.js";import a from"../../../core/PooledArray.js";import o from"../../../core/Accessor.js";import l from"../../../Color.js";import{Z as h,c as d}from"../../../chunks/vec3f64.js";import{f as c,s as u,a as p,l as g,b as f,n as m,d as T}from"../../../chunks/vec3.js";import{t as b}from"../../../chunks/mat4.js";import{a as v,I as x}from"../../../chunks/mat4f64.js";import{Z as R,a as y}from"../../../chunks/vec4f64.js";import{c as S,s as _}from"../../../chunks/vec4.js";import{BufferViewVec3f as k}from"../support/buffer/BufferView.js";import{create as O,set as P,expandWithOffset as D}from"../../../geometry/support/aaBoundingBox.js";import{requestImage as q}from"../../../support/requestImageUtils.js";import{DEFAULT_TILE_BACKGROUND as C}from"./TerrainConst.js";import{View as w}from"../webgl-engine/core/shaderLibrary/util/View.glsl.js";import{createEmptyTexture as U}from"../webgl-engine/lib/glUtil3D.js";import{TERRAIN_ID as E,getVerticalOffsetTerrain as B,IntersectorResult as j}from"../webgl-engine/lib/intersectorUtils.js";import{getSettings as N}from"../webgl-engine/lib/screenSizePerspectiveUtils.js";import{intersectAabbInvDirBefore as I,intersectTriangles as A,bindScreenSizePerspective as L}from"../webgl-engine/materials/internal/MaterialUtil.js";import{Slice as M}from"../webgl-engine/core/shaderLibrary/Slice.glsl.js";import{ScreenSpaceReflections as F}from"../webgl-engine/core/shaderLibrary/shading/ScreenSpaceReflections.glsl.js";import{overlayRenderOccludedFlag as G}from"./OverlayRenderer.js";import{clearCaches as Q,intersectSkirts as z}from"./PatchGeometryFactory.js";import{IteratorPreorder as V,traverseTilesPreorder as H,sortTiles as W,tile2str as X,compareTiles as Y}from"./tileUtils.js";import{PatchRenderData as Z}from"./PatchRenderData.js";import{TileRenderer as J}from"./TileRenderer.js";import{TerrainTechniqueConfiguration as K,TerrainTechnique as $}from"../webgl-engine/shaders/TerrainTechnique.js";import{trace as ee}from"../webgl-engine/statistics/tracer.js";const te=7,ie=10,re=O(),se=y();class ne{constructor(){this.extent=y(),this.minLevel=0,this.maxLevel=0,this.callback=null}}let ae=class extends o{constructor(e){super(e),this.type="Terrain",this.isGround=!0,this.tileSize=256,this.rctx=null,this._isTransparent=!1,this.renderDataPool=new n(Z),this.patchGroups=new a({allocator:e=>e||{root:null,origin:null,patches:new a},deallocator:e=>(e.root=null,e.origin=null,e.patches.clear(),e)}),this.patchGroupsDirty=!0,this.patchGroupsMap=new Map,this.tileIterator=new V,this.highestVisibleLODTile=null,this.visible=!0,this._opaque=!0,this._skirtScale=1,this._velvetOverground=!0,this.castShadows=!0,this._ssrEnabled=!1,this.emptyTex=null,this.tileRenderer=null,this.tileBackgroundInitialized=!1,this.tileBackgroundUpdating=!1,this.stencilEnabledLayerExtents=[],this.numTrianglesRendered=0,this.numTilesRendered=0,this.numTilesCulled=0,this.numOriginsRendered=0,this.clippingExtent=null,this.overlayOpacity=1,this.needsHighlight=!1,this.renderOccludedFlags=1,this.visibleScaleRangeQueries=new a({initialSize:10}),this.visibleScaleRangeQueriesInvPtr=0,this.visibleScaleRangeQueryQueue=new a({initialSize:30}),this.visibleScaleRangeQueryPool=new n(ne)}destroy(){Q()}install(e){const t=[2,7,9];e.addRenderPlugin(t,this)}uninstall(e){e.removeRenderPlugin(this)}get updating(){return!this.tileBackgroundInitialized||this.tileBackgroundUpdating}get canRender(){return this.visible&&!!this.rootTiles&&this.tileBackgroundInitialized&&!this.renderingDisabled}set renderingDisabled(e){this._set("renderingDisabled",!!e),this.setNeedsRender()}set opaque(e){this._opaque!==e&&(this._opaque=e,this.setNeedsRender())}get needsLinearDepth(){return this.overlayRenderer.hasWater}get opaque(){return this._opaque&&!this.shaderTechniqueConfig.slicePlaneEnabled}set isTransparent(e){this._isTransparent!==e&&(this._isTransparent=e,this.setNeedsRender())}get isTransparent(){return this._isTransparent}set skirtScale(e){e!==this._skirtScale&&(this._skirtScale=e,this.setNeedsRender())}get skirtScale(){return this._skirtScale}get renderPatchBorders(){return!!this.shaderTechniqueConfig.tileBorders}set renderPatchBorders(e){this.shaderTechniqueConfig.tileBorders!==e&&(this.shaderTechniqueConfig.tileBorders=e,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))}get cullBackFaces(){return this.shaderTechniqueConfig.backfaceCullingEnabled}set cullBackFaces(e){this.shaderTechniqueConfig.backfaceCullingEnabled!==e&&(this.shaderTechniqueConfig.backfaceCullingEnabled=e,this.notifyChange("cullBackFaces"),this.setNeedsRender())}set renderOrder(e){this._set("renderOrder",e),this.setNeedsRender()}set velvetOverground(e){this._velvetOverground!==e&&(this._velvetOverground=e,this.setNeedsRender())}get intersectionHandlerId(){return E}get slicePlane(){return this.shaderTechniqueConfig.slicePlaneEnabled}set slicePlane(e){this.shaderTechniqueConfig.slicePlaneEnabled!==e&&(this.shaderTechniqueConfig.slicePlaneEnabled=e,this.setNeedsRender())}set textureFadingEnabled(e){this.shaderTechniqueConfig.textureFadingEnabled!==e&&(this.shaderTechniqueConfig.textureFadingEnabled=e,this.setNeedsRender())}setDebugScreenSizePerspective(e){this.shaderTechniqueConfig.screenSizePerspective!==e&&(this.shaderTechniqueConfig.screenSizePerspective=e,this.setNeedsRender())}setRootTiles(e){this.rootTiles=e,this.setNeedsRender()}setNeedsHighlight(e){this.needsHighlight=e,this.setNeedsRender()}setRenderOccludedOverlay(e){this.renderOccludedFlags=e?G:1,this.setNeedsRender()}setStencilEnabledLayerExtents(e){this.stencilEnabledLayerExtents=e,this.setNeedsRender()}setTileSize(e){this.tileSize=e,this.tileRenderer&&(this.tileRenderer.tileSize=e),this.setNeedsRender()}loadTile(e){e.renderData||(e.renderData=this.renderDataPool.acquire(),e.renderData.init(e),e.renderData.localOrigin=this._getLocalOriginOfTile(e)),this.updateTileGeometry(e),this.updateTileTexture(e)}queryVisibleLevelRange(e,t,i,r){const s=this.visibleScaleRangeQueryPool.acquire();S(s.extent,e),s.minLevel=t||-Number.MAX_VALUE,s.maxLevel=null!=i?i:Number.MAX_VALUE,s.callback=r,this.visibleScaleRangeQueryQueue.push(s),this.setNeedsRender()}updateTileTexture(e){this.tileRenderer&&this.tileBackgroundInitialized&&(this.tileRenderer.updateTileTexture(e),this.setNeedsRender(),e.resetPendingUpdate(64))}updateTileGeometry(e){for(const t of e.layerInfo[0])t.pendingUpdates&=-33;e.resetPendingUpdate(32),e.renderData.updateGeometry(this.rctx,this.wireframe)&&this.setNeedsRender()}unloadTile(e){e.renderData&&(this.releaseTileGeometry(e.renderData),e.renderData.clear(),e.renderData=null,e.setMemoryDirty(),this.setNeedsRender())}_getLocalOriginOfTile(e){const t=ie-te,i=Math.max(0,Math.floor((e.lij[0]-t)/te)*te);if("spherical"===this.manifold&&0===i)return h;for(;e.parent&&e.lij[0]>i;)e=e.parent;return e.centerAtSeaLevel}setVisibility(e){this.visible=e,this.setNeedsRender()}getStats(){return{numTilesRendered:this.numTilesRendered,numTilesCulled:this.numTilesCulled,numTrianglesRendered:this.numTrianglesRendered,numOriginsRendered:this.numOriginsRendered}}set wireframe(e){this._get("wireframe")!==e&&(this._set("wireframe",e),this.rootTiles&&(H(this.rootTiles,(t=>{t.renderData&&t.renderData.updateGeometry(this.rctx,e)})),this.setNeedsRender()))}setNeedsRender(e=1){this.patchGroupsDirty=!0,this.context.requestRender(e)}setTileBackground(e){this.tileBackground=e,this._updateTileBackground()}initializeRenderContext(e){this.context=e,this.rctx=e.renderContext.rctx,this.shaderTechniques=e.shaderTechniqueRep,this.shaderTechniqueConfig=new K,this.tileRenderer=new J(this.rctx,this.tileSize,this.shaderTechniques),this.tileBackground&&this._updateTileBackground(),this.emptyTex=U(this.rctx)}uninitializeRenderContext(){null!=this.emptyTex&&(this.emptyTex.dispose(),this.emptyTex=null),this.tileRenderer&&(this.tileRenderer.dispose(),this.tileRenderer=null)}intersect(e,r,s,n){if(!this.rootTiles||e.options.selectOpaqueTerrainOnly&&e.options.selectionMode&&!this._opaque)return;const a=ue,o=pe;c(a,n,s),u(o,1/a[0],1/a[1],1/a[2]);const l=e.results.min,h=e.results.max,d=e.results.ground,m=0===e.options.store,b=!!e.results.ground.target;let v;const R=this.clippingExtent,y=this.tileIterator;y.reset(this.rootTiles);const S=B(e.verticalOffset);for(;!y.done;){const _=y.next();if(null===_.renderData||b&&this._useStencilForTile(_))continue;if(e.options.invisibleTerrain){if(!_.visible&&R&&!_.intersectsExtent(R))continue}else if(!_.visible)continue;const O=_.renderData.geometryInfo;P(re,O.boundingBox);const q=_.renderData.localOrigin;t(S)&&(S.localOrigin=q,S.applyToAabb(re));const C=-this._skirtScale*O.skirtLength;if(0!==C){const e=_.up;D(re,C*e[0],C*e[1],C*e[2])}const w=re;c(ge,s,q);const U=m&&null!=l.dist?l.dist:1/0;if(!I(w,ge,o,e.tolerance,U))continue;const E=(e,t,i,r)=>{e.set(void 0,X(t),i,r,x,void 0),e.intersector=me,e.target={type:"external",metadata:{tile:t}}},B=(t,o)=>{if(t>=0&&(e.options.backfacesTerrain||T(o,a)<0)&&(e.options.invisibleTerrain||!e.options.selectionMode||null==r||r(s,n,t))){if((null==d.dist||t<d.dist)&&E(d,_,t,o),e.options.isFiltered)return;2===e.options.store&&(i(v)?(v=new j(e.ray),E(v,_,t,o),e.results.all.push(v)):t<v.dist&&E(v,_,t,o)),(null==l.dist||t<l.dist)&&E(l,_,t,o),0!==e.options.store&&(null==h.dist||t>h.dist)&&E(h,_,t,o)}},N=fe;c(N,n,q);const L=O.indices,M=O.vertexAttributes,F={data:M.getField("position",k).typedBuffer,size:3,stride:M.stride/4},G=O.numWithoutSkirtIndices/3;if(A(ge,N,0,G,L,F,null,S,B),0!==C){const e="spherical"===this.manifold?e=>p(e,e,C/g(f(e,e,q))):e=>u(e,0,0,C),t=L.length/3;z(ge,N,G,t,L,M,e,S,B)}}}render(e){if(9===e.slot){if(0==(e.renderOccludedMask&G))return!1}else{const t=this.opaque?2:7;if(e.slot!==t)return!1}ee("# BEGIN RENDER TERRAIN");const t=e.pass,i=1===e.scenelightingData.globalFactor,r=this._updatePatchGroups();switch(t){case 0:{const t=e.shadowMap&&e.shadowMap.enabled;this.shaderTechniqueConfig.receiveShadows!==t&&(this.shaderTechniqueConfig.receiveShadows=t);const i=this.overlayRenderer.isEmpty()?0:this.overlayRenderer.hasWater?2:1;this.shaderTechniqueConfig.overlayMode!==i&&(this.shaderTechniqueConfig.overlayMode=i);const s=9===e.slot?3:1;this._renderMaterialPass(e,0,r,s);break}case 4:case 6:this.castShadows&&i&&this._renderAuxiliaryPass(e,3,r,0);break;case 2:this.isTransparent&&this.overlayRenderer.isEmpty()||this._renderAuxiliaryPass(e,1,r,0);break;case 3:this._renderAuxiliaryPass(e,2,r,0);break;case 5:this.needsHighlight&&(this._renderAuxiliaryPass(e,4,r,2),e.rctx.clearSafe(256))}return ee("# END RENDER TERRAIN"),0!==this.visibleScaleRangeQueryQueue.length&&this.setNeedsRender(),!0}_renderMaterialPass(e,t,i,r){const s=e.rctx,n=e.camera;this._ssrEnabled=e.ssrParams.ssrEnabled,this._setTerrainTechnique(t,3===r);const a=this.shaderTechnique.program;e.rctx.bindProgram(a),s.bindProgram(a),1===r&&e.ssrParams&&(e.ssrParams.lastFrameColorTextureUnit=9,e.ssrParams.linearDepthTextureUnit=8,F.bindUniforms(a,s,e.ssrParams)),e.shadowMap&&e.shadowMap.bind(a,7),e.ssaoHelper&&e.ssaoHelper.setUniforms(a,6),a.setUniform1i("tex",0),a.setUniform1i("texNext",1),this._bindOverlayData(a,r),a.setUniformMatrix4fv("viewNormal",n.viewInverseTransposeMatrix),w.bindProjectionMatrix(a,n.projectionMatrix),e.scenelightingData.setUniforms(a,!0);const o=n.viewMatrix;u(ce,o[12],o[13],o[14]),m(ce,ce),a.setUniform3fv("viewDirection",ce),this.numTilesRendered=0,this.numTilesCulled=0,this.numTrianglesRendered=0,this.numOriginsRendered=0,this._prepareScaleRangeQueries(),this.opaque?this._renderPatchGroups(e,a,i,r):e.offscreenRenderingHelper.renderToTargets((()=>this._renderPatchGroups(e,a,i,r)),e.offscreenRenderingHelper.tmpColor,e.offscreenRenderingHelper.mainDepth,[0,0,0,0]),this._processScaleRangeQueries()}_renderAuxiliaryPass(e,t,i,r){this._setTerrainTechnique(t,3===r);const s=this.shaderTechnique.program;if(e.rctx.bindProgram(s),5===e.pass){const t=e.offscreenRenderingHelper;e.rctx.bindTexture(t.depthTexture,6),s.setUniform1i("depthTex",6),s.setUniform4f("highlightViewportPixelSz",0,0,1/t.width,1/t.height)}else s.setUniformMatrix4fv("viewNormal",e.camera.viewInverseTransposeMatrix),2!==e.pass&&4!==e.pass&&6!==e.pass||s.setUniform2fv("nearFar",e.camera.nearFar);this._renderPatchGroupsAuxiliary(e,s,i,r)}_updateTileBackground(){if(!this.tileRenderer)return;this.tileBackgroundUpdating=!0;const e=()=>{this.tileBackgroundInitialized=!0,this.tileBackgroundUpdating=!1,this.shaderTechniqueConfig.useGrid=this.tileRenderer.backgroundIsGrid,this.shaderTechniqueConfig.hasBackgroundColor=!this.tileRenderer.backgroundIsGrid&&!!t(this.tileRenderer.backgroundColor),this.rootTiles&&H(this.rootTiles,(e=>{this.tileRenderer.updateTileTexture(e),this.setNeedsRender()})),this.setNeedsRender()};if("string"==typeof this.tileBackground){const t=this.tileBackground;q(t).then((i=>{t===this.tileBackground&&this.tileRenderer&&(this.tileRenderer.setBackground(i,this.tileBackground===C),e())}))}else{const t=this.tileBackground?l.toUnitRGBA(this.tileBackground):[0,0,0,0];this.tileRenderer.setBackground(t,!1),e()}}_updatePatchGroups(){const e=this.patchGroups;if(!this.patchGroupsDirty)return e;if(this.highestVisibleLODTile=null,this._renderCollectOrigins(e),0!==this.renderOrder){for(let t=0;t<e.length;t++)W(this.renderOrder,e.data[t].patches);e.sort(((e,t)=>le(e,t,this.renderOrder)))}return this.patchGroupsDirty=!1,e}_renderCollectOrigins(e){const t=this.rootTiles,i="spherical"===this.manifold;e.clear();for(const r of t){const t=e.pushNew();t.root=r,t.origin=i?h:r.centerAtSeaLevel,t.patches.clear(),this._renderCollectOriginsForRoot(e,t)}e.filterInPlace((e=>e.patches.length>0))}_renderCollectOriginsForRoot(e,t){const i=this.tileIterator;i.resetOne(t.root);const r=this.patchGroupsMap;for(r.clear(),r.set(t.origin,t);!i.done;){const t=i.next(),s=t.renderData;if(!s||t.visible){if(t.lij[0]%te==0){const i=e.pushNew();i.root=t,i.origin=t.centerAtSeaLevel,r.set(t.centerAtSeaLevel,i),i.patches.clear()}if(t.rendered){if(s){const e=r.get(s.localOrigin);e&&e.patches.push(t),(!this.highestVisibleLODTile||t.vlevel>this.highestVisibleLODTile.vlevel)&&(this.highestVisibleLODTile=t),i.skipSubtree()}}else this.numTilesCulled++}else this.numTilesCulled++,i.skipSubtree()}}_scaleQueriesForTile(e){const t=e.extent,i=e.lij[0];let r=0;for(;r<this.visibleScaleRangeQueriesInvPtr;){const e=this.visibleScaleRangeQueries.data[r],s=e.extent;i>=e.minLevel&&i<=e.maxLevel&&s[0]<=t[2]&&s[2]>=t[0]&&s[1]<=t[3]&&s[3]>=t[1]?(this.visibleScaleRangeQueries.swapElements(r,this.visibleScaleRangeQueriesInvPtr-1),this.visibleScaleRangeQueriesInvPtr--):r++}}_useStencilForTile(e){for(const t of this.stencilEnabledLayerExtents)if(e.intersectsExtent(t))return!0;return!1}_renderPatchGroupsAuxiliary(e,t,i,r){this.shaderTechnique.bindPipelineState(e.rctx);const s=this.stencilEnabledLayerExtents.length>0;t.setUniformMatrix4fv("proj",e.camera.projectionMatrix),t.setUniform1f("skirtScale",this._skirtScale),0!==r&&this._bindOverlayData(t,r);for(let n=0;n<i.length;n++){const a=i.data[n];this._bindPatchGroupData(t,a,e.camera.eye,e.camera.viewMatrix);for(let i=0;i<a.patches.length;i++)this._renderPatch(e.rctx,t,a.patches.data[i],4,s,r)}e.rctx.bindVAO(null)}_renderPatchGroups(e,r,s,n){const a=e.rctx,o=e.camera,l=o.viewMatrix;if(this.shaderTechnique.bindPipelineState(a),this.shaderTechniqueConfig.screenSizePerspective&&this.pointsOfInterest){const e=N("spherical"===this.manifold?1:2,this.ellipsoidRadius),t=this.pointsOfInterest.centerOnSurfaceFrequent.distance;e.update({distance:t,fovY:o.fovY}),L(e,r,"screenSizePerspective")}const h=this.stencilEnabledLayerExtents.length>0,d=3===n;d&&(a.bindTexture(this.emptyTex,0),r.setUniform1f("blend",1),r.setUniform4fv("texOffsetAndScale",R));const c=t(this.tileRenderer.backgroundColor)?this.tileRenderer.backgroundColor:R;this.shaderTechniqueConfig.hasBackgroundColor&&r.setUniform4fv("backgroundColor",c);const u=d?0:this._skirtScale;r.setUniform1f("skirtScale",u);const p=this.wireframe?1:4;for(let g=0;g<s.length;g++){const c=s.data[g],u=c.patches;if(0===u.length)continue;this._bindPatchGroupData(r,c,o.eye,l);const f=e.sliceHelper&&e.sliceHelper.plane;M.bindUniforms(r,this.shaderTechnique.configuration,f,c.origin),e.shadowMap&&e.shadowMap.bindView(r,c.origin),this.numOriginsRendered++;for(let e=0;e<u.length;e++){const s=u.data[e],o=s.renderData.textureReference;if(i(o))continue;if(ee("# RENDER TILE "+X(s)+", screenDepth:"+s.screenDepth),!d){this._scaleQueriesForTile(s),he(s.renderData.geometryInfo.uvOffsetAndScale,o.offsetAndScale,se),r.setUniform4fv("texOffsetAndScale",se),a.bindTexture(o.texture.texture,0);const e=s.renderData.textureFadeFactor,i=e<1?s.renderData.nextTextureReference:null;this.shaderTechniqueConfig.textureFadingEnabled&&t(i)?(he(s.renderData.geometryInfo.uvOffsetAndScale,i.offsetAndScale,se),r.setUniform1f("textureFadeFactor",e),r.setUniform4fv("nextTexOffsetAndScale",se),a.bindTexture(i.texture.texture,1)):(r.setUniform1f("textureFadeFactor",1),a.bindTexture(this.emptyTex,1)),s.renderData.textureIsFading&&this.setNeedsRender(),r.setUniform1f("opacity",s.renderData.opacity),r.setUniform1i("compositeBackground",s.renderData.compositeBackgroundInShader?1:0),r.setUniform1f("textureOpacity",s.renderData.layerOpacity),r.setUniform1f("baseOpacity",s.renderData.baseOpacity)}const l=this._renderPatch(a,r,s,p,h,n);s.renderOrder=this.numTilesRendered,this.numTilesRendered++,this.numTrianglesRendered+=l/3}}a.bindVAO(null)}_renderPatch(e,t,i,r,s,n){0!==n&&this._bindOverlayPatchData(t,i.renderData.overlay),s&&(this._useStencilForTile(i)?this.stencilShaderTechnique.bindPipelineState(e):this.shaderTechnique.bindPipelineState(e));const a=0===this._skirtScale?i.renderData.geometryInfo.numWithoutSkirtIndices:i.renderData.vao.indexBuffer.size;return e.bindVAO(i.renderData.vao),t.assertCompatibleVertexAttributeLocations(i.renderData.vao),e.drawElements(r,a,i.renderData.vao.indexBuffer.indexType,0),a}_bindPatchGroupData(e,t,i,r){e.setUniform3fv("origin",t.origin),b(de,r,t.origin),e.setUniformMatrix4fv("view",de),e.setUniform3f("camPos",i[0]-t.origin[0],i[1]-t.origin[1],i[2]-t.origin[2])}_bindOverlayData(e,i){e.setUniform1i("ovInnerColorTex",2),e.setUniform1i("ovOuterColorTex",3),e.setUniform1i("ovInnerWaterTex",4),e.setUniform1i("ovOuterWaterTex",5),e.setUniform1f("overlayOpacity",this.overlayOpacity);const r=this.overlayRenderer.overlays,s=e=>{if(t(r)){const t=r[e],s=(1===i?t.renderTargets.color:2===i?t.renderTargets.highlight:t.renderTargets.occluded).fbo.getTexture();this.rctx.bindTexture(s,2+e);const n=1===i?t.renderTargets.water:null;if(n){const t=n.fbo.getTexture();this.rctx.bindTexture(t,4+e)}else this.rctx.bindTexture(this.emptyTex,4+e)}else this.rctx.bindTexture(this.emptyTex,2+e),this.rctx.bindTexture(this.emptyTex,4+e)};s(0),s(1)}_bindOverlayPatchData(e,t){e.setUniform4fv("overlayTexOffset",t.offsets),e.setUniform4fv("overlayTexScale",t.scales)}_setTerrainTechnique(e,t){if(this.shaderTechniqueConfig.output=e,0===e){const e="spherical"===this.manifold;this.shaderTechniqueConfig.atmosphere=e&&this._velvetOverground,this.shaderTechniqueConfig.ssrEnabled=this._ssrEnabled}this.shaderTechniqueConfig.renderOccluded=t,this.shaderTechniqueConfig.stencilEnabled=!1,this.shaderTechnique=this.shaderTechniques.acquireAndReleaseExisting($,this.shaderTechniqueConfig,this.shaderTechnique),this.shaderTechniqueConfig.stencilEnabled=!0,this.stencilShaderTechnique=this.shaderTechniques.acquireAndReleaseExisting($,this.shaderTechniqueConfig,this.stencilShaderTechnique)}releaseTileGeometry(e){e.releaseGeometry()&&this.setNeedsRender(),this.renderDataPool.release(e)}_prepareScaleRangeQueries(){const e=this.visibleScaleRangeQueries,t=this.visibleScaleRangeQueryQueue;for(;e.length<e.data.length&&t.length>0;){const i=t.pop();e.push(i)}this.visibleScaleRangeQueriesInvPtr=e.length}_processScaleRangeQueries(){const e=this.visibleScaleRangeQueries,t=this.visibleScaleRangeQueryPool;for(let i=0;i<e.length;i++){const r=e.data[i];t.release(r),r.callback(i>=this.visibleScaleRangeQueriesInvPtr),r.callback=null}e.clear()}get test(){return{tileRenderer:this.tileRenderer}}};e([r()],ae.prototype,"tileBackgroundInitialized",void 0),e([r()],ae.prototype,"tileBackgroundUpdating",void 0),e([r({constructOnly:!0})],ae.prototype,"manifold",void 0),e([r({constructOnly:!0})],ae.prototype,"overlayRenderer",void 0),e([r({constructOnly:!0})],ae.prototype,"ellipsoidRadius",void 0),e([r({readOnly:!0})],ae.prototype,"updating",null),e([r({value:!1})],ae.prototype,"renderingDisabled",null),e([r()],ae.prototype,"renderPatchBorders",null),e([r()],ae.prototype,"cullBackFaces",null),e([r({value:1})],ae.prototype,"renderOrder",null),e([r()],ae.prototype,"wireframe",null),ae=e([s("esri.views.3d.terrain.TerrainRenderer")],ae);var oe=ae;function le(e,t,i){return 0===e.patches.length?-i:0===t.patches.length?i:Y(e.patches.data[0],t.patches.data[0],i)}function he(e,t,i){const r=e[0]*t[2]+t[0],s=e[1]*t[3]+t[1],n=e[2]*t[2],a=e[3]*t[3];_(i,r,s,n,a)}const de=v(),ce=d(),ue=d(),pe=d(),ge=d(),fe=d(),me="TerrainRenderer";export default oe;
