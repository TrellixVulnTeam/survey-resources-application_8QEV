/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import"../../../core/has.js";import"../../../core/Logger.js";import"../../../core/accessorSupport/ensureType.js";import{property as t}from"../../../core/accessorSupport/decorators/property.js";import{subclass as s}from"../../../core/accessorSupport/decorators/subclass.js";import"../../../core/urlUtils.js";import"../../../core/uuid.js";import"../../../portal/support/resourceExtension.js";import r from"../../../core/Accessor.js";import{canProject as n,project as i}from"../../../geometry/support/webMercatorUtils.js";import l from"../../../core/Handles.js";import{init as a}from"../../../core/watchUtils.js";import{fromExtent as o,empty as c,expand as p,allFinite as d,equals as h}from"../../../geometry/support/aaBoundingRect.js";import{isTiledLayer as u}from"../../../layers/support/layerUtils.js";import{WEBMERCATOR_WORLD_EXTENT as y,GEOGRAPHIC_WORLD_EXTENT as f}from"./TerrainConst.js";import{getTiledLayerInfo as m,isProjectableRasterLayer as E}from"./terrainUtils.js";let x=class extends r{constructor(e){super(e),this._handles=new l}initialize(){this._handles.add([this.layerViews.on("change",(()=>this.notifyChange("stencilEnabledExtents")))])}destroy(){this._handles.destroy(),this._handles=null}get layerViewsExtent(){return this._computeLayerViewsExtent()}get tiledLayersExtent(){return this._computeTiledLayersExtent()}get stencilEnabledExtents(){return this._computeStencilEnabledExtents()}set spatialReference(e){this.tilingScheme||this._set("spatialReference",e)}set tilingScheme(e){this._set("tilingScheme",e),this._set("spatialReference",e.spatialReference)}_computeStencilEnabledExtents(){const e=[];return this.layerViews.forEach((t=>{const s=t.layer;if("IntegratedMeshLayer"===s.operationalLayerType&&null!=this.spatialReference){const t=L(s.fullExtent,this.spatialReference);null!=t&&e.push(o(t))}})),e}};function g(e,t){return"spherical"===e?new _(t):new w(t)}e([t({readOnly:!0,dependsOn:[]})],x.prototype,"layerViewsExtent",null),e([t({readOnly:!0,dependsOn:["spatialReference","tilingScheme"]})],x.prototype,"tiledLayersExtent",null),e([t({readOnly:!0,dependsOn:["spatialReference"]})],x.prototype,"stencilEnabledExtents",null),e([t()],x.prototype,"spatialReference",null),e([t()],x.prototype,"tilingScheme",null),e([t()],x.prototype,"defaultTiledLayersExtent",void 0),e([t({constructOnly:!0})],x.prototype,"layers",void 0),e([t({constructOnly:!0})],x.prototype,"layerViews",void 0),x=e([s("esri.views.3d.terrain.SurfaceExtentHelperBase")],x);let _=class extends x{_computeLayerViewsExtent(){return this._getGlobalExtent()}_computeTiledLayersExtent(){return this._getGlobalExtent()}_getGlobalExtent(){return this.spatialReference.isWebMercator?y:f}};e([t({dependsOn:["spatialReference"]})],_.prototype,"layerViewsExtent",void 0),_=e([s("esri.views.3d.terrain.SurfaceExtentHelperGlobal")],_);let w=class extends x{initialize(){this._handles.add([this.layers.on("change",(e=>this._handleLayersChanged(e))),this.layerViews.on("change",(()=>this.notifyChange("layerViewsExtent")))])}_handleLayersChanged(e){for(const t of e.removed)this._handles.remove(t.uid);for(const t of e.added)this._handles.add(a(t,"loaded",(()=>this.notifyChange("tiledLayersExtent"))),t.uid)}_computeLayerViewsExtent(){const e=c(),t=this.spatialReference;this.layerViews.forEach((s=>{const r=s.layer;if(s.isResolved()&&("graphics"!==r.type||!r.internal)){const r=L("fullExtentInLocalViewSpatialReference"in s&&s.fullExtentInLocalViewSpatialReference||s.layer.fullExtent,t);r&&p(e,r)}}));const s=d(e)?e:null,r=this._get("layerViewsExtent");return h(s,r)?r:s}_computeTiledLayersExtent(){const e=this.tilingScheme;if(!e)return null;const t=this.spatialReference,s=c();this.layers.forEach((function(r){if(r.loaded&&u(r)){const{tileInfo:n,fullExtent:i}=m(r,t,2);(n&&E(r)&&i||n&&e.compatibleWith(n)&&i&&i.spatialReference.equals(t))&&p(s,i)}})),this.defaultTiledLayersExtent&&p(s,this.defaultTiledLayersExtent);const r=d(s)?s:null,n=this._get("tiledLayersExtent");return h(r,n)?n:r}};function L(e,t){return e&&!e.spatialReference.equals(t)&&(e=n(e.spatialReference,t)?i(e,t):null),e}w=e([s("esri.views.3d.terrain.SurfaceExtentHelperLocal")],w);export{x as SurfaceExtentHelper,g as create};
