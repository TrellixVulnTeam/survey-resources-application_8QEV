/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{isSome as e,abortMaybe as t,isNone as i}from"../../../core/maybe.js";import s from"../../../core/ObjectPool.js";import{createAbortController as n}from"../../../core/promiseUtils.js";import{log2 as r}from"../../../core/mathUtils.js";import{c as a,u as o}from"../../../chunks/vec3f64.js";import{g as h,f as l,o as d,d as u,a as c,b as p,l as g}from"../../../chunks/vec3.js";import{getReferenceEllipsoid as f}from"../../../geometry/projectionEllipsoid.js";import{create as m,equals as _}from"../../../geometry/support/aaBoundingRect.js";import{a as y}from"../../../chunks/vec2f64.js";import{a as v}from"../../../chunks/vec4f64.js";import{c as A,s as M}from"../../../chunks/vec2.js";import{t as L}from"../../../chunks/vec4.js";import{LayerClasses as j,MAX_PATCH_TESSELATION as D,ELEVATION_DESIRED_RESOLUTION_LEVEL as I}from"./TerrainConst.js";import{c as U}from"../../../chunks/sphere.js";import{getGpuMemoryUsage as B}from"../../webgl/Util.js";import{ImageWithType as C}from"../support/StreamDataLoader.js";import{VectorTile as T}from"../../2d/engine/vectorTiles/VectorTile.js";import x from"./RasterTile.js";import S from"./TileTexture.js";import{getLayerWithExtentRange as b,weakAssert as q}from"./terrainUtils.js";import{ElevationBounds as R}from"./ElevationBounds.js";import{tile2str as P,fallsWithinLayer as w}from"./tileUtils.js";import{TILE_AGENT_DONE as E}from"./TileAgent.js";import V from"./ElevationTileAgent.js";import W from"./MapTileAgent.js";import{TilePerLayerInfo as k}from"./TilePerLayerInfo.js";const N=q,O=a(),z=a(),H=a(),G=v(),F=.1;class X{constructor(){this.fovX=0,this.fovY=0,this.relativeWidthLimit=0,this.relativeHeightLimit=0,this.maxLod=0,this.angledSplitBias=0,this.aboveGround=!0}}class ${constructor(e){this._numSubdivisionAtLevel=e,this.lij=[0,0,0],this._children=[null,null,null,null],this._dirty=!0,this._previouslyRendered=!1,this.extent=m(),this._elevationBounds=y(),this.layerInfo=[[],[]],this.extentInRadians=m(),this.centerAtSeaLevel=a(),this._center=[a(),U(),a()],this.up=o(),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._maxTesselation=0,this._usedMemory=ee,this._mapTileMemory=0,this._mapDataRefCount=0,this._screenDepth=0,this.renderOrder=0,this._edgeLen=0,this._edgeLen2=0,this._curvatureHeight=0}static prune(){J.prune(0),K.prune(0),k.prune()}get usedMemory(){return this._usedMemory===ee&&this._updateMemoryUsed(),this._usedMemory+(this.isCached?0:this.mapTileMemory)}get cachedMemory(){return this.isCached?this.mapTileMemory:0}get mapTileMemory(){this._usedMemory===ee&&this._updateMemoryUsed();let e=this._mapTileMemory;for(const{data:t}of this.layerInfo[1])t instanceof T&&(e+=t.getMemoryUsage());return e}get isCached(){return!this.shouldLoad&&this._mapDataRefCount<=0}get maxTesselation(){return this._maxTesselation}get numSubdivisionsAtLevel(){return this._numSubdivisionAtLevel}get isWithinClippingArea(){return this._isWithinClippingArea}get intersectsClippingArea(){return this._intersectsClippingArea}get clippingArea(){return this._clippingArea}get parent(){return this._parent}get children(){return this._children}get surface(){return this._surface}get elevationBounds(){return this._elevationBounds}get level(){return this.lij[0]}get edgeLen(){return this._edgeLen}get radius(){return this._center[1][3]}get screenDepth(){return this._screenDepth}get visible(){if(this._dirty){this._dirty=!1;const e=this._isVisible(this.surface.frustum);e!==this._visible&&(this._visible=e,this._surface.emit("tiles-visibility-changed"),this._surface.renderer.setNeedsRender()),this.updateAgentSuspension()}return this._visible}get loadable(){return this.visible||this._surface.view.state.fixedContentCamera}get rendered(){const e=!!this.renderData;return e!==this._previouslyRendered&&(this._surface.emit("tiles-visibility-changed"),this._previouslyRendered=e,this._surface.renderer.setNeedsRender()),e}get shouldLoad(){if(!this.loadable)return!1;if(1===this._surface.lodSnapping){const e=this.level-this._surface.snapLevel;if(0===e)return!0;if(1===e)return!1}return this.isLeaf}init(e,t,i){this.lij[0]=e[0],this.lij[1]=e[1],this.lij[2]=e[2],this.ellipsoid=f(i.tilingScheme.spatialReference),i.tilingScheme.getExtent(e[0],e[1],e[2],this.extent),i.tilingScheme.convertExtentToRadians(this.extent,this.extentInRadians),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._clippingArea=null,this._mapDataRefCount=0,i.upsampleMapCache.pop(P(this)),this._edgeLen=0,this._edgeLen2=0,this._center[1][3]=0,this.vlevel=e?e[0]:0,t&&t._elevationBounds?A(this._elevationBounds,t.elevationBounds):M(this._elevationBounds,0,0),this._pendingUpdates=0,this.renderData=null,this._screenDepth=0,this._visible=!1,this._previouslyRendered=!1,this._parent=t,this.unsetChildren(),this._surface=i,this.updateVisibility();for(const s of j){const e=i.numLayers(s),t=this.layerInfo[s];for(const i of t)i.release();t.length=e;for(let i=0;i<e;i++)t[i]=k.acquire(this._surface.upsampleInfoPool),0===s&&this.findElevationBoundsForLayer(i,-1)}this.computeElevationBounds(),this._maxTesselation=Math.min(i.tilingScheme.pixelSize,D)}release(){N(!this.renderData,"tile.renderData was not unloaded"),this._surface.upsampleMapCache.pop(P(this));for(const e of j){for(const t of this.layerInfo[e])t.release();this.layerInfo[e].length=0}this._parent=null,this._surface=null,this._usedMemory=ee}refMapData(){++this._mapDataRefCount,this.isCached||this._surface.upsampleMapCache.pop(P(this))}unrefMapData(){if(--this._mapDataRefCount,this.isCached){const e=this.cachedMemory;e>0&&(this._surface.upsampleMapCache.put(P(this),this,e),this.setMemoryDirty())}}setMemoryDirty(){this._usedMemory=ee}get cpuImageMemorySize(){const e=4,t=this._surface.tilingScheme.pixelSize;return t*t*e}_updateMemoryUsed(){this._usedMemory=0,this._mapTileMemory=0;const e=this.cpuImageMemorySize;for(const t of this.layerInfo[1]){const i=t.data;i instanceof S?this._mapTileMemory+=B(i.texture):i instanceof HTMLImageElement||i instanceof C?this._mapTileMemory+=e:i instanceof x&&(this._mapTileMemory+=i.getMemoryUsage())}for(const t of this.layerInfo[0])this._usedMemory+=t.data?e:0;this.renderData&&(this._usedMemory+=this.renderData.estimatedGeometryMemoryUsage,this._mapTileMemory+=B(this.renderData.textureDescriptor)),this.isCached&&this._surface.upsampleMapCache.updateSize(P(this),this,this.cachedMemory)}getUsedMemoryForLayer(e,t){const i=this.layerInfo[e][t];if(!i||!i.data)return 0;if(1!==e||this.isCached){if(0===e)return this.cpuImageMemorySize}else{const e=i.data;if(e instanceof S)return B(e.texture);if(e instanceof HTMLImageElement||e instanceof C)return this.cpuImageMemorySize;if(e instanceof T||e instanceof x)return e.getMemoryUsage()}return 0}updateScreenDepth(e){h(G,this._center[1]),G[3]=1,L(G,G,e),this._screenDepth=G[2]<0?0:G[2]/G[3]}shouldSplit(t,i,s){if(e(t.frustum)&&!this._isVisible(t.frustum))return 0;const n=this.level;l(O,this._center[1],i);let a=d(O),o=1;l(z,this._center[0],i);const h=d(z);h<a&&(a=h,o=0),l(z,this._center[2],i);const f=d(z);if(f<a&&(a=f,o=2),this._edgeLen2>a&&n<t.maxLod)return 2;const m=Math.sqrt(a),_=t.fovX*m*2,y=this._edgeLen/_,v=()=>{const e=n+Math.ceil(-r(t.relativeWidthLimit/y));return e!==this.vlevel?(this.vlevel=e,4):1};if(1===s){if(1===this._surface.snapLevel-n)return n>=t.maxLod?v():2}const A=u(this.up,O),M=this._elevationBounds[1]-this._elevationBounds[0],L=M/this.edgeLen;if(t.aboveGround&&A>0&&L<.001){if(A/m-Math.sin(this._curvatureHeight/(this.edgeLen*Math.SQRT1_2)*Math.PI)-L>0)return 0}if(y<t.relativeWidthLimit)return this.vlevel!==this.level?(this.vlevel=this.level,4):0;if(n>=t.maxLod)return v();if(n>6){l(z,this._center[o],i),c(H,this.up,A),l(H,H,z);const e=d(H);if(e>this.radius*this.radius){c(H,H,this.radius/Math.sqrt(e)),p(H,H,this._center[o]),l(H,i,H);const s=Math.min(1,(Math.abs(u(H,this.up))+.5*M+this._curvatureHeight)/g(H)),n=F/t.angledSplitBias,r=t.fovY*m*2;if(s*(this._edgeLen/r)<n*t.relativeHeightLimit)return 0}}return 2}setChildren(e,t,i,s){N(!!(e&&t&&i&&s),"Null child passed"),this._children[0]=e,this._children[1]=t,this._children[2]=i,this._children[3]=s}unsetChildren(){this._children[0]=null,this._children[1]=null,this._children[2]=null,this._children[3]=null}load(e){this.refMapData();for(const t of j)this._createOrUpdateAgents(0,t);e.loadTile(this)}unload(e){e.unloadTile(this);for(const t of j){const e=this.layerInfo[t];for(const t of e)t.loadingAgent&&t.loadingAgent!==E&&(Q(t.loadingAgent),t.loadingAgent=null),t.pendingUpdates=0}this.resetPendingUpdate(32),this.resetPendingUpdate(64),this.unrefMapData()}unloadMapData(){const e=this.layerInfo[1];for(const t of e)t.loadingAgent&&t.loadingAgent!==E&&(Q(t.loadingAgent),t.loadingAgent=null),t.pendingUpdates=0;this.renderData&&this.renderData.releaseTexture(),this.setMemoryDirty()}updateClippingStatus(t){if(_(t,this._clippingArea))return!1;const i=this._intersectsClippingArea,s=this._isWithinClippingArea;e(t)?(this._intersectsClippingArea=this.intersectsExtent(t),this._isWithinClippingArea=this.isWithinExtent(t)):(this._intersectsClippingArea=!0,this._isWithinClippingArea=!0),this._clippingArea=t,this.updateVisibility();const n=s&&this._isWithinClippingArea,r=!(s||i||this._isWithinClippingArea||this._intersectsClippingArea);return!this.renderData||n||r||this.setPendingUpdate(32),!0}updateVisibility(){this._dirty=!0,this._surface.setTileTreeDirty()}getLayerInfo(e,t){return this.layerInfo[t][e]}hasLayerData(e,t){const i=this.layerInfo[t][e];return!(!i||!i.data||i.dataInvalidated)}get updating(){if(this.hasPendingUpdates)return!0;for(const e of j){const t=this.layerInfo[e];for(const e of t)if(e.loadingAgent&&e.loadingAgent!==E&&e.loadingAgent.updating)return!0}return!1}isSuspended(e){return!!this.hasPendingUpdate(2)||0!==e&&!this.loadable}get hasPendingUpdates(){return 0!==this._pendingUpdates}hasPendingUpdate(e){return(this._pendingUpdates&e)===e}setPendingUpdate(e){this._pendingUpdates|=e,2===e||8===e?this._surface.setTileTreeDirty():this._surface.pendingUpdates=!0}resetPendingUpdate(e){return!!this.hasPendingUpdate(e)&&(this._pendingUpdates&=~e,!0)}requestLayerData(e,i,s){const r=this.layerInfo[i][e];if(r.waitingAgents.has(s))return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),s.tile.lij.toString(),i,e),!0;if(r.waitingAgents.push(s),r.data&&!r.dataInvalidated)return console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),s.tile.lij.toString(),i,e),s.dataArrived(this),!0;if(r.requestPromise)return!0;t(r.requestAbort),r.requestAbort=n();const a=this._surface.requestTileData(this,e,i,r.requestAbort);if(!a)return r.requestAbort=null,!1;const o=()=>{r.requestPromise===a&&(r.requestPromise=null,r.requestAbort=null)};return r.requestPromise=a,a.then(o,o),!0}get isLeaf(){return null==this._children[0]}hasLij(e){return this.lij[0]===e[0]&&this.lij[1]===e[1]&&this.lij[2]===e[2]}findByLij(e){if(this.hasLij(e))return this;if(this.isLeaf)return null;const t=this._children[0].findByLij(e)||this._children[1].findByLij(e)||this._children[2].findByLij(e)||this._children[3].findByLij(e);return t||null}distanceToSquared(e){return d(l(H,this._center[1],e))}containsPoint(e){const t=this.extent;return e[0]>=t[0]&&e[1]>=t[1]&&e[0]<=t[2]&&e[1]<=t[3]}unrequestLayerData(e,t,i){const s=this.layerInfo[t][e],n=s.waitingAgents,r=null!=n.removeUnordered(i);N(r,"agent has not requested this piece of map data"),n.length<1&&(s.abortRequest(),this._updateMemoryUsed())}dataArrived(e,t,i){const s=this.layerInfo[t][e];s.data=i,s.dataInvalidated=!1,s.waitingAgents.forAll((e=>e.dataArrived(this))),s.waitingAgents.clear(),this._updateMemoryUsed()}dataMissing(e,t,i){i.notInTilemap||console.error(`Tile ${this.lij.toString()} layer ${t}/${e} error ${i}`);const s=this.layerInfo[t][e];s.dataMissing=!0,s.waitingAgents.forAll((e=>e.dataMissing())),s.waitingAgents.clear(),this._updateMemoryUsed()}updateRenderData(e){switch(e){case 1:return this.updateTexture();case 0:return this.updateGeometry()}}updateTexture(){this.renderData&&this.setPendingUpdate(64)}updateGeometry(){this.setPendingUpdate(32);for(const e of this.layerInfo[0])e.pendingUpdates|=32}invalidateLayerData(e,t){this.layerInfo[t][e].invalidateSourceData(),this.restartAgents(t)}computeElevationBounds(){M(this._elevationBounds,Number.MAX_VALUE,-Number.MAX_VALUE);const t=this.layerInfo[0];let i=!0;for(const s of t)e(s.elevationBounds)&&(this._elevationBounds[0]=Math.min(this._elevationBounds[0],s.elevationBounds.min),this._elevationBounds[1]=Math.max(this._elevationBounds[1],s.elevationBounds.max),s.elevationBounds.hasNoDataValues||(i=!1));i&&(this._elevationBounds[0]=Math.min(this._elevationBounds[0],0),this._elevationBounds[1]=Math.max(this._elevationBounds[1],0)),this.updateRadiusAndCenter(),this._surface.setTileTreeDirty()}_updateCenter(){const e=.5*(this._elevationBounds[0]+this._elevationBounds[1]);c(H,this.up,e),p(this._center[1],this.centerAtSeaLevel,H),c(H,this.up,this._elevationBounds[0]),p(this._center[0],this.centerAtSeaLevel,H),c(H,this.up,this._elevationBounds[1]),p(this._center[2],this.centerAtSeaLevel,H)}findElevationBoundsForLayer(e,t){const s=this.layerInfo[0][e];if(i(s.elevationBounds)||s.elevationBounds.level<t){const t=this._surface.layerViewByIndex(e,0),n=b(t);if(w(this,n,!1)){const t=Z;let n=!1;if(s.data){const e=s.data;t.min=e.bounds[0],t.max=e.bounds[1],t.hasNoDataValues=e.hasNoDataValues,t.level=this.lij[0],n=!0}else{let i,s,r=0;for(let t=this._parent;t&&(!s||r<I)&&(r=this.vlevel-t.level,i=s||i,s=t.layerInfo[0][e].data,!(!s&&i&&r>=I));t=t._parent);s=s||i,s&&(s.computeMinMaxValue(this.lij[0],this.lij[1],this.lij[2],t),t.min!==1/0&&(t.level=s.level,n=!0))}n&&(i(s.elevationBounds)&&(s.elevationBounds=new R),s.elevationBounds.copyFrom(t))}}}modifyLayers(e,t,i){const s=this.layerInfo[i];for(const a of s)a.loadingAgent&&a.loadingAgent!==E&&(Q(a.loadingAgent),a.loadingAgent=null),a.waitingAgents.clear();for(let a=0;a<s.length;++a)void 0===e[a]&&s[a].release();const n=new Array(...s),r=t.length;s.length=r;for(let a=0;a<r;a++){const e=t[a];s[a]=e>-1?n[e]:k.acquire(this._surface.upsampleInfoPool)}this._updateMemoryUsed()}restartAgents(e){this.renderData&&(this._createOrUpdateAgents(0,e),this.updateRenderData(e))}updateAgents(e){if(this.renderData){const t=this.layerInfo[e];for(const e of t)e.loadingAgent===E&&(e.loadingAgent=null);this._createOrUpdateAgents(0,e)}}updateAgentSuspension(){for(const e of j){const t=this.isSuspended(e);for(const i of this.layerInfo[e])i.loadingAgent&&i.loadingAgent!==E&&(i.loadingAgent.setSuspension(t),i.loadingAgent===E&&this.updateRenderData(e))}}removeLayerAgent(e,t){const i=this.layerInfo[t][e];i.loadingAgent&&i.loadingAgent!==E&&i.loadingAgent.dispose(),i.loadingAgent=null}agentDone(e,t){const i=this.layerInfo[t][e];i.loadingAgent=E,i.data||i.upsampleInfo||this._createOrUpdateAgents(e+1,t)}_createOrUpdateAgents(e,t){const i=this.isSuspended(t),s=this.layerInfo[t];for(let n=e;n<s.length;++n){const e=s[n];let r=!1;const a=this._surface.layerViewByIndex(n,t),o=b(a);if(e.loadingAgent?w(this,o,!1)?(e.loadingAgent!==E&&e.loadingAgent.setSuspension(i),e.loadingAgent!==E&&(r=e.loadingAgent.update())):e.dispose():w(this,o,!1)&&(e.loadingAgent=Y(this,n,t,i),r=e.loadingAgent.startLoading(),r?e.loadingAgent===E&&this.setPendingUpdate(32):(Q(e.loadingAgent),e.loadingAgent=E)),e.loadingAgent===E&&this.updateRenderData(t),r&&a.isOpaque)return}}isWithinExtent(e){const t=this.extent;return t[0]>=e[0]&&e[2]>=t[2]&&t[1]>=e[1]&&e[3]>=t[3]}intersectsExtent(e){const t=this.extent;return t[2]>=e[0]&&e[2]>=t[0]&&t[3]>=e[1]&&e[3]>=t[1]}get test(){return{cachedMemory:this.cachedMemory}}}function Y(e,t,i,s){const n=0===i?K.acquire():J.acquire();return n.init(e,t,i,s),n}function Q(e){e.dispose(),e instanceof V?K.release(e):e instanceof W&&J.release(e)}const J=new s(W),K=new s(V),Z=new R,ee=-1;export default $;export{X as SplitLimits};
