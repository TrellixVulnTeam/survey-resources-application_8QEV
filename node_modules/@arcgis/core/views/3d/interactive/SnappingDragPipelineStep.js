/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{isNone as e,abortMaybe as t,unwrap as n,isSome as r}from"../../../core/maybe.js";import{createTask as a}from"../../../core/promiseUtils.js";import{Task as o,ImmediateTask as i}from"../../support/Scheduler.js";import{pointEquals as p}from"../../../layers/graphics/dehydratedFeatureComparison.js";import{SnappingContext as s}from"../../interactive/snapping/SnappingContext.js";import{EventPipeline as c}from"../../interactive/dragEventPipeline.js";class l{constructor(){this.next=new c}createSnapDragEventPipelineStep({predicate:l=(()=>!0),cancel:d,snappingManager:m,snappingContext:u}){if(e(m))return e=>e;let x=null,y=null;const f=()=>{x=t(x),m.doneSnapping(),r(y)&&y.frameTask.remove(),y=null};return d.next((e=>(f(),e))),this.next=new c,e=>{if(!l(e))return e;if(x=t(x),"start"===e.action){const t="3d"===m.view.type?m.view.resourceController.scheduler.registerTask(o.SNAPPING,(e=>n(t).processQueue(e)),(()=>!1)):i;y={context:new s({geometry:u.geometry,elevationInfo:u.elevationInfo,pointer:u.pointer,vertexHandle:r(e.info)?e.info.handle:null,excludeFeature:u.excludeFeature,visualizer:u.visualizer}),originalPos:r(e.snapOrigin)?u.coordinateHelper.createDehydratedPoint(e.snapOrigin):e.mapStart,frameTask:t}}if(r(y)){const t=y.context.coordinateHelper.createDehydratedPoint(y.context.coordinateHelper.fromArray([y.originalPos.x,y.originalPos.y,y.originalPos.z]));t.x+=e.mapEnd.x-e.mapStart.x,t.y+=e.mapEnd.y-e.mapStart.y;const n=e.mapStart.x-y.originalPos.x,r=e.mapStart.y-y.originalPos.y,o={...e,action:"udpate"},i=y.context,s=m.update(t,y.context);if(e.mapEnd.x=s.x+n,e.mapEnd.y=s.y+r,"end"!==e.action){const e=y.frameTask;x=a((async a=>{const c=await e.schedule((()=>m.snap(t,i,a)),a);if(c.valid){const t=await e.schedule((()=>c.apply()),a);p(t,s)||(o.mapEnd.x=t.x+n,o.mapEnd.y=t.y+r,this.next.execute(o))}}))}}return"end"===e.action&&f(),e}}}export{l as SnappingPipeline};
