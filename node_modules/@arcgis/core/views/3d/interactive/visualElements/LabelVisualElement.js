/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{isSome as t,unwrap as e}from"../../../../core/maybe.js";import{createRenderScreenPointArray as s,createRenderScreenPointArray3 as i,createScreenPointArray as o}from"../../../../core/screenUtils.js";import{c as r}from"../../../../chunks/vec3f64.js";import{b as a}from"../../../../chunks/vec3.js";import n from"../../../../core/Handles.js";import{n as h,h as c,e as m,a as l,s as _,l as u,d as p}from"../../../../chunks/vec2.js";import{VisualElement as d}from"./VisualElement.js";import{screenSpaceTangent as x}from"../measurementTools/support/viewUtils.js";import b from"../../../overlay/LineOverlayItem.js";import v from"../../../overlay/TextOverlayItem.js";class f extends d{constructor(t){super(t.view),this._handles=new n,this._textItem=null,this._calloutItem=null,this._showCallout=!0,this._showText=!0,this._geometry=null,this._text=null,this._fontSize=14,this._distance=25,this._anchor="right",this.applyProps(t)}get geometry(){return this._geometry}set geometry(t){this._geometry=t,this._updateLabelPosition()}get textItem(){return this._textItem}get text(){return this._text}set text(t){this._text=t,this.attached&&(this._textItem.text=this._text)}get fontSize(){return this._fontSize}set fontSize(t){this._fontSize=t,this.attached&&(this._textItem.fontSize=this._fontSize)}get distance(){return this._distance}set distance(t){this._distance!==t&&(this._distance=t,this._updateLabelPosition())}get anchor(){return this._anchor}set anchor(t){this._anchor!==t&&(this._anchor=t,this._updateLabelPosition())}overlaps(t){return this.textItem.visible&&t.textItem.visible&&this.view.overlay.overlaps(this._textItem,t.textItem)}_updateLabelPosition(){if(this.attached){if(this._showText=!1,this._showCallout=!1,t(this.geometry)&&this.view._stage)switch(this.geometry.type){case"point":this._computeLabelPositionFromPoint(this.geometry,k)&&(this._textItem.position=[k[0],k[1]],this._textItem.anchor="center",this._showText=!0);break;case"corner":this._computeLabelPositionFromCorner(this.geometry,this._distance,k,z)&&(this._showCallout=this._updatePosition(k,z),this._showText=!0);break;case"segment":this._computeLabelPositionFromSegment(this.geometry,this._distance,this._anchor,k,z)&&(this._showText=!0,this._showCallout=this._updatePosition(k,z))}this.updateVisibility(this.visible)}}_computeLabelPositionFromPoint(t,e){this.view.renderCoordsHelper.toRenderCoords(t,L);const s=this.view._stage.camera;return s.projectToRenderScreen(L,R),!(R[2]<0||R[2]>1)&&(s.renderToScreen(R,e),!0)}_computeLabelPositionFromCorner(t,e,s,i){if(!t)return!1;const o=this.view._stage.camera;return w(t.left,1,o,P),h(P,P),w(t.right,0,o,T),c(j,P,T),h(j,j),m(j,j),o.projectToRenderScreen(t.left.endRenderSpace,R),!(R[2]<0||R[2]>1)&&(o.renderToScreen(R,s),l(j,j,e*o.pixelRatio),c(j,j,R),o.renderToScreen(j,i),!0)}_computeLabelPositionFromSegment(t,e,s,i,o){if(!t)return!1;const r=t.segment,a=this.view._stage.camera;x(r.startRenderSpace,r.endRenderSpace,P,a),_(j,-P[1],P[0]);let n=!1;switch(s){case"top":n=j[1]<0;break;case"bottom":n=j[1]>0;break;case"left":n=j[0]>0;break;case"right":n=j[0]<0}if(n&&h(j,j),0===u(j))switch(s){case"top":j[1]=1;break;case"bottom":j[1]=-1;break;case"left":j[0]=-1;break;case"right":j[0]=1}return r.eval(H[t.sampleLocation],L),a.projectToRenderScreen(L,R),!(R[2]<0||R[2]>1)&&(a.renderToScreen(R,i),l(j,j,e*a.pixelRatio),c(j,j,R),a.renderToScreen(j,o),!0)}_updatePosition(t,e){if(e){const s=e[0]-t[0],i=e[1]-t[1];return this._textItem.position=[e[0],e[1]],this._textItem.anchor=Math.abs(s)>Math.abs(i)?s>0?"left":"right":i>0?"top":"bottom",this._calloutItem.startPosition=[t[0],t[1]],this._calloutItem.endPosition=[e[0],e[1]],!0}return this._textItem.position=[t[0],t[1]],this._textItem.anchor="center",!1}createResources(){this._textItem=new v({visible:!0}),this._textItem.text=e(this._text),this._textItem.fontSize=this._fontSize,this._calloutItem=new b({visible:!0,width:2}),this._updateLabelPosition(),this.view.overlay.items.addMany([this._textItem,this._calloutItem]),this._handles.add(this.view.state.watch("camera",(()=>{this._updateLabelPosition()})))}destroyResources(){this.view.overlay&&!this.view.overlay.destroyed&&this.view.overlay.items.removeMany([this._textItem,this._calloutItem]),this._handles.removeAll()}updateVisibility(t){this._textItem.visible=this._showText&&t,this._calloutItem.visible=this._showCallout&&t}}function w(t,e,s,i){t.eval(e,I,S),a(y,I,S),s.projectToRenderScreen(I,C),s.projectToRenderScreen(y,M),p(i,V,F),m(i,i)}function g(t){switch(t){case"top":return"bottom";case"right":return"left";case"bottom":return"top";case"left":return"right"}}const I=r(),y=r(),S=r(),P=s(),T=s(),j=s(),L=r(),R=i(),k=o(),z=o(),C=i(),F=C,M=i(),V=M,H={start:0,center:.5,end:1};export{f as LabelVisualElement,g as mirrorPosition,w as screenSpaceTangent};
