/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../../chunks/tslib.es6.js";import"../../../../../core/has.js";import{unwrapOr as t,isSome as i,isNone as r,unwrap as s}from"../../../../../core/maybe.js";import"../../../../../core/Logger.js";import"../../../../../core/accessorSupport/ensureType.js";import{property as a}from"../../../../../core/accessorSupport/decorators/property.js";import{subclass as n}from"../../../../../core/accessorSupport/decorators/subclass.js";import"../../../../../core/urlUtils.js";import"../../../../../core/uuid.js";import"../../../../../portal/support/resourceExtension.js";import l from"../../../../../core/Evented.js";import o from"../../../../../Graphic.js";import{init as c}from"../../../../../core/watchUtils.js";import{HandleOwnerMixin as h}from"../../../../../core/HandleOwner.js";import p from"../../../../../layers/GraphicsLayer.js";import{getEffectiveElevationMode as u}from"../../../../../support/elevationInfoUtils.js";import{DrawOperation as d}from"./DrawOperation.js";import{SceneDrawSurface as m,ElevationDrawSurface as y}from"./drawSurfaces.js";import{InteractiveToolBase as v}from"../../../../interactive/InteractiveToolBase.js";import{createViewAlignedCoordinateSystem as g}from"../../../../draw/support/surfaceCoordinateSystems.js";import{settings as _}from"../settings.js";import{OutlineVisualElement as f}from"../../visualElements/OutlineVisualElement.js";import{VerticesVisualElement as V}from"../../visualElements/VerticesVisualElement.js";import{GraphicState as w}from"../../../layers/graphics/GraphicState.js";import{createSquare as G,createRectangle as E,createCircle as O,createEllipse as S,createPolygon as b,createPolyline as j}from"../../../../draw/support/createUtils.js";let C=class extends(h(l.EventedMixin(v))){constructor(e){super(e),this.drawOperation=null,this._createGraphic=null,this._createGraphicState=null,this._outlineVisualElement=null,this._verticesVisualElement=null,this._stagedVerticesVisualElement=null,this.hasZ=!0,this.defaultZ=0,this.elevationInfo=null,this.snapToScene=!1,this.snappingManager=null,this.mode=null,this.geometryType=null,this.type="draw-3d"}initialize(){const e=t(this.elevationInfo,{mode:this.hasZ?"absolute-height":"on-the-ground",offset:0});this._internalGraphicsLayer=new p({elevationInfo:e,listMode:"hide",internal:!0}),this.view.map.layers.add(this._internalGraphicsLayer),this.drawOperation=new d({view:this.view,manipulators:this.manipulators,geometryType:x(this.geometryType),drawingMode:this.mode,hasZ:this.hasZ,defaultZ:this.defaultZ,snapToSceneEnabled:this.snapToScene,snappingDrawSurface:new m(this.view,e,[this._internalGraphicsLayer]),elevationDrawSurface:new y(e,this.defaultZ,this.view,this._internalGraphicsLayer),hasM:!1,elevationInfo:e,snappingManager:this.snappingManager}),this.drawOperation.on("vertex-add",(e=>this.onVertexAdd(e))),this.drawOperation.on("vertex-remove",(e=>this.onVertexRemove(e))),this.drawOperation.on("vertex-update",(e=>this.onVertexUpdate(e))),this.drawOperation.on("cursor-update",(e=>this.onCursorUpdate(e))),this.drawOperation.on("complete",(e=>this.onComplete(e)))}destroy(){this.drawOperation.destroy(),this.drawOperation=null,this._destroyAllVisualisations(),this.view.map.remove(this._internalGraphicsLayer),this._set("view",null)}onInputEvent(e){this.drawOperation.onInputEvent(e)}_getCreateGeometry(e,t=!1){if(null==this.drawOperation)return null;const r=i(e)?e:this.drawOperation.hasStagedVertex?this.drawOperation.numVertices-1:null,s=this.drawOperation.vertices;if(0===s.length)return null;const a=this.drawOperation.spatialReference,n=s,l=n.slice(),o=[];i(r)&&(l.splice(r,1),o.push(n[r]));const c={regularVertices:null,stagedVertices:null,full:null,outline:null},h="3d"===this.view.type&&"global"===this.view.viewingMode;switch(this.geometryType){case"point":c.regularVertices=l,c.stagedVertices=o,c.full=this.drawOperation.coordinateHelper.createPointFromArray(s[0]);break;case"polyline":c.regularVertices=l,c.stagedVertices=o,n.length>0&&(c.full=j([n],a,h));break;case"polygon":c.regularVertices=l,c.stagedVertices=o,n.length>0&&(c.full=b([n],a,h,!0));break;case"circle":if(n.length>0){const e=g(this.view,s[0]);if(1===n.length&&t){const t=n[0],i=e.makeMapPoint(t[0]+I*this.view.resolution,t[1]);c.full=O([t,i],e,!0)}else 2===n.length&&(c.full=this.forceUniformSize?O(s,e,this.centered):S(s,e,this.centered))}break;case"rectangle":if(n.length>0){const e=g(this.view,s[0]);if(1===n.length&&t){const t=n[0],i=e.makeMapPoint(t[0]+I*this.view.resolution,t[1]);c.full=G([t,i],e,!0)}else 2===n.length&&(c.full=this.forceUniformSize?G(s,e,this.centered):E(s,e,this.centered))}break;default:return null}switch(this.geometryType){case"point":break;case"polyline":n.length>1&&(c.outline=j([n],a,h));break;case"polygon":n.length>1&&(c.outline=b([n],a,h));break;case"circle":case"rectangle":i(c.full)&&"polygon"===c.full.type&&(c.outline=b(c.full.rings,a,h))}return c}_destroyAllVisualisations(){this._destroyCreateGraphic(),this._destroyOutlineVisualElement(),this._destroyVerticesVisualElement(),this._destroyStagedVerticesVisualElement()}_destroyCreateGraphic(){i(this._createGraphic)&&(this._internalGraphicsLayer.remove(this._createGraphic),this._createGraphic.destroy(),this._createGraphic=null),this._createGraphicState=null,this.handles.remove(T)}_destroyOutlineVisualElement(){i(this._outlineVisualElement)&&(this._outlineVisualElement.destroy(),this._outlineVisualElement=null)}_destroyVerticesVisualElement(){i(this._verticesVisualElement)&&(this._verticesVisualElement.destroy(),this._verticesVisualElement=null)}_destroyStagedVerticesVisualElement(){i(this._stagedVerticesVisualElement)&&(this._stagedVerticesVisualElement.destroy(),this._stagedVerticesVisualElement=null)}_updateCreateGraphic(e=null){const t=this._getCreateGeometry(e);if(r(t))return void this._destroyAllVisualisations();const a=this._internalGraphicsLayer.elevationInfo;i(t.outline)?r(this._outlineVisualElement)?(this._outlineVisualElement=new f({view:this.view,geometry:t.outline,elevationInfo:s(a),isDraped:i(this._createGraphicState)?this._createGraphicState.isDraped:"on-the-ground"===u(this.hasZ,a),attached:!1}),_.visualElements.lineGraphics.outline.apply(this._outlineVisualElement),_.visualElements.lineGraphics.shadowStyle.apply(this._outlineVisualElement),this._outlineVisualElement.attached=!0,this._outlineVisualElement.laserlineEnabled=!0):this._outlineVisualElement.geometry=t.outline:this._destroyOutlineVisualElement(),i(t.regularVertices)?r(this._verticesVisualElement)?(this._verticesVisualElement=new V({view:this.view,spatialReference:this.view.spatialReference,vertices:t.regularVertices,elevationInfo:s(this._internalGraphicsLayer.elevationInfo),renderOccluded:_.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._verticesVisualElement.attached=!0):this._verticesVisualElement.vertices=t.regularVertices:this._destroyVerticesVisualElement(),i(t.stagedVertices)?r(this._stagedVerticesVisualElement)?(this._stagedVerticesVisualElement=new V({view:this.view,spatialReference:this.view.spatialReference,vertices:t.stagedVertices,elevationInfo:s(this._internalGraphicsLayer.elevationInfo),renderOccluded:_.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._stagedVerticesVisualElement.color=_.colorToVec4(_.reshapeManipulators.selected.color),this._stagedVerticesVisualElement.attached=!0):this._stagedVerticesVisualElement.vertices=t.stagedVertices:this._destroyStagedVerticesVisualElement(),i(t.full)?r(this._createGraphic)?(this._createGraphic=new o({geometry:t.full,symbol:this.createGraphicSymbol}),this._internalGraphicsLayer.add(this._createGraphic),this.view.maskOccludee(this._createGraphic),this._createGraphicState=new w({graphic:this._createGraphic}),this.handles.add([this.view.trackGraphicState(this._createGraphicState),c(this._createGraphicState,"isDraped",(e=>{i(this._outlineVisualElement)&&(this._outlineVisualElement.isDraped=e)}))],T),this.notifyChange("createGraphic")):this._createGraphic.geometry=t.full:this._destroyCreateGraphic()}get createGraphic(){return this._createGraphic}set enabled(e){this.drawOperation.interactive=e,this._set("enabled",e)}set centered(e){this._set("centered",e),this._updateCreateGraphic()}set forceUniformSize(e){this._set("forceUniformSize",e),this._updateCreateGraphic()}reset(){}get canRedo(){return this.drawOperation.canRedo}redo(){this.drawOperation.redo()}get canUndo(){return this.drawOperation.canUndo}undo(){this.drawOperation.undo()}completeCreateOperation(){this.drawOperation.complete()}activate(){}deactivate(){this.drawOperation.isCompleted||this.drawOperation.cancel()}getVertexCoords(){return this.drawOperation.vertices}onVertexAdd(e){this._updateCreateGraphic(),this.emit("vertex-add",e)}onVertexRemove(e){this._updateCreateGraphic(),this.emit("vertex-remove",e)}onVertexUpdate(e){this._updateCreateGraphic(),this.emit("vertex-update",e)}onCursorUpdate(e){this._updateCreateGraphic(1===e.vertices.length?e.vertices[0].vertexIndex:null),this.emit("cursor-update",e)}onComplete(e){this._updateCreateGraphic();let t=null;if(this.drawOperation.isCompleted){const e=this._getCreateGeometry(null,!0);i(e)&&(t=new o({geometry:e.full,symbol:this.createGraphicSymbol}))}this.emit("complete",{graphic:t,...e})}};function x(e){switch(e){case"point":case"polyline":case"polygon":return e;case"circle":case"rectangle":return"segment";default:return null}}e([a({constructOnly:!0,nonNullable:!0})],C.prototype,"view",void 0),e([a()],C.prototype,"createGraphicSymbol",void 0),e([a()],C.prototype,"createGraphic",null),e([a({value:!0})],C.prototype,"enabled",null),e([a({value:!0})],C.prototype,"centered",null),e([a({value:!0})],C.prototype,"forceUniformSize",null),e([a({constructOnly:!0})],C.prototype,"hasZ",void 0),e([a({nonNullable:!0})],C.prototype,"defaultZ",void 0),e([a({constructOnly:!0})],C.prototype,"elevationInfo",void 0),e([a()],C.prototype,"snapToScene",void 0),e([a()],C.prototype,"snappingManager",void 0),e([a({constructOnly:!0})],C.prototype,"mode",void 0),e([a({constructOnly:!0})],C.prototype,"geometryType",void 0),e([a({readOnly:!0})],C.prototype,"type",void 0),C=e([n("esri.views.3d.interactive.editingTools.draw3D.DrawTool")],C);const I=48,T="create-graphic";export{C as DrawGraphicTool};
