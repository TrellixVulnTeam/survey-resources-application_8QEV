/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{_ as t}from"../../../../../chunks/tslib.es6.js";import"../../../../../core/has.js";import{isSome as i,destroyMaybe as e,isNone as a}from"../../../../../core/maybe.js";import"../../../../../core/Logger.js";import"../../../../../core/accessorSupport/ensureType.js";import{makeHandle as o}from"../../../../../core/handleUtils.js";import{property as n}from"../../../../../core/accessorSupport/decorators/property.js";import{subclass as s}from"../../../../../core/accessorSupport/decorators/subclass.js";import"../../../../../core/urlUtils.js";import"../../../../../core/uuid.js";import"../../../../../portal/support/resourceExtension.js";import r from"../../../../../core/Evented.js";import{t as l}from"../../../../../chunks/common.js";import p from"../../../../../core/Handles.js";import{getGraphicEffectiveElevationInfo as h}from"../../../../../support/elevationInfoUtils.js";import{EditGeometry as c}from"../../../../interactive/editGeometry/EditGeometry.js";import{EditGeometryHelper as m}from"../../../../interactive/editGeometry/EditGeometryHelper.js";import{SnappingContext as u}from"../../../../interactive/snapping/SnappingContext.js";import{SnappingPipeline as g}from"../../SnappingDragPipelineStep.js";import{SnappingVisualizer3D as d}from"../../SnappingVisualizer3D.js";import{InteractiveToolBase as v}from"../../../../interactive/InteractiveToolBase.js";import{placeAtGraphic as y}from"../../manipulatorUtils.js";import{canMoveZ as M}from"../manipulatorUtils.js";import{GraphicState as f}from"../../../layers/graphics/GraphicState.js";import{createVisualElements as S}from"../visualElementUtils.js";import{ALIGN_ARROWS_SCALE_THRESHOLD as b}from"../manipulations/config.js";import{MoveManipulation as j}from"../manipulations/MoveManipulation.js";import{GraphicScaleRotateTransform as w}from"./GraphicScaleRotateTransform.js";let R=class extends(r.EventedMixin(v)){constructor(t){super(t),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this.type="transform-3d",this.handles=new p,this.scaleRotate=null,this.snappingPipeline=new g}initialize(){this.graphicState=new f({graphic:this.graphic}),this.moveManipulation=new j({tool:this,view:this.view,snapToScene:this.snapToScene,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZ&&M(this.graphic),radius:j.radiusForSymbol(this.graphic.symbol)}),this.moveManipulation.forEachManipulator((t=>this.handles.add(t.events.on("immediate-click",(t=>t.stopPropagation()))))),this.moveManipulation.elevationInfo=h(this.graphic);const t=this.graphic.geometry;if(this.moveManipulation.createGraphicDragPipeline(((e,a,o,n,s)=>(i(t)&&"point"===t.type&&0===e&&(o=o.next(this.snappingPipeline.createSnapDragEventPipelineStep({snappingContext:new u({elevationInfo:h(this.graphic),pointer:s,geometry:new m(c.fromGeometry(t,this.view.viewingMode),"point"),visualizer:new d,excludeFeature:this.graphic}),snappingManager:this.snappingManager,cancel:n}),this.snappingPipeline.next)),o)),this.graphicState,(t=>{const{action:i,graphic:e,dxScreen:a,dyScreen:o}=t,n={graphic:e,dxScreen:a,dyScreen:o};switch(i){case"start":this.emit("graphic-translate-start",n);break;case"update":this.emit("graphic-translate",n);break;case"end":this.emit("graphic-translate-stop",n)}})),this.moveManipulation.angle=this.symbolRotationAngle,this.enableScaling||this.enableRotation){const t=this.enableScaling&&this.enableRotation?null:this.enableScaling?"scale":"rotate";this.scaleRotate=new w({tool:this,mode:t}),this.handles.add(this.scaleRotate.events.on("scale-changed",(()=>this.onScaleChanged())))}this.handles.add([S({view:this.view,graphic:this.graphic,forEachManipulator:t=>this.forEachManipulator(t),onManipulatorsChanged:()=>o()}),this.graphic.watch("symbol",(()=>this.updateMoveAngle())),this.graphicState.on("changed",(()=>this.onGeometryChanged())),this.hideManipulatorsForGraphicState(),this.view.watch("scale",(()=>this.updateMoveAngle()))]),this.handles.add(this.view.trackGraphicState(this.graphicState)),this.onGeometryChanged()}forEachManipulator(t){this.moveManipulation.forEachManipulator(t),i(this.scaleRotate)&&this.scaleRotate.forEachManipulator(t)}hideManipulatorsForGraphicState(){return this.graphicState.watch("displaying",(t=>{this.forEachManipulator((i=>i.available=t)),this.moveManipulation.zManipulation.available=t&&this.enableZ&&M(this.graphic)}))}destroy(){this.handles.destroy(),this.moveManipulation.destroy(),this.scaleRotate=e(this.scaleRotate),this._set("view",null),this._set("graphic",null)}set snapToScene(t){this.moveManipulation&&(this.moveManipulation.snapToScene=t),this._set("snapToScene",t)}get symbolRotationAngle(){const t=this.graphic.symbol;if(t){const i=t.symbolLayers.find((t=>"object"===t.type)),e=i&&i.heading||0;return l(-e)}return 0}reset(){}onDetach(){i(this.scaleRotate)&&this.scaleRotate.cancelActiveAnimation()}onHide(){i(this.scaleRotate)&&this.scaleRotate.cancelActiveAnimation()}onScaleChanged(){if(a(this.scaleRotate))return;const t=this.scaleRotate.getScale();this.moveManipulation.displayScale=t}updateMoveAngle(){"local"===this.view.viewingMode||this.view.scale<b?this.moveManipulation.angle=this.symbolRotationAngle:this.moveManipulation.angle=0}onGeometryChanged(){y(this.view,this.moveManipulation,this.graphic)}get test(){return{discManipulator:this.moveManipulation.xyManipulation.test.discManipulator,ringManipulator:i(this.scaleRotate)?this.scaleRotate.test.ringManipulator:null,arrowManipulators:this.moveManipulation.xyAxisManipulation.test.arrowManipulators}}};t([n({constructOnly:!0,nonNullable:!0})],R.prototype,"view",void 0),t([n({constructOnly:!0,nonNullable:!0})],R.prototype,"graphic",void 0),t([n({constructOnly:!0,nonNullable:!0})],R.prototype,"enableZ",void 0),t([n()],R.prototype,"enableRotation",void 0),t([n()],R.prototype,"enableScaling",void 0),t([n({value:!1})],R.prototype,"snapToScene",null),t([n({constructOnly:!0})],R.prototype,"snappingManager",void 0),t([n({readOnly:!0})],R.prototype,"type",void 0),R=t([s("esri.views.3d.interactive.editingTools.graphicTransform3D.GraphicTransformTool")],R);export{R as GraphicTransformTool};
