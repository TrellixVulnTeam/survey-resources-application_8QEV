/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{isSome as e,isNone as t}from"../../../core/maybe.js";import{b as o}from"../../../chunks/mat4f64.js";import{DefaultErrorContext as r}from"./DefaultErrorContext.js";import{makeMaterialParameters as s,makeTextureSource as a}from"./LoaderResult.js";import{Resource as i}from"./internal/Resource.js";let n=0;async function l(r,s,a={},l=!0){const d=await i.load(r,f,s,a),x="gltf_"+n++,h={lods:[],materials:new Map,textures:new Map,meta:c(d)},w=!(!d.json.asset.extras||"symbolResource"!==d.json.asset.extras.ESRI_type);return await m(d,(async(r,s,i,n)=>{const c=void 0!==r.mode?r.mode:4,m=u(c);if(t(m))return void f.warnUnsupported("Unsupported primitive mode ("+T[c]+"). Skipping primitive.");if(!d.hasPositions(r))return void f.warn("Skipping primitive without POSITION vertex attribute.");const w=await d.getMaterial(r,a,l),S={transform:o(s),attributes:{position:await d.getPositionData(r,a),normal:null,texCoord0:null,color:null,tangent:null},indices:await d.getIndexData(r,a),primitiveType:m,material:p(h,w,x)};d.hasNormals(r)&&(S.attributes.normal=await d.getNormalData(r,a)),d.hasTangents(r)&&(S.attributes.tangent=await d.getTangentData(r,a)),d.hasTextureCoordinates(r)&&(S.attributes.texCoord0=await d.getTextureCoordinates(r,a)),d.hasVertexColors(r)&&(S.attributes.color=await d.getVertexColors(r,a));let g=null;e(h.meta)&&e(h.meta.ESRI_lod)&&"screenSpaceRadius"===h.meta.ESRI_lod.metric&&(g=h.meta.ESRI_lod.thresholds[i]),h.lods[i]=h.lods[i]||{parts:[],name:n,lodThreshold:g},h.lods[i].parts.push(S)})),{model:h,meta:{isEsriSymbolResource:w,uri:d.uri},customMeta:{}}}function u(e){switch(e){case 4:case 5:case 6:return e;default:return null}}function c(t){const o=t.json;let r=null;return o.nodes.forEach((t=>{const o=t.extras;e(o)&&(o.ESRI_proxyEllipsoid||o.ESRI_lod)&&(r=o)})),r}async function m(e,t){const o=e.json,r=o.scenes[o.scene||0].nodes,s=r.length>1;for(const i of r){const e=o.nodes[i],t=[a(i,0)];if(d(e)&&!s){const o=e.extensions.MSFT_lod.ids;t.push(...o.map(((e,t)=>a(e,t+1))))}await Promise.all(t)}async function a(r,s){const i=o.nodes[r],n=e.getNodeTransform(r);if(f.warnUnsupportedIf(null!=i.weights,"Morph targets are not supported."),null!=i.mesh){const e=o.meshes[i.mesh];for(const o of e.primitives)await t(o,n,s,e.name)}for(const e of i.children||[])await a(e,s)}}function d(e){return e.extensions&&e.extensions.MSFT_lod&&Array.isArray(e.extensions.MSFT_lod.ids)}function p(e,t,o){const r=t=>{const r=`${o}_tex_${t&&t.id}${t&&t.name?"_"+t.name:""}`;if(t&&!e.textures.has(r)){const o=a(t.data,{wrap:{s:x(t.wrapS),t:x(t.wrapT)},mipmap:h.some((e=>e===t.minFilter)),noUnpackFlip:!0});e.textures.set(r,o)}return r},i=`${o}_mat_${t.id}_${t.name}`;if(!e.materials.has(i)){const o=s({color:[t.color[0],t.color[1],t.color[2]],opacity:t.color[3],alphaMode:t.alphaMode,alphaCutoff:t.alphaCutoff,doubleSided:t.doubleSided,colorMixMode:t.ESRI_externalColorMixMode,textureColor:t.colorTexture?r(t.colorTexture):void 0,textureNormal:t.normalTexture?r(t.normalTexture):void 0,textureOcclusion:t.occlusionTexture?r(t.occlusionTexture):void 0,textureEmissive:t.emissiveTexture?r(t.emissiveTexture):void 0,textureMetallicRoughness:t.metallicRoughnessTexture?r(t.metallicRoughnessTexture):void 0,emissiveFactor:[t.emissiveFactor[0],t.emissiveFactor[1],t.emissiveFactor[2]],metallicFactor:t.metallicFactor,roughnessFactor:t.roughnessFactor});e.materials.set(i,o)}return i}function x(e){if(33071===e||33648===e||10497===e)return e;f.error(`Unexpected TextureSampler WrapMode: ${e}`)}const f=new r,h=[9987,9985],T=["POINTS","LINES","LINE_LOOP","LINE_STRIP","TRIANGLES","TRIANGLE_STRIP","TRIANGLE_FAN"];export{l as load};
