/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{isSome as e,isNone as t,disposeMaybe as i}from"../../../core/maybe.js";import{deg2rad as n}from"../../../core/mathUtils.js";import{c as s}from"../../../chunks/vec3f64.js";import{g as r,i as a,k as h,n as l,c,b as o}from"../../../chunks/vec3.js";import{a as _}from"../../../chunks/vec2f64.js";import{a as d}from"../../../chunks/vec4f64.js";import{t as p}from"../../../chunks/vec4.js";import{lineSegment as m,plane as f,sphere as g,clipRay as u,ray as b,frustum as P}from"./geometryUtils.js";import{inverseProjectionInfo as V}from"../webgl-engine/lib/Util.js";import{createQuadVAO as E}from"../webgl-engine/lib/glUtil3D.js";import{copyParameters as q,updateParameters as D}from"../webgl-engine/materials/internal/MaterialUtil.js";import{LaserlinePathTechniqueConfiguration as L,LaserlinePathTechnique as S}from"../webgl-engine/shaders/LaserlinePathTechnique.js";import{LaserlinePathData as R}from"./LaserlinePathData.js";import{LaserlineTechniqueConfiguration as U,LaserlineTechnique as x}from"../webgl-engine/shaders/LaserlineTechnique.js";const M=s(),T=d(),C={glowColor:[1,.5,0],glowWidth:8,glowFalloff:8,innerColor:[1,1,1],innerWidth:1,globalAlpha:.75,angleCutoff:n(6),globalAlphaContrastBoost:2};function v(e,t,i,n){const s=M,h=T;a(s,t,n),r(h,i),h[3]=0,p(h,h,n),f.fromPositionAndNormal(s,h,e)}class A{constructor(e,t={},i={contrastControlEnabled:!1}){this._renderCoordsHelper=e,this._config=i,this._technique=null,this._projInfo=d(),this._zScale=_(),this._heightManifoldEnabled=!1,this._heightManifoldTarget=s(),this._pointDistanceEnabled=!1,this._pointDistanceOrigin=s(),this._pointDistanceTarget=s(),this._lineVerticalPlaneEnabled=!1,this._lineVerticalPlaneSegment=m.create(),this._intersectsLineEnabled=!1,this._intersectsLineSegment=m.create(),this._intersectsLineRadius=3,this._intersectsLineInfinite=!1,this._pathVerticalPlaneEnabled=!1,this._pathVerticalPlaneData=null,this._pathTechnique=null,this.canRender=!0,this._tempNormal=s(),this._tempDir=s(),this._tempUp=s(),this._tempVec3A=s(),this._tempVec3B=s(),this._tempVec4=d(),this._tempPlane=f.create(),this._tempSphere=g.create(),this._params=q(t,C)}get renderSlots(){return[this._config.contrastControlEnabled?17:16]}get needsLinearDepth(){return!0}get heightManifoldEnabled(){return this._heightManifoldEnabled}set heightManifoldEnabled(e){this._heightManifoldEnabled!==e&&(this._heightManifoldEnabled=e,this._requestRender())}get heightManifoldTarget(){return this._heightManifoldTarget}set heightManifoldTarget(e){r(this._heightManifoldTarget,e),this._requestRender()}get pointDistanceEnabled(){return this._pointDistanceEnabled}set pointDistanceEnabled(e){e!==this._pointDistanceEnabled&&(this._pointDistanceEnabled=e,this._requestRender())}get pointDistanceTarget(){return this._pointDistanceTarget}set pointDistanceTarget(e){r(this._pointDistanceTarget,e),this._requestRender()}get pointDistanceOrigin(){return this._pointDistanceOrigin}set pointDistanceOrigin(e){r(this._pointDistanceOrigin,e),this._requestRender()}get lineVerticalPlaneEnabled(){return this._lineVerticalPlaneEnabled}set lineVerticalPlaneEnabled(e){e!==this._lineVerticalPlaneEnabled&&(this._lineVerticalPlaneEnabled=e,this._requestRender())}get lineVerticalPlaneSegment(){return this._lineVerticalPlaneSegment}set lineVerticalPlaneSegment(e){m.copy(e,this._lineVerticalPlaneSegment),this._requestRender()}get intersectsLineEnabled(){return this._intersectsLineEnabled}set intersectsLineEnabled(e){e!==this._intersectsLineEnabled&&(this._intersectsLineEnabled=e,this._requestRender())}get intersectsLineSegment(){return this._intersectsLineSegment}set intersectsLineSegment(e){m.copy(e,this._intersectsLineSegment),this._requestRender()}get intersectsLineRadius(){return this._intersectsLineRadius}set intersectsLineRadius(e){e!==this._intersectsLineRadius&&(this._intersectsLineRadius=e,this._requestRender())}get intersectsLineInfinite(){return this._intersectsLineInfinite}set intersectsLineInfinite(e){e!==this._intersectsLineInfinite&&(this._intersectsLineInfinite=e,this._requestRender())}get pathVerticalPlaneEnabled(){return this._pathVerticalPlaneEnabled}set pathVerticalPlaneEnabled(t){t!==this._pathVerticalPlaneEnabled&&(this._pathVerticalPlaneEnabled=t,e(this._pathVerticalPlaneData)&&this._requestRender())}set pathVerticalPlaneVertices(e){t(this._pathVerticalPlaneData)&&(this._pathVerticalPlaneData=new R(this._renderCoordsHelper)),this._pathVerticalPlaneData.vertices=e,this.pathVerticalPlaneEnabled&&this._requestRender()}set pathVerticalPlaneBuffers(e){t(this._pathVerticalPlaneData)&&(this._pathVerticalPlaneData=new R(this._renderCoordsHelper)),this._pathVerticalPlaneData.buffers=e,this.pathVerticalPlaneEnabled&&this._requestRender()}setParameterValues(e){D(this._params,e)&&this._requestRender()}initializeRenderContext(e){this._context=e;const t=e.renderContext.rctx;this._quadVAO=E(t),this._techniqueRepository=e.shaderTechniqueRep,this._techniqueConfig=new U,this._pathTechniqueConfig=new L}uninitializeRenderContext(){this._quadVAO=i(this._quadVAO),this._techniqueRepository.release(this._technique),this._technique=null,this._pathVerticalPlaneData=i(this._pathVerticalPlaneData),this._techniqueRepository.release(this._pathTechnique),this._pathTechnique=null}render(e){const t=this.heightManifoldEnabled||this.pointDistanceEnabled||this.lineVerticalPlaneSegment||this.intersectsLineEnabled,i=this.pathVerticalPlaneEnabled;if(!t&&!i)return!0;const n=e.camera;return V(n.projectionMatrix,n.fullWidth,n.fullHeight,this._projInfo,this._zScale),t&&this.renderUnified(e),i&&this.renderPath(e),!0}renderUnified(e){const t=e.rctx,i=this._selectTechnique(),n=i.program;t.bindProgram(n),i.bindPipelineState(t),this.bindGlobalUniforms(e,n),this.bindHeightManifoldUniforms(e,n),this.bindPointDistanceUniforms(e,n),this.bindLineVerticalPlaneUniforms(e,n),this.bindIntersectsLineUniforms(e,n),i.bind(this._params,e.camera),t.bindVAO(this._quadVAO),t.drawArrays(5,0,4)}renderPath(e){if(t(this._pathVerticalPlaneData))return;this._pathTechniqueConfig.contrastControlEnabled=this._config.contrastControlEnabled,this._pathTechnique=this._techniqueRepository.acquireAndReleaseExisting(S,this._pathTechniqueConfig,this._pathTechnique);const i=e.rctx,n=this._pathTechnique,s=n.program;i.bindProgram(s),n.bindPipelineState(i),this.bindGlobalUniforms(e,s),n.bind(this._params,this._pathVerticalPlaneData.origin,e.camera),this._pathVerticalPlaneData.draw(e.rctx)}bindHeightManifoldUniforms(e,t){if(!this.heightManifoldEnabled)return;const i=this._tempVec3A,n=this._tempPlane;this._renderCoordsHelper.worldUpAtPosition(this._heightManifoldTarget,i),v(n,this._heightManifoldTarget,i,e.camera.viewMatrix),t.setUniform4fv("heightPlane",n)}bindPointDistanceUniforms(e,t){if(!this._pointDistanceEnabled)return;const i=e.camera,n=this._tempSphere;r(n,this._pointDistanceOrigin),a(n,n,i.viewMatrix),n[3]=h(this._pointDistanceOrigin,this._pointDistanceTarget),t.setUniform4f("pointDistanceSphere",n[0],n[1],n[2],n[3])}bindLineVerticalPlaneUniforms(e,t){if(!this._lineVerticalPlaneEnabled)return;const i=this._renderCoordsHelper,n=e.camera,s=this._tempPlane,h=this._tempVec3A,_=this._tempUp,d=this._tempDir,p=this._tempNormal;m.pointAt(this._lineVerticalPlaneSegment,.5,h),i.worldUpAtPosition(h,_),l(d,this._lineVerticalPlaneSegment.vector),c(p,_,d),l(p,p),v(s,this._lineVerticalPlaneSegment.origin,p,n.viewMatrix),t.setUniform4fv("lineVerticalPlane",s);const f=this._tempVec3A;r(f,this._lineVerticalPlaneSegment.origin),i.setAltitude(0,f),a(f,f,n.viewMatrix),t.setUniform3fv("lineVerticalStart",f);const g=this._tempVec3B;o(g,this._lineVerticalPlaneSegment.origin,this._lineVerticalPlaneSegment.vector),i.setAltitude(0,g),a(g,g,n.viewMatrix),t.setUniform3fv("lineVerticalEnd",g)}bindIntersectsLineUniforms(e,t){if(!this._intersectsLineEnabled)return;const i=j,n=I;if(this._intersectsLineInfinite){const t=e.camera;if(u.fromRay(b.wrap(this._intersectsLineSegment.origin,this._intersectsLineSegment.vector),w),w.c0=-Number.MAX_VALUE,!P.intersectClipRay(t.frustum,w))return;u.getStart(w,i),u.getEnd(w,n)}else r(i,this._intersectsLineSegment.origin),o(n,this._intersectsLineSegment.origin,this._intersectsLineSegment.vector);const s=this._tempVec3A;a(s,i,e.camera.viewMatrix),t.setUniform3fv("intersectsLineStart",s);const h=this._tempVec4;r(h,this._intersectsLineSegment.vector),this._tempVec4[3]=0,p(this._tempVec4,this._tempVec4,e.camera.viewMatrix),a(n,n,e.camera.viewMatrix),t.setUniform3fv("intersectsLineEnd",n),l(h,h),t.setUniform3f("intersectsLineDirection",h[0],h[1],h[2]),t.setUniform1f("intersectsLineRadius",this._intersectsLineRadius)}bindGlobalUniforms(e,t){const i=e.camera;t.setUniform4fv("projInfo",this._projInfo),t.setUniform2fv("zScale",this._zScale),t.setUniform2f("nearFar",i.near,i.far),this._heightManifoldEnabled?t.setUniform1f("maxPixelDistance",2*i.computeScreenPixelSizeAt(this._heightManifoldTarget)):this._pointDistanceEnabled?t.setUniform1f("maxPixelDistance",2*i.computeScreenPixelSizeAt(this._pointDistanceTarget)):this._lineVerticalPlaneEnabled&&t.setUniform1f("maxPixelDistance",2*i.computeScreenPixelSizeAt(this._lineVerticalPlaneSegment.origin)),t.setUniform1i("depthMap",0),e.rctx.bindTexture(e.offscreenRenderingHelper.linearDepthTexture,0),t.setUniform1i("frameColor",1),e.rctx.bindTexture(e.offscreenRenderingHelper.mainColorTexture,1)}_requestRender(){this._context&&this._context.requestRender()}_selectTechnique(){return this._techniqueConfig.heightManifoldEnabled=this.heightManifoldEnabled,this._techniqueConfig.lineVerticalPlaneEnabled=this.lineVerticalPlaneEnabled,this._techniqueConfig.pointDistanceEnabled=this.pointDistanceEnabled,this._techniqueConfig.intersectsLineEnabled=this.intersectsLineEnabled,this._techniqueConfig.contrastControlEnabled=this._config.contrastControlEnabled,this._technique=this._techniqueRepository.acquireAndReleaseExisting(x,this._techniqueConfig,this._technique),this._technique}}const w=u.create(),j=s(),I=s();export{A as LaserLineRenderer};
