/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{isSome as t}from"../../../core/maybe.js";import e from"../../../core/Logger.js";import i from"../../../core/Evented.js";import{MemCacheStorage as s,MemCache as a}from"../../../core/MemCache.js";import{isMemoryManagedLayerView as r}from"../layers/support/MemoryManagedLayerView.js";const h=e.getLogger("esri.views.3d.support.MemoryController");function o(t){return new d(t)}const m=1,y=1,n=.75,_=.6,l=1.3;class d{constructor(t){this._view=t,this.events=new i,this.minQuality=.1,this._maxMemory=500,this._additionalCacheMemory=100,this._quality=1,this._stableQuality=0,this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._memoryUsed=0,this._memoryPredicted=0,this._cacheStorage=new s,this._numQualityChanges=0,this._updating=!1}destroy(){this.events=null,this._cacheStorage.destroy()}getMemCache(t,e){return new a(t,this._cacheStorage,e)}set maxMemory(t){null!=t&&t>0&&(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<t&&this._updateQuality(m),this._maxMemory=t)}get maxMemory(){return this._maxMemory}set additionalCacheMemory(t){null!=t&&t>=0&&(this._additionalCacheMemory=t)}disableMemCache(){this._additionalCacheMemory=-4096}get memoryFactor(){return this._quality}get updating(){return this._updating}get usedMemory(){return this._memoryUsed}resetStableQuality(){this._stableQuality=0}update(){if(this._updateMemory(),this._memoryPredicted<=0&&!this._updating)return;let t=this._layersUpdating();if(this._memoryPredicted<_&&this._canFastRecover)this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(m);else if(t)(this._memoryPredicted>1.1*y||this._memoryUsed>y)&&(this._stableQuality>0?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._quality>this.minQuality&&this._downscaleMemoryUsed<this._memoryUsed&&(this._updateQuality(this._quality/l),this._downscaleMemoryUsed=this._memoryUsed,this._canFastRecover=!1));else if(this._downscaleMemoryUsed=0,this._memoryUsed>y)this._stableQuality=0,this._canFastRecover=!1,t=this._updateQuality(this._quality/l),this._downscaleMemoryUsed=this._memoryPredicted;else if(this._stableQuality!==this._quality)if(this._memoryUsed<n&&this._quality<m){this._stableQuality=this._quality;const e=.05;t=this._updateQuality(this._quality+e)}else this._quality<1&&(this._canFastRecover=!0);this.updating!==t&&(this._updating=t,this.events.emit("updating-changed",this.updating))}_updateQuality(t){return(t=Math.min(Math.max(t,this.minQuality),m))!==this._quality&&(this._quality=t,this.events.emit("quality-changed",this._quality),++this._numQualityChanges,!0)}_layersUpdating(){return this._view.allLayerViews.some((t=>!!t.updating))}_updateMemory(){let e=0,i=0;this._view.basemapTerrain&&this._view.basemapTerrain.getUsedMemory&&(e+=this._view.basemapTerrain.getUsedMemory());const s=this._view._stage&&this._view._stage.renderView&&this._view._stage.renderView.edgeView;t(s)&&(e+=s.usedMemory),this._view.allLayerViews&&this._view.allLayerViews.forEach((t=>{if(r(t)){const s=t.ignoresMemoryFactor()?this._quality:1;e+=t.getUsedMemory()*s,i+=t.getUnloadedMemory()*s}}));const a=null==this._warnMemoryUsage||Math.round(10*e)!==Math.round(10*this._warnMemoryUsage),o=1048576*this._maxMemory;if(e>o&&a){this._warnMemoryUsage=e;const t=t=>(t/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB",s=Math.round(100*this._quality);h.warn(`Memory Limit exceeded! Limit: ${t(o)} Current: ${t(e)} Projected: ${t(e+i)} Quality: ${s}%`)}this._memoryUsed=e/o,this._memoryPredicted=(e+i)/o;const m=o-e;this._cacheStorage.maxSize=Math.max(0,m+1048576*this._additionalCacheMemory),this.events.emit("memory-used",this._memoryUsed)}get test(){const t=this;return{cacheStorage:this._cacheStorage,resetQualityChanges:()=>{const e=t._numQualityChanges;return t._numQualityChanges=0,e}}}}export{o as newMemoryController};
