/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import"../../../core/has.js";import{destroyMaybe as r,isNone as t,isSome as s}from"../../../core/maybe.js";import"../../../core/Logger.js";import"../../../core/accessorSupport/ensureType.js";import{property as o}from"../../../core/accessorSupport/decorators/property.js";import{subclass as i}from"../../../core/accessorSupport/decorators/subclass.js";import"../../../core/urlUtils.js";import"../../../core/uuid.js";import"../../../portal/support/resourceExtension.js";import{createResolver as n,isAbortError as a}from"../../../core/promiseUtils.js";import c from"../../../core/Accessor.js";import l from"../../../core/Evented.js";import{ElevationQuery as p}from"../layers/graphics/ElevationQuery.js";let h=class extends(l.EventedMixin(c)){constructor(e){super(e),this.im=new Array,this.ground=new Array,this.scene=new Array,this.handles=new Map}destroy(){this._elevationQuery=r(this._elevationQuery)}get elevationQuery(){return t(this._elevationQuery)&&(this._elevationQuery=new p(this.view.resourceController.scheduler,this.view.spatialReference,(()=>this.view.map&&this.view.map.ground),{maximumAutoTileRequests:4})),this._elevationQuery}getElevation(e,r,s,o,i){let n=null;return n=u(n,this.im,e,r,s,o,i),t(n)&&(n=u(n,this.ground,e,r,s,o,i)),"scene"===i&&(n=u(n,this.scene,e,r,s,o,i)),n}queryElevation(e,r,t,s,o,i=null,c=0){const l=n();return this.elevationQuery.queryElevation(e,r,i,c).then((i=>{"scene"===o&&(i=u(i,this.scene,e,r,t,s,o)),l.resolve(i)})).catch((i=>{a(i)?l.reject(i):l.resolve(this.getElevation(e,r,t,s,o))})),l.promise}register(e,r){this.handles.set(r,r.on("elevation-change",(e=>this.emit("elevation-change",e)))),this[e].push(r)}unregister(e){this.handles.has(e)&&(this.handles.get(e).remove(),this.handles.delete(e));for(const r of[this.im,this.ground,this.scene]){const t=r.indexOf(e);t>-1&&r.splice(t,1)}}};function u(e,r,t,o,i,n,a){for(const c of r){const r=c.getElevation(t,o,i,n,a);s(r)&&(e=s(e)?Math.max(r,e):r)}return e}e([o({constructOnly:!0})],h.prototype,"view",void 0),e([o({readOnly:!0,aliasOf:"view.basemapTerrain.spatialReference"})],h.prototype,"spatialReference",void 0),h=e([i("esri.views.3d.support.CombinedElevationProvider")],h);export{h as CombinedElevationProvider};
