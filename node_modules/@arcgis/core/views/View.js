/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import"../core/has.js";import{isSome as t}from"../core/maybe.js";import i from"../core/Logger.js";import"../core/accessorSupport/ensureType.js";import{property as r}from"../core/accessorSupport/decorators/property.js";import{aliasOf as a}from"../core/accessorSupport/decorators/aliasOf.js";import{subclass as s}from"../core/accessorSupport/decorators/subclass.js";import o from"../core/Error.js";import"../core/urlUtils.js";import"../core/uuid.js";import"../portal/support/resourceExtension.js";import{after as n}from"../core/promiseUtils.js";import{schedule as l}from"../core/scheduling.js";import p from"../core/Accessor.js";import{equals as h}from"../geometry/support/spatialReferenceUtils.js";import d from"../geometry/SpatialReference.js";import y from"../geometry/Extent.js";import u from"../core/Evented.js";import c from"../core/Collection.js";import{EsriPromiseMixin as m}from"../core/Promise.js";import f from"../core/Loadable.js";import w from"../core/CollectionFlattener.js";import g from"../Map.js";import v from"../TimeExtent.js";import{whenOnce as M,init as V,whenFalseOnce as R,watch as F}from"../core/watchUtils.js";import _ from"../geometry/HeightModelInfo.js";import{HandleOwnerMixin as j}from"../core/HandleOwner.js";import E,{graphicsCollectionProperty as C}from"../support/GraphicsCollection.js";import{BasemapView as S}from"./BasemapView.js";import O from"./LayerViewManager.js";import x from"./Magnifier.js";import b from"./RefreshManager.js";import{ViewEvents as L}from"./input/ViewEvents.js";import I from"./ToolViewManager.js";import{AnalysisManager as A}from"./3d/interactive/graphics/AnalysisManager.js";import D from"./input/Input.js";import T from"./navigation/Navigation.js";import q from"./support/DefaultsFromMap.js";var z;const H=i.getLogger("esri.views.View");let W=z=class extends(j(u.EventedMixin(m(p)))){constructor(e){super(e),this._userSpatialReference=null,this._cursor=null,this.allLayerViews=new w({root:this,rootCollectionNames:["basemapView.baseLayerViews","groundView?.layerViews","layerViews","basemapView.referenceLayerViews"],getChildrenFunction:e=>e.layerViews}),this.animation=null,this.basemapView=null,this.defaultsFromMap=new q({view:this}),this.fatalError=null,this.extent=null,this.graphics=new E,this.navigating=!1,this.layerViews=new c,this.magnifier=new x,this.padding={left:0,top:0,right:0,bottom:0},this.ready=!1,this.spatialReferenceWarningDelay=1e3,this.supportsGround=!0,this.timeExtent=null,this.type=null,this.scale=null,this.updating=!1,this.initialExtentRequired=!0,this.renderContext=null,this.input=new D,this.navigation=new T,this.layerViewManager=null,this.refreshManager=null,this.isHeightModelInfoRequired=!1,this.width=null,this.height=null,this.resizing=!1,this.suspended=!1,this.viewEvents=new L(this),this.persistableViewModels=new c,this._isValid=!1,this._readyCycleForced=!1,this.handles.add(this.watch("preconditionsReady",(e=>{e?(this._currentSpatialReference=this.spatialReference,z.views.add(this)):(this._currentSpatialReference=null,z.views.remove(this)),this.notifyChange("spatialReference"),!e&&this.ready?(this.layerViewManager.clear(),this.toolViewManager.detach(),this._teardown()):e&&!this.ready&&(this._startup(),this.toolViewManager.attach())}),!0))}initialize(){let e;this.addResolvingPromise(this.validate().then((()=>(this._isValid=!0,M(this,"ready"))))),this.basemapView=new S({view:this}),this.layerViewManager=new O({view:this,layerViewImporter:{importLayerView:e=>this.importLayerView(e),hasLayerViewModule:e=>this.hasLayerViewModule(e)},supportsGround:this.supportsGround}),this.refreshManager=new b({view:this}),this.toolViewManager=new I({view:this}),this.analysisManager=new A({viewFactory:e=>this.createAnalysisView(e),controllerFactory:e=>this.createAnalysisController(e)}),this._resetInitialViewPropertiesFromContent(),V(this.defaultsFromMap,"isSpatialReferenceDone",(t=>{const i=!!(this.map&&this.map.allLayers.length>0);if(t&&!this.spatialReference&&i||!e){if(t&&!this.spatialReference&&i&&!e){const t=e=n(this.spatialReferenceWarningDelay);e.then((()=>{t===e&&H.warn("#spatialReference","no spatial reference could be derived from the currently added map layers")})).catch((()=>{}))}}else e=null}),!0)}destroy(){if(this.destroyed)return;this.viewEvents.destroy(),this.allLayerViews.destroy(),this.navigation&&(this.navigation.destroy(),this._set("navigation",null)),this.graphics.destroy(),this.graphics=null,this.handles.remove("defaultsFromMap"),this.defaultsFromMap.destroy(),this._set("defaultsFromMap",null),this.toolViewManager.destroy(),this.toolViewManager=null,this.refreshManager.destroy(),this.refreshManager=null,this.layerViewManager.destroy(),this.layerViewManager=null,this.basemapView.destroy(),this.basemapView=null,this.invalidate(),this._emitter.clear(),this.handles.removeAll();const e=this.map;this.map=null,null==e||e.destroy()}_startup(){this._set("ready",!0)}_teardown(){this._set("ready",!1)}whenReady(){return Promise.resolve(this)}toMap(){return H.error("#toMap()","Not implemented on this instance of View"),null}get heightModelInfo(){return this.getDefaultHeightModelInfo()}get interacting(){return this.navigating}get preconditionsReady(){return!!(!this.fatalError&&this._isValid&&!this._readyCycleForced&&this.map&&(!f.isLoadable(this.map)||this.map.loaded)&&0!==this.width&&0!==this.height&&this.spatialReference&&this.isSpatialReferenceSupported(this.spatialReference)&&(this._currentSpatialReference||!this.initialExtentRequired||this.initialExtent||this.defaultsFromMap&&this.defaultsFromMap.isSpatialReferenceDone)&&this.defaultsFromMap&&this.defaultsFromMap.isTileInfoDone)}set map(e){var t;e!==this._get("map")&&(null!=(t=e)&&t.destroyed&&(H.warn("#map","The provided map is already destroyed",{map:e}),e=null),f.isLoadable(e)&&e.load().catch((()=>{})),this.initialized&&(this.forceReadyCycle(),this._resetInitialViewPropertiesFromContent()),this._set("map",e))}get spatialReference(){let e=this._userSpatialReference||this._currentSpatialReference||this.getDefaultSpatialReference()||null;return e&&this.isHeightModelInfoRequired&&this.defaultsFromMap&&(e=e.clone(),e.vcsWkid=this.defaultsFromMap.vcsWkid,e.latestVcsWkid=this.defaultsFromMap.latestVcsWkid),e}set spatialReference(e){this._userSpatialReference=e,this._set("spatialReference",e)}get stationary(){return!this.animation&&!this.navigating&&!this.resizing}get initialExtent(){return this.defaultsFromMap&&this.defaultsFromMap.extent}get cursor(){const e=this.toolViewManager?this.toolViewManager.cursor:null;return t(e)?e:this._cursor||"default"}set cursor(e){this._cursor=e,this.notifyChange("cursor")}get size(){return[this.width,this.height]}whenLayerView(e){return this.layerViewManager.whenLayerView(e)}getAnalysisView(e){return this.analysisManager.getAnalysisView(e)}whenAnalysisView(e){return this.analysisManager.whenAnalysisView(e)}getDefaultSpatialReference(){return this.get("defaultsFromMap.spatialReference")}getDefaultHeightModelInfo(){return this.get("map.supportsHeightModelInfo")&&this.get("map.heightModelInfo")||this.get("defaultsFromMap.heightModelInfo")||null}importLayerView(e){throw new o("importLayerView() not implemented")}hasLayerViewModule(e){return!1}async createAnalysisView(e){throw new o("createAnalysisView() not implemented")}async createAnalysisController(e){throw new o("createAnalysisController() not implemented")}async validate(){}invalidate(){this._isValid=!1}isSpatialReferenceSupported(e,t,i){return!0}isTileInfoRequired(){return!1}when(e,t){return this.isResolved()&&!this.ready&&H.warn("#when()",'Calling view.when() while the view is no longer ready but was already resolved once will resolve immediately. Use watchUtils.whenOnce(view, "ready").then(...) instead.'),super.when(e,t)}forceReadyCycle(){this.ready&&(this._readyCycleForced=!0,R(this,"preconditionsReady",(()=>this._readyCycleForced=!1)))}createTool(e,t,i){return this.toolViewManager.createTool(e,t,i)}tryFatalErrorRecovery(){this.fatalError=null}_resetInitialViewPropertiesFromContent(){if(!this.defaultsFromMap)return;const e=()=>this.defaultsFromMap&&this.defaultsFromMap.start();this.defaultsFromMap.reset(),this._currentSpatialReference=null,this.notifyChange("spatialReference"),this.handles.remove("defaultsFromMap"),this.handles.add([F(this,"spatialReference",((t,i)=>{h(t,i)||e()})),F(this,"initialExtentRequired",e),l(e)],"defaultsFromMap")}};W.views=new c,e([a("toolViewManager.activeTool")],W.prototype,"activeTool",void 0),e([r({readOnly:!0})],W.prototype,"allLayerViews",void 0),e([r()],W.prototype,"animation",void 0),e([r()],W.prototype,"basemapView",void 0),e([r()],W.prototype,"defaultsFromMap",void 0),e([r()],W.prototype,"fatalError",void 0),e([r({type:y})],W.prototype,"extent",void 0),e([r(C())],W.prototype,"graphics",void 0),e([r({readOnly:!0,type:_,dependsOn:["map.heightModelInfo?","defaultsFromMap.heightModelInfo"]})],W.prototype,"heightModelInfo",null),e([r({readOnly:!0})],W.prototype,"interacting",null),e([r({readOnly:!0})],W.prototype,"navigating",void 0),e([r({readOnly:!0,dependsOn:["fatalError","_isValid","_readyCycleForced","map","map.loaded?","width","height","spatialReference","_currentSpatialReference","initialExtentRequired","initialExtent","defaultsFromMap.isSpatialReferenceDone","defaultsFromMap.isTileInfoDone"]})],W.prototype,"preconditionsReady",null),e([r({type:c,readOnly:!0})],W.prototype,"layerViews",void 0),e([r({type:x})],W.prototype,"magnifier",void 0),e([r({value:null,type:g})],W.prototype,"map",null),e([r()],W.prototype,"padding",void 0),e([r({readOnly:!0})],W.prototype,"ready",void 0),e([r({type:d})],W.prototype,"spatialReference",null),e([r()],W.prototype,"spatialReferenceWarningDelay",void 0),e([r()],W.prototype,"stationary",null),e([r({readOnly:!0})],W.prototype,"supportsGround",void 0),e([r({type:v})],W.prototype,"timeExtent",void 0),e([a("toolViewManager.tools")],W.prototype,"tools",void 0),e([r()],W.prototype,"toolViewManager",void 0),e([a("analysisManager.analyses")],W.prototype,"analyses",void 0),e([r()],W.prototype,"analysisManager",void 0),e([r({readOnly:!0})],W.prototype,"type",void 0),e([r({type:Number})],W.prototype,"scale",void 0),e([r({readOnly:!0})],W.prototype,"updating",void 0),e([r({readOnly:!0})],W.prototype,"initialExtentRequired",void 0),e([r({readOnly:!0,type:y})],W.prototype,"initialExtent",null),e([r()],W.prototype,"cursor",null),e([r()],W.prototype,"renderContext",void 0),e([r({readOnly:!0})],W.prototype,"input",void 0),e([r({type:T,nonNullable:!0})],W.prototype,"navigation",void 0),e([r()],W.prototype,"layerViewManager",void 0),e([r()],W.prototype,"width",void 0),e([r()],W.prototype,"height",void 0),e([r({readOnly:!0})],W.prototype,"resizing",void 0),e([r({value:null,readOnly:!0})],W.prototype,"size",null),e([r({readOnly:!0})],W.prototype,"suspended",void 0),e([r({readOnly:!0})],W.prototype,"viewEvents",void 0),e([r({readOnly:!0})],W.prototype,"persistableViewModels",void 0),e([r()],W.prototype,"_isValid",void 0),e([r()],W.prototype,"_readyCycleForced",void 0),e([r()],W.prototype,"_currentSpatialReference",void 0),W=z=e([s("esri.views.View")],W);var P=W;export default P;
