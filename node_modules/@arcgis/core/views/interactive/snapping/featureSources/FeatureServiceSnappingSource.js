/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import"../../../../core/has.js";import{isSome as r}from"../../../../core/maybe.js";import"../../../../core/Logger.js";import"../../../../core/accessorSupport/ensureType.js";import{destroyHandle as t}from"../../../../core/handleUtils.js";import{property as i}from"../../../../core/accessorSupport/decorators/property.js";import{subclass as s}from"../../../../core/accessorSupport/decorators/subclass.js";import"../../../../core/urlUtils.js";import"../../../../core/uuid.js";import"../../../../portal/support/resourceExtension.js";import{reaction as o}from"../../../../core/accessorSupport/trackingUtils.js";import a from"../../../../core/Accessor.js";import n from"../../../../geometry/Point.js";import{init as l}from"../../../../core/watchUtils.js";import u from"../../../support/debugFlags.js";import{HandleOwnerMixin as p}from"../../../../core/HandleOwner.js";import{convertSnappingCandidate as c}from"./queryEngineUtils.js";import{FeatureServiceTiles2D as d}from"../../../2d/interactive/snapping/featureSources/featureServiceSource/FeatureServiceTiles2D.js";import{FeatureServiceTiles3D as h}from"../../../3d/interactive/snapping/featureSources/featureServiceSource/FeatureServiceTiles3D.js";import{WorkerTileTreeDebugger as f}from"./WorkerTileTreeDebugger.js";import{FeatureServiceSnappingSourceWorkerHandle as m}from"./featureServiceSource/FeatureServiceSnappingSourceWorkerHandle.js";import{FeatureServiceTilesSimple as y}from"./featureServiceSource/FeatureServiceTilesSimple.js";let g=class extends(p(a)){constructor(e){super(e)}get updateTilesParameters(){return{tiles:this.tilesOfInterest.tiles,tileInfo:this.tilesOfInterest.tileInfo,tileSize:this.tilesOfInterest.tileSize}}get updating(){return this.workerHandle.updating||this.updatingHandles.updating}get configuration(){return{filter:this.layer.createQuery(),customParameters:this.layer.customParameters}}get availability(){return this.workerHandle.availability}get layer(){return this.layerSource.layer}initialize(){if(r(this.view))switch(this.view.type){case"2d":this.tilesOfInterest=new d({view:this.view,layer:this.layer});break;case"3d":this.tilesOfInterest=new h({view:this.view})}else this.tilesOfInterest=new y({layer:this.layer});if(this.workerHandle=new m({scheduler:r(this.view)&&"3d"===this.view.type?this.view.resourceController.scheduler:null}),this.handles.add([t(this.workerHandle)]),this.workerHandle.setup({layer:this.layer,spatialReference:this.spatialReference,configuration:this.configuration},null),this.updatingHandles.add(this,"updateTilesParameters",(()=>this.workerHandle.updateTiles(this.updateTilesParameters,null)),2),this.handles.add([o((()=>this.configuration),(e=>this.workerHandle.configure(e,null)))]),r(this.view)){const e=this.view;this.handles.add(l(u,"FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES",(r=>{r&&!this.debug?(this.debug=new f({view:e,handle:this.workerHandle}),this.handles.add(t(this.debug),"debug")):!r&&this.debug&&this.handles.remove("debug")})))}this.handles.add(this.layerSource.layer.on("apply-edits",(e=>{this.workerHandle.applyEdits(e,null)})))}refresh(){this.workerHandle.refresh(null)}async fetchCandidates(e,r){this.tilesOfInterest.pointOfInterest=e.coordinateHelper.toPoint(e.point,new n);const{candidates:t}=await this.workerHandle.fetchCandidates({...e,filter:null},r);return{candidates:t.map((r=>c(r,e.coordinateHelper)))}}getDebugInfo(e){return this.workerHandle.getDebugInfo(e)}};e([i({constructOnly:!0})],g.prototype,"spatialReference",void 0),e([i({constructOnly:!0})],g.prototype,"layerSource",void 0),e([i({constructOnly:!0})],g.prototype,"view",void 0),e([i()],g.prototype,"tilesOfInterest",void 0),e([i({readOnly:!0})],g.prototype,"updateTilesParameters",null),e([i({readOnly:!0})],g.prototype,"updating",null),e([i({readOnly:!0})],g.prototype,"configuration",null),e([i({readOnly:!0})],g.prototype,"availability",null),g=e([s("esri.views.interactive.snapping.featureSources.FeatureServiceSnappingSource")],g);export{g as FeatureServiceSnappingSource};
