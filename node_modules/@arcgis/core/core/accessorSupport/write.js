/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import r from"../Logger.js";import{getProperties as e,merge as t}from"./utils.js";import{originSpecificWritePropertyDefinition as i}from"./extensions/serializableProperty.js";import o from"../Error.js";import{idToReadableName as n,nameToId as s}from"./PropertyOrigin.js";import{equals as u}from"../arrayUtils.js";const l=r.getLogger("esri.core.accessorSupport.write");function a(r,e,t,i,o){var n,s;const u={};return null==(n=e.write)||null==(s=n.writer)||s.call(r,i,u,t,o),u}function f(r,e,t,i,n,u){if(!i||!i.write)return!1;const a=r.get(t);if(!n&&i.write.overridePolicy){const e=i.write.overridePolicy.call(r,a,t,u);void 0!==e&&(n=e)}if(n||(n=i.write),!n||!1===n.enabled)return!1;if((null===a&&!n.allowNull||void 0===a)&&n.isRequired){const e=new o("web-document-write:property-required",`Missing value for required property '${t}' on '${r.declaredClass}'`,{propertyName:t,target:r});return e&&u&&u.messages?u.messages.push(e):e&&!u&&l.error(e.name,e.message),!1}if(void 0===a)return!1;if(null===a&&!n.allowNull)return!1;if(c(r,t,u,i,a))return!1;if(void 0!==i.default)return!0;if(!n.ignoreOrigin&&u&&u.origin){if(e.store.originOf(t)<s(u.origin))return!1}return!0}function c(r,e,t,i,o){const n=i.default;if(void 0===n)return!1;if(null!=i.defaultEquals)return i.defaultEquals(o);if("function"==typeof n){if(Array.isArray(o)){const i=n.call(r,e,t);return u(i,o)}return!1}return n===o}function p(r,t,o,n){const s=e(r),u=s.metadatas,l=i(u[t],n);return!!l&&f(r,s,t,l,o,n)}function g(r,o,s){if(r&&"function"==typeof r.toJSON&&(!r.toJSON.isDefaultToJSON||!r.write))return t(o,r.toJSON());const u=e(r),l=u.metadatas;for(const e in l){const g=i(l[e],s);if(!f(r,u,e,g,void 0,s))continue;const d=r.get(e),m=a(r,g,g.write&&"string"==typeof g.write.target?g.write.target:e,d,s);var c,p;if(Object.keys(m).length>0)o=t(o,m),null!=s&&null!=(c=s.resources)&&null!=(p=c.pendingOperations)&&p.length&&Promise.all(s.resources.pendingOperations).then((()=>t(o,m))),s&&s.writtenProperties&&s.writtenProperties.push({target:r,propName:e,oldOrigin:n(u.store.originOf(e)),newOrigin:s.origin})}return o}export default g;export{p as willPropertyWrite,g as write};
