/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import t from"../has.js";import r from"../Error.js";import{throwIfAborted as e,createAbortController as o}from"../promiseUtils.js";import n from"./RemoteClient.js";export{default as RemoteClient}from"./RemoteClient.js";import i from"./Connection.js";export{default as Connection}from"./Connection.js";import s from"./WorkerOwner.js";let a=t("esri-workers-debug")?1:t("host-browser")?navigator.hardwareConcurrency-1:0;a||(a=t("safari")&&t("mac")||t("trident")?7:2);let l=0;const c=[];function m(){g()}function f(t,r){return u(t,{client:r})}async function u(t,r){const e=new i;return await e.open(t,r),e}async function p(o,i={}){if("string"!=typeof o)throw new r("workers:undefined-module","modulePath is missing");let s=i.strategy||"distributed";if(t("host-webworker")&&!t("esri-workers")&&(s="local"),"local"===s){let t=await n.loadWorker(o);t||(t=await import(
/* @vite-ignore */
/* webpackIgnore: true */
o)),e(i.signal);const r=i.client||t;return u([n.connect(t)],{...i,client:r})}if(await g(),e(i.signal),"dedicated"===s){const t=l++%a;return u([await c[t].open(o,i)],i)}if(i.maxNumWorkers&&i.maxNumWorkers>0){const t=Math.min(i.maxNumWorkers,a);if(t<a){const r=new Array(t);for(let e=0;e<t;++e){const t=l++%a;r[e]=c[t].open(o,i)}return u(r,i)}}return u(c.map((t=>t.open(o,i))),i)}function w(){h&&(d.abort(),h=null);for(let t=0;t<c.length;t++)c[t]&&c[t].terminate();c.length=0}let d,h=null;async function g(){if(h)return h;d=o();const t=[];for(let r=0;r<a;r++){const e=s.create(r).then((t=>(c[r]=t,t)));t.push(e)}return h=Promise.all(t),h}export{m as initialize,p as open,f as openWithPorts,w as terminate};
