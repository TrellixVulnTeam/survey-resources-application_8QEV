/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{_ as e}from"./chunks/tslib.es6.js";import"./core/has.js";import{clone as r}from"./core/lang.js";import{isSome as t}from"./core/maybe.js";import s from"./core/Logger.js";import"./core/accessorSupport/ensureType.js";import{property as o}from"./core/accessorSupport/decorators/property.js";import{subclass as a}from"./core/accessorSupport/decorators/subclass.js";import{writer as i}from"./core/accessorSupport/decorators/writer.js";import{isProtocolRelative as n,urlToObject as l}from"./core/urlUtils.js";import"./core/uuid.js";import"./portal/support/resourceExtension.js";import{throwIfAborted as p,eachAlways as c}from"./core/promiseUtils.js";import{JSONSupportMixin as m}from"./core/JSONSupport.js";import u from"./geometry/SpatialReference.js";import h from"./core/Collection.js";import{referenceSetter as f}from"./core/collectionUtils.js";import y from"./core/Loadable.js";import d from"./portal/Portal.js";import{loadAll as b}from"./core/loadAll.js";import L from"./portal/PortalItem.js";import{getBasemapTitle as w,esriBasemapDefinitions as I}from"./support/basemapDefinitions.js";import{getLayerJSON as g}from"./webdoc/support/writeUtils.js";var j;let S=0;const v=s.getLogger("esri.Basemap");let _=j=class extends(m(y)){constructor(e){super(e),this.id=null,this.portalItem=null,this.spatialReference=null,this.thumbnailUrl=null,this.title="Basemap",this.id=Date.now().toString(16)+"-basemap-"+S++,this.baseLayers=new h,this.referenceLayers=new h;const r=e=>{e.parent&&e.parent!==this&&"remove"in e.parent&&e.parent.remove(e),e.parent=this,"elevation"===e.type&&v.error(`Layer '${e.title}, id:${e.id}' of type '${e.type}' is not supported as a basemap layer and will therefore be ignored.`)},t=e=>{e.parent=null};this.baseLayers.on("after-add",(e=>r(e.item))),this.referenceLayers.on("after-add",(e=>r(e.item))),this.baseLayers.on("after-remove",(e=>t(e.item))),this.referenceLayers.on("after-remove",(e=>t(e.item)))}initialize(){this.when().catch((e=>{v.error("#load()",`Failed to load basemap (title: '${this.title}', id: '${this.id}')`,e)})),this.resourceInfo&&this.read(this.resourceInfo.data,this.resourceInfo.context)}destroy(){var e;const r=this.baseLayers.removeAll();for(const s of r)s.destroy();const t=this.referenceLayers.removeAll();for(const s of t)s.destroy();this.baseLayers.destroy(),this.referenceLayers.destroy(),null==(e=this.portalItem)||e.destroy(),this.portalItem=null}normalizeCtorArgs(e){return e&&"resourceInfo"in e&&(this._set("resourceInfo",e.resourceInfo),delete(e={...e}).resourceInfo),e}set baseLayers(e){this._set("baseLayers",f(e,this._get("baseLayers")))}_writeBaseLayers(e,r,s){const o=[];e?(s={...s,layerContainerType:"basemap"},this.baseLayers.forEach((e=>{const r=g(e,s.webmap?s.webmap.getLayerJSONFromResourceInfo(e):null,s);t(r)&&o.push(r)})),this.referenceLayers.forEach((e=>{const r=g(e,s.webmap?s.webmap.getLayerJSONFromResourceInfo(e):null,s);t(r)&&(r.isReference=!0,o.push(r))})),r.baseMapLayers=o):r.baseMapLayers=o}set referenceLayers(e){this._set("referenceLayers",f(e,this._get("referenceLayers")))}writeTitle(e,r){r.title=e||"Basemap"}load(e){return this.addResolvingPromise(this._loadFromSource(e)),Promise.resolve(this)}loadAll(){return b(this,(e=>{e(this.baseLayers,this.referenceLayers)}))}clone(){const e={id:this.id,title:this.title,portalItem:this.portalItem,baseLayers:this.baseLayers.slice(),referenceLayers:this.referenceLayers.slice()};return this.loaded&&(e.loadStatus="loaded"),new j({resourceInfo:this.resourceInfo}).set(e)}read(e,r){this.resourceInfo||this._set("resourceInfo",{data:e,context:r}),super.read(e,r)}write(e,t){return e=e||{},t&&t.origin||(t={origin:"web-map",...t}),super.write(e,t),!this.loaded&&this.resourceInfo&&this.resourceInfo.data.baseMapLayers&&(e.baseMapLayers=this.resourceInfo.data.baseMapLayers.map((e=>{const t=r(e);return t.url&&n(t.url)&&(t.url=`https:${t.url}`),t.templateUrl&&n(t.templateUrl)&&(t.templateUrl=`https:${t.templateUrl}`),t}))),e}async _loadFromSource(e){const{resourceInfo:r,portalItem:t}=this;p(e);const s=[];if(r){const t=r.context?r.context.url:null;if(s.push(this._loadLayersFromJSON(r.data,t,e)),r.data.id&&!r.data.title){const e=r.data.id;s.push(w(e).then((e=>{e&&this.read({title:e},r.context)})))}}else t&&s.push(this._loadFromItem(t,e));await Promise.all(s)}async _loadLayersFromJSON(e,r,t){const s=this.resourceInfo&&this.resourceInfo.context,o=this.portalItem&&this.portalItem.portal||s&&s.portal||null,a=s&&"web-scene"===s.origin?"web-scene":"web-map",{populateOperationalLayers:i}=await import("./layers/support/layersCreator.js"),n=[];if(p(t),e.baseMapLayers&&Array.isArray(e.baseMapLayers)){const t={context:{origin:a,url:r,portal:o,layerContainerType:"basemap"},defaultLayerType:"DefaultTileLayer"},s=i(this.baseLayers,e.baseMapLayers.filter((e=>!e.isReference)),t);n.push(s);const l=i(this.referenceLayers,e.baseMapLayers.filter((e=>e.isReference)),t);n.push(l)}await c(n)}async _loadFromItem(e,r){const t=await e.load(r),s=await t.fetchData("json",r),o=l(e.itemUrl);return this._set("resourceInfo",{data:s.baseMap,context:{origin:"web-map",portal:e.portal||d.getDefault(),url:o}}),this.read(this.resourceInfo.data,this.resourceInfo.context),this.read({spatialReference:s.spatialReference},this.resourceInfo.context),this.read({title:e.title,thumbnailUrl:e.thumbnailUrl},{origin:"portal-item",portal:e.portal||d.getDefault(),url:o}),this._loadLayersFromJSON(this.resourceInfo.data,o,r)}static fromId(e){const r=I[e];return r?j.fromJSON(r):null}};e([o({json:{write:{ignoreOrigin:!0,target:"baseMapLayers",writer(e,r,t,s){this._writeBaseLayers(e,r,s)}},origins:{"web-scene":{write:{ignoreOrigin:!0,target:{baseMapLayers:{type:h}},writer(e,r,t,s){this._writeBaseLayers(e,r,s)}}}}}})],_.prototype,"baseLayers",null),e([o({type:String,json:{origins:{"web-scene":{write:!0}}}})],_.prototype,"id",void 0),e([o({type:L})],_.prototype,"portalItem",void 0),e([o()],_.prototype,"referenceLayers",null),e([o({readOnly:!0})],_.prototype,"resourceInfo",void 0),e([o({type:u})],_.prototype,"spatialReference",void 0),e([o()],_.prototype,"thumbnailUrl",void 0),e([o({type:String,json:{origins:{"web-scene":{write:{isRequired:!0}}}}})],_.prototype,"title",void 0),e([i("title")],_.prototype,"writeTitle",null),_=j=e([a("esri.Basemap")],_);var x=_;export default x;
